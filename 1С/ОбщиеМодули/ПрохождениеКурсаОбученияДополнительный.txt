////////////////////////////////////////////////////////////////////////////////
// Вспомогательные процедуры, функции

////////////////////////////////////////////////////////////////////////////////
// Процедуры, функции объекта

////////////////////////////////////////////////////////////////////////////////
// Процедуры, функции для работы формы 

#Если ТолстыйКлиентОбычноеПриложение Тогда

Процедура СобытиеПоКнопкеМероприятие(ЭтаФорма, ЭтотОбъект) Экспорт
	
	// Проверка на запись. Если не записан - записать надо или отмена действия.
	Если НЕ ЭтотОбъект.Проведен Тогда
		Вопрос("Сначала проведите документ", РежимДиалогаВопрос.ОК,,);
		возврат
	Конецесли;
		
	Если ЭтаФорма.Модифицированность Тогда 
		
		Отказ = Ложь;
	
		Если Вопрос("Перед созданием мероприятия документ необходимо записать. Записать документ?", РежимДиалогаВопрос.ОКОтмена,, КодВозвратаДиалога.ОК,) = КодВозвратаДиалога.ОК Тогда
			Попытка 
				ЭтотОбъект.Записать();
				Отказ = Ложь;
			Исключение
				Отказ = Истина;
			КонецПопытки;
		Иначе
			Возврат
		КонецЕсли;

		Если Отказ Тогда
			Возврат 
		КонецЕсли;

	КонецЕсли;
		
	Если ЭтотОбъект.Мероприятие.Пустая() Тогда 
		// Если курс помечен как пройденный, спросить "а стоит ли планировать?"
		Отказ = Ложь;
		Если ЭтотОбъект.ФактЗавершенияКурса тогда
			
			ОтветНаВопрос = Вопрос("Данный курс помечен как пройденный. Надо планировать его проведение?", РежимДиалогаВопрос.ДаНет);
			Если ОтветНаВопрос = КодВозвратаДиалога.Нет Тогда
				Отказ = Истина
			КонецЕсли;
			
		КонецЕсли;
		
		Если НЕ Отказ Тогда
			// Создать мероприятие
			ИмяМероприятия = Строка(ЭтотОбъект.КурсОбучения) + ". " + Строка(ЭтотОбъект.Ответственный) + ". " + Строка(ЭтотОбъект.ОбучающиесяРаботники.Количество()) + " Чел.";  
			
			НовоеМероприятие = Справочники.Мероприятия.СоздатьЭлемент();
			НовоеМероприятие.Наименование = ИмяМероприятия;
			НовоеМероприятие.Записать();
			
			// Скопировать занятия в состав мероприятия
			Для каждого строкаТЧ из ЭтотОбъект.КурсОбучения.ЗанятияКурса Цикл
				ЧастьМероприятия = Справочники.СоставМероприятия.СоздатьЭлемент();
				ЧастьМероприятия.Владелец = НовоеМероприятие.Ссылка;
				ЧастьМероприятия.Наименование = строкаТЧ.Занятие.Наименование;
				ЧастьМероприятия.Записать();		
			КонецЦикла;
			
			// Присвоить новое мероприятие реквизиту мероприятие. Открыть форму
			ЭтотОбъект.Мероприятие = НовоеМероприятие.Ссылка;
			ЭтотОбъект.Мероприятие.ПолучитьФорму("ФормаЭлемента").Открыть();

		КонецЕсли;
	
	Иначе
		
		// Если мероприятие уже созданно - открыть его.
		ЭтотОбъект.Мероприятие.ПолучитьФорму("ФормаЭлемента").Открыть();
	КонецЕсли;
	
	// Название кнопки "Мероприятия"
	Если ЭтотОбъект.Мероприятие.Пустая() Тогда
		ЭтаФорма.ЭлементыФормы.ДействияФормы.Кнопки.ОрганизацияОбучения.Кнопки.Мероприятие.Текст = "Создать мероприятие";
	Иначе
		ЭтаФорма.ЭлементыФормы.ДействияФормы.Кнопки.ОрганизацияОбучения.Кнопки.Мероприятие.Текст  = "Открыть мероприятие";
	КонецЕсли;
	
	// Записать документ еще раз.
	ЭтотОбъект.Записать();
	
КонецПроцедуры

Процедура СобытиеПоКнопкеЗанятость(ЭтаФорма, ЭтотОбъект) Экспорт
	
	ДокументУчастияВМероприятии = ЭтотОбъект.ДокументУчастияВМероприятии;
	ЭлементыФормы = ЭтаФорма.ЭлементыФормы;
	
	
	// создает или открывает документ "Участие в мероприятии"
	Если ЭтотОбъект.Мероприятие.Пустая() Тогда 
		Вопрос("Сначала создайте мероприятие", РежимДиалогаВопрос.ОК,,);
		Возврат;	
	КонецЕсли;
	
	Если ДокументУчастияВМероприятии.Пустая() Тогда 
		
		// Создать мероприятие
		ИмяМероприятия = Строка(ЭтотОбъект.КурсОбучения) + ". " + Строка(ЭтотОбъект.Ответственный) + ". " + Строка(ЭтотОбъект.ОбучающиесяРаботники.Количество()) + " Чел.";  
		
		НовоеУчастие = Документы.УчастиеВМероприятиях.СоздатьДокумент();
		НовоеУчастие.Мероприятие = ЭтотОбъект.Мероприятие.Ссылка;
		НовоеУчастие.Ответственный = ЭтотОбъект.Ответственный;
		НовоеУчастие.Дата = ТекущаяДата();
		
		// Скопировать занятия в состав мероприятия
		// Для каждой части мероприятия
		НаборЧастейМероприятия = Справочники.СоставМероприятия.Выбрать(,ЭтотОбъект.Мероприятие.Ссылка,,);
		
		Пока НаборЧастейМероприятия.Следующий() Цикл 
			
			ЧастьМероприятия = НаборЧастейМероприятия.Ссылка;
			
			Для каждого строкаТЧ из ЭтотОбъект.ОбучающиесяРаботники Цикл
				УчастиеРаботника = НовоеУчастие.Работники.Добавить();
				УчастиеРаботника.Сотрудник			= строкаТЧ.Сотрудник;
				УчастиеРаботника.Физлицо			= строкаТЧ.Физлицо;
				УчастиеРаботника.ЧастьМероприятия	= ЧастьМероприятия;
				УчастиеРаботника.ХарактерУчастия	= Перечисления.ХарактерУчастияВМероприятиях.Участник;
			КонецЦикла;
		КонецЦикла;
		
		НовоеУчастие.Записать();
		
		ДокументУчастияВМероприятии = НовоеУчастие.Ссылка;
		ДокументУчастияВМероприятии.ПолучитьФорму("ФормаДокумента").Открыть();
		
	Иначе
		
		// Если мероприятие уже созданно - открыть его.
		ДокументУчастияВМероприятии.ПолучитьФорму("ФормаДокумента").Открыть();
		
	КонецЕсли;
	
	Если ДокументУчастияВМероприятии.Пустая() Тогда
		ЭлементыФормы.ДействияФормы.Кнопки.ОрганизацияОбучения.Кнопки.Занятость.Текст = "Запланировать занятость";
	Иначе
		ЭлементыФормы.ДействияФормы.Кнопки.ОрганизацияОбучения.Кнопки.Занятость.Текст = "Открыть занятость";
	КонецЕсли;
	
КонецПроцедуры

#КонецЕсли