Функция РабочаяВерсияНастройкиОтчетов() Экспорт
	Возврат "1.0";
КонецФункции 

// Формирует типовой отчет в строку XML, табличный документ или поле табличного документа	
Функция СформироватьТиповойОтчет(ОтчетОбъект, Результат = Неопределено, ДанныеРасшифровки = Неопределено, ВыводВФормуОтчета = Истина, ВнешниеНаборыДанных = Неопределено, ВыводитьШапкуОтчетаНаВсехСтраницах = истина) Экспорт
	
	Если ТипЗнч(Результат) = Тип("Строка") Тогда
		ПараметрыИсполненияОтчета = Неопределено;
		ПараметрыИсполненияОтчета = ОтчетОбъект.ПолучитьПараметрыИсполненияОтчета();
		ДанныеРасшифровки = Неопределено;
		// Вывод отчета в XML
		СохранениеНастроек.ЗаполнитьНастройкиПриОткрытииОтчета(ОтчетОбъект);
		ОтчетОбъект.ДоработатьКомпоновщикПередВыводом();
		// Сгенерируем макет компоновки данных при помощи компоновщика макета
		КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;
		МакетКомпоновки = КомпоновщикМакета.Выполнить(ОтчетОбъект.СхемаКомпоновкиДанных, ОтчетОбъект.КомпоновщикНастроек.Настройки, ДанныеРасшифровки);
		// Создадим и инициализируем процессор компоновки
		ПроцессорКомпоновки = Новый ПроцессорКомпоновкиДанных;
		Если ПараметрыИсполненияОтчета <> Неопределено И ПараметрыИсполненияОтчета.Свойство("ИспользоватьСобытияПриФормированииОтчета") И ПараметрыИсполненияОтчета.ИспользоватьСобытияПриФормированииОтчета тогда
			ОтчетОбъект.ПередВыводомОтчета(МакетКомпоновки, ПроцессорКомпоновки);
		КонецЕсли;
		Если ВнешниеНаборыДанных = Неопределено Тогда
			ПроцессорКомпоновки.Инициализировать(МакетКомпоновки,, ДанныеРасшифровки);
		Иначе
			ПроцессорКомпоновки.Инициализировать(МакетКомпоновки, ВнешниеНаборыДанных, ДанныеРасшифровки);
		КонецЕсли;
		ЗаписьXML = Новый ЗаписьXML();
		ЗаписьXML.УстановитьСтроку();
		ЗаписьXML.ЗаписатьНачалоЭлемента("result");
		Пока Истина Цикл
			ЭлементРезультата = ПроцессорКомпоновки.Следующий();
			Если ЭлементРезультата = Неопределено Тогда
				Прервать;
			КонецЕсли;
			Если ПараметрыИсполненияОтчета <> Неопределено И ПараметрыИсполненияОтчета.Свойство("ИспользоватьСобытияПриФормированииОтчета") И ПараметрыИсполненияОтчета.ИспользоватьСобытияПриФормированииОтчета тогда
				ОтчетОбъект.ПередВыводомЭлементРезультата(МакетКомпоновки, ПроцессорКомпоновки, ЭлементРезультата);
			КонецЕсли;
			СериализаторXDTO.ЗаписатьXML(ЗаписьXML, ЭлементРезультата, "item", "http://v8.1c.ru/8.1/data-composition-system/result");
		КонецЦикла;
		ЗаписьXML.ЗаписатьКонецЭлемента();
		Результат = ЗаписьXML.Закрыть();
		
		ЗаписьXML = Новый ЗаписьXML();
		ЗаписьXML.УстановитьСтроку();
		ЗаписьXML.ЗаписатьНачалоЭлемента("details");
		СериализаторXDTO.ЗаписатьXML(ЗаписьXML, ДанныеРасшифровки, "item", "http://v8.1c.ru/8.1/data-composition-system/details");
		ЗаписьXML.ЗаписатьКонецЭлемента();
		ДанныеРасшифровки = ЗаписьXML.Закрыть();		
		
	ИначеЕсли ВыводВФормуОтчета Тогда
		#Если ТолстыйКлиентОбычноеПриложение или Сервер Тогда
			// Вывод отчета в форму отчета                           
			Результат.Очистить();
			Настройки = ОтчетОбъект.КомпоновщикНастроек.ПолучитьНастройки();
			ДоработатьТиповойОтчетПередВыводом(ОтчетОбъект);
			ВыводЗаголовкаТиповогоОтчета(ОтчетОбъект, Результат, ВыводВФормуОтчета);
			ОтчетОбъект.ДоработатьКомпоновщикПередВыводом();
			ВывестиТиповойОтчет(ОтчетОбъект, Результат, ДанныеРасшифровки, ВыводВФормуОтчета, ВнешниеНаборыДанных, ВыводитьШапкуОтчетаНаВсехСтраницах);
			ОтчетОбъект.КомпоновщикНастроек.ЗагрузитьНастройки(Настройки);
			#Если ТолстыйКлиентОбычноеПриложение тогда
				УправлениеОтображениемЗаголовкаТиповогоОтчета(ОтчетОбъект, Результат);
			#КонецЕсли
		Иначе
			// Вывод отчета в табличный документ
			Настройки = ОтчетОбъект.КомпоновщикНастроек.ПолучитьНастройки();
			ДоработатьТиповойОтчетПередВыводом(ОтчетОбъект);
			ВыводЗаголовкаТиповогоОтчета(ОтчетОбъект, Результат, ВыводВФормуОтчета);
			ОтчетОбъект.ДоработатьКомпоновщикПередВыводом();
			ВывестиТиповойОтчет(ОтчетОбъект, Результат, ДанныеРасшифровки, ВыводВФормуОтчета, ВнешниеНаборыДанных);
			ОтчетОбъект.КомпоновщикНастроек.ЗагрузитьНастройки(Настройки);
		#КонецЕсли
	КонецЕсли;
	Возврат Результат;
КонецФункции

// По структуре параметров восстанавливает состояние отчета
Процедура ПрименитьСтруктуруПараметровОтчета(ОтчетОбъект, СтруктураПараметров) Экспорт
	
	Если СтруктураПараметров = Неопределено Тогда
		Возврат;
	КонецЕсли;
	ЗаполнитьЗначенияСвойств(ОтчетОбъект, СтруктураПараметров);
	ОтчетОбъект.ИнициализацияОтчета();
	ОтчетОбъект.КомпоновщикНастроек.ЗагрузитьНастройки(СтруктураПараметров.НастройкиКомпоновщика);
	
КонецПроцедуры

Процедура ИнициализацияТиповогоОтчета(ОтчетОбъект) Экспорт
	
КонецПроцедуры

// Возвращает структуру параметров отчета для сохранения
Функция ПолучитьСтруктуруПараметровТиповогоОтчета(ОтчетОбъект) Экспорт
	
	СтруктураПараметров = Новый Структура;
	Для каждого Реквизит Из ОтчетОбъект.Метаданные().Реквизиты Цикл
		Если Реквизит.Имя = "СхемаКомпоновкиДанных" 
			ИЛИ Реквизит.Имя = "ДатаВерсииИсточникаДанных"
			ИЛИ Реквизит.Имя = "ИсточникДанныхОтчета"
			ИЛИ Реквизит.Имя = "Описание"
			ИЛИ Реквизит.Имя = "ПодлежитПередачеВПодчиненныеУзлыПриОбменеПоОрганизации" Тогда
			Продолжить;
		КонецЕсли;
		СтруктураПараметров.Вставить(Реквизит.Имя, ОтчетОбъект[Реквизит.Имя])
	КонецЦикла;
	
	СтруктураПараметров.Вставить("НастройкиКомпоновщика", ОтчетОбъект.КомпоновщикНастроек.ПолучитьНастройки());
	
	Если СтруктураПараметров.Свойство("Версия") тогда
		СтруктураПараметров.Версия = РабочаяВерсияНастройкиОтчетов();
	Иначе
		СтруктураПараметров.Вставить("Версия", РабочаяВерсияНастройкиОтчетов());
	КонецЕсли;
	
	Возврат СтруктураПараметров;
	
КонецФункции


// Добавляет отбор в набор отборов компоновщика или группы отборов
Функция ДобавитьОтбор(ЭлементСтруктуры, Знач Поле, Значение, ВидСравнения = Неопределено, Использование = Истина) Экспорт
	
	Если ТипЗнч(Поле) = Тип("Строка") Тогда
		Поле = Новый ПолеКомпоновкиДанных(Поле);
	КонецЕсли;
	
	Если ТипЗнч(ЭлементСтруктуры) = Тип("КомпоновщикНастроекКомпоновкиДанных") Тогда
		Отбор = ЭлементСтруктуры.Настройки.Отбор;
	Иначе
		Отбор = ЭлементСтруктуры;
	КонецЕсли;
	
	Если ВидСравнения = Неопределено Тогда
		ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	КонецЕсли;
	
	НовыйЭлемент = Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	НовыйЭлемент.Использование  = Использование;
	НовыйЭлемент.ЛевоеЗначение  = Поле;
	НовыйЭлемент.ВидСравнения   = ВидСравнения;
	НовыйЭлемент.ПравоеЗначение = Значение;
	Возврат НовыйЭлемент;
	
КонецФункции

// Добавляет группировку в компоновщик настроек в самый нижний уровень структуры, если поле не укзано - детальные поля
Функция ДобавитьГруппировку(КомпоновщикНастроек, Знач Поле = Неопределено, Строки = Истина) Экспорт
	
	ЭлементСтруктуры = Неопределено;
	
	Если ТипЗнч(КомпоновщикНастроек) = Тип("КомпоновщикНастроекКомпоновкиДанных") тогда
		ЭлементСтруктуры = ПолучитьПоследнийЭлементСтруктуры(КомпоновщикНастроек, Строки);
		Если ЭлементСтруктуры = Неопределено 
			ИЛИ ПолучитьЭлементСтруктурыДетальныеЗаписи(КомпоновщикНастроек) <> Неопределено 
			И Поле = Неопределено Тогда
			Возврат Неопределено;
		КонецЕсли;
	ИначеЕсли ТипЗнч(КомпоновщикНастроек) = Тип("ГруппировкаТаблицыКомпоновкиДанных") 
		ИЛИ ТипЗнч(КомпоновщикНастроек) = Тип("ГруппировкаДиаграммыКомпоновкиДанных") 
		ИЛИ ТипЗнч(КомпоновщикНастроек) = Тип("ГруппировкаКомпоновкиДанных") 
		ИЛИ ТипЗнч(КомпоновщикНастроек) = Тип("ТаблицаКомпоновкиДанных") 
		ИЛИ ТипЗнч(КомпоновщикНастроек) = Тип("ДиаграммаКомпоновкиДанных") 
		ИЛИ ТипЗнч(КомпоновщикНастроек) = Тип("КоллекцияЭлементовСтруктурыТаблицыКомпоновкиДанных") 
		ИЛИ ТипЗнч(КомпоновщикНастроек) = Тип("КоллекцияЭлементовСтруктурыДиаграммыКомпоновкиДанных") 
		тогда
		Если ТипЗнч(КомпоновщикНастроек) = Тип("ТаблицаКомпоновкиДанных") тогда 
			Если Строки тогда 
				ЭлементСтруктуры = КомпоновщикНастроек.Строки; 
			Иначе
				ЭлементСтруктуры = КомпоновщикНастроек.Колонки; 
			КонецЕсли;
		ИначеЕсли ТипЗнч(КомпоновщикНастроек) = Тип("ДиаграммаКомпоновкиДанных") тогда
			Если Строки тогда 
				ЭлементСтруктуры = КомпоновщикНастроек.Серии; 
			Иначе
				ЭлементСтруктуры = КомпоновщикНастроек.Точки; 
			КонецЕсли;
		Иначе
			ЭлементСтруктуры = КомпоновщикНастроек; 
		КонецЕсли; 
	КонецЕсли;
	
	Если ТипЗнч(Поле) = Тип("Строка") Тогда
		Поле = Новый ПолеКомпоновкиДанных(Поле);
	КонецЕсли;
	
	Если ТипЗнч(ЭлементСтруктуры) = Тип("ГруппировкаТаблицыКомпоновкиДанных") 
		ИЛИ ТипЗнч(ЭлементСтруктуры) = Тип("ГруппировкаДиаграммыКомпоновкиДанных") Тогда
		НоваяГруппировка = ЭлементСтруктуры.Структура.Добавить();
	ИначеЕсли ТипЗнч(ЭлементСтруктуры) = Тип("КоллекцияЭлементовСтруктурыТаблицыКомпоновкиДанных")
		ИЛИ ТипЗнч(ЭлементСтруктуры) = Тип("КоллекцияЭлементовСтруктурыДиаграммыКомпоновкиДанных") Тогда
		НоваяГруппировка = ЭлементСтруктуры.Добавить();
	Иначе
		НоваяГруппировка = ЭлементСтруктуры.Структура.Добавить(Тип("ГруппировкаКомпоновкиДанных"));
	КонецЕсли;
	
	НоваяГруппировка.Выбор.Элементы.Добавить(Тип("АвтоВыбранноеПолеКомпоновкиДанных"));
	НоваяГруппировка.Порядок.Элементы.Добавить(Тип("АвтоЭлементПорядкаКомпоновкиДанных"));
	Если Поле <> Неопределено Тогда
		ПолеГруппировки = НоваяГруппировка.ПоляГруппировки.Элементы.Добавить(Тип("ПолеГруппировкиКомпоновкиДанных"));
		ПолеГруппировки.Поле = Поле;
	КонецЕсли;
	Возврат НоваяГруппировка;
	
КонецФункции

// Возвращает последний элемент структуры - группировку
Функция ПолучитьПоследнийЭлементСтруктуры(КомпоновщикНастроек, Строки = Истина) Экспорт
	
	Структура = КомпоновщикНастроек.Настройки.Структура;
	Если Структура.Количество() = 0 Тогда
		Возврат КомпоновщикНастроек.Настройки;
	КонецЕсли;
	
	Если Строки Тогда
		ИмяСтруктурыТаблицы = "Строки";
		ИмяСтруктурыДиаграммы = "Серии";
	Иначе
		ИмяСтруктурыТаблицы = "Колонки";
		ИмяСтруктурыДиаграммы = "Точки";
	КонецЕсли;
	
	Пока Истина Цикл
		ЭлементСтруктуры = Структура[0];
		Если ТипЗнч(ЭлементСтруктуры) = Тип("ТаблицаКомпоновкиДанных") И ЭлементСтруктуры[ИмяСтруктурыТаблицы].Количество() > 0 Тогда
			Если ЭлементСтруктуры[ИмяСтруктурыТаблицы][0].Структура.Количество() = 0 Тогда
				Структура = ЭлементСтруктуры[ИмяСтруктурыТаблицы];
				Прервать;
			КонецЕсли;
			Структура = ЭлементСтруктуры[ИмяСтруктурыТаблицы][0].Структура;
		ИначеЕсли ТипЗнч(ЭлементСтруктуры) = Тип("ДиаграммаКомпоновкиДанных") И ЭлементСтруктуры[ИмяСтруктурыДиаграммы].Количество() > 0 Тогда
			Если ЭлементСтруктуры[ИмяСтруктурыДиаграммы][0].Структура.Количество() = 0 Тогда
				Структура = ЭлементСтруктуры[ИмяСтруктурыДиаграммы];
				Прервать;
			КонецЕсли;
			Структура = ЭлементСтруктуры[ИмяСтруктурыДиаграммы][0].Структура;
		ИначеЕсли ТипЗнч(ЭлементСтруктуры) = Тип("ГруппировкаКомпоновкиДанных")
			ИЛИ ТипЗнч(ЭлементСтруктуры) = Тип("ГруппировкаТаблицыКомпоновкиДанных")
			ИЛИ ТипЗнч(ЭлементСтруктуры) = Тип("ГруппировкаДиаграммыКомпоновкиДанных") Тогда
			Если ЭлементСтруктуры.Структура.Количество() = 0 Тогда
				Прервать;
			КонецЕсли;
			Структура = ЭлементСтруктуры.Структура;
		ИначеЕсли ТипЗнч(ЭлементСтруктуры) = Тип("ТаблицаКомпоновкиДанных") Тогда
			Возврат ЭлементСтруктуры[ИмяСтруктурыТаблицы];
		ИначеЕсли ТипЗнч(ЭлементСтруктуры) = Тип("ДиаграммаКомпоновкиДанных")	Тогда
			Возврат ЭлементСтруктуры[ИмяСтруктурыДиаграммы];
		Иначе
			Возврат ЭлементСтруктуры;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Структура[0];
	
КонецФункции

// Возвращает группировку - детальные записи компоновщика настроек
Функция ПолучитьЭлементСтруктурыДетальныеЗаписи(КомпоновщикНастроек) Экспорт
	
	ПоследнийЭлементСтруктуры = ПолучитьПоследнийЭлементСтруктуры(КомпоновщикНастроек, Истина);
	Если ТипЗнч(ПоследнийЭлементСтруктуры) = Тип("ГруппировкаКомпоновкиДанных")
		ИЛИ ТипЗнч(ПоследнийЭлементСтруктуры) = Тип("ГруппировкаТаблицыКомпоновкиДанных")
		ИЛИ ТипЗнч(ПоследнийЭлементСтруктуры) = Тип("ГруппировкаДиаграммыКомпоновкиДанных") Тогда
		Если ПоследнийЭлементСтруктуры.ПоляГруппировки.Элементы.Количество() = 0 Тогда
			Возврат ПоследнийЭлементСтруктуры;
		КонецЕсли;
	КонецЕсли;
	
КонецФункции

// Дорабатывает отчет перед выводом
Процедура ПолучитьПримененуюНастройку(ОтчетОбъект, КомпоновщикНастроек = Неопределено) Экспорт
	
	Если КомпоновщикНастроек = Неопределено Тогда
		КомпоновщикНастроек = ОтчетОбъект.КомпоновщикНастроек;
	КонецЕсли;
	
	Если ЭтоСтараяВерсияОтчета(ОтчетОбъект) Тогда
		Возврат;
	КонецЕсли;
	
	ПараметрыПанели  = ПолучитьПараметрыПанелиПользователяОбъекта(ОтчетОбъект);
	ЗначенияНастроек = ПолучитьЗначенияНастроекПанелиПользователяОбъекта(ОтчетОбъект);
	Если ПараметрыПанели = Неопределено
		ИЛИ ЗначенияНастроек = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	// Установка Настроек компоновки на панели настроек
	Для каждого ВидимостьСтраницы Из ЗначенияНастроек.ВидимостьСтраниц Цикл
		Если Не ВидимостьСтраницы.Значение ИЛИ ВидимостьСтраницы.Ключ = "Показатели" Тогда
			Продолжить;
		КонецЕсли;
		Если ВидимостьСтраницы.Ключ = "Параметры" Тогда
			ЗаполнитьЭлементы(КомпоновщикНастроек.Настройки.ПараметрыДанных, ЗначенияНастроек.НастройкиКомпоновщика.ПараметрыДанных);
		Иначе
			СкопироватьЭлементы(КомпоновщикНастроек.Настройки[ВидимостьСтраницы.Ключ], ЗначенияНастроек.НастройкиКомпоновщика[ВидимостьСтраницы.Ключ], , истина);
		КонецЕсли;
	КонецЦикла;
	
	Если ЗначенияНастроек.Свойство("Показатели") тогда
		ПоляВыбора = ПолучитьВыбранныеПоля(ОтчетОбъект.КомпоновщикНастроек);
		Для каждого ПолеВыбора из ПоляВыбора Цикл
			Если ЗначенияНастроек.Показатели.Получить(Строка(ПолеВыбора.Поле)) <> Неопределено тогда
				ПолеВыбора.Использование = ЗначенияНастроек.Показатели.Получить(Строка(ПолеВыбора.Поле));
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	
	// Установим у всех параметров использование
	Для каждого ЗначениеПараметра Из ЗначенияНастроек.НастройкиКомпоновщика.ПараметрыДанных.Элементы Цикл
		ЗначениеПараметра.Использование = Истина;
	КонецЦикла;
	
	// Установка параметра ПериодОтчета
	ЗначениеПараметра = КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("ПериодОтчета"));
	ЕстьПериод = ПараметрыПанели.ДеревоНастроекСтандартныхСтраниц.Строки.НайтиСтроки(Новый Структура("Имя", "Период"))[0].Использование;
	Если ЕстьПериод И ЗначениеПараметра <> Неопределено Тогда
		Периоды = ПолучитьСписокПериодов(ЗначенияНастроек.НастройкаПериода.Период, ПараметрыПанели);
		ЗначениеПараметра.Использование = Периоды.Количество() <> 0;
		Если ТипЗнч(ЗначениеПараметра.Значение) = Тип("СписокЗначений") Тогда
			ЗначениеПараметра.Значение = Периоды;
		Иначе
			ЗначениеПараметра.Значение = Периоды[0].Значение;
		КонецЕсли;
	КонецЕсли;
	
	Если ПараметрыПанели.ДеревоНастроекСтандартныхСтраниц.Строки.Найти("Период").Использование Тогда
		// Установка Стандартного периода
		ЗначениеПараметраНачалоПериода = КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("НачалоПериода"));
		ЗначениеПараметраКонецПериода  = КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("КонецПериода"));
		Если ЗначениеПараметраНачалоПериода <> Неопределено И ЗначениеПараметраКонецПериода <> Неопределено Тогда
			
			СтандартныйПериод = Неопределено;
			ЗначенияНастроек.Свойство("СтандартныйПериод", СтандартныйПериод);
			Если СтандартныйПериод <> Неопределено Тогда
				Если СтандартныйПериод.ДатаНачала <> '00010101' Тогда
					ЗначениеПараметраНачалоПериода.Использование = Истина;
					ЗначениеПараметраНачалоПериода.Значение = СтандартныйПериод.ДатаНачала;
				КонецЕсли;
				Если СтандартныйПериод.ДатаОкончания <> '00010101' Тогда
					ЗначениеПараметраКонецПериода.Использование = Истина;
					ЗначениеПараметраКонецПериода.Значение = СтандартныйПериод.ДатаОкончания;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
		// Установка Стандартной даты начала
		ЗначениеПараметраПериод = КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("Период"));
		Если ЗначениеПараметраПериод <> Неопределено Тогда
			СтандартнаяДатаНачала = Неопределено;
			ЗначенияНастроек.Свойство("СтандартнаяДатаНачала", СтандартнаяДатаНачала);
			Если СтандартнаяДатаНачала <> Неопределено Тогда
				Если СтандартнаяДатаНачала.Дата <> '00010101' Тогда
					ЗначениеПараметраПериод.Использование = Истина;
					ЗначениеПараметраПериод.Значение = СтандартнаяДатаНачала.Дата;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	// Установка Динамических отборов
	Если ЗначенияНастроек.Свойство("ДинамическиеПараметры") И ПараметрыПанели.Свойство("Параметры") тогда
		Для каждого СтрокаПараметра Из ПараметрыПанели.Параметры Цикл
			ЗначениеПараметра = ЗначенияНастроек.ДинамическиеПараметры[СтрокаПараметра.Параметр];
			Если ЗначениеПараметра = Неопределено ИЛИ Не ЗначениеПараметра.Использование Тогда
				Продолжить;
			КонецЕсли;
			УстановитьПараметр(КомпоновщикНастроек, ЗначениеПараметра.Параметр, ЗначениеПараметра.Значение);
		КонецЦикла;
	КонецЕсли;
	
	// Установка Динамических отборов
	Для каждого СтрокаОтбора Из ПараметрыПанели.Отборы Цикл
		ЗначениеОтбора = ЗначенияНастроек.ДинамическиеОтборы[СтрокаОтбора.Поле];
		Если ЗначениеОтбора = Неопределено ИЛИ Не ЗначениеОтбора.Использование Тогда
			Продолжить;
		КонецЕсли;
		Если СтрокаОтбора.ВидОтбора = "Список" ИЛИ СтрокаОтбора.ВидОтбора = "ДлинныйСписок" Тогда
			Если ЗначениеОтбора.ВидСравнения = "" Тогда
				Продолжить;
			КонецЕсли;
			Если ЗначениеОтбора.ВидСравнения = "Исключая" Тогда
				ВидСравненияКомпоновки = ВидСравненияКомпоновкиДанных["Не" + СтрокаОтбора.ВидСравнения];
			Иначе
				ВидСравненияКомпоновки = ВидСравненияКомпоновкиДанных[СтрокаОтбора.ВидСравнения];
			КонецЕсли;
		Иначе
			ВидСравненияКомпоновки = ВидСравненияКомпоновкиДанных[СтрокаОтбора.ВидСравнения];
		КонецЕсли;
		
		ДобавитьОтбор(КомпоновщикНастроек, ЗначениеОтбора.Поле, ЗначениеОтбора.Значение, ВидСравненияКомпоновки);
	КонецЦикла;
	УдалитьДублиОтбора(КомпоновщикНастроек);
	
	Если ЗначенияНастроек.Свойство("ДинамическиеГруппировки") И ПараметрыПанели.Свойство("Группировки") тогда
		Для каждого ЗначениДинГруппировки из ЗначенияНастроек.ДинамическиеГруппировки Цикл
			УстановитьГруппировку(КомпоновщикНастроек, ЗначениДинГруппировки);
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры

Функция ЭтоСтараяВерсияОтчета(ОтчетОбъект) Экспорт
	
	Возврат ТиповыеОтчетыПереопределяемый.ЭтоСтараяВерсияОтчетаПереопределяемая(ОтчетОбъект);
	
КонецФункции

Функция ПолучитьПараметрыПанелиПользователяОбъекта(ОтчетОбъект) Экспорт
	
	Если ОтчетОбъект.ПараметрыПанелиПользователя = Неопределено Тогда
		Возврат Неопределено;
	Иначе
		Возврат ОтчетОбъект.ПараметрыПанелиПользователя.Получить();
	КонецЕсли;
	
КонецФункции

Функция ПолучитьЗначенияНастроекПанелиПользователяОбъекта(ОтчетОбъект, ФормаОтчета = Неопределено) Экспорт
	
	Если ОтчетОбъект.ЗначенияНастроекПанелиПользователя = Неопределено Тогда
		#Если ТолстыйКлиентОбычноеПриложение тогда
			Если ФормаОтчета <> Неопределено Тогда
				Возврат ПолучитьЗначенияНастроекПанелиПользователя(ОтчетОбъект, ФормаОтчета);
			КонецЕсли;
		#КонецЕсли
		Возврат Неопределено;
	Иначе
		Возврат ОтчетОбъект.ЗначенияНастроекПанелиПользователя.Получить();
	КонецЕсли;
	
КонецФункции

// Заполняет одну коллекцию элементов на основании другой
Процедура ЗаполнитьЭлементы(ПриемникЗначения, ИсточникЗначения, ПервыйУровень = Неопределено) Экспорт
	
	Если ТипЗнч(ПриемникЗначения) = Тип("КоллекцияЗначенийПараметровКомпоновкиДанных") Тогда
		КоллекцияЗначений = ИсточникЗначения;
	Иначе
		КоллекцияЗначений = ИсточникЗначения.Элементы;
	КонецЕсли;
	
	Для каждого ЭлементИсточник Из КоллекцияЗначений Цикл
		Если ПервыйУровень = Неопределено Тогда
			ЭлементПриемник = ПриемникЗначения.НайтиЗначениеПараметра(ЭлементИсточник.Параметр);
		Иначе
			ЭлементПриемник = ПервыйУровень.НайтиЗначениеПараметра(ЭлементИсточник.Параметр);
		КонецЕсли;
		Если ЭлементПриемник = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		ЗаполнитьЗначенияСвойств(ЭлементПриемник, ЭлементИсточник);
		Если ТипЗнч(ЭлементИсточник) = Тип("ЗначениеПараметраКомпоновкиДанных") Тогда
			Если ЭлементИсточник.ЗначенияВложенныхПараметров.Количество() <> 0 Тогда
				ЗаполнитьЭлементы(ЭлементПриемник.ЗначенияВложенныхПараметров, ЭлементИсточник.ЗначенияВложенныхПараметров, ПриемникЗначения);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

// Компирует элементы из одной коллекции в другую
Процедура СкопироватьЭлементы(ПриемникЗначения, ИсточникЗначения, ПроверятьДоступность = Ложь, ОчищатьПриемник = Истина) Экспорт
	
	Если ТипЗнч(ИсточникЗначения) = Тип("УсловноеОформлениеКомпоновкиДанных")
		ИЛИ ТипЗнч(ИсточникЗначения) = Тип("ВариантыПользовательскогоПоляВыборКомпоновкиДанных")
		ИЛИ ТипЗнч(ИсточникЗначения) = Тип("ОформляемыеПоляКомпоновкиДанных") Тогда
		СоздаватьПоТипу = Ложь;
	Иначе
		СоздаватьПоТипу = Истина;
	КонецЕсли;
	ПриемникЭлементов = ПриемникЗначения.Элементы;
	ИсточникЭлементов = ИсточникЗначения.Элементы;
	Если ОчищатьПриемник Тогда
		ПриемникЭлементов.Очистить();
	КонецЕсли;
	
	Для каждого ЭлементИсточник Из ИсточникЭлементов Цикл
		
		Если ТипЗнч(ЭлементИсточник) = Тип("ЭлементПорядкаКомпоновкиДанных") Тогда
			// Элементы порядка добавляем в начало
			Индекс = ИсточникЭлементов.Индекс(ЭлементИсточник);
			ЭлементПриемник = ПриемникЭлементов.Вставить(Индекс, ТипЗнч(ЭлементИсточник));
		Иначе
			Если СоздаватьПоТипу Тогда
				ЭлементПриемник = ПриемникЭлементов.Добавить(ТипЗнч(ЭлементИсточник));
			Иначе
				ЭлементПриемник = ПриемникЭлементов.Добавить();
			КонецЕсли;
		КонецЕсли;
		
		ЗаполнитьЗначенияСвойств(ЭлементПриемник, ЭлементИсточник);
		// В некоторых коллекциях необходимо заполнить другие коллекции
		Если ТипЗнч(ИсточникЭлементов) = Тип("КоллекцияЭлементовУсловногоОформленияКомпоновкиДанных") Тогда
			СкопироватьЭлементы(ЭлементПриемник.Поля, ЭлементИсточник.Поля);
			СкопироватьЭлементы(ЭлементПриемник.Отбор, ЭлементИсточник.Отбор);
			ЗаполнитьЭлементы(ЭлементПриемник.Оформление, ЭлементИсточник.Оформление); 
		ИначеЕсли ТипЗнч(ИсточникЭлементов)	= Тип("КоллекцияВариантовПользовательскогоПоляВыборКомпоновкиДанных") Тогда
			СкопироватьЭлементы(ЭлементПриемник.Отбор, ЭлементИсточник.Отбор);
		КонецЕсли;
		
		// В некоторых элементах коллекции необходимо заполнить другие коллекции
		Если ТипЗнч(ЭлементИсточник) = Тип("ГруппаЭлементовОтбораКомпоновкиДанных") Тогда
			СкопироватьЭлементы(ЭлементПриемник, ЭлементИсточник);
		ИначеЕсли ТипЗнч(ЭлементИсточник) = Тип("ГруппаВыбранныхПолейКомпоновкиДанных") Тогда
			СкопироватьЭлементы(ЭлементПриемник, ЭлементИсточник);
		ИначеЕсли ТипЗнч(ЭлементИсточник) = Тип("ПользовательскоеПолеВыборКомпоновкиДанных") Тогда
			СкопироватьЭлементы(ЭлементПриемник.Варианты, ЭлементИсточник.Варианты);
		ИначеЕсли ТипЗнч(ЭлементИсточник) = Тип("ПользовательскоеПолеВыражениеКомпоновкиДанных") Тогда
			Попытка 
				ЭлементПриемник.УстановитьВыражениеДетальныхЗаписей (ЭлементИсточник.ПолучитьВыражениеДетальныхЗаписей());
				ЭлементПриемник.УстановитьВыражениеИтоговыхЗаписей(ЭлементИсточник.ПолучитьВыражениеИтоговыхЗаписей());
				ЭлементПриемник.УстановитьПредставлениеВыраженияДетальныхЗаписей(ЭлементИсточник.ПолучитьПредставлениеВыраженияДетальныхЗаписей ());
				ЭлементПриемник.УстановитьПредставлениеВыраженияИтоговыхЗаписей(ЭлементИсточник.ПолучитьПредставлениеВыраженияИтоговыхЗаписей ());
			Исключение
			КонецПопытки
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

Функция ПолучитьСписокПериодов(ПериодСохраненный, Параметры)
	
	СписокПериодов = Новый СписокЗначений;
	Периодичность = ПериодСохраненный.Периодичность;	
	Строка = Параметры.ДоступныеПериодичности.НайтиСтроки(Новый Структура("Периодичность", Периодичность))[0];
	РассчитыватьЧерез = Строка.РассчитыватьЧерез;
	Если Периодичность = РассчитыватьЧерез Тогда
		СписокПериодов.Добавить(ПериодСохраненный);
	КонецЕсли;
	Возврат СписокПериодов;
	
КонецФункции

Процедура УдалитьДублиОтбора(КомпоновщикНастроек) Экспорт
	
	Отбор = КомпоновщикНастроек.Настройки.Отбор.Элементы;
	
	Количество = Отбор.Количество();
	Для Индекс = 1 По Количество Цикл
		ЭлементСКонца = Отбор[Количество - Индекс];
		Для ИндексВнутр = 0 По Количество - Индекс - 1 Цикл
			ЭлементВнутр = Отбор[ИндексВнутр];
			Если ТипЗнч(ЭлементВнутр) = Тип("ЭлементОтбораКомпоновкиДанных")
				И ТипЗнч(ЭлементСКонца) = Тип("ЭлементОтбораКомпоновкиДанных")
				И ЭлементВнутр.ЛевоеЗначение = ЭлементСКонца.ЛевоеЗначение
				И ЭлементВнутр.ВидСравнения = ЭлементСКонца.ВидСравнения
				И ЭлементВнутр.Использование = ЭлементСКонца.Использование
				И ПравыеЗначенияОтборовСовпадают(ЭлементВнутр.ПравоеЗначение, ЭлементСКонца.ПравоеЗначение)
				И ЭлементВнутр.Применение = ЭлементСКонца.Применение Тогда
				Отбор.Удалить(ЭлементСКонца);
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
КонецПроцедуры

Функция ПравыеЗначенияОтборовСовпадают(Значение1, Значение2)
	
	Если ТипЗнч(Значение1) <> ТипЗнч(Значение2) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Если ТипЗнч(Значение1) <> Тип("СписокЗначений") Тогда
		Возврат Значение1 = Значение2;
	ИначеЕсли ТипЗнч(Значение1) = Тип("СписокЗначений") Тогда
		Если Значение1.Количество() <> Значение2.Количество() Тогда
			Возврат Ложь;
		КонецЕсли;
		Совпадают = Истина;
		Для каждого Элемент1 Из Значение1 Цикл
			Если Значение2.НайтиПоЗначению(Элемент1.Значение) = Неопределено Тогда
				Совпадают = Ложь;
				Прервать;
			КонецЕсли;
		КонецЦикла;
		Для каждого Элемент2 Из Значение2 Цикл
			Если Значение1.НайтиПоЗначению(Элемент2.Значение) = Неопределено Тогда
				Совпадают = Ложь;
				Прервать;
			КонецЕсли;
		КонецЦикла;
		Возврат Совпадают;
	КонецЕсли;
	Возврат Ложь;
	
КонецФункции

Процедура ЗагрузитьПредопределенныеНастройкиОтчетов() Экспорт
	
	#Если ТолстыйКлиентОбычноеПриложение тогда
	ТаблицаНастроек = ТиповыеОтчеты.ПолучитьТаблицуПредопределенныхНастроек();
	
	Для каждого СтрокаНастройки из ТаблицаНастроек Цикл
		
		ТиповыеОтчеты.ЗагрузитьНастройкуПредопределенногоЭлемента(СтрокаНастройки.Макет, СтрокаНастройки.Отчет);
		
	КонецЦикла
	#КонецЕсли	
	
КонецПроцедуры

// Скрывает и показывает заголовок типового отчета
Процедура УправлениеОтображениемЗаголовкаТиповогоОтчета(ОтчетОбъект, Результат) Экспорт
	
	ПараметрыИсполненияОтчета = ОтчетОбъект.ПолучитьПараметрыИсполненияОтчета();
	
	
	Если Результат.ВысотаТаблицы = 0 Тогда
		Возврат;
	КонецЕсли;
	
	ОбластьЗаголовок = Результат.Области.Найти("Заголовок");
	Если ОбластьЗаголовок = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если ЭтоСтараяВерсияОтчета(ОтчетОбъект) Тогда
		ПоказыватьЗаголовок = (ОтчетОбъект.КомпоновщикНастроек.Настройки.ПараметрыВывода.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("TitleOutput")).Значение = ТипВыводаТекстаКомпоновкиДанных.Выводить);
	Иначе
		ЗначенияНастроек = ПолучитьЗначенияНастроекПанелиПользователяОбъекта(ОтчетОбъект);
		Если ЗначенияНастроек <> Неопределено тогда
			ПоказыватьЗаголовок = ЗначенияНастроек["ВыводитьЗаголовокОтчета"];
		Иначе
			ПоказыватьЗаголовок = истина;
		КонецЕсли;
	КонецЕсли;
	
	ОбластьЗаголовок.Видимость = ПоказыватьЗаголовок;
	
КонецПроцедуры

#Если ТолстыйКлиентОбычноеПриложение Тогда
	//Процедура назначает форме уникальный ключ идентификации для возможности открытия нескольких одинаковых форм
	Процедура НазначитьФормеУникальныйКлючИдентификации(Форма) Экспорт
		
		Если Форма.КлючУникальности = Неопределено Тогда
			Форма.КлючУникальности = Новый УникальныйИдентификатор();
		КонецЕсли;
		
	КонецПроцедуры
	
	// Открывает форму настройки типового очтета для редактирования
	Функция РедактироватьНастройкиТиповогоОтчета(ОтчетОбъект, ФормаОтчета, ПараметрыФормы = Неопределено) Экспорт
		
		// Сохраним настройки на случай отмены редактирования
		СохраненныеНастройки = ОтчетОбъект.КомпоновщикНастроек.ПолучитьНастройки();
		
		//ДописатьВКомпоновщик не достающие поля
		
		// Откроем форму настройки
		ФормаНастройки = ПолучитьОбщуюФорму("ФормаНастройкиСтруктурыОтчета", ФормаОтчета);
		ФормаНастройки.КомпоновщикНастроек = ОтчетОбъект.КомпоновщикНастроек;
		ФормаНастройки.ОтчетОбъект = ОтчетОбъект;
		ФормаНастройки.ОтрицательноеКрасным = ОтчетОбъект.ОтрицательноеКрасным;
		ФормаНастройки.НастройкаПериода = ОтчетОбъект.НастройкаПериода;
		ФормаНастройки.ПараметрыФормы = ПараметрыФормы;
		ФормаНастройки.РасширеннаяНастройка = ОтчетОбъект.РасширеннаяНастройка;
		ФормаНастройки.ОсновнаяНастройка = Истина;
		РезультатОткрытия = ФормаНастройки.ОткрытьМодально();
		
	
		// Проверим результат открытия
		Если РезультатОткрытия <> Неопределено Тогда 
			// Обновим форму типового отчета
			ОбновитьФормуТиповогоОтчетаПоКомпоновщику(ОтчетОбъект, ФормаОтчета);
			УправлениеОтображениемЗаголовкаТиповогоОтчета(ОтчетОбъект, ФормаОтчета.ЭлементыФормы.Результат);
			// Перерисуем форму отчета
			ОтчетОбъект.РасширеннаяНастройка = ФормаНастройки.РасширеннаяНастройка;
			Возврат РезультатОткрытия;
		Иначе
			ОтчетОбъект.КомпоновщикНастроек.ЗагрузитьНастройки(СохраненныеНастройки);
			Возврат Ложь;
		КонецЕсли;
		
	КонецФункции
	
	Функция РедактироватьСтруктуруОтчета(ОтчетОбъект, ФормаОтчета, ПараметрыФормы = Неопределено) Экспорт
		
		СохраненнаяМодифицированность = ФормаОтчета.Модифицированность;
		// Подготовим отчет к открытию формы настройки
		ЗагрузитьВРеквизитЗначенияНастроекПанелиПользователя(ОтчетОбъект, ФормаОтчета);
		
		// Сохраним настройки на случай отмены редактирования
		СохраненныеНастройки = ОтчетОбъект.КомпоновщикНастроек.ПолучитьНастройки();
		
		//ЗаполнитьЭлементы(ОтчетОбъект.КомпоновщикНастроек.Настройки.ПараметрыДанных, ФормаОтчета.КомпоновщикНастроекПользователя.Настройки.ПараметрыДанных);
		//СкопироватьЭлементы(ОтчетОбъект.КомпоновщикНастроек.Настройки.Отбор,   ФормаОтчета.КомпоновщикНастроекПользователя.Настройки.Отбор);
		//СкопироватьЭлементы(ОтчетОбъект.КомпоновщикНастроек.Настройки.Порядок, ФормаОтчета.КомпоновщикНастроекПользователя.Настройки.Порядок);
		
		// Откроем форму настройки
		ФормаНастройки = ПолучитьОбщуюФорму("ФормаНастройкиСтруктурыОтчета", ФормаОтчета);
		ФормаНастройки.КомпоновщикНастроек = ОтчетОбъект.КомпоновщикНастроек;
		ФормаНастройки.ОтчетОбъект = ОтчетОбъект;
		ФормаНастройки.ОтрицательноеКрасным = ОтчетОбъект.ОтрицательноеКрасным;
		Если ЭтоСтараяВерсияОтчета(ОтчетОбъект) Тогда
			ФормаНастройки.НастройкаПериода = ОтчетОбъект.НастройкаПериода;
		КонецЕсли;
		ФормаНастройки.ПараметрыФормы = ПараметрыФормы;
		ФормаНастройки.РасширеннаяНастройка = ОтчетОбъект.РасширеннаяНастройка;
		ФормаНастройки.ОсновнаяНастройка = ОтчетОбъект.СохраненнаяНастройка.Пустая();
		РезультатОткрытия = ФормаНастройки.ОткрытьМодально();
		РасширеннаяНастройка = ФормаНастройки.РасширеннаяНастройка;
		
		ЗначенияНастроек = ПолучитьЗначенияНастроекПанелиПользователя(ОтчетОбъект, ФормаОтчета);
		ПерерисоватьПанельНастроек(ОтчетОбъект, ФормаОтчета, ЗначенияНастроек);
		ФормаОтчета.Модифицированность = Истина;
		
		
		// Проверим результат открытия
		Если РезультатОткрытия <> Неопределено Тогда 
			// Обновим форму типового отчета
			ОбновитьФормуТиповогоОтчетаПоКомпоновщику(ОтчетОбъект, ФормаОтчета);
			ЗаполнитьЭлементы(ФормаОтчета.КомпоновщикНастроекПользователя.Настройки.ПараметрыДанных, ОтчетОбъект.КомпоновщикНастроек.Настройки.ПараметрыДанных);
			СкопироватьЭлементы(ФормаОтчета.КомпоновщикНастроекПользователя.Настройки.Отбор,   ОтчетОбъект.КомпоновщикНастроек.Настройки.Отбор);
			СкопироватьЭлементы(ФормаОтчета.КомпоновщикНастроекПользователя.Настройки.Порядок, ОтчетОбъект.КомпоновщикНастроек.Настройки.Порядок);
			ОтчетОбъект.ЗначенияНастроекПанелиПользователя = Новый ХранилищеЗначения(ПолучитьЗначенияНастроекПанелиПользователя(ОтчетОбъект, ФормаОтчета));
			УправлениеОтображениемЗаголовкаТиповогоОтчета(ОтчетОбъект, ФормаОтчета.ЭлементыФормы.Результат);
			// Перерисуем форму отчета
			ПерерисоватьПанельНастроек(ОтчетОбъект, ФормаОтчета,,);
			ОтчетОбъект.РасширеннаяНастройка = ФормаНастройки.РасширеннаяНастройка;
			ФормаОтчета.Модифицированность = Истина;
			Возврат РезультатОткрытия;
		Иначе
			ОтчетОбъект.КомпоновщикНастроек.ЗагрузитьНастройки(СохраненныеНастройки);
			ФормаОтчета.Модифицированность = СохраненнаяМодифицированность;
			Возврат Ложь;
		КонецЕсли;
		
	КонецФункции
	
	// Скрывает или отображает быстрый отбор на форме
	Процедура УправлениеОтображениемЭлементовФормыТиповогоОтчета(ОтчетОбъект, ФормаОтчета) Экспорт
		
		Если ЭтоСтараяВерсияОтчета(ОтчетОбъект) Тогда
			
			ФормаОтчета.ЭлементыФормы.ДействияФормы.Кнопки.Отбор.Пометка = ОтчетОбъект.ПоказыватьБыстрыйОтбор;
			Если ФормаОтчета.ЭлементыФормы.ДействияФормы.Кнопки.Найти("Заголовок") <> Неопределено И ФормаОтчета.ЭлементыФормы.ДействияФормы.Кнопки.Заголовок.Пометка Тогда
				Значение = ТипВыводаТекстаКомпоновкиДанных.Выводить;
			Иначе
				Значение = ТипВыводаТекстаКомпоновкиДанных.НеВыводить;
			КонецЕсли;
			
			ОтчетОбъект.КомпоновщикНастроек.Настройки.ПараметрыВывода.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("TitleOutput")).Значение = Значение;
			
			Если ОтчетОбъект.ПоказыватьБыстрыйОтбор Тогда
				// Нужно показывать отбор
				ФормаОтчета.ЭлементыФормы.Разделитель.Свертка = РежимСверткиЭлементаУправления.Нет;
				ФормаОтчета.ЭлементыФормы.ПанельОтбора.Свертка = РежимСверткиЭлементаУправления.Нет;
				ФормаОтчета.ЭлементыФормы.Разделитель.УстановитьПривязку(ГраницаЭлементаУправления.Верх, ФормаОтчета.Панель, ГраницаЭлементаУправления.Верх, ФормаОтчета.Панель, ГраницаЭлементаУправления.Низ);
				ФормаОтчета.ЭлементыФормы.ПанельОтбора.УстановитьПривязку(ГраницаЭлементаУправления.Низ, ФормаОтчета.ЭлементыФормы.Разделитель, ГраницаЭлементаУправления.Верх);
				
			Иначе
				// Не нужно показывать отбор
				ФормаОтчета.ЭлементыФормы.ПанельОтбора.УстановитьПривязку(ГраницаЭлементаУправления.Низ);
				ФормаОтчета.ЭлементыФормы.Разделитель.УстановитьПривязку(ГраницаЭлементаУправления.Верх, ФормаОтчета.ЭлементыФормы.ПанельОтбора, ГраницаЭлементаУправления.Низ);
				ФормаОтчета.ЭлементыФормы.ПанельОтбора.Свертка = РежимСверткиЭлементаУправления.Верх;
				ФормаОтчета.ЭлементыФормы.Разделитель.Свертка = РежимСверткиЭлементаУправления.Верх;
			КонецЕсли;
			
		Иначе
			
			ЗначенияНастроек = ПолучитьЗначенияНастроекПанелиПользователяОбъекта(ОтчетОбъект, ФормаОтчета);
			Если ФормаОтчета.ЭлементыФормы.КоманднаяПанельДействияСОтчетом.Кнопки.Найти("Заголовок") <> Неопределено тогда 
				ЗначенияНастроек["ВыводитьЗаголовокОтчета"] = ФормаОтчета.ЭлементыФормы.КоманднаяПанельДействияСОтчетом.Кнопки.Заголовок.Пометка;
			КонецЕсли;
			ОтчетОбъект.ЗначенияНастроекПанелиПользователя = Новый ХранилищеЗначения(ЗначенияНастроек);
			
			Возврат;
		КонецЕсли;
		
	КонецПроцедуры
	
	// Открывает копию отчета в новом окне
	Процедура ОткрытьВНовомОкнеТиповойОтчет(ОтчетОбъект, ФормаОтчета) Экспорт
		
		Если Строка(ОтчетОбъект) = "ВнешнийОтчетОбъект." + ОтчетОбъект.Метаданные().Имя Тогда
			Предупреждение("Данный отчет является внешним." + Символы.ПС + "Открытие нового отчета возможно только для объектов конфигурации.");
			Возврат;
		Иначе
			НовыйОтчет = Отчеты[ОтчетОбъект.Метаданные().Имя].Создать();
		КонецЕсли;
		
		ЗаполнитьЗначенияСвойств(НовыйОтчет, ОтчетОбъект,, "СохраненнаяНастройка");
		НовыйОтчет.КомпоновщикНастроек.ЗагрузитьНастройки(ОтчетОбъект.КомпоновщикНастроек.ПолучитьНастройки());
		ФормаНовогоОтчета = НовыйОтчет.ПолучитьФорму();
		НазначитьФормеУникальныйКлючИдентификации(ФормаНовогоОтчета);
		ФормаНовогоОтчета.ЭтоОтработкаРасшифровки = Истина;
		ФормаНовогоОтчета.Открыть();
		СформироватьТиповойОтчет(НовыйОтчет, ФормаНовогоОтчета.ЭлементыФормы.Результат, ФормаНовогоОтчета.ДанныеРасшифровки);
		ФормаНовогоОтчета.ЭтоОтработкаРасшифровки = Ложь;
		
	КонецПроцедуры
	
	// Обновляет заголовок типового отчета
	Процедура ОбновитьЗаголовокТиповогоОтчета(ОтчетОбъект, ФормаОтчета) Экспорт
		
		ФормаОтчета.Заголовок = ПолучитьЗаголовокОтчета(ОтчетОбъект);
		
	КонецПроцедуры
	
	// Обновляет параметры периода в компоновщике настроек по данным формы
	Процедура ОбновитьПараметрыПериодаПоФорме(КомпоновщикНастроек, Форма) Экспорт
		
		ЗначениеПараметраНачалоПериода = КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("НачалоПериода"));
		ЗначениеПараметраКонецПериода = КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("КонецПериода"));
		ЗначениеПараметраПериод = КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("Период"));
		
		Если ЗначениеПараметраНачалоПериода <> Неопределено Тогда
			ЗначениеПараметраНачалоПериода.Значение = Форма.НачалоПериода;
			ЗначениеПараметраНачалоПериода.Использование = Истина;
		КонецЕсли;
		
		Если ЗначениеПараметраКонецПериода <> Неопределено Тогда
			ЗначениеПараметраКонецПериода.Значение = ?(Форма.КонецПериода = '0001-01-01', Форма.КонецПериода, КонецДня(Форма.КонецПериода));
			ЗначениеПараметраКонецПериода.Использование = Истина;
		КонецЕсли;
		
		Если ЗначениеПараметраПериод <> Неопределено Тогда
			ЗначениеПараметраПериод.Значение = ?(Форма.Период = '0001-01-01', Форма.Период, КонецДня(Форма.Период));
			ЗначениеПараметраПериод.Использование = Истина;
		КонецЕсли;
		
	КонецПроцедуры
	
	//Обновляет элементы формы типового отчета по компоновщику настроек
	Процедура ОбновитьФормуТиповогоОтчетаПоКомпоновщику(ОтчетОбъект, ФормаОтчета) Экспорт
		
		Если ЭтоСтараяВерсияОтчета(ОтчетОбъект) Тогда
			// Параметры периода
			ЗначениеПараметраНачалоПериода = ОтчетОбъект.КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("НачалоПериода"));
			ЗначениеПараметраКонецПериода = ОтчетОбъект.КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("КонецПериода"));
			ЗначениеПараметраПериод = ОтчетОбъект.КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("Период"));
			
			Если ЗначениеПараметраНачалоПериода <> Неопределено 
				И ЗначениеПараметраКонецПериода <> Неопределено Тогда
				ФормаОтчета.НачалоПериода = ЗначениеПараметраНачалоПериода.Значение;
				ФормаОтчета.КонецПериода = ЗначениеПараметраКонецПериода.Значение;
				ФормаОтчета.ЭлементыФормы.ПанельПериод.ТекущаяСтраница = ФормаОтчета.ЭлементыФормы.ПанельПериод.Страницы.Интервал;
			ИначеЕсли ЗначениеПараметраПериод <> Неопределено Тогда
				ФормаОтчета.Период = ЗначениеПараметраПериод.Значение;
				ФормаОтчета.ЭлементыФормы.ПанельПериод.ТекущаяСтраница = ФормаОтчета.ЭлементыФормы.ПанельПериод.Страницы.Период;
			Иначе
				ФормаОтчета.ЭлементыФормы.ПанельПериод.ТекущаяСтраница = ФормаОтчета.ЭлементыФормы.ПанельПериод.Страницы.Пустой;
			КонецЕсли;
			
			// Вывод заголовка отменяется
			Значение = ОтчетОбъект.КомпоновщикНастроек.Настройки.ПараметрыВывода.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("TitleOutput")).Значение;
			Пометка = (Значение = ТипВыводаТекстаКомпоновкиДанных.Выводить);
			Если ФормаОтчета.ЭлементыФормы.ДействияФормы.Кнопки.Найти("Заголовок") <> Неопределено тогда
				ФормаОтчета.ЭлементыФормы.ДействияФормы.Кнопки.Заголовок.Пометка = Пометка;
			КонецЕсли;
		Иначе
			
			ЗначенияНастроек = ПолучитьЗначенияНастроекПанелиПользователяОбъекта(ОтчетОбъект);
			ВыводитьЗаголовокОтчета = Истина;
			Если ЗначенияНастроек = Неопределено
				ИЛИ Не ЗначенияНастроек.Свойство("ВыводитьЗаголовокОтчета", ВыводитьЗаголовокОтчета) Тогда
				ВыводитьЗаголовок = Истина;	
			Иначе
				ВыводитьЗаголовок = ВыводитьЗаголовокОтчета;
			КонецЕсли;
			Если ФормаОтчета.ЭлементыФормы.КоманднаяПанельДействияСОтчетом.Кнопки.Найти("Заголовок") <> Неопределено тогда 
				ФормаОтчета.ЭлементыФормы.КоманднаяПанельДействияСОтчетом.Кнопки.Заголовок.Пометка = ВыводитьЗаголовок;
			КонецЕсли;
			
			ДополнительныеНастройкиОтчета = Новый Массив;
			ПараметрыИсполненияОтчета = ОтчетОбъект.ПолучитьПараметрыИсполненияОтчета();
			Если ПараметрыИсполненияОтчета.Свойство("ДополнительныеНастройкиОтчета") И ПараметрыИсполненияОтчета.ДополнительныеНастройкиОтчета тогда
				ДополнительныеНастройкиОтчета = ОтчетОбъект.ПолучитьДополнительныеНастройкиОтчета();
			КонецЕсли;
			
			Для каждого ДопНастройка из ДополнительныеНастройкиОтчета Цикл
				ЗначениеФлажка = ДопНастройка.ЗначениеПоУмолчанию;
				Если ЗначенияНастроек = Неопределено
					ИЛИ Не ЗначенияНастроек.Свойство(ДопНастройка.Имя, ЗначениеФлажка) Тогда
					Флажок = ложь;	
				Иначе
					Флажок = ЗначениеФлажка;
				КонецЕсли;
				Если ФормаОтчета.ЭлементыФормы.Найти(ДопНастройка.Имя) <> Неопределено тогда
					ФормаОтчета.ЭлементыФормы[ДопНастройка.Имя].Значение = Флажок;
				КонецЕсли;
			КонецЦикла;
			
			Если ЗначенияНастроек = Неопределено тогда
				СкопироватьЭлементы(ФормаОтчета.КомпоновщикНастроекПользователя.Настройки.Выбор, ФормаОтчета.КомпоновщикНастроек.Настройки.Выбор);
			Иначе
				ВыбранныеПоляПользователя = ФормаОтчета.КомпоновщикНастроекПользователя.Настройки.Выбор;
				ВыбранныеПоля = ОтчетОбъект.КомпоновщикНастроек.Настройки.Выбор;
				ОбновитьПоляВНастройкеПользователя(ВыбранныеПоляПользователя, ВыбранныеПоля);
			КонецЕсли;
			ВосстановитьПараметрыТабличногоДокумента(ФормаОтчета.ЭлементыФормы.Результат, ОтчетОбъект.СохраненнаяНастройка);	
			
		КонецЕсли;
	КонецПроцедуры
	
	// Процедура РезультатОбработкаРасшифровки
	// Действие, выполняемое при вызове расшифровки пользователем
	Процедура СтандартнаяОбработкаРасшифровкиТиповогоОтчета(ОтчетОбъект, ФормаОтчета, Расшифровка, СтандартнаяОбработка) Экспорт
		
		Перем ВыполненноеДействие;
		
		// Запретим стандартную обработку расшифровки
		СтандартнаяОбработка = Ложь;
		
		// Создадим и инициализируем обработчик расшифровки
		ОбработкаРасшифровки = Новый ОбработкаРасшифровкиКомпоновкиДанных(ФормаОтчета.ДанныеРасшифровки, 
		Новый ИсточникДоступныхНастроекКомпоновкиДанных(ПолучитьСхемуКомпоновкиОбъекта(ОтчетОбъект)));
		
		// Осуществим выбор действия расшифровки пользователем
		Настройки = ОбработкаРасшифровки.Выполнить(Расшифровка, ВыполненноеДействие);
		
		Если Настройки <> Неопределено Тогда
			// Пользователь выбрал действие, для которого нужно менять настройки
			
			Если ВыполненноеДействие = ДействиеОбработкиРасшифровкиКомпоновкиДанных.Упорядочить Тогда
				// Если требется упорядочить - упорядочим в текущем отчете
				ОтчетОбъект.КомпоновщикНастроек.ЗагрузитьНастройки(Настройки);
				ФормаОтчета.ОбновитьОтчет();
				
			Иначе
				
				НовыйОтчет = Отчеты[ОтчетОбъект.Метаданные().Имя].Создать();
				ЗаполнитьЗначенияСвойств(НовыйОтчет, ОтчетОбъект, , "СохраненнаяНастройка");
				НовыйОтчет.КомпоновщикНастроек.ЗагрузитьНастройки(Настройки);
				
				ФормаНовогоОтчета = НовыйОтчет.ПолучитьФорму();
				НазначитьФормеУникальныйКлючИдентификации(ФормаНовогоОтчета);
				ФормаНовогоОтчета.ЭтоОтработкаРасшифровки = Истина;
				Если Не ЭтоСтараяВерсияОтчета(ОтчетОбъект) Тогда
					ФормаНовогоОтчета.РежимРедактированияНастройки = Истина;
					ФормаНовогоОтчета.ПредставлениеНастройки = "Расшифровка " + Символы.ПС + ОтчетОбъект.СохраненнаяНастройка;
				КонецЕсли;
				ФормаНовогоОтчета.Открыть();
				ФормаНовогоОтчета.ОбновитьОтчет();
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецПроцедуры
	
	// Отрабатывает расшифровки типового отчета
	функция ОбработкаРасшифровкиТиповогоОтчета(Расшифровка, СтандартнаяОбработка, ОтчетОбъект, ФормаОтчета, ДополнительныеРасшифровки = Неопределено) Экспорт
		
		//Если  ЭтоВнешнийОбъект(ОтчетОбъект) тогда
		//	Возврат Неопределено;
		//КонецЕсли;
		
		Если ТипЗнч(Расшифровка) <> Тип("ИдентификаторРасшифровкиКомпоновкиДанных") 
			И ТипЗнч(Расшифровка) <> Тип("ДанныеРасшифровкиКомпоновкиДанных") Тогда
			Возврат Неопределено;
		КонецЕсли;
		
		СтандартнаяОбработка = Ложь;
		
		ЭтоДетальнаяЗапись = ЭтоДетальнаяЗапись(ФормаОтчета.ДанныеРасшифровки, Расшифровка);
		МассивПолейРасшифровки = ПолучитьМассивПолейРасшифровки(Расшифровка, ФормаОтчета.ДанныеРасшифровки);
		МассивПолейРасшифровкиСРесурсами = ПолучитьМассивПолейРасшифровки(Расшифровка, ФормаОтчета.ДанныеРасшифровки, , Истина);
		
		ДотупноеПоле = Неопределено;
		Если МассивПолейРасшифровкиСРесурсами.Количество() > 0 тогда
			ДотупноеПоле = ПолучитьДоступноеПоле(Новый ПолеКомпоновкиДанных(МассивПолейРасшифровкиСРесурсами[0].Поле), ОтчетОбъект.КомпоновщикНастроек.Настройки.ДоступныеПоляВыбора);
		Иначе
			Возврат Неопределено;
		КонецЕсли;
		
		Команда = Неопределено;
		
		Если ЭтоДетальнаяЗапись Тогда
			Команда = "ОткрытьЗначение";
		КонецЕсли;
		
		Значение = МассивПолейРасшифровкиСРесурсами[0].Значение;
		ПолеРасшифровки = ДотупноеПоле.Поле;
		ЭтоЧисловойРесурс = ДотупноеПоле <> Неопределено И ДотупноеПоле.Ресурс И (ДотупноеПоле.Тип.СодержитТип(Тип("Число")) или ТипЗнч(Значение) = Тип("Число") или Значение = NULL);
		
		Если ЭтоЧисловойРесурс И НЕ ЭтоДетальнаяЗапись тогда
			Команда = "РасшифроватьПоле";
		Иначе
			Команда = "ОткрытьЗначение";
		КонецЕсли;
		
		//Если ЭтоЧисловойРесурс И ЭтоДетальнаяЗапись тогда
		//	Предупреждение("Поле """ + ДотупноеПоле.Заголовок + """ расшифровать не удалось, так как ");
		//	Возврат;
		//КонецЕсли;
		
		Если Команда = "ОткрытьЗначение" Тогда
			Если МассивПолейРасшифровкиСРесурсами[0].Значение <> NULL тогда
				ОткрытьЗначение(МассивПолейРасшифровкиСРесурсами[0].Значение);
			КонецЕсли;
		ИначеЕсли Команда = "РасшифроватьПоле" Тогда
			// Для расшифровки создается список значащих полей 
			// 
			// Из списка удаляем все использованные поля
			// Выведем списк расшифровки группировки для выбора пользователя
			// Откроем форму с выбранной расшифровкой
			
			СписокПолейРасшифровки = ПолучитьСписокПолейКомпоновщикаНастроек(ОтчетОбъект, ОтчетОбъект.КомпоновщикНастроек);
			
			УдалитьИспользованныеПоляРасшифровки(СписокПолейРасшифровки, МассивПолейРасшифровки);
			
			
			
			СписокДоступныхРасшифровок = Новый СписокЗначений;
			Для каждого ПолеСпискаРасшифровки из СписокПолейРасшифровки Цикл
				ДостпноеПоле = ПолучитьДоступноеПоле(Новый ПолеКомпоновкиДанных(ПолеСпискаРасшифровки.Значение), ОтчетОбъект.КомпоновщикНастроек.Настройки.ДоступныеПоляГруппировок);
				СписокДоступныхРасшифровок.Добавить(ПолеСпискаРасшифровки.Значение, ДостпноеПоле.Заголовок);
			КонецЦикла;
			
			Если ДополнительныеРасшифровки <> Неопределено тогда
				Для каждого ЭлементСписка из ДополнительныеРасшифровки Цикл
					СписокДоступныхРасшифровок.Добавить(ЭлементСписка.Значение, ЭлементСписка.Представление);
				КонецЦИкла;
			КонецЕсли;
			
			СписокДоступныхРасшифровок.Добавить("Полный список полей для расшифровки...");
			Если СписокДоступныхРасшифровок.Количество() > 1 тогда
				Поле = ФормаОтчета.ВыбратьИзМеню(СписокДоступныхРасшифровок);
				Если Поле <> Неопределено тогда
					Поле = Поле.Значение;
				Иначе 
					Возврат Неопределено;
				КонецЕсли;
			Иначе
				Поле = "Полный список полей для расшифровки...";
			КонецЕсли;
			
			Если Поле = "Полный список полей для расшифровки..." тогда
				// Расшифровать собственным отчетом
				ФормаВыбораПоля = ПолучитьОбщуюФорму("ФормаВыбораДоступногоПоляКомпоновщикаНастроек");
				ФормаВыбораПоля.КомпоновщикНастроек = ОтчетОбъект.КомпоновщикНастроек;
				РодителиПоля = Новый Массив;
				ДобавитьРодителей(ФормаОтчета.ДанныеРасшифровки.Элементы[Расшифровка], ФормаОтчета.ДанныеРасшифровки, РодителиПоля);
				ФормаВыбораПоля.РодителиПоля = РодителиПоля;
				Поле = ФормаВыбораПоля.ОткрытьМодально();
				Если Поле = Неопределено Тогда
					Возврат Неопределено;
				КонецЕсли;
				Поле = Строка(Поле.Поле);
			ИначеЕсли ДополнительныеРасшифровки <> Неопределено и ДополнительныеРасшифровки.НайтиПоЗначению(Поле) <> Неопределено тогда
				// Расшифровать собственным отчетом
				Возврат Поле;
				
			КонецЕсли;
			
			Если ДополнительныеРасшифровки <> Неопределено тогда
				МассивДляУдаления = Новый Массив;
				Для каждого ЭлементСписка из СписокДоступныхРасшифровок Цикл
					Если ДополнительныеРасшифровки.НайтиПоЗначению(ЭлементСписка.Значение) <> Неопределено тогда
						МассивДляУдаления.Добавить(ЭлементСписка);
					КонецЕсли;
				КонецЦикла;
				Для каждого ЭлементСписка из МассивДляУдаления Цикл
					СписокДоступныхРасшифровок.Удалить(ЭлементСписка);
				КонецЦИкла;
			КонецЕсли;
			
			ФормаРасшифровки = ПолучитьОбщуюФорму("ФормаРасшифровкиАналитическихОтчетов", , ФормаОтчета);
			
			СписокДоступныхРасшифровок.Удалить(СписокДоступныхРасшифровок.Количество()-1);
			
			НовыйОтчет = ТиповыеОтчетыПереопределяемый.ПолучитьОтчетДляРасшифровкиПереопределяемая(ОтчетОбъект);
			
			ФормаРасшифровки.ОтчетОбъект            = НовыйОтчет;
			ФормаРасшифровки.ТекущееПолеРасшифровка = Поле;
			ФормаРасшифровки.ФормаОтчета            = ФормаОтчета;
			ФормаРасшифровки.ДанныеРасшифровки      = ФормаОтчета.ДанныеРасшифровки;
			ФормаРасшифровки.Расшифровка            = Расшифровка;
			ФормаРасшифровки.ПолеРасшифровки        = ПолеРасшифровки;
			ФормаРасшифровки.СписокПолейРасшифровки = СписокДоступныхРасшифровок;
			
			ФормаРасшифровки.Открыть();
			ФормаРасшифровки.ОбновитьФорму();
			
			Возврат Поле; 
		КонецЕсли;
		Возврат Неопределено; 
	КонецФункции
	
	// Выводит на печать без предварительного просмотра табличный документ
	Процедура ПечатьТиповогоОтчета(Результат) Экспорт
		
		Результат.Напечатать();
		
	КонецПроцедуры
	
	// Открывает форму редактирования пользовательского поля
	Процедура РедактироватьПользовательскиеПоля(КомпоновщикНастроек, ОтчетОбъект) Экспорт
		
		КонструкторПользовательскихПолей = Обработки.КонструкторПользовательскихПолей.Создать();
		Форма = КонструкторПользовательскихПолей.ПолучитьФорму("Форма", );
		Форма.ОтчетОбъект = ОтчетОбъект;	
		Форма.КомпоновщикНастроек = КомпоновщикНастроек;
		Форма.ОткрытьМодально();
		
	КонецПроцедуры
	
	Функция ПоказатьСхему(СхемаКомпоновкиДанных, КомпоновщикНастроек, Форма) Экспорт
		
		СкопироватьНастройкиКомпоновкиДанных(СхемаКомпоновкиДанных.НастройкиПоУмолчанию, КомпоновщикНастроек.ПолучитьНастройки());
		Конструктор = Новый КонструкторСхемыКомпоновкиДанных(СхемаКомпоновкиДанных);
		Конструктор.Редактировать(Форма);
		
		Возврат Истина;
		
	КонецФункции
	
	Процедура ОбработкаИзмененияТиповогоОтчетаНаФормеОтчета(ОтчетОбъект, ФормаОтчета) Экспорт
		
		Если ОтчетОбъект.СохраненнаяНастройка <> Неопределено 
			И ОтчетОбъект.СохраненнаяНастройка.СохранятьАвтоматически Тогда
			ФормаОтчета.СохранитьНастройку();
		КонецЕсли;
		
	КонецПроцедуры
	
	/////////////////////////////////////////////////////////////////////////////////////////
	// ДИНАМИЧЕСКИЕ ОТБОРЫ
	Процедура НарисоватьПериодПолемВыбора(ОтчетОбъект, ФормаОтчета, ЗначенияНастроек, Параметры, Лево, ЕстьПериодНаГорПанели)
		
		Если Не Параметры.ДеревоНастроекСтандартныхСтраниц.Строки.Найти("Период").Использование Тогда
			Возврат;
		КонецЕсли;
		
		ПараметрыИсполненияОтчета = Неопределено;
		ПараметрыИсполненияОтчета = ОтчетОбъект.ПолучитьПараметрыИсполненияОтчета();
		
		Если ПараметрыИсполненияОтчета = Неопределено или НЕ ПараметрыИсполненияОтчета.Свойство("МинимальныйПериодОтчета") тогда
			Возврат;
		КонецЕсли;
		
		МинимальныйПериодОтчета = ПараметрыИсполненияОтчета.МинимальныйПериодОтчета;
		
		ЭлементыФормы = ФормаОтчета.ЭлементыФормы;
		КомпоновщикНастроек = ОтчетОбъект.КомпоновщикНастроек;
		
		ЦветФонаКнопки = Новый Цвет(246, 244, 236);
		
		// Закладка Стандартный Период
		ЗначениеПараметраНачалоПериода = КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("НачалоПериода"));
		ЗначениеПараметраКонецПериода  = КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("КонецПериода"));
		Лево = 0;
		
		// Стандартный период
		Если ЗначениеПараметраНачалоПериода <> Неопределено
			И ЗначениеПараметраКонецПериода <> Неопределено Тогда
			
			//	   	Панель = Неопределено;
			ЭлементыФормы.ПанельПользователяГоризонтальная.ТекущаяСтраница = ЭлементыФормы.ПанельПользователяГоризонтальная.Страницы.ГоризонтальныеОтборы;
			Панель = ЭлементыФормы.ПанельПользователяГоризонтальная;
			
			Верх = 6;
			
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("ПолеВвода"), "ДинамическийОтборСтандартныйПериод",, Панель);
			НовыйЭлемент.Данные = "СтандартныйПериод";
			НовыйЭлемент.Видимость = Ложь;
			
			// Поле выбора Стандартный период
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("ПолеВыбора"), "ДинамическийОтборСтандартныйПериодПользователя",, Панель);
			НовыйЭлемент.Верх = Верх;
			НовыйЭлемент.Лево = Лево;
			НовыйЭлемент.Ширина = 200;
			НовыйЭлемент.ТипЗначения = Новый ОписаниеТипов("Строка");
			НовыйЭлемент.ЦветФонаКнопки = ЦветФонаКнопки;
			//НовыйЭлемент.РедактированиеТекста = ложь;
			СписокВыбора = ПолучитьСписокВыбораСтандартногоПериодаПользователя(Параметры);;
			НовыйЭлемент.СписокВыбора = СписокВыбора;
			Действие = ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиСтандартныйПериодПользователяПриИзменении;
			НовыйЭлемент.УстановитьДействие("ПриИзменении", Действие);
			//УстановитьПравуюПривязку(НовыйЭлемент, ЭлементыФормы.ПанельЗакладок);
			
			// Восстанавливаем значение
			Если ЗначенияНастроек.Свойство("СтандартныйПериод") Тогда
				СтандартныйПериод = ЗначенияНастроек.СтандартныйПериод;
				Если СписокВыбора.НайтиПоЗначению(СтандартныйПериод.Вариант) <> Неопределено Тогда
					НовыйЭлемент.Значение = СтандартныйПериод.Вариант;
					ФормаОтчета.СтандартныйПериод = СтандартныйПериод;
				КонецЕсли;
			КонецЕсли;
			
			УстановитьДопустимоеЗначениеСпискаВыбора(НовыйЭлемент, ФормаОтчета.СтандартныйПериод);
			
			//Верх = Верх + НовыйЭлемент.Высота + 6;
			Лево = Лево + НовыйЭлемент.Ширина + 6;
			
			// Надпись с
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("Надпись"), "ДинамическийОтборНадписьС",, Панель);
			НовыйЭлемент.Верх = Верх+2;
			НовыйЭлемент.Лево = Лево;
			НовыйЭлемент.Ширина = 40;
			НовыйЭлемент.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Право;
			НовыйЭлемент.Заголовок = "период:";
			//УстановитьПравуюПривязку(НовыйЭлемент, ЭлементыФормы.ПанельЗакладок);
			
			Лево = Лево + НовыйЭлемент.Ширина + 6;
			
			// Дата с
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("ПолеВвода"), "ДинамическийОтборПериодВыбор",, Панель);
			НовыйЭлемент.Верх = Верх;
			НовыйЭлемент.Лево = Лево;
			НовыйЭлемент.КнопкаВыбора = ложь;
			НовыйЭлемент.Ширина = 130;
			НовыйЭлемент.ТипЗначения = Новый ОписаниеТипов("Строка");
			НовыйЭлемент.ЦветФонаКнопки = ЦветФонаКнопки;
			НовыйЭлемент.Данные = "";
			НовыйЭлемент.КнопкаСпискаВыбора = истина;
			
			НовыйЭлемент.Значение = ПолучитьПредставлениеПериода(ФормаОтчета.СтандартныйПериод.ДатаНачала, ФормаОтчета.СтандартныйПериод.ДатаОкончания, МинимальныйПериодОтчета); 
			
			Действие = ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиДинамическийОтборПериодВыборПриИзменении;
			НовыйЭлемент.УстановитьДействие("ПриИзменении", Действие);
			
			Действие = ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиДинамическийОтборПериодВыборПриНачалеВыбораИзСписка;
			НовыйЭлемент.УстановитьДействие("НачалоВыбораИзСписка", Действие);
			
			Действие = ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиДинамическийОтборПериодВыборАвтоПодборТекста;
			НовыйЭлемент.УстановитьДействие("АвтоПодборТекста", Действие);
			
			Действие = ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиДинамическийОтборПериодВыборОчистка;
			НовыйЭлемент.УстановитьДействие("Очистка", Действие);
			
			Действие = ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиДинамическийОтборПериодВыборОкончаниеВводаТекста;
			НовыйЭлемент.УстановитьДействие("ОкончаниеВводаТекста", Действие);
			
			Лево = Лево + НовыйЭлемент.Ширина + 6;
			ЕстьПериодНаГорПанели = Истина;
			
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("Кнопка"), "ДинамическийОтборПериодаВыборПериода",, Панель);
			НовыйЭлемент.Заголовок = "...";
			НовыйЭлемент.Верх = Верх;
			НовыйЭлемент.Лево = Лево;
			НовыйЭлемент.Ширина = 15;
			НовыйЭлемент.Высота = 19;
			НовыйЭлемент.Подсказка = "Выбор произвольного периода";
			Лево = Лево + НовыйЭлемент.Ширина + 6;
			
			Действие = ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиИзменениеЗначенияДинамическогоОтбора;
			НовыйЭлемент.УстановитьДействие("Нажатие", Действие);
		
		КонецЕсли;
		
		Если ЗначениеПараметраНачалоПериода <> Неопределено	И ЗначениеПараметраКонецПериода <> Неопределено Тогда
			Лево = Лево + 16;
		КонецЕсли;
		
	КонецПроцедуры
	Процедура НарисоватьСтандартныйПериод(ОтчетОбъект, ФормаОтчета, ЗначенияНастроек, Параметры, Лево, ЕстьПериодНаГорПанели)
		
		Если Не Параметры.ДеревоНастроекСтандартныхСтраниц.Строки.Найти("Период").Использование Тогда
			Возврат;
		КонецЕсли;
		
		ПараметрыИсполненияОтчета = Неопределено;
		ПараметрыИсполненияОтчета = ОтчетОбъект.ПолучитьПараметрыИсполненияОтчета();
		
		Если ПараметрыИсполненияОтчета <> Неопределено и ПараметрыИсполненияОтчета.Свойство("МинимальныйПериодОтчета") тогда
			НарисоватьПериодПолемВыбора(ОтчетОбъект, ФормаОтчета, ЗначенияНастроек, Параметры, Лево, ЕстьПериодНаГорПанели);
			Возврат;
		КонецЕсли;
		
		ЭлементыФормы = ФормаОтчета.ЭлементыФормы;
		КомпоновщикНастроек = ОтчетОбъект.КомпоновщикНастроек;
		
		ЦветФонаКнопки = Новый Цвет(246, 244, 236);
		// Закладка Стандартный Период
		ЗначениеПараметраНачалоПериода = КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("НачалоПериода"));
		ЗначениеПараметраКонецПериода  = КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("КонецПериода"));
		ЗначениеПараметраПериод        = КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("Период"));
		Лево = 0;
		
		// Стандартный период
		Если ЗначениеПараметраНачалоПериода <> Неопределено
			И ЗначениеПараметраКонецПериода <> Неопределено Тогда
			
			//	   	Панель = Неопределено;
			ЭлементыФормы.ПанельПользователяГоризонтальная.ТекущаяСтраница = ЭлементыФормы.ПанельПользователяГоризонтальная.Страницы.ГоризонтальныеОтборы;
			Панель = ЭлементыФормы.ПанельПользователяГоризонтальная;
			
			Верх = 6;
			
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("ПолеВвода"), "ДинамическийОтборСтандартныйПериод",, Панель);
			НовыйЭлемент.Данные = "СтандартныйПериод";
			НовыйЭлемент.Видимость = Ложь;
			
			// Поле выбора Стандартный период
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("ПолеВыбора"), "ДинамическийОтборСтандартныйПериодПользователя",, Панель);
			НовыйЭлемент.Верх = Верх;
			НовыйЭлемент.Лево = Лево;
			НовыйЭлемент.Ширина = 200;
			НовыйЭлемент.ТипЗначения = Новый ОписаниеТипов("Строка");
			НовыйЭлемент.ЦветФонаКнопки = ЦветФонаКнопки;
			//НовыйЭлемент.РедактированиеТекста = ложь;
			СписокВыбора = ПолучитьСписокВыбораСтандартногоПериодаПользователя(Параметры);;
			НовыйЭлемент.СписокВыбора = СписокВыбора;
			Действие = ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиСтандартныйПериодПользователяПриИзменении;
			НовыйЭлемент.УстановитьДействие("ПриИзменении", Действие);
			//УстановитьПравуюПривязку(НовыйЭлемент, ЭлементыФормы.ПанельЗакладок);
			
			// Восстанавливаем значение
			Если ЗначенияНастроек.Свойство("СтандартныйПериод") Тогда
				СтандартныйПериод = ЗначенияНастроек.СтандартныйПериод;
				Если СписокВыбора.НайтиПоЗначению(СтандартныйПериод.Вариант) <> Неопределено Тогда
					НовыйЭлемент.Значение = СтандартныйПериод.Вариант;
					ФормаОтчета.СтандартныйПериод = СтандартныйПериод;
				КонецЕсли;
			КонецЕсли;
			
			УстановитьДопустимоеЗначениеСпискаВыбора(НовыйЭлемент, ФормаОтчета.СтандартныйПериод);
			
			//Верх = Верх + НовыйЭлемент.Высота + 6;
			Лево = Лево + НовыйЭлемент.Ширина + 6;
			
			// Надпись с
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("Надпись"), "ДинамическийОтборНадписьС",, Панель);
			НовыйЭлемент.Верх = Верх+2;
			НовыйЭлемент.Лево = Лево;
			НовыйЭлемент.Ширина = 6;
			НовыйЭлемент.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Право;
			НовыйЭлемент.Заголовок = "с:";
			//УстановитьПравуюПривязку(НовыйЭлемент, ЭлементыФормы.ПанельЗакладок);
			
			Лево = Лево + НовыйЭлемент.Ширина + 6;
			
			// Дата с
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("ПолеВвода"), "ДинамическийОтборДатаНачала",, Панель);
			НовыйЭлемент.Верх = Верх;
			НовыйЭлемент.Лево = Лево;
			НовыйЭлемент.Ширина = 80;
			НовыйЭлемент.ТипЗначения = Новый ОписаниеТипов("Дата",,, Новый КвалификаторыДаты(ЧастиДаты.Дата));
			НовыйЭлемент.ЦветФонаКнопки = ЦветФонаКнопки;
			НовыйЭлемент.Данные = "СтандартныйПериод.ДатаНачала";
			НовыйЭлемент.Доступность = СписокВыбора.НайтиПоЗначению(ВариантСтандартногоПериода.ПроизвольныйПериод) <> Неопределено;
			Действие = ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиДатаСтандартногоПериодаПриИзменении;
			НовыйЭлемент.УстановитьДействие("ПриИзменении", Действие);
			//УстановитьПравуюПривязку(НовыйЭлемент, ЭлементыФормы.ПанельЗакладок);
			Лево = Лево + НовыйЭлемент.Ширина + 6;
			
			
			// Надпись по
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("Надпись"), "ДинамическийОтборНадписьПо",, Панель);
			НовыйЭлемент.Верх = Верх+2;
			НовыйЭлемент.Лево = Лево;
			НовыйЭлемент.Ширина = 6;
			НовыйЭлемент.Заголовок = "по:";
			НовыйЭлемент.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Право;
			Лево = Лево + НовыйЭлемент.Ширина + 6;
			//УстановитьПравуюПривязку(НовыйЭлемент, ЭлементыФормы.ПанельЗакладок);
			
			
			// Дата по
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("ПолеВвода"), "ДинамическийОтборДатаОкончания",, Панель);
			НовыйЭлемент.Верх = Верх;
			НовыйЭлемент.Лево = Лево;
			НовыйЭлемент.Ширина = 80;
			НовыйЭлемент.ТипЗначения = Новый ОписаниеТипов("Дата",,, Новый КвалификаторыДаты(ЧастиДаты.Дата));
			НовыйЭлемент.ЦветФонаКнопки = ЦветФонаКнопки;
			НовыйЭлемент.Данные = "СтандартныйПериод.ДатаОкончания";
			НовыйЭлемент.Доступность = СписокВыбора.НайтиПоЗначению(ВариантСтандартногоПериода.ПроизвольныйПериод) <> Неопределено;
			Действие = ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиДатаСтандартногоПериодаПриИзменении;
			НовыйЭлемент.УстановитьДействие("ПриИзменении", Действие);
			Лево = Лево + НовыйЭлемент.Ширина + 6;
			//УстановитьПравуюПривязку(НовыйЭлемент, ЭлементыФормы.ПанельЗакладок);
			ЕстьПериодНаГорПанели = Истина;
			
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("Кнопка"), "ДинамическийОтборПериодаВыборПериода",, Панель);
			НовыйЭлемент.Заголовок = "...";
			НовыйЭлемент.Верх = Верх;
			НовыйЭлемент.Лево = Лево;
			НовыйЭлемент.Ширина = 15;
			НовыйЭлемент.Высота = 19
			;
			Лево = Лево + НовыйЭлемент.Ширина + 6;
			
			Действие = ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиИзменениеЗначенияДинамическогоОтбора;
			НовыйЭлемент.УстановитьДействие("Нажатие", Действие);
		
		КонецЕсли;
		
		// Стандартная дата начала
		Если ЗначениеПараметраПериод <> Неопределено Тогда
			//НоваяСтраница = ЭлементыФормы.ПанельЗакладок.Страницы.Вставить(0, "ДинамическийОтборСтандартнаяДатаНачала", "Период");
			//НоваяСтраница = ЭлементыФормы.ПанельЗакладок.Страницы.Добавить("ДинамическийОтборСтандартнаяДатаНачала", "Период");
			//Количество = ЭлементыФормы.ПанельЗакладок.Страницы.Количество();
			//ЭлементыФормы.ПанельЗакладок.Страницы.Сдвинуть(НоваяСтраница, -(Количество-1));
			//НоваяСтраница.Раскрыта = Истина;
			
			ЭлементыФормы.ПанельПользователяГоризонтальная.ТекущаяСтраница = ЭлементыФормы.ПанельПользователяГоризонтальная.Страницы.ГоризонтальныеОтборы;
			
			Верх = 6;
			
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("ПолеВвода"), "ДинамическийОтборСтандартнаяДатаНачала",, ЭлементыФормы.ПанельПользователяГоризонтальная);
			НовыйЭлемент.Данные = "СтандартнаяДатаНачала";
			НовыйЭлемент.Видимость = Ложь;
			
			// Поле выбора Стандартная дата начала
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("ПолеВыбора"), "ДинамическийОтборСтандартнаяДатаНачалаПользователя",, ЭлементыФормы.ПанельПользователяГоризонтальная);
			НовыйЭлемент.Верх = Верх;
			НовыйЭлемент.Лево = Лево;
			НовыйЭлемент.Ширина = 200;
			НовыйЭлемент.Высота = 19;
			НовыйЭлемент.ТипЗначения = Новый ОписаниеТипов("Строка");
			//		НовыйЭлемент.РедактированиеТекста = ложь;
			НовыйЭлемент.ЦветФонаКнопки = ЦветФонаКнопки;
			СписокВыбора = ПолучитьСписокВыбораСтандартнойДатыНачалаПользователя(Параметры);
			НовыйЭлемент.СписокВыбора = СписокВыбора;
			Действие = ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиСтандартнаяДатаНачалаПользователяПриИзменении;
			НовыйЭлемент.УстановитьДействие("ПриИзменении", Действие);
			//		УстановитьПравуюПривязку(НовыйЭлемент, ЭлементыФормы.ПанельЗакладок);
			
			// Восстанавливаем значение варианта стандартной даты начала
			Если ЗначенияНастроек.Свойство("СтандартнаяДатаНачала") Тогда
				СтандартнаяДатаНачала = ЗначенияНастроек.СтандартнаяДатаНачала;
				Если СписокВыбора.НайтиПоЗначению(СтандартнаяДатаНачала.Вариант) <> Неопределено Тогда
					НовыйЭлемент.Значение = СтандартнаяДатаНачала.Вариант;
					ФормаОтчета.СтандартнаяДатаНачала = СтандартнаяДатаНачала;
				КонецЕсли;
			КонецЕсли;
			
			УстановитьДопустимоеЗначениеСпискаВыбора(НовыйЭлемент, ФормаОтчета.СтандартнаяДатаНачала);
			
			Лево = Лево + НовыйЭлемент.Ширина + 6;
			//Верх = Верх + 19 + 6;
			
			// Надпись дата
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("Надпись"), "ДинамическийОтборНадписьДата",, ЭлементыФормы.ПанельПользователяГоризонтальная);
			НовыйЭлемент.Верх = Верх+2;
			НовыйЭлемент.Лево = Лево;
			НовыйЭлемент.Ширина = 26;
			НовыйЭлемент.Заголовок = "дата:";
			Лево = Лево + НовыйЭлемент.Ширина + 6;
			//УстановитьПравуюПривязку(НовыйЭлемент, ЭлементыФормы.ПанельЗакладок);
			
			
			// Поле ввода даты
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("ПолеВвода"), "ДинамическийОтборДата",, ЭлементыФормы.ПанельПользователяГоризонтальная);
			НовыйЭлемент.Верх = Верх;
			НовыйЭлемент.Лево = Лево;
			НовыйЭлемент.Ширина = 80;
			НовыйЭлемент.ТипЗначения = Новый ОписаниеТипов("Дата",,, Новый КвалификаторыДаты(ЧастиДаты.Дата));
			НовыйЭлемент.ЦветФонаКнопки = ЦветФонаКнопки;
			НовыйЭлемент.Данные = "СтандартнаяДатаНачала.Дата";
			НовыйЭлемент.Доступность = СписокВыбора.НайтиПоЗначению(ВариантСтандартнойДатыНачала.ПроизвольнаяДата) <> Неопределено;
			Действие = ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиДатаСтандартнойДатыНачалаПриИзменении;
			НовыйЭлемент.УстановитьДействие("ПриИзменении", Действие);
			Лево = Лево + НовыйЭлемент.Ширина + 6;
			//УстановитьПравуюПривязку(НовыйЭлемент, ЭлементыФормы.ПанельЗакладок);
			
			// Восстанавливаем значение
			//Если ЗначенияНастроек.Свойство("СтандартнаяДатаНачала") Тогда
			//	СтандартнаяДатаНачала = ЗначенияНастроек.СтандартнаяДатаНачала;
			//	НовыйЭлемент.Значение = СтандартнаяДатаНачала.Дата;
			//КонецЕсли;
			
			ЕстьПериодНаГорПанели = Истина;
			
		КонецЕсли;
		
		Если ЗначениеПараметраПериод <> Неопределено ИЛИ (ЗначениеПараметраНачалоПериода <> Неопределено 
			И ЗначениеПараметраКонецПериода <> Неопределено) Тогда
			Лево = Лево + 16;
		КонецЕсли;
		
	КонецПроцедуры
	
	Процедура НарисоватьСтандартныйПериодНаПравойПанели(ОтчетОбъект, ФормаОтчета, ЗначенияНастроек, Параметры, ПараметрыИсполненияОтчета = Неопределено)
		
		Если Не Параметры.ДеревоНастроекСтандартныхСтраниц.Строки.Найти("Период").Использование Тогда
			Возврат;
		КонецЕсли;
		
		СтруктураЭлементовУправления = Новый Структура("
		|СтраницаПанели, 
		|ДинамическийОтборСтандартныйПериод, 
		|ДинамическийОтборСтандартныйПериодПользователя,
		|ДинамическийОтборСтандартнаяДатаНачала,
		|ДинамическийОтборСтандартнаяДатаНачалаПользователя,
		|ДинамическийОтборНадписьС,
		|ДинамическийОтборДатаНачала,
		|ДинамическийОтборНадписьПо,
		|ДинамическийОтборДатаОкончания,
		|ДинамическийОтборНадписьДата,
		|ДинамическийОтборДата");
		
		ЭлементыФормы = ФормаОтчета.ЭлементыФормы;
		КомпоновщикНастроек = ОтчетОбъект.КомпоновщикНастроек;
		
		ЦветФонаКнопки = Новый Цвет(246, 244, 236);
		// Закладка Стандартный Период
		ЗначениеПараметраНачалоПериода = КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("НачалоПериода"));
		ЗначениеПараметраКонецПериода  = КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("КонецПериода"));
		ЗначениеПараметраПериод        = КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("Период"));
		
		// Стандартный период
		Если ЗначениеПараметраНачалоПериода <> Неопределено
			И ЗначениеПараметраКонецПериода <> Неопределено Тогда
			//НоваяСтраница = ЭлементыФормы.ПанельЗакладок.Страницы.Вставить(0, "ДинамическийОтборСтандартныйПериод", "Период");
			НоваяСтраница = ЭлементыФормы.ПанельЗакладок.Страницы.Добавить("ДинамическийОтборСтандартныйПериод", "Период");
			Количество = ЭлементыФормы.ПанельЗакладок.Страницы.Количество();
			ЭлементыФормы.ПанельЗакладок.Страницы.Сдвинуть(НоваяСтраница, -(Количество-1));
			НоваяСтраница.Раскрыта = Истина;
			СтруктураЭлементовУправления.СтраницаПанели = НоваяСтраница;
			
			ЭлементыФормы.ПанельЗакладок.ТекущаяСтраница = НоваяСтраница;
			Верх = 6;
			
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("ПолеВвода"), "ДинамическийОтборСтандартныйПериод",, ЭлементыФормы.ПанельЗакладок);
			НовыйЭлемент.Данные = "СтандартныйПериод";
			НовыйЭлемент.Видимость = Ложь;
			СтруктураЭлементовУправления.ДинамическийОтборСтандартныйПериод = НовыйЭлемент;
			
			// Поле выбора Стандартный период
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("ПолеВыбора"), "ДинамическийОтборСтандартныйПериодПользователя",, ЭлементыФормы.ПанельЗакладок);
			НовыйЭлемент.Верх = Верх;
			НовыйЭлемент.Лево = 6;
			НовыйЭлемент.Ширина = 292;
			НовыйЭлемент.ТипЗначения = Новый ОписаниеТипов("Строка");
			НовыйЭлемент.ЦветФонаКнопки = ЦветФонаКнопки;
			СписокВыбора = ПолучитьСписокВыбораСтандартногоПериодаПользователя(Параметры);;
			НовыйЭлемент.СписокВыбора = СписокВыбора;
			Действие = ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиСтандартныйПериодПользователяПриИзменении;
			НовыйЭлемент.УстановитьДействие("ПриИзменении", Действие);
			УстановитьПравуюПривязку(НовыйЭлемент, ЭлементыФормы.ПанельЗакладок);
			СтруктураЭлементовУправления.ДинамическийОтборСтандартныйПериодПользователя = НовыйЭлемент;
			
			
			// Восстанавливаем значение
			Если ЗначенияНастроек.Свойство("СтандартныйПериод") Тогда
				СтандартныйПериод = ЗначенияНастроек.СтандартныйПериод;
				Если СписокВыбора.НайтиПоЗначению(СтандартныйПериод.Вариант) <> Неопределено Тогда
					НовыйЭлемент.Значение = СтандартныйПериод.Вариант;
					ФормаОтчета.СтандартныйПериод = СтандартныйПериод;
				КонецЕсли;
			КонецЕсли;
			
			УстановитьДопустимоеЗначениеСпискаВыбора(НовыйЭлемент, ФормаОтчета.СтандартныйПериод);
			
			Верх = Верх + НовыйЭлемент.Высота + 6;
			
			// Надпись с
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("Надпись"), "ДинамическийОтборНадписьС",, ЭлементыФормы.ПанельЗакладок);
			НовыйЭлемент.Верх = Верх;
			НовыйЭлемент.Лево = 6;
			НовыйЭлемент.Ширина = 6;
			НовыйЭлемент.Заголовок = "с:";
			СтруктураЭлементовУправления.ДинамическийОтборНадписьС = НовыйЭлемент;
			
			// Дата с
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("ПолеВвода"), "ДинамическийОтборДатаНачала",, ЭлементыФормы.ПанельЗакладок);
			НовыйЭлемент.Верх = Верх;
			НовыйЭлемент.Лево = 20;
			НовыйЭлемент.Ширина = 80;
			НовыйЭлемент.ТипЗначения = Новый ОписаниеТипов("Дата",,, Новый КвалификаторыДаты(ЧастиДаты.Дата));
			НовыйЭлемент.ЦветФонаКнопки = ЦветФонаКнопки;
			НовыйЭлемент.Данные = "СтандартныйПериод.ДатаНачала";
			НовыйЭлемент.Доступность = СписокВыбора.НайтиПоЗначению(ВариантСтандартногоПериода.ПроизвольныйПериод) <> Неопределено;
			Действие = ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиДатаСтандартногоПериодаПриИзменении;
			НовыйЭлемент.УстановитьДействие("ПриИзменении", Действие);
			СтруктураЭлементовУправления.ДинамическийОтборНадписьС = НовыйЭлемент;
			
			
			// Надпись по
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("Надпись"), "ДинамическийОтборНадписьПо",, ЭлементыФормы.ПанельЗакладок);
			НовыйЭлемент.Верх = Верх;
			НовыйЭлемент.Лево = 110;
			НовыйЭлемент.Ширина = 6;
			НовыйЭлемент.Заголовок = "по:";
			СтруктураЭлементовУправления.ДинамическийОтборНадписьПо = НовыйЭлемент;
			
			// Дата по
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("ПолеВвода"), "ДинамическийОтборДатаОкончания",, ЭлементыФормы.ПанельЗакладок);
			НовыйЭлемент.Верх = Верх;
			НовыйЭлемент.Лево = 128;
			НовыйЭлемент.Ширина = 80;
			НовыйЭлемент.ТипЗначения = Новый ОписаниеТипов("Дата",,, Новый КвалификаторыДаты(ЧастиДаты.Дата));
			НовыйЭлемент.ЦветФонаКнопки = ЦветФонаКнопки;
			НовыйЭлемент.Данные = "СтандартныйПериод.ДатаОкончания";
			НовыйЭлемент.Доступность = СписокВыбора.НайтиПоЗначению(ВариантСтандартногоПериода.ПроизвольныйПериод) <> Неопределено;
			Действие = ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиДатаСтандартногоПериодаПриИзменении;
			НовыйЭлемент.УстановитьДействие("ПриИзменении", Действие);
			СтруктураЭлементовУправления.ДинамическийОтборДатаОкончания = НовыйЭлемент;
			
			
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("Кнопка"), "ДинамическийОтборПериодаВыборПериода",, ЭлементыФормы.ПанельЗакладок);
			НовыйЭлемент.Заголовок = "...";
			НовыйЭлемент.Верх = Верх;
			НовыйЭлемент.Лево = 214;
			НовыйЭлемент.Ширина = 20;
			Действие = Новый Действие("ДействияПанелиИзменениеЗначенияДинамическогоОтбора");
			НовыйЭлемент.УстановитьДействие("Нажатие", Действие);
			
		КонецЕсли;
		
		// Стандартная дата начала
		Если ЗначениеПараметраПериод <> Неопределено Тогда
			//НоваяСтраница = ЭлементыФормы.ПанельЗакладок.Страницы.Вставить(0, "ДинамическийОтборСтандартнаяДатаНачала", "Период");
			НоваяСтраница = ЭлементыФормы.ПанельЗакладок.Страницы.Добавить("ДинамическийОтборСтандартнаяДатаНачала", "Период");
			Количество = ЭлементыФормы.ПанельЗакладок.Страницы.Количество();
			ЭлементыФормы.ПанельЗакладок.Страницы.Сдвинуть(НоваяСтраница, -(Количество-1));
			НоваяСтраница.Раскрыта = Истина;
			
			ЭлементыФормы.ПанельЗакладок.ТекущаяСтраница = НоваяСтраница;
			СтруктураЭлементовУправления.СтраницаПанели = НоваяСтраница;
			
			Верх = 6;
			
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("ПолеВвода"), "ДинамическийОтборСтандартнаяДатаНачала",, ЭлементыФормы.ПанельЗакладок);
			НовыйЭлемент.Данные = "СтандартнаяДатаНачала";
			НовыйЭлемент.Видимость = Ложь;
			СтруктураЭлементовУправления.ДинамическийОтборСтандартнаяДатаНачала = НовыйЭлемент;
			
			
			// Поле выбора Стандартная дата начала
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("ПолеВыбора"), "ДинамическийОтборСтандартнаяДатаНачалаПользователя",, ЭлементыФормы.ПанельЗакладок);
			НовыйЭлемент.Верх = Верх;
			НовыйЭлемент.Лево = 6;
			НовыйЭлемент.Ширина = 292;
			НовыйЭлемент.ТипЗначения = Новый ОписаниеТипов("Строка");
			НовыйЭлемент.ЦветФонаКнопки = ЦветФонаКнопки;
			СписокВыбора = ПолучитьСписокВыбораСтандартнойДатыНачалаПользователя(Параметры);
			НовыйЭлемент.СписокВыбора = СписокВыбора;
			Действие = ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиСтандартнаяДатаНачалаПользователяПриИзменении;
			НовыйЭлемент.УстановитьДействие("ПриИзменении", Действие);
			УстановитьПравуюПривязку(НовыйЭлемент, ЭлементыФормы.ПанельЗакладок);
			СтруктураЭлементовУправления.ДинамическийОтборСтандартнаяДатаНачалаПользователя = НовыйЭлемент;
			
			
			// Восстанавливаем значение варианта стандартной даты начала
			Если ЗначенияНастроек.Свойство("СтандартнаяДатаНачала") Тогда
				СтандартнаяДатаНачала = ЗначенияНастроек.СтандартнаяДатаНачала;
				Если СписокВыбора.НайтиПоЗначению(СтандартнаяДатаНачала.Вариант) <> Неопределено Тогда
					НовыйЭлемент.Значение = СтандартнаяДатаНачала.Вариант;
					ФормаОтчета.СтандартнаяДатаНачала = СтандартнаяДатаНачала;
				КонецЕсли;
			КонецЕсли;
			
			УстановитьДопустимоеЗначениеСпискаВыбора(НовыйЭлемент, ФормаОтчета.СтандартнаяДатаНачала);
			
			Верх = Верх + 19 + 6;
			
			// Надпись дата
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("Надпись"), "ДинамическийОтборНадписьДата",, ЭлементыФормы.ПанельЗакладок);
			НовыйЭлемент.Верх = Верх + 3;
			НовыйЭлемент.Лево = 6;
			НовыйЭлемент.Ширина = 26;
			НовыйЭлемент.Заголовок = "дата:";
			СтруктураЭлементовУправления.ДинамическийОтборНадписьДата = НовыйЭлемент;
			
			// Поле ввода даты
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("ПолеВвода"), "ДинамическийОтборДата",, ЭлементыФормы.ПанельЗакладок);
			НовыйЭлемент.Верх = Верх;
			НовыйЭлемент.Лево = 40;
			НовыйЭлемент.Ширина = 80;
			НовыйЭлемент.ТипЗначения = Новый ОписаниеТипов("Дата",,, Новый КвалификаторыДаты(ЧастиДаты.Дата));
			НовыйЭлемент.ЦветФонаКнопки = ЦветФонаКнопки;
			НовыйЭлемент.Данные = "СтандартнаяДатаНачала.Дата";
			НовыйЭлемент.Доступность = СписокВыбора.НайтиПоЗначению(ВариантСтандартнойДатыНачала.ПроизвольнаяДата) <> Неопределено;
			Действие = ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиДатаСтандартнойДатыНачалаПриИзменении;
			НовыйЭлемент.УстановитьДействие("ПриИзменении", Действие);
			СтруктураЭлементовУправления.ДинамическийОтборДата = НовыйЭлемент;
			
			// Восстанавливаем значение
			Если ЗначенияНастроек.Свойство("СтандартнаяДатаНачала") Тогда
				СтандартнаяДатаНачала = ЗначенияНастроек.СтандартнаяДатаНачала;
				НовыйЭлемент.Значение = СтандартнаяДатаНачала.Дата;
			КонецЕсли;
			
		
		КонецЕсли;
		
		Если ПараметрыИсполненияОтчета <> Неопределено И ПараметрыИсполненияОтчета.Свойство("ПослеВыводаПериода") И ПараметрыИсполненияОтчета.ПослеВыводаПериода тогда
			ФормаОтчета.ПослеВыводаПериода(СтруктураЭлементовУправления);
		КонецЕсли;
	КонецПроцедуры
	
	Процедура НарисоватьДинамическийОтборГоризонтальнойПанели(ФормаОтчета, Индекс, Лево, ЦветФонаКнопки, СтрокаОтбора, ЭлементДинамическогоОтбора, ДоступноеПоле, ПоследнийЭлемент = ложь, Список = истина, ПараметрыИсполненияОтчета = Неопределено, ПредыдущийЭлемент, СреднийРазмерЭлементаУправления)
		
		Если ДоступноеПоле = Неопределено тогда
			Возврат;
		КонецЕсли;
		
		СтруктураЭлементовУправления = Новый Структура("
		|СтрокаОтбора, 
		|СтраницаПанели, 
		|ДинамическийОтборНадпись, 
		|ДинамическийОтборПолеВвода");
		
		СтруктураЭлементовУправления.СтрокаОтбора = СтрокаОтбора;
		ЭлементыФормы        = ФормаОтчета.ЭлементыФормы;
		ШиринаПанелиЗакладки = ЭлементыФормы.ПанельПользователяГоризонтальная.Ширина;
		СтруктураЭлементовУправления.СтраницаПанели = ЭлементыФормы.ПанельПользователяГоризонтальная.ТекущаяСтраница;
		
		НовыйЭлементНадпись = ЭлементыФормы.Добавить(Тип("Надпись"), "ДинамическийОтбор" + Индекс + "Надпись", Истина, ЭлементыФормы.ПанельПользователяГоризонтальная);
		НовыйЭлементНадпись.Верх = 6;
		НовыйЭлементНадпись.Лево = Лево;
		СреднийРазмерЭлементаУправления = ?(СреднийРазмерЭлементаУправления = Неопределено, СтрДлина(СтрокаОтбора.Представление)*7, СреднийРазмерЭлементаУправления);
		НовыйЭлементНадпись.Ширина = ?(СреднийРазмерЭлементаУправления > СтрДлина(СтрокаОтбора.Представление)*7, СтрДлина(СтрокаОтбора.Представление)*7, СреднийРазмерЭлементаУправления);
		НовыйЭлементНадпись.Заголовок = СтрокаОтбора.Представление+":";
		НовыйЭлементНадпись.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Право;
		Лево = Лево + НовыйЭлементНадпись.Ширина + 6;
		//УстановитьПравуюПривязку(НовыйЭлемент, ЭлементыФормы.ПанельЗакладок);
		СтруктураЭлементовУправления.ДинамическийОтборНадпись = НовыйЭлементНадпись;
		Если ПредыдущийЭлемент = Неопределено тогда
			УстановитьЛевуюПривязку(НовыйЭлементНадпись, ЭлементыФормы.ПанельПользователяГоризонтальная)
		Иначе
			УстановитьПривязкуКПравойГранице(НовыйЭлементНадпись, ПредыдущийЭлемент, ЭлементыФормы.ПанельПользователяГоризонтальная);
		КонецЕсли;
		УстановитьПривязкуКЛевойГранице(НовыйЭлементНадпись, НовыйЭлементНадпись, ЭлементыФормы.ПанельПользователяГоризонтальная);
		
		
		НовыйЭлемент = ЭлементыФормы.Добавить(Тип("ПолеВвода"), "ДинамическийОтбор" + Индекс + "ПолеВвода", Истина, ЭлементыФормы.ПанельПользователяГоризонтальная);
		НовыйЭлемент.Верх = 6;
		НовыйЭлемент.Лево = Лево;
		Если Найти(Строка(ДоступноеПоле.Тип),"ПланСчетов") <> 0 тогда
			НовыйЭлемент.Ширина = СреднийРазмерЭлементаУправления/2.5; 
		Иначе
			НовыйЭлемент.Ширина = ?(ПоследнийЭлемент, ШиринаПанелиЗакладки - Лево, СреднийРазмерЭлементаУправления); 
		КонецЕсли;
		НовыйЭлемент.ТипЗначения	   = ДоступноеПоле.Тип;
		Если Список тогда
			НовыйЭлемент.Значение          = Новый СписокЗначений;
			НовыйЭлемент.ТипЗначения       = Новый ОписаниеТипов("СписокЗначений");
			НовыйЭлемент.ТипЗначенияСписка = ДоступноеПоле.Тип;
		КонецЕсли;
		НовыйЭлемент.ЦветФонаКнопки    = ЦветФонаКнопки;
		НовыйЭлемент.УстановитьДействие("ПриИзменении", ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиИзменениеЗначенияДинамическогоОтбора);
		Если ФормаОтчета.ДействияЭлементовФормы.Свойство("ДействияПанелиНачалоВыбораЗначенияДинамическогоОтбора") тогда
			НовыйЭлемент.УстановитьДействие("НачалоВыбора", ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиНачалоВыбораЗначенияДинамическогоОтбора);
		КонецЕсли;
		
		Если ПоследнийЭлемент тогда
			УстановитьПравуюПривязку(НовыйЭлемент, ЭлементыФормы.ПанельПользователяГоризонтальная);
			НовыйЭлемент.УстановитьПривязку(ГраницаЭлементаУправления.Лево, НовыйЭлементНадпись, ГраницаЭлементаУправления.Право, ЭлементыФормы.ПанельПользователяГоризонтальная, ГраницаЭлементаУправления.Право)
		Иначе				
			УстановитьПривязкуКПравойГранице(НовыйЭлемент, НовыйЭлементНадпись, ЭлементыФормы.ПанельПользователяГоризонтальная);
			УстановитьПривязкуКЛевойГранице(НовыйЭлемент, НовыйЭлемент, ЭлементыФормы.ПанельПользователяГоризонтальная);
		КонецЕсли;
		//Получить из значений
		Если ЭлементДинамическогоОтбора <> Неопределено  Тогда
			// Восстановим значение
			НовыйЭлемент.Значение = ЭлементДинамическогоОтбора.Значение;
		Иначе
			// Установим значение по умолчанию
			НовыйЭлемент.Значение = СтрокаОтбора.Значение;
		КонецЕсли;
		Лево = ?(ПоследнийЭлемент, Лево, Лево + НовыйЭлемент.Ширина + 6);
		СтруктураЭлементовУправления.ДинамическийОтборПолеВвода = НовыйЭлемент;
		Если ПараметрыИсполненияОтчета <> Неопределено И ПараметрыИсполненияОтчета.Свойство("ПослеВыводаОтбора") И ПараметрыИсполненияОтчета.ПослеВыводаОтбора тогда
			ФормаОтчета.ПослеВыводаОтбора(СтруктураЭлементовУправления);
		КонецЕсли;
	КонецПроцедуры
	
	Процедура НарисоватьДинамическийОтборФлажокЗначение(ФормаОтчета, Индекс, Верх, ЦветФонаКнопки, СтрокаОтбора, ЭлементДинамическогоОтбора, ДоступноеПоле, ПараметрыИсполненияОтчета = Неопределено)
		
		Если ДоступноеПоле = Неопределено тогда
			Возврат;
		КонецЕсли;
		
		СтруктураЭлементовУправления = Новый Структура("
		|СтрокаОтбора, 
		|СтраницаПанели, 
		|ДинамическийОтборФлажок, 
		|ДинамическийОтборНадпись,
		|ДинамическийОтборПолеВвода");
		
		
		СтруктураЭлементовУправления.СтрокаОтбора = СтрокаОтбора;
		ЭлементыФормы        = ФормаОтчета.ЭлементыФормы;
		ШиринаПанелиЗакладки = ЭлементыФормы.ПанельЗакладок.Ширина-15;
		СтруктураЭлементовУправления.СтраницаПанели = ЭлементыФормы.ПанельЗакладок.ТекущаяСтраница;
		
		Если СтрокаОтбора.ВидОтбора = "Флажок" ИЛИ СтрокаОтбора.ВидОтбора = "ФлажокЗначение" Тогда
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("Флажок"), "ДинамическийОтбор" + Индекс + "Флажок", Истина, ЭлементыФормы.ПанельЗакладок);
			НовыйЭлемент.Верх = Верх;
			НовыйЭлемент.Лево = 6;
			НовыйЭлемент.Ширина = 143 * ?(СтрокаОтбора.ВидОтбора = "ФлажокЗначение", 1, 2);
			НовыйЭлемент.Заголовок = СтрокаОтбора.Представление;
			НовыйЭлемент.Значение = СтрокаОтбора.Использование;
			//Получить из значений
			Если ЭлементДинамическогоОтбора <> Неопределено 
				И ТипЗнч(ЭлементДинамическогоОтбора.Использование) = Тип("Булево") Тогда
				// Восстановим значение
				НовыйЭлемент.Значение = ЭлементДинамическогоОтбора.Использование;
			Иначе
				// Установим значение по умолчанию                                                     
				НовыйЭлемент.Значение = СтрокаОтбора.Использование;                                    
			КонецЕсли;
			Если СтрокаОтбора.ВидОтбора = "Флажок" Тогда
				УстановитьПравуюПривязку(НовыйЭлемент, ЭлементыФормы.ПанельЗакладок);
			КонецЕсли;
			СтруктураЭлементовУправления.ДинамическийОтборФлажок = НовыйЭлемент;
		КонецЕсли;
		
		Если СтрокаОтбора.ВидОтбора = "Значение" Тогда
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("Надпись"), "ДинамическийОтбор" + Индекс + "Надпись", Истина, ЭлементыФормы.ПанельЗакладок);
			НовыйЭлемент.Верх = Верх;
			НовыйЭлемент.Лево = 6;
			НовыйЭлемент.Ширина = ШиринаПанелиЗакладки - 19;
			НовыйЭлемент.Заголовок = СтрокаОтбора.Представление;
			СтруктураЭлементовУправления.ДинамическийОтборНадпись = НовыйЭлемент;
		КонецЕсли;
		
		Если СтрокаОтбора.ВидОтбора = "Значение" ИЛИ СтрокаОтбора.ВидОтбора = "ФлажокЗначение" Тогда
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("ПолеВвода"), "ДинамическийОтбор" + Индекс + "ПолеВвода", Истина, ЭлементыФормы.ПанельЗакладок);
			НовыйЭлемент.Верх = Верх;
			НовыйЭлемент.Лево = 153;
			НовыйЭлемент.Ширина = ШиринаПанелиЗакладки - 153 - 9;
			НовыйЭлемент.ТипЗначения = ДоступноеПоле.Тип;
			НовыйЭлемент.ЦветФонаКнопки = ЦветФонаКнопки;
			НовыйЭлемент.УстановитьДействие("ПриИзменении", ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиИзменениеЗначенияДинамическогоОтбора);
			Если ФормаОтчета.ДействияЭлементовФормы.Свойство("ДействияПанелиНачалоВыбораЗначенияДинамическогоОтбора") тогда
				НовыйЭлемент.УстановитьДействие("НачалоВыбора", ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиНачалоВыбораЗначенияДинамическогоОтбора);
			КонецЕсли;
			УстановитьПравуюПривязку(НовыйЭлемент, ЭлементыФормы.ПанельЗакладок);
			//Получить из значений
			Если ЭлементДинамическогоОтбора <> Неопределено  Тогда
				// Восстановим значение
				НовыйЭлемент.Значение = ЭлементДинамическогоОтбора.Значение;
			Иначе
				// Установим значение по умолчанию
				НовыйЭлемент.Значение = СтрокаОтбора.Значение;
			КонецЕсли;
			СтруктураЭлементовУправления.ДинамическийОтборПолеВвода = НовыйЭлемент;
		КонецЕсли;
		Верх = Верх + 19 + 6;
		Если ПараметрыИсполненияОтчета <> Неопределено И ПараметрыИсполненияОтчета.Свойство("ПослеВыводаОтбора") И ПараметрыИсполненияОтчета.ПослеВыводаОтбора тогда
			ФормаОтчета.ПослеВыводаОтбора(СтруктураЭлементовУправления);
		КонецЕсли;
	КонецПроцедуры
	
	Процедура НарисоватьДинамическийОтборСписок(ФормаОтчета, Индекс, Верх, ЦветФонаКнопки, СтрокаОтбора, ЭлементДинамическогоОтбора, ДоступноеПоле, ПараметрыИсполненияОтчета = Неопределено)
		
		Если ДоступноеПоле = Неопределено тогда
			Возврат;
		КонецЕсли;
		
		СтруктураЭлементовУправления = Новый Структура("
		|СтрокаОтбора, 
		|СтраницаПанели, 
		|ДинамическийОтборВидСравнения, 
		|ДинамическийОтборСохранитьСписок,
		|ДинамическийОтборЗагрузитьСписок,
		|ДинамическийОтборКнопкаПодбор,
		|ДинамическийОтборТабличноеПоле");
		
		ЭлементыФормы = ФормаОтчета.ЭлементыФормы;
		СтруктураЭлементовУправления.СтраницаПанели = ЭлементыФормы.ПанельЗакладок.ТекущаяСтраница;
		ШиринаПанелиЗакладки = ЭлементыФормы.ПанельЗакладок.Ширина-15;
		СтруктураЭлементовУправления.СтрокаОтбора = СтрокаОтбора;
		
		// Добавление Поля выбора вида сравнения
		ЭлементВидСравнения        = ЭлементыФормы.Добавить(Тип("ПолеВыбора"), "ДинамическийОтбор" + Индекс + "ВидСравнения", Истина, ЭлементыФормы.ПанельЗакладок);
		//ЭлементВидСравнения.ИзменяетДанные = Истина;
		ЭлементВидСравнения.Лево   = 6;
		ЭлементВидСравнения.Верх   = Верх;
		ЭлементВидСравнения.Ширина = (ШиринаПанелиЗакладки - 139);//125;
		ЭлементВидСравнения.Высота = 19;
		ЭлементВидСравнения.ЦветФонаКнопки = ЦветФонаКнопки;
		СписокВыбора = Новый СписокЗначений;
		СписокВыбора.Добавить("", "Не отбирать");
		СписокВыбора.Добавить("Выбранные", "Только выбранные");
		Если СтрокаОтбора.ДоступенВариантИсключить Тогда
			СписокВыбора.Добавить("Исключая", "Кроме выбранных");
		КонецЕсли;
		ЭлементВидСравнения.СписокВыбора = СписокВыбора;
		ЭлементВидСравнения.Значение = СписокВыбора[0].Значение;
		Если ЭлементДинамическогоОтбора <> Неопределено
			И ТипЗнч(ЭлементДинамическогоОтбора.ВидСравнения) = Тип("Строка")
			И СписокВыбора.НайтиПоЗначению(ЭлементДинамическогоОтбора.ВидСравнения) <> Неопределено Тогда
			// Восстановим значение
			ЭлементВидСравнения.Значение = ЭлементДинамическогоОтбора.ВидСравнения;
		Иначе
			// Возьмем значение по умолчанию
			Если СтрокаОтбора.Использование Тогда
				ЭлементВидСравнения.Значение = "Выбранные";
			КонецЕсли;
		КонецЕсли;
		ЭлементВидСравнения.УстановитьПривязку(ГраницаЭлементаУправления.Право, ЭлементыФормы.ПанельЗакладок, ГраницаЭлементаУправления.Право);
		ЭлементВидСравнения.УстановитьПривязку(ГраницаЭлементаУправления.Лево, ЭлементыФормы.ПанельЗакладок, ГраницаЭлементаУправления.Лево);
		
		СтруктураЭлементовУправления.ДинамическийОтборВидСравнения = ЭлементВидСравнения;
		
		Если СтрокаОтбора.СохранятьСписок Тогда
			// Добавление надписи Сохранить список
			ЭлементНадпись        = ЭлементыФормы.Добавить(Тип("Надпись"), "ДинамическийОтбор" + Индекс + "СохранитьСписок", Истина, ЭлементыФормы.ПанельЗакладок);
			ЭлементНадпись.Лево   = ШиринаПанелиЗакладки - 125;
			ЭлементНадпись.Верх   = Верх - 5;
			ЭлементНадпись.Ширина = 30;
			ЭлементНадпись.Высота = 30;
			ЭлементНадпись.Заголовок  = "";
			ЭлементНадпись.Картинка   = БиблиотекаКартинок.СохранитьСписок;
			ЭлементНадпись.ГиперСсылка = Истина;
			ЭлементНадпись.Подсказка = "Сохранить этот список";
			ЭлементНадпись.РазмерКартинки = РазмерКартинки.РеальныйРазмер;
			ЭлементНадпись.УстановитьДействие("Нажатие", ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиСохранитьСписок);
			ЭлементНадпись.УстановитьПривязку(ГраницаЭлементаУправления.Право, ЭлементыФормы.ПанельЗакладок, ГраницаЭлементаУправления.Право);
			ЭлементНадпись.УстановитьПривязку(ГраницаЭлементаУправления.Лево, ЭлементыФормы.ПанельЗакладок, ГраницаЭлементаУправления.Право);
			СтруктураЭлементовУправления.ДинамическийОтборСохранитьСписок = ЭлементНадпись;
			
			// Добавление надписи Загрузить список
			ЭлементНадпись        = ЭлементыФормы.Добавить(Тип("Надпись"), "ДинамическийОтбор" + Индекс + "ЗагрузитьСписок", Истина, ЭлементыФормы.ПанельЗакладок);
			ЭлементНадпись.Лево   = ШиринаПанелиЗакладки - 105;
			ЭлементНадпись.Верх   = Верх - 5;
			ЭлементНадпись.Ширина = 30;
			ЭлементНадпись.Высота = 30;
			ЭлементНадпись.Заголовок  = "";
			ЭлементНадпись.Картинка   = БиблиотекаКартинок.ЗагрузитьСписок;
			ЭлементНадпись.Подсказка = "Загрузить сохраненный список";
			ЭлементНадпись.ГиперСсылка = Истина;
			ЭлементНадпись.РазмерКартинки = РазмерКартинки.РеальныйРазмер;
			ЭлементНадпись.УстановитьДействие("Нажатие", ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиЗагрузитьСписок);
			ЭлементНадпись.УстановитьПривязку(ГраницаЭлементаУправления.Право, ЭлементыФормы.ПанельЗакладок, ГраницаЭлементаУправления.Право);
			ЭлементНадпись.УстановитьПривязку(ГраницаЭлементаУправления.Лево, ЭлементыФормы.ПанельЗакладок, ГраницаЭлементаУправления.Право);
			
			СтруктураЭлементовУправления.ДинамическийОтборЗагрузитьСписок = ЭлементНадпись;
			
		КонецЕсли;
		
		// Сохранить загрузить список
		// Добавление Кнопки Подбор
		КнопкаПодбор = ЭлементыФормы.Добавить(Тип("Кнопка"), "ДинамическийОтбор" + Индекс + "КнопкаПодбор", Истина, ЭлементыФормы.ПанельЗакладок);
		КнопкаПодбор.Лево   = ШиринаПанелиЗакладки - 85;
		КнопкаПодбор.Верх   = Верх;
		КнопкаПодбор.Ширина = 75;
		КнопкаПодбор.Высота = 19;
		КнопкаПодбор.ЦветФонаКнопки = ЦветФонаКнопки;
		Верх = Верх + 19 + 6;
		Если ДоступноеПоле <> Неопределено И ДоступноеПоле.Тип.Типы().Количество() > 1 тогда
			КнопкаПодбор.Заголовок = "Подбор...";
		Иначе
			КнопкаПодбор.Заголовок = "Подбор";
		КонецЕсли;
		Если ФормаОтчета.ДействияЭлементовФормы.Свойство("ДействияПанелиКнопкаПодборНажатие") тогда
			КнопкаПодбор.УстановитьДействие("Нажатие", ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиКнопкаПодборНажатие);
		КонецЕсли;
		КнопкаПодбор.УстановитьПривязку(ГраницаЭлементаУправления.Право, ЭлементыФормы.ПанельЗакладок, ГраницаЭлементаУправления.Право);
		КнопкаПодбор.УстановитьПривязку(ГраницаЭлементаУправления.Лево, ЭлементыФормы.ПанельЗакладок, ГраницаЭлементаУправления.Право);
		//УстановитьПравуюПривязкуПолностью(КнопкаПодбор, ЭлементыФормы.ПанельЗакладок);
		СтруктураЭлементовУправления.ДинамическийОтборКнопкаПодбор = КнопкаПодбор;
		
		// Добавление Табличного поля для списка
		ЭлементТабличноеПоле = ЭлементыФормы.Добавить(Тип("ТабличноеПоле"), "ДинамическийОтбор" + Индекс + "ТабличноеПоле", Истина, ЭлементыФормы.ПанельЗакладок);
		ЭлементТабличноеПоле.Лево           = 6;
		ЭлементТабличноеПоле.Верх           = Верх;
		ЭлементТабличноеПоле.Ширина         = ШиринаПанелиЗакладки - 15;
		ЭлементТабличноеПоле.Высота         = 79 * ?(СтрокаОтбора.ВидОтбора = "Список", 1, 2);
		Верх = Верх + ЭлементТабличноеПоле.Высота + 6;
		ЭлементТабличноеПоле.ТолькоПросмотр = Ложь;
		ЭлементТабличноеПоле.Шапка          = Ложь;
		ЭлементТабличноеПоле.Значение       = Новый ТаблицаЗначений;
		УстановитьПравуюПривязку(ЭлементТабличноеПоле, ЭлементыФормы.ПанельЗакладок);
		СтруктураЭлементовУправления.ДинамическийОтборТабличноеПоле = ЭлементТабличноеПоле;
		
		ЭлементТабличноеПоле.Значение.Колонки.Добавить("Значение", ДоступноеПоле.Тип);
		НоваяКолонка                             = ЭлементТабличноеПоле.Колонки.Добавить("Значение", "");
		НоваяКолонка.Данные                      = "Значение";
		ЭлементТабличноеПоле.ГоризонтальныеЛинии = Ложь;
		//Получить из значений
		Если ЭлементДинамическогоОтбора <> Неопределено 
			И ТипЗнч(ЭлементДинамическогоОтбора.Значение) = Тип("СписокЗначений") Тогда
			// Восстановим значение списка отбора
			Для каждого ЭлементСписка Из ЭлементДинамическогоОтбора.Значение Цикл
				НоваяСтрока = ЭлементТабличноеПоле.Значение.Добавить();
				НоваяСтрока.Значение = ЭлементСписка.Значение;
			КонецЦикла;
		Иначе
			// Проверим есть ли значение по умолчанию
			Если СтрокаОтбора.Значение.Количество() > 0 Тогда
				Для каждого ЭлементСписка Из СтрокаОтбора.Значение Цикл
					НоваяСтрока = ЭлементТабличноеПоле.Значение.Добавить();
					НоваяСтрока.Значение = ЭлементСписка.Значение;
					Если Не ЗначениеЗаполнено(НоваяСтрока.Значение) Тогда
						ЭлементТабличноеПоле.Значение.Удалить(НоваяСтрока);
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
		КонецЕсли;
		
		ЭлементТабличноеПоле.УстановитьДействие("ПриОкончанииРедактирования", ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиОкончаниеРедактированиеТабличногоПоля);
		ЭлементТабличноеПоле.УстановитьДействие("ПослеУдаления", ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиУдалениеСтрокиТабличногоПоля);
		Если ФормаОтчета.ДействияЭлементовФормы.Свойство("ДействияПанелиНачалоВыбораЗначенияТабличногоПоля") тогда
			ЭлементТабличноеПоле.Колонки.Значение.ЭлементУправления.УстановитьДействие("НачалоВыбора", ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиНачалоВыбораЗначенияТабличногоПоля);
		КонецЕсли;
		
		Если ПараметрыИсполненияОтчета <> Неопределено И ПараметрыИсполненияОтчета.Свойство("ПослеВыводаОтбора") И ПараметрыИсполненияОтчета.ПослеВыводаОтбора тогда
			ФормаОтчета.ПослеВыводаОтбора(СтруктураЭлементовУправления);
		КонецЕсли;
		
	КонецПроцедуры
	
	Процедура НарисоватьПараметрОтчета(ФормаОтчета, Индекс, СтрокаПараметра,  Лево, ЦветФонаКнопки, Параметр, ДоступныйПараметр, ЭлементДинамическогоПараметра, ПараметрыИсполненияОтчета = Неопределено, ПоследнийЭлемент = ложь, ПредыдущийЭлемент = Неопределено, СреднийРазмерЭлементаУправления = Неопределено)
		
		СтруктураЭлементовУправления = Новый Структура("
		|СтрокаПараметра,
		|СтраницаПанели, 
		|ДинамическийПараметрНадпись, 
		|ДинамическийПараметрПолеВвода,
		|ДинамическийПараметрТабличноеПоле,
		|ДинамическийПараметрПереключатель");
		
		СтруктураЭлементовУправления.СтрокаПараметра = СтрокаПараметра;
		Если СтрокаПараметра.ВыводитьНа = "ГоризонтальнаяПанель" И ФормаОтчета.ЭлементыФормы.Найти("ПанельПользователяГоризонтальная") <> Неопределено тогда
			Если СтрокаПараметра.ОтображатьКак = "ПолеВвода" или СтрокаПараметра.ОтображатьКак = "СписокЗначение" тогда
				
				ЭлементыФормы        = ФормаОтчета.ЭлементыФормы;
				
				СтруктураЭлементовУправления.СтраницаПанели = ЭлементыФормы.ПанельПользователяГоризонтальная;
				
				НовыйЭлементНадпись = ЭлементыФормы.Добавить(Тип("Надпись"), "ДинамическийПараметр" + Индекс + "Надпись", Истина, ЭлементыФормы.ПанельПользователяГоризонтальная);
				НовыйЭлементНадпись.Верх = 6;
				НовыйЭлементНадпись.Лево = Лево;
				НовыйЭлементНадпись.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Право;
				СреднийРазмерЭлементаУправления = ?(СреднийРазмерЭлементаУправления = Неопределено, СтрДлина(ДоступныйПараметр.Заголовок)*7, СреднийРазмерЭлементаУправления);
				НовыйЭлементНадпись.Ширина = ?(СреднийРазмерЭлементаУправления > СтрДлина(ДоступныйПараметр.Заголовок)*7, СтрДлина(ДоступныйПараметр.Заголовок)*7, СреднийРазмерЭлементаУправления);
				НовыйЭлементНадпись.Высота = 19;
				НовыйЭлементНадпись.Заголовок = ДоступныйПараметр.Заголовок+":";
				Лево = Лево + НовыйЭлементНадпись.Ширина + 6;
				//УстановитьПравуюПривязку(НовыйЭлемент, ЭлементыФормы.ПанельПользователяГоризонтальная);
				СтруктураЭлементовУправления.ДинамическийПараметрНадпись = НовыйЭлементНадпись;
				Если ПредыдущийЭлемент = Неопределено тогда
					УстановитьЛевуюПривязку(НовыйЭлементНадпись, ЭлементыФормы.ПанельПользователяГоризонтальная)
				Иначе
					УстановитьПривязкуКПравойГранице(НовыйЭлементНадпись, ПредыдущийЭлемент, ЭлементыФормы.ПанельПользователяГоризонтальная);
				КонецЕсли;
				УстановитьПривязкуКЛевойГранице(НовыйЭлементНадпись, НовыйЭлементНадпись, ЭлементыФормы.ПанельПользователяГоризонтальная);
				//УстановитьПривязкуКПравойГранице(НовыйЭлемент, НовыйЭлементНадпись, ЭлементыФормы.ПанельПользователяГоризонтальная);
				
				
				Если СтрокаПараметра.ОтображатьКак <> "СписокЗначение" И ДоступныйПараметр.ДоступныеЗначения <> Неопределено тогда
					НовыйЭлемент = ЭлементыФормы.Добавить(Тип("ПолеВыбора"), "ДинамическийПараметр" + Индекс + "ПолеВвода", Истина, ЭлементыФормы.ПанельПользователяГоризонтальная);
				Иначе
					НовыйЭлемент = ЭлементыФормы.Добавить(Тип("ПолеВвода"), "ДинамическийПараметр" + Индекс + "ПолеВвода", Истина, ЭлементыФормы.ПанельПользователяГоризонтальная);
				КонецЕсли;
				НовыйЭлемент.Верх = 6;
				НовыйЭлемент.Лево = Лево;
				Если СтрокаПараметра.Владелец().Колонки.Найти("МаленкийЭлементУпавления") <> Неопределено  и СтрокаПараметра.МаленкийЭлементУпавления тогда
					НовыйЭлемент.Ширина = СреднийРазмерЭлементаУправления/2.5; 
				Иначе
					НовыйЭлемент.Ширина = СреднийРазмерЭлементаУправления; 
				КонецЕсли;
				НовыйЭлемент.АвтоОтметкаНезаполненного = СтрокаПараметра.Заполнено;
				//КонецЕсли;
				НовыйЭлемент.ТипЗначения = ДоступныйПараметр.Тип;
				Если ДоступныйПараметр.ДоступныеЗначения <> Неопределено тогда
					НовыйЭлемент.СписокВыбора = ДоступныйПараметр.ДоступныеЗначения;
					//НовыйЭлемент.КнопкаВыбора = ложь;
					//НовыйЭлемент.КнопкаСпискаВыбора = истина;
				КонецЕсли;
				Если СтрокаПараметра.ОтображатьКак = "СписокЗначение" тогда
					НовыйЭлемент.Значение          = Новый СписокЗначений;
					НовыйЭлемент.ТипЗначения       = Новый ОписаниеТипов("СписокЗначений");
					НовыйЭлемент.ТипЗначенияСписка = ДоступныйПараметр.Тип;
				КонецЕсли;
				НовыйЭлемент.ЦветФонаКнопки    = ЦветФонаКнопки;
				Если ФормаОтчета.ДействияЭлементовФормы.Свойство("ДействияПанелиИзменениеЗначенияДинамическогоПараметра") тогда
					НовыйЭлемент.УстановитьДействие("ПриИзменении", ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиИзменениеЗначенияДинамическогоПараметра);
				КонецЕсли;
				Если ФормаОтчета.ДействияЭлементовФормы.Свойство("ДействияПанелиНачалоВыбораЗначенияДинамическогоПараметра") тогда
					НовыйЭлемент.УстановитьДействие("НачалоВыбора", ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиНачалоВыбораЗначенияДинамическогоПараметра);
				КонецЕсли;
				//Получить из значений
				Если ЭлементДинамическогоПараметра <> Неопределено  Тогда
					// Восстановим значение
					НовыйЭлемент.Значение = ЭлементДинамическогоПараметра.Значение;
				Иначе
					// Установим значение по умолчанию
					НовыйЭлемент.Значение = Параметр.Значение;
				КонецЕсли;
				
				СтруктураЭлементовУправления.ДинамическийПараметрПолеВвода = НовыйЭлемент;
				
				Если ПоследнийЭлемент тогда
					УстановитьПравуюПривязку(НовыйЭлемент, ЭлементыФормы.ПанельПользователяГоризонтальная);
					НовыйЭлемент.УстановитьПривязку(ГраницаЭлементаУправления.Лево, НовыйЭлементНадпись, ГраницаЭлементаУправления.Право, ЭлементыФормы.ПанельПользователяГоризонтальная, ГраницаЭлементаУправления.Право)
				Иначе				
					УстановитьПривязкуКПравойГранице(НовыйЭлемент, НовыйЭлементНадпись, ЭлементыФормы.ПанельПользователяГоризонтальная);
					УстановитьПривязкуКЛевойГранице(НовыйЭлемент, НовыйЭлемент, ЭлементыФормы.ПанельПользователяГоризонтальная);
				КонецЕсли;
				
				Лево = Лево + НовыйЭлемент.Ширина + 6;
				
				ПредыдущийЭлемент = НовыйЭлемент;
			КонецЕсли;
			
		ИначеЕсли СтрокаПараметра.ВыводитьНа = "ПраваяПанель" или (ФормаОтчета.ЭлементыФормы.Найти("ПанельПользователяГоризонтальная") = Неопределено) И СтрокаПараметра.ВыводитьНа <> "" тогда
			
			Верх = 6;
			ЭлементыФормы        = ФормаОтчета.ЭлементыФормы;
			ШиринаПанелиЗакладки = ЭлементыФормы.ПанельЗакладок.Ширина - 15;
			НоваяСтраница = ЭлементыФормы.ПанельЗакладок.Страницы.Добавить("ДинамическийПараметр"+ Индекс + "Страница", ДоступныйПараметр.Заголовок, СтрокаПараметра.Параметр);
			ЭлементыФормы.ПанельЗакладок.ТекущаяСтраница = НоваяСтраница;
			СтруктураЭлементовУправления.СтраницаПанели = НоваяСтраница;
			
			Если СтрокаПараметра.ОтображатьКак = "ПолеВвода" тогда
				
				
				//НовыйЭлемент = ЭлементыФормы.Добавить(Тип("Надпись"), "ДинамическийПарамтер" + Индекс + "Надпись", Истина, ЭлементыФормы.ПанельЗакладок);
				//НовыйЭлемент.Верх = Верх;
				//НовыйЭлемент.Лево = 6;
				//НовыйЭлемент.Ширина = ШиринаПанелиЗакладки - 19;
				//НовыйЭлемент.Заголовок = ДоступныйПараметр.Заголовок;
				Если ДоступныйПараметр.ДоступныеЗначения <> Неопределено тогда
					НовыйЭлемент = ЭлементыФормы.Добавить(Тип("ПолеВыбора"), "ДинамическийПараметр" + Индекс + "ПолеВвода", Истина, ЭлементыФормы.ПанельЗакладок);
				Иначе
					НовыйЭлемент = ЭлементыФормы.Добавить(Тип("ПолеВвода"), "ДинамическийПараметр" + Индекс + "ПолеВвода", Истина, ЭлементыФормы.ПанельЗакладок);
				КонецЕсли;
				НовыйЭлемент.Верх = Верх;
				НовыйЭлемент.Лево = 6;
				НовыйЭлемент.Ширина = ШиринаПанелиЗакладки - 15;
				НовыйЭлемент.АвтоОтметкаНезаполненного  = СтрокаПараметра.Заполнено;
				НовыйЭлемент.ТипЗначения = ДоступныйПараметр.Тип;
				Если ДоступныйПараметр.ДоступныеЗначения <> Неопределено тогда
					НовыйЭлемент.СписокВыбора = ДоступныйПараметр.ДоступныеЗначения;
				КонецЕсли;
				НовыйЭлемент.ЦветФонаКнопки = ЦветФонаКнопки;
				Если ФормаОтчета.ДействияЭлементовФормы.Свойство("ДействияПанелиИзменениеЗначенияДинамическогоПараметра") тогда
					НовыйЭлемент.УстановитьДействие("ПриИзменении", ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиИзменениеЗначенияДинамическогоПараметра);
				КонецЕсли;
				УстановитьПравуюПривязку(НовыйЭлемент, ЭлементыФормы.ПанельЗакладок);
				Если ЭлементДинамическогоПараметра <> Неопределено  Тогда
					// Восстановим значение
					НовыйЭлемент.Значение = ЭлементДинамическогоПараметра.Значение;
				Иначе
					// Установим значение по умолчанию
					НовыйЭлемент.Значение = Параметр.Значение;
				КонецЕсли;
				СтруктураЭлементовУправления.ДинамическийПараметрПолеВвода = НовыйЭлемент;
				
			ИначеЕсли СтрокаПараметра.ОтображатьКак = "СписокЗначение" тогда
				// Добавление Табличного поля для списка
				ЭлементТабличноеПоле = ЭлементыФормы.Добавить(Тип("ТабличноеПоле"), "ДинамическийПараметр" + Индекс + "ТабличноеПоле", Истина, ЭлементыФормы.ПанельЗакладок);
				ЭлементТабличноеПоле.Лево           = 6;
				ЭлементТабличноеПоле.Верх           = Верх;
				ЭлементТабличноеПоле.Ширина         = ШиринаПанелиЗакладки - 15;
				ЭлементТабличноеПоле.Высота         = 79;
				Верх = Верх + ЭлементТабличноеПоле.Высота + 6;
				ЭлементТабличноеПоле.ТолькоПросмотр = Ложь;
				ЭлементТабличноеПоле.Шапка          = Ложь;
				ЭлементТабличноеПоле.Значение       = Новый ТаблицаЗначений;
				УстановитьПравуюПривязку(ЭлементТабличноеПоле, ЭлементыФормы.ПанельЗакладок);
				
				ЭлементТабличноеПоле.Значение.Колонки.Добавить("Значение", ДоступныйПараметр.Тип);
				НоваяКолонка                             = ЭлементТабличноеПоле.Колонки.Добавить("Значение", "");
				НоваяКолонка.Данные                      = "Значение";
				ЭлементТабличноеПоле.ГоризонтальныеЛинии = Ложь;
				//Получить из значений
				Если ЭлементДинамическогоПараметра <> Неопределено 
					И ТипЗнч(ЭлементДинамическогоПараметра.Значение) = Тип("СписокЗначений") Тогда
					// Восстановим значение списка отбора
					Для каждого ЭлементСписка Из ЭлементДинамическогоПараметра.Значение Цикл
						НоваяСтрока = ЭлементТабличноеПоле.Значение.Добавить();
						НоваяСтрока.Значение = ЭлементСписка.Значение;
					КонецЦикла;
				Иначе
					// Проверим есть ли значение по умолчанию
					Если Параметр <> Неопределено 
						И ТипЗнч(Параметр.Значение) = Тип("СписокЗначений") Тогда
						// Восстановим значение списка отбора
						Для каждого ЭлементСписка Из Параметр.Значение Цикл
							НоваяСтрока = ЭлементТабличноеПоле.Значение.Добавить();
							НоваяСтрока.Значение = ЭлементСписка.Значение;
						КонецЦикла;
					КонецЕсли;
				КонецЕсли;
				СтруктураЭлементовУправления.ДинамическийПараметрТабличноеПоле = НовыйЭлемент;
				
			ИначеЕсли СтрокаПараметра.ОтображатьКак = "Переключатель" тогда
				Если ДоступныйПараметр.ДоступныеЗначения <> Неопределено тогда			
					ПервыйВГруппе = истина;
					Массив = Новый Массив;
					Сч = 0;
					Для каждого ЭлементСписка из ДоступныйПараметр.ДоступныеЗначения Цикл
						НовыйЭлемент = ЭлементыФормы.Добавить(Тип("Переключатель"), "ДинамическийПараметр" + Индекс + Сч + "Переключатель", Истина, ЭлементыФормы.ПанельЗакладок);
						НовыйЭлемент.Заголовок     = ?(СтрДлина(ЭлементСписка.Представление) = 0 ,Строка(ЭлементСписка.Значение), ЭлементСписка.Представление);
						НовыйЭлемент.Подсказка     = ?(СтрДлина(ЭлементСписка.Представление) = 0 ,Строка(ЭлементСписка.Значение), ЭлементСписка.Представление);
						НовыйЭлемент.ПервыйВГруппе = ПервыйВГруппе;
						//НовыйЭлемент.Данные        = СтрокаПараметра.Параметр;
						НовыйЭлемент.ТипЗначения   = ДоступныйПараметр.Тип;
						Если ПервыйВГруппе тогда
							ПервыйВГруппеЭлемент = НовыйЭлемент;
						КонецЕсли;
						ПервыйВГруппе              = ложь;
						НовыйЭлемент.ВыбираемоеЗначение = ЭлементСписка.Значение;
						НовыйЭлемент.Лево           = 6;
						НовыйЭлемент.Ширина         = ШиринаПанелиЗакладки - 12;
						НовыйЭлемент.Верх           = Верх;
						НовыйЭлемент.Высота         = 15;
						Верх = Верх + 15 + 6;
						Сч = Сч + 1;
						Массив.Добавить(НовыйЭлемент);
						УстановитьПравуюПривязку(НовыйЭлемент, ЭлементыФормы.ПанельЗакладок);
					КонецЦикла;
					Если ЭлементДинамическогоПараметра <> Неопределено  Тогда
						// Восстановим значение
						ПервыйВГруппеЭлемент.Значение = ЭлементДинамическогоПараметра.Значение;
					Иначе
						// Установим значение по умолчанию
						ПервыйВГруппеЭлемент.Значение = Параметр.Значение;
					КонецЕсли;
					СтруктураЭлементовУправления.ДинамическийПараметрПереключатель = Массив;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		Если ПараметрыИсполненияОтчета <> Неопределено И ПараметрыИсполненияОтчета.Свойство("ПослеВыводаПараметра") И ПараметрыИсполненияОтчета.ПослеВыводаПараметра тогда
			ФормаОтчета.ПослеВыводаПараметра(СтруктураЭлементовУправления);
		КонецЕсли;
		
	КонецПроцедуры
	
	Процедура НарисоватьГруппировкуОтчета(ФормаОтчета, ОтчетОбъект, Индекс, СтрокаГруппировки, ЦветФонаКнопки, Группировки, ЭлементДинамическойГруппировки, ПараметрыИсполненияОтчета = Неопределено)
		
		ВидыГруппировок = Новый Соответствие;
		
		//опредлим вид группировки
		ПерваяГруппировка = Неопределено;
		Если Группировки = Неопределено тогда
			Возврат;
		КонецЕсли;
		Если Группировки.Количество() > 0 тогда
			ПерваяГруппировка = Группировки[0].Значение;
		Иначе
			Возврат;
		КонецЕсли;
		Если ПерваяГруппировка = Неопределено тогда
			Возврат;
		КонецЕсли;
		
		Если ТипЗнч(ПерваяГруппировка) = Тип("ГруппировкаКомпоновкиДанных") 
			ИЛИ ТипЗнч(ПерваяГруппировка) = Тип("ГруппировкаТаблицыКомпоновкиДанных") 
			ИЛИ ТипЗнч(ПерваяГруппировка) = Тип("ГруппировкаДиаграммыКомпоновкиДанных") тогда  //рисуем элемент группировки
			НарисоватьЭлементУправленияГруппировокой(ФормаОтчета,  ОтчетОбъект, Индекс, СтрокаГруппировки, ЦветФонаКнопки, Группировки, ЭлементДинамическойГруппировки, ПараметрыИсполненияОтчета);
		ИначеЕсли ТипЗнч(ПерваяГруппировка) = Тип("ТаблицаКомпоновкиДанных") тогда
			НарисоватьЭлементУправленияТаблицейДиаграммой(ФормаОтчета,  ОтчетОбъект, Индекс, СтрокаГруппировки, ЦветФонаКнопки, Группировки, ЭлементДинамическойГруппировки, ПараметрыИсполненияОтчета);
		ИначеЕсли ТипЗнч(ПерваяГруппировка) = Тип("ДиаграммаКомпоновкиДанных") тогда
			НарисоватьЭлементУправленияТаблицейДиаграммой(ФормаОтчета,  ОтчетОбъект, Индекс, СтрокаГруппировки, ЦветФонаКнопки, Группировки, ЭлементДинамическойГруппировки, ПараметрыИсполненияОтчета);
		КонецЕсли;
	КонецПроцедуры
	
	Процедура НарисоватьЭлементУправленияТаблицейДиаграммой(ФормаОтчета, ОтчетОбъект, Индекс, СтрокаГруппировки, ЦветФонаКнопки, Группировки, ЭлементДинамическойГруппировки, ПараметрыИсполненияОтчета)
		
		СтруктураЭлементовУправления = Новый Структура("
		|СтрокаГруппировки,
		|СтраницаПанели, 
		|ДинамическаяГруппировкаНадписьСтрок, 
		|ДинамическаяГруппировкаНадписьКолонок, 
		
		|ДинамическийПараметрТабличноеПоле,
		|ДинамическийПараметрКаманднаяПанель,
		
		|ДинамическийПараметрТабличноеПолеСтрок,
		|ДинамическийПараметрКаманднаяПанельСтрок,
		
		|ДинамическийПараметрТабличноеПолеКолонок,
		|ДинамическийПараметрКаманднаяПанельКолонок");
		
		СтруктураЭлементовУправления.СтрокаГруппировки = СтрокаГруппировки;
		
		Верх = 6;
		ЭлементыФормы        = ФормаОтчета.ЭлементыФормы;
		ШиринаПанелиЗакладки = ЭлементыФормы.ПанельЗакладок.Ширина;
		НоваяСтраница = ЭлементыФормы.ПанельЗакладок.Страницы.Добавить("ДинамическаяГруппировка"+ Индекс + "Страница", СтрокаГруппировки.Представление);
		ЭлементыФормы.ПанельЗакладок.ТекущаяСтраница = НоваяСтраница;
		
		СтруктураЭлементовУправления.СтраницаПанели = НоваяСтраница;
		
		НовыйЭлемент = ЭлементыФормы.Добавить(Тип("Надпись"), "ДинамическаяГруппировка" + Индекс + "Надпись", Истина, ЭлементыФормы.ПанельЗакладок);
		НовыйЭлемент.Верх = Верх;
		НовыйЭлемент.Лево = 6;
		НовыйЭлемент.Ширина = ШиринаПанелиЗакладки - 15;
		НовыйЭлемент.Заголовок = СтрокаГруппировки.ПредставлениеСтрок + ":";
		Верх = Верх + НовыйЭлемент.Высота + 6;
		УстановитьПравуюПривязку(НовыйЭлемент, ЭлементыФормы.ПанельПользователяГоризонтальная);
		//СтруктураЭлементовУправления.ДинамическийПараметрНадпись = НовыйЭлемент;
		
		// нарисовать таблицу группировки
		НовыйЭлемент                      = ЭлементыФормы.Добавить(Тип("ТабличноеПоле"), "ДинамическаяГруппировка" + Индекс + "ТабличноеПолеСтрок", Истина, ЭлементыФормы.ПанельЗакладок);
		НовыйЭлемент.Лево                 = 6;
		НовыйЭлемент.Верх                 = Верх;
		НовыйЭлемент.Ширина               = ШиринаПанелиЗакладки - 15-24-9;
		НовыйЭлемент.Высота               = 79;
		Верх                              = Верх + НовыйЭлемент.Высота + 6;
		НовыйЭлемент.ТолькоПросмотр       = Ложь;
		НовыйЭлемент.Шапка                = Ложь;
		НовыйЭлемент.Значение             = Новый ТаблицаЗначений;
		НовыйЭлемент.ГоризонтальныеЛинии  = Ложь;
		НовыйЭлемент.ВертикальныеЛинии    = ложь;
		//НовыйЭлемент.ИзменятьСоставСтрок  = ложь;
		НовыйЭлемент.РежимВыделенияСтроки = РежимВыделенияСтрокиТабличногоПоля.Строка;
		НовыйЭлемент.Рамка = Новый Рамка(ТипРамкиЭлементаУправления.БезРамки, 0);
		НовыйЭлемент.УстановитьДействие("ПриПолученииДанных", ФормаОтчета.ДействияЭлементовФормы.ГруппировкиПриПолученииДанных);
		СтруктураЭлементовУправления.ДинамическийПараметрТабличноеПолеСтрок = НовыйЭлемент;
		УстановитьПравуюПривязку(НовыйЭлемент, ЭлементыФормы.ПанельЗакладок);
		
		НовыйЭлемент.Значение.Колонки.Добавить("Использование", Новый ОписаниеТипов("Булево"));
		НовыйЭлемент.Значение.Колонки.Добавить("Значение", Новый ОписаниеТипов("СписокЗначений"));
		НовыйЭлемент.Значение.Колонки.Добавить("Представление", Новый ОписаниеТипов("Строка"));
		НовыйЭлемент.Значение.Колонки.Добавить("ИспользованиеИерархии", Новый ОписаниеТипов("Булево"));
		НовыйЭлемент.Значение.Колонки.Добавить("ЗначениеИерархии", Новый ОписаниеТипов("СписокЗначений"));
		НовыйЭлемент.Значение.Колонки.Добавить("ПредставлениеИерархии", Новый ОписаниеТипов("Строка"));
		
		НоваяКолонка                     = НовыйЭлемент.Колонки.Добавить("ИспользованиеИерархии", "");
		НоваяКолонка.ДанныеФлажка        = "ИспользованиеИерархии";
		НоваяКолонка.РежимРедактирования = РежимРедактированияКолонки.Непосредственно;
		НоваяКолонка.Ширина              = 1;
		НоваяКолонка                     = НовыйЭлемент.Колонки.Добавить("Использование", "");
		НоваяКолонка.ДанныеФлажка        = "Использование";
		НоваяКолонка.РежимРедактирования = РежимРедактированияКолонки.Непосредственно;
		НоваяКолонка.Ширина              = 1;
		НоваяКолонка.Положение           = ПоложениеКолонки.НаСледующейСтроке;
		
		НоваяКолонка                     = НовыйЭлемент.Колонки.Добавить("ЗначениеИерархии", "");
		НоваяКолонка.Данные              = "ЗначениеИерархии";
		НоваяКолонка.Видимость           = ложь;
		НоваяКолонка                     = НовыйЭлемент.Колонки.Добавить("Значение", "");
		НоваяКолонка.Данные              = "Значение";
		НоваяКолонка.Видимость           = ложь;
		НоваяКолонка.Положение           = ПоложениеКолонки.НаСледующейСтроке;
		
		НоваяКолонка                     = НовыйЭлемент.Колонки.Добавить("ПредставлениеИерархии", "");
		НоваяКолонка.Данные              = "ПредставлениеИерархии";
		НоваяКолонка.ТолькоПросмотр      = истина;
		НоваяКолонка                     = НовыйЭлемент.Колонки.Добавить("Представление", "");
		НоваяКолонка.Данные              = "Представление";
		НоваяКолонка.ТолькоПросмотр      = истина;
		НоваяКолонка.Положение           = ПоложениеКолонки.НаСледующейСтроке;
		
		ЭлементКоманднаяПанель          = ЭлементыФормы.Добавить(Тип("КоманднаяПанель"), "ДинамическаяГруппировка" + Индекс + "КоманднаяПанельСтрок", Истина, ЭлементыФормы.ПанельЗакладок); 
		ЭлементКоманднаяПанель.Верх     = НовыйЭлемент.Верх + 11;
		ЭлементКоманднаяПанель.Высота   = 47;
		ЭлементКоманднаяПанель.Лево     = ШиринаПанелиЗакладки - 15 - 24 + 12;
		ЭлементКоманднаяПанель.Ширина   = 24;
		ЭлементКоманднаяПанель.ЦветФона = ЦветаСтиля.ЦветФонаПоля;
		ЭлементКоманднаяПанель.ИсточникДействий = НовыйЭлемент;
		СтруктураЭлементовУправления.ДинамическийПараметрКаманднаяПанельСтрок = ЭлементКоманднаяПанель;
		УстановитьПравуюПривязкуПолностью(ЭлементКоманднаяПанель, ЭлементыФормы.ПанельЗакладок);
		
		КнопкаВверх                   = ЭлементКоманднаяПанель.Кнопки.Добавить("ДинамическаяГруппировка" + Индекс + "КнопкаВверхСтрок", ТипКнопкиКоманднойПанели.Действие, , ФормаОтчета.ДействияЭлементовФормы.ПриНажатииНаКнопкуВверх);
		КнопкаВверх.Картинка          = БиблиотекаКартинок.ПереместитьВверх;
		КнопкаВверх.Отображение       = ОтображениеКнопкиКоманднойПанели.Картинка;
		КнопкаВниз                    = ЭлементКоманднаяПанель.Кнопки.Добавить("ДинамическаяГруппировка" + Индекс + "КнопкаВнизСтрок", ТипКнопкиКоманднойПанели.Действие, , ФормаОтчета.ДействияЭлементовФормы.ПриНажатииНаКнопкуВниз);
		КнопкаВниз.Картинка           = БиблиотекаКартинок.ПереместитьВниз;
		КнопкаВниз.Отображение        = ОтображениеКнопкиКоманднойПанели.Картинка;
		
		//Добавить строки группировки
		Если ТипЗнч(Группировки[0].Значение) = Тип("ТаблицаКомпоновкиДанных") тогда
			СтрокиГруппировки = ПолучитьЭлементыСтруктуры(Группировки[0].Значение.Строки);
		Иначе
			СтрокиГруппировки = ПолучитьЭлементыСтруктуры(Группировки[0].Значение.Точки);
		КонецЕсли;
		
		Для каждого Группировка из СтрокиГруппировки Цикл
			СтрокаГруп = НовыйЭлемент.Значение.Добавить();
			Представление = "";
			ИспользоватьИерархию = ложь;
			Для каждого ПолеГруппировки из Группировка.Значение.ПоляГруппировки.Элементы Цикл
				СтрокаГруп.Значение.Добавить(Строка(ПолеГруппировки.Поле));
				СтрокаГруп.ЗначениеИерархии.Добавить(ПолеГруппировки.ТипГруппировки);
				ИспользоватьИерархию = Ложь;
				ДоступноеПоле = ПолучитьДоступноеПолеПоПолюКомпоновкиДанных(ПолеГруппировки.Поле, ОтчетОбъект.КомпоновщикНастроек);
				ТипыПоля = ДоступноеПоле.Тип.Типы();
				Для каждого ТипПоля из ТипыПоля Цикл
					ОбъектМетаданных = Метаданные.НайтиПоТипу(ТипПоля);
					Если ОбъектМетаданных <> Неопределено и Метаданные.Справочники.Содержит(ОбъектМетаданных) тогда
						ИспользоватьИерархию = ОбъектМетаданных.Иерархический;
					КонецЕсли;
				КонецЦикла;
				Представление = Представление + ?(Представление = "", "", ", ") + ДоступноеПоле.Заголовок;
			КонецЦикла;
			СтрокаГруп.Представление         = Представление;
			Если СтрокаГруппировки["НастраиватьИерархию"] И ИспользоватьИерархию тогда
				СтрокаГруп.ПредставлениеИерархии = "" + Представление + " (по группам)";
			КонецЕсли;
			СтрокаГруп.Использование         = Группировка.Значение.Использование;
			СтрокаГруп.ИспользованиеИерархии = ИспользоватьИерархию;
		КонецЦикла;
		
		Если ЭлементДинамическойГруппировки <> Неопределено тогда
			ПрименитьНастройкуПользователя(НовыйЭлемент.Значение, ЭлементДинамическойГруппировки.СписокГруппировкиСтрок);
		КонецЕсли;
		
		
		// колонки
		НовыйЭлемент = ЭлементыФормы.Добавить(Тип("Надпись"), "ДинамическаяГруппировка" + Индекс + "НадписьКолонок", Истина, ЭлементыФормы.ПанельЗакладок);
		НовыйЭлемент.Верх = Верх;
		НовыйЭлемент.Лево = 6;
		НовыйЭлемент.Ширина = ШиринаПанелиЗакладки - 15;
		НовыйЭлемент.Заголовок = СтрокаГруппировки.ПредставлениеКолонок + ":";
		Верх = Верх + НовыйЭлемент.Высота + 6;
		УстановитьПравуюПривязку(НовыйЭлемент, ЭлементыФормы.ПанельПользователяГоризонтальная);
		
		// нарисовать таблицу группировки
		НовыйЭлемент                      = ЭлементыФормы.Добавить(Тип("ТабличноеПоле"), "ДинамическаяГруппировка" + Индекс + "ТабличноеПолеКолонок", Истина, ЭлементыФормы.ПанельЗакладок);
		НовыйЭлемент.Лево                 = 6;
		НовыйЭлемент.Верх                 = Верх;
		НовыйЭлемент.Ширина               = ШиринаПанелиЗакладки - 15-24-9;
		НовыйЭлемент.Высота               = 79;
		Верх                              = Верх + НовыйЭлемент.Высота + 6;
		НовыйЭлемент.ТолькоПросмотр       = Ложь;
		НовыйЭлемент.Шапка                = Ложь;
		НовыйЭлемент.Значение             = Новый ТаблицаЗначений;
		НовыйЭлемент.ГоризонтальныеЛинии  = Ложь;
		НовыйЭлемент.ВертикальныеЛинии    = ложь;
		НовыйЭлемент.ИзменятьСоставСтрок  = ложь;
		НовыйЭлемент.РежимВыделенияСтроки = РежимВыделенияСтрокиТабличногоПоля.Строка;
		НовыйЭлемент.Рамка = Новый Рамка(ТипРамкиЭлементаУправления.БезРамки, 0);
		СтруктураЭлементовУправления.ДинамическийПараметрТабличноеПолеКолонок = НовыйЭлемент;
		НовыйЭлемент.УстановитьДействие("ПриПолученииДанных", ФормаОтчета.ДействияЭлементовФормы.ГруппировкиПриПолученииДанных);
		УстановитьПравуюПривязку(НовыйЭлемент, ЭлементыФормы.ПанельЗакладок);
		
		
		
		НовыйЭлемент.Значение.Колонки.Добавить("Использование", Новый ОписаниеТипов("Булево"));
		НовыйЭлемент.Значение.Колонки.Добавить("Значение", Новый ОписаниеТипов("СписокЗначений"));
		НовыйЭлемент.Значение.Колонки.Добавить("Представление", Новый ОписаниеТипов("Строка"));
		НовыйЭлемент.Значение.Колонки.Добавить("ИспользованиеИерархии", Новый ОписаниеТипов("Булево"));
		НовыйЭлемент.Значение.Колонки.Добавить("ЗначениеИерархии", Новый ОписаниеТипов("СписокЗначений"));
		НовыйЭлемент.Значение.Колонки.Добавить("ПредставлениеИерархии", Новый ОписаниеТипов("Строка"));
		
		НоваяКолонка                     = НовыйЭлемент.Колонки.Добавить("ИспользованиеИерархии", "");
		НоваяКолонка.ДанныеФлажка        = "ИспользованиеИерархии";
		НоваяКолонка.РежимРедактирования = РежимРедактированияКолонки.Непосредственно;
		НоваяКолонка.Ширина              = 1;
		НоваяКолонка                     = НовыйЭлемент.Колонки.Добавить("Использование", "");
		НоваяКолонка.ДанныеФлажка        = "Использование";
		НоваяКолонка.РежимРедактирования = РежимРедактированияКолонки.Непосредственно;
		НоваяКолонка.Ширина              = 1;
		НоваяКолонка.Положение           = ПоложениеКолонки.НаСледующейСтроке;
		
		НоваяКолонка                     = НовыйЭлемент.Колонки.Добавить("ЗначениеИерархии", "");
		НоваяКолонка.Данные              = "ЗначениеИерархии";
		НоваяКолонка.Видимость           = ложь;
		НоваяКолонка                     = НовыйЭлемент.Колонки.Добавить("Значение", "");
		НоваяКолонка.Данные              = "Значение";
		НоваяКолонка.Видимость           = ложь;
		НоваяКолонка.Положение           = ПоложениеКолонки.НаСледующейСтроке;
		
		НоваяКолонка                     = НовыйЭлемент.Колонки.Добавить("ПредставлениеИерархии", "");
		НоваяКолонка.Данные              = "ПредставлениеИерархии";
		НоваяКолонка.ТолькоПросмотр      = истина;
		НоваяКолонка                     = НовыйЭлемент.Колонки.Добавить("Представление", "");
		НоваяКолонка.Данные              = "Представление";
		НоваяКолонка.ТолькоПросмотр      = истина;
		НоваяКолонка.Положение           = ПоложениеКолонки.НаСледующейСтроке;
		
		ЭлементКоманднаяПанель          = ЭлементыФормы.Добавить(Тип("КоманднаяПанель"), "ДинамическаяГруппировка" + Индекс + "КоманднаяПанельКолонок", Истина, ЭлементыФормы.ПанельЗакладок); 
		ЭлементКоманднаяПанель.Верх     = НовыйЭлемент.Верх + 11;
		ЭлементКоманднаяПанель.Высота   = 47;
		ЭлементКоманднаяПанель.Лево     = ШиринаПанелиЗакладки - 15 - 24 + 12;
		ЭлементКоманднаяПанель.Ширина   = 24;
		ЭлементКоманднаяПанель.ЦветФона = ЦветаСтиля.ЦветФонаПоля;
		ЭлементКоманднаяПанель.ИсточникДействий = НовыйЭлемент;
		УстановитьПравуюПривязкуПолностью(ЭлементКоманднаяПанель, ЭлементыФормы.ПанельЗакладок);
		СтруктураЭлементовУправления.ДинамическийПараметрКаманднаяПанельКолонок = ЭлементКоманднаяПанель;
		
		КнопкаВверх                   = ЭлементКоманднаяПанель.Кнопки.Добавить("ДинамическаяГруппировка" + Индекс + "КнопкаВверхКолонок", ТипКнопкиКоманднойПанели.Действие, , ФормаОтчета.ДействияЭлементовФормы.ПриНажатииНаКнопкуВверх);
		КнопкаВверх.Картинка          = БиблиотекаКартинок.ПереместитьВверх;
		КнопкаВверх.Отображение       = ОтображениеКнопкиКоманднойПанели.Картинка;
		КнопкаВниз                    = ЭлементКоманднаяПанель.Кнопки.Добавить("ДинамическаяГруппировка" + Индекс + "КнопкаВнизКолонок", ТипКнопкиКоманднойПанели.Действие, , ФормаОтчета.ДействияЭлементовФормы.ПриНажатииНаКнопкуВниз);
		КнопкаВниз.Картинка           = БиблиотекаКартинок.ПереместитьВниз;
		КнопкаВниз.Отображение        = ОтображениеКнопкиКоманднойПанели.Картинка;
		
		//Добавить строки группировки
		Если ТипЗнч(Группировки[0].Значение) = Тип("ТаблицаКомпоновкиДанных") тогда
			СтрокиГруппировки = ПолучитьЭлементыСтруктуры(Группировки[0].Значение.Колонки);
		Иначе
			СтрокиГруппировки = ПолучитьЭлементыСтруктуры(Группировки[0].Значение.Серии);
		КонецЕсли;
		Для каждого Группировка из СтрокиГруппировки Цикл
			СтрокаГруп = НовыйЭлемент.Значение.Добавить();
			Представление = "";
			ИспользоватьИерархию = ложь;
			Для каждого ПолеГруппировки из Группировка.Значение.ПоляГруппировки.Элементы Цикл
				СтрокаГруп.Значение.Добавить(Строка(ПолеГруппировки.Поле));
				СтрокаГруп.ЗначениеИерархии.Добавить(ПолеГруппировки.ТипГруппировки);
				ИспользоватьИерархию = Ложь;
				ДоступноеПоле = ПолучитьДоступноеПолеПоПолюКомпоновкиДанных(ПолеГруппировки.Поле, ОтчетОбъект.КомпоновщикНастроек);
				ТипыПоля = ДоступноеПоле.Тип.Типы();
				Для каждого ТипПоля из ТипыПоля Цикл
					ОбъектМетаданных = Метаданные.НайтиПоТипу(ТипПоля);
					Если ОбъектМетаданных <> Неопределено и Метаданные.Справочники.Содержит(ОбъектМетаданных) тогда
						ИспользоватьИерархию = ОбъектМетаданных.Иерархический;
					КонецЕсли;
				КонецЦикла;
				Представление = Представление + ?(Представление = "", "", ", ") + ДоступноеПоле.Заголовок;
			КонецЦикла;
			СтрокаГруп.Представление         = Представление;
			Если СтрокаГруппировки["НастраиватьИерархию"] И ИспользоватьИерархию тогда
				СтрокаГруп.ПредставлениеИерархии = "" + Представление + " (по группам)";
			КонецЕсли;
			СтрокаГруп.Использование         = Группировка.Значение.Использование;
			СтрокаГруп.ИспользованиеИерархии = ИспользоватьИерархию;
		КонецЦикла;
		
		Если ЭлементДинамическойГруппировки <> Неопределено тогда
			ПрименитьНастройкуПользователя(НовыйЭлемент.Значение, ЭлементДинамическойГруппировки.СписокГруппировкиКолонок);
		КонецЕсли;
		
		Если ПараметрыИсполненияОтчета <> Неопределено И ПараметрыИсполненияОтчета.Свойство("ПослеВыводаГруппировки") И ПараметрыИсполненияОтчета.ПослеВыводаГруппировки тогда
			ФормаОтчета.ПослеВыводаГруппировки(СтруктураЭлементовУправления);
		КонецЕсли;
		
		
	КонецПроцедуры
	
	Процедура НарисоватьЭлементУправленияГруппировокой(ФормаОтчета, ОтчетОбъект, Индекс, СтрокаГруппировки, ЦветФонаКнопки, Группировки, ЭлементДинамическойГруппировки, ПараметрыИсполненияОтчета)
		
		СтруктураЭлементовУправления = Новый Структура("
		|СтрокаГруппировки,
		|СтраницаПанели, 
		|ДинамическаяГруппировкаНадписьСтрок, 
		|ДинамическаяГруппировкаНадписьКолонок, 
		
		|ДинамическийПараметрТабличноеПоле,
		|ДинамическийПараметрКаманднаяПанель,
		
		|ДинамическийПараметрТабличноеПолеСтрок,
		|ДинамическийПараметрКаманднаяПанельСтрок,
		
		|ДинамическийПараметрТабличноеПолеКолонок,
		|ДинамическийПараметрКаманднаяПанельКолонок");
		
		СтруктураЭлементовУправления.СтрокаГруппировки = СтрокаГруппировки;
		
		Верх = 6;
		ЭлементыФормы        = ФормаОтчета.ЭлементыФормы;
		ШиринаПанелиЗакладки = ЭлементыФормы.ПанельЗакладок.Ширина-15;
		НоваяСтраница = ЭлементыФормы.ПанельЗакладок.Страницы.Добавить("ДинамическаяГруппировка"+ Индекс + "Страница", СтрокаГруппировки.Представление);
		ЭлементыФормы.ПанельЗакладок.ТекущаяСтраница = НоваяСтраница;
		СтруктураЭлементовУправления.СтраницаПанели = НоваяСтраница;
		
		// нарисовать таблицу группировки
		ЭлементТабличноеПоле                = ЭлементыФормы.Добавить(Тип("ТабличноеПоле"), "ДинамическаяГруппировка" + Индекс + "ТабличноеПоле", Истина, ЭлементыФормы.ПанельЗакладок);
		ЭлементТабличноеПоле.Лево           = 6;
		ЭлементТабличноеПоле.Верх           = Верх;
		ЭлементТабличноеПоле.Ширина         = ШиринаПанелиЗакладки - 18 -24 ;
		ЭлементТабличноеПоле.Высота         = 79;
		Верх                                = Верх + ЭлементТабличноеПоле.Высота + 6;
		ЭлементТабличноеПоле.ТолькоПросмотр = Ложь;
		ЭлементТабличноеПоле.Шапка          = Ложь;
		ЭлементТабличноеПоле.Значение       = Новый ТаблицаЗначений;
		ЭлементТабличноеПоле.ГоризонтальныеЛинии = Ложь;
		ЭлементТабличноеПоле.ВертикальныеЛинии   = ложь;
		ЭлементТабличноеПоле.РежимВыделенияСтроки = РежимВыделенияСтрокиТабличногоПоля.Строка;
		ЭлементТабличноеПоле.ИзменятьСоставСтрок  = ложь;
		ЭлементТабличноеПоле.Рамка = Новый Рамка(ТипРамкиЭлементаУправления.БезРамки, 0);
		СтруктураЭлементовУправления.ДинамическийПараметрТабличноеПоле = ЭлементТабличноеПоле;
		ЭлементТабличноеПоле.УстановитьДействие("ПриПолученииДанных", ФормаОтчета.ДействияЭлементовФормы.ГруппировкиПриПолученииДанных);
		
		УстановитьПравуюПривязку(ЭлементТабличноеПоле, ЭлементыФормы.ПанельЗакладок);
		
		ЭлементТабличноеПоле.Значение.Колонки.Добавить("Использование", Новый ОписаниеТипов("Булево"));
		ЭлементТабличноеПоле.Значение.Колонки.Добавить("Значение", Новый ОписаниеТипов("СписокЗначений"));
		ЭлементТабличноеПоле.Значение.Колонки.Добавить("Представление", Новый ОписаниеТипов("Строка"));
		ЭлементТабличноеПоле.Значение.Колонки.Добавить("ИспользованиеИерархии", Новый ОписаниеТипов("Булево"));
		ЭлементТабличноеПоле.Значение.Колонки.Добавить("ЗначениеИерархии", Новый ОписаниеТипов("СписокЗначений"));
		ЭлементТабличноеПоле.Значение.Колонки.Добавить("ПредставлениеИерархии", Новый ОписаниеТипов("Строка"));
		
		НоваяКолонка                     = ЭлементТабличноеПоле.Колонки.Добавить("ИспользованиеИерархии", "");
		НоваяКолонка.ДанныеФлажка        = "ИспользованиеИерархии";
		НоваяКолонка.РежимРедактирования = РежимРедактированияКолонки.Непосредственно;
		НоваяКолонка.Ширина              = 1;
		НоваяКолонка                     = ЭлементТабличноеПоле.Колонки.Добавить("Использование", "");
		НоваяКолонка.ДанныеФлажка        = "Использование";
		НоваяКолонка.РежимРедактирования = РежимРедактированияКолонки.Непосредственно;
		НоваяКолонка.Ширина              = 1;
		НоваяКолонка.Положение           = ПоложениеКолонки.НаСледующейСтроке;
		
		НоваяКолонка                     = ЭлементТабличноеПоле.Колонки.Добавить("ЗначениеИерархии", "");
		НоваяКолонка.Данные              = "ЗначениеИерархии";
		НоваяКолонка.Видимость           = ложь;
		НоваяКолонка                     = ЭлементТабличноеПоле.Колонки.Добавить("Значение", "");
		НоваяКолонка.Данные              = "Значение";
		НоваяКолонка.Видимость           = ложь;
		НоваяКолонка.Положение           = ПоложениеКолонки.НаСледующейСтроке;
		
		НоваяКолонка                     = ЭлементТабличноеПоле.Колонки.Добавить("ПредставлениеИерархии", "");
		НоваяКолонка.Данные              = "ПредставлениеИерархии";
		НоваяКолонка.ТолькоПросмотр      = истина;
		НоваяКолонка                     = ЭлементТабличноеПоле.Колонки.Добавить("Представление", "");
		НоваяКолонка.Данные              = "Представление";
		НоваяКолонка.ТолькоПросмотр      = истина;
		НоваяКолонка.Положение           = ПоложениеКолонки.НаСледующейСтроке;
		
		//	НоваяКолонка.ЭлементУправления.УстановитьДействие("НачалоВыбора", ФормаОтчета.ДействияЭлементовФормы.ПриВыбореПоляГруппировки);
		
		ЭлементКоманднаяПанель          = ЭлементыФормы.Добавить(Тип("КоманднаяПанель"), "ДинамическаяГруппировка" + Индекс + "КоманднаяПанель", Истина, ЭлементыФормы.ПанельЗакладок); 
		ЭлементКоманднаяПанель.Верх     = 19;
		ЭлементКоманднаяПанель.Высота   = 47;
		ЭлементКоманднаяПанель.Лево     = ШиринаПанелиЗакладки - 30;
		ЭлементКоманднаяПанель.Ширина   = 24;
		ЭлементКоманднаяПанель.ЦветФона = ЦветаСтиля.ЦветФонаПоля;
		ЭлементКоманднаяПанель.ИсточникДействий = ЭлементТабличноеПоле;
		УстановитьПравуюПривязкуПолностью(ЭлементКоманднаяПанель, ЭлементыФормы.ПанельЗакладок);
		СтруктураЭлементовУправления.ДинамическийПараметрКаманднаяПанель = ЭлементКоманднаяПанель;
		
		КнопкаВверх                   = ЭлементКоманднаяПанель.Кнопки.Добавить("ДинамическаяГруппировка" + Индекс + "КнопкаВверх", ТипКнопкиКоманднойПанели.Действие, , ФормаОтчета.ДействияЭлементовФормы.ПриНажатииНаКнопкуВверх);
		КнопкаВверх.Картинка          = БиблиотекаКартинок.ПереместитьВверх;
		КнопкаВверх.Отображение       = ОтображениеКнопкиКоманднойПанели.Картинка;
		КнопкаВниз                    = ЭлементКоманднаяПанель.Кнопки.Добавить("ДинамическаяГруппировка" + Индекс + "КнопкаВниз", ТипКнопкиКоманднойПанели.Действие, , ФормаОтчета.ДействияЭлементовФормы.ПриНажатииНаКнопкуВниз);
		КнопкаВниз.Картинка           = БиблиотекаКартинок.ПереместитьВниз;
		КнопкаВниз.Отображение        = ОтображениеКнопкиКоманднойПанели.Картинка;
		
		//СтруктураЭлементовУправления.ДинамическийПараметрТабличноеПоле = НовыйЭлемент;
		
		//Добавить строки группировки
		Для каждого Группировка из Группировки Цикл
			СтрокаГруп = ЭлементТабличноеПоле.Значение.Добавить();
			Представление = "";
			ИспользоватьИерархию = ложь;
			Для каждого ПолеГруппировки из Группировка.Значение.ПоляГруппировки.Элементы Цикл
				СтрокаГруп.Значение.Добавить(Строка(ПолеГруппировки.Поле));
				СтрокаГруп.ЗначениеИерархии.Добавить(ПолеГруппировки.ТипГруппировки);
				ИспользоватьИерархию = Ложь;
				ДоступноеПоле = ПолучитьДоступноеПолеПоПолюКомпоновкиДанных(ПолеГруппировки.Поле, ОтчетОбъект.КомпоновщикНастроек);
				ТипыПоля = ДоступноеПоле.Тип.Типы();
				Для каждого ТипПоля из ТипыПоля Цикл
					ОбъектМетаданных = Метаданные.НайтиПоТипу(ТипПоля);
					Если ОбъектМетаданных <> Неопределено и Метаданные.Справочники.Содержит(ОбъектМетаданных) тогда
						ИспользоватьИерархию = ОбъектМетаданных.Иерархический;
					КонецЕсли;
				КонецЦикла;
				Представление = Представление + ?(Представление = "", "", ", ") + ДоступноеПоле.Заголовок;
			КонецЦикла;
			СтрокаГруп.Представление         = Представление;
			Если СтрокаГруппировки["НастраиватьИерархию"] И ИспользоватьИерархию тогда
				СтрокаГруп.ПредставлениеИерархии = "" + Представление + " (по группам)";
			КонецЕсли;
			СтрокаГруп.Использование         = Группировка.Значение.Использование;
			СтрокаГруп.ИспользованиеИерархии = Группировка.Значение.Использование И ИспользоватьИерархию;
		КонецЦикла;
		
		Если ЭлементДинамическойГруппировки <> Неопределено тогда
			ПрименитьНастройкуПользователя(ЭлементТабличноеПоле.Значение, ЭлементДинамическойГруппировки.СписокГруппировки);
		КонецЕсли;
		
		Если ПараметрыИсполненияОтчета <> Неопределено И ПараметрыИсполненияОтчета.Свойство("ПослеВыводаГруппировки") И ПараметрыИсполненияОтчета.ПослеВыводаГруппировки тогда
			ФормаОтчета.ПослеВыводаГруппировки(СтруктураЭлементовУправления);
		КонецЕсли;
		
	КонецПроцедуры
	
	Функция УстановитьВариантПоУмолчанию(ОтчетОбъект, ФормаОтчета) Экспорт
		
		Если ФормаОтчета = Неопределено 
			ИЛИ НЕ ФормаОтчета.ЭтоОтработкаРасшифровки Тогда
			
			Вариант = ПолучитьПоследнийИспользуемыйВариант(ПолучитьИдентификаторОбъекта(ОтчетОбъект));
			СтруктураПоиска = Новый Структура;
			СтруктураПоиска.Вставить("Ссылка", Вариант);
			НайденныеСтроки = ОтчетОбъект.ТаблицаВариантовОтчета.НайтиСтроки(СтруктураПоиска);
			Если НайденныеСтроки.Количество() > 0 Тогда
				ОтчетОбъект.СохраненнаяНастройка = НайденныеСтроки[0].Ссылка;
			Иначе 
				Если ОтчетОбъект.ТаблицаВариантовОтчета.Количество() > 0 Тогда
					ОтчетОбъект.СохраненнаяНастройка = ОтчетОбъект.ТаблицаВариантовОтчета[0].Ссылка;
				КонецЕсли;
			КонецЕсли;
			
			Если ФормаОтчета <> Неопределено Тогда
				ОбновитьЗаголовокТиповогоОтчета(ОтчетОбъект, ФормаОтчета);
			КонецЕсли;
			
		КонецЕсли;
		
	КонецФункции
	
	Процедура ОбновитьКнопкиВыбораНастроек(ФормаОтчета, ОтчетОбъект, ПредставлениеНастройки, РежимРедактированияНастройки) Экспорт
		
		ЭлементыФормы = ФормаОтчета.ЭлементыФормы;
		
		// Удалим старые кнопки
		Количество = ЭлементыФормы.Количество();
		Для Индекс = 1 По Количество Цикл
			ЭлементФормы = ЭлементыФормы[Количество - Индекс];
			Если Лев(ЭлементФормы.Имя, 26) = "ПолеКартинкиВыбораВарианта" ИЛИ Лев(ЭлементФормы.Имя, 19) = "РамкаВыбораВарианта" Тогда
				ЭлементыФормы.Удалить(ЭлементФормы);
			КонецЕсли;
		КонецЦикла;
		
		Если ЭлементыФормы.Найти("НадписьПредупреждение") <> Неопределено Тогда
			Если ОтчетОбъект.ТаблицаВариантовОтчета.Количество() = 0 Тогда
				ЭлементыФормы.НадписьПредупреждение.Видимость = Истина;
			Иначе
				ЭлементыФормы.НадписьПредупреждение.Видимость = Ложь;
			КонецЕсли;
		КонецЕсли;
		
		// Добавим кнопки выбора вариантов
		Для Индекс = 0 По ОтчетОбъект.ТаблицаВариантовОтчета.Количество() - 1 Цикл
			Строка = ОтчетОбъект.ТаблицаВариантовОтчета.Получить(Индекс);
			ДобавитьКнопкуВыбораВариантаОтчета(ФормаОтчета, Индекс, Строка.Наименование, Строка.Ссылка = ОтчетОбъект.СохраненнаяНастройка, Строка.ПравоИзменения, Строка.Описание);
		КонецЦикла;
		
		ЭлементыФормы.РазделительПанелиВыбораВариантов.Верх = ЭлементыФормы.РазделительПанелиВыбораВариантов.Верх + 1;
		ЭлементыФормы.РазделительПанелиВыбораВариантов.Верх = ЭлементыФормы.РазделительПанелиВыбораВариантов.Верх - 1;
		
	КонецПроцедуры
	
	Процедура ДобавитьКнопкуВыбораВариантаОтчета(ФормаОтчета, Индекс, Заголовок, Пометка, ПравоИзменения, Описание)
		
		ЭлементыФормы = ФормаОтчета.ЭлементыФормы;
		
		Если ЭлементыФормы.Найти("НадписьВариантыОтчета") = Неопределено Тогда 
			Элемент = ЭлементыФормы.ПолеКартинкиОсновнойВариант;
			Смещение = 0;
		Иначе
			Элемент = ЭлементыФормы.НадписьВариантыОтчета;
			Смещение = ЭлементыФормы.НадписьВариантыОтчета.Лево + ЭлементыФормы.НадписьВариантыОтчета.Ширина + 2;
		КонецЕсли;
		
		ПолеКартинки = ЭлементыФормы.Добавить(Тип("ПолеКартинки"), "ПолеКартинкиВыбораВарианта" + Индекс, Истина, ЭлементыФормы.ПанельВыбораВариантов);
		ПолеКартинки.УстановитьПривязку(ГраницаЭлементаУправления.Низ, Элемент, ГраницаЭлементаУправления.Низ);
		ПолеКартинки.Лево = (Индекс) * 103 + 0 + Смещение;
		ПолеКартинки.Верх = 0;
		ПолеКартинки.Ширина = 102;
		ПолеКартинки.Высота = Элемент.Высота;
		ПолеКартинки.ГиперСсылка = Истина;
		ПолеКартинки.ЦветФона = ЦветаСтиля.ЦветФонаКнопки;
		ПолеКартинки.ЦветТекста = WebЦвета.ТемноСиний;
		ПолеКартинки.ТекстНевыбраннойКартинки = Заголовок;
		ПолеКартинки.АвтоКонтекстноеМеню = Ложь;
		
		ПолеКартинки.Подсказка = Описание;
		ПолеКартинки.Шрифт = Новый Шрифт(ПолеКартинки.Шрифт, "Verdana");
		Если Пометка Тогда
			ПолеКартинки.КонтекстноеМеню = ЭлементыФормы.КонтекстноеМенюКартинкиВыбораСохраненнойНастройки;
		КонецЕсли;
		Если Пометка Тогда
			ПолеКартинки.ЦветФона = Новый Цвет(255, 248, 220);
			ПолеКартинки.ЦветТекста = ЦветаСтиля.ЦветТекстаКнопки;
			ПолеКартинки.ГиперСсылка = ложь;
		Иначе
			ПолеКартинки.ГиперСсылка = истина;
		КонецЕсли;
		Действие = ФормаОтчета.ДействияЭлементовФормы.ОбработкаНажатияКнопкиСохраненнойНастройки;
		ПолеКартинки.УстановитьДействие("Нажатие", Действие);
		
		Рамка = ЭлементыФормы.Добавить(Тип("РамкаГруппы"), "РамкаВыбораВарианта" + Индекс, Истина, ЭлементыФормы.ПанельВыбораВариантов);
		Рамка.УстановитьПривязку(ГраницаЭлементаУправления.Низ, Элемент, ГраницаЭлементаУправления.Низ);
		Рамка.Лево = (Индекс + 1) * 103 - 2  + Смещение;
		Рамка.Верх = 0;
		Рамка.Ширина = 1;
		Рамка.Высота = Элемент.Высота;
		Рамка.ЦветРамки = ЦветаСтиля.ЦветРамки;
		Рамка.ЦветТекста = WebЦвета.ТемноСиний;
		
	КонецПроцедуры
	
	Процедура ГруппировкаПриПолученииДанных(Элемент, ОформленияСтрок) Экспорт
		Для каждого ОформлениеСтроки из ОформленияСтрок Цикл
			Если ОформлениеСтроки.ДанныеСтроки.ПредставлениеИерархии = "" тогда
				ОформлениеСтроки.Ячейки.ПредставлениеИерархии.Видимость = ложь;
				ОформлениеСтроки.Ячейки.ИспользованиеИерархии.Видимость = ложь;
			КонецЕсли;
		КонецЦикла;
	Конецпроцедуры
	
	Процедура УстановитьПравуюПривязку(Элемент, Панель) Экспорт
		
		Элемент.УстановитьПривязку(ГраницаЭлементаУправления.Право, Панель, ГраницаЭлементаУправления.Право);
		
	КонецПроцедуры
	
	Процедура УстановитьЛевуюПривязку(Элемент, Панель) Экспорт
		
		Элемент.УстановитьПривязку(ГраницаЭлементаУправления.Лево, Панель, ГраницаЭлементаУправления.Лево);
		
	КонецПроцедуры
	
	Процедура УстановитьПривязкуКЛевойГранице(Элемент, ПривязатьК, Панель = Неопределено) Экспорт
		
		Если Панель <> Неопределено тогда
			Элемент.УстановитьПривязку(ГраницаЭлементаУправления.Право, ПривязатьК, ГраницаЭлементаУправления.Лево, Панель, ГраницаЭлементаУправления.Право);
		Иначе
			Элемент.УстановитьПривязку(ГраницаЭлементаУправления.Право, ПривязатьК, ГраницаЭлементаУправления.Лево);
		КонецЕсли;
		
	КонецПроцедуры
	
	Процедура УстановитьПривязкуКПравойГранице(Элемент, ПривязатьК, Панель = Неопределено) Экспорт
		
		Если Панель <> Неопределено тогда
			Элемент.УстановитьПривязку(ГраницаЭлементаУправления.Лево, ПривязатьК, ГраницаЭлементаУправления.Право, Панель, ГраницаЭлементаУправления.Право);
		Иначе
			Элемент.УстановитьПривязку(ГраницаЭлементаУправления.Лево, ПривязатьК, ГраницаЭлементаУправления.Право);
		КонецЕсли;
		
		
	КонецПроцедуры
	
	
	Процедура УстановитьПравуюПривязкуПолностью(Элемент, Панель, ЛевыйЭлемент = Неопределено)
		
		ЛевыйЭлемент = ?(ЛевыйЭлемент = Неопределено, Панель, ЛевыйЭлемент);
		Элемент.УстановитьПривязку(ГраницаЭлементаУправления.Право, Панель, ГраницаЭлементаУправления.Право);
		Элемент.УстановитьПривязку(ГраницаЭлементаУправления.Лево, ЛевыйЭлемент, ГраницаЭлементаУправления.Лево);
		
	КонецПроцедуры
	
	
	Функция ПолучитьСтруктуруПоказателей(ЭлементыФормы) Экспорт
		
		ИспользованиеПоказателей = Новый Соответствие;
		Для каждого СтрокаПоказателя из ЭлементыФормы.Показатели.Значение Цикл
			ИспользованиеПоказателей.Вставить(СтрокаПоказателя.Поле, СтрокаПоказателя.Использование);
		КонецЦикла;
		Возврат ИспользованиеПоказателей;
		
	КонецФункции 
	
	Процедура ЗагрузитьВРеквизитЗначенияНастроекПанелиПользователя(ОтчетОбъект, ФормаОтчета) Экспорт
		
		ОтчетОбъект.ЗначенияНастроекПанелиПользователя = Новый ХранилищеЗначения(ПолучитьЗначенияНастроекПанелиПользователя(ОтчетОбъект, ФормаОтчета));
		
	КонецПроцедуры
	
	Процедура ПерерисоватьПанельНастроек(ОтчетОбъект, ФормаОтчета, ЗначенияНастроек = Неопределено, ПереноситьПараметры = истина) Экспорт
		
		ПараметрыИсполненияОтчета = Неопределено;
		ПараметрыИсполненияОтчета = ОтчетОбъект.ПолучитьПараметрыИсполненияОтчета();
		
		ЕстьЭлементыНаПанели = ложь;
		
		ЦветФонаКнопки = Новый Цвет(246, 244, 236);
		ЭлементыФормы = ФормаОтчета.ЭлементыФормы;
		ЭлементыФормы.ПанельЗакладок.Видимость = Ложь;
		ЭлементыФормы.ПанельЗакладок.Видимость = Ложь;
		
		
		Если ЭлементыФормы.Найти("ПанельПользователяГоризонтальная") <> Неопределено тогда
			ЭлементыФормы.ПанельПользователяГоризонтальная.Видимость = ложь;
		КонецЕсли;
		
		ЭлементыФормы.ПанельЗакладок.РежимПрокручиваемыхСтраниц = Ложь;
		ШиринаФормы = ФормаОтчета.Ширина;
		ШиринаПанели = ЭлементыФормы.ПанельПользователя.Ширина;
		ЕстьРазделитель = ЭлементыФормы.Найти("Разделитель") <> Неопределено;
		Если ЕстьРазделитель тогда
			Если ШиринаПанели < 306 тогда
				ЭлементыФормы.Разделитель.Лево = ШиринаФормы - 295;
			КонецЕсли;
		КонецЕсли;
		
		
		// Инициализация ЗначенияНастроек
		Если ЗначенияНастроек = Неопределено Тогда
			ЗначенияНастроек = ПолучитьЗначенияНастроекПанелиПользователяОбъекта(ОтчетОбъект);
		КонецЕсли;
		Если ЗначенияНастроек = Неопределено Тогда
			ЗначенияНастроек = ПолучитьЗначенияНастроекПанелиПользователяПоУмолчанию(ОтчетОбъект);
		КонецЕсли;
		
		// Инициализация Параметры
		Параметры = ПолучитьПараметрыПанелиПользователяОбъекта(ОтчетОбъект);
		Если Параметры = Неопределено Тогда
			Параметры = ПолучитьПараметрыПанелиПользователяПоУмолчанию(ОтчетОбъект, ФормаОтчета);
			СохраненнаяМодифицированность = ФормаОтчета.Модифицированность;
			ОтчетОбъект.ПараметрыПанелиПользователя = Новый ХранилищеЗначения(Параметры);
			ФормаОтчета.Модифицированность = СохраненнаяМодифицированность;
		КонецЕсли;
		
		
		// Управление видимостью стандартных страниц
		ДеревоНастроекСтандартныхСтраниц = Параметры.ДеревоНастроекСтандартныхСтраниц;
		Для каждого НастройкаСтраницы Из ДеревоНастроекСтандартныхСтраниц.Строки Цикл
			Если НастройкаСтраницы.Имя = "Период" Тогда
				Продолжить;
			КонецЕсли;
			Страница = ЭлементыФормы.ПанельЗакладок.Страницы.Найти(НастройкаСтраницы.Имя);
			Если Страница <> Неопределено тогда
				Страница.Видимость = НастройкаСтраницы.Использование;
				Если Страница.Видимость тогда
					ЕстьЭлементыНаПанели = истина;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		
		Если ПереноситьПараметры тогда
			Для каждого ВидимостьСтраницы Из ЗначенияНастроек.ВидимостьСтраниц Цикл
				Страница = ЭлементыФормы.ПанельЗакладок.Страницы.Найти(ВидимостьСтраницы.Ключ);
				Если Страница = Неопределено ИЛИ ВидимостьСтраницы.Ключ = "Показатели" Тогда
					Продолжить;
				КонецЕсли;
				// Восстанавливаем значение
				ТекущиеНастройкиКомпоновщика = ЗначенияНастроек.НастройкиКомпоновщика;
				
				Если ВидимостьСтраницы.Ключ = "Параметры" Тогда
					ЗаполнитьЭлементы(ФормаОтчета.КомпоновщикНастроекПользователя.Настройки["ПараметрыДанных"], ТекущиеНастройкиКомпоновщика["ПараметрыДанных"]);
				Иначе
					СкопироватьЭлементы(ФормаОтчета.КомпоновщикНастроекПользователя.Настройки[ВидимостьСтраницы.Ключ], ТекущиеНастройкиКомпоновщика[ВидимостьСтраницы.Ключ]);
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		
		ФормаОтчета.ЭлементыФормы.Сортировка.Верх      = 6;
		ФормаОтчета.ЭлементыФормы.Отбор.Верх           = 6;
		ФормаОтчета.ЭлементыФормы.ПараметрыДанных.Верх = 6;
		
		// Установка высоты табличного поля параметры
		Если ОтчетОбъект.КомпоновщикНастроек.Настройки.ПараметрыДанных.ДоступныеПараметры <> Неопределено Тогда
			КоличествоПараметров = 0;
			Для каждого Параметр Из ОтчетОбъект.КомпоновщикНастроек.Настройки.ПараметрыДанных.ДоступныеПараметры.Элементы Цикл
				Если Параметр.Видимость Тогда
					КоличествоПараметров = КоличествоПараметров + 1;
				КонецЕсли;
			КонецЦикла;
			Если КоличествоПараметров = 0 Тогда
				// Спрячем закладку Параметры, если параметров нет
				ЭлементыФормы.ПанельЗакладок.Страницы.Параметры.Видимость = Ложь;
				ЕстьЭлементыНаПанели = истина;
			Иначе
				// Сделаем высоту списка параметров впритык всем параметрам
				ЭлементыФормы.ПараметрыДанных.Высота = 17 * (1 + КоличествоПараметров);
			КонецЕсли;
		КонецЕсли;
		
		// Удаление старых закладок с динамическими отборами
		Количество = ЭлементыФормы.ПанельЗакладок.Страницы.Количество();
		Для Индекс = 1 По Количество Цикл
			Страница = ЭлементыФормы.ПанельЗакладок.Страницы[Количество - Индекс];
			Если Лев(Страница.Имя, 17) = "ДинамическийОтбор" 
				или Лев(Страница.Имя, 20) = "ДинамическийПараметр" 
				или Лев(Страница.Имя, 23) = "ДинамическаяГруппировка" Тогда
				ЭлементыФормы.ПанельЗакладок.Страницы.Удалить(Количество - Индекс);
			КонецЕсли;
		КонецЦикла;
		
		Надпись = ЭлементыФормы.Найти("НадписьНеЗаполненаПанель");
		Если Надпись <> Неопределено тогда
			ЭлементыФормы.Удалить(Надпись);
		КонецЕсли;
		
		// Удалим старые элементы с динамическими отборами
		Количество = ЭлементыФормы.Количество();
		Для Индекс = 1 По Количество Цикл
			Элемент = ЭлементыФормы[Количество - Индекс];
			Если Лев(Элемент.Имя, 17) = "ДинамическийОтбор" или Лев(Элемент.Имя, 20) = "ДинамическийПараметр" или Лев(Страница.Имя, 23) = "ДинамическаяГруппировка" Тогда
				ЭлементыФормы.Удалить(Элемент);
			КонецЕсли;
		КонецЦикла;
		
		ЛевоГорПанели = 0;
		ЕстьПериодНаГорПанели = ложь;
		Если ФормаОтчета.ЭлементыФормы.Найти("ПанельПользователяГоризонтальная") = Неопределено тогда
			НарисоватьСтандартныйПериодНаПравойПанели(ОтчетОбъект, ФормаОтчета, ЗначенияНастроек, Параметры, ПараметрыИсполненияОтчета);
		Иначе
			НарисоватьСтандартныйПериод(ОтчетОбъект, ФормаОтчета, ЗначенияНастроек, Параметры, 	ЛевоГорПанели, ЕстьПериодНаГорПанели);
		КонецЕсли;
		
		Отборы = Параметры.Отборы;
		ЕстьОтборыВГоризонтальнойПанели     = Отборы.Колонки.Найти("Расположение") <> Неопределено И Отборы.НайтиСтроки(Новый Структура("Расположение", "ГоризонтальнаяПанель")).Количество() > 0;
		ЕстьПараметрыНаГоризонтальнойПанели = Параметры.Свойство("Параметры") И Параметры.Параметры.Колонки.Найти("ВыводитьНа") <> Неопределено 
		И Параметры.Параметры.НайтиСтроки(Новый Структура("ВыводитьНа", "ГоризонтальнаяПанель")).Количество() > 0 или ЕстьПериодНаГорПанели;
		
		
		Если ЭлементыФормы.Найти("ПанельПользователяГоризонтальная") <> Неопределено тогда
			Если ЕстьОтборыВГоризонтальнойПанели или ЕстьПараметрыНаГоризонтальнойПанели тогда
				ЭлементыФормы.ПанельПользователяГоризонтальная.Свертка = РежимСверткиЭлементаУправления.Нет;
			Иначе
				ЭлементыФормы.ПанельПользователяГоризонтальная.Свертка = РежимСверткиЭлементаУправления.Верх;
			КонецЕсли;
		КонецЕсли;
		
		ПредыдущийЭлемент = Неопределено;
		Если  ЭлементыФормы.Найти("ПанельПользователяГоризонтальная") <> Неопределено тогда
			ШиринаПанели   = ЭлементыФормы.ПанельПользователяГоризонтальная.Ширина - ЛевоГорПанели - 6;
			КолВоЭлементов = 0;
			КолВоЭлементов = КолВоЭлементов + ?(Параметры.Свойство("Параметры")  И Параметры.Параметры.Колонки.Найти("ВыводитьНа") <> Неопределено, Параметры.Параметры.НайтиСтроки(Новый Структура("ВыводитьНа", "ГоризонтальнаяПанель")).Количество()*2, 0) 
			+ ?(Отборы <> Неопределено И Отборы.Колонки.Найти("Расположение") <> Неопределено, Отборы.НайтиСтроки(Новый Структура("Расположение", "ГоризонтальнаяПанель")).Количество() * 2, 0);
			СреднийРазмер  = ?(КолВоЭлементов <> 0, ШиринаПанели/КолВоЭлементов, 0);
		Иначе
			СреднийРазмер  = 0;
		КонецЕсли;
		
		Если ФормаОтчета.ЭлементыФормы.Найти("Отбор") <> Неопределено тогда
			ШиринаПанели = ФормаОтчета.ЭлементыФормы.ПанельПользователя.Ширина;
			Если ФормаОтчета.ЭлементыФормы.Отбор.Ширина <> ШиринаПанели-31 тогда
				ФормаОтчета.ЭлементыФормы.Отбор.Ширина = ШиринаПанели-31;
			КонецЕсли;
		КонецЕсли;
		
		Если ФормаОтчета.ЭлементыФормы.Найти("Сортировка") <> Неопределено тогда
			ШиринаПанели = ФормаОтчета.ЭлементыФормы.ПанельПользователя.Ширина;
			Если ФормаОтчета.ЭлементыФормы.Сортировка.Ширина <> ШиринаПанели-70 тогда
				ФормаОтчета.ЭлементыФормы.Сортировка.Ширина  = ШиринаПанели-70;
				
			КонецЕсли;
		КонецЕсли;
		//нарисуем на панели настройку параметров
		Если Параметры.Свойство("Параметры") тогда
			ШиринаПанели = ФормаОтчета.ЭлементыФормы.ПанельПользователя.Ширина;
			Если ФормаОтчета.ЭлементыФормы.ПараметрыДанных.Ширина <> ШиринаПанели-31 тогда
				ФормаОтчета.ЭлементыФормы.ПараметрыДанных.Ширина = ШиринаПанели-31;
			КонецЕсли;
			ПоследнийЭлемент = ложь;
			Для каждого СтрокаПараметров из Параметры.Параметры Цикл
				ДоступноеПолеПараметра = ПолучитьДоступныйПараметрПоПараметруКомпоновкиДанных(СтрокаПараметров.Параметр, ОтчетОбъект.КомпоновщикНастроек.Настройки.ПараметрыДанных.ДоступныеПараметры);
				ЗначениеПараметра = ОтчетОбъект.КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных(СтрокаПараметров.Параметр));
				Если ЗначениеПараметра = Неопределено и ДоступноеПолеПараметра = Неопределено тогда
					Продолжить;
				КонецЕсли;
				Если ЗначенияНастроек.Свойство("ДинамическиеПараметры") Тогда
					ЭлементДинамическогоОтбора = ЗначенияНастроек.ДинамическиеПараметры[СтрокаПараметров.Параметр];
				КонецЕсли;
				Если Не ЕстьОтборыВГоризонтальнойПанели тогда
					ПоследнийЭлемент = Параметры.Параметры.Индекс(СтрокаПараметров) = (Параметры.Параметры.Индекс(СтрокаПараметров) - 1);
				КонецЕсли;
				НарисоватьПараметрОтчета(ФормаОтчета, Параметры.Параметры.Индекс(СтрокаПараметров), СтрокаПараметров, ЛевоГорПанели, ЦветФонаКнопки, ЗначениеПараметра, ДоступноеПолеПараметра, ЭлементДинамическогоОтбора, ПараметрыИсполненияОтчета, ПоследнийЭлемент, ПредыдущийЭлемент, СреднийРазмер);
				Если СтрокаПараметров.ВыводитьНа <> "ГоризонтальнаяПанель" и СтрокаПараметров.ВыводитьНа <> "" и СтрокаПараметров.ВыводитьНа <> Неопределено тогда
					ЕстьЭлементыНаПанели = истина;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		
		Если Параметры.Свойство("Группировки") тогда
			МассивПомеченныхГруппировок = Новый Соответствие;
			ВсеГруппировки = ПолучитьЭлементыСтруктуры(ОтчетОбъект.КомпоновщикНастроек);
			Для каждого Группировка из ВсеГруппировки Цикл
				Имя = Группировка.Значение.Имя;
				Если Имя <> "" тогда
					МассивГруппировок = МассивПомеченныхГруппировок.Получить(Группировка.Значение.Имя);
					Если МассивГруппировок = Неопределено тогда
						МассивГруппировок = Новый Массив;
					КонецЕсли;
					МассивГруппировок.Добавить(Группировка);
					МассивПомеченныхГруппировок.Вставить(Группировка.Значение.Имя, МассивГруппировок);
				КонецЕсли;
			КонецЦикла;
			
			Для каждого СтрокаГруппировки из Параметры.Группировки Цикл
				Если НЕ СтрокаГруппировки.Использование тогда
					Продолжить;
				КонецЕсли;
				Если ЗначенияНастроек.Свойство("ДинамическиеГруппировки") Тогда
					ЭлементДинамическойГруппировки = ЗначенияНастроек.ДинамическиеГруппировки[СтрокаГруппировки.Группировка];
				КонецЕсли;
				Группировки = МассивПомеченныхГруппировок.Получить(СтрокаГруппировки.Группировка);
				Индекс = Параметры.Группировки.Индекс(СтрокаГруппировки);
				НарисоватьГруппировкуОтчета(ФормаОтчета, ОтчетОбъект, Индекс, СтрокаГруппировки, ЦветФонаКнопки, Группировки, ЭлементДинамическойгруппировки, ПараметрыИсполненияОтчета);
				ЕстьЭлементыНаПанели = истина;
			КонецЦикла;
		КонецЕсли;
		
		// Добавим закладки динамических отборов
		ЕстьДополнительнаяСтраница = Ложь;
		
		ВерхДопСтраница = 6;
		ИндексПоследСтроки = -1;
		Для каждого СтрокаОтбора Из Отборы Цикл
			Если СтрокаОтбора.Расположение = "ГоризонтальнаяПанель" тогда
				ИндексПоследСтроки = Отборы.Индекс(СтрокаОтбора);
			КонецЕсли;
		КонецЦикла;
		ЕстьДополнительнаяСтраница = ложь;
		Для каждого СтрокаОтбора Из Отборы Цикл
			
			Индекс = Отборы.Индекс(СтрокаОтбора);
			ДоступноеПоле = ПолучитьДоступноеПолеПоПолюКомпоновкиДанных(СтрокаОтбора.Поле, ОтчетОбъект.КомпоновщикНастроек.Настройки.Отбор.ДоступныеПоляОтбора);
			ЭлементДинамическогоОтбора = Неопределено;
			
			Если ЗначенияНастроек.Свойство("ДинамическиеОтборы") Тогда
				ЭлементДинамическогоОтбора = ЗначенияНастроек.ДинамическиеОтборы[СтрокаОтбора.Поле];
			КонецЕсли;
			
			Если СтрокаОтбора.Расположение <> "ГоризонтальнаяПанель" или ФормаОтчета.ЭлементыФормы.Найти("ПанельПользователяГоризонтальная") = Неопределено тогда
				
				Если СтрокаОтбора.Расположение = "НоваяСтраница" или СтрокаОтбора.Расположение = "ГоризонтальнаяПанель" Тогда
					НоваяСтраница = ЭлементыФормы.ПанельЗакладок.Страницы.Добавить("ДинамическийОтбор" + Индекс, СтрокаОтбора.Представление, СтрокаОтбора.Поле);
					НоваяСтраница.Раскрыта = Истина;
					Верх = 6;
				ИначеЕсли СтрокаОтбора.Расположение = "ДополнительнаяСтраница" Тогда
					Если Не ЕстьДополнительнаяСтраница Тогда
						ЕстьДополнительнаяСтраница = Истина;
						НоваяСтраница = ЭлементыФормы.ПанельЗакладок.Страницы.Добавить("ДинамическийОтбор" + "ДополнительнаяСтраница", "Отборы", СтрокаОтбора.Поле);
					КонецЕсли;
					НоваяСтраница = ЭлементыФормы.ПанельЗакладок.Страницы["ДинамическийОтбор" + "ДополнительнаяСтраница"];
					Верх = ВерхДопСтраница;
				Иначе
				КонецЕсли;
				
				ЭлементыФормы.ПанельЗакладок.ТекущаяСтраница = НоваяСтраница;
				
				Если СтрокаОтбора.ВидОтбора = "Список" ИЛИ СтрокаОтбора.ВидОтбора = "ДлинныйСписок" Тогда
					НарисоватьДинамическийОтборСписок(ФормаОтчета, Индекс, Верх, ЦветФонаКнопки, СтрокаОтбора, ЭлементДинамическогоОтбора, ДоступноеПоле, ПараметрыИсполненияОтчета);
					ЕстьЭлементыНаПанели = истина;
				ИначеЕсли СтрокаОтбора.ВидОтбора = "Флажок" ИЛИ СтрокаОтбора.ВидОтбора = "ФлажокЗначение" ИЛИ СтрокаОтбора.ВидОтбора = "Значение" Тогда
					НарисоватьДинамическийОтборФлажокЗначение(ФормаОтчета, Индекс, Верх, ЦветФонаКнопки, СтрокаОтбора, ЭлементДинамическогоОтбора, ДоступноеПоле, ПараметрыИсполненияОтчета);
					ЕстьЭлементыНаПанели = истина;
				КонецЕсли;
				Если ЕстьДополнительнаяСтраница И НоваяСтраница = ЭлементыФормы.ПанельЗакладок.Страницы["ДинамическийОтбор" + "ДополнительнаяСтраница"] Тогда
					ВерхДопСтраница = Верх;
				КонецЕсли;
			Иначе
				НарисоватьДинамическийОтборГоризонтальнойПанели(ФормаОтчета, Индекс, ЛевоГорПанели, ЦветФонаКнопки, СтрокаОтбора, ЭлементДинамическогоОтбора, ДоступноеПоле, ИндексПоследСтроки = Индекс, СтрокаОтбора.ВидОтбора = "Список", ПараметрыИсполненияОтчета, ПредыдущийЭлемент, СреднийРазмер);
			КонецЕсли;
			
		КонецЦикла;
		
		ДополнительныеНастройкиОтчета = Новый Массив;
		ПараметрыИсполненияОтчета = ОтчетОбъект.ПолучитьПараметрыИсполненияОтчета();
		Если ПараметрыИсполненияОтчета.Свойство("ДополнительныеНастройкиОтчета") И ПараметрыИсполненияОтчета.ДополнительныеНастройкиОтчета тогда
			ДополнительныеНастройкиОтчета = ОтчетОбъект.ПолучитьДополнительныеНастройкиОтчета();
		КонецЕсли;
		
		Для каждого ДопНастройка из ДополнительныеНастройкиОтчета Цикл
			Если Не ЕстьДополнительнаяСтраница тогда
				НоваяСтраница = ЭлементыФормы.ПанельЗакладок.Страницы.Добавить("ДинамическийОтбор" + "ДополнительнаяСтраница", "Дополнительные настройки", "ДиаграммаГанта");
				ЕстьДополнительнаяСтраница = истина;
			КонецЕсли;
			ЭлементыФормы.ПанельЗакладок.ТекущаяСтраница = ЭлементыФормы.ПанельЗакладок.Страницы["ДинамическийОтбор" + "ДополнительнаяСтраница"];
			НарисоватьФлажокДопНастроек(ФормаОтчета, ВерхДопСтраница, ДопНастройка.Имя, ДопНастройка.Заголовок, ДопНастройка.ЗначениеПоУмолчанию);
			ЕстьЭлементыНаПанели = истина;
		КонецЦикла;
		
		//Заполнить таблицу показателей
		
		Страница = ЭлементыФормы.ПанельЗакладок.Страницы.Найти("Показатели");
		Если Страница <> Неопределено и Страница.Видимость тогда
			Показатели = ФормаОтчета.ЭлементыФормы.Показатели.Значение;
			Показатели.Очистить();
			ПоляВыбора = ПолучитьВыбранныеПоля(ОтчетОбъект.КомпоновщикНастроек);
			Для каждого ВыбранноеПоле из ПоляВыбора Цикл
				ДоступноеПоле = ПолучитьДоступноеПоле(ВыбранноеПоле.Поле, ОтчетОбъект.КомпоновщикНастроек.Настройки.Выбор.ДоступныеПоляВыбора);
				Если ДоступноеПоле <> Неопределено и ДоступноеПоле.Ресурс Тогда
					СтрокаПоказателя = Показатели.Добавить();
					СтрокаПоказателя.Использование = ВыбранноеПоле.Использование;
					СтрокаПоказателя.Поле          = ВыбранноеПоле.Поле;
					СтрокаПоказателя.Представление = ДоступноеПоле.Заголовок;
				КонецЕсли;
			КонецЦикла;
			Если ЗначенияНастроек.Свойство("Показатели")  тогда
				ШиринаПанели = ФормаОтчета.ЭлементыФормы.ПанельПользователя.Ширина;
				Если ФормаОтчета.ЭлементыФормы.Показатели.Ширина <> ШиринаПанели-31 тогда
					ФормаОтчета.ЭлементыФормы.Показатели.Ширина = ШиринаПанели-31;
				КонецЕсли;
				Для каждого СтрокаПоказатель из ЗначенияНастроек.Показатели Цикл
					СтрокаПоля = Показатели.Найти(СтрокаПоказатель.Ключ, "Поле");
					Если СтрокаПоля <> Неопределено тогда
						СтрокаПоля.Использование = СтрокаПоказатель.Значение;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
		КонецЕсли;
		
		ТиповыеОтчетыПереопределяемый.ПослеВыводаПанелиПользователя(ОтчетОбъект, ФормаОтчета, ДеревоНастроекСтандартныхСтраниц, ЗначенияНастроек);
		
		// Сдвинем страницу Сортировка в самый конец
		Количество = ЭлементыФормы.ПанельЗакладок.Страницы.Количество();
		Если ЭлементыФормы.ПанельЗакладок.Страницы.Найти("Показатели") <> Неопределено тогда
			Индекс = ЭлементыФормы.ПанельЗакладок.Страницы.Индекс(ЭлементыФормы.ПанельЗакладок.Страницы.Показатели);
			ЭлементыФормы.ПанельЗакладок.Страницы.Сдвинуть(ЭлементыФормы.ПанельЗакладок.Страницы.Показатели, Количество - 1 - Индекс);
		КонецЕсли;
		Индекс = ЭлементыФормы.ПанельЗакладок.Страницы.Индекс(ЭлементыФормы.ПанельЗакладок.Страницы.Порядок);
		ЭлементыФормы.ПанельЗакладок.Страницы.Сдвинуть(ЭлементыФормы.ПанельЗакладок.Страницы.Порядок, Количество - 1 - Индекс);
		
		Если ПараметрыИсполненияОтчета <> Неопределено И ПараметрыИсполненияОтчета.Свойство("ПослеВыводаПанелиПользователя") И ПараметрыИсполненияОтчета.ПослеВыводаПанелиПользователя тогда
			ФормаОтчета.ПослеВыводаПанелиПользователя(ЗначенияНастроек);
		КонецЕсли;
		
		ЭлементыФормы.ПанельЗакладок.РежимПрокручиваемыхСтраниц = Истина;
		
		ЭлементыФормы.ПанельЗакладок.Видимость = Истина;
		Если ЭлементыФормы.Найти("ПанельПользователяГоризонтальная") <> Неопределено тогда
			ЭлементыФормы.ПанельПользователяГоризонтальная.Видимость = истина;
		КонецЕсли;
		
		Если НЕ ЕстьЭлементыНаПанели тогда 
			НовыйЭлемент = ЭлементыФормы.Добавить(Тип("Надпись"), "НадписьНеЗаполненаПанель", Истина, ЭлементыФормы.ПанельПользователя);
			НовыйЭлемент.Верх      = 1;
			НовыйЭлемент.Лево      = 1;
			НовыйЭлемент.Ширина    = ?(ЭлементыФормы.ПанельПользователя.Ширина < 215, 215, ЭлементыФормы.ПанельПользователя.Ширина-1);
			НовыйЭлемент.Высота    = ЭлементыФормы.ПанельПользователя.Высота-35;
			НовыйЭлемент.Заголовок = "         Панель пользователя не заполнена.";
			НовыйЭлемент.ЦветТекста = ЦветаСтиля.ЦветРамки;
			НовыйЭлемент.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Лево;
			УстановитьПравуюПривязкуПолностью(НовыйЭлемент, ЭлементыФормы.ПанельПользователя);
		КонецЕсли;
		
	КонецПроцедуры
	
	Процедура НарисоватьФлажокДопНастроек(ФормаОтчета, ВерхДопСтр, ИмяФлажка, НазваниеФлажка, ЗначениеПоУмолчанию, ПараметрыИсполненияОтчета = Неопределено)
		ЭлементыФормы = ФормаОтчета.ЭлементыФормы;
		ШиринаПанелиЗакладки = ЭлементыФормы.ПанельЗакладок.Ширина-15;
		НовыйЭлемент = ЭлементыФормы.Добавить(Тип("Флажок"), ИмяФлажка, Истина, ЭлементыФормы.ПанельЗакладок);
		НовыйЭлемент.Верх      = ВерхДопСтр;
		НовыйЭлемент.Лево      = 6;
		НовыйЭлемент.Ширина    = ШиринаПанелиЗакладки - 15;
		НовыйЭлемент.Заголовок = НазваниеФлажка;
		НовыйЭлемент.Значение  = ЗначениеПоУмолчанию;
		УстановитьПравуюПривязку(НовыйЭлемент, ЭлементыФормы.ПанельЗакладок);
		Если ПараметрыИсполненияОтчета <> Неопределено И ПараметрыИсполненияОтчета.Свойство("ДействияПанелиИзменениеФлажкаДопНастроек") И ПараметрыИсполненияОтчета.ДействияПанелиИзменениеФлажкаДопНастроек тогда
			Если ФормаОтчета.ДействияЭлементовФормы.Свойство("ДействияПанелиИзменениеФлажкаДопНастроек") тогда
				НовыйЭлемент.УстановитьДействие("ПриИзменении", ФормаОтчета.ДействияЭлементовФормы.ДействияПанелиИзменениеФлажкаДопНастроек);
			КонецЕсли;
		КонецЕсли;
		ВерхДопСтр = ВерхДопСтр + НовыйЭлемент.Высота + 6; 
	КонецПроцедуры
	
	Процедура СохранитьРезультатВНастройке(ОтчетОбъект, ФормаОтчета) Экспорт 
		
		Если Не ФормаОтчета.ЭтоОтработкаРасшифровки И Не ФормаОтчета.РежимРедактированияНастройки Тогда
			СохранитьНастройкуПользователяНастройкиОтчета(ОтчетОбъект, ФормаОтчета);
		КонецЕсли;
		
		СсылкаНаОбъект = ПолучитьИдентификаторОбъекта(ОтчетОбъект); 
		НастраиваемыйОбъект = ?(ОтчетОбъект.СохраненнаяНастройка.Пустая(), СсылкаНаОбъект, ОтчетОбъект.СохраненнаяНастройка);
		Настройка = ПолучитьНастройкуПользователяНастройкиОтчета(НастраиваемыйОбъект);
		Если Настройка <> Неопределено Тогда
			Настройка = Настройка.ПолучитьОбъект();
			Значение = Настройка.ХранилищеНастроек.Получить();
		Иначе
			Настройка = Справочники.СохраненныеНастройки.СоздатьЭлемент();
			Настройка.НастраиваемыйОбъект = НастраиваемыйОбъект;
			Настройка.ТипНастройки = Перечисления.ТипыНастроек.НастройкиПользователяНастройкиОтчета;
			Настройка.Наименование = "НастройкиПользователяНастройкиОтчета";
			НовыйПользователь = Настройка.Пользователи.Добавить();
			НовыйПользователь.Пользователь = глЗначениеПеременной("глТекущийПользователь");
			Значение = Новый Соответствие;
		КонецЕсли;
		ТД = Новый ТабличныйДокумент;
		ТД.Вывести(ФормаОтчета.ЭлементыФормы.Результат);
		Значение["Результат"] = ТД;
		Настройка.ХранилищеНастроек = Новый ХранилищеЗначения(Значение);
		Настройка.Записать();
		
	КонецПроцедуры
	
	Процедура СохранитьРезультатССохраненным(ОтчетОбъект, ФормаОтчета) Экспорт
		
		СсылкаНаОбъект = ПолучитьИдентификаторОбъекта(ОтчетОбъект); 
		НастраиваемыйОбъект = ?(ОтчетОбъект.СохраненнаяНастройка.Пустая(), СсылкаНаОбъект, ОтчетОбъект.СохраненнаяНастройка);
		Настройка = ПолучитьНастройкуПользователяНастройкиОтчета(НастраиваемыйОбъект);
		Если Настройка = Неопределено Тогда
			Возврат;
		КонецЕсли;
		Значение = Настройка.ХранилищеНастроек.Получить();
		ТД = Значение["Результат"];
		Если ТД = Неопределено Тогда
			Вопрос("Отсутствует сохраненный результат", РежимДиалогаВопрос.ОК);
			Возврат;
		ИначеЕсли ТД.ВысотаТаблицы = 0 Тогда
			Вопрос("Сохраненный результат пустой", РежимДиалогаВопрос.ОК);
			Возврат;
		ИначеЕсли ФормаОтчета.ЭлементыФормы.Результат.ВысотаТаблицы = 0 Тогда
			Вопрос("Текущий результат пустой", РежимДиалогаВопрос.ОК);
			Возврат;
		КонецЕсли;
		
		ТД2 = Новый ТабличныйДокумент;
		ТД2.Вывести(ФормаОтчета.ЭлементыФормы.Результат);
		
		Файл1 = ПолучитьИмяВременногоФайла("ФайлСравнения1.mxl");
		Файл2 = ПолучитьИмяВременногоФайла("ФайлСравнения2.mxl");
		ТД2.Записать(Файл1);
		ТД.Записать(Файл2);
		СравнениеФайлов = Новый СравнениеФайлов;
		СравнениеФайлов.ПервыйФайл = Файл1;
		СравнениеФайлов.ВторойФайл = Файл2;
		СравнениеФайлов.СпособСравнения = СпособСравненияФайлов.ТабличныйДокумент;
		
		Если СравнениеФайлов.Сравнить() Тогда
			Вопрос("Результаты совпадают", РежимДиалогаВопрос.ОК);
		Иначе
			СравнениеФайлов.ПоказатьРазличия();
		КонецЕсли;
		
	КонецПроцедуры
	
	Процедура СохранитьТекущуюНастройку(ОтчетОбъект, ФормаОтчета) Экспорт
		
		Если Не ОтчетОбъект.СохраненнаяНастройка.Пустая() И ОтчетОбъект.СохраненнаяНастройка.ПолучитьОбъект() = Неопределено Тогда
			// Вариант отчета удален. Сбрасываем вариант отчета на основной и предлагаем сохранить как
			ОтчетОбъект.СохраненнаяНастройка = Справочники.СохраненныеНастройки.ПустаяСсылка();
			СохранитьТекущуюНастройкуКак(ОтчетОбъект, ФормаОтчета);
			ОбновитьЗаголовокТиповогоОтчета(ОтчетОбъект, ФормаОтчета);
			Возврат;
		КонецЕсли;
		
		Если Не ЗаписьОтчетаДоступна(ОтчетОбъект) Тогда
			СохранитьТекущуюНастройкуКак(ОтчетОбъект, ФормаОтчета);
			Возврат;
		КонецЕсли;
		
		ЗагрузитьВРеквизитЗначенияНастроекПанелиПользователя(ОтчетОбъект, ФормаОтчета);
		Если ОтчетОбъект.СохраненнаяНастройка.Пустая() Тогда
			ФормаОтчета.ЗаписатьВФорме();
		Иначе
			ОтчетОбъект.СохранитьНастройку();
		КонецЕсли;
		
		ФормаОтчета.Модифицированность = Ложь;
		ОбновитьЗаголовокТиповогоОтчета(ОтчетОбъект, ФормаОтчета);
		ФормаОтчета.Модифицированность = Ложь;
		УдалитьПользовательскиеНастройки(ОтчетОбъект.СохраненнаяНастройка);

		
	КонецПроцедуры
	
	Процедура СохранитьТекущуюНастройкуКак(ОтчетОбъект, ФормаОтчета) Экспорт
		
		СохраненнаяСохраненнаяНастройка = ОтчетОбъект.СохраненнаяНастройка;
		СохранениеНастроек.ВыбратьНастройкуФормы(ОтчетОбъект.СохраненнаяНастройка, ФормаОтчета, ПолучитьИдентификаторОбъекта(ОтчетОбъект), Истина);
		
		Если Не ФормаОтчета.РежимРедактированияНастройки Тогда
			ОбновитьТаблицуДоступныхНастроекПользователю(ОтчетОбъект);
			ОбновитьКнопкиВыбораНастроек(ФормаОтчета, ОтчетОбъект, ФормаОтчета.ПредставлениеНастройки, ФормаОтчета.РежимРедактированияНастройки);
		Иначе
			// Сохранили настройки отчета в СохраненнуюНастройку
			ОтчетОбъект.СохраненнаяНастройка = СохраненнаяСохраненнаяНастройка;
			УдалитьПользовательскиеНастройки(ОтчетОбъект.СохраненнаяНастройка);
		КонецЕсли;
		
	КонецПроцедуры
	
	Процедура РедактироватьПанельПользователя(ОтчетОбъект, ФормаОтчета) Экспорт
		
		ФормаНастройки = ПолучитьОбщуюФорму("ФормаНастройкиПараметровПанелиПользователя", ФормаОтчета);
		ФормаНастройки.ОтчетОбъект = ОтчетОбъект;
		
		ЗначенияНастроек = ПолучитьЗначенияНастроекПанелиПользователя(ОтчетОбъект, ФормаОтчета);
		Если ФормаНастройки.ОткрытьМодально() = Истина Тогда
			ПерерисоватьПанельНастроек(ОтчетОбъект, ФормаОтчета, ЗначенияНастроек);
			ФормаОтчета.Модифицированность = Истина;
		КонецЕсли;
		
	КонецПроцедуры
	
	Процедура ОткрытьФормуСохраненнойНастройки(ОтчетОбъект, ФормаОтчета) Экспорт
		
		Если Не ОтчетОбъект.СохраненнаяНастройка.Пустая() Тогда
			
			Если ОтчетОбъект.СохраненнаяНастройка.ПолучитьОбъект() = Неопределено Тогда
				ОтчетОбъект.СохраненнаяНастройка = Справочники.СохраненныеНастройки.ПустаяСсылка();
				Вопрос("Текущий вариант отчета удален.", РежимДиалогаВопрос.ОК);
				ОбновитьТаблицуДоступныхНастроекПользователю(ОтчетОбъект);
				ОбновитьКнопкиВыбораНастроек(ФормаОтчета, ОтчетОбъект, ФормаОтчета.ПредставлениеНастройки, ФормаОтчета.РежимРедактированияНастройки);
				ОбновитьЗаголовокТиповогоОтчета(ОтчетОбъект, ФормаОтчета);
				Возврат;
			КонецЕсли;
			
			ФормаЭлемента = ОтчетОбъект.СохраненнаяНастройка.ПолучитьФорму(, ФормаОтчета);
			ФормаЭлемента.ОткрытьМодально();
			ОбновитьТаблицуДоступныхНастроекПользователю(ОтчетОбъект);
			ОбновитьКнопкиВыбораНастроек(ФормаОтчета, ОтчетОбъект, ФормаОтчета.ПредставлениеНастройки, ФормаОтчета.РежимРедактированияНастройки);
		Иначе
			Вопрос("Основной вариант не содержит описания и виден всем пользователям", РежимДиалогаВопрос.ОК);
		КонецЕсли;
		
	КонецПроцедуры
	
	Процедура ОбработкаЗакрытияНастройкиОтчета(ОтчетОбъект, ФормаОтчета, Отказ = Ложь, СтандартнаяОбработка = Истина) Экспорт
		
		Если Не ОтчетОбъект.СохраненнаяНастройка.Пустая() И ОтчетОбъект.СохраненнаяНастройка.ПолучитьОбъект() = Неопределено Тогда
			// Вариант отчета удален
			Возврат;
		КонецЕсли;
		
		Если Не ФормаОтчета.ЭтоОтработкаРасшифровки И Не ФормаОтчета.РежимРедактированияНастройки Тогда
			СохранитьНастройкуПользователяНастройкиОтчета(ОтчетОбъект, ФормаОтчета);
		КонецЕсли;
		
		СтандартнаяОбработка = Ложь;
		Если Не ЗаписьОтчетаДоступна(ОтчетОбъект) ИЛИ Не ФормаОтчета.Модифицированность Тогда
			Возврат;
		КонецЕсли;
		
		Если ОтчетОбъект.СохраненнаяНастройка.Пустая() Тогда
			// Сохраним сам отчет
			РезультатВопроса = Вопрос(НСТР("ru='Сохранить изменения в основном варианте отчета?'"), РежимДиалогаВопрос.ДаНетОтмена);
			Если РезультатВопроса = КодВозвратаДиалога.Да Тогда
				СохранитьТекущуюНастройку(ОтчетОбъект, ФормаОтчета);
			ИначеЕсли РезультатВопроса = КодВозвратаДиалога.Нет Тогда
			Иначе
				Отказ = Истина;
			КонецЕсли;
		Иначе
			// Сохраним настройку
			РезультатВопроса = Вопрос("Сохранить изменения в варианте отчета " 
			+ """" + ОтчетОбъект.СохраненнаяНастройка.Наименование + """?", РежимДиалогаВопрос.ДаНетОтмена);
			Если РезультатВопроса = КодВозвратаДиалога.Отмена Тогда
				Отказ = Истина;
			ИначеЕсли РезультатВопроса = КодВозвратаДиалога.Да Тогда
				СохранитьТекущуюНастройку(ОтчетОбъект, ФормаОтчета);
			КонецЕсли;
		КонецЕсли;
		
	КонецПроцедуры
	
	Процедура СохранитьНастройкуПользователяНастройкиОтчета(ОтчетОбъект, ФормаОтчета) Экспорт
		
		СсылкаНаОбъект = ПолучитьИдентификаторОбъекта(ОтчетОбъект); 
		НастраиваемыйОбъект = ?(ОтчетОбъект.СохраненнаяНастройка.Пустая(), СсылкаНаОбъект, ОтчетОбъект.СохраненнаяНастройка);
		
		Настройка = ПолучитьНастройкуПользователяНастройкиОтчета(НастраиваемыйОбъект);
		Если Настройка <> Неопределено Тогда
			Настройка = Настройка.ПолучитьОбъект();
			Значение = Настройка.ХранилищеНастроек.Получить();
		Иначе
			Настройка = Справочники.СохраненныеНастройки.СоздатьЭлемент();
			Настройка.НастраиваемыйОбъект = НастраиваемыйОбъект;
			Настройка.ТипНастройки = Перечисления.ТипыНастроек.НастройкиПользователяНастройкиОтчета;
			//Настройка.Владелец = глЗначениеПеременной("глТекущийПользователь");
			Настройка.Наименование = "НастройкиПользователяНастройкиОтчета";
			НовыйПользователь = Настройка.Пользователи.Добавить();
			НовыйПользователь.Пользователь = глЗначениеПеременной("глТекущийПользователь");
			Значение = Новый Соответствие;
		КонецЕсли;
		Значение["ЗначенияНастроекПанелиПользователя"] = ПолучитьЗначенияНастроекПанелиПользователя(ОтчетОбъект, ФормаОтчета);
		Настройка.ХранилищеНастроек = Новый ХранилищеЗначения(Значение);
		Настройка.Записать();
		
	КонецПроцедуры
	
	Процедура ОбработкаВыбораВариантаОтчета(ОтчетОбъект, ФормаОтчета, ВыбраннаяСохраненнаяНастройка) Экспорт 
		Отказ = ложь;
		ОбработкаЗакрытияНастройкиОтчета(ОтчетОбъект, ФормаОтчета, Отказ);
		Если Не ВыбраннаяСохраненнаяНастройка.Пустая() И ВыбраннаяСохраненнаяНастройка.ПолучитьОбъект() = Неопределено Тогда
			Вопрос("Операция невозможна. Вариант отчета удален.", РежимДиалогаВопрос.ОК);
			ОбновитьТаблицуДоступныхНастроекПользователю(ОтчетОбъект);
			ОбновитьКнопкиВыбораНастроек(ФормаОтчета, ОтчетОбъект, ФормаОтчета.ПредставлениеНастройки, ФормаОтчета.РежимРедактированияНастройки);
			Возврат;
		КонецЕсли;
		
		ОтчетОбъект.ЗначенияНастроекПанелиПользователя = Новый ХранилищеЗначения(Неопределено);
		ОтчетОбъект.ПараметрыПанелиПользователя = Новый ХранилищеЗначения(ПолучитьПараметрыПанелиПользователяПоУмолчанию(ОтчетОбъект, ФормаОтчета));
		ФормаОтчета.КомпоновщикНастроекПользователя = Новый КомпоновщикНастроекКомпоновкиДанных;
		
		
		// Сохраним результат
		Если ФормаОтчета.СоответствиеНастройкаРезультат[ОтчетОбъект.СохраненнаяНастройка] <> Неопределено Тогда
			ФормаОтчета.ЭлементыФормы.Удалить(ФормаОтчета.СоответствиеНастройкаРезультат[ОтчетОбъект.СохраненнаяНастройка].Результат);
		КонецЕсли;
		Результат = ФормаОтчета.ЭлементыФормы.Добавить(Тип("ПолеТабличногоДокумента"), , Ложь);
		Результат.Вывести(ФормаОтчета.ЭлементыФормы.Результат);
		Структура = Новый Структура;
		Структура.Вставить("Результат", Результат);
		Структура.Вставить("ФиксацияСверху",    ФормаОтчета.ЭлементыФормы.Результат.ФиксацияСверху);
		Структура.Вставить("ДанныеРасшифровки", ФормаОтчета.ДанныеРасшифровки);
		ФормаОтчета.СоответствиеНастройкаРезультат[ОтчетОбъект.СохраненнаяНастройка] = Структура;
		
		// Установим настройку
		ОтчетОбъект.СохраненнаяНастройка = ВыбраннаяСохраненнаяНастройка;
		
		// Загрузим результат, если есть сохраненный
		ФормаОтчета.ЭлементыФормы.Результат.Очистить();
		ФормаОтчета.ЭлементыФормы.Результат.ФиксацияСверху = 0;
		Структура = ФормаОтчета.СоответствиеНастройкаРезультат[ОтчетОбъект.СохраненнаяНастройка];
		
		Если Структура <> Неопределено Тогда
			
			ФормаОтчета.ЭлементыФормы.Результат.Вывести(Структура.Результат);
			ФормаОтчета.ДанныеРасшифровки = Структура.ДанныеРасшифровки;
			ФормаОтчета.ЭлементыФормы.Результат.ФиксацияСверху = Структура.ФиксацияСверху;
			ФормаОтчета.Обновить();
			
		КонецЕсли;
		
		// Загрузим саму настройку
		Если ОтчетОбъект.СохраненнаяНастройка.Пустая() Тогда
			
			ПрименитьНастройкуПользователяНастройкиОтчета(ОтчетОбъект);
			ОтчетОбъект.КомпоновщикНастроек.ЗагрузитьНастройки(ПолучитьСхемуКомпоновкиОбъекта(ОтчетОбъект).НастройкиПоУмолчанию);
			
		Иначе
			
			ОтчетОбъект.ПрименитьНастройку();
			ПрименитьНастройкуПользователяНастройкиОтчета(ОтчетОбъект);
			
		КонецЕсли;
		
		ОбработкаФормыПослеПримененияНастройки(ОтчетОбъект, ФормаОтчета);
		
	КонецПроцедуры
	
	Процедура СохранитьПараметрыТабличногоДокумента(Результат, ВариантОтчета) Экспорт
		
		Структура = Новый Структура("АвтоМасштаб, ПолеСверху, ПолеСлева, ПолеСнизу, ПолеСправа, МасштабПечати, ИмяПараметровПечати, ИмяПринтера, ОриентацияСтраницы ");
		Структура.АвтоМасштаб         = Результат.АвтоМасштаб;
		Структура.ПолеСверху          = Результат.ПолеСверху;
		Структура.ПолеСлева           = Результат.ПолеСлева;
		Структура.ПолеСнизу           = Результат.ПолеСнизу;
		Структура.ПолеСправа          = Результат.ПолеСправа;
		Структура.МасштабПечати       = Результат.МасштабПечати;
		Структура.ИмяПараметровПечати = Результат.ИмяПараметровПечати;
		Структура.ИмяПринтера         = Результат.ИмяПринтера;
		Структура.ОриентацияСтраницы  = Результат.ОриентацияСтраницы;
		
		СохранитьЗначение("УниверсальныйОтчет_НастройкиВариантаОтчета_" + ВариантОтчета.НастраиваемыйОбъект + "/" + ВариантОтчета, Структура);
	КонецПроцедуры
	
	Процедура ВосстановитьПараметрыТабличногоДокумента(Результат, ВариантОтчета) Экспорт
		
		ПараметрыТабличногоДокумента = ВосстановитьЗначение("УниверсальныйОтчет_НастройкиВариантаОтчета_" + ВариантОтчета.НастраиваемыйОбъект + "/" + ВариантОтчета);
		Если ТипЗНЧ(ПараметрыТабличногоДокумента) = Тип("Структура") тогда
			Результат.АвтоМасштаб         = ПараметрыТабличногоДокумента.АвтоМасштаб;
			Результат.ПолеСверху          = ПараметрыТабличногоДокумента.ПолеСверху;
			Результат.ПолеСлева           = ПараметрыТабличногоДокумента.ПолеСлева;
			Результат.ПолеСнизу           = ПараметрыТабличногоДокумента.ПолеСнизу;
			Результат.ПолеСправа          = ПараметрыТабличногоДокумента.ПолеСправа;
			Результат.МасштабПечати       = ПараметрыТабличногоДокумента.МасштабПечати;
			Результат.ИмяПараметровПечати = ПараметрыТабличногоДокумента.ИмяПараметровПечати;
			Результат.ИмяПринтера      	  = ПараметрыТабличногоДокумента.ИмяПринтера;
			Результат.ОриентацияСтраницы  = ПараметрыТабличногоДокумента.ОриентацияСтраницы;
			
		КонецЕсли;
	КонецПроцедуры
	
	
	Процедура ВыборВариантаОтчетаНаПанелиВариантов(ОтчетОбъект, ФормаОтчета, Элемент = Неопределено, СохраненаяНастройка = Неопределено) Экспорт
		
		Если СохраненаяНастройка = Неопределено тогда
			Индекс = Число(Сред(Элемент.Имя, 27));
			Если Не ФормаОтчета.ЭтоОтработкаРасшифровки И Не ФормаОтчета.РежимРедактированияНастройки Тогда
				СохранитьНастройкуПользователяНастройкиОтчета(ОтчетОбъект, ФормаОтчета);
			КонецЕсли;
		Иначе
			СтрокаТаблицы = ОтчетОбъект.ТаблицаВариантовОтчета.Найти(СохраненаяНастройка, "Ссылка");
			Если СтрокаТаблицы = Неопределено тогда
				Возврат;
			КонецЕсли;
			Индекс = ОтчетОбъект.ТаблицаВариантовОтчета.Индекс(СтрокаТаблицы);
			Элемент = ФормаОтчета.ЭлементыФормы["ПолеКартинкиВыбораВарианта" + Индекс];
		КонецЕсли;
		ВыбраннаяСохраненнаяНастройка = ОтчетОбъект.ТаблицаВариантовОтчета[Индекс].Ссылка;
		
		Если Не ВыбраннаяСохраненнаяНастройка.Пустая() И ВыбраннаяСохраненнаяНастройка.ПолучитьОбъект() = Неопределено Тогда
			Вопрос("Операция невозможна. Вариант отчета """ + Элемент.ТекстНевыбраннойКартинки + """ удален.", РежимДиалогаВопрос.ОК);
			ОбновитьТаблицуДоступныхНастроекПользователю(ОтчетОбъект);
			ОбновитьКнопкиВыбораНастроек(ФормаОтчета, ОтчетОбъект, ФормаОтчета.ПредставлениеНастройки, ФормаОтчета.РежимРедактированияНастройки);
			Возврат;
		КонецЕсли;
		
		//Отказ = Ложь;
		// Затерем значения настроек панели чтобы они не перешли на другой вариант отчета
		ОтчетОбъект.ЗначенияНастроекПанелиПользователя = Новый ХранилищеЗначения(Неопределено);
		ОтчетОбъект.ПараметрыПанелиПользователя = Новый ХранилищеЗначения(ПолучитьПараметрыПанелиПользователяПоУмолчанию(ОтчетОбъект, ФормаОтчета));
		ОчиститьКомпоновщикНастроек(ФормаОтчета.КомпоновщикНастроекПользователя);
		//ФормаОтчета.КомпоновщикНастроекПользователя = Новый КомпоновщикНастроекКомпоновкиДанных;
		//Если Отказ Тогда
		//	Возврат;
		//КонецЕсли;
		
		// Сохраним результат
		Если ФормаОтчета.СоответствиеНастройкаРезультат[ОтчетОбъект.СохраненнаяНастройка] <> Неопределено Тогда
			ФормаОтчета.ЭлементыФормы.Удалить(ФормаОтчета.СоответствиеНастройкаРезультат[ОтчетОбъект.СохраненнаяНастройка].Результат);
		КонецЕсли;
		Результат = ФормаОтчета.ЭлементыФормы.Добавить(Тип("ПолеТабличногоДокумента"), , Ложь);
		Результат.Вывести(ФормаОтчета.ЭлементыФормы.Результат);
		Структура = Новый Структура;
		Структура.Вставить("Результат", Результат);
		Структура.Вставить("ФиксацияСверху",    ФормаОтчета.ЭлементыФормы.Результат.ФиксацияСверху);
		Структура.Вставить("ДанныеРасшифровки", ФормаОтчета.ДанныеРасшифровки);
		ФормаОтчета.СоответствиеНастройкаРезультат[ОтчетОбъект.СохраненнаяНастройка] = Структура;
		
		//запомним настройки табличного документа
		
		СохранитьПараметрыТабличногоДокумента(ФормаОтчета.ЭлементыФормы.Результат, ОтчетОбъект.СохраненнаяНастройка);
		
		// Обновим кнопки выбора настройки
		Для каждого ЭлементСписка Из ОтчетОбъект.ТаблицаВариантовОтчета Цикл
			Кнопка = ФормаОтчета.ЭлементыФормы["ПолеКартинкиВыбораВарианта" + ОтчетОбъект.ТаблицаВариантовОтчета.Индекс(ЭлементСписка)];
			Кнопка.ЦветФона        = ЦветаСтиля.ЦветФонаКнопки;;
			Кнопка.ЦветТекста      = WebЦвета.ТемноСиний;
			Кнопка.КонтекстноеМеню = Неопределено;
			Кнопка.ГиперСсылка     = истина;
		КонецЦикла;
		Элемент.ЦветФона    = Новый Цвет(255, 248, 220);
		Элемент.ЦветТекста  = ЦветаСтиля.ЦветТекстаКнопки;
		Элемент.ГиперСсылка = ложь;
		
		// Установим настройку
		ОтчетОбъект.СохраненнаяНастройка = ОтчетОбъект.ТаблицаВариантовОтчета[Индекс].Ссылка;
		
		Элемент.КонтекстноеМеню = ФормаОтчета.ЭлементыФормы.КонтекстноеМенюКартинкиВыбораСохраненнойНастройки;
		
		// Загрузим результат, если есть сохраненный
		ФормаОтчета.ЭлементыФормы.Результат.Очистить();
		ФормаОтчета.ЭлементыФормы.Результат.ФиксацияСверху = 0;
		Структура = ФормаОтчета.СоответствиеНастройкаРезультат[ОтчетОбъект.СохраненнаяНастройка];
		Если Структура <> Неопределено Тогда
			ФормаОтчета.ЭлементыФормы.Результат.Вывести(Структура.Результат);
			ФормаОтчета.ДанныеРасшифровки = Структура.ДанныеРасшифровки;
			ФормаОтчета.ЭлементыФормы.Результат.ФиксацияСверху = Структура.ФиксацияСверху;
			ФормаОтчета.Обновить();
		КонецЕсли;
		
		ВосстановитьПараметрыТабличногоДокумента(ФормаОтчета.ЭлементыФормы.Результат, ОтчетОбъект.СохраненнаяНастройка);
		
		// Загрузим саму настройку
		Если ОтчетОбъект.СохраненнаяНастройка.Пустая() Тогда
			
			ПрименитьНастройкуПользователяНастройкиОтчета(ОтчетОбъект);
			ОтчетОбъект.КомпоновщикНастроек.ЗагрузитьНастройки(ПолучитьСхемуКомпоновкиОбъекта(ОтчетОбъект).НастройкиПоУмолчанию);
			
		Иначе
			
			ОтчетОбъект.ПрименитьНастройку();
			ПрименитьНастройкуПользователяНастройкиОтчета(ОтчетОбъект);
			
		КонецЕсли;
		
		ОбработкаФормыПослеПримененияНастройки(ОтчетОбъект, ФормаОтчета);
		
	КонецПроцедуры
	
	Процедура ОбработкаФормыПослеПримененияНастройки(ОтчетОбъект, ФормаОтчета, ИспользоватьЗначенияНастроекНаФорме = Ложь) Экспорт
		
		Если ИспользоватьЗначенияНастроекНаФорме Тогда
			ЗначенияНастроек = ПолучитьЗначенияНастроекПанелиПользователя(ОтчетОбъект, ФормаОтчета);
		КонецЕсли;
		ПерерисоватьПанельНастроек(ОтчетОбъект, ФормаОтчета, ЗначенияНастроек);
		ОбновитьФормуТиповогоОтчетаПоКомпоновщику(ОтчетОбъект, ФормаОтчета);
		ОбновитьЗаголовокТиповогоОтчета(ОтчетОбъект, ФормаОтчета);
		
		ФормаОтчета.Модифицированность = Ложь;
		
		ЕстьЭлементыУправленияНаПравойПанели = Истина;
		
		Если ФормаОтчета.ОтчетОбъект.ПараметрыПанелиПользователя <> Неопределено тогда
			ПараметрыПанели = ФормаОтчета.ОтчетОбъект.ПараметрыПанелиПользователя.Получить();
			
			ЭлементыФормы = ФормаОтчета.ЭлементыФормы;
			Кнопка = Неопределено;
			
			Если ЭлементыФормы.КоманднаяПанельДействияСОтчетом.Кнопки.Найти("ПанельПользователя") <> Неопределено тогда
				Кнопка = ЭлементыФормы.КоманднаяПанельДействияСОтчетом.Кнопки.ПанельПользователя;
			ИначеЕсли ЭлементыФормы.СервиснаяПанель.Кнопки.Найти("ПанельПользователя") <> Неопределено тогда
				Кнопка = ЭлементыФормы.СервиснаяПанель.Кнопки.ПанельПользователя;
			КонецЕсли;
			
			ЕстьЭлементыУправленияНаПравойПанели = ложь;
			
			Если ПараметрыПанели.Свойство("Отборы") и ПараметрыПанели.Отборы <> Неопределено тогда
				Для каждого СтрокаОтбора из ПараметрыПанели.Отборы Цикл
					Если СтрокаОтбора.Расположение <> "ГоризонтальнаяПанель" тогда
						ЕстьЭлементыУправленияНаПравойПанели = Истина;
						Прервать;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			
			Если Не ЕстьЭлементыУправленияНаПравойПанели И ПараметрыПанели.Свойство("Параметры") и ПараметрыПанели.Параметры <> Неопределено тогда
				Для каждого СтрокаОтбора из ПараметрыПанели.Параметры Цикл
					Если СтрокаОтбора.ВыводитьНа <> "ГоризонтальнаяПанель" и СтрокаОтбора.ВыводитьНа <> "" и СтрокаОтбора.ВыводитьНа <> Неопределено тогда
						ЕстьЭлементыУправленияНаПравойПанели = Истина;
						Прервать;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			
			Если НЕ ЕстьЭлементыУправленияНаПравойПанели И ПараметрыПанели.Свойство("ДеревоНастроекСтандартныхСтраниц") и ПараметрыПанели.ДеревоНастроекСтандартныхСтраниц <> Неопределено тогда
				Для каждого СтрокаОтбора из ПараметрыПанели.ДеревоНастроекСтандартныхСтраниц.Строки Цикл
					Если СтрокаОтбора.Использование и СтрокаОтбора.Имя <> "Период" тогда
						ЕстьЭлементыУправленияНаПравойПанели = Истина;
						Прервать;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
		КонецЕсли;
		
		Если НЕ ЕстьЭлементыУправленияНаПравойПанели и Кнопка.Пометка тогда 
			Кнопка.Пометка = ложь;
		КонецЕсли;
		
		УправлениеОтображениемПанелиПользователя(ФормаОтчета);
		
	КонецПроцедуры
	
	Процедура УстановитьВидимостьПанелиВариантовПоУмолчанию(ЭтотОбъект, ЭтаФорма) Экспорт
		ЭлементыФормы = ЭтаФорма.ЭлементыФормы;
		Если ЭлементыФормы.КоманднаяПанельДействияСОтчетом.Кнопки.Найти("ПанельВариантов") <> Неопределено тогда
			Если ЭтотОбъект.ТаблицаВариантовОтчета.Количество() < 2 Тогда
				ЭлементыФормы.КоманднаяПанельДействияСОтчетом.Кнопки.ПанельВариантов.Пометка = Ложь;
			КонецЕсли;
			Если ЭтаФорма.ЭтоОтработкаРасшифровки тогда
				ЭлементыФормы.КоманднаяПанельДействияСОтчетом.Кнопки.ПанельВариантов.Пометка = Ложь;
			КонецЕсли;
		ИначеЕсли ЭлементыФормы.Найти("СервиснаяПанель") <> Неопределено 
			И ЭлементыФормы.СервиснаяПанель.Кнопки.Найти("ПанельВариантов") <> Неопределено тогда 
			Если ЭтотОбъект.ТаблицаВариантовОтчета.Количество() < 2 Тогда
				ЭлементыФормы.СервиснаяПанель.Кнопки.ПанельВариантов.Пометка = Ложь;
			КонецЕсли;
			Если ЭтаФорма.ЭтоОтработкаРасшифровки тогда
				ЭлементыФормы.СервиснаяПанель.Кнопки.ПанельВариантов.Пометка = Ложь;
			КонецЕсли;
		КонецЕсли;
	КонецПроцедуры
	
	Процедура УстановитьВидимостьПанелиПользователяПоУмолчанию(ЭтотОбъект, ЭтаФорма) Экспорт
		
		ЭлементыФормы = ЭтаФорма.ЭлементыФормы;
		
		Если ЭтотОбъект.ТаблицаВариантовОтчета.Количество() = 0 Тогда
			Если ЭлементыФормы.КоманднаяПанельДействияСОтчетом.Кнопки.Найти("ПанельПользователя") <> Неопределено тогда
				ЭлементыФормы.КоманднаяПанельДействияСОтчетом.Кнопки.ПанельПользователя.Пометка = Ложь;
			ИначеЕсли ЭлементыФормы.Найти("СервиснаяПанель") <> Неопределено 
				И ЭлементыФормы.СервиснаяПанель.Кнопки.Найти("ПанельПользователя") <> Неопределено тогда
				ЭлементыФормы.СервиснаяПанель.Кнопки.ПанельПользователя.Пометка = Ложь;
			КонецЕсли;
		КонецЕсли;
		
	КонецПроцедуры
	
	
	Процедура УправлениеОтображениемПанелиПользователя(ФормаОтчета) Экспорт
		
		ЭлементыФормы = ФормаОтчета.ЭлементыФормы;
		Кнопка = Неопределено;
		Если ЭлементыФормы.КоманднаяПанельДействияСОтчетом.Кнопки.Найти("ПанельПользователя") <> Неопределено тогда
			Кнопка = ЭлементыФормы.КоманднаяПанельДействияСОтчетом.Кнопки.ПанельПользователя;
		ИначеЕсли ЭлементыФормы.СервиснаяПанель.Кнопки.Найти("ПанельПользователя") <> Неопределено тогда
			Кнопка = ЭлементыФормы.СервиснаяПанель.Кнопки.ПанельПользователя;
		КонецЕсли;
		
		ЕстьРазделитель = ЭлементыФормы.Найти("Разделитель") <> Неопределено;
		
		Если ЕстьРазделитель тогда
			
			Если Кнопка = Неопределено или Не Кнопка.Пометка тогда
				ЭлементыФормы.ПанельПользователя.УстановитьПривязку(ГраницаЭлементаУправления.Лево);
				ЭлементыФормы.Разделитель.УстановитьПривязку(ГраницаЭлементаУправления.Право, ЭлементыФормы.ПанельПользователя, ГраницаЭлементаУправления.Лево);
				ЭлементыФормы.ПанельПользователя.Свертка = РежимСверткиЭлементаУправления.Право;
				ЭлементыФормы.Разделитель.Свертка        = РежимСверткиЭлементаУправления.Право;
			Иначе
				ЭлементыФормы.ПанельПользователя.Свертка = РежимСверткиЭлементаУправления.Нет;
				ЭлементыФормы.Разделитель.Свертка        = РежимСверткиЭлементаУправления.Нет;
				ШиринаПанели = ЭлементыФормы.ПанельПользователя.Ширина;
				Если ШиринаПанели/ФормаОтчета.Ширина > 0.5 тогда
					ШиринаПанели = Окр(ФормаОтчета.Ширина*0.3);
					ЭлементыФормы.ПанельПользователя.Ширина = ШиринаПанели;
					ЭлементыФормы.ПанельПользователя.Лево = ФормаОтчета.Ширина - ШиринаПанели -6;
				КонецЕсли;
				ЭлементыФормы.Разделитель.УстановитьПривязку(ГраницаЭлементаУправления.Право, ЭлементыФормы.ПанельВыбораВариантов, ГраницаЭлементаУправления.Право);
				ЭлементыФормы.ПанельПользователя.УстановитьПривязку(ГраницаЭлементаУправления.Лево, ЭлементыФормы.Разделитель, ГраницаЭлементаУправления.Право);
				ЭлементыФормы.Разделитель.Лево            = ФормаОтчета.Ширина - ШиринаПанели - 7 - 8; // 330 - 323   513
				ЭлементыФормы.Результат.Ширина            = ФормаОтчета.Ширина - 16 - 7 - ШиринаПанели;
				//вычислим ширнину панели если 
				
			КонецЕсли;
		Иначе	
			Если Не Кнопка.Пометка тогда
				ЭлементыФормы.ПанельПользователя.Свертка = РежимСверткиЭлементаУправления.Право;
			Иначе
				ЭлементыФормы.ПанельПользователя.Свертка = РежимСверткиЭлементаУправления.Нет;
				ШиринаПанели = ЭлементыФормы.ПанельПользователя.Ширина;
				Если ШиринаПанели/ФормаОтчета.Ширина > 0.5 тогда
					ШиринаПанели = Окр(ФормаОтчета.Ширина*0.3);
					ЭлементыФормы.ПанельПользователя.Ширина = ШиринаПанели;
					ЭлементыФормы.ПанельПользователя.Лево = ФормаОтчета.Ширина - ШиринаПанели -6;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецПроцедуры
	
	Процедура УправлениеОтображениемПанелиВариантов(ФормаОтчета) Экспорт
		
		ЭлементыФормы = ФормаОтчета.ЭлементыФормы;
		Кнопка = Неопределено;
		Если ЭлементыФормы.КоманднаяПанельДействияСОтчетом.Кнопки.Найти("ПанельВариантов") <> Неопределено тогда
			Кнопка = ЭлементыФормы.КоманднаяПанельДействияСОтчетом.Кнопки.ПанельВариантов;
		Иначе
			Если ЭлементыФормы.СервиснаяПанель.Кнопки.Найти("ПанельВариантов") <> Неопределено И ЭлементыФормы.Найти("СервиснаяПанель") <> Неопределено тогда
				Кнопка = ЭлементыФормы.СервиснаяПанель.Кнопки.ПанельВариантов;
			КонецЕсли;
		КонецЕсли;
		Если Кнопка <> Неопределено И Кнопка.Пометка Тогда
			ЭлементыФормы.РазделительПанелиВыбораВариантов.Свертка = РежимСверткиЭлементаУправления.Нет;
			ЭлементыФормы.ПанельВыбораВариантов.Свертка = РежимСверткиЭлементаУправления.Нет;
			ЭлементыФормы.РазделительПанелиВыбораВариантов.УстановитьПривязку(ГраницаЭлементаУправления.Верх);
			ЭлементыФормы.ПанельВыбораВариантов.УстановитьПривязку(ГраницаЭлементаУправления.Низ, ЭлементыФормы.РазделительПанелиВыбораВариантов, ГраницаЭлементаУправления.Верх);
			ЭлементыФормы.Сформировать.Высота = ЭлементыФормы.Сформировать.Высота - 2;
		Иначе
			ЭлементыФормы.ПанельВыбораВариантов.УстановитьПривязку(ГраницаЭлементаУправления.Низ);
			ЭлементыФормы.РазделительПанелиВыбораВариантов.УстановитьПривязку(ГраницаЭлементаУправления.Верх, ЭлементыФормы.ПанельВыбораВариантов, ГраницаЭлементаУправления.Низ);
			ЭлементыФормы.ПанельВыбораВариантов.Свертка = РежимСверткиЭлементаУправления.Верх;
			ЭлементыФормы.РазделительПанелиВыбораВариантов.Свертка = РежимСверткиЭлементаУправления.Верх;
			ЭлементыФормы.Сформировать.Высота = ЭлементыФормы.Сформировать.Высота + 2;
		КонецЕсли;
		
	КонецПроцедуры
	
	Процедура ОбновитьИзмененияТабличногоПоля(ЭлементыФормы, Элемент) Экспорт
		
		Если ТипЗнч(Элемент) = Тип("Число") Тогда
			Индекс = Элемент;
		Иначе
			Индекс = Число(Сред(Элемент.Имя, 18, 1));
		КонецЕсли;
		
		ЭлементТабличноеПоле = ЭлементыФормы["ДинамическийОтбор" + Индекс + "ТабличноеПоле"];
		ЭлементВидСравнения = ЭлементыФормы["ДинамическийОтбор" + Индекс + "ВидСравнения"];
		
		// При очистке списка можно смело выставлять вид сравнения в "Не отбирать"
		Если ЭлементТабличноеПоле.Значение.Количество() = 0 И ЭлементВидСравнения.Значение <> "" Тогда
			ЭлементВидСравнения.Значение = "";
		КонецЕсли;
		
		// Если список не пуст, а вид сравнения "Не отбирать", установим вид сравнения в "Только выбранные"
		Если ЭлементТабличноеПоле.Значение.Количество() > 0 И ЭлементВидСравнения.Значение = "" Тогда
			ЭлементВидСравнения.Значение = "Выбранные";
		КонецЕсли;
		
	КонецПроцедуры
	
	Процедура ОбработкаНажатияКнопкиПодбор(ОтчетОбъект, ФормаОтчета, Элемент, Владелец = Неопределено, НазваниеРеквизита = "", СписокТипов = Неопределено) Экспорт
		
		Параметры = ПолучитьПараметрыПанелиПользователяОбъекта(ОтчетОбъект);
		Индекс = Число(Сред(Элемент.Имя, 18, 1));
		СтрокаОтбора = Параметры.Отборы[Индекс];
		МассивТипов = Новый Массив;
		Если СписокТипов = Неопределено тогда
			ДоступноеПоле = ПолучитьДоступноеПолеПоПолюКомпоновкиДанных(СтрокаОтбора.Поле, ОтчетОбъект.КомпоновщикНастроек.Настройки.Отбор.ДоступныеПоляОтбора);
			СписокТипов = ДоступноеПоле.Тип.Типы();
			
			МассивТипов = Новый Массив;
			Для каждого ТипЗнач из СписокТипов Цикл
				Если ТипЗнач <> Тип("Строка") и ТипЗнач <> Тип("Число") и ТипЗнач <> Тип("Дата") и ТипЗнач <> Тип("NULL")
					и ТипЗнач <> Тип("ВидДвиженияНакопления") и ТипЗнач <> Тип("Булево") и ТипЗнач <> Тип("ХранилищеЗначения") 
					тогда
					МассивТипов.Добавить(ТипЗнач);
				КонецЕсли;
			КонецЦикла;
		Иначе
			МассивТипов = СписокТипов;
		КонецЕсли;
		
		Если МассивТипов.Количество() > 1 Тогда
			СписокТипов = Новый СписокЗначений;
			СписокТипов.ЗагрузитьЗначения(МассивТипов);
			ВыбранныйТип = ФормаОтчета.ВыбратьИзМеню(СписокТипов);
			Если ВыбранныйТип = Неопределено Тогда
				Возврат;
			КонецЕсли;
			ТипПоля = ВыбранныйТип.Значение;
		ИначеЕсли МассивТипов.Количество() = 1 Тогда
			ТипПоля = МассивТипов[0];
		Иначе
			Возврат;
		КонецЕсли;
		
		ОбъектМетаданных = Метаданные.НайтиПоТипу(ТипПоля);
		Если ОбъектМетаданных = Неопределено Тогда
			Возврат;
		КонецЕсли;
		
		ЭлементСписок = ФормаОтчета.ЭлементыФормы.Найти("ДинамическийОтбор"+Индекс+"ТабличноеПоле");
		
		Если Метаданные.Справочники.Найти(ОбъектМетаданных.Имя) <> Неопределено тогда
			ФормаВыбора = Справочники[ОбъектМетаданных.Имя].ПолучитьФормуВыбора(, ФормаОтчета, "ОтборПо" + Индекс);
			
			ФормаВыбора.ЗакрыватьПриВыборе = Ложь;
			Если Владелец <> Неопределено тогда
				ФормаВыбора.ПараметрОтборПоВладельцу = Владелец;
				ФормаВыбора.ПараметрВыборПоВладельцу = Владелец;
				Если НазваниеРеквизита <> "" тогда
					ОтборПоРеквизиту =  ФормаВыбора.Отбор.Найти(НазваниеРеквизита); 
					Если ОтборПоРеквизиту <> Неопределено тогда
						Если ТипЗнч(Владелец) = Тип("ТаблицаЗначений") тогда
							Если Владелец.Количество() > 0 тогда
								ОтборПоРеквизиту.Значение = Владелец[0].Значение;
							КонецЕсли;
						ИначеЕсли ТипЗнч(Владелец) = Тип("СписокЗначений") тогда
							Если Владелец.Количество() > 0 тогда
								ОтборПоРеквизиту.Значение = Владелец[0].Значение;
							КонецЕсли;
						Иначе
							ОтборПоРеквизиту.Значение = Владелец;
						КонецЕсли;
						ОтборПоРеквизиту.Использование = ?(ЗначениеЗаполнено(Владелец), Истина, Ложь);
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
		
		Если Метаданные.Документы.Найти(ОбъектМетаданных.Имя) <> Неопределено тогда
			ФормаВыбора = Документы[ОбъектМетаданных.Имя].ПолучитьФормуВыбора(, ФормаОтчета, "ОтборПо" + Индекс);
			ФормаВыбора.ЗакрыватьПриВыборе = Ложь;
		КонецЕсли;
		
		Если Метаданные.Перечисления.Найти(ОбъектМетаданных.Имя) <> Неопределено тогда
			ФормаВыбора = Перечисления[ОбъектМетаданных.Имя].ПолучитьФормуВыбора(, ФормаОтчета, "ОтборПо" + Индекс);
			ФормаВыбора.ЗакрыватьПриВыборе = Ложь;
		КонецЕсли;
		
		Если Метаданные.ПланыВидовРасчета.Найти(ОбъектМетаданных.Имя) <> Неопределено тогда
			ФормаВыбора = ПланыВидовРасчета[ОбъектМетаданных.Имя].ПолучитьФормуВыбора(, ФормаОтчета, "ОтборПо" + Индекс);
			ФормаВыбора.ЗакрыватьПриВыборе = Ложь;
		КонецЕсли;
		
		Если Метаданные.ПланыВидовХарактеристик.Найти(ОбъектМетаданных.Имя) <> Неопределено тогда
			ФормаВыбора = ПланыВидовХарактеристик[ОбъектМетаданных.Имя].ПолучитьФормуВыбора(, ФормаОтчета, "ОтборПо" + Индекс);
			ФормаВыбора.ЗакрыватьПриВыборе = Ложь;
		КонецЕсли;
		
		Если Метаданные.ПланыСчетов.Найти(ОбъектМетаданных.Имя) <> Неопределено тогда
			ФормаВыбора = ПланыСчетов[ОбъектМетаданных.Имя].ПолучитьФормуВыбора(, ФормаОтчета, "ОтборПо" + Индекс);
			ФормаВыбора.ЗакрыватьПриВыборе = Ложь;
		КонецЕсли;
		
		Если Метаданные.Задачи.Найти(ОбъектМетаданных.Имя) <> Неопределено тогда
			ФормаВыбора = Задачи[ОбъектМетаданных.Имя].ПолучитьФормуВыбора(, ФормаОтчета, "ОтборПо" + Индекс);
			ФормаВыбора.ЗакрыватьПриВыборе = Ложь;
		КонецЕсли;
		
		ФормаВыбора.КлючУникальности = "ОтборПо" + Индекс;
		ФормаВыбора.Открыть();
	КонецПроцедуры
	
	Процедура ОбработкаИзмененияЗначенияДинамическогоОтбора(ЭлементыФормы, Элемент, ФормаОтчета = Неопределено) Экспорт
		
		Если ТипЗнч(Элемент) = Тип("Кнопка") тогда
			НастройкаПериода = Новый НастройкаПериода;
			
			Если ЭлементыФормы.Найти("ДинамическийОтборПериодВыбор") <> Неопределено И ФормаОтчета <> Неопределено тогда
				НачалоПериода = ФормаОтчета.СтандартныйПериод.ДатаНачала;
				КонецПериода  = КонецДня(ФормаОтчета.СтандартныйПериод.ДатаОкончания);
			Иначе	
				НачалоПериода = ЭлементыФормы.ДинамическийОтборДатаНачала.Значение;
				КонецПериода  = КонецДня(ЭлементыФормы.ДинамическийОтборДатаОкончания.Значение);
			КонецЕсли;
			
			НастроитьПериод(НастройкаПериода, НачалоПериода, КонецПериода);
			
			ЭлементыФормы.ДинамическийОтборСтандартныйПериодПользователя.Значение = ВариантСтандартногоПериода.ПроизвольныйПериод;
			
			Если ЭлементыФормы.Найти("ДинамическийОтборПериодВыбор") <> Неопределено И ФормаОтчета <> Неопределено тогда
				ФормаОтчета.СтандартныйПериод.ДатаНачала            = НачалоПериода;
				ФормаОтчета.СтандартныйПериод.ДатаОкончания         = КонецПериода;
				ПараметрыИсполненияОтчета                           = ФормаОтчета.ОтчетОбъект.ПолучитьПараметрыИсполненияОтчета();
				ЭлементыФормы.ДинамическийОтборПериодВыбор.Значение = ПолучитьПредставлениеПериода(НачалоПериода, КонецПериода, ПараметрыИсполненияОтчета.МинимальныйПериодОтчета); 
			Иначе	
				ЭлементыФормы.ДинамическийОтборДатаНачала.Значение    = НачалоПериода;
				ЭлементыФормы.ДинамическийОтборДатаОкончания.Значение = КонецПериода;
			КонецЕсли;
			
		Иначе
			Индекс = Число(Сред(Элемент.Имя, 18, 1));
			ЭлементФлажок = ЭлементыФормы.Найти("ДинамическийОтбор" + Индекс + "Флажок");
			Если ЭлементФлажок <> Неопределено и ТипЗнч(Элемент) = Тип("ПолеВвода") Тогда
				Если ТипЗнч(Элемент.Значение) <> Тип("СписокЗначений") тогда
					ЭлементФлажок.Значение = ЗначениеЗаполнено(Элемент.Значение);
				Иначе
					ЭлементФлажок.Значение = Элемент.Значение.Количество() <> 0;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
	КонецПроцедуры
	
	Функция ПолучитьОтборИзФормы(ОтчетОбъект, ФормаОтчета, Элемент) Экспорт
		Параметры = ПолучитьПараметрыПанелиПользователяОбъекта(ОтчетОбъект);
		ЭлементыФормы = ФормаОтчета.ЭлементыФормы;
		Если ТипЗнч(Элемент) <> Тип("Строка") и ТипЗнч(Элемент) <> Тип("ПолеКомпоновкиДанных") тогда
			Если Лев(Элемент.Имя, 17) <> "ДинамическийОтбор" тогда
				Возврат Неопределено;
			КонецЕсли;
			Индекс = Число(Сред(Элемент.Имя, 18, 1));
			СтрокаОтбора = Параметры.Отборы[Индекс];
		Иначе
			Поле         = Строка(Элемент);
			СтрокаОтбора = Параметры.Отборы.Найти(Поле, "Поле");
			Если СтрокаОтбора <> Неопределено тогда
				Индекс = Параметры.Отборы.Индекс(СтрокаОтбора);
			КонецЕсли;
		КонецЕсли;
		Если СтрокаОтбора = Неопределено тогда
			Возврат Неопределено;
		КонецЕсли;
		Значение = Неопределено;
		ВидСравненияОтбора = Неопределено;
		Использование = Неопределено;
		Если СтрокаОтбора.Расположение = "ГоризонтальнаяПанель" тогда
			ЭлементУпраления = ЭлементыФормы["ДинамическийОтбор" + Индекс + "ПолеВвода"];
			Значение         = ЭлементУпраления.Значение;
			Использование    = ЗначениеЗаполнено(ЭлементУпраления.Значение);
			ВидСравненияОтбора = СтрокаОтбора.ВидСравнения;
		Иначе
			Если СтрокаОтбора.ВидОтбора = "Список" или СтрокаОтбора.ВидОтбора = "ДлинныйСписок" тогда
				ЭлементУпраления = ЭлементыФормы["ДинамическийОтбор" + Индекс + "ТабличноеПоле"];
				Значение         = ЭлементУпраления.Значение;
				ВидСравненияОтбора     = ЭлементыФормы["ДинамическийОтбор" + Индекс + "ВидСравнения"].Значение;     
				Использование    = истина;
				Если ВидСравненияОтбора = "Выбранные" тогда
					ВидСравненияОтбора = СтрокаОтбора.ВидСравнения;
				ИначеЕсли ВидСравненияОтбора = "Исключая" тогда
					ВидСравненияОтбора = ВидСравненияКомпоновкиДанных["Не" + СтрокаОтбора.ВидСравнения];
				Иначе
					ВидСравненияОтбора = СтрокаОтбора.ВидСравнения;
					Использование = ложь;
				КонецЕсли;
			ИначеЕсли СтрокаОтбора.ВидОтбора = "ФлажокЗначение" или СтрокаОтбора.ВидОтбора = "Значение" тогда
				ЭлементУпраления = ЭлементыФормы["ДинамическийОтбор" + Индекс + "ПолеВвода"];
				Значение         = ЭлементУпраления.Значение;
				Если СтрокаОтбора.ВидОтбора = "ФлажокЗначение" тогда
					Использование = ЭлементыФормы["ДинамическийОтбор" + Индекс + "Флажок"].Значение;
				Иначе
					Использование = ЗначениеЗаполнено(ЭлементУпраления.Значение);
				КонецЕсли;
				ВидСравненияОтбора = СтрокаОтбора.ВидСравнения;
			ИначеЕсли СтрокаОтбора.ВидОтбора = "Флажок" тогда
			КонецЕсли;
		КонецЕсли;
		Возврат Новый Структура("СтрокаОтбора, Индекс, Значение, ВидСравнения, Использование",СтрокаОтбора, Индекс, Значение, ВидСравненияОтбора);
	КонецФункции
	
	Функция ПолучитьПараметрИзФормы(ОтчетОбъект, ФормаОтчета, Элемент) Экспорт
		ЭлементыФормы = ФормаОтчета.ЭлементыФормы;
		Параметры = ПолучитьПараметрыПанелиПользователяОбъекта(ОтчетОбъект);
		СтрокаПараметра = Неопределено;
		Индекс = Неопределено;
		Если НЕ Параметры.Свойство("Параметры") тогда
			Возврат Неопределено;
		КонецЕсли;
		Если ТипЗнч(Элемент) <> Тип("Строка") и ТипЗнч(Элемент) <> Тип("ПараметрКомпоновкиДанных") тогда
			Если Лев(Элемент.Имя, 20) <> "ДинамическийПараметр" тогда
				Возврат Неопределено;
			КонецЕсли;
			Индекс = Число(Сред(Элемент.Имя, 21, 1));
			СтрокаПараметра = Параметры.Параметры[Индекс];
		Иначе
			Параметр  = Строка(Элемент);
			СтрокаПараметра = Параметры.Параметры.Найти(Параметр, "Параметр");
			Если СтрокаПараметра <> Неопределено тогда
				Индекс          = Параметры.Параметры.Индекс(СтрокаПараметра);
			КонецЕсли;
		КонецЕсли;
		Если СтрокаПараметра = Неопределено или Индекс = Неопределено тогда
			Возврат Неопределено;
		КонецЕсли;
		Значение = Неопределено;
		Использование = Неопределено;
		Если СтрокаПараметра.ОтображатьКак = "ПолеВвода" тогда
			Значение = ЭлементыФормы["ДинамическийПараметр" + Индекс + "ПолеВвода"].Значение;
		Иначе
			Если СтрокаПараметра.ВыводитьНа = "ГоризонтальнаяПанель" И СтрокаПараметра.ОтображатьКак = "СписокЗначение" тогда
				Значение = ЭлементыФормы["ДинамическийПараметр" + Индекс + "ПолеВвода"].Значение;
				Значение = Значение.Выгрузить("Значение");
			ИначеЕсли СтрокаПараметра.ОтображатьКак = "Переключатель" тогда
				Значение = ЭлементыФормы["ДинамическийПараметр" + Индекс + 0 + "Переключатель"].Значение;
			КонецЕсли;
		КонецЕсли;
		Использование = ЗначениеЗаполнено(Значение);
		Возврат Новый Структура("СтрокаПараметра, Индекс, Значение, Использование", СтрокаПараметра, Индекс, Значение, Использование);
	КонецФункции
	
	Функция ПолучитьОписаниеЭлементаУправленияПоПолюОтбора(ОтчетОбъект, Поле) Экспорт
		Если ТипЗнч(Поле) = Тип("ПолеКомпоновкиДанных") тогда
			Поле = Строка(Поле);
		КонецЕсли;
		Параметры = ПолучитьПараметрыПанелиПользователяОбъекта(ОтчетОбъект);
		СтрокаОтбора = Параметры.Отборы.Найти(Поле, "Поле");
		Если СтрокаОтбора = Неопределено тогда
			Возврат Неопределено;
		КонецЕсли;
		Индекс = Параметры.Отборы.Индекс(СтрокаОтбора);
		Структура = Новый Структура("Индекс, ВидОтбора",Индекс, СтрокаОтбора.ВидОтбора);
		Возврат Структура;
	КонецФункции
	
	Функция ПолучитьОписаниеЭлементаУправленияПоПараметру(ОтчетОбъект, Параметр) Экспорт
		Если ТипЗнч(Параметр) = Тип("ПараметрКомпоновкиДанных") тогда
			Поле = Строка(Поле);
		КонецЕсли;
		Параметры = ПолучитьПараметрыПанелиПользователяОбъекта(ОтчетОбъект);
		СтрокаПараметра = Параметры.Параметры.Найти(Параметр, "Параметр");
		Если СтрокаПараметра = Неопределено тогда
			Возврат Неопределено;
		КонецЕсли;
		Индекс = Параметры.Параметры.Индекс(СтрокаПараметра);
		Если СтрокаПараметра.ОтображатьКак = "СписокЗначение" И СтрокаПараметра.ВыводитьНа = "ПраваяПанель" тогда
			ЭлементУправления = "ТабличноеПоле";
		ИначеЕсли СтрокаПараметра.ОтображатьКак = "СписокЗначение" И СтрокаПараметра.ВыводитьНа = "ГоризонтальнаяПанель" тогда
			ЭлементУправления = "ПолеВвода";
		Иначе
			ЭлементУправления = СтрокаПараметра.ОтображатьКак;
		КонецЕсли;
		НазваниеЭлементаУправления = "ДинамическийПараметр" + Индекс + ЭлементУправления;
		Структура = Новый Структура("Индекс, НазваниеЭлементаУпраления, ОтображатьКак", Индекс, НазваниеЭлементаУправления);
		Возврат Структура;
	КонецФункции
	
	Функция ПолучитьОписаниеЭлементаУправленияПоГруппировке(ОтчетОбъект, ИмяГруппировки) Экспорт
		СписокЗначенийПолей = Новый СписокЗначений;
		Если ИмяГруппировки = Неопределено тогда
			Возврат Неопределено;
		КонецЕсли;
		Параметры = ПолучитьПараметрыПанелиПользователяОбъекта(ОтчетОбъект);
		СтрокаГруппировки = Параметры.Группировки.Найти(ИмяГруппировки, "Группировка");
		ЭлементыСтруктурыОтчета = ПолучитьЭлементыСтруктуры(ОтчетОбъект.КомпоновщикНастроек);
		ПервыйЭлемент = Неопределено;
		Для каждого ЭлементСтруктуры из ЭлементыСтруктурыОтчета Цикл
			Если ЭлементСтруктуры.Значение.Имя = ИмяГруппировки тогда
				ПервыйЭлемент = ЭлементСтруктуры.Значение;
				Прервать;
			КонецЕсли;
		КонецЦикла;
		Если ПервыйЭлемент = Неопределено тогда
			Возврат Неопределено;
		КонецЕсли;
		Индекс = Параметры.Группировки.Индекс(СтрокаГруппировки);
		СтруктураЭлемента = Новый Структура("Индекс, 
		|СтрокаГруппировки, 
		|НазванияЭлементаУправления, 
		|НазваниеЭлементаУправленияСтрок, 
		|НазваниеЭлементаУправленияКолонок,
		|Диаграмма", Индекс, СтрокаГруппировки, Неопределено, Неопределено, Неопределено, ложь);
		
		Если ТипЗнч(ПервыйЭлемент) = Тип("ГруппировкаКомпоновкиДанных") 
			или ТипЗнч(ПервыйЭлемент) = Тип("ГруппировкаТаблицыКомпоновкиДанных") 
			или ТипЗнч(ПервыйЭлемент) = Тип("ГруппировкаДиаграммыКомпоновкиДанных") тогда
			СтруктураЭлемента.НазванияЭлементаУправления = "ДинамическаяГруппировка" + Индекс + "ТабличноеПоле";
		ИначеЕсли ТипЗнч(ПервыйЭлемент) = Тип("ТаблицаКомпоновкиДанных") 
			или ТипЗнч(ПервыйЭлемент) = Тип("ДиаграммаКомпоновкиДанных") тогда
			СтруктураЭлемента.НазваниеЭлементаУправленияСтрок = "ДинамическаяГруппировка" + Индекс + "ТабличноеПолеСтрок";
			СтруктураЭлемента.НазваниеЭлементаУправленияКолонок = "ДинамическаяГруппировка" + Индекс + "ТабличноеПолеКолонок";
			СтруктураЭлемента.Диаграмма =  ТипЗнч(ПервыйЭлемент) = Тип("ДиаграммаКомпоновкиДанных");
		КонецЕсли;
		
		Возврат СтруктураЭлемента;
	КонецФункции
	
	Процедура ЗагрузитьСписокВТабличноеПоле(ОтчетОбъект, ЭлементыФормы, Элемент) Экспорт
		
		Параметры = ПолучитьПараметрыПанелиПользователяОбъекта(ОтчетОбъект);
		Индекс = Число(Сред(Элемент.Имя, 18, 1));
		СтрокаОтбора = Параметры.Отборы[Индекс];
		ЭлементТабличноеПоле = ЭлементыФормы["ДинамическийОтбор" + Индекс + "ТабличноеПоле"];
		
		Отказ = Ложь;
		Значение = ВосстановитьЗначение("ДинамическиеОтборы_СохраненныеСписки");
		Если Значение = Неопределено Тогда
			Отказ = Истина;
		КонецЕсли;
		
		Если Не Отказ Тогда
			Список = Значение[СтрокаОтбора.Поле];
			Если Список = Неопределено ИЛИ Список.Количество() = 0 Тогда
				Отказ = Истина;
			КонецЕсли;
		КонецЕсли;
		
		Если Отказ Тогда
			Вопрос("Сохраненные списки отсутствуют", РежимДиалогаВопрос.ОК, , , "Загрузка списка");
			Возврат;
		КонецЕсли;
		
		ФормаРаботыСоСпискомЗначений = ПолучитьОбщуюФорму("ФормаРаботыСоСпискомЗначений");
		ФормаРаботыСоСпискомЗначений.СписокЗначений = Список;
		ЭлементСписка = ФормаРаботыСоСпискомЗначений.ОткрытьМодально();
		Если ЭлементСписка <> Неопределено Тогда
			ЭлементТабличноеПоле.Значение.Очистить();
			Для каждого ЭлементСпискаСписка Из ЭлементСписка.Значение Цикл
				НоваяСтрока = ЭлементТабличноеПоле.Значение.Добавить();
				НоваяСтрока.Значение = ЭлементСпискаСписка.Значение;
			КонецЦикла;
		КонецЕсли;
		Список = ФормаРаботыСоСпискомЗначений.СписокЗначений;
		Значение[СтрокаОтбора.Поле] = Список;
		СохранитьЗначение("ДинамическиеОтборы_СохраненныеСписки", Значение);
		ОбновитьИзмененияТабличногоПоля(ЭлементыФормы, Элемент);
		
	КонецПроцедуры
	
	Процедура СохранитьСписокВТабличномПоле(ОтчетОбъект, ЭлементыФормы, Элемент) Экспорт
		
		Параметры = ПолучитьПараметрыПанелиПользователяОбъекта(ОтчетОбъект);
		Индекс = Число(Сред(Элемент.Имя, 18, 1));
		СтрокаОтбора = Параметры.Отборы[Индекс];
		ЭлементТабличноеПоле = ЭлементыФормы["ДинамическийОтбор" + Индекс + "ТабличноеПоле"];
		Если ЭлементТабличноеПоле.Значение.Количество() = 0 Тогда
			Вопрос("Список пуст", РежимДиалогаВопрос.ОК);
			Возврат;
		КонецЕсли;
		
		ЗначениеСписка = Новый СписокЗначений;
		ЗначениеСписка.ЗагрузитьЗначения(ЭлементТабличноеПоле.Значение.ВыгрузитьКолонку("Значение"));
		
		НазваниеСписка = Строка(ЗначениеСписка);
		Результат = ВвестиЗначение(НазваниеСписка, "Введите название сохраняемого списка");
		Если Результат = Ложь Тогда
			Возврат;
		КонецЕсли;
		
		Значение = ВосстановитьЗначение("ДинамическиеОтборы_СохраненныеСписки");
		Если Значение = Неопределено Тогда
			Значение = Новый Соответствие;
		КонецЕсли;
		НовыйСписок = Значение[СтрокаОтбора.Поле];
		Если НовыйСписок = Неопределено Тогда
			НовыйСписок = Новый СписокЗначений;
		КонецЕсли;
		НовыйСписок.Добавить(ЗначениеСписка, НазваниеСписка);
		Значение[СтрокаОтбора.Поле] = НовыйСписок;
		СохранитьЗначение("ДинамическиеОтборы_СохраненныеСписки", Значение);
		
	КонецПроцедуры
	
	Процедура ОбработкаВыбораФормыОтчета(ОтчетОбъект, ФормаОтчета, ЗначениеВыбора, Источник) Экспорт
		
		Если ТипЗнч(ЗначениеВыбора) = Тип("СхемаКомпоновкиДанных") Тогда
			
			Если Не ЗаписьОтчетаДоступна(ОтчетОбъект) Тогда
				Предупреждение("Право на изменение отчета имеет только владелец");
				Возврат;
			КонецЕсли;
			
			// Запишем схему компоновки в реквизит
			ОтчетОбъект.СхемаКомпоновкиДанных = Новый ХранилищеЗначения(ЗначениеВыбора);
			
			ИнициализироватьКомпоновщикНастроек(ОтчетОбъект, ЗначениеВыбора);
			ФормаОтчета.КомпоновщикНастроекПользователя.Инициализировать(Новый ИсточникДоступныхНастроекКомпоновкиДанных(ЗначениеВыбора));
			ОтчетОбъект.ПрименитьНастройку();
			ОбработкаФормыПослеПримененияНастройки(ОтчетОбъект, ФормаОтчета, Истина);
			ФормаОтчета.Модифицированность = Истина;
			
		ИначеЕсли Найти(Источник.КлючУникальности, "ОтборПо") <> 0 тогда
			
			Индекс = Число(Прав(Источник.КлючУникальности, СтрДлина(Источник.КлючУникальности)-7));
			СтрокаТаблицыЗначений = ФормаОтчета.ЭлементыФормы["ДинамическийОтбор" + Индекс + "ТабличноеПоле"].Значение.Добавить();
			СтрокаТаблицыЗначений.Значение = ЗначениеВыбора;
			ОбновитьИзмененияТабличногоПоля(ФормаОтчета.ЭлементыФормы, Индекс);
			
		КонецЕсли;
		
	КонецПроцедуры
	
	Процедура ОбработкаНачалаВыбораОтчета(ОтчетОбъект, Элемент, СтандартнаяОбработка) Экспорт
		
		СписокОтчетов = ПолучитьСписокТиповыхОтчетов();
		ВыбранныйЭлемент = СписокОтчетов.ВыбратьЭлемент("Выберете отчет");
		Если ВыбранныйЭлемент <> Неопределено Тогда
			Элемент.Значение = ВыбранныйЭлемент.Значение;
		КонецЕсли;
		
	КонецПроцедуры
	
	Процедура ПриНажатииКнопкиВверхВниз(ФормаОтчета, ОтчетОбъект, Кнопка) Экспорт
		ЭлементыФормы = ФормаОтчета.ЭлементыФормы;
		Индекс = Число(Сред(Кнопка.Имя, 24, 1));
		Направление = ?(Найти(Кнопка.Имя,"Вверх") <> 0, -1, 1);
		Если Найти(Кнопка.Имя,"Строк") <> 0 тогда
			ТабличноеПоле = ЭлементыФормы.Найти("ДинамическаяГруппировка" + Индекс + "ТабличноеПолеСтрок");
		ИначеЕсли Найти(Кнопка.Имя,"Колонок") <> 0 тогда
			ТабличноеПоле = ЭлементыФормы.Найти("ДинамическаяГруппировка" + Индекс + "ТабличноеПолеКолонок");
		Иначе
			ТабличноеПоле = ЭлементыФормы.Найти("ДинамическаяГруппировка" + Индекс + "ТабличноеПоле");
		КонецЕсли;
		
		Если ТабличноеПоле <> Неопределено и ТабличноеПоле.ТекущаяСтрока <> Неопределено тогда
			ТаблицаЗначений = ТабличноеПоле.Значение;
			Если Направление + ТаблицаЗначений.Индекс(ТабличноеПоле.ТекущаяСтрока) < ТаблицаЗначений.Количество()
				И Направление + ТаблицаЗначений.Индекс(ТабличноеПоле.ТекущаяСтрока) >= 0 тогда
				ТаблицаЗначений.Сдвинуть(ТабличноеПоле.ТекущаяСтрока, Направление);
			КонецЕсли;
		КонецЕсли;
	КонецПроцедуры
	
	Процедура СохранитьНастройкиФормыОтчета(ОтчетОбъект, ЭтаФорма) Экспорт
		НастройкиФормыОтчета = Новый Структура("ПанельПользователя, ПанельВариантов");
		Если  ЭтаФорма.ЭлементыФормы.Найти("СервиснаяПанель") <> Неопределено тогда
			СервиснаяПанель                         = ЭтаФорма.ЭлементыФормы.СервиснаяПанель;
			НастройкиФормыОтчета.ПанельПользователя = СервиснаяПанель.Кнопки.Найти("ПанельПользователя") <> Неопределено И СервиснаяПанель.Кнопки.ПанельПользователя.Пометка;
			НастройкиФормыОтчета.ПанельВариантов    = СервиснаяПанель.Кнопки.Найти("ПанельВариантов") <> Неопределено И СервиснаяПанель.Кнопки.ПанельВариантов.Пометка;
		КонецЕсли;
		
		НастраиваемыйОбъект = ПолучитьИдентификаторОбъекта(ОтчетОбъект);
		Пользователь = глЗначениеПеременной("глТекущийПользователь");
		Если Найти(НастраиваемыйОбъект, "Отчет") = 0 тогда
			Возврат;
		КонецЕсли;
		
		ТЗ = "ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
		|	СохраненныеНастройки.Ссылка
		|ИЗ
		|	Справочник.СохраненныеНастройки.Пользователи КАК СохраненныеНастройкиПользователи
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.СохраненныеНастройки КАК СохраненныеНастройки
		|		ПО СохраненныеНастройкиПользователи.Ссылка = СохраненныеНастройки.Ссылка
		|ГДЕ
		|	СохраненныеНастройки.ТипНастройки = &ТипНастройки
		|	И СохраненныеНастройки.НастраиваемыйОбъект = &НастраиваемыйОбъект
		|	И СохраненныеНастройкиПользователи.Пользователь = &Пользователь";
		Запрос = Новый Запрос(ТЗ);
		Запрос.УстановитьПараметр("ТипНастройки", Перечисления.ТипыНастроек.ОбщиеНастройкиОтчетов);
		Запрос.УстановитьПараметр("НастраиваемыйОбъект", НастраиваемыйОбъект);
		Запрос.УстановитьПараметр("Пользователь", Пользователь);
		
		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() тогда
			НастройкиФормы = Выборка.Ссылка.ПолучитьОбъект();
		Иначе
			НовыйЭлемент                     = Справочники.СохраненныеНастройки.СоздатьЭлемент();
			НовыйЭлемент.Наименование        = "Настройки формы отчета";
			НовыйЭлемент.НастраиваемыйОбъект = НастраиваемыйОбъект;
			//НовыйЭлемент.Владелец            = Пользователь;
			НовыйЭлемент.ТипНастройки        = Перечисления.ТипыНастроек.ОбщиеНастройкиОтчетов;
			НовыйПользователь                = НовыйЭлемент.Пользователи.Добавить();
			НовыйПользователь.Пользователь   = глЗначениеПеременной("глТекущийПользователь");
			НовыйПользователь.ПравоИзменения = Истина;
			НовыйЭлемент.Записать();
			НастройкиФормы = НовыйЭлемент;
		КонецЕсли;
		НастройкиФормы.ХранилищеНастроек = Новый ХранилищеЗначения(НастройкиФормыОтчета);
		НастройкиФормы.Записать();
		
		СохранитьПараметрыТабличногоДокумента(ЭтаФорма.ЭлементыФормы.Результат, ОтчетОбъект.СохраненнаяНастройка);
		
	КонецПроцедуры
	
	Процедура ВосстановитьНастройкиФормыОтчета(ЭтотОбъект, ЭтаФорма) Экспорт
		НастраиваемыйОбъект = ПолучитьИдентификаторОбъекта(ЭтотОбъект);
		Пользователь = глЗначениеПеременной("глТекущийПользователь");
		Если Найти(НастраиваемыйОбъект, "Отчет") = 0 тогда
			Возврат;
		КонецЕсли;
		Если ЭтаФорма.ЭтоОтработкаРасшифровки тогда
			возврат;
		КонецЕсли;
		ТЗ = "ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
		|	СохраненныеНастройки.Ссылка
		|ИЗ
		|	Справочник.СохраненныеНастройки.Пользователи КАК СохраненныеНастройкиПользователи
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.СохраненныеНастройки КАК СохраненныеНастройки
		|		ПО СохраненныеНастройкиПользователи.Ссылка = СохраненныеНастройки.Ссылка
		|ГДЕ
		|	СохраненныеНастройки.ТипНастройки = &ТипНастройки
		|	И СохраненныеНастройки.НастраиваемыйОбъект = &НастраиваемыйОбъект
		|	И СохраненныеНастройкиПользователи.Пользователь = &Пользователь";
		Запрос = Новый Запрос(ТЗ);
		Запрос.УстановитьПараметр("ТипНастройки", Перечисления.ТипыНастроек.ОбщиеНастройкиОтчетов);
		Запрос.УстановитьПараметр("НастраиваемыйОбъект", НастраиваемыйОбъект);
		Запрос.УстановитьПараметр("Пользователь", Пользователь);
		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() тогда
			НастройкиФормы = Выборка.Ссылка.ПолучитьОбъект();
			НастройкиФормыОтчета = НастройкиФормы.ХранилищеНастроек.Получить();
			Если НастройкиФормыОтчета <> Неопределено тогда
				Если ЭтаФорма.ЭлементыФормы.Найти("СервиснаяПанель") <> Неопределено тогда
					СервиснаяПанель = ЭтаФорма.ЭлементыФормы.СервиснаяПанель;
					Если СервиснаяПанель.Кнопки.Найти("ПанельПользователя") <> Неопределено тогда
						СервиснаяПанель.Кнопки.ПанельПользователя.Пометка = НастройкиФормыОтчета.ПанельПользователя;
					КонецЕсли;
					Если СервиснаяПанель.Кнопки.Найти("ПанельВариантов") <> Неопределено тогда
						СервиснаяПанель.Кнопки.ПанельВариантов.Пометка = НастройкиФормыОтчета.ПанельВариантов
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецПроцедуры
	
	// Возвращает картинку представления элемента отчета
	Функция ПолучитьКартинкуПредставленияЭлементаОтчета(ПредставлениеЭлементаОтчета) Экспорт
		
		Если ПредставлениеЭлементаОтчета = Перечисления.ПредставленияЭлементовОтчетов.Таблица Тогда
			Возврат  БиблиотекаКартинок.Таблица;
		ИначеЕсли ПредставлениеЭлементаОтчета = Перечисления.ПредставленияЭлементовОтчетов.КроссТаблица Тогда
			Возврат  БиблиотекаКартинок.КроссТаблица;
		ИначеЕсли ПредставлениеЭлементаОтчета = Перечисления.ПредставленияЭлементовОтчетов.Диаграмма Тогда
			Возврат БиблиотекаКартинок.Диаграмма;
		КонецЕсли;
		
	КонецФункции
	
	// Открывает форму настройки периода
	Функция НастроитьПериод(НастройкаПериода, НачалоПериода, КонецПериода) Экспорт
		
		НастройкаПериода.ВариантНастройки = ВариантНастройкиПериода.Период;
		НастройкаПериода.УстановитьПериод(НачалоПериода, ?(КонецПериода='0001-01-01', КонецПериода, КонецДня(КонецПериода)));
		НастройкаПериода.РедактироватьКакИнтервал = ложь;
		НастройкаПериода.РедактироватьКакПериод = Истина;
		Если НастройкаПериода.Редактировать() Тогда
			НачалоПериода = НастройкаПериода.ПолучитьДатуНачала();
			КонецПериода = НастройкаПериода.ПолучитьДатуОкончания();
			Возврат НастройкаПериода;
		КонецЕсли;
		
	КонецФункции
	
	Функция ПолучитьПоследнийИспользуемыйВариант(Ссылка)
		
		Значение = ВосстановитьЗначение("ПоследниеИспользованныеНастройкиПользователя");
		Если Значение = Неопределено ИЛИ Значение[Ссылка] = Неопределено Тогда
			Возврат Справочники.СохраненныеНастройки.ПустаяСсылка();
		Иначе
			Возврат Значение[Ссылка];
		КонецЕсли;
		
	КонецФункции
	
	Процедура СохранитьПоследнююИспользуемуюНастройку(ОтчетОбъект) Экспорт
		
		Значение = ВосстановитьЗначение("ПоследниеИспользованныеНастройкиПользователя");
		Если Значение = Неопределено ИЛИ ТипЗнч(Значение) <> Тип("Соответствие") Тогда
			Значение = Новый Соответствие;
		КонецЕсли;
		
		Значение[ПолучитьИдентификаторОбъекта(ОтчетОбъект)] = ОтчетОбъект.СохраненнаяНастройка;
		СохранитьЗначение("ПоследниеИспользованныеНастройкиПользователя", Значение);
		
	КонецПроцедуры
	
	Процедура ПроверитьЗначенияПараметров(ЗначенияНастроек, ПараметрыПанели, Отказ) Экспорт
		
		Отказ = ложь;
		Если ЗначенияНастроек.Свойство("ДинамическиеПараметры") И ПараметрыПанели.Свойство("Параметры") тогда
			Если ПараметрыПанели.Параметры.Колонки.Найти("Заполнено") <> Неопределено тогда
				СтрокиПарамтеровДляПроверки = ПараметрыПанели.Параметры.НайтиСтроки(Новый Структура("Заполнено", истина));
				Если СтрокиПарамтеровДляПроверки.Количество() > 0 тогда
					СтрокаПредупреждения = "Не заполнен(а)";
					Для каждого СтрокаПараметра Из СтрокиПарамтеровДляПроверки Цикл
						ЗначениеПараметра = ЗначенияНастроек.ДинамическиеПараметры[СтрокаПараметра.Параметр];
						Если ЗначениеПараметра = Неопределено или (Не ЗначениеЗаполнено(ЗначениеПараметра.Значение) И ЗначениеПараметра.Значение <> 0) ИЛИ Не ЗначениеПараметра.Использование Тогда
							СтрокаПредупреждения = СтрокаПредупреждения + " " + СтрокаПараметра.ПараметрНазвание;
							Отказ = истина;
						КонецЕсли;
					КонецЦикла;
					Если Отказ тогда
						СтрокаПредупреждения = СтрокаПредупреждения + "!";
						Предупреждение(СтрокаПредупреждения);
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
	КонецПроцедуры
	
	Функция ПолучитьЗначенияНастроекПанелиПользователя(ОтчетОбъект, ФормаОтчета) Экспорт

	ПараметрыИсполненияОтчета = Неопределено;
	ПараметрыИсполненияОтчета = ОтчетОбъект.ПолучитьПараметрыИсполненияОтчета();
	
	ЭлементыФормы = ФормаОтчета.ЭлементыФормы;
	ЗначенияНастроек = Новый Структура;
	
	Если ФормаОтчета.ЭлементыФормы.КоманднаяПанельДействияСОтчетом.Кнопки.Найти("Заголовок") <> Неопределено тогда
		Пометка = ФормаОтчета.ЭлементыФормы.КоманднаяПанельДействияСОтчетом.Кнопки.Заголовок.Пометка;
	Иначе
		Пометка = ложь;
	КонецЕсли;
	ЗначенияНастроек.Вставить("ВыводитьЗаголовокОтчета", Пометка);
	ЗначенияНастроек.Вставить("ФормироватьПриОткрытии", Ложь);
	
	//ДинамическиеОтборы
	ЗначенияНастроек.Вставить("ДинамическиеОтборы", ПолучитьСтруктуруДинамическихОтборов(ПолучитьПараметрыПанелиПользователяОбъекта(ОтчетОбъект), ЭлементыФормы));
	ЗначенияНастроек.Вставить("ДинамическиеПараметры", ПолучитьСтруктуруДинамическихПараметров(ПолучитьПараметрыПанелиПользователяОбъекта(ОтчетОбъект), ЭлементыФормы));
	ЗначенияНастроек.Вставить("ДинамическиеГруппировки", ПолучитьСтруктуруДинамическихГруппировок(ПолучитьПараметрыПанелиПользователяОбъекта(ОтчетОбъект), ЭлементыФормы));
	
	ЗначенияНастроек.Вставить("НастройкиКомпоновщика", ФормаОтчета.КомпоновщикНастроекПользователя.ПолучитьНастройки());
	
	ДополнительныеНастройкиОтчета = Новый Массив;
	ПараметрыИсполненияОтчета = ОтчетОбъект.ПолучитьПараметрыИсполненияОтчета();
	Если ПараметрыИсполненияОтчета.Свойство("ДополнительныеНастройкиОтчета") И ПараметрыИсполненияОтчета.ДополнительныеНастройкиОтчета тогда
		ДополнительныеНастройкиОтчета = ОтчетОбъект.ПолучитьДополнительныеНастройкиОтчета();
	КонецЕсли;
	
	Для каждого ДопНастройка из ДополнительныеНастройкиОтчета Цикл
		Если ЭлементыФормы.Найти(ДопНастройка.Имя) <>  Неопределено тогда
			ЗначенияНастроек.Вставить(ДопНастройка.Имя, ЭлементыФормы[ДопНастройка.Имя].Значение);
		Иначе
			ЗначенияНастроек.Вставить(ДопНастройка.Имя, ложь);
		КонецЕсли;
	КонецЦИкла;
	
	
	// Запомним видимость страниц компоновки чтобы при загрузке значений знать,
	// брать из значений по умолчанию или из запомненных значений
	ВидимостьСтраниц = Новый Соответствие;
	ВидимостьСтраниц.Вставить("Параметры", ЭлементыФормы.ПанельЗакладок.Страницы.Параметры.Видимость);
	ВидимостьСтраниц.Вставить("Отбор", ЭлементыФормы.ПанельЗакладок.Страницы.Отбор.Видимость);
	ВидимостьСтраниц.Вставить("Порядок", ЭлементыФормы.ПанельЗакладок.Страницы.Порядок.Видимость);
	Если ЭлементыФормы.ПанельЗакладок.Страницы.Найти("Показатели") <> Неопределено тогда
		ВидимостьСтраниц.Вставить("Показатели", ЭлементыФормы.ПанельЗакладок.Страницы.Показатели.Видимость);
		ЗначенияНастроек.Вставить("Показатели", ПолучитьСтруктуруПоказателей(ЭлементыФормы));
	КонецЕсли;
	
	ЗначенияНастроек.Вставить("ВидимостьСтраниц", ВидимостьСтраниц);
	
	// Стандартный период
	ЗначенияНастроек.Вставить("СтандартныйПериод", ФормаОтчета.СтандартныйПериод);
	
	// Стандартная дата начала
	ЗначенияНастроек.Вставить("СтандартнаяДатаНачала", ФормаОтчета.СтандартнаяДатаНачала);
	
	ТиповыеОтчетыПереопределяемый.ДополнитьЗначенияНастроекПанелиПользователя(ЗначенияНастроек, ОтчетОбъект, ФормаОтчета);
	
	Если ПараметрыИсполненияОтчета <> Неопределено И ПараметрыИсполненияОтчета.Свойство("ПриПолучениеНастроекПользователя") И ПараметрыИсполненияОтчета.ПриПолучениеНастроекПользователя тогда
		ФормаОтчета.ПриПолучениеНастроекПользователя(ЗначенияНастроек);
	КонецЕсли;
	
	
	Возврат ЗначенияНастроек;
	
КонецФункции

	
#КонецЕсли


Функция ДобавитьРодителей(ЭлементРасшифровки, ТекущийОтчет, МассивПолейРасшифровки, ВключатьРесурсы = Ложь)  Экспорт
	
	Если ТипЗнч(ЭлементРасшифровки) = Тип("ЭлементРасшифровкиКомпоновкиДанныхПоля") Тогда
		Для каждого Поле Из ЭлементРасшифровки.ПолучитьПоля() Цикл
			ДоступноеПоле = ПолучитьДоступноеПолеПоПолюКомпоновкиДанных(Новый ПолеКомпоновкиДанных(Поле.Поле), ТекущийОтчет);
			Если ДоступноеПоле = Неопределено Тогда
				Продолжить;
			КонецЕсли;
			Если Не ВключатьРесурсы И ДоступноеПоле.Ресурс Тогда
				Продолжить;
			КонецЕсли;
			МассивПолейРасшифровки.Добавить(Поле);
		КонецЦикла;
	КонецЕсли;
	Для каждого Родитель Из ЭлементРасшифровки.ПолучитьРодителей() Цикл
		ДобавитьРодителей(Родитель, ТекущийОтчет, МассивПолейРасшифровки, ВключатьРесурсы);
	КонецЦикла;
	
КонецФункции

// Возвращает массив, по которому следует расшифровать отчет
Функция ПолучитьМассивПолейРасшифровки(Расшифровка, ДанныеРасшифровки, ТекущийОтчет = Неопределено, ВключатьРесурсы = Ложь) Экспорт
	
	МассивПолейРасшифровки = Новый Массив;
	
	Если ТипЗнч(Расшифровка) <> Тип("ИдентификаторРасшифровкиКомпоновкиДанных") 
		И ТипЗнч(Расшифровка) <> Тип("ДанныеРасшифровкиКомпоновкиДанных") Тогда
		Возврат МассивПолейРасшифровки;
	КонецЕсли;
	
	Если ТекущийОтчет = Неопределено Тогда
		ТекущийОтчет = ДанныеРасшифровки;
	КонецЕсли;
	
	// Добавим поля родительских группировок
	ДобавитьРодителей(ДанныеРасшифровки.Элементы[Расшифровка], ТекущийОтчет, МассивПолейРасшифровки, ВключатьРесурсы);
	
	Количество = МассивПолейРасшифровки.Количество();
	Для Индекс = 1 По Количество Цикл
		ОбратныйИндекс = Количество - Индекс;
		Для ИндексВнутри = 0 По ОбратныйИндекс - 1 Цикл
			Если МассивПолейРасшифровки[ОбратныйИндекс].Поле = МассивПолейРасшифровки[ИндексВнутри].Поле Тогда
				МассивПолейРасшифровки.Удалить(ОбратныйИндекс);
				Прервать;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	// Добавим отбор, установленный в отчете
	Для каждого ЭлементОтбора Из ТекущийОтчет.Настройки.Отбор.Элементы Цикл
		Если Не ЭлементОтбора.Использование Тогда
			Продолжить;
		КонецЕсли;
		МассивПолейРасшифровки.Добавить(ЭлементОтбора);
	КонецЦикла;
	
	Возврат МассивПолейРасшифровки;
	
КонецФункции


// Копирует настройки компоновки данных из одного компоновщика настроек в другой
Процедура СкопироватьНастройкиКомпоновкиДанных(НастройкиПриемник, НастройкиИсточник) Экспорт
	
	Если НастройкиИсточник = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если ТипЗнч(НастройкиПриемник) = Тип("НастройкиКомпоновкиДанных") Тогда
		Для каждого Параметр Из НастройкиИсточник.ПараметрыДанных.Элементы Цикл
			ЗначениеПараметра = НастройкиПриемник.ПараметрыДанных.НайтиЗначениеПараметра(Параметр.Параметр);
			Если ЗначениеПараметра <> Неопределено Тогда
				ЗаполнитьЗначенияСвойств(ЗначениеПараметра, Параметр);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	Если ТипЗнч(НастройкиИсточник) = Тип("НастройкиВложенногоОбъектаКомпоновкиДанных") Тогда
		ЗаполнитьЗначенияСвойств(НастройкиПриемник, НастройкиИсточник);
		СкопироватьНастройкиКомпоновкиДанных(НастройкиПриемник.Настройки, НастройкиИсточник.Настройки);
		Возврат;
	КонецЕсли;
	
	// Копирование настроек
	Если ТипЗнч(НастройкиИсточник) = Тип("НастройкиКомпоновкиДанных") Тогда
		
		ЗаполнитьЭлементы(НастройкиПриемник.ПараметрыДанных, НастройкиИсточник.ПараметрыДанных);
		СкопироватьЭлементы(НастройкиПриемник.ПользовательскиеПоля, НастройкиИсточник.ПользовательскиеПоля);
		СкопироватьЭлементы(НастройкиПриемник.Отбор,         НастройкиИсточник.Отбор);
		СкопироватьЭлементы(НастройкиПриемник.Порядок,       НастройкиИсточник.Порядок);
		
	КонецЕсли;
	
	Если ТипЗнч(НастройкиИсточник) = Тип("ГруппировкаКомпоновкиДанных")
		ИЛИ ТипЗнч(НастройкиИсточник) = Тип("ГруппировкаТаблицыКомпоновкиДанных")
		ИЛИ ТипЗнч(НастройкиИсточник) = Тип("ГруппировкаДиаграммыКомпоновкиДанных") Тогда
		
		СкопироватьЭлементы(НастройкиПриемник.ПоляГруппировки, НастройкиИсточник.ПоляГруппировки);
		СкопироватьЭлементы(НастройкиПриемник.Отбор,           НастройкиИсточник.Отбор);
		СкопироватьЭлементы(НастройкиПриемник.Порядок,         НастройкиИсточник.Порядок);
		ЗаполнитьЗначенияСвойств(НастройкиПриемник, НастройкиИсточник);
		
	КонецЕсли;
	
	СкопироватьЭлементы(НастройкиПриемник.Выбор,              НастройкиИсточник.Выбор);
	СкопироватьЭлементы(НастройкиПриемник.УсловноеОформление, НастройкиИсточник.УсловноеОформление);
	ЗаполнитьЭлементы(НастройкиПриемник.ПараметрыВывода,      НастройкиИсточник.ПараметрыВывода);
	
	// Копирование структуры
	Если ТипЗнч(НастройкиИсточник) = Тип("НастройкиКомпоновкиДанных")
		ИЛИ ТипЗнч(НастройкиИсточник) = Тип("ГруппировкаКомпоновкиДанных") Тогда
		
		Для каждого ЭлементСтруктурыИсточник Из НастройкиИсточник.Структура Цикл
			ЭлементСтруктурыПриемник = НастройкиПриемник.Структура.Добавить(ТипЗнч(ЭлементСтруктурыИсточник));
			СкопироватьНастройкиКомпоновкиДанных(ЭлементСтруктурыПриемник, ЭлементСтруктурыИсточник);
		КонецЦикла;
		
	КонецЕсли;
	
	Если ТипЗнч(НастройкиИсточник) = Тип("ГруппировкаТаблицыКомпоновкиДанных")
		ИЛИ ТипЗнч(НастройкиИсточник) = Тип("ГруппировкаДиаграммыКомпоновкиДанных") Тогда
		
		Для каждого ЭлементСтруктурыИсточник Из НастройкиИсточник.Структура Цикл
			ЭлементСтруктурыПриемник = НастройкиПриемник.Структура.Добавить();
			СкопироватьНастройкиКомпоновкиДанных(ЭлементСтруктурыПриемник, ЭлементСтруктурыИсточник);
		КонецЦикла;
		
	КонецЕсли;
	
	Если ТипЗнч(НастройкиИсточник) = Тип("ТаблицаКомпоновкиДанных") Тогда
		
		Для каждого ЭлементСтруктурыИсточник Из НастройкиИсточник.Строки Цикл
			ЭлементСтруктурыПриемник = НастройкиПриемник.Строки.Добавить();
			СкопироватьНастройкиКомпоновкиДанных(ЭлементСтруктурыПриемник, ЭлементСтруктурыИсточник);
		КонецЦикла;
		
		Для каждого ЭлементСтруктурыИсточник Из НастройкиИсточник.Колонки Цикл
			ЭлементСтруктурыПриемник = НастройкиПриемник.Колонки.Добавить();
			СкопироватьНастройкиКомпоновкиДанных(ЭлементСтруктурыПриемник, ЭлементСтруктурыИсточник);
		КонецЦикла;
		
	КонецЕсли;
	
	Если ТипЗнч(НастройкиИсточник) = Тип("ДиаграммаКомпоновкиДанных") Тогда
		
		Для каждого ЭлементСтруктурыИсточник Из НастройкиИсточник.Серии Цикл
			ЭлементСтруктурыПриемник = НастройкиПриемник.Серии.Добавить();
			СкопироватьНастройкиКомпоновкиДанных(ЭлементСтруктурыПриемник, ЭлементСтруктурыИсточник);
		КонецЦикла;
		
		Для каждого ЭлементСтруктурыИсточник Из НастройкиИсточник.Точки Цикл
			ЭлементСтруктурыПриемник = НастройкиПриемник.Точки.Добавить();
			СкопироватьНастройкиКомпоновкиДанных(ЭлементСтруктурыПриемник, ЭлементСтруктурыИсточник);
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры

// Заменяет цвета в диаграмме
Процедура ЗаменитьЦветаВДиаграмме(Диаграмма, ТаблицаЦветовСерий) Экспорт
	
	Серии = Диаграмма.Серии;
	
	Для каждого Серия Из Серии Цикл
		
		СтруктураПоиска = Новый Структура("Текст", Серия.Текст);
		МассивЦветовСерий = ТаблицаЦветовСерий.НайтиСтроки(СтруктураПоиска);
		
		Если МассивЦветовСерий.Количество() > 0 Тогда
			Серия.Цвет = МассивЦветовСерий[0].Цвет;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры


// Удаляет недоступные элементы отбора из компоновщика
Процедура УдалитьНедоступныеПоляИзОтбора(КомпоновщикНастроек) Экспорт
	
	Количество = КомпоновщикНастроек.Настройки.Отбор.Элементы.Количество();
	Для Индекс = 1 По Количество Цикл
		ЭлементОтбора = КомпоновщикНастроек.Настройки.Отбор.Элементы[Количество - Индекс];
		ПолеОтбора = ЭлементОтбора.ЛевоеЗначение;
		Если КомпоновщикНастроек.Настройки.Отбор.ДоступныеПоляОтбора.НайтиПоле(ПолеОтбора) = Неопределено Тогда
			КомпоновщикНастроек.Настройки.Отбор.Элементы.Удалить(ЭлементОтбора);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

// Возвращает компоновщик настроек по схеме компоновки и настройкам компоновщика
Функция ПолучитьКомпоновщикПоСхемеИНастройкам(Схема, Настройки = Неопределено) Экспорт
	
	КомпоновщикНастроек = Новый КомпоновщикНастроекКомпоновкиДанных;
	КомпоновщикНастроек.Инициализировать(Новый ИсточникДоступныхНастроекКомпоновкиДанных(Схема));
	Если Настройки <> Неопределено Тогда
		КомпоновщикНастроек.ЗагрузитьНастройки(Настройки);
	КонецЕсли;
	Возврат КомпоновщикНастроек;
	
КонецФункции

// Добавляет в группировку автовыбранное поле
Функция ДобавитьАвтоВыбранноеПоле(Структура) Экспорт
	
	ВыбранноеПоле = Структура.Выбор.Элементы.Добавить(Тип("АвтоВыбранноеПолеКомпоновкиДанных"));
	Возврат ВыбранноеПоле;
	
КонецФункции

// Добавляет в группировку автоэлемент порядка
Процедура ДобавитьАвтоЭлементПорядка(Строка) Экспорт
	
	ПолеПолеПорядок = Строка.Порядок.Элементы.Добавить(Тип("АвтоЭлементПорядкаКомпоновкиДанных"));
	
КонецПроцедуры

// Возвращает представление по типу элемента структуры
Функция ПолучитьПредставлениеПоЭлементуСтруктуры(ЭлементСтруктуры) Экспорт
	
	Если ТипЗнч(ЭлементСтруктуры) = Тип("ГруппировкаКомпоновкиДанных") Тогда
		Возврат Перечисления.ПредставленияЭлементовОтчетов.Таблица;
	ИначеЕсли ТипЗнч(ЭлементСтруктуры) = Тип("ТаблицаКомпоновкиДанных") Тогда
		Возврат Перечисления.ПредставленияЭлементовОтчетов.КроссТаблица;
	ИначеЕсли ТипЗнч(ЭлементСтруктуры) = Тип("ДиаграммаКомпоновкиДанных") Тогда
		Возврат Перечисления.ПредставленияЭлементовОтчетов.Диаграмма;
	КонецЕсли;
	
КонецФункции

// Возвращает тип элемента структуры по представлению
Функция ПолучитьТипЭлементаПоПредставлению(Представление) Экспорт
	
	Если Представление = Перечисления.ПредставленияЭлементовОтчетов.Таблица Тогда
		Возврат Тип("ГруппировкаКомпоновкиДанных")
	ИначеЕсли Представление = Перечисления.ПредставленияЭлементовОтчетов.КроссТаблица Тогда
		Возврат Тип("ТаблицаКомпоновкиДанных")
	ИначеЕсли Представление = Перечисления.ПредставленияЭлементовОтчетов.Диаграмма Тогда
		Возврат Тип("ДиаграммаКомпоновкиДанных")
	КонецЕсли;
	
КонецФункции


/////////////////////////////////////////////////////////////////////////////////
// ОбЩИЕ ПРОЦЕДУРЫ ОТЧЕТОВ

// Выводит заголовок типового отчета в табличный документ
Процедура ВыводЗаголовкаТиповогоОтчета(ОтчетОбъект, Результат, ВыводВФормуОтчета = Истина) Экспорт
	
	ТипРезультата = ТипЗнч(Результат);
	Если ТипРезультата <> Тип("ТабличныйДокумент") 
		И ТипРезультата <> Тип("ПолеТабличногоДокумента") Тогда
		
		Возврат;
	КонецЕсли; 
	
	ПараметрыИсполненияОтчета = Неопределено;
	ПараметрыИсполненияОтчета = ОтчетОбъект.ПолучитьПараметрыИсполненияОтчета();
	
	Если ЭтоСтараяВерсияОтчета(ОтчетОбъект) Тогда
		ЗначениеПараметра = ОтчетОбъект.КомпоновщикНастроек.Настройки.ПараметрыВывода.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("TitleOutput"));
		ВыводитьЗаголовок = (ЗначениеПараметра.Значение = ТипВыводаТекстаКомпоновкиДанных.Выводить И ЗначениеПараметра.Использование);
		Если Не ВыводВФормуОтчета И Не ВыводитьЗаголовок Тогда
			Возврат;
		КонецЕсли;
		МакетЗаголовок = ПолучитьОбщийМакет("ЗаголовокТиповогоОтчета");
		ОбластьЗаголовок = МакетЗаголовок.ПолучитьОбласть("Заголовок");
		ЗаголовокОтчета = ОтчетОбъект.КомпоновщикНастроек.Настройки.ПараметрыВывода.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("Title")).Значение;
		ОбластьЗаголовок.Параметры.ЗаголовокОтчета = ЗаголовокОтчета;
		ОбластьЗаголовок.Параметры.ОписаниеНастроекОтчета = ПолучитьОписаниеНастроекОтчета(ОтчетОбъект.КомпоновщикНастроек);
		Результат.Вывести(ОбластьЗаголовок);
	Иначе
		ЗначенияНастроек = ПолучитьЗначенияНастроекПанелиПользователяОбъекта(ОтчетОбъект);
		ВыводитьЗаголовокОтчета = Истина;
		Если ЗначенияНастроек = Неопределено
			ИЛИ Не ЗначенияНастроек.Свойство("ВыводитьЗаголовокОтчета", ВыводитьЗаголовокОтчета) Тогда
			ВыводитьЗаголовок = Истина;	
		Иначе
			ВыводитьЗаголовок = ВыводитьЗаголовокОтчета;
		КонецЕсли;
		
		Если Не ВыводВФормуОтчета И Не ВыводитьЗаголовок Тогда
			Возврат;
		КонецЕсли;
		МакетЗаголовок = ПолучитьОбщийМакет("ЗаголовокТиповогоОтчета");
		ОбластьЗаголовок = МакетЗаголовок.ПолучитьОбласть("Заголовок");
		ЗначениеПараметра = ОтчетОбъект.КомпоновщикНастроек.Настройки.ПараметрыВывода.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("Title"));
		ЗаголовокОтчета = ЗначениеПараметра.Значение;
		Если ПустаяСтрока(ЗаголовокОтчета) Тогда
			ЗаголовокОтчета = ПолучитьЗаголовокОтчета(ОтчетОбъект);
		КонецЕсли;
		ОбластьЗаголовок.Параметры.ЗаголовокОтчета = ЗаголовокОтчета;
		ОбластьЗаголовок.Параметры.ОписаниеНастроекОтчета = ПолучитьОписаниеНастроекОтчета(ОтчетОбъект.КомпоновщикНастроек);
		Если ПараметрыИсполненияОтчета <> Неопределено И ПараметрыИсполненияОтчета.Свойство("ПриВыводеЗаголовкаОтчета") И ПараметрыИсполненияОтчета.ПриВыводеЗаголовкаОтчета тогда
			ОтчетОбъект.ПриВыводеЗаголовкаОтчета(ОбластьЗаголовок);
		КонецЕсли;
		Результат.Вывести(ОбластьЗаголовок);
	КонецЕсли;
	
КонецПроцедуры

Функция ПолучитьОписаниеНастроекОтчета(КомпоновщикНастроек)
	
	Если КомпоновщикНастроек.Настройки.Структура.Количество() = 0 Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	// Период
	ЗначениеПараметраПериод = КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("Период"));
	ЗначениеПараметраНачалоПериода = КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("НачалоПериода"));
	ЗначениеПараметраКонецПериода = КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("КонецПериода"));
	
	Если ЗначениеПараметраНачалоПериода <> Неопределено 
		И ЗначениеПараметраКонецПериода <> Неопределено Тогда
		
		НачалоПериода = ?(ТипЗнч(ЗначениеПараметраНачалоПериода.Значение) = Тип("СтандартнаяДатаНачала") или ТипЗнч(ЗначениеПараметраНачалоПериода.Значение) = Тип("Дата"), Дата(ЗначениеПараметраНачалоПериода.Значение), '00010101');
		КонецПериода = ?(ТипЗнч(ЗначениеПараметраКонецПериода.Значение) = Тип("СтандартнаяДатаНачала") или ТипЗнч(ЗначениеПараметраКонецПериода.Значение) = Тип("Дата"), Дата(ЗначениеПараметраКонецПериода.Значение), '00010101');
		Если НачалоПериода = '00010101' И КонецПериода = '00010101' Тогда
			ОписаниеПериода = НСтр("ru='Период не установлен'");
		ИначеЕсли НачалоПериода = '00010101' ИЛИ КонецПериода = '00010101' Тогда
			ОписаниеПериода = Формат(НачалоПериода, "ДФ = дд.ММ.гггг; ДП = ...") + " - " + Формат(КонецПериода, "ДФ = дд.ММ.гггг; ДП = ...");
		ИначеЕсли НачалоПериода <= КонецПериода Тогда
			ОписаниеПериода = ПредставлениеПериода(НачалоДня(НачалоПериода), КонецДня(КонецПериода), "ФП = Истина");
		Иначе
			ОписаниеПериода = НСтр("ru='Неправильно задан период!'");
		КонецЕсли;
	ИначеЕсли ЗначениеПараметраПериод <> Неопределено Тогда
		Период = ?(ТипЗнч(ЗначениеПараметраПериод.Значение) = Тип("СтандартнаяДатаНачала") или ТипЗнч(ЗначениеПараметраПериод.Значение) = Тип("Дата"), Дата(ЗначениеПараметраПериод.Значение), '00010101');
		Если Период = '00010101' или Период = Неопределено Тогда
			ОписаниеПериода = НСтр("ru='на '") + Формат(ТекущаяДата(), "ДП = ...");
		Иначе
			ОписаниеПериода = ?(Период = КонецДня(Период), НСтр("ru='на конец дня '"), "") + Формат(Период, "ДФ = дд.ММ.гггг; ДП = ...");
		КонецЕсли;
	Иначе
		ОписаниеПериода = "";
	КонецЕсли;
	Если Не ПустаяСтрока(ОПисаниеПериода) Тогда
		ОписаниеПериода = "Период: " + ОписаниеПериода + Символы.ПС;
	КонецЕсли;
	
	ЭлементОтчета = КомпоновщикНастроек.Настройки.Структура[0];
	ПредставлениеЭлементаОтчета = ПолучитьПредставлениеПоЭлементуСтруктуры(ЭлементОтчета);
	Если ПредставлениеЭлементаОтчета = Перечисления.ПредставленияЭлементовОтчетов.Таблица Тогда
		Строки = ПолучитьМассивГруппировок(ЭлементОтчета, КомпоновщикНастроек);
		ТипСтрок = "Группировки строк";
	ИначеЕсли ПредставлениеЭлементаОтчета = Перечисления.ПредставленияЭлементовОтчетов.КроссТаблица Тогда
		Если ЭлементОтчета.Строки.Количество() > 0 Тогда
			Строки = ПолучитьМассивГруппировок(ЭлементОтчета.Строки[0], КомпоновщикНастроек);
		Иначе
			Строки = Новый Массив;
		КонецЕсли;
		ТипСтрок = "Группировки строк";
		Если ЭлементОтчета.Колонки.Количество() > 0 Тогда
			Колонки = ПолучитьМассивГруппировок(ЭлементОтчета.Колонки[0], КомпоновщикНастроек); 
		Иначе
			Колонки = Новый Массив;
		КонецЕсли;
		ТипКолонок = "Группировки колонок";
	ИначеЕсли ПредставлениеЭлементаОтчета = Перечисления.ПредставленияЭлементовОтчетов.Диаграмма Тогда
		Если ЭлементОтчета.Серии.Количество() > 0 Тогда
			Строки = ПолучитьМассивГруппировок(ЭлементОтчета.Серии[0], КомпоновщикНастроек);
		Иначе
			Строки = Новый Массив;
		КонецЕсли;
		ТипСтрок = "Группировки серий";
		Если ЭлементОтчета.Точки.Количество() > 0 Тогда
			Колонки = ПолучитьМассивГруппировок(ЭлементОтчета.Точки[0], КомпоновщикНастроек); 
		Иначе
			Колонки = Новый Массив;
		КонецЕсли;
		ТипКолонок = "Группировки точек";
	КонецЕсли;
	
	Показатели = ПолучитьПоказатели(КомпоновщикНастроек);
	ДополнительныеПоля = ПолучитьДополнительныеПоля(КомпоновщикНастроек);
	
	СтрокаОтбор = Строка(КомпоновщикНастроек.Настройки.Отбор);
	ОписаниеНастроекОтчета = 
	ОписаниеПериода +
	СформироватьСтрокуПолей(ТипСтрок, Строки) + 
	СформироватьСтрокуПолей(ТипКолонок, Колонки) + 
	СформироватьСтрокуПолей("Дополнительные поля", ДополнительныеПоля) +
	СформироватьСтрокуПолей("Показатели", Показатели) +
	?(ПустаяСтрока(СтрокаОтбор) , "", "Отбор: " + СтрокаОтбор);
	
	Возврат ОписаниеНастроекОтчета;		
	
КонецФункции

Функция СформироватьСтрокуПолей(ТипПолей, МассивПолей)
	
	Если МассивПолей = Неопределено ИЛИ МассивПолей.Количество() = 0 Тогда
		Возврат "";
	КонецЕсли;
	
	СтрокаПолей = ТипПолей + ": ";
	Для каждого Поле Из МассивПолей Цикл
		СтрокаПолей = СтрокаПолей + Поле + "; ";
	КонецЦикла;
	
	СтрокаПолей = СтрокаПолей + Символы.ПС;     	
	
	Возврат СтрокаПолей;
	
КонецФункции

Функция ПолучитьПоказатели(КомпоновщикНастроек)
	
	Элементы = Новый Массив;
	ВыбранныеПоля = ПолучитьВыбранныеПоля(КомпоновщикНастроек);
	
	Для каждого ВыбранноеПоле Из ВыбранныеПоля Цикл
		Если НЕ ВыбранноеПоле.Использование тогда
			Продолжить;
		КонецЕсли;
		ДоступноеПоле = ПолучитьДоступноеПоле(ВыбранноеПоле.Поле, КомпоновщикНастроек.Настройки.Выбор.ДоступныеПоляВыбора);
		Если ДоступноеПоле <> Неопределено и ДоступноеПоле.Ресурс Тогда
			Элементы.Добавить(ДоступноеПоле.Заголовок);
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат Элементы;
	
КонецФункции

Функция ПолучитьДополнительныеПоля(КомпоновщикНастроек)
	
	Элементы = Новый Массив;
	ВыбранныеПоля = ПолучитьВыбранныеПоля(КомпоновщикНастроек);
	
	Для каждого ВыбранноеПоле Из ВыбранныеПоля Цикл
		Если НЕ ВыбранноеПоле.Использование тогда
			Продолжить;
		КонецЕсли;
		ДоступноеПоле = ПолучитьДоступноеПоле(ВыбранноеПоле.Поле, КомпоновщикНастроек.Настройки.Выбор.ДоступныеПоляВыбора);
		Если ДоступноеПоле <> Неопределено И Не ДоступноеПоле.Ресурс Тогда
			Элементы.Добавить(ДоступноеПоле.Заголовок);
		КонецЕсли;
	КонецЦикла;
	
	Возврат Элементы;
	
КонецФункции

Функция ПолучитьДоступноеПоле(Знач Поле, ОбластьПоиска) Экспорт
	
	Возврат ОбластьПоиска.НайтиПоле(Поле);
	
КонецФункции

// Возвращает массив группировок компоновщика настроек
Функция ПолучитьМассивГруппировок(ЭлементСтруктуры, КомпоновщикНастроек, МассивГруппировок = Неопределено) Экспорт
	
	
	Если МассивГруппировок = Неопределено Тогда
		МассивГруппировок = Новый Массив;
	КонецЕсли;
	
	Если ТипЗнч(ЭлементСтруктуры) <> Тип("ГруппировкаКомпоновкиДанных") 
		и ТипЗнч(ЭлементСтруктуры) <> Тип("ГруппировкаТаблицыКомпоновкиДанных") 
		и ТипЗнч(ЭлементСтруктуры) <> Тип("ГруппировкаДиаграммыКомпоновкиДанных") тогда
		Возврат МассивГруппировок;
	КонецЕсли;
	
	Для каждого ПолеГруппировки Из ЭлементСтруктуры.ПоляГруппировки.Элементы Цикл
		Если Не ПолеГруппировки.Использование Тогда
			Продолжить;
		КонецЕсли;
		Если ТипЗнч(ПолеГруппировки) = Тип("АвтоПолеГруппировкиКомпоновкиДанных") тогда
			Продолжить;
		КонецЕсли;
		ДоступноеПоле = ПолучитьДоступноеПоле(ПолеГруппировки.Поле, КомпоновщикНастроек.Настройки.ДоступныеПоляГруппировок);
		Если ДоступноеПоле = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		МассивГруппировок.Добавить(ДоступноеПоле.Заголовок);
	КонецЦикла;
	
	Если ЭлементСтруктуры.Структура.Количество() = 0 Тогда
		Возврат МассивГруппировок;
	Иначе
		Возврат ПолучитьМассивГруппировок(ЭлементСтруктуры.Структура[0], КомпоновщикНастроек, МассивГруппировок);
	КонецЕсли;
	
КонецФункции

// Выводит типовой отчет в табличный документ
Процедура ВывестиТиповойОтчет(ОтчетОбъект, Результат, ДанныеРасшифровки, ВыводВФормуОтчета = Истина, ВнешниеНаборыДанных = Неопределено, ВыводитьШапкуОтчетаНаВсехСтраницах = истина)
	
	ПараметрыИсполненияОтчета = Неопределено;
	
	ПараметрыИсполненияОтчета = ОтчетОбъект.ПолучитьПараметрыИсполненияОтчета();
	ОтчетОбъект.КомпоновщикНастроек.Восстановить();
	Схема = ПолучитьСхемуКомпоновкиОбъекта(ОтчетОбъект);
	
	Если ВыводВФормуОтчета тогда
	
		Попытка
			УниверсальныйМеханизмФормированияОтчета(ОтчетОбъект, Схема, ПараметрыИсполненияОтчета, Результат, ДанныеРасшифровки, ВыводВФормуОтчета, ВнешниеНаборыДанных, ВыводитьШапкуОтчетаНаВсехСтраницах);
		Исключение
			#Если ТолстыйКлиентОбычноеПриложение тогда
				Предупреждение("Отчет не сформирован!" + Символы.ПС + ПолучитьОписаниеРодительскойПричиныИнформацииОбОшибке(ИнформацияОбОшибке()));
			#КонецЕсли
		КонецПопытки;
		
	Иначе
		
		УниверсальныйМеханизмФормированияОтчета(ОтчетОбъект, Схема, ПараметрыИсполненияОтчета, Результат, ДанныеРасшифровки, ВыводВФормуОтчета, ВнешниеНаборыДанных, ВыводитьШапкуОтчетаНаВсехСтраницах);
		
	КонецЕсли;
	
КонецПроцедуры

Процедура УниверсальныйМеханизмФормированияОтчета(ОтчетОбъект, Схема, ПараметрыИсполненияОтчета, Результат, ДанныеРасшифровки, ВыводВФормуОтчета, ВнешниеНаборыДанных, ВыводитьШапкуОтчетаНаВсехСтраницах)
	
	//Сгенерируем макет компоновки данных при помощи компоновщика макета
	КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;
	
	ТипРезультата = ТипЗнч(Результат);
	Если ТипРезультата = Тип("ТабличныйДокумент") 
		ИЛИ ТипРезультата = Тип("ПолеТабличногоДокумента") Тогда
		
		ВыводВТабличныйДокумент = Истина;
		
	Иначе
		ВыводВТабличныйДокумент = Ложь;
	КонецЕсли; 
	
	//В качестве схемы компоновки будет выступать схема самого отчета
	//В качестве настроек отчета - текущие настройки отчета
	//Данные расшифровки будем помещать в ДанныеРасшифровки
	Если ВыводВФормуОтчета Тогда
		МакетКомпоновки = КомпоновщикМакета.Выполнить(Схема, ОтчетОбъект.КомпоновщикНастроек.Настройки, ДанныеРасшифровки);
		ДополнитьМакетыМакетаКомпоновкиРасшифровкойРесурсов(МакетКомпоновки, ОтчетОбъект.КомпоновщикНастроек);
		
		//Создадим и инициализируем процессор компоновки
		ПроцессорКомпоновки = Новый ПроцессорКомпоновкиДанных;
		Если ПараметрыИсполненияОтчета <> Неопределено И ПараметрыИсполненияОтчета.Свойство("ИспользоватьСобытияПриФормированииОтчета") И ПараметрыИсполненияОтчета.ИспользоватьСобытияПриФормированииОтчета тогда
			ОтчетОбъект.ПередВыводомОтчета(МакетКомпоновки, ПроцессорКомпоновки);
		КонецЕсли;
		Если ВнешниеНаборыДанных = Неопределено Тогда
			ПроцессорКомпоновки.Инициализировать(МакетКомпоновки, , ДанныеРасшифровки, Истина);
		Иначе
			ПроцессорКомпоновки.Инициализировать(МакетКомпоновки, ВнешниеНаборыДанных, ДанныеРасшифровки, Истина);
		КонецЕсли;
	Иначе
		Если ВыводВТабличныйДокумент Тогда
			МакетКомпоновки = КомпоновщикМакета.Выполнить(Схема, ОтчетОбъект.КомпоновщикНастроек.Настройки);
		Иначе
			МакетКомпоновки = КомпоновщикМакета.Выполнить(Схема, ОтчетОбъект.КомпоновщикНастроек.Настройки,,, Тип("ГенераторМакетаКомпоновкиДанныхДляКоллекцииЗначений"));
		КонецЕсли; 
		
		//Создадим и инициализируем процессор компоновки
		ПроцессорКомпоновки = Новый ПроцессорКомпоновкиДанных;
		Если ПараметрыИсполненияОтчета <> Неопределено И ПараметрыИсполненияОтчета.Свойство("ИспользоватьСобытияПриФормированииОтчета") И ПараметрыИсполненияОтчета.ИспользоватьСобытияПриФормированииОтчета тогда
			ОтчетОбъект.ПередВыводомОтчета(МакетКомпоновки, ПроцессорКомпоновки);
		КонецЕсли;
		Если ВнешниеНаборыДанных = Неопределено Тогда
			ПроцессорКомпоновки.Инициализировать(МакетКомпоновки, , , Истина);
		Иначе
			ПроцессорКомпоновки.Инициализировать(МакетКомпоновки, ВнешниеНаборыДанных, , Истина);
		КонецЕсли;
	КонецЕсли;
	
	//Создадим и инициализируем процессор вывода результата
	Если ВыводВТабличныйДокумент Тогда
		ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент;
		ПроцессорВывода.УстановитьДокумент(Результат);
	Иначе
		ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВКоллекциюЗначений;
		ПроцессорВывода.УстановитьОбъект(Результат);
	КонецЕсли; 
	
	//Обозначим начало вывода
	ПроцессорВывода.НачатьВывод();
	#Если ТолстыйКлиентОбычноеПриложение тогда
		Состояние(НСТР("ru='Если Вы хотите прервать вывод отчета, нажмите Ctrl+Break'"));
	#КонецЕсли
	
	ТаблицаЗафиксирована = Не ВыводВФормуОтчета;
	
	Если ВыводВТабличныйДокумент Тогда
		Результат.ФиксацияСверху = 0;
	КонецЕсли; 
	
	//определим нужна ли фиксация в отчете. Если элементов структуры больше 2-х
	
	КолВоВключеныхЭлементов = 0;
	Для каждого ЭлементСтруктуры из ОтчетОбъект.КомпоновщикНастроек.Настройки.Структура Цикл
		Если ЭлементСтруктуры.Использование тогда 
			КолВоВключеныхЭлементов = КолВоВключеныхЭлементов + 1;
		КонецЕсли;
		
		Если КолВоВключеныхЭлементов > 1 тогда
			ТаблицаЗафиксирована = истина;
		КонецЕсли;
	КонецЦикла;
	
	//Основной цикл вывода отчета
	Пока Истина Цикл
		
		#Если ТолстыйКлиентОбычноеПриложение тогда
			ОбработкаПрерыванияПользователя();
		#КонецЕсли
		//Получим следующий элемент результата компоновки
		ЭлементРезультата = ПроцессорКомпоновки.Следующий();
		
		Если ЭлементРезультата = Неопределено Тогда
			//Следующий элемент не получен - заканчиваем цикл вывода
			Прервать;
			
		Иначе
			
			Если ВыводВТабличныйДокумент Тогда
				// Зафиксируем шапку
				Если Не (ОтчетОбъект.РасширеннаяНастройка И ПараметрыИсполненияОтчета <> Неопределено 
					И ПараметрыИсполненияОтчета.Свойство("ПриВыводеЗаголовкаОтчета") 
					И Не ПараметрыИсполненияОтчета.ПриВыводеЗаголовкаОтчета)  
					И Не ТаблицаЗафиксирована 
					И ЭлементРезультата.ЗначенияПараметров.Количество() > 0 
					И ТипЗнч(ОтчетОбъект.КомпоновщикНастроек.Настройки.Структура[0]) <> Тип("ДиаграммаКомпоновкиДанных") Тогда
					
					ТаблицаЗафиксирована = Истина;
					Результат.ФиксацияСверху = Результат.ВысотаТаблицы;
					Если ВыводитьШапкуОтчетаНаВсехСтраницах тогда
						ОбластьШапки = Результат.Область(3, ,Результат.ВысотаТаблицы, );
						Результат.ПовторятьПриПечатиСтроки = ОбластьШапки;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
			
			Если ПараметрыИсполненияОтчета <> Неопределено И ПараметрыИсполненияОтчета.Свойство("ИспользоватьСобытияПриФормированииОтчета") И ПараметрыИсполненияОтчета.ИспользоватьСобытияПриФормированииОтчета тогда
				ОтчетОбъект.ПередВыводомЭлементРезультата(МакетКомпоновки, ПроцессорКомпоновки, ЭлементРезультата);
			КонецЕсли;
			
			//Элемент получен - выведем его при помощи процессора вывода
			ПроцессорВывода.ВывестиЭлемент(ЭлементРезультата);
			
		КонецЕсли;
		
	КонецЦикла;
	
	//Обозначем завершение вывода
	ПроцессорВывода.ЗакончитьВывод();
	
КонецПроцедуры

Функция ПолучитьОписаниеРодительскойПричиныИнформацииОбОшибке(ИнформацияОбОшибке) Экспорт
	
	Пока ИнформацияОбОшибке.Причина <> Неопределено Цикл
		ИнформацияОбОшибке = ИнформацияОбОшибке.Причина;
	КонецЦикла;
	Возврат ИнформацияОбОшибке.Описание;
	
КонецФункции

// Дорабатывает отчет перед выводом
Процедура ДоработатьТиповойОтчетПередВыводом(ОтчетОбъект, КомпоновщикНастроек = Неопределено) Экспорт
	
	Если КомпоновщикНастроек = Неопределено тогда
		КомпоновщикНастроек = ОтчетОбъект.КомпоновщикНастроек;
	КонецЕсли;
	
	// Отработка "Отрицательное красным"
	Если ОтчетОбъект.ОтрицательноеКрасным И Не ОтчетОбъект.РасширеннаяНастройка Тогда
		НовыйЭлемент = КомпоновщикНастроек.Настройки.УсловноеОформление.Элементы.Добавить();
		// Настройка оформления
		ЗначениеПараметра = НовыйЭлемент.Оформление.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("MarkNegatives"));
		ЗначениеПараметра.Использование = Истина;
		ЗначениеПараметра.Значение = Истина;
	КонецЕсли;
	
	Если Не ОтчетОбъект.РасширеннаяНастройка Тогда
		// Убрать вывод заголовка, т.к. он выводится нестандартно
		УстановитьПараметрВывода(КомпоновщикНастроек, "TitleOutput", ТипВыводаТекстаКомпоновкиДанных.НеВыводить);
	КонецЕсли;
	
КонецПроцедуры


Процедура УстановитьГруппировку(КомпоновщикНастроек, ЗначенияНастроек)
	МассивПервыхЭлементовСтруктуры = Новый Массив;
	НайтиПервыеЭлементыСтруктуры(ЗначенияНастроек.Значение.ИмяГруппировки, КомпоновщикНастроек.Настройки.Структура, МассивПервыхЭлементовСтруктуры);
	Для каждого ПервыйЭлементСтруктуры из МассивПервыхЭлементовСтруктуры Цикл
		Если ТипЗнч(ПервыйЭлементСтруктуры.Элемент) <> Тип("ТаблицаКомпоновкиДанных") И ТипЗнч(ПервыйЭлементСтруктуры.Элемент) <> Тип("ДиаграммаКомпоновкиДанных") тогда
			ПоследнийЭлемент = ПоследниеЭлементыСтруктуры(ПервыйЭлементСтруктуры.Элемент);
			МассивСохраненныхЭлементов = Новый Массив;
			Если ПоследнийЭлемент <> Неопределено тогда
				Для каждого ЭлементСтруктуры из ПоследнийЭлемент.Родитель.Структура Цикл
					МассивСохраненныхЭлементов.Добавить(ЭлементСтруктуры);
				КонецЦикла;
			КонецЕсли;
			Родитель = ПервыйЭлементСтруктуры.Элемент.Родитель;
			Строки = истина;
			Если ТипЗнч(Родитель) = Тип("ТаблицаКомпоновкиДанных") тогда
				Строки =  ?(Родитель.Строки.Индекс(ПервыйЭлементСтруктуры.Элемент) >= 0, истина, ложь);
				Если Строки тогда
					Родитель.Строки.Удалить(ПервыйЭлементСтруктуры.Элемент);
				Иначе
					Родитель.Строки.Удалить(ПервыйЭлементСтруктуры.Элемент);
				КонецЕсли;
			ИначеЕсли ТипЗнч(Родитель) = Тип("ДиаграммаКомпоновкиДанных") тогда
				Строки =  ?(Родитель.Точки.Индекс(ПервыйЭлементСтруктуры.Элемент) >= 0, истина, ложь);
				Если Строки тогда
					Родитель.Точки.Удалить(ПервыйЭлементСтруктуры.Элемент);
				Иначе
					Родитель.Серии.Удалить(ПервыйЭлементСтруктуры.Элемент);
				КонецЕсли;
			Иначе
				Родитель.Структура.Удалить(ПервыйЭлементСтруктуры.Элемент);
			КонецЕсли;
			ДобавитьГруппировкиПользователя(Родитель, ЗначенияНастроек.Значение.СписокГруппировки, Строки, МассивСохраненныхЭлементов);
		ИначеЕсли ТипЗнч(ПервыйЭлементСтруктуры.Элемент) = Тип("ТаблицаКомпоновкиДанных") тогда
			ПоследнийЭлемент = ПервыйЭлементСтруктуры;
			ПоследнийЭлемент.Элемент.Строки.Очистить();
			ПоследнийЭлемент.Элемент.Колонки.Очистить();
			ДобавитьГруппировкиПользователя(ПоследнийЭлемент.Элемент, ЗначенияНастроек.Значение.СписокГруппировкиСтрок, истина);
			ДобавитьГруппировкиПользователя(ПоследнийЭлемент.Элемент, ЗначенияНастроек.Значение.СписокГруппировкиКолонок, ложь);
		ИначеЕсли ТипЗнч(ПервыйЭлементСтруктуры.Элемент) = Тип("ДиаграммаКомпоновкиДанных") тогда
			ПоследнийЭлемент = ПервыйЭлементСтруктуры;
			ПоследнийЭлемент.Элемент.Точки.Очистить();
			ПоследнийЭлемент.Элемент.Серии.Очистить();
			ДобавитьГруппировкиПользователя(ПоследнийЭлемент.Элемент, ЗначенияНастроек.Значение.СписокГруппировкиСтрок, истина);
			ДобавитьГруппировкиПользователя(ПоследнийЭлемент.Элемент, ЗначенияНастроек.Значение.СписокГруппировкиКолонок, ложь);
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

Процедура ДобавитьГруппировкиПользователя(Структура, СписокГруппировки, Строки, МассивСохраненныхЭлементов = Неопределено)
	
	Элемент = Неопределено;
	Если ТипЗнч(Структура) = Тип("ТаблицаКомпоновкиДанных") ИЛИ ТипЗнч(Структура) = Тип("ГруппировкаТаблицыКомпоновкиДанных") тогда
		ТипГруппировки = Тип("ГруппировкаТаблицыКомпоновкиДанных");
		Если Строки тогда
			Элемент = Структура.Строки;
		Иначе
			Элемент = Структура.Колонки;
		КонецЕсли;
	ИначеЕсли ТипЗнч(Структура) = Тип("ДиаграммаКомпоновкиДанных") ИЛИ ТипЗнч(Структура) = Тип("ГруппировкаДиаграммыКомпоновкиДанных")  тогда
		ТипГруппировки = Тип("ГруппировкаДиаграммыКомпоновкиДанных");
		Если Строки тогда
			Элемент = Структура.Точки;
		Иначе
			Элемент = Структура.Серии;
		КонецЕсли;
	Иначе
		ТипГруппировки = Тип("ГруппировкаКомпоновкиДанных");
		Элемент = Структура.Структура;
	КонецЕсли;
	
	Для каждого СтрокаГруппировки из СписокГруппировки Цикл
		Если НЕ СтрокаГруппировки.Использование И Не СтрокаГруппировки.ИспользованиеИерархии тогда
			Продолжить;
		КонецЕсли;
		Если ТипГруппировки = Тип("ГруппировкаКомпоновкиДанных") тогда
			Группировка = Элемент.Добавить(ТипГруппировки);
		Иначе
			Группировка = Элемент.Добавить();
		КонецЕсли;
		Для каждого Поле из СтрокаГруппировки.Значение Цикл
			ИндексПоля = СтрокаГруппировки.Значение.Индекс(Поле);
			ПолеГруппировки = Группировка.ПоляГруппировки.Элементы.Добавить(Тип("ПолеГруппировкиКомпоновкиДанных"));
			ПолеГруппировки.Поле = Новый ПолеКомпоновкиДанных(Поле.Значение);
			ПолеГруппировки.Использование = истина;
			ТипГруппировкиПоля = СтрокаГруппировки.ЗначениеИерархии.Получить(ИндексПоля);
			Если СтрокаГруппировки.ПредставлениеИерархии <> "" тогда
				Если СтрокаГруппировки.Использование и СтрокаГруппировки.ИспользованиеИерархии тогда
					ПолеГруппировки.ТипГруппировки = ТипГруппировкиКомпоновкиДанных.Иерархия;
				ИначеЕсли СтрокаГруппировки.Использование и Не СтрокаГруппировки.ИспользованиеИерархии тогда
					ПолеГруппировки.ТипГруппировки = ТипГруппировкиКомпоновкиДанных.Элементы;
				ИначеЕсли НЕ СтрокаГруппировки.Использование и СтрокаГруппировки.ИспользованиеИерархии тогда
					ПолеГруппировки.ТипГруппировки = ТипГруппировкиКомпоновкиДанных.ТолькоИерархия;
				КонецЕсли;
			Иначе	
				Если ТипГруппировкиПоля <> Неопределено тогда
					ПолеГруппировки.ТипГруппировки = ТипГруппировкиПоля.Значение;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		ВыбраноеПоле = Группировка.Выбор.Элементы.Добавить(Тип("АвтоВыбранноеПолеКомпоновкиДанных"));
		ВыбраноеПоле.Использование = истина;
		Элемент = Группировка.Структура;
	КонецЦикла;
	
	Если МассивСохраненныхЭлементов <> Неопределено тогда
		Для каждого ПоследнийЭлемент из МассивСохраненныхЭлементов Цикл
			ТипГруппировки = ТипЗнч(ПоследнийЭлемент);
			Если ТипГруппировки <> Тип("ГруппировкаТаблицыКомпоновкиДанных") и ТипГруппировки <> Тип("ГруппировкаДиаграммыКомпоновкиДанных") тогда
				Группировка = Элемент.Добавить(ТипГруппировки);
			Иначе
				Группировка = Элемент.Добавить();
			КонецЕсли;
			СкопироватьНастройкиКомпоновкиДанных(Группировка, ПоследнийЭлемент);
		КонецЦикла;
	КонецЕсли;
КонецПроцедуры

Процедура НайтиПервыеЭлементыСтруктуры(Имя, Структура, МассивГруппировок) Экспорт
	Для каждого ЭлементСтруктуры из Структура Цикл
		Если ЭлементСтруктуры.Имя = Имя тогда
			СтруктураЭлемента = Новый Структура("Элемент, Индекс", ЭлементСтруктуры, Структура.Индекс(ЭлементСтруктуры));
			МассивГруппировок.Добавить(СтруктураЭлемента);
		Иначе
			Если (ТипЗнч(ЭлементСтруктуры) = Тип("ГруппировкаКомпоновкиДанных")
				ИЛИ ТипЗнч(ЭлементСтруктуры) = Тип("ГруппировкаТаблицыКомпоновкиДанных")
				ИЛИ ТипЗнч(ЭлементСтруктуры) = Тип("ГруппировкаДиаграммыКомпоновкиДанных")) 
				И ЭлементСтруктуры.Структура.Количество() > 0 тогда
				НайтиПервыеЭлементыСтруктуры(Имя, ЭлементСтруктуры.Структура, МассивГруппировок);
			ИначеЕсли ТипЗнч(ЭлементСтруктуры) = Тип("ТаблицаКомпоновкиДанных") тогда
				НайтиПервыеЭлементыСтруктуры(Имя, ЭлементСтруктуры.Строки, МассивГруппировок);
				НайтиПервыеЭлементыСтруктуры(Имя, ЭлементСтруктуры.Колонки, МассивГруппировок);
			ИначеЕсли ТипЗнч(ЭлементСтруктуры) = Тип("ДиаграммаКомпоновкиДанных") тогда
				НайтиПервыеЭлементыСтруктуры(Имя, ЭлементСтруктуры.Серии, МассивГруппировок);
				НайтиПервыеЭлементыСтруктуры(Имя, ЭлементСтруктуры.Точки, МассивГруппировок);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

Функция ПоследниеЭлементыСтруктуры(ПервыйЭлементСтруктуры)
	ЭлементСтруктурыНовый = ПервыйЭлементСтруктуры;
	Имя = ПервыйЭлементСтруктуры.Имя;
	Пока Имя = ЭлементСтруктурыНовый.Имя Цикл
		Если ТипЗнч(ЭлементСтруктурыНовый) = Тип("ТаблицаКомпоновкиДанных") 
			ИЛИ ТипЗнч(ЭлементСтруктурыНовый) = Тип("ДиаграммаКомпоновкиДанных") тогда
			Прервать;
		КонецЕсли;
		Если ЭлементСтруктурыНовый.Структура.Количество() = 0 тогда
			ЭлементСтруктурыНовый = Неопределено;
			Прервать;
		КонецЕсли;
		ЭлементСтруктурыНовый = ЭлементСтруктурыНовый.Структура[0];
	КонецЦикла;
	Возврат ЭлементСтруктурыНовый;
КонецФункции

Процедура ОбновитьПоляВНастройкеПользователя(ВыбранныеПоляПользователя, ВыбранныеПоля)
	Если ВыбранныеПоляПользователя.Элементы.Количество() = 0 тогда
		СкопироватьЭлементы(ВыбранныеПоляПользователя, ВыбранныеПоля);
		Возврат;
	КонецЕсли;
КонецПроцедуры

Функция ЭтоДетальнаяЗапись(ДанныеРасшифровки, Расшифровка)
	
	ЭтоДетальнаяЗапись = Ложь;
	Элемент = ДанныеРасшифровки.Элементы[Расшифровка];
	Если ТипЗнч(Элемент) = Тип("ЭлементРасшифровкиКомпоновкиДанныхПоля") Тогда
		Элементы = Элемент.ПолучитьРодителей();
		ПоляВРасшифровке  = Элемент.ПолучитьПоля();
		Если Элементы.Количество() = 1 Тогда
			Элемент = Элементы[0];
			Если ТипЗнч(Элемент) = Тип("ЭлементРасшифровкиКомпоновкиДанныхГруппировка") Тогда
				ЭтоДетальнаяЗапись = Истина;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	Возврат ЭтоДетальнаяЗапись;
	
КонецФункции

Функция ЭтоВнешнийОбъект(ОтчетОбъект) Экспорт
	
	Если Метаданные.НайтиПоПолномуИмени(ОтчетОбъект.Метаданные().ПолноеИмя()) = Неопределено Тогда
		ЭтоВнешнийОтчет = Истина;
	Иначе 
		ЭтоВнешнийОтчет = Ложь;
	КонецЕсли;
	Возврат ЭтоВнешнийОтчет;
	
КонецФункции

Функция ПолучитьСписокПолейКомпоновщикаНастроек(ОтчетОбъект, КомпоновщикНастроек) Экспорт
	
	СписокПолей = Новый СписокЗначений;
	
	СписокПолейИсключений = Новый СписокЗначений;
	Если ЗначениеЗаполнено(ОтчетОбъект.СохраненнаяНастройка) тогда
		Если ТипЗнч(ОтчетОбъект.ПараметрыПанелиПользователя) = Тип("ХранилищеЗначения") тогда
			НастройкиПанели = ОтчетОбъект.ПараметрыПанелиПользователя.Получить();
			Если НастройкиПанели.Свойство("СписокИсключаемыхПолейРасшифровки") тогда
				СписокПолейИсключений = НастройкиПанели.СписокИсключаемыхПолейРасшифровки;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	ДобавитьПоля(КомпоновщикНастроек.Настройки.ДоступныеПоляГруппировок.Элементы, СписокПолей, СписокПолейИсключений);
	
	Возврат СписокПолей;
КонецФункции

Процедура ДобавитьПоля(Элементы, СписокПолей, СписокПолейИсключений)   
	
	Для каждого ДоступноеПоле из Элементы Цикл
		Если СписокПолейИсключений.НайтиПоЗначению(Строка(ДоступноеПоле.Поле)) <> Неопределено тогда
			Продолжить;
		КонецЕсли;
		Если ДоступноеПоле.Папка тогда
			ДобавитьПоля(ДоступноеПоле.Элементы, СписокПолей, СписокПолейИсключений);
		Иначе
			СписокПолей.Добавить(Строка(ДоступноеПоле.Поле));
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Процедура УдалитьИспользованныеПоляРасшифровки(СписокПолейРасшифровки, МассивПолейРасшифровки)
	
	Для каждого ПолеРасшифровки из МассивПолейРасшифровки Цикл
		Поле = Неопределено;
		Если ТипЗНч(ПолеРасшифровки) = Тип("ЗначениеПоляРасшифровкиКомпоновкиДанных") тогда
			Поле = ПолеРасшифровки.Поле
		ИначеЕсли ТипЗнч(ПолеРасшифровки) = Тип("ЭлементОтбораКомпоновкиДанных") тогда
			Поле = ПолеРасшифровки.ЛевоеЗначение;
		КонецЕсли;
		ПолеСписка = СписокПолейРасшифровки.НайтиПоЗначению(Строка(Поле));
		Если ПолеСписка <> Неопределено тогда
			СписокПолейРасшифровки.Удалить(ПолеСписка);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

// На основании отбора настраивает расшифровываемый отчет
Процедура НастроитьТиповойОтчет(ОтчетОбъект, Отбор, КомпоновщикОсновногоОтчета = Неопределено) Экспорт
	
	Если ТипЗнч(Отбор) <> Тип("Массив") Тогда
		Возврат;
	КонецЕсли;
	
	// Настройка отбора
	Для каждого ЭлементОтбора Из Отбор Цикл
		
		Если ТипЗнч(ЭлементОтбора) = Тип("ЭлементОтбораКомпоновкиДанных") Тогда
			ПолеОтбора = ЭлементОтбора.ЛевоеЗначение;
		Иначе
			ПолеОтбора = Новый ПолеКомпоновкиДанных(ЭлементОтбора.Поле);
		КонецЕсли;
		
		Если ОтчетОбъект.КомпоновщикНастроек.Настройки.ДоступныеПоляОтбора.НайтиПоле(ПолеОтбора) = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		НовыйЭлементОтбора = ОтчетОбъект.КомпоновщикНастроек.Настройки.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
		Если ТипЗнч(ЭлементОтбора) = Тип("ЭлементОтбораКомпоновкиДанных") Тогда
			ЗаполнитьЗначенияСвойств(НовыйЭлементОтбора, ЭлементОтбора);
		Иначе
			НовыйЭлементОтбора.Использование  = Истина;
			НовыйЭлементОтбора.ЛевоеЗначение  = ПолеОтбора;
			Если ЭлементОтбора.Иерархия Тогда
				Если ТипЗнч(ЭлементОтбора.Значение) = Тип("СписокЗначений") Тогда
					НовыйЭлементОтбора.ВидСравнения = ВидСравненияКомпоновкиДанных.ВСпискеПоИерархии;
				Иначе
					НовыйЭлементОтбора.ВидСравнения = ВидСравненияКомпоновкиДанных.ВИерархии;
				КонецЕсли;
			Иначе
				Если ТипЗнч(ЭлементОтбора.Значение) = Тип("СписокЗначений") Тогда
					НовыйЭлементОтбора.ВидСравнения = ВидСравненияКомпоновкиДанных.ВСписке;
				Иначе
					НовыйЭлементОтбора.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
				КонецЕсли;
			КонецЕсли;
			
			НовыйЭлементОтбора.ПравоеЗначение = ЭлементОтбора.Значение;
			
		КонецЕсли;
		
	КонецЦикла;
	
	// Настройка параметров
	Если КомпоновщикОсновногоОтчета = Неопределено Тогда
		Возврат;
	КонецЕсли;
	Для каждого ПараметрОсновногоОтчета Из КомпоновщикОсновногоОтчета.Настройки.ПараметрыДанных.Элементы Цикл
		ЗначениеПараметра = ОтчетОбъект.КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(ПараметрОсновногоОтчета.Параметр);
		Если ЗначениеПараметра <> Неопределено Тогда
			ЗначениеПараметра.Значение = ПараметрОсновногоОтчета.Значение;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

// Возвращает имя формы, с помощью которого следует редактировать пользовательское поле
Функция ПолучитьИмяФормыРедактированияПользовательскогоПоля(ПользовательскоеПоле) Экспорт
	
	Если ТипЗнч(ПользовательскоеПоле) = Тип("ПользовательскоеПолеВыражениеКомпоновкиДанных") Тогда
		Если ПолучитьВыражениеАгрегатаИтоговыхЗаписей(ПользовательскоеПоле) <> Неопределено Тогда
			ИмяФормы = "Форма" + "Формула";
			Возврат ИмяФормы;
		Иначе
			Возврат Неопределено;
		КонецЕсли;
	КонецЕсли;
	
	Если ПользовательскоеПоле.Варианты.Элементы.Количество() > 0
		И ПолучитьПараметрИзСтроки(ПользовательскоеПоле.Варианты.Элементы[0].Значение) = "ДоработкаТаблицы" Тогда
		ИмяФормы = "Форма" + ПолучитьПараметрИзСтроки(ПользовательскоеПоле.Варианты.Элементы[0].Значение, 2);
	КонецЕсли;
	Если ПользовательскоеПоле.Варианты.Элементы.Количество() > 2
		И (ПользовательскоеПоле.Варианты.Элементы[0].Значение = "1Тренд"
		ИЛИ ПользовательскоеПоле.Варианты.Элементы[0].Значение = "1Состояние") Тогда
		ИмяФормы = "ФормаИнтервал";
	ИначеЕсли ПользовательскоеПоле.Варианты.Элементы.Количество() > 1
		И ПользовательскоеПоле.Варианты.Элементы[0].Значение = "0ИГ" Тогда
		ИмяФормы = "ФормаИнтервалы";
	КонецЕсли;
	Возврат ИмяФормы;
	
КонецФункции

Функция ПолучитьВыражениеАгрегатаИтоговыхЗаписей(ПользовательскоеПоле) Экспорт
	
	ВыражениеДетальныхЗаписей = ПользовательскоеПоле.ПолучитьПредставлениеВыраженияДетальныхЗаписей();
	ВыражениеИтоговыхЗаписей = ПользовательскоеПоле.ПолучитьПредставлениеВыраженияИтоговыхЗаписей();
	ВыражениеАгрегата = СтрЗаменить(ВыражениеИтоговыхЗаписей, ВыражениеДетальныхЗаписей, "");
	ВыражениеАгрегата = СтрЗаменить(ВыражениеАгрегата, ")", "");
	Если ВыражениеАгрегата = "Сумма("
		ИЛИ ВыражениеАгрегата = "Количество(Различные "
		ИЛИ ВыражениеАгрегата = "Количество("
		ИЛИ ВыражениеАгрегата = "Максимум("
		ИЛИ ВыражениеАгрегата = "Минимум("
		ИЛИ ВыражениеАгрегата = "Среднее(" Тогда
		Возврат ВыражениеАгрегата;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

Функция ПолучитьПараметрИзСтроки(Знач Строка, НомерПараметра = 1) Экспорт
	
	Для Индекс = 1 По НомерПараметра Цикл
		ПоложениеЗапятой = Найти(Строка, ",");
		Если ПоложениеЗапятой = 0 Тогда
			ПодСтрока = Строка;
			Возврат Подстрока;
		Иначе
			ПодСтрока = Лев(Строка, ПоложениеЗапятой - 1);
		КонецЕсли;
		Строка = Сред(Строка, ПоложениеЗапятой + 1);
	КонецЦикла;
	
	Возврат ПодСтрока;
	
КонецФункции

// Возвращает список доступных для выбора ресурсов
Функция ПолучитьСписокДоступныхРесурсов(КомпоновщикНастроек, ВключаяПользовательскиеПоляВыражение = Истина, ВключаяПользовательскиеПоляВыбор = Истина) Экспорт
	
	СписокРесурсов = Новый СписокЗначений;
	ДобавитьРесурсы(СписокРесурсов, КомпоновщикНастроек.Настройки.ДоступныеПоляВыбора, КомпоновщикНастроек, ВключаяПользовательскиеПоляВыражение, ВключаяПользовательскиеПоляВыбор);
	Возврат СписокРесурсов;
	
КонецФункции

Функция ДобавитьРесурсы(СписокРесурсов, КоллекцияПолей, КомпоновщикНастроек, ВключаяПользовательскиеПоляВыражение, ВключаяПользовательскиеПоляВыбор)
	
	Для каждого ДоступноеПоле Из КоллекцияПолей.Элементы Цикл
		Если ДоступноеПоле.Ресурс Тогда
			ПользовательскоеПоле = НайтиПользовательскоеПоле(КомпоновщикНастроек, ДоступноеПоле.Поле);
			Если ПользовательскоеПоле <> Неопределено Тогда
				Если Не (ТипЗнч(ПользовательскоеПоле) = Тип("ПользовательскоеПолеВыражениеКомпоновкиДанных") И ВключаяПользовательскиеПоляВыражение
					ИЛИ ТипЗнч(ПользовательскоеПоле) = Тип("ПользовательскоеПолеВыборКомпоновкиДанных") И ВключаяПользовательскиеПоляВыбор) Тогда
					Продолжить;
				КонецЕсли;
			КонецЕсли;
			СписокРесурсов.Добавить(ДоступноеПоле.Поле, ДоступноеПоле.Заголовок);
		КонецЕсли;
		Если ДоступноеПоле.Папка Тогда
			ДобавитьРесурсы(СписокРесурсов, ДоступноеПоле, КомпоновщикНастроек, ВключаяПользовательскиеПоляВыражение, ВключаяПользовательскиеПоляВыбор);
		КонецЕсли;
	КонецЦикла;
	
КонецФункции

// Возвращает доступное поле по полю компоновки
Функция ПолучитьДоступноеПолеПоПолюКомпоновкиДанных(ПолеКомпоновкиДанных, ОбластьПоиска) Экспорт
	
	Если ТипЗнч(ПолеКомпоновкиДанных) = Тип("Строка") Тогда
		ПолеПоиска = Новый ПолеКомпоновкиДанных(ПолеКомпоновкиДанных);
	Иначе
		ПолеПоиска = ПолеКомпоновкиДанных;
	КонецЕсли;
	
	Если ТипЗнч(ОбластьПоиска) = Тип("КомпоновщикНастроекКомпоновкиДанных")
		ИЛИ ТипЗнч(ОбластьПоиска) = Тип("ДанныеРасшифровкиКомпоновкиДанных")
		ИЛИ ТипЗнч(ОбластьПоиска) = Тип("НастройкиВложенногоОбъектаКомпоновкиДанных") Тогда
		Возврат ОбластьПоиска.Настройки.ДоступныеПоляВыбора.НайтиПоле(ПолеПоиска);
	Иначе
		Возврат ОбластьПоиска.НайтиПоле(ПолеПоиска);
	КонецЕсли;
	
КонецФункции

Функция ПолучитьДоступныйПараметрПоПараметруКомпоновкиДанных(ПарамтерКомпоновкиДанных, ОбластьПоиска) Экспорт
	
	Если ТипЗнч(ПарамтерКомпоновкиДанных) = Тип("Строка") Тогда
		ПолеПоиска = Новый ПараметрКомпоновкиДанных(ПарамтерКомпоновкиДанных);
	Иначе
		ПолеПоиска = ПарамтерКомпоновкиДанных;
	КонецЕсли;
	
	Если ТипЗнч(ОбластьПоиска) = Тип("КомпоновщикНастроекКомпоновкиДанных")
		ИЛИ ТипЗнч(ОбластьПоиска) = Тип("ДанныеРасшифровкиКомпоновкиДанных")
		ИЛИ ТипЗнч(ОбластьПоиска) = Тип("НастройкиВложенногоОбъектаКомпоновкиДанных") Тогда
		Возврат ОбластьПоиска.Настройки.ДоступныеПоляПараметровДанных.НайтиПоле(ПолеПоиска);
	Иначе
		Возврат ОбластьПоиска.НайтиПараметр(ПолеПоиска);
	КонецЕсли;
	
КонецФункции


// Заполняет отбор построителя по отбору компоновщика
Процедура ЗаполнитьОтборПоОтборуКомпоновщика(Отбор, ОтборКомпоновщика) Экспорт
	
	ЗаполнитьЗначенияСвойств(Отбор, ОтборКомпоновщика, "Использование, Представление");
	
	Если ОтборКомпоновщика.ВидСравнения = ВидСравненияКомпоновкиДанных.Больше Тогда
		Отбор.ВидСравнения = ВидСравнения.Больше;
	ИначеЕсли ОтборКомпоновщика.ВидСравнения = ВидСравненияКомпоновкиДанных.БольшеИлиРавно Тогда
		Отбор.ВидСравнения = ВидСравнения.БольшеИлиРавно;
	ИначеЕсли ОтборКомпоновщика.ВидСравнения = ВидСравненияКомпоновкиДанных.ВИерархии Тогда
		Отбор.ВидСравнения = ВидСравнения.ВИерархии;
	ИначеЕсли ОтборКомпоновщика.ВидСравнения = ВидСравненияКомпоновкиДанных.ВСписке Тогда
		Отбор.ВидСравнения = ВидСравнения.ВСписке;
	ИначеЕсли ОтборКомпоновщика.ВидСравнения = ВидСравненияКомпоновкиДанных.ВСпискеПоИерархии Тогда
		Отбор.ВидСравнения = ВидСравнения.ВСпискеПоИерархии;
	ИначеЕсли ОтборКомпоновщика.ВидСравнения = ВидСравненияКомпоновкиДанных.Меньше Тогда
		Отбор.ВидСравнения = ВидСравнения.Меньше;
	ИначеЕсли ОтборКомпоновщика.ВидСравнения = ВидСравненияКомпоновкиДанных.МеньшеИлиРавно Тогда
		Отбор.ВидСравнения = ВидСравнения.МеньшеИлиРавно;
	ИначеЕсли ОтборКомпоновщика.ВидСравнения = ВидСравненияКомпоновкиДанных.НеВИерархии Тогда
		Отбор.ВидСравнения = ВидСравнения.НеВИерархии;
	ИначеЕсли ОтборКомпоновщика.ВидСравнения = ВидСравненияКомпоновкиДанных.НеВСписке Тогда
		Отбор.ВидСравнения = ВидСравнения.НеВСписке;
	ИначеЕсли ОтборКомпоновщика.ВидСравнения = ВидСравненияКомпоновкиДанных.НеВСпискеПоИерархии Тогда
		Отбор.ВидСравнения = ВидСравнения.НеВСпискеПоИерархии;
	ИначеЕсли ОтборКомпоновщика.ВидСравнения = ВидСравненияКомпоновкиДанных.НеРавно Тогда
		Отбор.ВидСравнения = ВидСравнения.НеРавно;
	ИначеЕсли ОтборКомпоновщика.ВидСравнения = ВидСравненияКомпоновкиДанных.НеСодержит Тогда
		Отбор.ВидСравнения = ВидСравнения.НеСодержит;
	ИначеЕсли ОтборКомпоновщика.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно Тогда
		Отбор.ВидСравнения = ВидСравнения.Равно;
	ИначеЕсли ОтборКомпоновщика.ВидСравнения = ВидСравненияКомпоновкиДанных.Содержит Тогда
		Отбор.ВидСравнения = ВидСравнения.Содержит;
	Иначе
		// Не нашли соответствие - не применяем отбор
		Отбор.Использование = Ложь;
		Возврат;
	КонецЕсли;
	
	Отбор.Значение = ОтборКомпоновщика.ПравоеЗначение;
	
КонецПроцедуры

// Возвращает список всех группировок компоновщика настроек
Функция ПолучитьЭлементыСтруктуры(ЭлементСтруктуры) Экспорт
	
	СписокПолей = Новый СписокЗначений;
	Если ТипЗнч(ЭлементСтруктуры) = Тип("КомпоновщикНастроекКомпоновкиДанных") тогда
		Структура = ЭлементСтруктуры.Настройки.Структура;
	Иначе
		Структура = ЭлементСтруктуры;
	КонецЕсли;
	
	ДобавитьЭлементСтруктуры(Структура, СписокПолей);
	Возврат СписокПолей;
	
КонецФункции

Процедура ДобавитьЭлементСтруктуры(Структура, СписокПолей)
	
	Для каждого ЭлементСтруктуры Из Структура Цикл
		Если ТипЗнч(ЭлементСтруктуры) = Тип("ТаблицаКомпоновкиДанных") Тогда
			СписокПолей.Добавить(ЭлементСтруктуры);
			ДобавитьЭлементСтруктуры(ЭлементСтруктуры.Строки, СписокПолей);
			ДобавитьЭлементСтруктуры(ЭлементСтруктуры.Колонки, СписокПолей);
		ИначеЕсли ТипЗнч(ЭлементСтруктуры) = Тип("ДиаграммаКомпоновкиДанных") Тогда
			СписокПолей.Добавить(ЭлементСтруктуры);
			ДобавитьЭлементСтруктуры(ЭлементСтруктуры.Точки, СписокПолей);
			ДобавитьЭлементСтруктуры(ЭлементСтруктуры.Серии, СписокПолей);
		ИначеЕсли ТипЗнч(ЭлементСтруктуры) = Тип("ГруппировкаКомпоновкиДанных") или ТипЗнч(ЭлементСтруктуры) = Тип("ГруппировкаТаблицыКомпоновкиДанных") или ТипЗнч(ЭлементСтруктуры) = Тип("ГруппировкаДиаграммыКомпоновкиДанных") тогда
			СписокПолей.Добавить(ЭлементСтруктуры);
			ДобавитьЭлементСтруктуры(ЭлементСтруктуры.Структура, СписокПолей);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры


// Возвращает список всех группировок компоновщика настроек
Функция ПолучитьГруппировки(ЭлементСтруктуры, ПоказыватьГруппировкиТаблиц = истина) Экспорт
	
	СписокПолей = Новый СписокЗначений;
	Если ТипЗнч(ЭлементСтруктуры) = Тип("КомпоновщикНастроекКомпоновкиДанных") тогда
		Структура = ЭлементСтруктуры.Настройки.Структура;
		ДобавитьГруппировки(Структура, СписокПолей);
	ИначеЕсли ТипЗнч(ЭлементСтруктуры) = Тип("ТаблицаКомпоновкиДанных") Тогда
		ДобавитьГруппировки(ЭлементСтруктуры.Строки, СписокПолей);
		ДобавитьГруппировки(ЭлементСтруктуры.Колонки, СписокПолей);
	ИначеЕсли ТипЗнч(ЭлементСтруктуры) = Тип("ДиаграммаКомпоновкиДанных") Тогда
		ДобавитьГруппировки(ЭлементСтруктуры.Серии, СписокПолей);
		ДобавитьГруппировки(ЭлементСтруктуры.Точки, СписокПолей);
	Иначе
		ДобавитьГруппировки(ЭлементСтруктуры.Структура, СписокПолей, ПоказыватьГруппировкиТаблиц);
	КонецЕсли;
	Возврат СписокПолей;
	
КонецФункции

Процедура ДобавитьГруппировки(Структура, СписокПолей, ПоказыватьГруппировкиТаблиц = истина)
	
	Для каждого ЭлементСтруктуры Из Структура Цикл
		Если ТипЗнч(ЭлементСтруктуры) = Тип("ТаблицаКомпоновкиДанных") Тогда
			ДобавитьГруппировки(ЭлементСтруктуры.Строки, СписокПолей);
			ДобавитьГруппировки(ЭлементСтруктуры.Колонки, СписокПолей);
		ИначеЕсли ТипЗнч(ЭлементСтруктуры) = Тип("ДиаграммаКомпоновкиДанных") Тогда
			ДобавитьГруппировки(ЭлементСтруктуры.Серии, СписокПолей);
			ДобавитьГруппировки(ЭлементСтруктуры.Точки, СписокПолей);
		Иначе
			СписокПолей.Добавить(ЭлементСтруктуры);
			Если ПоказыватьГруппировкиТаблиц тогда
				ДобавитьГруппировки(ЭлементСтруктуры.Структура, СписокПолей);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

// Возвращает массив полей группировок всех группировок компоновщика настроек
Функция ПолучитьМассивПолейГруппировки(КомпоновщикНастроек, БезПользовательскихПолей = Ложь) Экспорт
	
	МассивПолей = Новый Массив;
	
	Структура = КомпоновщикНастроек.Настройки.Структура;
	ДобавитьПоляГруппировкиВМассив(Структура, МассивПолей, БезПользовательскихПолей);
	Возврат МассивПолей;
	
КонецФункции

Процедура ДобавитьПоляГруппировкиВМассив(Структура, МассивПолей, БезПользовательскихПолей)
	
	Для каждого ЭлементСтруктуры Из Структура Цикл
		Если ТипЗнч(ЭлементСтруктуры) = Тип("ТаблицаКомпоновкиДанных") Тогда
			ДобавитьПоляГруппировкиВМассив(ЭлементСтруктуры.Строки, МассивПолей, БезПользовательскихПолей);
			ДобавитьПоляГруппировкиВМассив(ЭлементСтруктуры.Колонки, МассивПолей, БезПользовательскихПолей);
		ИначеЕсли ТипЗнч(ЭлементСтруктуры) = Тип("ДиаграммаКомпоновкиДанных") Тогда
			ДобавитьПоляГруппировкиВМассив(ЭлементСтруктуры.Серии, МассивПолей, БезПользовательскихПолей);
			ДобавитьПоляГруппировкиВМассив(ЭлементСтруктуры.Точки, МассивПолей, БезПользовательскихПолей);
		Иначе
			Для каждого ТекущееПолеГруппировки Из ЭлементСтруктуры.ПоляГруппировки.Элементы Цикл
				ДоступноеПоле = ЭлементСтруктуры.Выбор.ДоступныеПоляВыбора.НайтиПоле(ТекущееПолеГруппировки.Поле);
				Если ДоступноеПоле <> Неопределено 
					И (ДоступноеПоле.Родитель = Неопределено ИЛИ Не БезПользовательскихПолей ИЛИ ДоступноеПоле.Родитель.Поле <> Новый ПолеКомпоновкиДанных("UserFields") ИЛИ ДоступноеПоле.Родитель.Поле <> Новый ПолеКомпоновкиДанных("ПользовательскиеПоля")) Тогда
					МассивПолей.Добавить(ТекущееПолеГруппировки);
				КонецЕсли;
			КонецЦикла;
			ДобавитьПоляГруппировкиВМассив(ЭлементСтруктуры.Структура, МассивПолей, БезПользовательскихПолей);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

// Возвращает список полей группировок всех группировок компоновщика настроек
Функция ПолучитьПоляГруппировок(КомпоновщикНастроек, БезПользовательскихПолей = Ложь) Экспорт
	
	СписокПолей = Новый СписокЗначений;
	
	Структура = КомпоновщикНастроек.Настройки.Структура;
	ДобавитьПоляГруппировки(Структура, СписокПолей, БезПользовательскихПолей);
	Возврат СписокПолей;
	
КонецФункции

Процедура ДобавитьПоляГруппировки(Структура, СписокПолей, БезПользовательскихПолей)
	
	Для каждого ЭлементСтруктуры Из Структура Цикл
		Если ТипЗнч(ЭлементСтруктуры) = Тип("ТаблицаКомпоновкиДанных") Тогда
			ДобавитьПоляГруппировки(ЭлементСтруктуры.Строки, СписокПолей, БезПользовательскихПолей);
			ДобавитьПоляГруппировки(ЭлементСтруктуры.Колонки, СписокПолей, БезПользовательскихПолей);
		ИначеЕсли ТипЗнч(ЭлементСтруктуры) = Тип("ДиаграммаКомпоновкиДанных") Тогда
			ДобавитьПоляГруппировки(ЭлементСтруктуры.Серии, СписокПолей, БезПользовательскихПолей);
			ДобавитьПоляГруппировки(ЭлементСтруктуры.Точки, СписокПолей, БезПользовательскихПолей);
		Иначе
			Для каждого ТекущееПолеГруппировки Из ЭлементСтруктуры.ПоляГруппировки.Элементы Цикл
				ДоступноеПоле = ЭлементСтруктуры.Выбор.ДоступныеПоляВыбора.НайтиПоле(ТекущееПолеГруппировки.Поле);
				Если ДоступноеПоле <> Неопределено 
					И (ДоступноеПоле.Родитель = Неопределено ИЛИ Не БезПользовательскихПолей ИЛИ ДоступноеПоле.Родитель.Поле <> Новый ПолеКомпоновкиДанных("UserFields") ИЛИ ДоступноеПоле.Родитель.Поле <> Новый ПолеКомпоновкиДанных("ПользовательскиеПоля")) Тогда
					СписокПолей.Добавить(Строка(ДоступноеПоле.Поле), ДоступноеПоле.Заголовок);
				КонецЕсли;
			КонецЦикла;
			ДобавитьПоляГруппировки(ЭлементСтруктуры.Структура, СписокПолей, БезПользовательскихПолей);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

// Возвращает группировку по полю группировки
Функция ПолучитьЭлементСтруктурыПоПолюГруппировки(ПолеГруппировки, КомпоновщикНастроек) Экспорт
	
	Структура = КомпоновщикНастроек.Настройки.Структура;
	Возврат НайтиЭлементСтруктурыПоПолюГруппировки(Структура, ПолеГруппировки);
	
КонецФункции

Функция НайтиЭлементСтруктурыПоПолюГруппировки(Структура, ПолеГруппировки)
	
	Для каждого ЭлементСтруктуры Из Структура Цикл
		Если ТипЗнч(ЭлементСтруктуры) = Тип("ТаблицаКомпоновкиДанных") Тогда
			ЭлементСтруктуры = НайтиЭлементСтруктурыПоПолюГруппировки(ЭлементСтруктуры.Строки, ПолеГруппировки);
			Если ЭлементСтруктуры = Неопределено Тогда
				Возврат НайтиЭлементСтруктурыПоПолюГруппировки(ЭлементСтруктуры.Колонки, ПолеГруппировки);
			Иначе
				Возврат ЭлементСтруктуры;
			КонецЕсли;
		ИначеЕсли ТипЗнч(ЭлементСтруктуры) = Тип("ДиаграммаКомпоновкиДанных") Тогда
			НайденныйЭлементСтруктуры = НайтиЭлементСтруктурыПоПолюГруппировки(ЭлементСтруктуры.Серии, ПолеГруппировки);
			Если НайденныйЭлементСтруктуры = Неопределено Тогда
				Возврат НайтиЭлементСтруктурыПоПолюГруппировки(ЭлементСтруктуры.Точки, ПолеГруппировки);
			Иначе
				Возврат ЭлементСтруктуры;
			КонецЕсли;
		Иначе
			Для каждого ТекущееПолеГруппировки Из ЭлементСтруктуры.ПоляГруппировки.Элементы Цикл
				Если ПолеГруппировки = ТекущееПолеГруппировки.Поле Тогда
					Возврат ЭлементСтруктуры;
				КонецЕсли;
			КонецЦикла;
			Возврат НайтиЭлементСтруктурыПоПолюГруппировки(ЭлементСтруктуры.Структура, ПолеГруппировки);
		КонецЕсли;
	КонецЦикла;
	
КонецФункции

// Возвращает пользовательское поле по полю компоновки данных
Функция НайтиПользовательскоеПоле(КомпоновщикНастроек, ПолеКомпоновкиДанных) Экспорт
	
	Для каждого ПользовательскоеПоле Из КомпоновщикНастроек.Настройки.ПользовательскиеПоля.Элементы Цикл
		Если ПользовательскоеПоле.ПутьКДанным = Строка(ПолеКомпоновкиДанных) Тогда
			Возврат ПользовательскоеПоле;
		КонецЕсли;
	КонецЦикла;
	
КонецФункции

// Возвращает массив наборов данных - запрос в схеме компоновки данных
Функция ПолучитьНаборыДанныхЗапрос(СхемаКомпоновкиДанных, НаборыДанных = Неопределено, МассивНаборовДанных = Неопределено) Экспорт
	
	Если МассивНаборовДанных = Неопределено Тогда
		МассивНаборовДанных = Новый Массив;
	КонецЕсли;
	Если НаборыДанных = Неопределено Тогда
		НаборыДанных = СхемаКомпоновкиДанных.НаборыДанных;
	КонецЕсли;
	
	Для каждого НаборДанных Из НаборыДанных Цикл
		Если ТипЗнч(НаборДанных) = Тип("НаборДанныхЗапросСхемыКомпоновкиДанных") Тогда
			МассивНаборовДанных.Добавить(НаборДанных);
		ИначеЕсли ТипЗнч(НаборДанных) = Тип("НаборДанныхОбъединениеСхемыКомпоновкиДанных") Тогда
			ПолучитьНаборыДанныхЗапрос(СхемаКомпоновкиДанных, НаборДанных.Элементы, МассивНаборовДанных)
		КонецЕсли;
	КонецЦикла;
	Возврат МассивНаборовДанных;
	
КонецФункции


////////////////////////////////////////////////////////////
// ФУНКЦИИ ДЛЯ ПРОГРАММНОЙ НАСТРОЙКИ КОМПОНОВЩИКА НАСТРОЕК

// Устанавливает параметр данных компоновщика настроек
Функция УстановитьПараметр(КомпоновщикНастроекКоллекцияЗначений, ИмяПараметра, Значение, Использование = Истина) Экспорт
	
	Если ТипЗнч(КомпоновщикНастроекКоллекцияЗначений) = Тип("КомпоновщикНастроекКомпоновкиДанных") Тогда
		ЗначениеПараметра = КомпоновщикНастроекКоллекцияЗначений.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных(ИмяПараметра));
	ИначеЕсли ТипЗнч(КомпоновщикНастроекКоллекцияЗначений) = Тип("КоллекцияЗначенийПараметровКомпоновкиДанных") Тогда
		ЗначениеПараметра = КомпоновщикНастроекКоллекцияЗначений.Найти(ИмяПараметра);
	ИначеЕсли ТипЗнч(КомпоновщикНастроекКоллекцияЗначений) = Тип("ОформлениеКомпоновкиДанных") Тогда
		ЗначениеПараметра = КомпоновщикНастроекКоллекцияЗначений.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных(ИмяПараметра));
	КонецЕсли;
	
	Если ЗначениеПараметра = Неопределено Тогда
		Возврат Неопределено;
	Иначе
		ЗначениеПараметра.Использование = Использование;
		ЗначениеПараметра.Значение      = Значение;
		Возврат ЗначениеПараметра;
	КонецЕсли;
	
КонецФункции

// Устанавливает параметр вывода компоновщика настроек
Функция УстановитьПараметрВывода(КомпоновщикНастроекГруппировка, ИмяПараметра, Значение, Использование = Истина) Экспорт
	
	Если ТипЗнч(КомпоновщикНастроекГруппировка) = Тип("КомпоновщикНастроекКомпоновкиДанных") Тогда
		ЗначениеПараметра = КомпоновщикНастроекГруппировка.Настройки.ПараметрыВывода.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных(ИмяПараметра));
	Иначе
		ЗначениеПараметра = КомпоновщикНастроекГруппировка.ПараметрыВывода.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных(ИмяПараметра));
	КонецЕсли;
	Если ЗначениеПараметра = Неопределено Тогда
		Возврат Неопределено;
	Иначе
		ЗначениеПараметра.Использование = Использование;
		ЗначениеПараметра.Значение      = Значение;
		Возврат ЗначениеПараметра;
	КонецЕсли;
	
КонецФункции


// Удаляет отбор из компоновщика настроек, если поле не указано, очищает отбор
Функция УдалитьОтбор(КомпоновщикНастроек, Знач Поле = Неопределено) Экспорт
	Если Поле = Неопределено Тогда
		КомпоновщикНастроек.Настройки.Отбор.Элементы.Очистить();
		Возврат Истина;
	КонецЕсли;
	Если ТипЗнч(Поле) = Тип("Строка") Тогда
		Поле = Новый ПолеКомпоновкиДанных(Поле);
	КонецЕсли;
	ПолеУдалено = Ложь;
	Элементы = ПолучитьЭлементыОтбора(КомпоновщикНастроек);
	Для каждого Элемент Из Элементы Цикл
		Если Элемент.Использование И Элемент.ЛевоеЗначение = Поле Тогда
			Элемент.Использование = Ложь;
			ПолеУдалено = Истина;
		КонецЕсли;
	КонецЦикла;
	Возврат ПолеУдалено;
КонецФункции

// Удаляет указанное выбранное поле из компоновщика настроек, если поле не указано - очищает все поля
Функция УдалитьВыбранноеПоле(ЭлементСтруктуры, Знач Поле = Неопределено) Экспорт
	
	Если ТипЗнч(ЭлементСтруктуры) = Тип("КомпоновщикНастроекКомпоновкиДанных") Тогда
		ВыбранныеПоля = ЭлементСтруктуры.Настройки.Выбор;
	Иначе
		ВыбранныеПоля = ЭлементСтруктуры;
	КонецЕсли;
	
	Если Поле = Неопределено Тогда
		ВыбранныеПоля.Элементы.Очистить();
		Возврат Истина;
	КонецЕсли;
	Если ТипЗнч(Поле) = Тип("Строка") Тогда
		Поле = Новый ПолеКомпоновкиДанных(Поле);
	КонецЕсли;
	ПолеУдалено = Ложь;
	Элементы = ПолучитьВыбранныеПоля(ВыбранныеПоля);
	Для каждого Элемент Из Элементы Цикл
		Если Элемент.Использование И Элемент.Поле = Поле Тогда
			Элемент.Использование = Ложь;
			ПолеУдалено = Истина;
		КонецЕсли;
	КонецЦикла;
	Возврат ПолеУдалено;
	
КонецФункции


// Функция удаляет из компоновщика настроек указанную в параметре группировку, если параметр не указан, удаляет все группировки
Функция УдалитьГруппировку(КомпоновщикНастроек, Знач Поле = Неопределено, Строки = Истина) Экспорт
	
	Если КомпоновщикНастроек.Настройки.Структура.Количество() = 0 Тогда
		Возврат Неопределено;
	КонецЕсли;
	Элемент = КомпоновщикНастроек.Настройки.Структура[0];
	Если ТипЗнч(Элемент) = Тип("ТаблицаКомпоновкиДанных") Тогда
		Если Строки И Элемент.Строки.Количество() > 0 Тогда
			Элемент = Элемент.Строки[0];
		ИначеЕсли Не Строки И Элемент.Колонки.Количество() > 0 Тогда
			Элемент = Элемент.Колонки[0];
		Иначе
			Возврат Неопределено;
		КонецЕсли;
	ИначеЕсли ТипЗнч(Элемент) = Тип("ДиаграммаКомпоновкиДанных") Тогда
		Если Строки И Элемент.Серии.Количество() > 0 Тогда
			Элемент = Элемент.Серии[0];
		ИначеЕсли Не Строки И Элемент.Точки.Количество() > 0 Тогда
			Элемент = Элемент.Точки[0];
		Иначе
			Возврат Неопределено;
		КонецЕсли;
	КонецЕсли;
	Если Поле = Неопределено Тогда
		КомпоновщикНастроек.Настройки.Структура.Очистить();
		Возврат Неопределено;
	КонецЕсли;
	Если ТипЗнч(Поле) = Тип("Строка") Тогда
		Поле = Новый ПолеКомпоновкиДанных(Поле);
	КонецЕсли;
	Пока Истина Цикл
		Если Элемент.ПоляГруппировки.Элементы.Количество() > 0 
			И Элемент.ПоляГруппировки.Элементы[0].Поле = Поле Тогда
			Элемент.Родитель.Структура.Очистить();
			Прервать;
			Возврат Истина;
		ИначеЕсли Элемент.Структура.Количество() > 0 Тогда
			Элемент = Элемент.Структура[0];
		Иначе 
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
КонецФункции

// Возвращает массив элементов отбора или групп элементов отбора
Функция ПолучитьЭлементыОтбора(КомпоновщикНастроек, ТолькоГруппы = Ложь) Экспорт
	
	МассивПолей = Новый Массив;
	ДобавитьЭлементыОтбораВМассив(КомпоновщикНастроек.Настройки.Отбор.Элементы, МассивПолей, ТолькоГруппы);
	Возврат МассивПолей;
	
КонецФункции

Процедура ДобавитьЭлементыОтбораВМассив(Элементы, МассивПолей, ТолькоГруппы = Ложь)
	
	Для каждого Элемент Из Элементы Цикл
		Если ТипЗнч(Элемент) = Тип("ГруппаЭлементовОтбораКомпоновкиДанных") Тогда
			Если ТолькоГруппы Тогда
				МассивПолей.Добавить(Элемент);
			КонецЕсли;
			ДобавитьЭлементыОтбораВМассив(Элемент.Элементы, МассивПолей, ТолькоГруппы);
		Иначе
			Если Не ТолькоГруппы Тогда
				МассивПолей.Добавить(Элемент);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

// Возвращает массив выбранных полей или групп выбранных полей
Функция ПолучитьВыбранныеПоля(ЭлементСтруктуры, ТолькоГруппы = Ложь) Экспорт
	
	Если ТипЗнч(ЭлементСтруктуры) = Тип("КомпоновщикНастроекКомпоновкиДанных") 
		ИЛИ ТипЗнч(ЭлементСтруктуры) = Тип("НастройкиВложенногоОбъектаКомпоновкиДанных")  Тогда
		ВыбранныеПоля = ЭлементСтруктуры.Настройки.Выбор;
	Иначе
		ВыбранныеПоля = ЭлементСтруктуры;
	КонецЕсли;
	
	МассивПолей = Новый Массив;
	ДобавитьВыбранныеПоляВМассивДляПоказателей(ВыбранныеПоля.Элементы, МассивПолей, ТолькоГруппы);
	Возврат МассивПолей;
	
КонецФункции

Процедура ДобавитьВыбранныеПоляВМассивДляПоказателей(ЭлементСтруктуры, МассивПолей, ТолькоГруппы = Ложь)
	
	Если ТипЗнч(ЭлементСтруктуры) = Тип("КомпоновщикНастроекКомпоновкиДанных") Тогда
		ВыбранныеПоля = ЭлементСтруктуры.Настройки.Выбор;
	Иначе
		ВыбранныеПоля = ЭлементСтруктуры;
	КонецЕсли;
	
	Для каждого Элемент Из ЭлементСтруктуры Цикл
		Если ТипЗнч(Элемент) = Тип("АвтоВыбранноеПолеКомпоновкиДанных") Тогда
			Продолжить;
		ИначеЕсли ТипЗнч(Элемент) = Тип("ГруппаВыбранныхПолейКомпоновкиДанных") Тогда
			Если ТолькоГруппы Тогда
				МассивПолей.Добавить(Элемент);
			КонецЕсли;
			Если Элемент.Использование тогда
				ДобавитьВыбранныеПоляВМассивДляПоказателей(Элемент.Элементы, МассивПолей, ТолькоГруппы);
			КонецЕсли;
		Иначе
			Если Не ТолькоГруппы Тогда
				МассивПолей.Добавить(Элемент);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Процедура ДобавитьВыбранныеПоляВМассив(ЭлементСтруктуры, МассивПолей, ТолькоГруппы = Ложь)
	
	Если ТипЗнч(ЭлементСтруктуры) = Тип("КомпоновщикНастроекКомпоновкиДанных") Тогда
		ВыбранныеПоля = ЭлементСтруктуры.Настройки.Выбор;
	Иначе
		ВыбранныеПоля = ЭлементСтруктуры;
	КонецЕсли;
	
	Для каждого Элемент Из ЭлементСтруктуры Цикл
		Если ТипЗнч(Элемент) = Тип("АвтоВыбранноеПолеКомпоновкиДанных") Тогда
			Продолжить;
		ИначеЕсли ТипЗнч(Элемент) = Тип("ГруппаВыбранныхПолейКомпоновкиДанных") Тогда
			Если ТолькоГруппы Тогда
				МассивПолей.Добавить(Элемент);
			КонецЕсли;
			ДобавитьВыбранныеПоляВМассив(Элемент.Элементы, МассивПолей, ТолькоГруппы);
		Иначе
			Если Не ТолькоГруппы Тогда
				МассивПолей.Добавить(Элемент);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

// Функция проверяет, могут ли в отчете выводиться детальные поля
Функция ВСтруктуреМогутБытьДетальныеПоля(КомпоновщикНастроек) Экспорт
	
	ПоляГруппировки = ПолучитьМассивПолейГруппировки(КомпоновщикНастроек);
	ВыбранныеПоля = ПолучитьВыбранныеПоля(КомпоновщикНастроек);
	МогутБытьДетальныеПоля = Ложь;
	Для каждого ВыбранноеПоле Из ВыбранныеПоля Цикл
		ДоступноеПоле = ПолучитьДоступноеПолеПоПолюКомпоновкиДанных(ВыбранноеПоле.Поле, КомпоновщикНастроек);
		Если ДоступноеПоле = Неопределено ИЛИ ДоступноеПоле.Ресурс Тогда
			Продолжить;
		КонецЕсли;
		
		Если Не ВыбранноеПоле.Использование Тогда
			Продолжить;
		КонецЕсли;
		ЕстьРодитель = Ложь;
		Для каждого ПолеГруппировки Из ПоляГруппировки Цикл
			Если Не ПолеГруппировки.Использование ИЛИ ПолеГруппировки.Поле = Новый ПолеКомпоновкиДанных("") Тогда
				Продолжить;
			КонецЕсли;
			Если ПолеЯвляетсяРодителемДругого(КомпоновщикНастроек, ПолеГруппировки.Поле, ВыбранноеПоле.Поле) Тогда
				ЕстьРодитель = Истина;
			КонецЕсли;
		КонецЦикла;
		Если Не ЕстьРодитель Тогда
			Возврат Истина;
		КонецЕсли;
	КонецЦикла;
	Возврат Ложь;
	
КонецФункции

Функция ПолеЯвляетсяРодителемДругого(КомпоновщикНастроек, Поле1, Поле2)
	
	ДоступноеПоле1 = ПолучитьДоступноеПолеПоПолюКомпоновкиДанных(Поле1, КомпоновщикНастроек);
	ДоступноеПоле2 = ПолучитьДоступноеПолеПоПолюКомпоновкиДанных(Поле2, КомпоновщикНастроек);
	Если ДоступноеПоле1 = ДоступноеПоле2 Тогда
		Возврат Истина;
	КонецЕсли;
	Пока ДоступноеПоле2.Родитель <> Неопределено Цикл
		ДоступноеПоле2 = ДоступноеПоле2.Родитель;
		Если ДоступноеПоле1 = ДоступноеПоле2 Тогда
			Возврат Истина;
		КонецЕсли;
	КонецЦикла;
	Возврат Ложь;
	
КонецФункции

// Добавляет в набор данных поле набора данных
Функция ДобавитьПолеНабораДанных(НаборДанных, Поле, Заголовок, ПутьКДанным = Неопределено) Экспорт
	
	Если ПутьКДанным = Неопределено Тогда
		ПутьКДанным = Поле;
	КонецЕсли;
	
	ПолеНабораДанных = НаборДанных.Поля.Добавить(Тип("ПолеНабораДанныхСхемыКомпоновкиДанных"));
	ПолеНабораДанных.Поле        = Поле;
	ПолеНабораДанных.Заголовок   = Заголовок;
	ПолеНабораДанных.ПутьКДанным = ПутьКДанным;
	Возврат ПолеНабораДанных;
	
КонецФункции

// Добавляет в набор данных поля периода Период секунда, минута, час ....
Функция ДобавитьПоляПериодаВНаборДанных(НаборДанных) Экспорт
	
	СписокПериодов = Новый СписокЗначений;
	СписокПериодов.Добавить("ПериодСекунда",   "Период секунда");
	СписокПериодов.Добавить("ПериодМинута",    "Период минута");
	СписокПериодов.Добавить("ПериодЧас",       "Период час");
	СписокПериодов.Добавить("ПериодДень",      "Период день");
	СписокПериодов.Добавить("ПериодНеделя",    "Период неделя");
	СписокПериодов.Добавить("ПериодДекада",    "Период декада");
	СписокПериодов.Добавить("ПериодМесяц",     "Период месяц");
	СписокПериодов.Добавить("ПериодКвартал",   "Период квартал");
	СписокПериодов.Добавить("ПериодПолугодие", "Период полугодие");
	СписокПериодов.Добавить("ПериодГод",       "Период год");
	
	ИмяПапки = "Периоды";
	СписокПолейНабораДанных = Новый СписокЗначений;
	ПапкаПолейНабораДанных = НаборДанных.Поля.Добавить(Тип("ПапкаПолейНабораДанныхСхемыКомпоновкиДанных"));
	ПапкаПолейНабораДанных.Заголовок   = ИмяПапки;
	ПапкаПолейНабораДанных.ПутьКДанным = ИмяПапки;
	
	Для каждого Период Из СписокПериодов Цикл
		ПолеНабораДанных = НаборДанных.Поля.Добавить(Тип("ПолеНабораДанныхСхемыКомпоновкиДанных"));
		ПолеНабораДанных.Поле        = Период.Значение;
		ПолеНабораДанных.Заголовок   = Период.Представление;
		ПолеНабораДанных.ПутьКДанным = ИмяПапки + "." + Период.Значение;
		СписокПолейНабораДанных.Добавить(ПолеНабораДанных);
	КонецЦикла;
	
	Возврат СписокПолейНабораДанных;
	
КонецФункции

// Функция добавляет поле итога в схему компоновки данных. Если параметр Выражение не указан, используется Сумма(ПутьКДанным)
Функция ДобавитьПолеИтога(СхемаКомпоновкиДанных, ПутьКДанным, Выражение = Неопределено) Экспорт
	
	Если Выражение = Неопределено Тогда
		Выражение = "Сумма(" + ПутьКДанным + ")";
	КонецЕсли;
	
	ПолеИтога = СхемаКомпоновкиДанных.ПоляИтога.Добавить();
	ПолеИтога.ПутьКДанным = ПутьКДанным;
	ПолеИтога.Выражение = Выражение;
	Возврат ПолеИтога;
	
КонецФункции

// Функция добавляет выбранное поле в набор выбранных полей
Функция ДобавитьВыбранноеПоле(ЭлементСтруктуры, Знач Поле, Заголовок = Неопределено) Экспорт
	
	Если ТипЗнч(ЭлементСтруктуры) = Тип("КомпоновщикНастроекКомпоновкиДанных") Тогда
		ВыбранныеПоля = ЭлементСтруктуры.Настройки.Выбор;
	Иначе
		ВыбранныеПоля = ЭлементСтруктуры;
	КонецЕсли;
	
	Если ТипЗнч(Поле) = Тип("Строка") Тогда
		Поле = Новый ПолеКомпоновкиДанных(Поле);
	КонецЕсли;
	ВыбранноеПоле = ВыбранныеПоля.Элементы.Добавить(Тип("ВыбранноеПолеКомпоновкиДанных"));
	ВыбранноеПоле.Поле = Поле;
	Если Заголовок <> Неопределено Тогда
		ВыбранноеПоле.Заголовок = Заголовок;
	КонецЕсли;
	Возврат ВыбранноеПоле;
	
КонецФункции

// Функция добавляет в схему компоновки источник данных с типом "Local"
Функция ДобавитьЛокальныйИсточникДанных(СхемаКомпоновкиДанных) Экспорт
	
	ИсточникДанных = СхемаКомпоновкиДанных.ИсточникиДанных.Добавить();
	ИсточникДанных.Имя = "ИсточникДанных1";
	ИсточникДанных.ТипИсточникаДанных = "Local";
	Возврат ИсточникДанных;
	
КонецФункции

// Функция добавляет набор данных - запрос в указанную в параметре коллекцию наборов данных
Функция ДобавитьНаборДанныхЗапрос(НаборыДанных, ИсточникДанных, ИмяНабораДанных = "НаборДанных1") Экспорт
	
	НаборДанных = НаборыДанных.Добавить(Тип("НаборДанныхЗапросСхемыКомпоновкиДанных"));
	НаборДанных.Имя = ИмяНабораДанных;
	НаборДанных.ИсточникДанных = ИсточникДанных.Имя;
	Возврат НаборДанных;
	
КонецФункции

// Функция добавляет набор данных - объединение в указанную в параметре коллекцию наборов данных
Функция ДобавитьНаборДанныхОбъединение(НаборыДанных, ИсточникДанных, ИмяНабораДанных = "НаборДанных1") Экспорт
	
	НаборДанных = НаборыДанных.Добавить(Тип("НаборДанныхОбъединениеСхемыКомпоновкиДанных"));
	НаборДанных.Имя = ИмяНабораДанных;
	Возврат НаборДанных;
	
КонецФункции

Процедура ЗаполнитьПолеНабораДанныхОстаток(ПолеНабораДанных, ГруппаОстатка) Экспорт
	
	ПутьКДанным = ПолеНабораДанных.ПутьКДанным;
	
	Если Найти(ПутьКДанным, "НачальныйОстаток") > 0 ИЛИ Найти(ПутьКДанным, "КонечныйОстаток") > 0 Тогда
		ПолеНабораДанных.Роль.Остаток = Истина;
		ПолеНабораДанных.Роль.ГруппаОстатка = ГруппаОстатка;
		Если ВРег(Прав(ПутьКДанным, 2)) = "ДТ" Тогда
			ПолеНабораДанных.Роль.ТипБухгалтерскогоОстатка = ТипБухгалтерскогоОстаткаКомпоновкиДанных.Дебет
		ИначеЕсли ВРег(Прав(ПутьКДанным, 2)) = "КТ" Тогда
			ПолеНабораДанных.Роль.ТипБухгалтерскогоОстатка = ТипБухгалтерскогоОстаткаКомпоновкиДанных.Кредит
		Иначе
			ПолеНабораДанных.Роль.ТипБухгалтерскогоОстатка = ТипБухгалтерскогоОстаткаКомпоновкиДанных.Нет
		КонецЕсли;
		Если Найти(ПутьКДанным, "НачальныйОстаток") > 0 Тогда
			ПолеНабораДанных.Роль.ТипОстатка = ТипОстаткаКомпоновкиДанных.НачальныйОстаток;
		ИначеЕсли Найти(ПутьКДанным, "КонечныйОстаток") > 0 Тогда
			ПолеНабораДанных.Роль.ТипОстатка = ТипОстаткаКомпоновкиДанных.КонечныйОстаток;
		Иначе
			ПолеНабораДанных.Роль.ТипОстатка = ТипОстаткаКомпоновкиДанных.Нет;
		КонецЕсли;
	КонецЕсли;	
	
КонецПроцедуры

// Добавляет в макеты макета компоновки расшифровку для ресурсов
Процедура ДополнитьМакетыМакетаКомпоновкиРасшифровкойРесурсов(МакетКомпоновки, КомпоновщикНастроек) Экспорт
	
	Для каждого Макет Из МакетКомпоновки.Макеты Цикл
		// Получим массив параметров расшифровки
		МассивВыраженийПолей = Новый Массив;
		Для каждого Параметр Из Макет.Параметры Цикл
			Если ТипЗнч(Параметр) <> Тип("ПараметрОбластиРасшифровкаКомпоновкиДанных") Тогда
				Продолжить;
			КонецЕсли;
			Для каждого ВыражениеПоля Из Параметр.ВыраженияПолей Цикл
				Если Не ЭтоВыражениеПоляПараметраРасшифровкиРесурс(ВыражениеПоля, КомпоновщикНастроек) Тогда
					МассивВыраженийПолей.Добавить(ВыражениеПоля);
				КонецЕсли;
			КонецЦикла;
		КонецЦикла;
		// Установим параметры расшифровки у ресурсов
		Для каждого Параметр Из Макет.Параметры Цикл
			Если ТипЗнч(Параметр) <> Тип("ПараметрОбластиРасшифровкаКомпоновкиДанных") Тогда
				Продолжить;
			КонецЕсли;
			Ресурс = Ложь;
			Для каждого ВыражениеПоля Из Параметр.ВыраженияПолей Цикл
				Если ЭтоВыражениеПоляПараметраРасшифровкиРесурс(ВыражениеПоля, КомпоновщикНастроек) Тогда
					Ресурс = Истина;
					Прервать;
				КонецЕсли;
			КонецЦикла;
			Если Не Ресурс Тогда
				Продолжить;
			КонецЕсли;
			Для каждого ВыражениеПоля Из МассивВыраженийПолей Цикл
				Если Параметр.ВыраженияПолей.Найти(ВыражениеПоля.Поле) <> Неопределено Тогда
					Продолжить;
				КонецЕсли;
				НовоеВыражениеПоля = Параметр.ВыраженияПолей.Добавить();
				ЗаполнитьЗначенияСвойств(НовоеВыражениеПоля, ВыражениеПоля);
			КонецЦикла;
		КонецЦикла;
	КонецЦикла;
	
КонецПроцедуры

Функция ЭтоВыражениеПоляПараметраРасшифровкиРесурс(ВыражениеПоля, КомпоновщикНастроек)
	
	ДоступныеРесурсы = ПолучитьСписокДоступныхРесурсов(КомпоновщикНастроек);
	ДостуныйРесурс = ДоступныеРесурсы.НайтиПоЗначению(Новый ПолеКомпоновкиДанных(ВыражениеПоля.Поле));
	Возврат ДостуныйРесурс <> Неопределено;
	
КонецФункции


Функция СериализоватьОбъектXDTO(Объект) Экспорт
	
	ЗаписьXML = Новый ЗаписьXML();
	ЗаписьXML.УстановитьСтроку();
	СериализаторXDTO.ЗаписатьXML(ЗаписьXML, Объект);
	СтрокаXML = ЗаписьXML.Закрыть();
	Возврат СтрокаXML;
	
КонецФункции

Функция СериализоватьОбъект(Объект) Экспорт
	ЗаписьXML = Новый ЗаписьXML();
	ЗаписьXML.УстановитьСтроку();
	Объект2 = Объект.ПолучитьОбъект();
	ЗаписатьXML(ЗаписьXML, Объект2);
	СтрокаXML = ЗаписьXML.Закрыть();
	Возврат СтрокаXML;
КонецФункции

Функция ПрочитатьОбъектXDTO(СтрокаXML) Экспорт
	
	ЧтениеXML = Новый ЧтениеXML;
	ЧтениеXML.УстановитьСтроку(СтрокаXML);
	Объект = СериализаторXDTO.ПрочитатьXML(ЧтениеXML);
	ЧтениеXML.Закрыть();
	Возврат Объект;
	
КонецФункции

Функция ПрочитатьОбъект(СтрокаXML) Экспорт
	
	ЧтениеXML = Новый ЧтениеXML;
	ЧтениеXML.УстановитьСтроку(СтрокаXML);
	Объект = ПрочитатьXML(ЧтениеXML);
	ЧтениеXML.Закрыть();
	Возврат Объект;
	
КонецФункции

Процедура УстановитьДопустимоеЗначениеСпискаВыбора(Элемент, Значение = Неопределено)
	
	Если Значение = Неопределено Тогда
		Значение = Элемент.Значение;
	КонецЕсли;
	
	НайденноеЗначение = Элемент.СписокВыбора.НайтиПоЗначению(Значение.Вариант);
	Если НайденноеЗначение = Неопределено И Элемент.СписокВыбора.Количество() > 0 Тогда
		Значение.Вариант = Элемент.СписокВыбора[0].Значение;
		Элемент.Значение = Элемент.СписокВыбора[0].Значение;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПрименитьНастройкуПользователя(ЗначениеГруппировки, СписокГруппировки)
	Если Типзнч(СписокГруппировки) = Тип("ТаблицаЗначений") тогда
		Для каждого СтрокаЗначения из СписокГруппировки Цикл
			СоотСтрока = Неопределено;
			Для каждого СтрокаГруппировки из ЗначениеГруппировки Цикл
				ТребуемаяСтрока = истина;
				Для каждого Поле из СтрокаЗначения.Значение Цикл
					Если СтрокаГруппировки.Значение.НайтиПоЗначению(Поле.Значение) = Неопределено тогда
						ТребуемаяСтрока = ложь;
						Прервать;
					КонецЕсли;
				КонецЦикла;
				Если ТребуемаяСтрока тогда
					СоотСтрока = СтрокаГруппировки;
				КонецЕсли;
			КонецЦикла;
			Если СоотСтрока <> Неопределено тогда
				ИндексСтрокиЗначения    = СписокГруппировки.Индекс(СтрокаЗначения);
				ИндексСтрокиГруппировки = ЗначениеГруппировки.Индекс(СоотСтрока);
				Если ИндексСтрокиГруппировки <> ИндексСтрокиЗначения и ИндексСтрокиЗначения >=0 и ИндексСтрокиЗначения < ЗначениеГруппировки.Количество() тогда
					ЗначениеГруппировки.Сдвинуть(СоотСтрока, ИндексСтрокиЗначения - ИндексСтрокиГруппировки);
				КонецЕсли;
				СоотСтрока.Использование = СтрокаЗначения.Использование;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
КонецПроцедуры

// Заполняет отбор компоновщика по отбору построителя
Функция ПолучитьТаблицуДоступныхВариантов(НастраиваемыйОбъект, Пользователь = Неопределено, СПомеченнымиНаУдаление = Ложь, ТипНастройки = Неопределено, СписокДоступныхНастроек = Неопределено) Экспорт
	
	Возврат ТиповыеОтчетыПереопределяемый.ПолучитьТаблицуДоступныхВариантовПереопределяемая(НастраиваемыйОбъект, Пользователь, СПомеченнымиНаУдаление, ТипНастройки, СписокДоступныхНастроек);
	
КонецФункции

Функция ПолучитьСписокДоступныхВариантов(НастраиваемыйОбъект, Пользователь = Неопределено, СПомеченнымиНаУдаление = Ложь, ОтчетОбъект = Неопределено) Экспорт
	
	СписокНастроек = Новый СписокЗначений;
	
	Если ОтчетОбъект <> Неопределено тогда
		ПараметрыИсполненияОтчета = Неопределено;
		ПараметрыИсполненияОтчета = ОтчетОбъект.ПолучитьПараметрыИсполненияОтчета();
		
		СписокДоступныхНастроек = Неопределено;
		Если ПараметрыИсполненияОтчета <> Неопределено И ПараметрыИсполненияОтчета.Свойство("СписокДоступныхПредопределенныхНастроек") тогда
			СписокДоступныхНастроек = ПараметрыИсполненияОтчета.СписокДоступныхПредопределенныхНастроек;
		КонецЕсли;
	КонецЕсли;
	
	ТаблицаДоступныхНастроек = ПолучитьТаблицуДоступныхВариантов(НастраиваемыйОбъект, Пользователь, СПомеченнымиНаУдаление,, СписокДоступныхНастроек);
	Для каждого Строка Из ТаблицаДоступныхНастроек Цикл
		СписокНастроек.Добавить(Строка.Ссылка, Строка.Наименование, Строка.ПравоИзменения);
	КонецЦикла;
	
	Возврат СписокНастроек;
	
КонецФункции

Функция НастройкиКомпоновщикаПростые(КомпоновщикНастроек) Экспорт
	
	Если КомпоновщикНастроек.Настройки.Структура.Количество() = 1 Тогда
		Если КомпоновщикНастроек.Настройки.Структура[0].Имя <> "" тогда
			Возврат Ложь;
		КонецЕсли;
		Если ТипЗнч(КомпоновщикНастроек.Настройки.Структура[0]) = Тип("ГруппировкаКомпоновкиДанных") Тогда
			Возврат ЭтоПростаяСтруктура(КомпоновщикНастроек.Настройки.Структура[0]);
		ИначеЕсли ТипЗнч(КомпоновщикНастроек.Настройки.Структура[0]) = Тип("ТаблицаКомпоновкиДанных") Тогда
			Возврат ЭтоПростаяСтруктура(КомпоновщикНастроек.Настройки.Структура[0].Строки)
			И ЭтоПростаяСтруктура(КомпоновщикНастроек.Настройки.Структура[0].Колонки)
			И ЭтоПростаяСтруктура(КомпоновщикНастроек.Настройки.Структура[0]);
		ИначеЕсли ТипЗнч(КомпоновщикНастроек.Настройки.Структура[0]) = Тип("ДиаграммаКомпоновкиДанных") Тогда
			Возврат ЭтоПростаяСтруктура(КомпоновщикНастроек.Настройки.Структура[0].Серии)
			И ЭтоПростаяСтруктура(КомпоновщикНастроек.Настройки.Структура[0].Точки)
			И ЭтоПростаяСтруктура(КомпоновщикНастроек.Настройки.Структура[0]);
		КонецЕсли;
	ИначеЕсли КомпоновщикНастроек.Настройки.Структура.Количество() = 0 Тогда
		Возврат Истина;
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции

Функция ЭтоПростаяСтруктура(Структура)
	
	// Количество структур везде должно быть 1
	// Таблица и Диаграмма могут быть только на верхнем уровне
	НастройкиПростые = Истина;
	Если  (ТипЗнч(Структура) = Тип("ГруппировкаКомпоновкиДанных") 
		ИЛИ ТипЗнч(Структура) = Тип("ГруппировкаТаблицыКомпоновкиДанных") 
		ИЛИ ТипЗнч(Структура) = Тип("ГруппировкаДиаграммыКомпоновкиДанных"))
		И Структура.Имя <> "" тогда
		Возврат Ложь;
	КонецЕсли;
	Если ТипЗнч(Структура) = Тип("КоллекцияЭлементовСтруктурыТаблицыКомпоновкиДанных")
		ИЛИ ТипЗнч(Структура) = Тип("КоллекцияЭлементовСтруктурыДиаграммыКомпоновкиДанных") Тогда
		Если Структура.Количество() > 1
			ИЛИ (Структура.Количество() = 1 И Не ЭтоПростаяСтруктура(Структура[0])) Тогда
			Возврат Ложь;
		КонецЕсли;
	ИначеЕсли ТипЗнч(Структура) = Тип("ГруппировкаКомпоновкиДанных") 
		ИЛИ ТипЗнч(Структура) = Тип("ГруппировкаТаблицыКомпоновкиДанных") 
		ИЛИ ТипЗнч(Структура) = Тип("ГруппировкаДиаграммыКомпоновкиДанных") Тогда
		Если Структура.Структура.Количество() > 1
			ИЛИ (Структура.Структура.Количество() = 1 И Не ЭтоПростаяСтруктура(Структура.Структура[0])) Тогда
			Возврат Ложь;
		КонецЕсли;
		Если Структура.Выбор.Элементы.Количество() <> 1 ИЛИ ТипЗнч(Структура.Выбор.Элементы[0]) <> Тип("АвтоВыбранноеПолеКомпоновкиДанных")
			ИЛИ Структура.Порядок.Элементы.Количество() <> 1 ИЛИ ТипЗнч(Структура.Порядок.Элементы[0]) <> Тип("АвтоЭлементПорядкаКомпоновкиДанных")
			ИЛИ Структура.Отбор.Элементы.Количество() > 0
			ИЛИ Структура.УсловноеОформление.Элементы.Количество() > 0
			ИЛИ Структура.ПоляГруппировки.Элементы.Количество() > 1 Тогда
			Возврат Ложь;
		КонецЕсли;
		Возврат ЭтоПростаяСтруктура(Структура.ПараметрыВывода);
	ИначеЕсли ТипЗнч(Структура) = Тип("ТаблицаКомпоновкиДанных") Тогда
		Если Структура.Выбор.Элементы.Количество() <> 0
			ИЛИ Структура.УсловноеОформление.Элементы.Количество() > 0 Тогда
			Возврат Ложь;
		КонецЕсли;
		Возврат ЭтоПростаяСтруктура(Структура.ПараметрыВывода);
	ИначеЕсли ТипЗнч(Структура) = Тип("ДиаграммаКомпоновкиДанных") Тогда
		Если Структура.Выбор.Элементы.Количество() <> 1 ИЛИ ТипЗнч(Структура.Выбор.Элементы[0]) <> Тип("АвтоВыбранноеПолеКомпоновкиДанных")
			ИЛИ Структура.УсловноеОформление.Элементы.Количество() > 0 Тогда
			Возврат Ложь;
		КонецЕсли;
		Возврат ЭтоПростаяСтруктура(Структура.ПараметрыВывода);
	ИначеЕсли ТипЗнч(Структура) = Тип("ЗначенияПараметровВыводаГруппировкиКомпоновкиДанных")
		ИЛИ ТипЗнч(Структура) = Тип("ЗначенияПараметровВыводаГруппировкиТаблицыКомпоновкиДанных")
		ИЛИ ТипЗнч(Структура) = Тип("ЗначенияПараметровВыводаГруппировкиДиаграммыКомпоновкиДанных")
		ИЛИ ТипЗнч(Структура) = Тип("ЗначенияПараметровВыводаКомпоновкиДанных")
		ИЛИ ТипЗнч(Структура) = Тип("ЗначенияПараметровВыводаТаблицыКомпоновкиДанных")
		ИЛИ ТипЗнч(Структура) = Тип("ЗначенияПараметровВыводаДиаграммыКомпоновкиДанных") Тогда
		
		Для каждого Элемент Из Структура.Элементы Цикл
			Если Элемент.Использование Тогда
				Возврат Ложь;
			КонецЕсли;
			НастройкиПростые = ЭтоПростаяСтруктура(Элемент.ЗначенияВложенныхПараметров);
			Если Не НастройкиПростые Тогда
				Возврат Ложь;
			КонецЕсли;
		КонецЦикла;
	ИначеЕсли ТипЗнч(Структура) = Тип("КоллекцияЗначенийПараметровКомпоновкиДанных") Тогда
		Для каждого Элемент Из Структура Цикл
			Если Элемент.Использование Тогда
				Возврат Ложь;
			КонецЕсли;
			НастройкиПростые = ЭтоПростаяСтруктура(Элемент.ЗначенияВложенныхПараметров);
			Если Не НастройкиПростые Тогда
				Возврат Ложь;
			КонецЕсли;
		КонецЦикла;
		
	КонецЕсли;
	Возврат Истина;
	
КонецФункции

Функция ПолучитьТаблицуСтандартныхПериодов()
	
	ТаблицаСтандартныхПериодов = Новый ТаблицаЗначений;
	ТаблицаСтандартныхПериодов.Колонки.Добавить("Периодичность");
	ТаблицаСтандартныхПериодов.Колонки.Добавить("Время");
	ТаблицаСтандартныхПериодов.Колонки.Добавить("СтандартныйПериод");
	ТаблицаСтандартныхПериодов.Колонки.Добавить("Представление");
	
	// Произвольный
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "", "ПроизвольныйПериод", ВариантСтандартногоПериода.ПроизвольныйПериод, "Произвольный период");
	// День
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "День", "Предыдущий",    ВариантСтандартногоПериода.Вчера, "Вчера");
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "День", "Текущий",       ВариантСтандартногоПериода.Сегодня, " Сегодня");
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "День", "Следующий",     ВариантСтандартногоПериода.Завтра, "  Завтра");
	// Неделя
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Неделя", "Предыдущий",  ВариантСтандартногоПериода.ПрошлаяНеделя, "Предыдущая неделя");
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Неделя", "Текущий",     ВариантСтандартногоПериода.ЭтаНеделя, " Эта неделя");
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Неделя", "Следующий",   ВариантСтандартногоПериода.СледующаяНеделя, " Следующая неделя");
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Неделя", "СНачала",     ВариантСтандартногоПериода.СНачалаЭтойНедели, "С начала этой недели");
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Неделя", "ДоКонца",     ВариантСтандартногоПериода.ДоКонцаЭтойНедели, "До конца этой недели");
	// Декада
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Декада", "Предыдущий",  ВариантСтандартногоПериода.ПрошлаяДекада, "Предыдущая декада");
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Декада", "Текущий",     ВариантСтандартногоПериода.ЭтаДекада, " Эта декада");
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Декада", "Следующий",   ВариантСтандартногоПериода.СледующаяДекада, "  Следующая декада");
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Декада", "СНачала",     ВариантСтандартногоПериода.СНачалаЭтойДекады, "С начала этой декады");
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Декада", "ДоКонца",     ВариантСтандартногоПериода.ДоКонцаЭтойДекады, "До конца этой декады");
	// Месяц
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Месяц", "Предыдущий",   ВариантСтандартногоПериода.ПрошлыйМесяц, "Предыдущий месяц");
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Месяц", "Текущий",      ВариантСтандартногоПериода.ЭтотМесяц, " Этот месяц");
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Месяц", "Следующий",    ВариантСтандартногоПериода.СледующийМесяц, "  Следующий месяц");
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Месяц", "СНачала",      ВариантСтандартногоПериода.СНачалаЭтогоМесяца, "С начала этого месяца");
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Месяц", "ДоКонца",      ВариантСтандартногоПериода.ДоКонцаЭтогоМесяца, "До конца этого месяца");
	// Квартал
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Квартал", "Предыдущий", ВариантСтандартногоПериода.ПрошлыйКвартал, "Предыдущий квартал");
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Квартал", "Текущий",    ВариантСтандартногоПериода.ЭтотКвартал, " Этот квартал");
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Квартал", "Следующий",  ВариантСтандартногоПериода.СледующийКвартал, "  Следующий квартал");
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Квартал", "СНачала",    ВариантСтандартногоПериода.СНачалаЭтогоКвартала, "С начала этого квартала");
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Квартал", "ДоКонца",    ВариантСтандартногоПериода.ДоКонцаЭтогоКвартала, "До конца этого квартала");
	// Полугодие
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Полугодие", "Предыдущий", ВариантСтандартногоПериода.ПрошлоеПолугодие, "Предыдущее полугодие");
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Полугодие", "Текущий",    ВариантСтандартногоПериода.ЭтоПолугодие, " Это полугодие");
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Полугодие", "Следующий",  ВариантСтандартногоПериода.СледующееПолугодие, "  Следующее полугодие");
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Полугодие", "СНачала",    ВариантСтандартногоПериода.СНачалаЭтогоПолугодия, "С начала этого полугодия");
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Полугодие", "ДоКонца",    ВариантСтандартногоПериода.ДоКонцаЭтогоПолугодия, "До конца этого полугодия");
	// Год
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Год", "Предыдущий",     ВариантСтандартногоПериода.ПрошлыйГод, "Предыдущий год");
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Год", "Текущий",        ВариантСтандартногоПериода.ЭтотГод, " Этот год");
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Год", "Следующий",      ВариантСтандартногоПериода.СледующийГод, "  Следующий год");
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Год", "СНачала",        ВариантСтандартногоПериода.СНачалаЭтогоГода, "С начала этого года");
	ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, "Год", "ДоКонца",        ВариантСтандартногоПериода.ДоКонцаЭтогоГода, "До конца этого года");
	Возврат ТаблицаСтандартныхПериодов;
	
КонецФункции

Функция ПолучитьТаблицуСтандартныхДатНачала()
	
	ТаблицаСтандартныхПериодов = Новый ТаблицаЗначений;
	ТаблицаСтандартныхПериодов.Колонки.Добавить("Периодичность");
	ТаблицаСтандартныхПериодов.Колонки.Добавить("Время");
	ТаблицаСтандартныхПериодов.Колонки.Добавить("СтандартнаяДатаНачала");
	ТаблицаСтандартныхПериодов.Колонки.Добавить("Представление");
	
	// Произвольная
	ДобавитьСтрокуСтандартнойДатыНачала(ТаблицаСтандартныхПериодов, "", "ПроизвольнаяДата",  ВариантСтандартнойДатыНачала.ПроизвольнаяДата, "Произвольная дата");
	// День
	ДобавитьСтрокуСтандартнойДатыНачала(ТаблицаСтандартныхПериодов, "День", "Предыдущий",    ВариантСтандартнойДатыНачала.НачалоПрошлогоДня, "Начало вчерашнего дня");
	ДобавитьСтрокуСтандартнойДатыНачала(ТаблицаСтандартныхПериодов, "День", "Текущий",       ВариантСтандартнойДатыНачала.НачалоЭтогоДня, " Начало сегодняшнего дня");
	ДобавитьСтрокуСтандартнойДатыНачала(ТаблицаСтандартныхПериодов, "День", "Следующий",     ВариантСтандартнойДатыНачала.НачалоСледующегоДня, "  Начало завтрашнего дня");
	// Неделя
	ДобавитьСтрокуСтандартнойДатыНачала(ТаблицаСтандартныхПериодов, "Неделя", "Предыдущий",  ВариантСтандартнойДатыНачала.НачалоПрошлойНедели, "Начало предыдущей недели");
	ДобавитьСтрокуСтандартнойДатыНачала(ТаблицаСтандартныхПериодов, "Неделя", "Текущий",     ВариантСтандартнойДатыНачала.НачалоЭтойНедели, " Начало этой недели");
	ДобавитьСтрокуСтандартнойДатыНачала(ТаблицаСтандартныхПериодов, "Неделя", "Следующий",   ВариантСтандартнойДатыНачала.НачалоСледующейНедели, "  Начало следующей недели");
	// Декада
	ДобавитьСтрокуСтандартнойДатыНачала(ТаблицаСтандартныхПериодов, "Декада", "Предыдущий",  ВариантСтандартнойДатыНачала.НачалоПрошлойДекады, "Начало предыдущей декады");
	ДобавитьСтрокуСтандартнойДатыНачала(ТаблицаСтандартныхПериодов, "Декада", "Текущий",     ВариантСтандартнойДатыНачала.НачалоЭтогоМесяца, " Начало этой декады");
	ДобавитьСтрокуСтандартнойДатыНачала(ТаблицаСтандартныхПериодов, "Декада", "Следующий",   ВариантСтандартнойДатыНачала.НачалоСледующейДекады, "  Начало следующей декады");
	// Месяц
	ДобавитьСтрокуСтандартнойДатыНачала(ТаблицаСтандартныхПериодов, "Месяц", "Предыдущий",   ВариантСтандартнойДатыНачала.НачалоПрошлогоМесяца, "Начало предыдущего месяца");
	ДобавитьСтрокуСтандартнойДатыНачала(ТаблицаСтандартныхПериодов, "Месяц", "Текущий",      ВариантСтандартнойДатыНачала.НачалоЭтогоМесяца, " Начало этого месяца");
	ДобавитьСтрокуСтандартнойДатыНачала(ТаблицаСтандартныхПериодов, "Месяц", "Следующий",    ВариантСтандартнойДатыНачала.НачалоСледующегоМесяца, "  Начало следующего месяца");
	// Квартал
	ДобавитьСтрокуСтандартнойДатыНачала(ТаблицаСтандартныхПериодов, "Квартал", "Предыдущий", ВариантСтандартнойДатыНачала.НачалоПрошлогоКвартала, "Начало предыдущего квартала");
	ДобавитьСтрокуСтандартнойДатыНачала(ТаблицаСтандартныхПериодов, "Квартал", "Текущий",    ВариантСтандартнойДатыНачала.НачалоЭтогоКвартала, " Начало этого квартала");
	ДобавитьСтрокуСтандартнойДатыНачала(ТаблицаСтандартныхПериодов, "Квартал", "Следующий",  ВариантСтандартнойДатыНачала.НачалоСледующегоКвартала, "  Начало следующего квартала");
	// Полугодие
	ДобавитьСтрокуСтандартнойДатыНачала(ТаблицаСтандартныхПериодов, "Полугодие", "Предыдущий", ВариантСтандартнойДатыНачала.НачалоПрошлогоПолугодия, "Начало предыдущего полугодия");
	ДобавитьСтрокуСтандартнойДатыНачала(ТаблицаСтандартныхПериодов, "Полугодие", "Текущий",    ВариантСтандартнойДатыНачала.НачалоЭтогоПолугодия, " Начало этого полугодия");
	ДобавитьСтрокуСтандартнойДатыНачала(ТаблицаСтандартныхПериодов, "Полугодие", "Следующий",  ВариантСтандартнойДатыНачала.НачалоСледующегоПолугодия, "  Начало следующего полугодия");
	// Год
	ДобавитьСтрокуСтандартнойДатыНачала(ТаблицаСтандартныхПериодов, "Год", "Предыдущий",     ВариантСтандартнойДатыНачала.НачалоПрошлогоГода, "Начало предыдущего года");
	ДобавитьСтрокуСтандартнойДатыНачала(ТаблицаСтандартныхПериодов, "Год", "Текущий",        ВариантСтандартнойДатыНачала.НачалоЭтогоГода, " Начало этого года");
	ДобавитьСтрокуСтандартнойДатыНачала(ТаблицаСтандартныхПериодов, "Год", "Следующий",      ВариантСтандартнойДатыНачала.НачалоСледующегоГода, "  Начало этого года");
	Возврат ТаблицаСтандартныхПериодов;
	
КонецФункции

Процедура ДобавитьСтрокуСтандартногоПериода(ТаблицаСтандартныхПериодов, Периодичность, Время, СтандартныйПериод, Представление)
	
	НоваяСтрока = ТаблицаСтандартныхПериодов.Добавить();
	НоваяСтрока.Периодичность = Периодичность;
	НоваяСтрока.Время = Время;
	НоваяСтрока.СтандартныйПериод = СтандартныйПериод;
	НоваяСтрока.Представление = Представление;
	
КонецПроцедуры

Процедура ДобавитьСтрокуСтандартнойДатыНачала(ТаблицаСтандартныхПериодов, Периодичность, Время, СтандартнаяДатаНачала, Представление)
	
	НоваяСтрока = ТаблицаСтандартныхПериодов.Добавить();
	НоваяСтрока.Периодичность = Периодичность;
	НоваяСтрока.Время = Время;
	НоваяСтрока.СтандартнаяДатаНачала = СтандартнаяДатаНачала;
	НоваяСтрока.Представление = Представление;
	
КонецПроцедуры

Функция ПолучитьСписокВыбораСтандартногоПериодаПользователя(Параметры)
	
	ТаблицаСтандартныхПериодов = ПолучитьТаблицуСтандартныхПериодов();
	ВспомогательныйПериод = Новый СтандартныйПериод;
	СписокВыбораПериодовПользователя = Новый СписокЗначений;
	
	Если Параметры.ПроизвольныйПериод Тогда
		СписокВыбораПериодовПользователя.Вставить(0, ВариантСтандартногоПериода.ПроизвольныйПериод, "Произвольный период");
	КонецЕсли;
	
	Для каждого ОтносительноеВремя Из Параметры.СписокДоступныхОтносительныхПериодов Цикл
		Если Не ОтносительноеВремя.Пометка Тогда
			Продолжить;
		КонецЕсли;
		Для каждого Периодичность Из Параметры.ДоступныеПериодичности Цикл
			Если Не Периодичность.Использование Тогда
				Продолжить;
			КонецЕсли;
			СтруктураПоиска = Новый Структура;
			СтруктураПоиска.Вставить("Время", ОтносительноеВремя.Значение);
			СтруктураПоиска.Вставить("Периодичность", Периодичность.Периодичность);
			НайденныеСтроки = ТаблицаСтандартныхПериодов.НайтиСтроки(СтруктураПоиска);
			Если НайденныеСтроки.Количество() = 1 Тогда
				НайденнаяСтрока = НайденныеСтроки[0];
				Если  Периодичность.Периодичность = "Декада" 
					ИЛИ Периодичность.Периодичность = "Неделя" 
					ИЛИ ОтносительноеВремя.Значение = "СНачала" 
					ИЛИ ОтносительноеВремя.Значение = "ДоКонца" Тогда
					Представление = ""
				Иначе
					ВспомогательныйПериод.Вариант = НайденнаяСтрока.СтандартныйПериод;
					Представление = " (" + ПредставлениеПериода(ВспомогательныйПериод.ДатаНачала, ВспомогательныйПериод.ДатаОкончания) + ")";
				КонецЕсли;
				СписокВыбораПериодовПользователя.Добавить(НайденнаяСтрока.СтандартныйПериод, НайденнаяСтрока.Представление + Представление);
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	Возврат СписокВыбораПериодовПользователя;
	
КонецФункции

Функция ПолучитьСписокВыбораСтандартнойДатыНачалаПользователя(Параметры)
	
	ТаблицаСтандартныхДатНачала = ПолучитьТаблицуСтандартныхДатНачала();
	ВспомогательныйПериод = Новый СтандартнаяДатаНачала;
	СписокВыбораПериодовПользователя = Новый СписокЗначений;
	
	Если Параметры.ПроизвольныйПериод Тогда
		СписокВыбораПериодовПользователя.Вставить(0, ВариантСтандартнойДатыНачала.ПроизвольнаяДата, "Произвольная дата");
	КонецЕсли;
	
	Для каждого ОтносительноеВремя Из Параметры.СписокДоступныхОтносительныхПериодов Цикл
		Если Не ОтносительноеВремя.Пометка Тогда
			Продолжить;
		КонецЕсли;
		Для каждого Периодичность Из Параметры.ДоступныеПериодичности Цикл
			Если Не Периодичность.Использование Тогда
				Продолжить;
			КонецЕсли;
			СтруктураПоиска = Новый Структура;
			СтруктураПоиска.Вставить("Время", ОтносительноеВремя.Значение);
			СтруктураПоиска.Вставить("Периодичность", Периодичность.Периодичность);
			НайденныеСтроки = ТаблицаСтандартныхДатНачала.НайтиСтроки(СтруктураПоиска);
			Если НайденныеСтроки.Количество() = 1 Тогда
				НайденнаяСтрока = НайденныеСтроки[0];
				
				ВспомогательныйПериод.Вариант = НайденнаяСтрока.СтандартнаяДатаНачала;
				Представление = " (" + Формат(ВспомогательныйПериод.Дата, "ДФ=dd.MM.yyyy") + ")";
				
				СписокВыбораПериодовПользователя.Добавить(НайденнаяСтрока.СтандартнаяДатаНачала, НайденнаяСтрока.Представление + Представление);
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	Возврат СписокВыбораПериодовПользователя;
	
КонецФункции

Функция ПолучитьЗаголовокОтчета(ОтчетОбъект, ФормаОтчета = Неопределено) Экспорт
	
	Возврат ТиповыеОтчетыПереопределяемый.ПолучитьЗаголовокОтчетаПереопределяемая(ОтчетОбъект, ФормаОтчета);
	
КонецФункции 

Функция ПолучитьЗначенияНастроекПанелиПользователяПоУмолчанию(ОтчетОбъект, ФормаОтчета = Неопределено) Экспорт
	
	ЗначенияНастроек = Новый Структура;
	
	ЗначенияНастроек.Вставить("ВыводитьЗаголовокОтчета", Истина);
	ЗначенияНастроек.Вставить("ФормироватьПриОткрытии", Ложь);
	
	//ДинамическиеОтборы
	ЗначенияНастроек.Вставить("ДинамическиеОтборы", Новый Соответствие);
	ЗначенияНастроек.Вставить("ДинамическиеПараметры", Новый Соответствие);
	ЗначенияНастроек.Вставить("ДинамическиеГруппировки", Новый Соответствие);
	
	Компоновщик = Новый КомпоновщикНастроекКомпоновкиДанных;
	СхемаОбъекта = ПолучитьСхемуКомпоновкиОбъекта(ОтчетОбъект);
	Компоновщик.Инициализировать(Новый ИсточникДоступныхНастроекКомпоновкиДанных(СхемаОбъекта));
	ЗаполнитьЭлементы(Компоновщик.Настройки["ПараметрыДанных"], СхемаОбъекта.НастройкиПоУмолчанию["ПараметрыДанных"]);
	
	ЗначенияНастроек.Вставить("НастройкиКомпоновщика", Компоновщик.ПолучитьНастройки());
	
	
	// Запомним видимость страниц компоновки чтобы при загрузке значений знать,
	// брать из значений по умолчанию или из запомненных значений
	ВидимостьСтраниц = Новый Соответствие;
	ВидимостьСтраниц.Вставить("Параметры", Ложь);
	ВидимостьСтраниц.Вставить("Отбор", Ложь);
	ВидимостьСтраниц.Вставить("Порядок", Ложь);
	ВидимостьСтраниц.Вставить("Показатели", ложь);
	ЗначенияНастроек.Вставить("ВидимостьСтраниц", ВидимостьСтраниц);
	ЗначенияНастроек.Вставить("Показатели", Новый Соответствие);
	
	// Стандартный период
	ЗначенияНастроек.Вставить("СтандартныйПериод", Новый СтандартныйПериод);
	
	// Стандартная дата начала
	ЗначенияНастроек.Вставить("СтандартнаяДатаНачала", Новый СтандартнаяДатаНачала);
	
	ТиповыеОтчетыПереопределяемый.ДополнитьЗначенияНастроекПанелиПользователяПоумолчанию(ЗначенияНастроек, ОтчетОбъект);
	
	Возврат ЗначенияНастроек;
	
КонецФункции

Функция ПолучитьПараметрыПанелиПользователяПоУмолчанию(ОтчетОбъект, ФормаОтчета = Неопределено) Экспорт
	
	Возврат ТиповыеОтчетыПереопределяемый.ПолучитьПараметрыПанелиПользователяПоУмолчаниюПереопределяемая(ОтчетОбъект, ФормаОтчета);
	
КонецФункции



Функция ПолучитьНастройкуПользователяНастройкиОтчета(НастраиваемыйОбъект, Пользователь = Неопределено)
	
	Если Пользователь = Неопределено Тогда
		Пользователь = глЗначениеПеременной("глТекущийПользователь");
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ Разрешенные
	|	СохраненныеНастройкиПользователи.Ссылка
	|ИЗ
	|	Справочник.СохраненныеНастройки.Пользователи КАК СохраненныеНастройкиПользователи
	|ГДЕ
	|	СохраненныеНастройкиПользователи.Пользователь = &Пользователь
	|	И СохраненныеНастройкиПользователи.Ссылка.ТипНастройки = &ТипНастройки
	|	И СохраненныеНастройкиПользователи.Ссылка.НастраиваемыйОбъект = &НастраиваемыйОбъект";
	Запрос.УстановитьПараметр("Пользователь", Пользователь);
	Запрос.УстановитьПараметр("ТипНастройки", Перечисления.ТипыНастроек.НастройкиПользователяНастройкиОтчета);
	Запрос.УстановитьПараметр("НастраиваемыйОбъект", НастраиваемыйОбъект);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Ссылка;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

Процедура ЗагрузитьВСхемуНастройкиКомпоновщика(Схема, Настройки) Экспорт
	
	НастройкиXDTO = СериализаторXDTO.ЗаписатьXDTO(Настройки);
	СхемаXDTO = СериализаторXDTO.ЗаписатьXDTO(Схема);
	Если НастройкиXDTO <> Неопределено Тогда
		Если СхемаXDTO.Свойства().Получить("defaultSettings") <> Неопределено тогда
			
			СхемаXDTO.defaultSettings = НастройкиXDTO;
			
		ИначеЕсли СхемаXDTO.Свойства().Получить("settingsVariant") <> Неопределено и СхемаXDTO.settingsVariant.Количество() <> 0 тогда
			
			СхемаXDTO.settingsVariant[0].settings = НастройкиXDTO;
			
		КонецЕсли;
	КонецЕсли;
	Схема = СериализаторXDTO.ПрочитатьXDTO(СхемаXDTO);
	
КонецПроцедуры



Процедура ОбновитьТаблицуДоступныхНастроекПользователю(ОтчетОбъект) Экспорт
	
	ПараметрыИсполненияОтчета = Неопределено;
	
	ПараметрыИсполненияОтчета = ОтчетОбъект.ПолучитьПараметрыИсполненияОтчета();
	
	СписокДоступныхНастроек = Неопределено;
	Если ПараметрыИсполненияОтчета <> Неопределено И ПараметрыИсполненияОтчета.Свойство("СписокДоступныхПредопределенныхНастроек") тогда
		СписокДоступныхНастроек = ПараметрыИсполненияОтчета.СписокДоступныхПредопределенныхНастроек;
	КонецЕсли;
	
	ОтчетОбъект.ТаблицаВариантовОтчета = ПолучитьТаблицуДоступныхВариантов(ПолучитьИдентификаторОбъекта(ОтчетОбъект), глЗначениеПеременной("глТекущийПользователь"),,, СписокДоступныхНастроек);
	
КонецПроцедуры


Функция ДобавитьИЗаполнитьСтроку(Родитель, Использование, Имя, Представление) Экспорт
	
	НоваяСтрока = Родитель.Строки.Добавить();
	НоваяСтрока.Использование = Использование;
	НоваяСтрока.Имя = Имя;
	НоваяСтрока.Представление = Представление;
	Возврат НоваяСтрока;
	
КонецФункции

Функция ДобавитьСтрокуПериодичности(Таблица, Периодичность, Использование) Экспорт
	
	НоваяСтрока = Таблица.Добавить();
	НоваяСтрока.Периодичность = Периодичность;
	НоваяСтрока.Использование = Использование;
	Возврат НоваяСтрока;
	
КонецФункции


Процедура ОбновитьЦветаДиаграммы(Результат, ТаблицаЦветовСерий) Экспорт
	
	Если ТаблицаЦветовСерий = Неопределено 
		ИЛИ ТаблицаЦветовСерий.Колонки.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Рисунки = Результат.Рисунки;
	Для каждого Рисунок Из Рисунки Цикл
		Если ТипЗнч(Рисунок.Объект) <> Тип("Диаграмма") Тогда
			Продолжить;
		КонецЕсли;
		Серии = Рисунок.Объект.Серии;
		Для каждого Серия Из Серии Цикл
			СтруктураПоиска = Новый Структура("Текст", Серия.Текст);
			МассивЦветовСерий = ТаблицаЦветовСерий.НайтиСтроки(СтруктураПоиска);
			Если МассивЦветовСерий.Количество() > 0 Тогда
				Серия.Цвет = МассивЦветовСерий[0].Цвет;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
КонецПроцедуры

Процедура УстановитьЗначениеВЭлементеПоСтруктуре(Структура, Ключ, ЭлементФормы) Экспорт
	
	Значение = ПолучитьЗначенияЭлементаСтруктуры(Структура, Ключ);
	Если Значение <> Неопределено Тогда
		ЭлементФормы.Значение = Значение;
	КонецЕсли;
	
КонецПроцедуры

Функция ПолучитьЗначенияЭлементаСтруктуры(Структура, Ключ) Экспорт
	
	Если Структура = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	Значение = Неопределено;
	Структура.Свойство(Ключ, Значение);
	Возврат Значение;
	
КонецФункции

Процедура УстановитьДопустимоеЗначениеВПолеВыбора(Элемент, Значение, УстанавливатьПервоеЗначение = Ложь) Экспорт
	
	Если ЗначениеЗаполнено(Элемент.Значение) Тогда
		Возврат;
	КонецЕсли;
	
	Если Значение <> Неопределено И Элемент.СписокВыбора.НайтиПоЗначению(Значение) <> Неопределено Тогда
		Элемент.Значение = Значение;
	КонецЕсли;
	
	Если Элемент.Значение = Неопределено И УстанавливатьПервоеЗначение И Элемент.СписокВыбора.Количество() > 1 Тогда
		Элемент.Значение = Элемент.СписокВыбора[1].Значение;
	КонецЕсли;
	
КонецПроцедуры

Функция ПолучитьСтруктуруДинамическихОтборов(Параметры, ЭлементыФормы) Экспорт
	
	
	Соответствие = Новый Соответствие;
	Если Параметры = Неопределено Тогда
		Возврат Соответствие;
	КонецЕсли;
	
	Для каждого СтрокаОтбора Из Параметры.Отборы Цикл
		Индекс = Параметры.Отборы.Индекс(СтрокаОтбора);
		
		ЕстьСписок = (СтрокаОтбора.ВидОтбора = "Список" ИЛИ СтрокаОтбора.ВидОтбора = "ДлинныйСписок") 
		И СтрокаОтбора.Расположение <> "ГоризонтальнаяПанель";
		ЕстьЗначение = СтрокаОтбора.ВидОтбора = "ФлажокЗначение" ИЛИ СтрокаОтбора.ВидОтбора = "Значение" ИЛИ ((СтрокаОтбора.ВидОтбора = "Список" ИЛИ СтрокаОтбора.ВидОтбора = "ДлинныйСписок") 
		И СтрокаОтбора.Расположение = "ГоризонтальнаяПанель");
		ЕстьФлажок = СтрокаОтбора.ВидОтбора = "Флажок" ИЛИ СтрокаОтбора.ВидОтбора = "ФлажокЗначение";
		
		Использование = Истина;
		Значение = Неопределено;
		ВыбранныйВидСравнения = Неопределено;
		
		Если ЕстьСписок Тогда
			Если ЭлементыФормы.Найти("ДинамическийОтбор" + Индекс + "ТабличноеПоле") <> Неопределено тогда
				Список = Новый СписокЗначений;
				Список.ЗагрузитьЗначения(ЭлементыФормы["ДинамическийОтбор" + Индекс + "ТабличноеПоле"].Значение.ВыгрузитьКолонку("Значение"));
				Значение = Список;
				ВыбранныйВидСравнения = ЭлементыФормы["ДинамическийОтбор" + Индекс + "ВидСравнения"].Значение;
			КонецЕсли;
		ИначеЕсли ЕстьЗначение Тогда
			Если ЭлементыФормы.Найти("ДинамическийОтбор" + Индекс + "ПолеВвода") <> Неопределено тогда
				Значение = ЭлементыФормы["ДинамическийОтбор" + Индекс + "ПолеВвода"].Значение;
			КонецЕсли;
		Иначе
			Значение = СтрокаОтбора.Значение;
		КонецЕсли;
		Если ЕстьФлажок Тогда
			Если ЭлементыФормы.Найти("ДинамическийОтбор" + Индекс + "Флажок") <> Неопределено тогда
				Использование = ЭлементыФормы["ДинамическийОтбор" + Индекс + "Флажок"].Значение;
			КонецЕсли;
		КонецЕсли;
		
		Если (СтрокаОтбора.Расположение = "ГоризонтальнаяПанель" или СтрокаОтбора.ВидОтбора = "Значение") И НЕ ЗначениеЗаполнено(Значение) тогда
			Использование = ложь;
		КонецЕсли;
		
		СтруктураОтбора = Новый Структура;
		СтруктураОтбора.Вставить("Использование", Использование);
		СтруктураОтбора.Вставить("Поле", СтрокаОтбора.Поле);
		СтруктураОтбора.Вставить("ВидСравнения", ВыбранныйВидСравнения);
		СтруктураОтбора.Вставить("Значение", Значение);
		Соответствие[СтрокаОтбора.Поле] = СтруктураОтбора;
	КонецЦикла;
	Возврат Соответствие;
	
КонецФункции

Функция ПолучитьСтруктуруДинамическихПараметров(Параметры, ЭлементыФормы) Экспорт
	
	Соответствие = Новый Соответствие;
	Если Параметры = Неопределено или НЕ Параметры.Свойство("Параметры") Тогда
		Возврат Соответствие;
	КонецЕсли;
	
	Для каждого СтрокаПараметра Из Параметры.Параметры Цикл
		
		
		Индекс = Параметры.Параметры.Индекс(СтрокаПараметра);
		
		ЕстьСписок = СтрокаПараметра.ОтображатьКак = "СписокЗначение";
		ЕстьЗначение = СтрокаПараметра.ОтображатьКак = "Переключатель" ИЛИ СтрокаПараметра.ОтображатьКак = "ПолеВвода";
		
		Если НЕ ЕстьЗначение и НЕ ЕстьСписок тогда 
			Продолжить;
		КонецЕсли;
		Если СтрокаПараметра.ОтображатьКак = "СписокЗначение" И СтрокаПараметра.ВыводитьНа = "ПраваяПанель" тогда
			ЭлементУправления = "ТабличноеПоле";
		ИначеЕсли СтрокаПараметра.ОтображатьКак = "СписокЗначение" И СтрокаПараметра.ВыводитьНа = "ГоризонтальнаяПанель" тогда
			ЭлементУправления = "ПолеВвода";
		Иначе
			ЭлементУправления = СтрокаПараметра.ОтображатьКак;
		КонецЕсли;
		Если СтрокаПараметра.ОтображатьКак = "Переключатель" тогда
			НазваниеЭлементаУправления = "ДинамическийПараметр" + Индекс + 0 + ЭлементУправления;
		Иначе
			НазваниеЭлементаУправления = "ДинамическийПараметр" + Индекс + ЭлементУправления;
		КонецЕсли;
		
		Использование = Истина;
		Значение = Неопределено;
		
		Если ЭлементыФормы.Найти(НазваниеЭлементаУправления) <> Неопределено тогда
			Если ЕстьСписок Тогда
				Список = Новый СписокЗначений;
				
				Если ЭлементУправления = "ПолеВвода" тогда
					Список = ЭлементыФормы[НазваниеЭлементаУправления].Значение;
				Иначе
					Список.ЗагрузитьЗначения(ЭлементыФормы[НазваниеЭлементаУправления].Значение.ВыгрузитьКолонку("Значение"));
				КонецЕсли;
				Значение = Список;
			Иначе 
				Значение = ЭлементыФормы[НазваниеЭлементаУправления].Значение;
			КонецЕсли;
		Иначе
			Сообщить("Не найден параметр "+СтрокаПараметра.Параметр);
		КонецЕсли;
		СтруктураОтбора = Новый Структура;
		СтруктураОтбора.Вставить("Использование", Использование);
		СтруктураОтбора.Вставить("Параметр", СтрокаПараметра.Параметр);
		СтруктураОтбора.Вставить("Значение", Значение);
		Соответствие[СтрокаПараметра.Параметр] = СтруктураОтбора;
	КонецЦикла;
	Возврат Соответствие;
	
КонецФункции

Функция ПолучитьСтруктуруДинамическихГруппировок(Параметры, ЭлементыФормы) Экспорт
	
	Соответствие = Новый Соответствие;
	Если Параметры = Неопределено или НЕ Параметры.Свойство("Группировки") Тогда
		Возврат Соответствие;
	КонецЕсли;
	
	Для каждого СтрокаГруппировки Из Параметры.Группировки Цикл
		Индекс = Параметры.Группировки.Индекс(СтрокаГруппировки);
		Значение = Неопределено;
		ЗначениеСтрок = Неопределено;
		ЗначениеКолонок = Неопределено;
		ЭлемУпрЗначение = ЭлементыФормы.Найти("ДинамическаяГруппировка" + Индекс + "ТабличноеПоле");
		ЭлемУпрЗначениеСтрок = ЭлементыФормы.Найти("ДинамическаяГруппировка" + Индекс + "ТабличноеПолеСтрок");
		ЭлемУпрЗначениеКолонок = ЭлементыФормы.Найти("ДинамическаяГруппировка" + Индекс + "ТабличноеПолеКолонок");
		
		СтруктураГруппировки = Новый Структура("Использование, 
		|ИмяГруппировки, 
		|СписокГруппировки, 
		|СписокГруппировкиСтрок, 
		|СписокГруппировкиКолонок", 
		СтрокаГруппировки.Использование,
		СтрокаГруппировки.Группировка,
		?(ЭлемУпрЗначение <> Неопределено, ЭлемУпрЗначение.Значение, Неопределено),
		?(ЭлемУпрЗначениеСтрок <> Неопределено, ЭлемУпрЗначениеСтрок.Значение, Неопределено),
		?(ЭлемУпрЗначениеКолонок <> Неопределено, ЭлемУпрЗначениеКолонок.Значение, Неопределено));
		
		Соответствие[СтрокаГруппировки.Группировка] = СтруктураГруппировки;
	КонецЦикла;
	Возврат Соответствие;
КонецФункции

Процедура ПрименитьНастройкуПользователяНастройкиОтчета(ОтчетОбъект) Экспорт
	
	СсылкаНаОбъект = ПолучитьИдентификаторОбъекта(ОтчетОбъект); 
	НастраиваемыйОбъект = ?(ОтчетОбъект.СохраненнаяНастройка.Пустая(), СсылкаНаОбъект, ОтчетОбъект.СохраненнаяНастройка);
	Настройка = ПолучитьНастройкуПользователяНастройкиОтчета(НастраиваемыйОбъект);
	Если Настройка <> Неопределено Тогда
		Настройка = Настройка.ПолучитьОбъект();
		Значение = Настройка.ХранилищеНастроек.Получить();
		ОтчетОбъект.ЗначенияНастроекПанелиПользователя = Новый ХранилищеЗначения(Значение["ЗначенияНастроекПанелиПользователя"]);
	Иначе
		ПараметрыИсполненияОтчета = Неопределено;
		ПараметрыИсполненияОтчета = ОтчетОбъект.ПолучитьПараметрыИсполненияОтчета();
		
		Если ПараметрыИсполненияОтчета <> Неопределено 
			И ПараметрыИсполненияОтчета.Свойство("ЗаполнитьОтборыПоУмолчанию") 
			И ПараметрыИсполненияОтчета.ЗаполнитьОтборыПоУмолчанию 
			И ПараметрыИсполненияОтчета.Свойство("СписокПолейПодстановкиОтборовПоУмолчанию") 
			И ПараметрыИсполненияОтчета.СписокПолейПодстановкиОтборовПоУмолчанию <> Неопределено тогда
			ЗаполнитьОтборыПоУмолчанию(ОтчетОбъект, ПараметрыИсполненияОтчета.СписокПолейПодстановкиОтборовПоУмолчанию);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Функция ПолучитьИдентификаторОбъекта(ОтчетОбъект) Экспорт
	
	Возврат ТиповыеОтчетыПереопределяемый.ПолучитьИдентификаторОбъектаПереопределяемая(ОтчетОбъект);
	
КонецФункции

Функция ПолучитьСхемуКомпоновкиОбъекта(ОтчетОбъект) Экспорт
	
	Возврат ТиповыеОтчетыПереопределяемый.ПолучитьСхемуКомпоновкиОбъектаПереопределяемая(ОтчетОбъект);

КонецФункции

Процедура ЗаполнитьОтборыПоУмолчанию(ОтчетОбъект, СписокПолейПодстановки)
	
	Для каждого СписокПолей из СписокПолейПодстановки Цикл
		ТекПользователь = глЗначениеПеременной("глТекущийПользователь");
		Значение        = УправлениеПользователями.ПолучитьЗначениеПоУмолчанию(ТекПользователь, СписокПолей.Значение);
		ПодставитьОтборПоПолюВПанель(ОтчетОбъект, СписокПолей.Ключ, Значение);
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ПоказатьКопиюРезультата(Результат) Экспорт
	
	ТабДок = Новый ТабличныйДокумент;
	ТабДок.Вывести(Результат);
	ТабДок.ОтображатьЗаголовки = Ложь;
	ТабДок.ОтображатьСетку = Ложь;
	ТабДок.СохранятьСвойстваОтображения = Истина;
	ТабДок.Показать();
	
КонецПроцедуры

Процедура ЗаполнитьНастройкиПоКомпановщику(ОтчетОбъект, КомпоновщикНастроек, ЗначенияНастроек) Экспорт
	
	Если ЗначенияНастроек = Неопределено тогда
		ЗначенияНастроек = ПолучитьЗначенияНастроекПанелиПользователяПоУмолчанию(ОтчетОбъект);
	КонецЕсли;
	
	Если ЭтоСтараяВерсияОтчета(ОтчетОбъект) Тогда
		Возврат;
	КонецЕсли;
	
	ПараметрыПанели  = ПолучитьПараметрыПанелиПользователяОбъекта(ОтчетОбъект);
	Если ПараметрыПанели = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	// Установка Настроек компоновки на панели настроек
	Для каждого ВидимостьСтраницы Из ЗначенияНастроек.ВидимостьСтраниц Цикл
		Если Не ВидимостьСтраницы.Значение Тогда
			Продолжить;
		КонецЕсли;
		Если ВидимостьСтраницы.Ключ = "Параметры" Тогда
			ЗаполнитьЭлементы(ЗначенияНастроек.НастройкиКомпоновщика.ПараметрыДанных, КомпоновщикНастроек.Настройки.ПараметрыДанных);
		Иначе
			Если ВидимостьСтраницы.Ключ = "Выбор" тогда
				КомпоновщикНастроек.Настройки[ВидимостьСтраницы.Ключ].Элементы.Очистить();
			КонецЕсли;
			СкопироватьЭлементы(ЗначенияНастроек.НастройкиКомпоновщика[ВидимостьСтраницы.Ключ], КомпоновщикНастроек.Настройки[ВидимостьСтраницы.Ключ], , Ложь);
		КонецЕсли;
	КонецЦикла;
	
	// Установим у всех параметров использование
	Для каждого ЗначениеПараметра Из ЗначенияНастроек.НастройкиКомпоновщика.ПараметрыДанных.Элементы Цикл
		ЗначениеПараметра.Использование = Истина;
	КонецЦикла;
	
	// Установка параметра ПериодОтчета
	//ЗначениеПараметра = КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("ПериодОтчета"));
	//ЕстьПериод = ПараметрыПанели.ДеревоНастроекСтандартныхСтраниц.Строки.НайтиСтроки(Новый Структура("Имя", "Период"))[0].Использование;
	//Если ЕстьПериод И ЗначениеПараметра <> Неопределено Тогда
	//	Периоды = ПолучитьСписокПериодов(ЗначениеПараметра.Значение, ПараметрыПанели);
	//	ЗначениеПараметра.Использование = Периоды.Количество() <> 0;
	//	Если ТипЗнч(ЗначениеПараметра.Значение) = Тип("СписокЗначений") Тогда
	//		ЗначениеПараметра.Значение = Периоды;
	//	Иначе
	//		ЗначениеПараметра.Значение = Периоды[0].Значение;
	//	КонецЕсли;
	//КонецЕсли;
	
	Если ПараметрыПанели.ДеревоНастроекСтандартныхСтраниц.Строки.Найти("Период").Использование Тогда
		// Установка Стандартного периода
		ЗначениеПараметраНачалоПериода = КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("НачалоПериода"));
		ЗначениеПараметраКонецПериода  = КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("КонецПериода"));
		Если ЗначениеПараметраНачалоПериода <> Неопределено И ЗначениеПараметраКонецПериода <> Неопределено Тогда
			СтандартныйПериод = Неопределено;
			ЗначенияНастроек.Свойство("СтандартныйПериод", СтандартныйПериод);
			Если СтандартныйПериод <> Неопределено Тогда
				Если ЗначениеПараметраНачалоПериода.Использование Тогда
					ЗначенияНастроек.СтандартныйПериод.ДатаНачала = ЗначениеПараметраНачалоПериода.Значение;
				КонецЕсли;
				Если ЗначениеПараметраКонецПериода.Использование Тогда
					ЗначенияНастроек.СтандартныйПериод.ДатаОкончания = ЗначениеПараметраКонецПериода.Значение;
				КонецЕсли;
				ЗначенияНастроек.СтандартныйПериод = СтандартныйПериод;
			КонецЕсли;
		КонецЕсли;
		
		// Установка Стандартной даты начала
		ЗначениеПараметраПериод = КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("Период"));
		Если ЗначениеПараметраПериод <> Неопределено Тогда
			СтандартнаяДатаНачала = Неопределено;
			ЗначенияНастроек.Свойство("СтандартнаяДатаНачала", СтандартнаяДатаНачала);
			Если СтандартнаяДатаНачала <> Неопределено Тогда
				Если ЗначениеПараметраПериод.Использование Тогда
					ЗначенияНастроек.СтандартнаяДатаНачала.Дата = ЗначениеПараметраПериод.Значение;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	// Установка Динамических отборов
	Если ЗначенияНастроек.Свойство("ДинамическиеПараметры") И ПараметрыПанели.Свойство("Параметры") тогда
		Для каждого СтрокаПараметра Из ПараметрыПанели.Параметры Цикл
			ЗначениеПараметра = ЗначенияНастроек.ДинамическиеПараметры[СтрокаПараметра.Параметр];
			Если ЗначениеПараметра = Неопределено ИЛИ Не ЗначениеПараметра.Использование Тогда
				Продолжить;
			КонецЕсли;
			ЗначениеПараметраКомпоновщика = ПолучитьПараметр(КомпоновщикНастроек, ЗначениеПараметра.Параметр);
			ЗначениеПараметра.Значение = ЗначениеПараметраКомпоновщика.Значение;
		КонецЦикла;
	КонецЕсли;
	
	
	// Установка Динамических отборов
	Для каждого СтрокаОтбора Из ПараметрыПанели.Отборы Цикл
		ЗначениеОтбора = ЗначенияНастроек.ДинамическиеОтборы[СтрокаОтбора.Поле];
		Если ЗначениеОтбора = Неопределено ИЛИ Не ЗначениеОтбора.Использование Тогда
			Продолжить;
		КонецЕсли;
		Для каждого ЭлементОтбора из КомпоновщикНастроек.Настройки.Отбор.Элементы Цикл
			Если ЭлементОтбора.Использование и ЭлементОтбора.ЛевоеЗначение = Новый ПолеКомпоновкиДанных(ЗначениеОтбора.Поле) тогда
				ЗначениеОтбора.Значение = ЭлементОтбора.ПравоеЗначение;
				Прервать;
			КонецЕсли;
		КонецЦИкла;
	КонецЦикла;
	//
	Если ЗначенияНастроек.Свойство("ДинамическиеГруппировки") И ПараметрыПанели.Свойство("Группировки") тогда
		Группировки =  ПолучитьГруппировки(КомпоновщикНастроек);
		Для каждого ЗначениДинГруппировки из ЗначенияНастроек.ДинамическиеГруппировки Цикл
			Если ЗначениДинГруппировки.Значение.СписокГруппировки <> Неопределено тогда
				ЗначениДинГруппировки.Значение.СписокГруппировки.Очистить();
				Для каждого Группировка из Группировки Цикл
					Если  Группировка.Значение.Имя = ЗначениДинГруппировки.Значение.ИмяГруппировки тогда
						ДобавитьГрупипровкуВЗначениеНастроек(КомпоновщикНастроек, Группировка.Значение, ЗначениДинГруппировки.Значение.СписокГруппировки);
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			Если ЗначениДинГруппировки.Значение.СписокГруппировкиСтрок <> Неопределено И ЗначениДинГруппировки.Значение.СписокГруппировкиКолонок <> Неопределено тогда
				ЗначениДинГруппировки.Значение.СписокГруппировкиСтрок.Очистить();
				Для каждого Группировка из Группировки Цикл
					Если  Группировка.Значение.Имя = ЗначениДинГруппировки.Значение.ИмяГруппировки тогда
						Если ТипЗнч(Группировка) = Тип("ТаблицаКомпоновкиДанных") или ТипЗнч(Группировка) = Тип("ДиаграммаКомпоновкиДанных") тогда
							Строки = Неопределено;
							Колонки = Неопределено;
							Если ТипЗнч(Группировка) = Тип("ТаблицаКомпоновкиДанных") тогда
								Строки  = Группировка.Строки;
								Колонки = Группировка.Колонки;
							Иначе
								Строки  = Группировка.Серии;
								Колонки = Группировка.Точки;
							КонецЕсли;
							ГруппировкиСтрок = ПолучитьГруппировки(Строки);
							ГруппировкиКолонок = ПолучитьГруппировки(Колонки);
							Для каждого ГруппировкаСтрок из ГруппировкиСтрок Цикл
								ДобавитьГрупипровкуВЗначениеНастроек(КомпоновщикНастроек, ГруппировкаСтрок.Значение, ЗначениДинГруппировки.Значение.СписокГруппировкиСтрок);
							КонецЦикла;
							Для каждого ГруппировкаКолонок из ГруппировкиКолонок Цикл
								ДобавитьГрупипровкуВЗначениеНастроек(КомпоновщикНастроек, ГруппировкаКолонок.Значение, ЗначениДинГруппировки.Значение.СписокГруппировкиКолонок);
							КонецЦикла;
						КонецЕсли;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

Процедура ДобавитьГрупипровкуВЗначениеНастроек(КомпоновщикНастроек, Группировка, ЭлементТабличноеПоле)
	СтрокаГруппировки = ЭлементТабличноеПоле.Добавить();
	Представление = "";
	Для каждого ПолеГруппировки из Группировка.ПоляГруппировки.Элементы Цикл
		СтрокаГруппировки.Значение.Добавить(Строка(ПолеГруппировки.Поле));
		ДоступноеПоле = ПолучитьДоступноеПолеПоПолюКомпоновкиДанных(ПолеГруппировки.Поле, КомпоновщикНастроек);
		Представление = Представление + ?(Представление = "", "", ", ") + ДоступноеПоле.Заголовок;
	КонецЦикла;
	СтрокаГруппировки.Представление = Представление;
	СтрокаГруппировки.Использование = Группировка.Использование;
КонецПроцедуры


Процедура ОчиститьКомпоновщикНастроек(КомпоновщикНастроек)
	
	Если ТипЗнч(КомпоновщикНастроек) <> Тип("КомпоновщикНастроекКомпоновкиДанных") тогда
		Возврат;
	КонецЕсли;
	КомпоновщикНастроек.Настройки.Выбор.Элементы.Очистить();
	КомпоновщикНастроек.Настройки.Отбор.Элементы.Очистить();
	КомпоновщикНастроек.Настройки.Структура.Очистить();
	КомпоновщикНастроек.Настройки.ПользовательскиеПоля.Элементы.Очистить();
	КомпоновщикНастроек.Настройки.УсловноеОформление.Элементы.Очистить();
	
	//очистим параметры
	
	Для каждого Параметр из КомпоновщикНастроек.Настройки.ПараметрыДанных.Элементы Цикл
		Если Параметр.Значение <> Неопределено тогда
			Параметр.Значение = Неопределено;
		КонецЕсли;
	КонецЦикла;
	
	Для каждого Параметр из КомпоновщикНастроек.Настройки.ПараметрыВывода.Элементы Цикл
		Параметр.Использование = истина;
	КонецЦикла;
	
КонецПроцедуры

Функция ИнициализироватьКомпоновщикНастроек(ОтчетОбъект, Схема = Неопределено, ЗагружатьНастройкиПоУмолчанию = Ложь, ТолькоПолучитьСКД = ложь) Экспорт
	
	Схема = ОтчетОбъект.СхемаКомпоновкиДанных;
	
	Если Схема = Неопределено Тогда
		Схема = ОтчетОбъект.СхемаКомпоновкиДанных.Получить();
	КонецЕсли;
	Если Схема = Неопределено Тогда
		// Если схема компоновки еще не редактировалась, создадим новую
		ОтчетОбъект.СхемаКомпоновкиДанных = Новый ХранилищеЗначения(Новый СхемаКомпоновкиДанных);
	КонецЕсли;
	
	Если Не ТолькоПолучитьСКД тогда
		ОтчетОбъект.КомпоновщикНастроек.Инициализировать(Новый ИсточникДоступныхНастроекКомпоновкиДанных(Схема));
	КонецЕсли;
	
	Если ЗагружатьНастройкиПоУмолчанию Тогда
		// Загрузим настройки по умолчанию
		ОтчетОбъект.КомпоновщикНастроек.ЗагрузитьНастройки(Схема.НастройкиПоУмолчанию);
	КонецЕсли;
	
	Возврат Схема;
	
КонецФункции


Функция ПолучитьСписокТиповыхОтчетов()
	
	СписокОтчетов = Новый СписокЗначений;
	Для каждого Отчет Из Метаданные.Отчеты Цикл
		Если Отчет.Имя <> "ШаблонТиповогоОтчета"
			И Отчет.Реквизиты.Найти("ПериодОтчета") = Неопределено
			И Отчет.Реквизиты.Найти("ЗначенияНастроекПанелиПользователя") <> Неопределено Тогда
			СписокОтчетов.Добавить(Отчет.Имя, Отчет.Синоним);
		КонецЕсли;
	КонецЦикла;
	Возврат СписокОтчетов;
	
КонецФункции

Функция ЗаписьОтчетаДоступна(ОтчетОбъект, ПроверяемаяСохраненнаяНастройка = Неопределено) Экспорт
	
	Если ПроверяемаяСохраненнаяНастройка = Неопределено Тогда
		ПроверяемаяСохраненнаяНастройка = ОтчетОбъект.СохраненнаяНастройка;
	КонецЕсли;
	
	СписокДоступныхНастроек = ПолучитьСписокДоступныхВариантов(ПолучитьИдентификаторОбъекта(ОтчетОбъект), глЗначениеПеременной("глТекущийПользователь"),, ОтчетОбъект);
	
	Элемент = СписокДоступныхНастроек.НайтиПоЗначению(ПроверяемаяСохраненнаяНастройка);
	Если ПроверяемаяСохраненнаяНастройка.Пустая() Тогда
		// Основную настройку типового отчета сохранять нельзя
		Возврат Ложь;
	Иначе
		Возврат Элемент <> Неопределено И Элемент.Пометка 
		ИЛИ РольДоступна("ПолныеПрава");
	КонецЕсли;
	
КонецФункции

// Получает параметр данных компоновщика настроек
Функция ПолучитьПараметр(КомпоновщикНастроекКоллекцияЗначений, ИмяПараметра) Экспорт
	
	Если ТипЗнч(КомпоновщикНастроекКоллекцияЗначений) = Тип("КомпоновщикНастроекКомпоновкиДанных")
		ИЛИ ТипЗнч(КомпоновщикНастроекКоллекцияЗначений) = Тип("ДанныеРасшифровкиКомпоновкиДанных") Тогда
		ЗначениеПараметра = КомпоновщикНастроекКоллекцияЗначений.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных(ИмяПараметра));
	ИначеЕсли ТипЗнч(КомпоновщикНастроекКоллекцияЗначений) = Тип("КоллекцияЗначенийПараметровКомпоновкиДанных") Тогда
		ЗначениеПараметра = КомпоновщикНастроекКоллекцияЗначений.Найти(ИмяПараметра);
	ИначеЕсли ТипЗнч(КомпоновщикНастроекКоллекцияЗначений) = Тип("ОформлениеКомпоновкиДанных") Тогда
		ЗначениеПараметра = КомпоновщикНастроекКоллекцияЗначений.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных(ИмяПараметра));
	КонецЕсли;
	
	Возврат ЗначениеПараметра;
	
КонецФункции

// Получает параметр вывода компоновщика настроек
Функция ПолучитьПараметрВывода(КомпоновщикНастроекГруппировка, ИмяПараметра) Экспорт
	
	Если ТипЗнч(КомпоновщикНастроекГруппировка) = Тип("КомпоновщикНастроекКомпоновкиДанных") 
		ИЛИ ТипЗнч(КомпоновщикНастроекГруппировка) = Тип("ДанныеРасшифровкиКомпоновкиДанных") Тогда
		ЗначениеПараметра = КомпоновщикНастроекГруппировка.Настройки.ПараметрыВывода.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных(ИмяПараметра));
	Иначе
		ЗначениеПараметра = КомпоновщикНастроекГруппировка.ПараметрыВывода.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных(ИмяПараметра));
	КонецЕсли;
	
	Возврат ЗначениеПараметра;
КонецФункции

Функция ПолучитьНастройкуОтчета(ТекстФайлаНастройки) Экспорт
	
	СтруктураНастроек = Новый Структура("Версия, Наименование, НастраиваемыйОбъект, Описание, ХранилищеНастроек");
	
	НачалоВерсии = Найти(ТекстФайлаНастройки, "<ВЕРСИЯ>");
	КонецВерсии  = Найти(ТекстФайлаНастройки, "</ВЕРСИЯ>");
	СтруктураНастроек.Версия = Сред(ТекстФайлаНастройки, НачалоВерсии + 8, КонецВерсии - НачалоВерсии - 8); 
	НачалоНаименования = Найти(ТекстФайлаНастройки, "<НАИМЕНОВАНИЕ>");
	КонецНаименования  = Найти(ТекстФайлаНастройки, "</НАИМЕНОВАНИЕ>");
	СтруктураНастроек.Наименование = Сред(ТекстФайлаНастройки, НачалоНаименования + 14, КонецНаименования - НачалоНаименования - 14); 
	НачалоОбъект = Найти(ТекстФайлаНастройки, "<ОБЪЕКТ>");
	КонецОбъект  = Найти(ТекстФайлаНастройки, "</ОБЪЕКТ>");
	СтруктураНастроек.НастраиваемыйОбъект = Сред(ТекстФайлаНастройки, НачалоОбъект + 8, КонецОбъект - НачалоОбъект - 8 ); 
	НачалоОписание = Найти(ТекстФайлаНастройки, "<ОПИСАНИЕ>");
	КонецОписание  = Найти(ТекстФайлаНастройки, "</ОПИСАНИЕ>");
	СтруктураНастроек.Описание = Сред(ТекстФайлаНастройки, НачалоОписание + 10,  КонецОписание - НачалоОписание - 10 ); 
	НачалоНастройки = Найти(ТекстФайлаНастройки, "<НАСТРОЙКА>");
	КонецНастройки  = Найти(ТекстФайлаНастройки, "</НАСТРОЙКА>");
	СтрокаXML = Сред(ТекстФайлаНастройки, НачалоНастройки + 11, КонецНастройки - НачалоНастройки - 11);
	Попытка 
		СтруктураНастроек.ХранилищеНастроек = ПрочитатьОбъект(СтрокаXML); 
	Исключение
		СтруктураНастроек = Неопределено; 
	КонецПопытки;
	
	Возврат СтруктураНастроек;
	
КонецФункции

// Процедура загружает настройки по умолчанию, в предопредленные элементы справочника

Функция ЗагрузитьНастройкуПредопределенногоЭлемента(НазваниеМакета, ОтчетНазвание = Неопределено, ТекстовыйДокумент = Неопределено, Перезаписать = ложь) Экспорт
	
	БылиИзменения = ложь;
	
	Настройка = Неопределено;
	
	Если ОтчетНазвание = Неопределено И ТекстовыйДокумент = Неопределено тогда
		Возврат БылиИзменения;
	ИначеЕсли ТекстовыйДокумент <> Неопределено тогда
		Настройка = ПолучитьНастройкуОтчета(ТекстовыйДокумент.ПолучитьТекст());
	ИначеЕсли ОтчетНазвание <> Неопределено тогда
		ОбъектМетаданных = Метаданные.Отчеты.Найти(ОтчетНазвание);
		Если ОбъектМетаданных <> Неопределено и ОбъектМетаданных.Макеты.Найти(НазваниеМакета) <> Неопределено тогда
			ДвоичныеДанные = Отчеты[ОтчетНазвание].ПолучитьМакет(НазваниеМакета);
			ИмяВременогоФайла = ПолучитьИмяВременногоФайла();
			ДвоичныеДанные.Записать(ИмяВременогоФайла);
			ТекстовыйДокумент = Новый ТекстовыйДокумент;
			ТекстовыйДокумент.Прочитать(ИмяВременогоФайла);
			Настройка = ПолучитьНастройкуОтчета(ТекстовыйДокумент.ПолучитьТекст());
		КонецЕсли;
	КонецЕсли;
	
	Если Настройка = Неопределено тогда
		Возврат БылиИзменения;
	КонецЕсли;
	СохраненаяНастройка = Неопределено;
	ВЫПОЛНИТЬ("СохраненаяНастройка = Справочники.СохраненныеНастройки."+НазваниеМакета);
	
	Если ЗначениеЗаполнено(СохраненаяНастройка) тогда
		ОбъектСохраненаяНастройка = СохраненаяНастройка.ПолучитьОбъект();
		
		Если СохраненаяНастройка.НастраиваемыйОбъект <> Настройка.НастраиваемыйОбъект тогда
			ОбъектСохраненаяНастройка.НастраиваемыйОбъект = Настройка.НастраиваемыйОбъект;
			БылиИзменения = истина;
		КонецЕсли;
		
		Если СохраненаяНастройка.ТипНастройки <> Перечисления.ТипыНастроек.НастройкиОтчета тогда
			ОбъектСохраненаяНастройка.ТипНастройки = Перечисления.ТипыНастроек.НастройкиОтчета;
			БылиИзменения = истина;
		КонецЕсли;
		
		Если СохраненаяНастройка.Наименование = "" тогда
			ОбъектСохраненаяНастройка.Наименование = Настройка.Наименование;
			БылиИзменения = истина;
		КонецЕсли;
		
		Если СохраненаяНастройка.Описание <> Настройка.Описание тогда
			ОбъектСохраненаяНастройка.Описание = Настройка.Описание;
			БылиИзменения = истина;
		КонецЕсли;
		
		Если СохраненаяНастройка.Пользователи.Количество() = 0 тогда
			НоваяСтрока = ОбъектСохраненаяНастройка.Пользователи.Добавить();
			НоваяСтрока.Пользователь = Справочники.ГруппыПользователей.ВсеПользователи;
			НоваяСтрока.ПравоИзменения = истина;
			БылиИзменения = истина;
		КонецЕсли;
		
		НастройкаТекущая = СохраненаяНастройка.ХранилищеНастроек.Получить();
		ИзмениласьНастройка = НастройкаТекущая <> Неопределено и НастройкаТекущая.Свойство("Изменялась") И НастройкаТекущая.Изменялась;
		Если НастройкаТекущая = Неопределено или Не ИзмениласьНастройка или Перезаписать тогда
			ОбъектСохраненаяНастройка.ХранилищеНастроек = Новый ХранилищеЗначения(Настройка.ХранилищеНастроек.Получить());
			БылиИзменения = истина;
		КонецЕсли;
	КонецЕсли;
	Если БылиИзменения тогда
		ОбъектСохраненаяНастройка.Записать();
		УдалитьПользовательскиеНастройки(ОбъектСохраненаяНастройка.Ссылка);
	КонецЕсли;
	
	Возврат БылиИзменения;
	
КонецФункции

Процедура УдалитьПользовательскиеНастройки(Ссылка)
	
	ТЗ = "ВЫБРАТЬ
	|	СохраненныеНастройки.Ссылка
	|ИЗ
	|	Справочник.СохраненныеНастройки КАК СохраненныеНастройки
	|ГДЕ
	|	СохраненныеНастройки.ТипНастройки = &ТипНастройки
	|	И СохраненныеНастройки.НастраиваемыйОбъект = &НастраиваемыйОбъект";
		 
	Запрос = Новый Запрос(ТЗ);
	Запрос.УстановитьПараметр("ТипНастройки",  Перечисления.ТипыНастроек.НастройкиПользователяНастройкиОтчета);
	Запрос.УстановитьПараметр("НастраиваемыйОбъект",  Ссылка);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Объект = Выборка.Ссылка.ПолучитьОбъект();
		Объект.Удалить();
	КонецЦикла;
	
КонецПроцедуры


Функция ЗагрузитьНастройкуОтчета(СохраненаяНастройка, Настройка, ОбновлятьЭлемент = ложь, ЗаписыватьЭлемент = истина) Экспорт
	
	БылиИзменения = ложь;
	
	Если СохраненаяНастройка <> Неопределено И СохраненаяНастройка <> Справочники.СохраненныеНастройки.ПустаяСсылка() тогда
		ОбъектСохраненаяНастройка = СохраненаяНастройка.ПолучитьОбъект();
		
		Если СохраненаяНастройка.НастраиваемыйОбъект <> Настройка.НастраиваемыйОбъект тогда
			ОбъектСохраненаяНастройка.НастраиваемыйОбъект = Настройка.НастраиваемыйОбъект;
			БылиИзменения = истина;
		КонецЕсли;
		
		Если СохраненаяНастройка.ТипНастройки <> Перечисления.ТипыНастроек.НастройкиОтчета тогда
			ОбъектСохраненаяНастройка.ТипНастройки = Перечисления.ТипыНастроек.НастройкиОтчета;
			БылиИзменения = истина;
		КонецЕсли;
		
		Если СохраненаяНастройка.Наименование = "" тогда
			ОбъектСохраненаяНастройка.Наименование = Настройка.Наименование;
			БылиИзменения = истина;
		КонецЕсли;
		
		Если СохраненаяНастройка.Описание <> Настройка.Описание тогда
			ОбъектСохраненаяНастройка.Описание = Настройка.Описание;
			БылиИзменения = истина;
		КонецЕсли;
		
		Если СохраненаяНастройка.Пользователи.Количество() = 0 тогда
			НоваяСтрока = ОбъектСохраненаяНастройка.Пользователи.Добавить();
			НоваяСтрока.Пользователь = Справочники.ГруппыПользователей.ВсеПользователи;
			НоваяСтрока.ПравоИзменения = истина;
			БылиИзменения = истина;
		КонецЕсли;
		
		НастройкаТекущая = СохраненаяНастройка.ХранилищеНастроек.Получить();
		Если НастройкаТекущая = Неопределено или НЕ НастройкаТекущая.Свойство("Изменялась", истина) или ОбновлятьЭлемент тогда
			ОбъектСохраненаяНастройка.ХранилищеНастроек = Новый ХранилищеЗначения(Настройка.ХранилищеНастроек.Получить());
			БылиИзменения = истина;
		КонецЕсли;
	КонецЕсли;
	Если БылиИзменения и ЗаписыватьЭлемент тогда
		ОбъектСохраненаяНастройка.Записать();
	КонецЕсли;
	
	Возврат БылиИзменения;
	
КонецФункции


Процедура ПолучитьФайлСНастройкойОтчета(НастройкаОтчета, ТекстовыйДокумент) Экспорт
	
	Настройка = НастройкаОтчета.ХранилищеНастроек.Получить();
	Если Настройка <> Неопределено и Настройка.Свойство("Изменялась") тогда 
		Настройка.Удалить("Изменялась");
	КонецЕсли;
	ТекстовыйДокумент.ДобавитьСтроку("<НАСТРОЙКА_ВАРИАНТА_ОТЧЕТА>");
	Если Настройка <> Неопределено и Настройка.Свойство("Версия") тогда
		ТекстовыйДокумент.ДобавитьСтроку("<ВЕРСИЯ>" + Настройка.Версия + "</ВЕРСИЯ>");
	КонецЕсли;
	ТекстовыйДокумент.ДобавитьСтроку("<НАИМЕНОВАНИЕ>" + НастройкаОтчета.Наименование + "</НАИМЕНОВАНИЕ>");
	ТекстовыйДокумент.ДобавитьСтроку("<ОБЪЕКТ>" + НастройкаОтчета.НастраиваемыйОбъект + "</ОБЪЕКТ>");
	ТекстовыйДокумент.ДобавитьСтроку("<ОПИСАНИЕ>" + НастройкаОтчета.Описание + "</ОПИСАНИЕ>");
	ЗаписьXML = Новый ЗаписьXML();
	ЗаписьXML.УстановитьСтроку();
	ЗаписатьXML(ЗаписьXML, Новый ХранилищеЗначения(Настройка));
	СтрокаXML = ЗаписьXML.Закрыть();
	ТекстовыйДокумент.ДобавитьСтроку("<НАСТРОЙКА>" + СтрокаXML + "</НАСТРОЙКА>");
	ТекстовыйДокумент.ДобавитьСтроку("</НАСТРОЙКА_ВАРИАНТА_ОТЧЕТА>");
	
КонецПроцедуры


Процедура ЗагрузитьНастройкиОтчетов(СписокНастроек, СоответсвиеИмяОтчета = Неопределено, Перезаписать = ложь) Экспорт
	
	Для каждого ЭлементСпискаНастроек из СписокНастроек Цикл
		
		Если СоответсвиеИмяОтчета = Неопределено тогда 
			ИмяОтчета = ПолучитьИмяОтчета(ЭлементСпискаНастроек.Значение)
		Иначе
			ИмяОтчета = СоответсвиеИмяОтчета.Получить(ЭлементСпискаНастроек.Значение);
		КонецЕсли;
		ЗагрузитьНастройкуПредопределенногоЭлемента(ЭлементСпискаНастроек.Значение, ИмяОтчета,,Перезаписать );
		
	КонецЦикла;
	
КонецПроцедуры

Функция ПолучитьИмяОтчета(НазваниеМакета) Экспорт
	СписокНастроек = ПолучитьТаблицуПредопределенныхНастроек();
	СтрокиСписка = СписокНастроек.НайтиСтроки(Новый Структура("Макет", НазваниеМакета));
	ОтчетНазваниеОтчета = "";
	Если СтрокиСписка.Количество()=1 тогда
		НазваниеОтчета = СтрокиСписка[0].Отчет;
	КонецЕсли;
	Возврат НазваниеОтчета;
КонецФункции

Функция ПолучитьТаблицуПредопределенныхНастроек() Экспорт
	
	СписокНастроек = Новый ТаблицаЗначений;
	СписокНастроек.Колонки.Добавить("Макет");
	СписокНастроек.Колонки.Добавить("Представление");
	СписокНастроек.Колонки.Добавить("Отчет");
	СписокНастроек.Колонки.Добавить("ОтчетПредставление");
	
	Запрос = Новый Запрос();
	Запрос.Текст = "ВЫБРАТЬ
	|	СохраненныеНастройки.Ссылка
	|ИЗ
	|	Справочник.СохраненныеНастройки КАК СохраненныеНастройки
	|ГДЕ
	|	СохраненныеНастройки.Предопределенный";
	
	Выборка = Запрос.Выполнить().Выбрать();
	СписокПредопределенныхМакетов = Новый СписокЗначений;
	Пока Выборка.Следующий() Цикл
		СписокПредопределенныхМакетов.Добавить(Справочники.СохраненныеНастройки.ПолучитьИмяПредопределенного(Выборка.Ссылка));
	КонецЦикла;
	
	Для каждого МетаДанныеОтчета из Метаданные.Отчеты Цикл
		Для каждого Макет из МетаДанныеОтчета.Макеты Цикл
			Если Строка(Макет.ТипМакета) <> "ДвоичныеДанные" ИЛИ СписокПредопределенныхМакетов.НайтиПоЗначению(Макет.Имя) = Неопределено тогда
				Продолжить;
			КонецЕсли;
			СтрокаТаб                    = СписокНастроек.Добавить();
			СтрокаТаб.Макет              = Макет.Имя;
			СтрокаТаб.Отчет              = МетаДанныеОтчета.Имя;
			СтрокаТаб.ОтчетПредставление = МетаДанныеОтчета.Синоним;
			СтрокаТаб.Представление      = Макет.Синоним;
		КонецЦикла;
	КонецЦикла;
	
	Возврат СписокНастроек;
	
КонецФункции

Функция ПолучитьИмяФайлаДляНастройки(Знач ИмяФайла, Ссылка) Экспорт
	
	ИмяФайла = СокрЛП(ИмяФайла);
	ИмяФайла = СтрЗаменить(ИмяФайла, "\", "");
	ИмяФайла = СтрЗаменить(ИмяФайла, ":", "");
	ИмяФайла = СтрЗаменить(ИмяФайла, "?", "");
	ИмяФайла = СтрЗаменить(ИмяФайла, "*", "");
	ИмяФайла = СтрЗаменить(ИмяФайла, "/", "");
	ИмяФайла = СтрЗаменить(ИмяФайла, "&", "");
	ИмяФайла = СтрЗаменить(ИмяФайла, """", "");
	ИмяФайла = СтрЗаменить(ИмяФайла, "<", "");
	ИмяФайла = СтрЗаменить(ИмяФайла, ">", "");
	ИмяФайла = СтрЗаменить(ИмяФайла, "|", "");
	
	НазваниеОтчета = Ссылка.НастраиваемыйОбъект;
	НазваниеОтчета = СтрЗаменить(НазваниеОтчета, "ОтчетОбъект.", "");
	ИмяФайла = НазваниеОтчета +"_"+ ИмяФайла;
	
	Возврат ИмяФайла;
КонецФункции

Процедура ПодставитьОтборПоПолюВПанель(ОтчетОбъект, Поле, Значение) Экспорт
	
	ЗначениеНастройкиПанели = ПолучитьЗначенияНастроекПанелиПользователяОбъекта(ОтчетОбъект);
	Если ЗначениеНастройкиПанели = Неопределено тогда
		Возврат;
	КонецЕсли;
	СтруктураОтбора = ЗначениеНастройкиПанели.ДинамическиеОтборы.Получить(Поле);	
	Если СтруктураОтбора <> Неопределено тогда
		Если ТипЗНч(СтруктураОтбора.Значение) = ТипЗнч(Значение) тогда
			СтруктураОтбора.Значение = Значение;
		ИначеЕсли ТипЗнч(СтруктураОтбора.Значение) = Тип("СписокЗначений") и СтруктураОтбора.Значение.Количество() = 0 тогда
			СтруктураОтбора.Значение.Добавить(Значение);
		КонецЕсли;
		СтруктураОтбора.Использование = истина;
	КонецЕсли;
	Если ЗначениеНастройкиПанели.Свойство("ДинамическиеПараметры") тогда
		СтруктураПараметра = ЗначениеНастройкиПанели.ДинамическиеПараметры.Получить(Поле);
		Если СтруктураПараметра <> Неопределено тогда
			Если ТипЗнч(СтруктураПараметра.Значение) = ТипЗнч(Значение) тогда
				СтруктураПараметра.Значение = Значение;
			ИначеЕсли ТипЗнч(СтруктураПараметра.Значение) = Тип("СписокЗначений") и СтруктураПараметра.Значение.Количество() = 0 тогда
				СтруктураПараметра.Значение.Добавить(Значение);
			КонецЕсли;
			СтруктураПараметра.Использование = истина;
		КонецЕсли;
	КонецЕсли;
	ОтчетОбъект.ЗначенияНастроекПанелиПользователя = Новый ХранилищеЗначения(ЗначениеНастройкиПанели);
	
КонецПроцедуры

Процедура ОбновитьПредопределенныеВариантыОтчетов(СписокВариантов = Неопределено, Перезаписать = ложь) Экспорт
	
	СписокНастроек = Новый СписокЗначений;
	СоответсвиеИмяОтчета = Новый Соответствие;
	
	ТаблицаНастроек = ПолучитьТаблицуПредопределенныхНастроек();
	
	Если СписокВариантов = Неопределено тогда
		Для каждого СтрокаТаблицы из ТаблицаНастроек Цикл
			СписокНастроек.Добавить(СтрокаТаблицы.Макет,  "Отчет: " + СтрокаТаблицы.ОтчетПредставление + " - " +  СтрокаТаблицы.Представление);
			СоответсвиеИмяОтчета.Вставить(СтрокаТаблицы.Макет, СтрокаТаблицы.Отчет);
		КонецЦикла;
		СписокНастроек.ОтметитьЭлементы("Выберите варианты отчетов, которые требуется обновить:");
		Кол = СписокНастроек.Количество();
		КолУдаленных = 0;
		Для сч = 0 по Кол-1 Цикл
			Если Не СписокНастроек.Получить(сч - КолУдаленных).Пометка тогда
				СписокНастроек.Удалить(сч - КолУдаленных);
			КонецЕсли;
		КонецЦикла
	Иначе
		Для каждого Вариант из СписокВариантов Цикл
			СтрокаТаблицы = ТаблицаНастроек.Найти(Вариант.Значение, "Макет");
			Если СтрокаТаблицы <> Неопределено тогда
				СписокНастроек.Добавить(СтрокаТаблицы.Макет,  "Отчет: " + СтрокаТаблицы.ОтчетПредставление + " - " +  СтрокаТаблицы.Представление);
				СоответсвиеИмяОтчета.Вставить(СтрокаТаблицы.Макет, СтрокаТаблицы.Отчет);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	ЗагрузитьНастройкиОтчетов(СписокНастроек, СоответсвиеИмяОтчета, Перезаписать)
	
КонецПроцедуры

Процедура ОткрытьФормуРасшифровки(ОтчетОбъект, Заголовок) Экспорт
	
	ФормаРасшифровки = ПолучитьОбщуюФорму("ФормаРасшифровкиАналитическихОтчетов", , );
	ОтчетОбъект.ЗначенияНастроекПанелиПользователя = Неопределено;
	УстановитьПараметрВывода(ОтчетОбъект.КомпоновщикНастроек, "Title", Заголовок);
	ФормаРасшифровки.ОтчетОбъект = ОтчетОбъект;
	ФормаРасшифровки.РежимФормированияОтчета = истина;
	ФормаРасшифровки.Заголовок = Заголовок;
	ФормаРасшифровки.Открыть();
	ФормаРасшифровки.Заголовок = Заголовок;
	ФормаРасшифровки.ОбновитьФорму();
	
КонецПроцедуры

// события элемента управления периодом

Процедура ДействияПанелиДинамическийОтборПериодВыборПриИзменении(ФормаОтчета, Элемент) Экспорт
	
	ПараметрыИсполненияОтчета = Неопределено;
	ПараметрыИсполненияОтчета = ФормаОтчета.ОтчетОбъект.ПолучитьПараметрыИсполненияОтчета();
	
	ДатаКакПериодПодобратьДатуПоТексту(Элемент.Значение, ФормаОтчета.СтандартныйПериод.ДатаНачала, ПараметрыИсполненияОтчета.МинимальныйПериодОтчета);
	ФормаОтчета.СтандартныйПериод.ДатаОкончания = ПолучитьКонецПериода(ФормаОтчета.СтандартныйПериод.ДатаНачала, ПараметрыИсполненияОтчета.МинимальныйПериодОтчета);
	ФормаОтчета.ЭлементыФормы.ДинамическийОтборСтандартныйПериодПользователя.Значение = ФормаОтчета.СтандартныйПериод.Вариант; 
	Элемент.Значение = ПолучитьПредставлениеПериода(ФормаОтчета.СтандартныйПериод.ДатаНачала, ФормаОтчета.СтандартныйПериод.ДатаОкончания, ПараметрыИсполненияОтчета.МинимальныйПериодОтчета);
	
КонецПроцедуры

Процедура ДействияПанелиДинамическийОтборПериодВыборПриНачалеВыбораИзСписка(ФормаОтчета, Элемент, СтандартнаяОбработка) Экспорт
	
	
	ПараметрыИсполненияОтчета = Неопределено;
	ПараметрыИсполненияОтчета = ФормаОтчета.ОтчетОбъект.ПолучитьПараметрыИсполненияОтчета();
	
	НачалоВыбораИзСпискаПредставленияПериода(Элемент, СтандартнаяОбработка, ФормаОтчета.СтандартныйПериод.ДатаНачала, ФормаОтчета, ПараметрыИсполненияОтчета.МинимальныйПериодОтчета);	
	ФормаОтчета.СтандартныйПериод.ДатаОкончания = ПолучитьКонецПериода(ФормаОтчета.СтандартныйПериод.ДатаНачала, ПараметрыИсполненияОтчета.МинимальныйПериодОтчета);
	ФормаОтчета.ЭлементыФормы.ДинамическийОтборСтандартныйПериодПользователя.Значение = ФормаОтчета.СтандартныйПериод.Вариант; 
	
КонецПроцедуры

Процедура ДействияПанелиДинамическийОтборПериодВыборАвтоПодборТекста(ФормаОтчета, Элемент, Текст, ТекстАвтоПодбора, СтандартнаяОбработка) Экспорт
	
	ПараметрыИсполненияОтчета = Неопределено;
	ПараметрыИсполненияОтчета = ФормаОтчета.ОтчетОбъект.ПолучитьПараметрыИсполненияОтчета();
	
	ДатаКакПериодАвтоПодборТекста(Текст, ТекстАвтоПодбора, СтандартнаяОбработка, ПараметрыИсполненияОтчета.МинимальныйПериодОтчета);
	
КонецПроцедуры

Процедура ДействияПанелиДинамическийОтборПериодВыборОчистка(ФормаОтчета, Элемент, СтандартнаяОбработка) Экспорт
	
	СтандартнаяОбработка = ложь;
	
КонецПроцедуры

Процедура ДействияПанелиДинамическийОтборПериодВыборОкончаниеВводаТекстаОкончаниеВводаТекста(ФормаОтчета, Элемент, Текст, Значение, СтандартнаяОбработка) Экспорт
	
	ПараметрыИсполненияОтчета = Неопределено;
	ПараметрыИсполненияОтчета = ФормаОтчета.ОтчетОбъект.ПолучитьПараметрыИсполненияОтчета();
	
	ДатаКакПериодОкончаниеВводаТекста(Текст, Значение, СтандартнаяОбработка, ПараметрыИсполненияОтчета.МинимальныйПериодОтчета );
	
КонецПроцедуры   

Функция ПолучитьКонецПериода(ДатаНачала, МинимальныйПериод)
	
	Если ВРЕГ(МинимальныйПериод) = "МЕСЯЦ" тогда
		Возврат КонецМесяца(ДатаНачала);
	ИначеЕсли ВРЕГ(МинимальныйПериод) = "КВАРТАЛ" тогда
		Возврат КонецКвартала(ДатаНачала);
	ИначеЕсли ВРЕГ(МинимальныйПериод) = "ГОД" тогда
		Возврат КонецГода(ДатаНачала);
	КонецЕсли;
	
КонецФункции

Функция ДатаКакПериодПодобратьДатуПоТексту(Текст, ДатаПоТексту = НеОпределено, МинимальныйПериод) Экспорт
	СписокВозврата = Новый СписокЗначений;
	ТекущийГод = Год(ТекущаяДата());
	
	Если ПустаяСтрока(Текст) Тогда
		Возврат СписокВозврата;
	КонецЕсли;
	Если Найти(Текст, ".") <> 0 Тогда
		Подстроки = РазложитьСтрокуВМассивПодстрок(Текст, ".");
	ИначеЕсли Найти(Текст, ",") <> 0 Тогда
		Подстроки = РазложитьСтрокуВМассивПодстрок(Текст, ",");
	ИначеЕсли Найти(Текст, "-") <> 0 Тогда
		Подстроки = РазложитьСтрокуВМассивПодстрок(Текст, "-");
	ИначеЕсли Найти(Текст, "/") <> 0 Тогда
		Подстроки = РазложитьСтрокуВМассивПодстрок(Текст, "/");
	ИначеЕсли Найти(Текст, "\") <> 0 Тогда
		Подстроки = РазложитьСтрокуВМассивПодстрок(Текст, "\");
	Иначе
		Подстроки = РазложитьСтрокуВМассивПодстрок(Текст, " ");
	КонецЕсли;
	
	
	Если Подстроки.Количество() = 1 Тогда
		
		Если ВРЕГ(МинимальныйПериод) = "МЕСЯЦ" тогда
			// единственное слово - пытаемся получить месяц
			Если ТолькоЦифрыВСтроке(Текст) Тогда
				МесяцЧислом = Число(Текст);
				Если МесяцЧислом >= 1 и МесяцЧислом <=12 Тогда
					ДатаПоТексту = Дата(ТекущийГод, МесяцЧислом, 1);
					Если СтрДлина(Текст) = 1 Тогда
						СписокВозврата.Добавить(Формат(ДатаПоТексту, "ДФ='М/гг'"));
					Иначе
						СписокВозврата.Добавить(Формат(ДатаПоТексту, "ДФ='ММ/гг'"));
					КонецЕсли;
				Иначе
					Возврат СписокВозврата;
				КонецЕсли;                
			Иначе
				СписокМесяцев = СписокМесяцевПоСтроке(Текст);
				Для Каждого Месяц Из СписокМесяцев Цикл
					ДатаПоТексту = Дата(ТекущийГод, Месяц, 1);
					СписокВозврата.Добавить(Формат(ДатаПоТексту, "ДФ='ММММ гг'"));
				КонецЦикла;
			КонецЕсли;
		ИначеЕсли ВРЕГ(МинимальныйПериод) = "КВАРТАЛ" тогда
			Если ТолькоЦифрыВСтроке(Текст) Тогда
				КварталЧислом = Число(Текст);
				Если КварталЧислом >= 1 и КварталЧислом <=4 Тогда
					ДатаПоТексту = Дата(ТекущийГод, (КварталЧислом-1)*3+1, 1);
					СписокВозврата.Добавить("" + КварталЧислом + " квартал " + Формат(ТекущийГод, "ЧГ=0"));
				Иначе
					Возврат СписокВозврата;
				КонецЕсли;                
			Иначе
				СписокКварталов = СписокКварталовПоСтроке(Текст);
				Для Каждого Квартал Из СписокКварталов Цикл
					ДатаПоТексту = Дата(ТекущийГод, Квартал*3 - 2, 1);
					СписокВозврата.Добавить("" + Квартал + " квартал " + Формат(ТекущийГод, "ЧГ=0"));
				КонецЦикла;
			КонецЕсли;
		ИначеЕсли ВРЕГ(МинимальныйПериод) = "ГОД" тогда
			Если ТолькоЦифрыВСтроке(Текст) Тогда
				ГодЧислом = Число(Текст);
				ГодБезСтолетия = ТекущийГод - Цел(ТекущийГод/100)*100;
				Если ГодЧислом >= 0 и ГодЧислом <=9 тогда
					Если ГодЧислом <= ГодБезСтолетия  Тогда
						Год = Цел(ТекущийГод/100)*100+ГодЧислом;
					Иначе
						Год = Цел(ТекущийГод/10)*10+ГодЧислом;
					КонецЕсли;
					ДатаПоТексту = Дата(Год, 1, 1);
					СписокВозврата.Добавить(Формат(ТекущийГод, "ЧГ=0"));
				ИначеЕсли ГодЧислом >= 10 и ГодЧислом <=99 тогда
					Если ГодЧислом >= ГодБезСтолетия-10 и ГодЧислом <= ГодБезСтолетия + 15 Тогда
						Год = Цел(ТекущийГод/100)*100+ГодЧислом;
					Иначе
						Год = (Цел(ТекущийГод/100)-1)*100 + ГодЧислом;
					КонецЕсли;
					ДатаПоТексту = Дата(Год, 1, 1);
					СписокВозврата.Добавить(Формат(ТекущийГод, "ЧГ=0"));
				Иначе
					Возврат СписокВозврата;
				КонецЕсли;                
			КонецЕсли;
		КонецЕсли;
	ИначеЕсли Подстроки.Количество() = 2 Тогда
		Если ВРЕГ(МинимальныйПериод) = "МЕСЯЦ" тогда
			// два слова - первое считаем месяцем, второе - годом
			Если ТолькоЦифрыВСтроке(Подстроки[1]) Тогда
				Если ПустаяСтрока(Подстроки[1]) Тогда
					ГодЧислом = 0;
					Подстроки[1] = "0";
					ТекстВозврата = Текст + "0";
				Иначе
					ГодЧислом = Число(Подстроки[1]);
					ТекстВозврата = "";
				КонецЕсли;
				Если ГодЧислом > 3000 Тогда
					Возврат СписокВозврата;
				КонецЕсли;
				Если СтрДлина(Подстроки[1]) <= 1 Тогда
					ГодЧислом = Число(Лев(Формат(ТекущийГод, "ЧГ="), 3) + Подстроки[1]);
					СтрокаФорматированияГода = "г";
				ИначеЕсли СтрДлина(Подстроки[1]) = 2 Тогда
					ГодЧислом = Число(Лев(Формат(ТекущийГод, "ЧГ="), 2) + Подстроки[1]);
					СтрокаФорматированияГода = "гг";
				ИначеЕсли СтрДлина(Подстроки[1]) = 3 Тогда
					ГодЧислом = Число(Лев(Формат(ТекущийГод, "ЧГ="), 1) + Подстроки[1]);
					СтрокаФорматированияГода = "гггг";
				КонецЕсли;                    
			Иначе
				// второе слово может быть только годом
				Возврат СписокВозврата;
			КонецЕсли;                
			Если ЗначениеЗаполнено(Подстроки[0]) И ТолькоЦифрыВСтроке(Подстроки[0]) Тогда
				МесяцЧислом = Число(Подстроки[0]);
				Если МесяцЧислом >= 1 и МесяцЧислом <= 12 Тогда
					// если "правильный" месяц и год
					ДатаПоТексту = Дата(ГодЧислом, МесяцЧислом, 1);
					СписокВозврата.Добавить(ТекстВозврата);
				Иначе
					Возврат СписокВозврата;
				КонецЕсли;                
			Иначе
				СписокМесяцев = СписокМесяцевПоСтроке(Подстроки[0]);
				Если СписокМесяцев.Количество() = 1 Тогда
					ДатаПоТексту = Дата(ГодЧислом, СписокМесяцев[0], 1);
					СписокВозврата.Добавить("");
				Иначе
					Для Каждого Месяц Из СписокМесяцев Цикл
						ДатаПоТексту = Дата(ГодЧислом, Месяц, 1);
						СписокВозврата.Добавить(Формат(Дата(ГодЧислом, Месяц, 1), "ДФ='ММММ гг'"));
					КонецЦикла;
				КонецЕсли;
			КонецЕсли;
		ИначеЕсли ВРЕГ(МинимальныйПериод) = "КВАРТАЛ" тогда
			// два слова - первое считаем месяцем, второе - годом
			Если ТолькоЦифрыВСтроке(Подстроки[1]) Тогда
				Если ПустаяСтрока(Подстроки[1]) Тогда
					ГодЧислом = 0;
					Подстроки[1] = "0";
					ТекстВозврата = Текст + "0";
				Иначе
					ГодЧислом = Число(Подстроки[1]);
					ТекстВозврата = "";
				КонецЕсли;
				Если ГодЧислом > 3000 Тогда
					Возврат СписокВозврата;
				КонецЕсли;
				Если СтрДлина(Подстроки[1]) <= 1 Тогда
					ГодЧислом = Число(Лев(Формат(ТекущийГод, "ЧГ="), 3) + Подстроки[1]);
					СтрокаФорматированияГода = "г";
				ИначеЕсли СтрДлина(Подстроки[1]) = 2 Тогда
					ГодЧислом = Число(Лев(Формат(ТекущийГод, "ЧГ="), 2) + Подстроки[1]);
					СтрокаФорматированияГода = "гг";
				ИначеЕсли СтрДлина(Подстроки[1]) = 3 Тогда
					ГодЧислом = Число(Лев(Формат(ТекущийГод, "ЧГ="), 1) + Подстроки[1]);
					СтрокаФорматированияГода = "гггг";
				КонецЕсли;                    
			Иначе
				// Если второе не не содержит первой буквы к и строка то ввели что-то непонятное
				Если Найти(ВРЕГ(Подстроки[1]),"К") <> 1 тогда
					Возврат СписокВозврата;
				КонецЕсли;
			КонецЕсли;                
			Если ЗначениеЗаполнено(Подстроки[0]) И ТолькоЦифрыВСтроке(Подстроки[0]) Тогда
				КварталЧислом = Число(Подстроки[0]);
				Если КварталЧислом >= 1 и КварталЧислом <= 4 Тогда
					// если "правильный" месяц и год
					ДатаПоТексту = Дата(ГодЧислом, КварталЧислом*3-2, 1);
					СписокВозврата.Добавить(ТекстВозврата);
				Иначе
					Возврат СписокВозврата;
				КонецЕсли;                
			Иначе
				СписокКварталов = СписокКварталовПоСтроке(Подстроки[0]);
				Если СписокКварталов.Количество() = 1 Тогда
					ДатаПоТексту = Дата(ГодЧислом, СписокКварталов[0], 1);
					СписокВозврата.Добавить("");
				Иначе
					Для Каждого Квартал Из СписокКварталов Цикл
						ДатаПоТексту = Дата(ГодЧислом, Квартал*3-2, 1);
						СписокВозврата.Добавить("" + Квартал + " квартал " + Формат(ГодЧислом, "ЧГ=0"));
					КонецЦикла;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	ИначеЕсли Подстроки.Количество() = 3 Тогда
		Если ВРЕГ(МинимальныйПериод) = "КВАРТАЛ" тогда
			// три слова - первое считаем квартал, второе - "квартал", третье - годом
			Если ТолькоЦифрыВСтроке(Подстроки[2]) Тогда
				Если ПустаяСтрока(Подстроки[2]) Тогда
					ГодЧислом = 0;
					Подстроки[2] = "0";
					ТекстВозврата = Текст + "0";
				Иначе
					ГодЧислом = Число(Подстроки[2]);
					ТекстВозврата = "";
				КонецЕсли;
				Если ГодЧислом > 3000 Тогда
					Возврат СписокВозврата;
				КонецЕсли;
				Если СтрДлина(Подстроки[2]) <= 1 Тогда
					ГодЧислом = Число(Лев(Формат(ТекущийГод, "ЧГ="), 3) + Подстроки[2]);
					СтрокаФорматированияГода = "г";
				ИначеЕсли СтрДлина(Подстроки[2]) = 2 Тогда
					ГодЧислом = Число(Лев(Формат(ТекущийГод, "ЧГ="), 2) + Подстроки[2]);
					СтрокаФорматированияГода = "гг";
				ИначеЕсли СтрДлина(Подстроки[2]) = 3 Тогда
					ГодЧислом = Число(Лев(Формат(ТекущийГод, "ЧГ="), 1) + Подстроки[2]);
					СтрокаФорматированияГода = "гггг";
				КонецЕсли;                    
			Иначе
				Возврат СписокВозврата;
			КонецЕсли; 
			
			Если Найти(ВРЕГ(Подстроки[1]),"К") <> 1 тогда
				Возврат СписокВозврата;
			КонецЕсли;
			
			Если ЗначениеЗаполнено(Подстроки[0]) И ТолькоЦифрыВСтроке(Подстроки[0]) Тогда
				КварталЧислом = Число(Подстроки[0]);
				Если КварталЧислом >= 1 и КварталЧислом <= 4 Тогда
					// если "правильный" месяц и год
					ДатаПоТексту = Дата(ГодЧислом, КварталЧислом*3-2, 1);
					СписокВозврата.Добавить(ТекстВозврата);
				Иначе
					Возврат СписокВозврата;
				КонецЕсли;                
			Иначе
				СписокКварталов = СписокКварталовПоСтроке(Подстроки[0]);
				Если СписокКварталов.Количество() = 1 Тогда
					ДатаПоТексту = Дата(ГодЧислом, СписокКварталов[0], 1);
					СписокВозврата.Добавить("");
				Иначе
					Для Каждого Квартал Из СписокКварталов Цикл
						ДатаПоТексту = Дата(ГодЧислом, Квартал*3-2, 1);
						СписокВозврата.Добавить("" + Квартал + " квартал " + Формат(ГодЧислом, "ЧГ=0"));
					КонецЦикла;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	Возврат СписокВозврата;
КонецФункции

Процедура НачалоВыбораИзСпискаПредставленияПериода(Элемент, СтандартнаяОбработка, Период, ЭтаФорма, МинимальныйПериод, НачальноеЗначение = Неопределено)
	
	СтандартнаяОбработка = Ложь;
	
	Если НачальноеЗначение = Неопределено Тогда
		НачальноеЗначение = Период;
	КонецЕсли; 
	
	СписокВыбора = Новый СписокЗначений;
	НачалоТекущегоГода = НачалоГода(НачальноеЗначение);
	Если ВРЕГ(МинимальныйПериод) = "ГОД" тогда
		НачалоПрошлогоГода = НачалоГода(ДобавитьМесяц(НачалоТекущегоГода, -36))-1;
		СписокВыбора.Добавить(НачалоПрошлогоГода, (Формат(НачалоПрошлогоГода-1, "ДФ='yyyy'") + "..."));
	Иначе	
		НачалоПрошлогоГода = КонецГода(НачалоТекущегоГода - 1);
		СписокВыбора.Добавить(НачалоПрошлогоГода, (Формат(НачалоПрошлогоГода, "ДФ='yyyy'") + "..."));
	КонецЕсли;
		
	НачалоМесяцаЗаполнения = НачалоПрошлогоГода+1;
	ЭлементПоУмолчанию = Неопределено;
	
	Если ВРЕГ(МинимальныйПериод) = "МЕСЯЦ" тогда
		Для а = 1 По 12 Цикл
			ДобавленныйЭлемент = СписокВыбора.Добавить(НачалоМесяцаЗаполнения, ПолучитьПредставлениеПериода(НачалоМесяцаЗаполнения, , МинимальныйПериод));
			Если НачальноеЗначение = НачалоМесяцаЗаполнения Тогда
				ЭлементПоУмолчанию = ДобавленныйЭлемент;
			КонецЕсли; 
			НачалоМесяцаЗаполнения = ДобавитьМесяц(НачалоМесяцаЗаполнения, 1);
		КонецЦикла;
		НачалоСледующегоГода = КонецГода(НачалоТекущегоГода) + 1;
	ИначеЕсли ВРЕГ(МинимальныйПериод) = "КВАРТАЛ" тогда
		Для а = 1 По 4 Цикл
			ДобавленныйЭлемент = СписокВыбора.Добавить(НачалоМесяцаЗаполнения, ПолучитьПредставлениеПериода(НачалоМесяцаЗаполнения, , МинимальныйПериод));
			Если НачальноеЗначение = НачалоМесяцаЗаполнения Тогда
				ЭлементПоУмолчанию = ДобавленныйЭлемент;
			КонецЕсли; 
			НачалоМесяцаЗаполнения = ДобавитьМесяц(НачалоМесяцаЗаполнения, 3);
		КонецЦикла;
		НачалоСледующегоГода = КонецГода(НачалоТекущегоГода) + 1;
	ИначеЕсли ВРЕГ(МинимальныйПериод) = "ГОД" тогда
		Для а = 1 По 6 Цикл
			ДобавленныйЭлемент = СписокВыбора.Добавить(НачалоМесяцаЗаполнения, ПолучитьПредставлениеПериода(НачалоМесяцаЗаполнения, , МинимальныйПериод));
			Если НачальноеЗначение = НачалоМесяцаЗаполнения Тогда
				ЭлементПоУмолчанию = ДобавленныйЭлемент;
			КонецЕсли; 
			НачалоМесяцаЗаполнения = ДобавитьМесяц(НачалоМесяцаЗаполнения, 12);
		КонецЦикла;
		НачалоСледующегоГода = КонецГода(ДобавитьМесяц(НачалоМесяцаЗаполнения, -12)) + 1;
	КонецЕсли;
	
	СписокВыбора.Добавить(НачалоСледующегоГода, (Формат(НачалоСледующегоГода, "ДФ='yyyy'") + "..."));
	
	ВыбранныйЭлемент = ЭтаФорма.ВыбратьИзСписка(СписокВыбора, Элемент, ЭлементПоУмолчанию);
	
	Если ВыбранныйЭлемент = Неопределено Тогда
		Возврат;
	ИначеЕсли ВРЕГ(МинимальныйПериод) = "ГОД" тогда
		Если  Год(ВыбранныйЭлемент.Значение) = Год(НачалоПрошлогоГода) тогда
			НачалоВыбораИзСпискаПредставленияПериода(Элемент, СтандартнаяОбработка, Период, ЭтаФорма, МинимальныйПериод, ДобавитьМесяц(ВыбранныйЭлемент.Значение, -24));
			Возврат;
		ИначеЕсли Год(ВыбранныйЭлемент.Значение) = Год(НачалоСледующегоГода) тогда
			НачалоВыбораИзСпискаПредставленияПериода(Элемент, СтандартнаяОбработка, Период, ЭтаФорма, МинимальныйПериод, ДобавитьМесяц(ВыбранныйЭлемент.Значение, +36));
			Возврат;
		КонецЕсли;
	Иначе
		Если Год(ВыбранныйЭлемент.Значение) <> Год(НачальноеЗначение) Тогда
			НачалоВыбораИзСпискаПредставленияПериода(Элемент, СтандартнаяОбработка, Период, ЭтаФорма, МинимальныйПериод, ВыбранныйЭлемент.Значение);
			Возврат;
		КонецЕсли;
	КонецЕсли;
	
	Период           = ВыбранныйЭлемент.Значение;
	Элемент.Значение = ПолучитьПредставлениеПериода(Период, , МинимальныйПериод);
	
КонецПроцедуры

Функция СписокМесяцевПоСтроке(Текст)
	
	СписокМесяцев = Новый СписокЗначений;
	Месяцы = Новый Соответствие;
	МесяцыВозврата = Новый Массив;
	
	Для Счетчик = 1 По 12 Цикл
		Представление = Формат(Дата(2000, Счетчик, 1), "ДФ='ММММ'");
		СписокМесяцев.Добавить(Счетчик, Представление);
		Представление = Формат(Дата(2000, Счетчик, 1), "ДФ='МММ'");
		СписокМесяцев.Добавить(Счетчик, Представление);
	КонецЦикла;
	
	Для Каждого ЭлементСписка Из СписокМесяцев Цикл
		Если ВРег(Текст) = ВРег(Лев(ЭлементСписка.Представление, СтрДлина(Текст))) Тогда
			Месяцы[ЭлементСписка.Значение] = 0;
		КонецЕсли;
	КонецЦикла;
	
	Для Каждого Элемент Из Месяцы Цикл
		МесяцыВозврата.Добавить(Элемент.Ключ);
	КонецЦикла;
	
	Возврат МесяцыВозврата;
	
КонецФункции

Функция СписокКварталовПоСтроке(Текст)
	
	СписокМесяцев = Новый СписокЗначений;
	Кварталы = Новый Соответствие;
	МесяцыВозврата = Новый Массив;
	
	Для Счетчик = 1 По 4 Цикл
		Представление = "" + Счетчик + "квартал";
		СписокМесяцев.Добавить(Счетчик, Представление);
		Представление = "" + Счетчик + "кв";
		СписокМесяцев.Добавить(Счетчик, Представление);
	КонецЦикла;
	
	Для Каждого ЭлементСписка Из СписокМесяцев Цикл
		Если ВРег(Текст) = ВРег(Лев(ЭлементСписка.Представление, СтрДлина(Текст))) Тогда
			Кварталы[ЭлементСписка.Значение] = 0;
		КонецЕсли;
	КонецЦикла;
	
	Для Каждого Элемент Из Кварталы Цикл
		МесяцыВозврата.Добавить(Элемент.Ключ);
	КонецЦикла;
	
	Возврат МесяцыВозврата;
	
КонецФункции


Функция ПолучитьПредставлениеПериода(ДатаНачала, ДатаОкончания, МинимальныйПериод)
	
	НачалоПериода = ДатаНачала;
	Если ВРЕГ(МинимальныйПериод) = "МЕСЯЦ" тогда
		НачалоПериода = НачалоМесяца(ДатаНачала);
	ИначеЕсли ВРЕГ(МинимальныйПериод) = "КВАРТАЛ" тогда
		НачалоПериода = НачалоКвартала(ДатаНачала);
	ИначеЕсли ВРЕГ(МинимальныйПериод) = "ГОД" тогда
		НачалоПериода = НачалоГода(ДатаНачала);
	КонецЕсли;

	Если ДатаОкончания <> Неопределено и (ПолучитьКонецПериода(ДатаНачала, МинимальныйПериод) <> КонецДня(ДатаОкончания) или ДатаНачала <> НачалоПериода) тогда
		Возврат Формат(ДатаНачала, "ДФ=dd.MM.yy") + " - " + Формат(ДатаОкончания, "ДФ=dd.MM.yy")
	Иначе
		Если ВРЕГ(МинимальныйПериод) = "МЕСЯЦ" тогда
			Возврат Формат(ДатаНачала, "ДФ='MMMM yyyy'");
		ИначеЕсли ВРЕГ(МинимальныйПериод) = "КВАРТАЛ" тогда
			Квартал = Цел((Месяц(ДатаНачала)-1)/3) + 1;
			Возврат "" + Квартал + " квартал " + Формат(ДатаНачала, "ДФ=yyyy");
		ИначеЕсли ВРЕГ(МинимальныйПериод) = "ГОД" тогда
			Возврат Формат(ДатаНачала, "ДФ='yyyy'");
		КонецЕсли;
	КонецЕсли;
	
КонецФункции
	
Функция РазложитьСтрокуВМассивПодстрок(Знач Стр, Разделитель = ",")
	
	МассивСтрок = Новый Массив();
	Если Разделитель = " " Тогда
		Стр = СокрЛП(Стр);
		Пока 1=1 Цикл
			Поз = Найти(Стр,Разделитель);
			Если Поз=0 Тогда
				МассивСтрок.Добавить(Стр);
				Возврат МассивСтрок;
			КонецЕсли;
			МассивСтрок.Добавить(Лев(Стр,Поз-1));
			Стр = СокрЛ(Сред(Стр,Поз));
		КонецЦикла;
	Иначе
		ДлинаРазделителя = СтрДлина(Разделитель);
		Пока 1=1 Цикл
			Поз = Найти(Стр,Разделитель);
			Если Поз=0 Тогда
				МассивСтрок.Добавить(Стр);
				Возврат МассивСтрок;
			КонецЕсли;
			МассивСтрок.Добавить(Лев(Стр,Поз-1));
			Стр = Сред(Стр,Поз+ДлинаРазделителя);
		КонецЦикла;
	КонецЕсли;
	
КонецФункции // глРазложить

Функция ТолькоЦифрыВСтроке(Знач СтрокаПроверки, УчитыватьЛидирующиеНули = Истина, УчитыватьПробелы = Истина)
	
	Если ТипЗнч(СтрокаПроверки) <> Тип("Строка") Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(СтрокаПроверки) Тогда
		Возврат Истина;
	КонецЕсли; 
	
	Если НЕ УчитыватьПробелы Тогда
		СтрокаПроверки = СтрЗаменить(СтрокаПроверки, " ", "");
	КонецЕсли;
	
	Если НЕ УчитыватьЛидирующиеНули Тогда
		НомерПервойЦифры = 0;
		Для а = 1 По СтрДлина(СтрокаПроверки) Цикл
			НомерПервойЦифры = НомерПервойЦифры + 1;
			КодСимвола = КодСимвола(Сред(СтрокаПроверки, а, 1));
			Если КодСимвола <> 48 Тогда
				Прервать;
			КонецЕсли;
		КонецЦикла;
		СтрокаПроверки = Сред(СтрокаПроверки, НомерПервойЦифры);
	КонецЕсли;
	
	Для а = 1 По СтрДлина(СтрокаПроверки) Цикл
		КодСимвола = КодСимвола(Сред(СтрокаПроверки, а, 1));
		Если НЕ (КодСимвола >= 48 И КодСимвола <= 57) Тогда
			Возврат Ложь;
		КонецЕсли; 
	КонецЦикла; 

	Возврат Истина;
	
КонецФункции

Процедура ДатаКакПериодАвтоПодборТекста(Текст, ТекстАвтоПодбора, СтандартнаяОбработка, МинимальныйПериодОтчета)
	
	Список = ДатаКакПериодПодобратьДатуПоТексту(Текст, , МинимальныйПериодОтчета);
	Если Список.Количество() = 1 Тогда
		ТекстАвтоПодбора = Список[0].Значение;
	КонецЕсли;
	СтандартнаяОбработка = Ложь;
	
КонецПроцедуры

Процедура ДатаКакПериодОкончаниеВводаТекста(Текст, Значение, СтандартнаяОбработка, МинимальныйПериодОтчета)
	
	Список = ДатаКакПериодПодобратьДатуПоТексту(Текст, , МинимальныйПериодОтчета);
	Если Список.Количество() = 1 Тогда
		Значение = Текст;
	Иначе
		Значение = Список;
	КонецЕсли;
	СтандартнаяОбработка = Ложь;
	
КонецПроцедуры


Процедура ДействияПанелиСтандартныйПериодПользователяПриИзменении(ФормаОтчета, Элемент) Экспорт
	
	ПараметрыИсполненияОтчета = Неопределено;
	ПараметрыИсполненияОтчета = ФормаОтчета.ОтчетОбъект.ПолучитьПараметрыИсполненияОтчета();
	
	ФормаОтчета.СтандартныйПериод.Вариант = ?(Элемент.Значение = Неопределено, ВариантСтандартногоПериода.ПроизвольныйПериод, Элемент.Значение);
	Если ПараметрыИсполненияОтчета <> Неопределено и ПараметрыИсполненияОтчета.Свойство("МинимальныйПериодОтчета") тогда
		ФормаОтчета.ЭлементыФормы.ДинамическийОтборПериодВыбор.Значение = ПолучитьПредставлениеПериода(ФормаОтчета.СтандартныйПериод.ДатаНачала, ФормаОтчета.СтандартныйПериод.ДатаОкончания, ПараметрыИсполненияОтчета.МинимальныйПериодОтчета);
	КонецЕсли;

КонецПроцедуры