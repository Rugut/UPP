////////////////////////////////////////////////////////////////////////////////
// ПЕРЕМЕННЫЕ МОДУЛЯ

Перем мДлинаСуток;

////////////////////////////////////////////////////////////////////////////////
// ЭКСПОРТНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ

// Возвращает доступные варианты печати документа
//
// Возвращаемое значение:
//  Структура, каждая строка которой соответствует одному из вариантов печати
//  
Функция ПолучитьСтруктуруПечатныхФорм() Экспорт
	
	СтруктураПечатныхФорм = Новый Структура;
	
	Возврат СтруктураПечатныхФорм;

КонецФункции // ПолучитьСтруктуруПечатныхФорм()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ДЛЯ ОБЕСПЕЧЕНИЯ ПРОВЕДЕНИЯ ДОКУМЕНТА

// Формирует запрос по шапке документа
//
// Параметры: 
//  Режим - режим проведения
//
// Возвращаемое значение:
//  Результат запроса
//
Функция СформироватьЗапросПоШапке(Режим)

	Запрос = Новый Запрос;

	// Установим параметры запроса
	Запрос.УстановитьПараметр("ДокументСсылка",		Ссылка);
	Запрос.УстановитьПараметр("ПустаяОрганизация",	Справочники.Организации.ПустаяСсылка());
	
	Если Действие = 0 Или Действие = 1 Тогда
		ТаблицаВР = "ОсновныеНачисленияОрганизаций";
	Иначе
		ТаблицаВР = "УдержанияОрганизаций";
	КонецЕсли;
	
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации.ВидРасчета КАК ВидРасчета,
	|	МАКСИМУМ(Показатели.НомерСтроки) КАК КоличествоПоказателей,
	|	Показатели1.Показатель.Предопределенный КАК Показатель1Предопределенный,
	|	Показатели1.Показатель.Наименование КАК Показатель1Наименование,
	|	Показатели1.Показатель.ТипПоказателя КАК Показатель1ТипПоказателя,
	|	Показатели1.Показатель.ВозможностьИзменения КАК Показатель1ВозможностьИзменения,
	|	Показатели2.Показатель.Предопределенный КАК Показатель2Предопределенный,
	|	Показатели2.Показатель.Наименование КАК Показатель2Наименование,
	|	Показатели2.Показатель.ТипПоказателя КАК Показатель2ТипПоказателя,
	|	Показатели2.Показатель.ВозможностьИзменения КАК Показатель2ВозможностьИзменения,
	|	Показатели3.Показатель.Предопределенный КАК Показатель3Предопределенный,
	|	Показатели3.Показатель.Наименование КАК Показатель3Наименование,
	|	Показатели3.Показатель.ТипПоказателя КАК Показатель3ТипПоказателя,
	|	Показатели3.Показатель.ВозможностьИзменения КАК Показатель3ВозможностьИзменения,
	|	Показатели4.Показатель.Предопределенный КАК Показатель4Предопределенный,
	|	Показатели4.Показатель.Наименование КАК Показатель4Наименование,
	|	Показатели4.Показатель.ТипПоказателя КАК Показатель4ТипПоказателя,
	|	Показатели4.Показатель.ВозможностьИзменения КАК Показатель4ВозможностьИзменения,
	|	Показатели5.Показатель.Предопределенный КАК Показатель5Предопределенный,
	|	Показатели5.Показатель.Наименование КАК Показатель5Наименование,
	|	Показатели5.Показатель.ТипПоказателя КАК Показатель5ТипПоказателя,
	|	Показатели5.Показатель.ВозможностьИзменения КАК Показатель5ВозможностьИзменения,
	|	Показатели6.Показатель.Предопределенный КАК Показатель6Предопределенный,
	|	Показатели6.Показатель.Наименование КАК Показатель6Наименование,
	|	Показатели6.Показатель.ТипПоказателя КАК Показатель6ТипПоказателя,
	|	Показатели6.Показатель.ВозможностьИзменения КАК Показатель6ВозможностьИзменения,
	|	Показатели1.ЗапрашиватьПриКадровыхПеремещениях КАК Показатель1ЗапрашиватьПриКадровыхПеремещениях,
	|	Показатели2.ЗапрашиватьПриКадровыхПеремещениях КАК Показатель2ЗапрашиватьПриКадровыхПеремещениях,
	|	Показатели3.ЗапрашиватьПриКадровыхПеремещениях КАК Показатель3ЗапрашиватьПриКадровыхПеремещениях,
	|	Показатели4.ЗапрашиватьПриКадровыхПеремещениях КАК Показатель4ЗапрашиватьПриКадровыхПеремещениях,
	|	Показатели5.ЗапрашиватьПриКадровыхПеремещениях КАК Показатель5ЗапрашиватьПриКадровыхПеремещениях,
	|	Показатели6.ЗапрашиватьПриКадровыхПеремещениях КАК Показатель6ЗапрашиватьПриКадровыхПеремещениях,
	|	Показатели1.Показатель.ТарифнаяСтавка КАК Показатель1ТарифнаяСтавка,
	|	Показатели2.Показатель.ТарифнаяСтавка КАК Показатель2ТарифнаяСтавка,
	|	Показатели3.Показатель.ТарифнаяСтавка КАК Показатель3ТарифнаяСтавка,
	|	Показатели4.Показатель.ТарифнаяСтавка КАК Показатель4ТарифнаяСтавка,
	|	Показатели5.Показатель.ТарифнаяСтавка КАК Показатель5ТарифнаяСтавка,
	|	Показатели6.Показатель.ТарифнаяСтавка КАК Показатель6ТарифнаяСтавка,
	
	|	Показатели1.Показатель.Валюта КАК Валюта1,
	|	Показатели2.Показатель.Валюта КАК Валюта2,
	|	Показатели3.Показатель.Валюта КАК Валюта3,
	|	Показатели4.Показатель.Валюта КАК Валюта4,
	|	Показатели5.Показатель.Валюта КАК Валюта5,
	|	Показатели6.Показатель.Валюта КАК Валюта6
	
	|ПОМЕСТИТЬ ВТПоказатели
	|ИЗ
	|	Документ.ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации КАК ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации
	|		ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовРасчета."+ТаблицаВР+".Показатели КАК Показатели
	|		ПО ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации.ВидРасчета = Показатели.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовРасчета."+ТаблицаВР+".Показатели КАК Показатели1
	|		ПО ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации.ВидРасчета = Показатели1.Ссылка
	|			И (Показатели1.НомерСтроки = 1)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовРасчета."+ТаблицаВР+".Показатели КАК Показатели2
	|		ПО ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации.ВидРасчета = Показатели2.Ссылка
	|			И (Показатели2.НомерСтроки = 2)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовРасчета."+ТаблицаВР+".Показатели КАК Показатели3
	|		ПО ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации.ВидРасчета = Показатели3.Ссылка
	|			И (Показатели3.НомерСтроки = 3)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовРасчета."+ТаблицаВР+".Показатели КАК Показатели4
	|		ПО ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации.ВидРасчета = Показатели4.Ссылка
	|			И (Показатели4.НомерСтроки = 4)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовРасчета."+ТаблицаВР+".Показатели КАК Показатели5
	|		ПО ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации.ВидРасчета = Показатели5.Ссылка
	|			И (Показатели5.НомерСтроки = 5)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовРасчета."+ТаблицаВР+".Показатели КАК Показатели6
	|		ПО ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации.ВидРасчета = Показатели6.Ссылка
	|			И (Показатели6.НомерСтроки = 6)
	|ГДЕ
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации.Ссылка = &ДокументСсылка
	|
	|СГРУППИРОВАТЬ ПО
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации.ВидРасчета,
	|	Показатели1.Показатель,
	|	Показатели2.Показатель,
	|	Показатели3.Показатель,
	|	Показатели4.Показатель,
	|	Показатели5.Показатель,
	|	Показатели6.Показатель,
	|	Показатели1.ЗапрашиватьПриКадровыхПеремещениях,
	|	Показатели2.ЗапрашиватьПриКадровыхПеремещениях,
	|	Показатели3.ЗапрашиватьПриКадровыхПеремещениях,
	|	Показатели4.ЗапрашиватьПриКадровыхПеремещениях,
	|	Показатели5.ЗапрашиватьПриКадровыхПеремещениях,
	|	Показатели6.ЗапрашиватьПриКадровыхПеремещениях,
	|	Показатели1.Показатель.Предопределенный,
	|	Показатели1.Показатель.Наименование,
	|	Показатели1.Показатель.ТипПоказателя,
	|	Показатели1.Показатель.ВозможностьИзменения,
	|	Показатели2.Показатель.Предопределенный,
	|	Показатели2.Показатель.Наименование,
	|	Показатели2.Показатель.ТипПоказателя,
	|	Показатели2.Показатель.ВозможностьИзменения,
	|	Показатели3.Показатель.Предопределенный,
	|	Показатели3.Показатель.Наименование,
	|	Показатели3.Показатель.ТипПоказателя,
	|	Показатели3.Показатель.ВозможностьИзменения,
	|	Показатели4.Показатель.Предопределенный,
	|	Показатели4.Показатель.Наименование,
	|	Показатели4.Показатель.ТипПоказателя,
	|	Показатели4.Показатель.ВозможностьИзменения,
	|	Показатели5.Показатель.Предопределенный,
	|	Показатели5.Показатель.Наименование,
	|	Показатели5.Показатель.ТипПоказателя,
	|	Показатели5.Показатель.ВозможностьИзменения,
	|	Показатели6.Показатель.Предопределенный,
	|	Показатели6.Показатель.Наименование,
	|	Показатели6.Показатель.ТипПоказателя,
	|	Показатели6.Показатель.ВозможностьИзменения,
	|	Показатели1.Показатель.ТарифнаяСтавка,
	|	Показатели2.Показатель.ТарифнаяСтавка,
	|	Показатели3.Показатель.ТарифнаяСтавка,
	|	Показатели4.Показатель.ТарифнаяСтавка,
	|	Показатели5.Показатель.ТарифнаяСтавка,
	|	Показатели6.Показатель.ТарифнаяСтавка,
	|	Показатели1.Показатель.Валюта,
	|	Показатели2.Показатель.Валюта,
	|	Показатели3.Показатель.Валюта,
	|	Показатели4.Показатель.Валюта,
	|	Показатели5.Показатель.Валюта,
	|	Показатели6.Показатель.Валюта
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ВидРасчета
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации.Дата,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации.Организация,
	|	ВЫБОР
	|		КОГДА ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации.Организация.ГоловнаяОрганизация = &ПустаяОрганизация
	|			ТОГДА ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации.Организация
	|		ИНАЧЕ ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации.Организация.ГоловнаяОрганизация
	|	КОНЕЦ КАК ГоловнаяОрганизация,
	|	ЕСТЬNULL(ПоказателиНачисления.КоличествоПоказателей, 0) КАК КоличествоПоказателейНачисления,
	|	ЕСТЬNULL(ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации.ВидРасчета.ЗачетОтработанногоВремени, Ложь) КАК ОсновноеНачисление,
	|	ВЫБОР
	|		КОГДА ПоказателиНачисления.КоличествоПоказателей > 0
	|			ТОГДА ПоказателиНачисления.КоличествоПоказателей
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК КоличествоПоказателей,
	|	ПоказателиНачисления.Показатель1Предопределенный,
	|	ПоказателиНачисления.Показатель1Наименование,
	|	ПоказателиНачисления.Показатель1ТипПоказателя,
	|	ПоказателиНачисления.Показатель1ВозможностьИзменения,
	|	ПоказателиНачисления.Показатель2Предопределенный,
	|	ПоказателиНачисления.Показатель2Наименование,
	|	ПоказателиНачисления.Показатель2ТипПоказателя,
	|	ПоказателиНачисления.Показатель2ВозможностьИзменения,
	|	ПоказателиНачисления.Показатель3Предопределенный,
	|	ПоказателиНачисления.Показатель3Наименование,
	|	ПоказателиНачисления.Показатель3ТипПоказателя,
	|	ПоказателиНачисления.Показатель3ВозможностьИзменения,
	|	ПоказателиНачисления.Показатель4Предопределенный,
	|	ПоказателиНачисления.Показатель4Наименование,
	|	ПоказателиНачисления.Показатель4ТипПоказателя,
	|	ПоказателиНачисления.Показатель4ВозможностьИзменения,
	|	ПоказателиНачисления.Показатель5Предопределенный,
	|	ПоказателиНачисления.Показатель5Наименование,
	|	ПоказателиНачисления.Показатель5ТипПоказателя,
	|	ПоказателиНачисления.Показатель5ВозможностьИзменения,
	|	ПоказателиНачисления.Показатель6Предопределенный,
	|	ПоказателиНачисления.Показатель6Наименование,
	|	ПоказателиНачисления.Показатель6ТипПоказателя,
	|	ПоказателиНачисления.Показатель6ВозможностьИзменения,
	|	ПоказателиНачисления.Показатель1ТарифнаяСтавка,
	|	ПоказателиНачисления.Показатель2ТарифнаяСтавка,
	|	ПоказателиНачисления.Показатель3ТарифнаяСтавка,
	|	ПоказателиНачисления.Показатель4ТарифнаяСтавка,
	|	ПоказателиНачисления.Показатель5ТарифнаяСтавка,
	|	ПоказателиНачисления.Показатель6ТарифнаяСтавка,
	|	ПоказателиНачисления.Показатель1ЗапрашиватьПриКадровыхПеремещениях,
	|	ПоказателиНачисления.Показатель2ЗапрашиватьПриКадровыхПеремещениях,
	|	ПоказателиНачисления.Показатель3ЗапрашиватьПриКадровыхПеремещениях,
	|	ПоказателиНачисления.Показатель4ЗапрашиватьПриКадровыхПеремещениях,
	|	ПоказателиНачисления.Показатель5ЗапрашиватьПриКадровыхПеремещениях,
	|	ПоказателиНачисления.Показатель6ЗапрашиватьПриКадровыхПеремещениях,
	
	|	ПоказателиНачисления.Валюта1 КАК Валюта1,
	|	ПоказателиНачисления.Валюта2 КАК Валюта2,
	|	ПоказателиНачисления.Валюта3 КАК Валюта3,
	|	ПоказателиНачисления.Валюта4 КАК Валюта4,
	|	ПоказателиНачисления.Валюта5 КАК Валюта5,
	|	ПоказателиНачисления.Валюта6 КАК Валюта6,

	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации.ВидРасчета.ПроизвольнаяФормулаРасчета КАК ПроизвольнаяФормулаРасчетаНачисления,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации.Ссылка,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации.ВидРасчета,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации.ВидРасчета.СпособРасчета КАК СпособРасчета,
	|	ВЫБОР КОГДА ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации.Действие = 1 Или ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации.Действие = 3 ТОГДА Значение(Перечисление.ВидыДействияСНачислением.Прекратить) ИНАЧЕ Значение(Перечисление.ВидыДействияСНачислением.Изменить) КОНЕЦ КАК Действие,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации.ДатаДействия,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации.ДатаДействияКонец
	|ИЗ
	|	Документ.ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации КАК ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТПоказатели КАК ПоказателиНачисления
	|		ПО ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации.ВидРасчета = ПоказателиНачисления.ВидРасчета
	|ГДЕ
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации.Ссылка = &ДокументСсылка";
	
	Возврат Запрос.Выполнить();

КонецФункции // СформироватьЗапросПоШапке()

// Проверяет правильность заполнения шапки документа.
// Если какой-то из реквизитов шапки, влияющий на проведение не заполнен или
// заполнен не корректно, то выставляется флаг отказа в проведении.
// Проверка выполняется по выборке из результата запроса по шапке,
// все проверяемые реквизиты должны быть включены в выборку по шапке.
//
// Параметры:
//  ВыборкаПоШапкеДокумента	- выборка из результата запроса по шапке документа,
//  Отказ					- флаг отказа в проведении.
//	Заголовок				- Заголовок для сообщений об ошибках проведения
//
Процедура ПроверитьЗаполнениеШапки(ВыборкаПоШапкеДокумента, Отказ, Заголовок)
	
	Если НЕ ЗначениеЗаполнено(ВыборкаПоШапкеДокумента.Организация) Тогда
		ОбщегоНазначения.ВывестиИнформациюОбОшибке(ОбщегоНазначения.ПреобразоватьСтрокуИнтерфейса("Не указана организация!"), Отказ, Заголовок);
	КонецЕсли;
	
	// Действие
	
	Если ВыборкаПоШапкеДокумента.Действие <> Перечисления.ВидыДействияСНачислением.НеИзменять Тогда
		// Вид расчета
		Если НЕ ЗначениеЗаполнено(ВыборкаПоШапкеДокумента.ВидРасчета) Тогда
			ОбщегоНазначения.ВывестиИнформациюОбОшибке("Не задан вид расчета!", Отказ, Заголовок);
		КонецЕсли;
		
		// ДатаДействия
		Если НЕ ЗначениеЗаполнено(ВыборкаПоШапкеДокумента.ДатаДействия) Тогда
			ОбщегоНазначения.ВывестиИнформациюОбОшибке("Не задана дата действия!", Отказ, Заголовок);
		КонецЕсли;
		
		// Период действия
		Если ЗначениеЗаполнено(ВыборкаПоШапкеДокумента.ДатаДействияКонец) И ВыборкаПоШапкеДокумента.ДатаДействия > ВыборкаПоШапкеДокумента.ДатаДействияКонец Тогда
			ОбщегоНазначения.ВывестиИнформациюОбОшибке("Дата окончания действия не должна быть меньше даты начала!", Отказ, Заголовок);
		КонецЕсли; 
		
	КонецЕсли;
	
КонецПроцедуры // ПроверитьЗаполнениеШапки()

// Формирует запрос по таблице "Начисления" документа
//
// Параметры:
//	Режим - режим проведения
//
// Возвращаемое значение:
//	Результат запроса.
//
Функция СформироватьЗапросПоНачисления(ВыборкаПоШапкеДокумента)
	
	Запрос = Новый Запрос;
	
	Запрос.УстановитьПараметр("ДокументСсылка",		Ссылка);
	Запрос.УстановитьПараметр("ДатаДействия",		ДатаДействия);
	Запрос.УстановитьПараметр("ГоловнаяОрганизация",	ВыборкаПоШапкеДокумента.ГоловнаяОрганизация);
	Запрос.УстановитьПараметр("Организация",	ВыборкаПоШапкеДокумента.Организация);
	
	Если Действие = 0 Или Действие = 1 Тогда
		Плановые			= "ПлановыеНачисленияРаботниковОрганизаций";
		Работник			= "Сотрудник";
		РаботникСоединения	= "";
		ВнутреннееУсловиеСвязи = 
		"Сотрудник В
		|					(ВЫБРАТЬ
		|						ДанныеДокумента.Сотрудник
		|					ИЗ
		|						ВТДанныеДокумента КАК ДанныеДокумента)";
		ТекстДопПолейВременнойТаблицы = 
		"ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.ТарифныйРазряд1,
		|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.ТарифныйРазряд2,
		|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.ТарифныйРазряд3,
		|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.ТарифныйРазряд4,
		|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.ТарифныйРазряд5,
		|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.ТарифныйРазряд6,";
		ТекстДопПолейВременнойТаблицыРегистра = 
		"ВЫБОР
		|		КОГДА ПлановыеНачисленияРаботников.ПериодЗавершения <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
		|				И ПлановыеНачисленияРаботников.ПериодЗавершения <= &ДатаДействия
		|			ТОГДА ПлановыеНачисленияРаботников.ТарифныйРазряд1Завершения
		|		ИНАЧЕ ПлановыеНачисленияРаботников.ТарифныйРазряд1
		|	КОНЕЦ КАК ТарифныйРазряд1Завершения,
		|	ВЫБОР
		|		КОГДА ПлановыеНачисленияРаботников.ПериодЗавершения <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
		|				И ПлановыеНачисленияРаботников.ПериодЗавершения <= &ДатаДействия
		|			ТОГДА ПлановыеНачисленияРаботников.ТарифныйРазряд2Завершения
		|		ИНАЧЕ ПлановыеНачисленияРаботников.ТарифныйРазряд2
		|	КОНЕЦ КАК ТарифныйРазряд2Завершения,
		|	ВЫБОР
		|		КОГДА ПлановыеНачисленияРаботников.ПериодЗавершения <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
		|				И ПлановыеНачисленияРаботников.ПериодЗавершения <= &ДатаДействия
		|			ТОГДА ПлановыеНачисленияРаботников.ТарифныйРазряд3Завершения
		|		ИНАЧЕ ПлановыеНачисленияРаботников.ТарифныйРазряд3
		|	КОНЕЦ КАК ТарифныйРазряд3Завершения,
		|	ВЫБОР
		|		КОГДА ПлановыеНачисленияРаботников.ПериодЗавершения <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
		|				И ПлановыеНачисленияРаботников.ПериодЗавершения <= &ДатаДействия
		|			ТОГДА ПлановыеНачисленияРаботников.ТарифныйРазряд4Завершения
		|		ИНАЧЕ ПлановыеНачисленияРаботников.ТарифныйРазряд4
		|	КОНЕЦ КАК ТарифныйРазряд4Завершения,
		|	ВЫБОР
		|		КОГДА ПлановыеНачисленияРаботников.ПериодЗавершения <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
		|				И ПлановыеНачисленияРаботников.ПериодЗавершения <= &ДатаДействия
		|			ТОГДА ПлановыеНачисленияРаботников.ТарифныйРазряд5Завершения
		|		ИНАЧЕ ПлановыеНачисленияРаботников.ТарифныйРазряд5
		|	КОНЕЦ КАК ТарифныйРазряд5Завершения,
		|	ВЫБОР
		|		КОГДА ПлановыеНачисленияРаботников.ПериодЗавершения <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
		|				И ПлановыеНачисленияРаботников.ПериодЗавершения <= &ДатаДействия
		|			ТОГДА ПлановыеНачисленияРаботников.ТарифныйРазряд6Завершения
		|		ИНАЧЕ ПлановыеНачисленияРаботников.ТарифныйРазряд6
		|	КОНЕЦ КАК ТарифныйРазряд6Завершения,";
		ТекстДопПолейРегистра = 
		"НачисленияДоНазначения.ТарифныйРазряд1Завершения,
		|	НачисленияДоНазначения.ТарифныйРазряд2Завершения,
		|	НачисленияДоНазначения.ТарифныйРазряд3Завершения,
		|	НачисленияДоНазначения.ТарифныйРазряд4Завершения,
		|	НачисленияДоНазначения.ТарифныйРазряд5Завершения,
		|	НачисленияДоНазначения.ТарифныйРазряд6Завершения,";
	Иначе
		Плановые			= "ПлановыеУдержанияРаботниковОрганизаций";
		Работник			= "ФизЛицо";
		РаботникСоединения	= ".ФизЛицо";
		ВнутреннееУсловиеСвязи = 
		"ФизЛицо В
		|					(ВЫБРАТЬ
		|						ДанныеДокумента.ФизЛицо
		|					ИЗ
		|						ВТДанныеДокумента КАК ДанныеДокумента)";
		ТекстДопПолейВременнойТаблицы = ""; 
		ТекстДопПолейВременнойТаблицыРегистра = ""; 
		ТекстДопПолейРегистра	= "";
	КонецЕсли;
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Ссылка,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.НомерСтроки,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Сотрудник,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.ФизЛицо,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.ДокументОснование,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Показатель1,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Показатель2,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Показатель3,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Показатель4,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Показатель5,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Показатель6,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Валюта1,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Валюта2,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Валюта3,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Валюта4,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Валюта5,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Валюта6,
	|	НЕОПРЕДЕЛЕНО КАК ДополнительноеПолеДокумента,
	|	ВЫБОР
	|		КОГДА ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Ссылка.Организация.ГоловнаяОрганизация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|			ТОГДА ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Ссылка.Организация
	|		ИНАЧЕ ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Ссылка.Организация.ГоловнаяОрганизация
	|	КОНЕЦ КАК Организация
	|ПОМЕСТИТЬ ВТДанныеДокумента
	|ИЗ
	|	Документ.ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизации.ОсновныеНачисления КАК ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления
	|ГДЕ
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Ссылка = &ДокументСсылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПлановыеНачисленияРаботников.Организация КАК Организация,
	|	ПлановыеНачисленияРаботников.Сотрудник КАК Сотрудник,
	|	ПлановыеНачисленияРаботников.ВидРасчета КАК ВидРасчета,
	|	НЕОПРЕДЕЛЕНО КАК ДополнительноеПолеРегистра,
	|	ВЫБОР
	|		КОГДА ПлановыеНачисленияРаботников.ПериодЗавершения <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	|				И ПлановыеНачисленияРаботников.ПериодЗавершения <= &ДатаДействия
	|			ТОГДА ПлановыеНачисленияРаботников.ДействиеЗавершения
	|		ИНАЧЕ ПлановыеНачисленияРаботников.Действие
	|	КОНЕЦ КАК ДействиеЗавершения,
	|	ВЫБОР
	|		КОГДА ПлановыеНачисленияРаботников.ПериодЗавершения <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	|				И ПлановыеНачисленияРаботников.ПериодЗавершения <= &ДатаДействия
	|			ТОГДА ПлановыеНачисленияРаботников.Показатель1Завершения
	|		ИНАЧЕ ПлановыеНачисленияРаботников.Показатель1
	|	КОНЕЦ КАК Показатель1Завершения,
	|	ВЫБОР
	|		КОГДА ПлановыеНачисленияРаботников.ПериодЗавершения <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	|				И ПлановыеНачисленияРаботников.ПериодЗавершения <= &ДатаДействия
	|			ТОГДА ПлановыеНачисленияРаботников.Показатель2Завершения
	|		ИНАЧЕ ПлановыеНачисленияРаботников.Показатель2
	|	КОНЕЦ КАК Показатель2Завершения,
	|	ВЫБОР
	|		КОГДА ПлановыеНачисленияРаботников.ПериодЗавершения <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	|				И ПлановыеНачисленияРаботников.ПериодЗавершения <= &ДатаДействия
	|			ТОГДА ПлановыеНачисленияРаботников.Показатель3Завершения
	|		ИНАЧЕ ПлановыеНачисленияРаботников.Показатель3
	|	КОНЕЦ КАК Показатель3Завершения,
	|	ВЫБОР
	|		КОГДА ПлановыеНачисленияРаботников.ПериодЗавершения <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	|				И ПлановыеНачисленияРаботников.ПериодЗавершения <= &ДатаДействия
	|			ТОГДА ПлановыеНачисленияРаботников.Показатель4Завершения
	|		ИНАЧЕ ПлановыеНачисленияРаботников.Показатель4
	|	КОНЕЦ КАК Показатель4Завершения,
	|	ВЫБОР
	|		КОГДА ПлановыеНачисленияРаботников.ПериодЗавершения <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	|				И ПлановыеНачисленияРаботников.ПериодЗавершения <= &ДатаДействия
	|			ТОГДА ПлановыеНачисленияРаботников.Показатель5Завершения
	|		ИНАЧЕ ПлановыеНачисленияРаботников.Показатель5
	|	КОНЕЦ КАК Показатель5Завершения,
	|	ВЫБОР
	|		КОГДА ПлановыеНачисленияРаботников.ПериодЗавершения <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	|				И ПлановыеНачисленияРаботников.ПериодЗавершения <= &ДатаДействия
	|			ТОГДА ПлановыеНачисленияРаботников.Показатель6Завершения
	|		ИНАЧЕ ПлановыеНачисленияРаботников.Показатель6
	|	КОНЕЦ КАК Показатель6Завершения,
	|	ВЫБОР
	|		КОГДА ПлановыеНачисленияРаботников.ПериодЗавершения <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	|				И ПлановыеНачисленияРаботников.ПериодЗавершения <= &ДатаДействия
	|			ТОГДА ПлановыеНачисленияРаботников.Валюта1Завершения
	|		ИНАЧЕ ПлановыеНачисленияРаботников.Валюта1
	|	КОНЕЦ КАК Валюта1Завершения,
	|	ВЫБОР
	|		КОГДА ПлановыеНачисленияРаботников.ПериодЗавершения <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	|				И ПлановыеНачисленияРаботников.ПериодЗавершения <= &ДатаДействия
	|			ТОГДА ПлановыеНачисленияРаботников.Валюта2Завершения
	|		ИНАЧЕ ПлановыеНачисленияРаботников.Валюта2
	|	КОНЕЦ КАК Валюта2Завершения,
	|	ВЫБОР
	|		КОГДА ПлановыеНачисленияРаботников.ПериодЗавершения <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	|				И ПлановыеНачисленияРаботников.ПериодЗавершения <= &ДатаДействия
	|			ТОГДА ПлановыеНачисленияРаботников.Валюта3Завершения
	|		ИНАЧЕ ПлановыеНачисленияРаботников.Валюта3
	|	КОНЕЦ КАК Валюта3Завершения,
	|	ВЫБОР
	|		КОГДА ПлановыеНачисленияРаботников.ПериодЗавершения <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	|				И ПлановыеНачисленияРаботников.ПериодЗавершения <= &ДатаДействия
	|			ТОГДА ПлановыеНачисленияРаботников.Валюта4Завершения
	|		ИНАЧЕ ПлановыеНачисленияРаботников.Валюта4
	|	КОНЕЦ КАК Валюта4Завершения,
	|	ВЫБОР
	|		КОГДА ПлановыеНачисленияРаботников.ПериодЗавершения <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	|				И ПлановыеНачисленияРаботников.ПериодЗавершения <= &ДатаДействия
	|			ТОГДА ПлановыеНачисленияРаботников.Валюта5Завершения
	|		ИНАЧЕ ПлановыеНачисленияРаботников.Валюта5
	|	КОНЕЦ КАК Валюта5Завершения,
	|	ВЫБОР
	|		КОГДА ПлановыеНачисленияРаботников.ПериодЗавершения <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	|				И ПлановыеНачисленияРаботников.ПериодЗавершения <= &ДатаДействия
	|			ТОГДА ПлановыеНачисленияРаботников.Валюта6Завершения
	|		ИНАЧЕ ПлановыеНачисленияРаботников.Валюта6
	|	КОНЕЦ КАК Валюта6Завершения
	|ПОМЕСТИТЬ ВТДанныеДо
	|ИЗ
	|	РегистрСведений.ПлановыеНачисленияРаботниковОрганизаций.СрезПоследних(
	|			&ДатаДействия,
	|			Организация = &ГоловнаяОрганизация
	|				И &ВнутреннееУсловиеСвязи) КАК ПлановыеНачисленияРаботников
	|ГДЕ
	|	ВЫБОР
	|			КОГДА ПлановыеНачисленияРаботников.ПериодЗавершения <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	|					И ПлановыеНачисленияРаботников.ПериодЗавершения <= &ДатаДействия
	|				ТОГДА ПлановыеНачисленияРаботников.ДействиеЗавершения
	|			ИНАЧЕ ПлановыеНачисленияРаботников.Действие
	|		КОНЕЦ <> ЗНАЧЕНИЕ(Перечисление.ВидыДействияСНачислением.Прекратить)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.НомерСтроки,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Сотрудник,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Сотрудник.Наименование,
	|	ВЫБОР
	|		КОГДА ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Сотрудник.Организация = &ГоловнаяОрганизация
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ОшибкаНеСоответствиеСотрудникаИОрганизации,
	|	СуществующиеДвижения.Регистратор КАК КонфликтныйДокумент,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.ФизЛицо,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.ДокументОснование,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Показатель1,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Показатель2,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Показатель3,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Показатель4,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Показатель5,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Показатель6,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Валюта1,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Валюта2,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Валюта3,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Валюта4,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Валюта5,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Валюта6,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.ДополнительноеПолеДокумента,
	|	ВЫБОР
	|		КОГДА НачисленияДоНазначения.ДействиеЗавершения ЕСТЬ NULL 
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыДействияСНачислением.Прекратить)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыДействияСНачислением.Изменить)
	|	КОНЕЦ КАК ДействиеЗавершения,
	|	НачисленияДоНазначения.Показатель1Завершения,
	|	НачисленияДоНазначения.Показатель2Завершения,
	|	НачисленияДоНазначения.Показатель3Завершения,
	|	НачисленияДоНазначения.Показатель4Завершения,
	|	НачисленияДоНазначения.Показатель5Завершения,
	|	НачисленияДоНазначения.Показатель6Завершения,
	|	НачисленияДоНазначения.Валюта1Завершения,
	|	НачисленияДоНазначения.Валюта2Завершения,
	|	НачисленияДоНазначения.Валюта3Завершения,
	|	НачисленияДоНазначения.Валюта4Завершения,
	|	НачисленияДоНазначения.Валюта5Завершения,
	|	НачисленияДоНазначения.Валюта6Завершения,
	|	НачисленияДоНазначения.ДополнительноеПолеРегистра,
	|	МАКСИМУМ(ПовторяющиесяСтроки.НомерСтроки) КАК КонфликтнаяСтрокаНомер
	|ИЗ
	|	ВТДанныеДокумента КАК ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПлановыеНачисленияРаботниковОрганизаций КАК СуществующиеДвижения
	|		ПО ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Ссылка.ДатаДействия = СуществующиеДвижения.Период
	|			И ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Ссылка.ВидРасчета = СуществующиеДвижения.ВидРасчета
	|			И ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Организация = СуществующиеДвижения.Организация
	|			И (&УсловиеСвязиДокумента)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТДанныеДокумента КАК ПовторяющиесяСтроки
	|		ПО ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.НомерСтроки < ПовторяющиесяСтроки.НомерСтроки
	|			И (&УсловиеСвязиПовторов)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТДанныеДо КАК НачисленияДоНазначения
	|		ПО (&ВнешнееУсловиеСвязи)
	|			И ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Организация = НачисленияДоНазначения.Организация
	|			И ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Ссылка.ВидРасчета = НачисленияДоНазначения.ВидРасчета
	|
	|СГРУППИРОВАТЬ ПО
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.НомерСтроки,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Сотрудник,
	|	ВЫБОР
	|		КОГДА ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Сотрудник.Организация = &ГоловнаяОрганизация
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ,
	|	СуществующиеДвижения.Регистратор,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Ссылка.ВидРасчета.ЗачетОтработанногоВремени,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.ФизЛицо,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.ДокументОснование,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Показатель1,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Показатель2,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Показатель3,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Показатель4,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Показатель5,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Показатель6,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Валюта1,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Валюта2,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Валюта3,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Валюта4,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Валюта5,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Валюта6,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Сотрудник.Наименование,
	|	ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.ДополнительноеПолеДокумента,
	|	НачисленияДоНазначения.ДействиеЗавершения,
	|	НачисленияДоНазначения.Показатель1Завершения,
	|	НачисленияДоНазначения.Показатель2Завершения,
	|	НачисленияДоНазначения.Показатель3Завершения,
	|	НачисленияДоНазначения.Показатель4Завершения,
	|	НачисленияДоНазначения.Показатель5Завершения,
	|	НачисленияДоНазначения.Показатель6Завершения,
	|	НачисленияДоНазначения.ДополнительноеПолеРегистра,
	|	НачисленияДоНазначения.Валюта1Завершения,
	|	НачисленияДоНазначения.Валюта2Завершения,
	|	НачисленияДоНазначения.Валюта3Завершения,
	|	НачисленияДоНазначения.Валюта4Завершения,
	|	НачисленияДоНазначения.Валюта5Завершения,
	|	НачисленияДоНазначения.Валюта6Завершения";
	
    ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"РегистрСведений.ПлановыеНачисленияРаботниковОрганизаций", "РегистрСведений." + Плановые);
    ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"НЕОПРЕДЕЛЕНО КАК ДополнительноеПолеДокумента,", ТекстДопПолейВременнойТаблицы);
    ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.ДополнительноеПолеДокумента,", ТекстДопПолейВременнойТаблицы);
    ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"НЕОПРЕДЕЛЕНО КАК ДополнительноеПолеРегистра,", ТекстДопПолейВременнойТаблицыРегистра);
    ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"НачисленияДоНазначения.ДополнительноеПолеРегистра,", ТекстДопПолейРегистра);
    ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ВнутреннееУсловиеСвязи", ВнутреннееУсловиеСвязи);
    ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ВнешнееУсловиеСвязи", "ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Сотрудник" + РаботникСоединения + " = НачисленияДоНазначения." + Работник);
    ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&УсловиеСвязиДокумента", "ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Сотрудник" + РаботникСоединения + " = СуществующиеДвижения." + Работник);
    ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&УсловиеСвязиПовторов", "ВводПостоянногоНачисленияИлиУдержанияСотрудникамОрганизацииОсновныеНачисления.Сотрудник" + РаботникСоединения + " = ПовторяющиесяСтроки.Сотрудник" + РаботникСоединения);
    ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"ПлановыеНачисленияРаботников.Сотрудник КАК Сотрудник", "ПлановыеНачисленияРаботников." + Работник + " КАК " + Работник);
	
	Запрос.Текст =  ТекстЗапроса;
	Возврат Запрос.Выполнить();

КонецФункции //СформироватьЗапросПоНачисления

// Проверяет правильность заполнения реквизитов в строке ТЧ "ОсновныеНачисления" документа.
// Если какой-то из реквизитов, влияющий на проведение не заполнен или
// заполнен не корректно, то выставляется флаг отказа в проведении.
// Проверка выполняется по выборке из результата запроса по строке ТЧ документа,
// все проверяемые реквизиты должны быть включены в выборку.
//
// Параметры: 
//  ВыборкаПоШапкеДокумента		- выборка из результата запроса по шапке документа,
//  ВыборкаПоСтрокамДокумента	- спозиционированная на определеной строке выборка 
//  							  из результата запроса
//  Отказ						- флаг отказа в проведении.
//
Процедура ПроверитьЗаполнениеСтрокиНачисления(ВыборкаПоШапкеДокумента, ВыборкаПоСтрокамДокумента, Отказ, Заголовок, КонтрольРазмераСтавокШтатногоРасписания, СоответствиеВалютныеСпособыРасчета)

	СтрокаНачалаСообщенияОбОшибке = "В строке номер """+ СокрЛП(ВыборкаПоСтрокамДокумента.НомерСтроки) +
									""" табл. части ""Сотрудники и показатели для расчета"": ";
	
	// Сотрудник
	Если НЕ ЗначениеЗаполнено(ВыборкаПоСтрокамДокумента.Сотрудник) Тогда
		ОбщегоНазначения.ВывестиИнформациюОбОшибке(СтрокаНачалаСообщенияОбОшибке + "не выбран сотрудник!", Отказ, Заголовок);
	КонецЕсли;
	
	ЭтоНачисление = (Действие = 0 Или Действие = 1);

	// Организация сотрудника должна совпадать с организацией документа
	Если ВыборкаПоСтрокамДокумента.ОшибкаНеСоответствиеСотрудникаИОрганизации Тогда
		ОбщегоНазначения.ВывестиИнформациюОбОшибке(СтрокаНачалаСообщенияОбОшибке + ОбщегоНазначения.ПреобразоватьСтрокуИнтерфейса("указанный сотрудник оформлен на другую организацию!"), Отказ, Заголовок);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ВыборкаПоШапкеДокумента.Действие) Тогда
		Если ВыборкаПоШапкеДокумента.Действие <> Перечисления.ВидыДействияСНачислением.НеИзменять Тогда
			Если ЗначениеЗаполнено(ВыборкаПоШапкеДокумента.ДатаДействия) Тогда
				Если ЗначениеЗаполнено(ВыборкаПоСтрокамДокумента.КонфликтныйДокумент) Тогда
					// Движения в регистре на дату из документа
					Расшифровки = Новый Массив;
					Расшифровки.Добавить(Новый Структура("Представление, Расшифровка", ВыборкаПоСтрокамДокумента.КонфликтныйДокумент, ВыборкаПоСтрокамДокумента.КонфликтныйДокумент));
					ОбщегоНазначения.ВывестиИнформациюОбОшибке("На дату "+ ВыборкаПоШапкеДокумента.ДатаДействия + " вид расчета уже зарегистрирован документом ", Отказ, Заголовок, , Расшифровки);
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;

	//Док основание
	Если ВыборкаПоШапкеДокумента.Действие = Перечисления.ВидыДействияСНачислением.Прекратить И (Не ЭтоНачисление) И Не ЗначениеЗаполнено(ВыборкаПоСтрокамДокумента.ДокументОснование) Тогда
		ОбщегоНазначения.ВывестиИнформациюОбОшибке("Не выбран документ-основание в строке" + ВыборкаПоСтрокамДокумента.НомерСтроки + "!", Отказ, Заголовок);
	КонецЕсли;
	
				
	// Одинаковые строки
	Если ЗначениеЗаполнено(ВыборкаПоСтрокамДокумента.КонфликтнаяСтрокаНомер) Тогда
		ОбщегоНазначения.ВывестиИнформациюОбОшибке("Один и тот же сотрудник " + ВыборкаПоСтрокамДокумента.СотрудникНаименование + " введен дважды (см. строку " + ВыборкаПоСтрокамДокумента.КонфликтнаяСтрокаНомер + ")!", Отказ, Заголовок); 
	КонецЕсли;
	
	Если ВыборкаПоШапкеДокумента.Действие = Перечисления.ВидыДействияСНачислением.Начать или ВыборкаПоШапкеДокумента.Действие = Перечисления.ВидыДействияСНачислением.Изменить Тогда
		ИспользуютсяНачисленияВВалюте			= ПроцедурыУправленияПерсоналом.ЗначениеУчетнойПолитикиПоПерсоналуОрганизации(глЗначениеПеременной("глУчетнаяПолитикаПоПерсоналуОрганизации"), Организация, "ИспользуютсяНачисленияВВалюте");
		Если ВыборкаПоШапкеДокумента.ПроизвольнаяФормулаРасчетаНачисления Тогда
			Для СчПоказателя = 1 По Мин(ВыборкаПоШапкеДокумента.КоличествоПоказателейНачисления, 6) Цикл
				ТипПоказателя = ВыборкаПоШапкеДокумента["Показатель" + СчПоказателя + "ТипПоказателя"];
				ВозможностьИзменения = ВыборкаПоШапкеДокумента["Показатель" + СчПоказателя + "ВозможностьИзменения"];
				ЗапрашиватьПриКадровыхПеремещениях = ВыборкаПоШапкеДокумента["Показатель" + СчПоказателя + "ЗапрашиватьПриКадровыхПеремещениях"];
				Если ВозможностьИзменения = Перечисления.ИзменениеПоказателейСхемМотивации.НеИзменяется И ЗапрашиватьПриКадровыхПеремещениях Тогда
					
					// проверка постоянных показателей
					Если ВыборкаПоСтрокамДокумента["Показатель" + СчПоказателя] = 0 Тогда
						// размер 
						Если Не ВыборкаПоШапкеДокумента["Показатель" + СчПоказателя + "Предопределенный"]
							и ТипПоказателя <> Перечисления.ТипыПоказателейСхемМотивации.ОценочнаяШкалаПроцентная
							и ТипПоказателя <> Перечисления.ТипыПоказателейСхемМотивации.ОценочнаяШкалаЧисловая
							и ТипПоказателя <> Перечисления.ТипыПоказателейСхемМотивации.ТарифныйРазряд Тогда
							ОбщегоНазначения.ВывестиИнформациюОбОшибке(СтрокаНачалаСообщенияОбОшибке + " не указан размер показателя " + ВыборкаПоШапкеДокумента["Показатель" + СчПоказателя+"Наименование"], Отказ, Заголовок);
						КонецЕсли;
					КонецЕсли;
					Если ЭтоНачисление Тогда
						Если НЕ ЗначениеЗаполнено(ВыборкаПоСтрокамДокумента["ТарифныйРазряд" + СчПоказателя])
							и ТипПоказателя = Перечисления.ТипыПоказателейСхемМотивации.ТарифныйРазряд Тогда
							ОбщегоНазначения.ВывестиИнформациюОбОшибке(СтрокаНачалаСообщенияОбОшибке + "не указан размер тарифа " + ВыборкаПоШапкеДокумента["Показатель" + СчПоказателя+"Наименование"], Отказ, Заголовок);
						КонецЕсли;
					КонецЕсли;
					// валюта (для денежного показателя)
					Если ИспользуютсяНачисленияВВалюте Тогда
						Если ТипПоказателя = Перечисления.ТипыПоказателейСхемМотивации.Денежный 
							и НЕ ЗначениеЗаполнено(ВыборкаПоСтрокамДокумента["Валюта" + СчПоказателя]) И НЕ ЗначениеЗаполнено(ВыборкаПоШапкеДокумента["Валюта" + СчПоказателя])
							и ТипПоказателя <> Перечисления.ТипыПоказателейСхемМотивации.ТарифныйРазряд Тогда
							ОбщегоНазначения.ВывестиИнформациюОбОшибке(СтрокаНачалаСообщенияОбОшибке +  "не указана валюта!", Отказ, Заголовок);
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
			КонецЦикла;
		Иначе
			Если ИспользуютсяНачисленияВВалюте Тогда
				// Валюта
				Если ВыборкаПоШапкеДокумента.КоличествоПоказателей > 0 
					И Не ВыборкаПоШапкеДокумента.ТребуетВводаТарифногоРазряда
					И Не ЗначениеЗаполнено(ВыборкаПоСтрокамДокумента.Валюта1) И НЕ ВыборкаПоШапкеДокумента["Валюта1"]
					И СоответствиеВалютныеСпособыРасчета[ВыборкаПоСтрокамДокумента.СпособРасчета] 
					И ПроведениеРасчетов.СпособРасчетаТребуетРазмер(ВыборкаПоСтрокамДокумента.СпособРасчета) Тогда
					ОбщегоНазначения.ВывестиИнформациюОбОшибке(СтрокаНачалаСообщенияОбОшибке + "не задана валюта!", Отказ, Заголовок);
				КонецЕсли;
			КонецЕсли;
			
			// Размер оплаты
			Если ВыборкаПоШапкеДокумента.КоличествоПоказателей > 0 И ВыборкаПоШапкеДокумента.Действие <> Перечисления.ВидыДействияСНачислением.Прекратить И ПроведениеРасчетов.СпособРасчетаТребуетРазмер(ВыборкаПоШапкеДокумента.СпособРасчета) Тогда
				Если ВыборкаПоСтрокамДокумента.Показатель1 = 0 и Не ВыборкаПоСтрокамДокумента.ТребуетВводаТарифногоРазряда Тогда
					ОбщегоНазначения.ВывестиИнформациюОбОшибке(СтрокаНачалаСообщенияОбОшибке + "не указан размер!", Отказ, Заголовок);
					
				ИначеЕсли ВыборкаПоСтрокамДокумента.ТарифныйРазряд1.Пустая() И ВыборкаПоСтрокамДокумента.ТребуетВводаТарифногоРазряда Тогда
					ОбщегоНазначения.ВывестиИнформациюОбОшибке(СтрокаНачалаСообщенияОбОшибке + "не указан разряд!", Отказ, Заголовок);
					
				КонецЕсли;
			КонецЕсли;

		КонецЕсли;
	КонецЕсли;

		
КонецПроцедуры // ПроверитьЗаполнениеСтрокиРаботникаОрганизации()

Процедура ДобавитьСтрокуВДвиженияПоНачислениям(ВыборкаПоШапкеДокумента, ВыборкаПоНачислениям)
	
	ЭтоНачисление = (Действие = 0 Или Действие = 1);
	
	Если ЭтоНачисление Тогда
		Движение = Движения.ПлановыеНачисленияРаботниковОрганизаций.Добавить();
	Иначе
		Движение = Движения.ПлановыеУдержанияРаботниковОрганизаций.Добавить();
	КонецЕсли;
	
	// Свойства
	Движение.Период						= ВыборкаПоШапкеДокумента.ДатаДействия;
	
	// Измерения
	Если ЭтоНачисление Тогда
		Движение.Сотрудник					= ВыборкаПоНачислениям.Сотрудник;
	Иначе
		Движение.ФизЛицо					= ВыборкаПоНачислениям.ФизЛицо;
	КонецЕсли;
	Движение.Организация				= ВыборкаПоШапкеДокумента.ГоловнаяОрганизация;

	Если ЭтоНачисление Тогда
		Если НЕ ВыборкаПоШапкеДокумента.ОсновноеНачисление Тогда
			Движение.ВидРасчетаИзмерение	= ВыборкаПоШапкеДокумента.ВидРасчета;
		КонецЕсли;
	КонецЕсли;
	
	
	// Ресурсы
	Движение.Действие					= ВыборкаПоШапкеДокумента.Действие;
	Движение.ВидРасчета					= ВыборкаПоШапкеДокумента.ВидРасчета;
	
	Если ВыборкаПоШапкеДокумента.Действие <> Перечисления.ВидыДействияСНачислением.Прекратить Тогда
		Для Сч = 1 По 6 Цикл
			Если ВыборкаПоШапкеДокумента.ПроизвольнаяФормулаРасчетаНачисления Тогда
				Если Сч <= ВыборкаПоШапкеДокумента.КоличествоПоказателейНачисления Тогда
					Если ВыборкаПоШапкеДокумента["Показатель" + Сч + "ЗапрашиватьПриКадровыхПеремещениях"]
						Или ВыборкаПоШапкеДокумента["ОсновноеНачисление"] И ВыборкаПоШапкеДокумента["Показатель" + Сч + "ТарифнаяСтавка"] Тогда
						Движение["Показатель"+Сч]			= ВыборкаПоНачислениям["Показатель"+Сч];
						Если ЗначениеЗаполнено(ВыборкаПоНачислениям["Валюта"+Сч]) Тогда
							Движение["Валюта"+Сч]				= ВыборкаПоНачислениям["Валюта"+Сч];
						Иначе
							Движение["Валюта"+Сч]				= ВыборкаПоШапкеДокумента["Валюта" + Сч];
						КонецЕсли;
						Если ЭтоНачисление Тогда
							Движение["ТарифныйРазряд"+Сч]		= ВыборкаПоНачислениям["ТарифныйРазряд"+Сч];
						КонецЕсли;
					Иначе
						Движение["Показатель"+Сч]			= 0;
						Движение["Валюта"+Сч]				= Справочники.Валюты.ПустаяСсылка();
						Если ЭтоНачисление Тогда
							Движение["ТарифныйРазряд"+Сч]		= Справочники.ТарифныеРазряды.ПустаяСсылка();
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
			Иначе
				Движение["Показатель"+Сч]			= ВыборкаПоНачислениям["Показатель"+Сч];
				Если ЗначениеЗаполнено(ВыборкаПоНачислениям["Валюта"+Сч]) Тогда
					Движение["Валюта"+Сч]				= ВыборкаПоНачислениям["Валюта"+Сч];
				Иначе
					Движение["Валюта"+Сч]				= ВыборкаПоШапкеДокумента["Валюта" + Сч];
				КонецЕсли;
				Если ЭтоНачисление Тогда
					Движение["ТарифныйРазряд"+Сч]		= ВыборкаПоНачислениям["ТарифныйРазряд"+Сч];
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	Если ВыборкаПоШапкеДокумента.Действие <> Перечисления.ВидыДействияСНачислением.Прекратить 
		И ЗначениеЗаполнено(ВыборкаПоШапкеДокумента.ДатаДействияКонец) Тогда
		Движение.ПериодЗавершения		= ВыборкаПоШапкеДокумента.ДатаДействияКонец + мДлинаСуток;
		Движение.ДействиеЗавершения		= ВыборкаПоНачислениям.ДействиеЗавершения;
		
		Для Сч = 1 По 6 Цикл
			Если ВыборкаПоШапкеДокумента.ПроизвольнаяФормулаРасчетаНачисления Тогда
				Если Сч <= ВыборкаПоШапкеДокумента.КоличествоПоказателейНачисления Тогда
					
					Движение["Показатель"+Сч+"Завершения"]				= ВыборкаПоНачислениям["Показатель"+Сч+"Завершения"];
					Если ЗначениеЗаполнено(ВыборкаПоНачислениям["Валюта"+Сч]) Тогда
						Движение["Валюта"+Сч+"Завершения"]				= ВыборкаПоНачислениям["Валюта"+Сч+"Завершения"];
					Иначе
						Движение["Валюта"+Сч+"Завершения"]				= ВыборкаПоШапкеДокумента["Валюта" + Сч];
					КонецЕсли;
					Если ЭтоНачисление Тогда
						Движение["ТарифныйРазряд"+Сч+"Завершения"]		= ВыборкаПоНачислениям["ТарифныйРазряд"+Сч+"Завершения"];
					КонецЕсли;
				Иначе
					Движение["Показатель"+Сч+"Завершения"]			= 0;
					Движение["Валюта"+Сч+"Завершения"]				= Справочники.Валюты.ПустаяСсылка();
					Если ЭтоНачисление Тогда
						Движение["ТарифныйРазряд"+Сч+"Завершения"]	= Справочники.ТарифныеРазряды.ПустаяСсылка();
					КонецЕсли;
				КонецЕсли;
			Иначе
				Движение["Показатель"+Сч+"Завершения"]				= ВыборкаПоНачислениям["Показатель"+Сч+"Завершения"];
				Если ЗначениеЗаполнено(ВыборкаПоНачислениям["Валюта"+Сч]) Тогда
					Движение["Валюта"+Сч+"Завершения"]				= ВыборкаПоНачислениям["Валюта"+Сч+"Завершения"];
				Иначе
					Движение["Валюта"+Сч+"Завершения"]				= ВыборкаПоШапкеДокумента["Валюта" + Сч];
				КонецЕсли;
				Если ЭтоНачисление Тогда
					Движение["ТарифныйРазряд"+Сч+"Завершения"]		= ВыборкаПоНачислениям["ТарифныйРазряд"+Сч+"Завершения"];
				КонецЕсли;
			КонецЕсли;
		КонецЦикла
		
	КонецЕсли;

	Если Не ЭтоНачисление Тогда
		Если ВыборкаПоШапкеДокумента.Действие = Перечисления.ВидыДействияСНачислением.Прекратить Тогда
			Движение.ДокументОснование = ВыборкаПоНачислениям.ДокументОснование;
		Иначе
			Движение.ДокументОснование = Ссылка;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ

Процедура ОбработкаПроведения(Отказ, Режим)
	
	ОбработкаКомментариев = глЗначениеПеременной("глОбработкаСообщений");
	ОбработкаКомментариев.УдалитьСообщения();
	
	// Заголовок для сообщений об ошибках проведения.
	Заголовок = ОбщегоНазначения.ПредставлениеДокументаПриПроведении(Ссылка);
	
	СоответствиеВалютныеСпособыРасчета = ПроведениеРасчетов.ПолучитьСоответствиеСпособовРасчетаТребующихВалюту();
	РезультатЗапросаПоШапке = СформироватьЗапросПоШапке(Режим);

	// Получим реквизиты шапки из запроса
	ВыборкаПоШапкеДокумента = РезультатЗапросаПоШапке.Выбрать();

	Если ВыборкаПоШапкеДокумента.Следующий() Тогда

		//Надо позвать проверку заполнения реквизитов шапки
		ПроверитьЗаполнениеШапки(ВыборкаПоШапкеДокумента, Отказ, Заголовок);
		
		КонтрольРазмераСтавокШтатногоРасписания = ПроцедурыУправленияПерсоналом.ЗначениеУчетнойПолитикиПоПерсоналуОрганизации(глЗначениеПеременной("глУчетнаяПолитикаПоПерсоналуОрганизации"), Организация, "КонтрольРазмераСтавокШтатногоРасписания");

		// Движения стоит добавлять, если в проведении еще не отказано (отказ =ложь)
		Если НЕ Отказ Тогда

			// получим реквизиты табличной части "ОсновныеНачисления"
			РезультатЗапросаПоНачислениям = СформироватьЗапросПоНачисления(ВыборкаПоШапкеДокумента);
			ВыборкаПоНачислениям = РезультатЗапросаПоНачислениям.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			Пока ВыборкаПоНачислениям.Следующий() Цикл
				
				// проверим очередную строку табличной части
				ПроверитьЗаполнениеСтрокиНачисления(ВыборкаПоШапкеДокумента, ВыборкаПоНачислениям, Отказ, Заголовок, КонтрольРазмераСтавокШтатногоРасписания, СоответствиеВалютныеСпособыРасчета);

				Если НЕ Отказ Тогда

					// Заполним записи в наборах записей регистров
					ДобавитьСтрокуВДвиженияПоНачислениям(ВыборкаПоШапкеДокумента, ВыборкаПоНачислениям);
					
				КонецЕсли;
				
			КонецЦикла;
			
		КонецЕсли;

	КонецЕсли;

	ОбработкаКомментариев.ПоказатьСообщения();
	
КонецПроцедуры // ОбработкаПроведения()

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	Если ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	МассивТЧ = Новый Массив();
	МассивТЧ.Добавить(ОсновныеНачисления);

	КраткийСоставДокумента = ПроцедурыУправленияПерсоналом.ЗаполнитьКраткийСоставДокумента(МассивТЧ, "Физлицо");

КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОПЕРАТОРЫ ОСНОВНОЙ ПРОГРАММЫ

мДлинаСуток = 86400;