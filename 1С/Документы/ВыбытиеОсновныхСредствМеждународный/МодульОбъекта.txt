Перем мУдалятьДвижения;

////////////////////////////////////////////////////////////////////////////////
// ЭКСПОРТНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ ДОКУМЕНТА

#Если Клиент Тогда
// Процедура осуществляет печать документа. Можно направить печать на 
// экран или принтер, а также распечатать необходимое количество копий.
//
//  Название макета печати передается в качестве параметра,
// по переданному названию находим имя макета в соответствии.
//
// Параметры:
//  НазваниеМакета - строка, название макета.
//
Процедура Печать(ИмяМакета, КоличествоЭкземпляров = 1, НаПринтер = Ложь) Экспорт

	Если ЭтоНовый() Тогда
		Предупреждение("Документ можно распечатать только после его записи");
		Возврат;
	ИначеЕсли Не УправлениеДопПравамиПользователей.РазрешитьПечатьНепроведенныхДокументов(Проведен) Тогда
		Предупреждение("Недостаточно полномочий для печати непроведенного документа!");
		Возврат;
	КонецЕсли;

	Если Не РаботаСДиалогами.ПроверитьМодифицированность(ЭтотОбъект) Тогда
		Возврат;
	КонецЕсли;

	Если ТипЗнч(ИмяМакета) = Тип("ДвоичныеДанные") Тогда

		ТабДокумент = УниверсальныеМеханизмы.НапечататьВнешнююФорму(Ссылка, ИмяМакета);
		
		Если ТабДокумент = Неопределено Тогда
			Возврат
		КонецЕсли; 
		
	КонецЕсли;

	УниверсальныеМеханизмы.НапечататьДокумент(ТабДокумент, КоличествоЭкземпляров, НаПринтер, ОбщегоНазначения.СформироватьЗаголовокДокумента(ЭтотОбъект), Ссылка);

КонецПроцедуры // Печать

#КонецЕсли

// Возвращает доступные варианты печати документа
//
// Возвращаемое значение:
//  Структура, каждая строка которой соответствует одному из вариантов печати
//  
Функция ПолучитьСтруктуруПечатныхФорм() Экспорт
	
	Возврат Новый Структура;

КонецФункции // ПолучитьСтруктуруПечатныхФорм()


Процедура ОбработкаПроведения(Отказ)
	
	Если мУдалятьДвижения Тогда
		ОбщегоНазначения.УдалитьДвиженияРегистратора(ЭтотОбъект, Отказ);
	КонецЕсли;

	Для Каждого ТекСтрокаОсновныеСредства Из ОсновныеСредства Цикл
		СрезСведенийМежд = РегистрыСведений.ОсновныеСредстваМеждународныйУчет.ПолучитьПоследнее(Дата, Новый Структура("ОсновноеСредство", ТекСтрокаОсновныеСредства.ОсновноеСредство));

		// регистр ОсновныеСредстваМеждународныйУчет 
		ДвижениеРС = Движения.ОсновныеСредстваМеждународныйУчет.Добавить();
		ДвижениеРС.Период = Дата;
		ДвижениеРС.ОсновноеСредство = ТекСтрокаОсновныеСредства.ОсновноеСредство;
		ДвижениеРС.Организация = Организация;
		ДвижениеРС.ДатаПринятияКУчету = СрезСведенийМежд.ДатаПринятияКУчету;
		ДвижениеРС.МестонахождениеОбъекта = ТекСтрокаОсновныеСредства.МестонахождениеОбъектаНов;
		ДвижениеРС.МОЛ = ТекСтрокаОсновныеСредства.МОЛНов;
		ДвижениеРС.СчетУчета = СрезСведенийМежд.СчетУчета;
		ДвижениеРС.СрокПолезногоИспользования = СрезСведенийМежд.СрокПолезногоИспользования;
		ДвижениеРС.МетодНачисленияАмортизации = СрезСведенийМежд.МетодНачисленияАмортизации;
		ДвижениеРС.СчетНачисленияАмортизации = СрезСведенийМежд.СчетНачисленияАмортизации;
		ДвижениеРС.ПервоначальнаяСтоимость = СрезСведенийМежд.ПервоначальнаяСтоимость;
		ДвижениеРС.ЛиквидационнаяСтоимость = СрезСведенийМежд.ЛиквидационнаяСтоимость;
		ДвижениеРС.СчетЗатрат = СрезСведенийМежд.СчетЗатрат;
		ДвижениеРС.Субконто1 = СрезСведенийМежд.Субконто1;
		ДвижениеРС.Субконто2 = СрезСведенийМежд.Субконто2;
		ДвижениеРС.Субконто3 = СрезСведенийМежд.Субконто3;
		ДвижениеРС.ПредполагаемыйОбъемПродукции = СрезСведенийМежд.ПредполагаемыйОбъемПродукции;
		ДвижениеРС.СуммаНачисленнойАмортизации = СрезСведенийМежд.СуммаНачисленнойАмортизации;
		ДвижениеРС.СправедливаяСтоимость = СрезСведенийМежд.СправедливаяСтоимость;
		ДвижениеРС.НачислятьАмортизацию = Ложь;
		ДвижениеРС.Состояние = Перечисления.ВидыСостоянийОС.СнятоСУчета; // д.б. НаходитсяВСтадииВыбытия;
		ДвижениеРС.СчетСниженияСтоимости = СрезСведенийМежд.СчетСниженияСтоимости;
		
		// Проверка "хвостов" по "СчетУчета" и "СчетНачисленияАмортизации"
		МассивСчетов = Новый Массив();
		МассивСчетов.Добавить(СрезСведенийМежд.СчетУчета);
		МассивСчетов.Добавить(СрезСведенийМежд.СчетНачисленияАмортизации);
		МассивСчетов.Добавить(СрезСведенийМежд.СчетСниженияСтоимости);
		
		БухИтоги = Обработки.БухгалтерскиеИтоги.Создать();
		БухИтоги.РассчитатьИтоги("Международный", "КонечныйОстатокДт,КонечныйОстатокКт", "Сумма", "Счет,Субконто1", Дата, Дата, , МассивСчетов, ПланыВидовХарактеристик.ВидыСубконтоМеждународные.ОсновныеСредства, , ,"Организация", Организация);
		СуммаДт = БухИтоги.ПолучитьИтог("СуммаКонечныйОстатокДт", "Счет,Субконто1", СрезСведенийМежд.СчетУчета, ТекСтрокаОсновныеСредства.ОсновноеСредство);
		СуммаКт = БухИтоги.ПолучитьИтог("СуммаКонечныйОстатокКт", "Счет,Субконто1", СрезСведенийМежд.СчетНачисленияАмортизации, ТекСтрокаОсновныеСредства.ОсновноеСредство);
		СуммаКт1 = БухИтоги.ПолучитьИтог("СуммаКонечныйОстатокКт", "Счет,Субконто1", СрезСведенийМежд.СчетСниженияСтоимости, ТекСтрокаОсновныеСредства.ОсновноеСредство);
		
		Если СуммаДт <> 0 Тогда
			Движение = Движения.Международный.Добавить();
			Движение.Период = Дата;
			Движение.СчетДт = ПланыСчетов.Международный.ОсновныеСредстваДляПродажи; //201
			Движение.СчетКт = СрезСведенийМежд.СчетУчета;
			Движение.Организация = Организация;
			Движение.Сумма = СуммаДт;
			Движение.Содержание = "Закрытие счета учета основного средства";
			Движение.НомерЖурнала = "Рег";
			
			Если не Движение.СчетДт.ВидыСубконто.Найти(ПланыВидовХарактеристик.ВидыСубконтоМеждународные.ОсновныеСредства,) = Неопределено Тогда
				Движение.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконтоМеждународные.ОсновныеСредства] = ТекСтрокаОсновныеСредства.ОсновноеСредство;
			КонецЕсли;
			
			Если не Движение.СчетКт.ВидыСубконто.Найти(ПланыВидовХарактеристик.ВидыСубконтоМеждународные.ОсновныеСредства,) = Неопределено Тогда
				Движение.СубконтоКт[ПланыВидовХарактеристик.ВидыСубконтоМеждународные.ОсновныеСредства] = ТекСтрокаОсновныеСредства.ОсновноеСредство;
			КонецЕсли;
			
		КонецЕсли;
		
		Если СуммаКт <> 0 Тогда
			Движение = Движения.Международный.Добавить();
			Движение.Период = Дата;
			Движение.СчетДт = СрезСведенийМежд.СчетНачисленияАмортизации;
			Движение.СчетКт = ПланыСчетов.Международный.ОсновныеСредстваДляПродажи; //201
			Движение.Организация = Организация;
			Движение.Сумма = СуммаКт;
			Движение.Содержание = "Закрытие счета начисления амортизации основного средства";
			Движение.НомерЖурнала = "Рег";
			
			Если не Движение.СчетДт.ВидыСубконто.Найти(ПланыВидовХарактеристик.ВидыСубконтоМеждународные.ОсновныеСредства,) = Неопределено Тогда
				Движение.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконтоМеждународные.ОсновныеСредства] = ТекСтрокаОсновныеСредства.ОсновноеСредство;
			КонецЕсли;
			
			Если не Движение.СчетКт.ВидыСубконто.Найти(ПланыВидовХарактеристик.ВидыСубконтоМеждународные.ОсновныеСредства,) = Неопределено Тогда
				Движение.СубконтоКт[ПланыВидовХарактеристик.ВидыСубконтоМеждународные.ОсновныеСредства] = ТекСтрокаОсновныеСредства.ОсновноеСредство;
			КонецЕсли;
			
		КонецЕсли;
		
		Если СуммаКт1 <> 0 Тогда
			Движение = Движения.Международный.Добавить();
			Движение.Период = Дата;
			Движение.СчетДт = СрезСведенийМежд.СчетСниженияСтоимости;
			Движение.СчетКт = ПланыСчетов.Международный.ОсновныеСредстваДляПродажи; //201
			Движение.Организация = Организация;
			Движение.Сумма = СуммаКт1;
			Движение.Содержание = "Закрытие счета снижения стоимости основного средства";
			Движение.НомерЖурнала = "Рег";
			
			Если не Движение.СчетДт.ВидыСубконто.Найти(ПланыВидовХарактеристик.ВидыСубконтоМеждународные.ОсновныеСредства,) = Неопределено Тогда
				Движение.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконтоМеждународные.ОсновныеСредства] = ТекСтрокаОсновныеСредства.ОсновноеСредство;
			КонецЕсли;
			
			Если не Движение.СчетКт.ВидыСубконто.Найти(ПланыВидовХарактеристик.ВидыСубконтоМеждународные.ОсновныеСредства,) = Неопределено Тогда
				Движение.СубконтоКт[ПланыВидовХарактеристик.ВидыСубконтоМеждународные.ОсновныеСредства] = ТекСтрокаОсновныеСредства.ОсновноеСредство;
			КонецЕсли;
			
		КонецЕсли;
		
		ОбщаяСуммаКорректировки = СуммаДт - СуммаКт - СуммаКт1;
		
		// Проверяем если вместе с подготовкой к выбытию было и само выбытие
		СчетаОС = Новый Массив();
		СчетаОС.Добавить(ПланыСчетов.Международный.ОсновныеСредства); //101
		СчетаОС.Добавить(ПланыСчетов.Международный.ИнвестиционнаяСобственностьНетто); //102
		
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		               |	МеждународныйОбороты.Субконто1 КАК ОС,
		               |	СУММА(МеждународныйОбороты.СуммаОборотКт) КАК СуммаОборотКт,
		               |	МеждународныйОбороты.КорСчет
		               |ИЗ
		               |	РегистрБухгалтерии.Международный.Обороты(&НачалоПериода, &КонецПериода, Период, Счет В ИЕРАРХИИ (&Счет), &ОС, Организация = &Организация, НЕ(КорСчет В ИЕРАРХИИ (&СчетаОС)), ) КАК МеждународныйОбороты
		               |
		               |ГДЕ
		               |	МеждународныйОбороты.Субконто1 = &ОсновноеСредство
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	МеждународныйОбороты.Субконто1,
		               |	МеждународныйОбороты.КорСчет";
		
		Запрос.УстановитьПараметр("НачалоПериода", ПериодНачало);
		Запрос.УстановитьПараметр("КонецПериода", ПериодКонец);
		Запрос.УстановитьПараметр("Счет", ПланыСчетов.Международный.ОсновныеСредстваДляПродажи);
		Запрос.УстановитьПараметр("ОС", ПланыВидовХарактеристик.ВидыСубконтоМеждународные.ОсновныеСредства);
		Запрос.УстановитьПараметр("Организация", Организация);
		Запрос.УстановитьПараметр("СчетаОС", СчетаОС);
		Запрос.УстановитьПараметр("ОсновноеСредство", ТекСтрокаОсновныеСредства.ОсновноеСредство);

		Результат = Запрос.Выполнить();
		Выборка = Результат.Выбрать();
		
		Если Выборка.Следующий() Тогда // Если были операции, связанные с выбытием.
			ДвижениеРС.Состояние = Перечисления.ВидыСостоянийОС.СнятоСУчета;
			
			БухИтоги = Обработки.БухгалтерскиеИтоги.Создать();
			БухИтоги.РассчитатьИтоги("Международный", "КонечныйОстатокДт,КонечныйОстатокКт", "Сумма", "Счет,Субконто1", Дата, Дата, , ПланыСчетов.Международный.ОсновныеСредстваДляПродажи, ПланыВидовХарактеристик.ВидыСубконтоМеждународные.ОсновныеСредства, , ,"Организация", Организация);
			СуммаДт = БухИтоги.ПолучитьИтог("СуммаКонечныйОстатокДт", "Счет,Субконто1", ПланыСчетов.Международный.ОсновныеСредстваДляПродажи, ТекСтрокаОсновныеСредства.ОсновноеСредство) - БухИтоги.ПолучитьИтог("СуммаКонечныйОстатокКт", "Счет,Субконто1", ПланыСчетов.Международный.ОсновныеСредстваДляПродажи, ТекСтрокаОсновныеСредства.ОсновноеСредство);
			Если (СуммаДт + ОбщаяСуммаКорректировки) <> 0 Тогда // Если есть остаток по 201 с учетом предыдущей корретировки, то списываем его
				Движение = Движения.Международный.Добавить();
				Движение.Период = Дата;
				Движение.СчетДт = Выборка.КорСчет;
				Движение.СчетКт = ПланыСчетов.Международный.ОсновныеСредстваДляПродажи; //201
				Движение.Организация = Организация;
				Движение.Сумма = СуммаДт + ОбщаяСуммаКорректировки;
				Движение.Содержание = "Выбытие основного средства";
				Движение.НомерЖурнала = "Рег";
				
				Если не Движение.СчетДт.ВидыСубконто.Найти(ПланыВидовХарактеристик.ВидыСубконтоМеждународные.ОсновныеСредства,) = Неопределено Тогда
					Движение.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконтоМеждународные.ОсновныеСредства] = ТекСтрокаОсновныеСредства.ОсновноеСредство;
				КонецЕсли;
				
				Если не Движение.СчетКт.ВидыСубконто.Найти(ПланыВидовХарактеристик.ВидыСубконтоМеждународные.ОсновныеСредства,) = Неопределено Тогда
					Движение.СубконтоКт[ПланыВидовХарактеристик.ВидыСубконтоМеждународные.ОсновныеСредства] = ТекСтрокаОсновныеСредства.ОсновноеСредство;
				КонецЕсли;
				
				// Списываем резерв переоценки
				БухИтоги = Обработки.БухгалтерскиеИтоги.Создать();
				БухИтоги.РассчитатьИтоги("Международный", "КонечныйОстатокКт", "Сумма", "Счет,Субконто1", Дата, Дата, , ПланыСчетов.Международный.РезервыНаПереоценкуОСиИС, ПланыВидовХарактеристик.ВидыСубконтоМеждународные.ОсновныеСредства, , ,"Организация", Организация);
				СуммаСписания = БухИтоги.ПолучитьИтог("СуммаКонечныйОстатокКт", "Счет,Субконто1", ПланыСчетов.Международный.РезервыНаПереоценкуОСиИС, ТекСтрокаОсновныеСредства.ОсновноеСредство);
				Если СуммаСписания <> 0 Тогда
					Движение = Движения.Международный.Добавить();
					Движение.Период = Дата;
					Движение.СчетДт = ПланыСчетов.Международный.РезервыНаПереоценкуОСиИС; //30271
					Движение.СчетКт = ПланыСчетов.Международный.НераспределеннаяПрибыль; //304
					Движение.Организация = Организация;
					Движение.Сумма = СуммаСписания;
					Движение.Содержание = "Списание резерва";
					Движение.НомерЖурнала = "Рег";
					
					Если не Движение.СчетДт.ВидыСубконто.Найти(ПланыВидовХарактеристик.ВидыСубконтоМеждународные.ОсновныеСредства,) = Неопределено Тогда
						Движение.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконтоМеждународные.ОсновныеСредства] = ТекСтрокаОсновныеСредства.ОсновноеСредство;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
		// Проверяем, был ли резерв переоценки по данному ОС
		БухИтоги = Обработки.БухгалтерскиеИтоги.Создать();
		БухИтоги.РассчитатьИтоги("Международный", "КонечныйОстатокДт,КонечныйОстатокКт", "Сумма", "Счет,Субконто1", Дата, Дата, , ПланыСчетов.Международный.РезервыНаПереоценкуОСиИС, ПланыВидовХарактеристик.ВидыСубконтоМеждународные.ОсновныеСредства, , ,"Организация", Организация);
		СуммаКт = БухИтоги.ПолучитьИтог("СуммаКонечныйОстатокКт", "Счет,Субконто1", ПланыСчетов.Международный.РезервыНаПереоценкуОСиИС, ТекСтрокаОсновныеСредства.ОсновноеСредство) - БухИтоги.ПолучитьИтог("СуммаКонечныйОстатокДт", "Счет,Субконто1", ПланыСчетов.Международный.РезервыНаПереоценкуОСиИС, ТекСтрокаОсновныеСредства.ОсновноеСредство);
		
		Если СуммаКт <> 0 Тогда
			Движение = Движения.Международный.Добавить();
			Движение.Период = Дата;
			Движение.СчетДт = ПланыСчетов.Международный.РезервыНаПереоценкуОСиИС;
			Движение.СчетКт = ПланыСчетов.Международный.НераспределеннаяПрибыль;
			Движение.Организация = Организация;
			Движение.Сумма = СуммаКт;
			Движение.Содержание = "Закрытие резерва переоценки основного средства";
			Движение.НомерЖурнала = "Рег";
			
			Если не Движение.СчетДт.ВидыСубконто.Найти(ПланыВидовХарактеристик.ВидыСубконтоМеждународные.ОсновныеСредства,) = Неопределено Тогда
				Движение.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконтоМеждународные.ОсновныеСредства] = ТекСтрокаОсновныеСредства.ОсновноеСредство;
			КонецЕсли;
			
			Если не Движение.СчетКт.ВидыСубконто.Найти(ПланыВидовХарактеристик.ВидыСубконтоМеждународные.ОсновныеСредства,) = Неопределено Тогда
				Движение.СубконтоКт[ПланыВидовХарактеристик.ВидыСубконтоМеждународные.ОсновныеСредства] = ТекСтрокаОсновныеСредства.ОсновноеСредство;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	// записываем движения регистров
	Движения.ОсновныеСредстваМеждународныйУчет.Записать();
	Движения.Международный.Записать();
КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	Если ОбменДанными.Загрузка  Тогда
		Возврат;
	КонецЕсли;


	 
	мУдалятьДвижения = НЕ ЭтоНовый();
	
КонецПроцедуры // ПередЗаписью