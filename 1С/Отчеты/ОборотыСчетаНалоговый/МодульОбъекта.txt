Перем ИмяРегистраБухгалтерии Экспорт;

#Если Клиент Тогда

//////////////////////////////////////////////////////////
// ФОРМИРОВАНИЕ ЗАГОЛОВКА ОТЧЕТА
//

// Выводит заголовок отчета
//
// Параметры:
//	Нет.
//
Функция СформироватьЗаголовок() Экспорт

	ОписаниеПериода = БухгалтерскиеОтчеты.СформироватьСтрокуВыводаПараметровПоДатам(ДатаНач, ДатаКон);
	
	Макет = ПолучитьМакет("Макет");
	
	БухгалтерскиеОтчеты.УдалитьОбластьИзмакетаПриНеобходимости(Макет, "СальдоНачДт", СальдоНачДт);
	БухгалтерскиеОтчеты.УдалитьОбластьИзмакетаПриНеобходимости(Макет, "СальдоНачКт", СальдоНачКт);
	БухгалтерскиеОтчеты.УдалитьОбластьИзмакетаПриНеобходимости(Макет, "СальдоКонДт", СальдоКонДт);
	БухгалтерскиеОтчеты.УдалитьОбластьИзмакетаПриНеобходимости(Макет, "СальдоКонКт", СальдоКонКт);
	
	БухгалтерскиеОтчеты.УдалитьОбластьИзмакетаПриНеобходимости(Макет, "ОборотДт", ОборотДт);
	БухгалтерскиеОтчеты.УдалитьОбластьИзмакетаПриНеобходимости(Макет, "ОборотКт", ОборотКт);
	БухгалтерскиеОтчеты.УдалитьОбластьИзмакетаПриНеобходимости(Макет, "ОборотДтКорСчет", ОборотДтКорСчета);
	БухгалтерскиеОтчеты.УдалитьОбластьИзмакетаПриНеобходимости(Макет, "ОборотКтКорСчет", ОборотКтКорСчета);
	    		
	ЗаголовокОтчета = Макет.ПолучитьОбласть("Заголовок");
	ОбластьЗаголовок=Макет.Область("Заголовок");
	
	// После удаления областей нужно установить свойства ПоВыделеннымКолонкам
	Для Сч = 1 По ЗаголовокОтчета.ВысотаТаблицы-1 Цикл
		
		Макет.Область(ОбластьЗаголовок.Верх+Сч, 2, ОбластьЗаголовок.Верх+Сч, 2).РазмещениеТекста = ТипРазмещенияТекстаТабличногоДокумента.Переносить;
		Макет.Область(ОбластьЗаголовок.Верх+Сч, 2, ОбластьЗаголовок.Верх+Сч, ОбластьЗаголовок.Право).ПоВыделеннымКолонкам = Истина;
		
	КонецЦикла;
	
	ЗаголовокОтчета = Макет.ПолучитьОбласть("Заголовок");

	НазваниеОрганизации = Организация.НаименованиеПолное;
	Если ПустаяСтрока(НазваниеОрганизации) Тогда
		НазваниеОрганизации = Организация;
	КонецЕсли;
	
	ЗаголовокОтчета.Параметры.НазваниеОрганизации = НазваниеОрганизации;
	
	ЗаголовокОтчета.Параметры.ОписаниеПериода = ОписаниеПериода;

	ТекстПроИтоги = "";
	Если ПоСубсчетам Или ПоСубсчетамКорСчетов Тогда
		ТекстПроИтоги = ТекстПроИтоги + ", субсчетам"
	КонецЕсли;

	ДополнениеКИтогам = БухгалтерскиеОтчеты.СформироватьСтрокуОписанияИтоговПоИзмерениямПостроителя(ПостроительОтчета);
	
	Если НЕ ПустаяСтрока(ДополнениеКИтогам) Тогда
		ТекстПроИтоги = ТекстПроИтоги + ", " + ДополнениеКИтогам;
	КонецЕсли;
	ТекстПроИтоги = Сред(ТекстПроИтоги, 3);

	ТекстПроСписокПоказателей = "Выводимые данные: сумма";
	
	ЗаголовокОтчета.Параметры.ТекстПроСписокПоказателей = ТекстПроСписокПоказателей;

	Если Не ПустаяСтрока(ТекстПроИтоги) Тогда
		ЗаголовокОтчета.Параметры.ТекстПроИтоги = "Детализация по " + ТекстПроИтоги;
	КонецЕсли;

	ЗаголовокОтчета.Параметры.Заголовок = ЗаголовокОтчета();
	
	// Вывод списка фильтров:
	СтрОтбор = УправлениеОтчетами.СформироватьСтрокуОтборов(ПостроительОтчета.Отбор);
	Если ЗначениеЗаполнено(ВидУчета) Тогда
		СтрОтбор = СтрОтбор + ?(Не ПустаяСтрока(СтрОтбор),"; ","") + "Вид учета = " + ВидУчета;
	КонецЕсли;

	Если Не ПустаяСтрока(СтрОтбор) Тогда
		ОбластьОтбор = Макет.ПолучитьОбласть("СтрокаОтбор");
		ОбластьОтбор.Параметры.ТекстПроОтбор = "Отбор: " + СтрОтбор;
		ЗаголовокОтчета.Вывести(ОбластьОтбор);
	КонецЕсли;

	Возврат(ЗаголовокОтчета);

КонецФункции // СформироватьЗаголовок()

Функция ЗаголовокОтчета() Экспорт
	
	ИмяОтчета = "Обороты счета ";
	
	Возврат ИмяОтчета + ?(ЗначениеЗаполнено(Счет), Счет, "(не выбран счет)") + " (налоговый)";
	
КонецФункции // ЗаголовокОтчета()

//////////////////////////////////////////////////////////
// ПОСТРОЕНИЕ ОТЧЕТА
//

//Функция возвращает ограничения для отчета
Функция ПолучитьСтрокуОграниченийПоРеквизитамИПостроителю(Запрос)
	
	ОграниченияПоПостроителюОтчета = БухгалтерскиеОтчеты.ПолучитьТекстОграниченийПоПостроителюОтчета(ПостроительОтчета, Запрос);
	
	СтрокаОграниченийПоРеквизитам = "";
	БухгалтерскиеОтчеты.ДополнитьСтрокуОграниченийПоРеквизитам(СтрокаОграниченийПоРеквизитам, "Организация", Организация);
	БухгалтерскиеОтчеты.ДополнитьСтрокуОграниченийПоРеквизитам(СтрокаОграниченийПоРеквизитам, "ВидУчета", ВидУчета);
	
	Если Не ПустаяСтрока(ОграниченияПоПостроителюОтчета)
		И Не ПустаяСтрока(СтрокаОграниченийПоРеквизитам) Тогда
		
		ОграниченияПоПостроителюОтчета = " И " + ОграниченияПоПостроителюОтчета;
		
	КонецЕсли;
	
	Возврат СтрокаОграниченийПоРеквизитам + ОграниченияПоПостроителюОтчета;
	
КонецФункции

//Процедура устанавливает ограничения по запросу
Процедура УстановитьПараметрыЗапроса(Запрос, Знач АвтоматическиРассчитатьКонечнуюДатуОтчета = Ложь)
	
	Запрос.УстановитьПараметр("Счет", Счет);
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("ВидУчета", ВидУчета);

	Запрос.УстановитьПараметр("ДатаНач", ДатаНач);
	
	Если ДатаНач='00010101000000' Тогда
		Запрос.УстановитьПараметр("ДатаНач", ДатаНач+1);
	КонецЕсли;
	
	КонечнаяДатаОтчета = ДатаКон;			
		
	Если АвтоматическиРассчитатьКонечнуюДатуОтчета Тогда
			
		Если НЕ(Не ЗначениеЗаполнено(Период)
			ИЛИ Врег(Период) = "РЕГИСТРАТОР") Тогда
				
			ДатаПоследнегоОборота = ПолучитьДатуПоследнегоОборотаПоОтчету();
			КонечнаяДатаОтчета = ДатаПоследнегоОборота;
				
		КонецЕсли;
				
	КонецЕсли;
	
	Если КонечнаяДатаОтчета <> '00010101000000' Тогда
		КонечнаяДатаОтчета = Новый Граница(КонецДня(КонечнаяДатаОтчета), ВидГраницы.Включая);
	КонецЕсли;
		
	Запрос.УстановитьПараметр("ДатаКон", КонечнаяДатаОтчета);
	
КонецПроцедуры

//Функция возвращает дату последнего оборота по ограничениям
Функция ПолучитьДатуПоследнегоОборотаПоОтчету()
	
	Запрос = Новый Запрос;
	УстановитьПараметрыЗапроса(Запрос);
	
	ОграниченияПоРеквизитам = ПолучитьСтрокуОграниченийПоРеквизитамИПостроителю(Запрос);
	
	Запрос.Текст = "
	|Выбрать Разрешенные 
	|	Период КАК Период,
	|	КорСчет КАК КорСчет
	|ИЗ
	|	РегистрБухгалтерии."+ИмяРегистраБухгалтерии+".Обороты(&ДатаНач, &ДатаКон, " + Период + ", Счет В ИЕРАРХИИ (&Счет), , " + 
	ОграниченияПоРеквизитам + ") КАК БухОбороты
	|	УПОРЯДОЧИТЬ ПО
	|		Период УБЫВ";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если РезультатЗапроса.Пустой() Тогда
		Возврат КонецГода(ТекущаяДата());
	КонецЕсли;
		
	Выборка = РезультатЗапроса.Выбрать();
	Выборка.Следующий();
	
	КонечнаяДатаПериода = БухгалтерскиеОтчеты.ПолучитьДатуОкончанияПериода(Выборка.Период, Период);
	Возврат КонечнаяДатаПериода;
	
КонецФункции

// Формирование текста запроса
//
// Возвращаемое значение:
//   Строка   – текст сформированного запроса
//
Процедура СформироватьТекстЗапросов(МассивРесурсов, ЗапросОбороты, ЗапросОстатки)

	Периодичность = Период;
	
	ТекстСубконто = "";
	ТекстСубконтоИзмерения = "";
	
	// Субконто отчета
	Для Инд = 0 По ПостроительОтчета.ИзмеренияСтроки.Количество()-1 Цикл
		
		Измерение = ПостроительОтчета.ИзмеренияСтроки[Инд];
		
		СтрокаТипаИзмерения = БухгалтерскиеОтчеты.ПолучитьПоТипуИзмеренияПостроителяОтчетаСтрокуЗапроса(Измерение.ТипИзмерения);
				
		ТекстСубконто = ТекстСубконто + "
		|	" + Измерение.ПутьКДанным + " КАК " + Измерение.Имя + ",";
		ТекстСубконто = ТекстСубконто + "
		|	ПРЕДСТАВЛЕНИЕ(" + Измерение.ПутьКДанным + ") КАК " + Измерение.Имя + "Представление,";
		
		ТекстСубконтоИзмерения = ТекстСубконтоИзмерения + ",
		|	" + Измерение.ПутьКДанным +" "+СтрокаТипаИзмерения + " КАК " + Измерение.Имя;
						
	КонецЦикла;
	
	ОграниченияПоРеквизитам = ПолучитьСтрокуОграниченийПоРеквизитамИПостроителю(ЗапросОстатки);
	ОграниченияПоРеквизитам = ПолучитьСтрокуОграниченийПоРеквизитамИПостроителю(ЗапросОбороты);
	
	Если ПоСубсчетам Тогда
		
		ТекстСчет = 
		"	Счет КАК Счет, 
		
		|	Счет.Вид КАК ВидСчета, 
		|	Счет.Порядок КАК СчетПорядок, 
		|	Счет.Представление КАК СчетПредставление,";
		
	Иначе
		
		ТекстСчет = "";
		
	КонецЕсли;
		
	ТекстОбороты = "ВЫБРАТЬ РАЗРЕШЕННЫЕ" + ТекстСчет + ТекстСубконто + "
	|	КорСчет.Ссылка КАК КорСчет, 
	|	КорСчет.Порядок КАК КорСчетПорядок, 
	|	КорСчет.Представление КАК КорСчетПредставление,";
	
	ТекстОстатки = "ВЫБРАТЬ РАЗРЕШЕННЫЕ" + ТекстСчет +  ТекстСубконто + "";
	
	Если ЗначениеЗаполнено(Период) Тогда
		
		ТекстПериод = ?(ВРЕГ(Период)<>"РЕГИСТРАТОР",
					"
					|	Период,",
					"
					|	Регистратор КАК Период,
					|	ПРЕДСТАВЛЕНИЕ(Регистратор) КАК РегистраторПредставление,
					|	Регистратор.Дата КАК РегистраторДата,");
		ТекстОбороты = ТекстОбороты + ТекстПериод;
		ТекстОстатки = ТекстОстатки + ТекстПериод;
					
	КонецЕсли;
	
	Для каждого ИмяРесурса Из МассивРесурсов Цикл
		
		ТекстОбороты = ТекстОбороты + "
		|	" + ИмяРесурса + "ОборотДт КАК " + ИмяРесурса + "ОборотДт,
		|	" + ИмяРесурса + "ОборотКт КАК " + ИмяРесурса + "ОборотКт,
		|	ВЫБОР КОГДА "+ ИмяРесурса +"ОборотДт <> 0 ТОГДА 1 ИНАЧЕ 0 КОНЕЦ КАК Есть"+ ИмяРесурса +"ОборотДт,
		|	ВЫБОР КОГДА "+ ИмяРесурса +"ОборотКт <> 0 ТОГДА 1 ИНАЧЕ 0 КОНЕЦ КАК Есть"+ ИмяРесурса +"ОборотКт,";
		
		ТекстРазвернутоеСальдо = ?(РазвернутоеСальдо, "Развернутый", "");
		ТекстОстатки = ТекстОстатки + "
		|	" + ИмяРесурса + "Начальный" + ТекстРазвернутоеСальдо + "ОстатокДт КАК " + ИмяРесурса + "НачДт,
		|	" + ИмяРесурса + "Начальный" + ТекстРазвернутоеСальдо + "ОстатокКт КАК " + ИмяРесурса + "НачКт,
		|	" + ИмяРесурса + "Конечный"  + ТекстРазвернутоеСальдо + "ОстатокДт КАК " + ИмяРесурса + "КонДт,
		|	" + ИмяРесурса + "Конечный"  + ТекстРазвернутоеСальдо + "ОстатокКт КАК " + ИмяРесурса + "КонКт,
		|	" + ИмяРесурса + "ОборотДт КАК " + ИмяРесурса + "ЕстьОборотДт,
		|	" + ИмяРесурса + "ОборотКт КАК " + ИмяРесурса + "ЕстьОборотКт,";
		
	КонецЦикла;
	
	ТекстОстатки = Лев(ТекстОстатки, СтрДлина(ТекстОстатки) - 1);
	ТекстОбороты = Лев(ТекстОбороты, СтрДлина(ТекстОбороты) - 1);
	
	ТекстОбороты = ТекстОбороты + "
	|ИЗ
	|	РегистрБухгалтерии." + ИмяРегистраБухгалтерии + ".Обороты(&ДатаНач, &ДатаКон, " + Периодичность + 
	    ", Счет В ИЕРАРХИИ (&Счет), , " + ОграниченияПоРеквизитам + ") КАК Таблица
	| ";
	
	ТекстОстатки = ТекстОстатки + "
	|ИЗ
	|	РегистрБухгалтерии." + ИмяРегистраБухгалтерии + ".ОстаткиИОбороты(&ДатаНач, &ДатаКон, " + Периодичность + 
	    ", ДвиженияИГраницыПериода, счет В ИЕРАРХИИ (&счет), , " + ОграниченияПоРеквизитам + ") КАК Таблица
	|";
	
	ТекстИтогиОбороты = "";
	ТекстИтогиОстатки = "";
	ТекстПорядок = "";
	
	Если ПоСубсчетам Тогда
		ТекстПорядок = ТекстПорядок + ", СчетПорядок";
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Период) Тогда
		Если ВРег(Период)<>"РЕГИСТРАТОР" Тогда
			ТекстПорядок = ТекстПорядок + ", Период";
		Иначе
			ТекстПорядок = ТекстПорядок + ", РегистраторДата, Регистратор";
		КонецЕсли;
	КонецЕсли;
	
	Для каждого Измерение Из ПостроительОтчета.ИзмеренияСтроки Цикл
		ТекстПорядок = ТекстПорядок + ", " + Измерение.Имя;
	КонецЦикла;
	
	ТекстОбороты = ТекстОбороты + "
	|УПОРЯДОЧИТЬ ПО "+Сред(ТекстПорядок + ", КорСчетПорядок", 2);
	
	Если Не ПустаяСтрока(ТекстПорядок) Тогда
			
		ТекстОстатки = ТекстОстатки + "
		|УПОРЯДОЧИТЬ ПО "+Сред(ТекстПорядок, 2);
		
	КонецЕсли;
	
	Для каждого ИмяРесурса Из МассивРесурсов Цикл
	
		ТекстИтогиОбороты = ТекстИтогиОбороты + ",
		|	СУММА(" + ИмяРесурса + "ОборотДт),
		|	СУММА(" + ИмяРесурса + "ОборотКт),
		|	СУММА(Есть" + ИмяРесурса + "ОборотДт),
		|	СУММА(Есть" + ИмяРесурса + "ОборотКт)";
		
		ТекстИтогиОстатки = ТекстИтогиОстатки + ",
		|	СУММА(" + ИмяРесурса + "НачДт),
		|	СУММА(" + ИмяРесурса + "НачКт),
		|	СУММА(" + ИмяРесурса + "КонДт),
		|	СУММА(" + ИмяРесурса + "КонКт),
		|	СУММА(" + ИмяРесурса + "ЕстьОборотДт),
		|	СУММА(" + ИмяРесурса + "ЕстьОборотКт)";

	КонецЦикла; 
		
	ТекстОбороты = ТекстОбороты + "
	|ИТОГИ " + Сред(ТекстИтогиОбороты, 2)+ "
	|	ПО ОБЩИЕ";
	
	ТекстОстатки = ТекстОстатки + "
	|ИТОГИ " + Сред(ТекстИтогиОстатки, 2)+ "
	|	ПО ОБЩИЕ";
	
	Если ПоСубсчетам Тогда
		ТекстОбороты = ТекстОбороты +	",
		|	Счет ИЕРАРХИЯ КАК Счет";
		ТекстОстатки = ТекстОстатки +	",
		|	Счет ИЕРАРХИЯ КАК Счет";
	КонецЕсли;
	
	// добавим итоги по субконто
	ТекстОбороты = ТекстОбороты + ТекстСубконтоИзмерения;
	ТекстОстатки = ТекстОстатки + ТекстСубконтоИзмерения;
	
	Если ЗначениеЗаполнено(Период) Тогда
		
		Текст = ", Период ";
		Если ВсеПериоды и Врег(Период) <> "РЕГИСТРАТОР" Тогда
			Текст = Текст + " ПЕРИОДАМИ(" + Период + ",,)";
		КонецЕсли;
		Текст = Текст + " КАК Период";
		
		ТекстОбороты = ТекстОбороты + Текст;
		ТекстОстатки = ТекстОстатки + Текст;
		
	КонецЕсли;
	
	ТекстОбороты = ТекстОбороты + ", КорСчет ИЕРАРХИЯ КАК КорСчет";
	
	ТекстОбороты = ТекстОбороты + "
	|АВТОУПОРЯДОЧИВАНИЕ";
	
	ТекстОстатки = ТекстОстатки + "
	|АВТОУПОРЯДОЧИВАНИЕ";
	
	ЗапросОбороты.Текст = ТекстОбороты;
	ЗапросОстатки.Текст = ТекстОстатки;

КонецПроцедуры

// Выполняет запрос и формирует табличный документ-результат отчета
// в соответствии с настройками, заданными значениями реквизитов отчета.
//
// Параметры:
//  ДокументРезультат - табличный документ, формируемый отчетом
//
Процедура СформироватьОтчет(ДокументРезультат,  ПоказыватьЗаголовок = Истина, ВысотаЗаголовка = 0) Экспорт

	Если Счет.Пустая() Тогда
		Предупреждение("Не выбран счет!", 60);
		Возврат;
	КонецЕсли;

	ОграничениеПоДатамКорректно = БухгалтерскиеОтчеты.ПроверитьКорректностьОграниченийПоДатам(ДатаНач, ДатаКон);
	Если НЕ ОграничениеПоДатамКорректно Тогда
        Возврат;
	КонецЕсли;
	
	НаличиеДублей = БухгалтерскиеОтчеты.ОпределитьНаличиеДублирующегосяПараметраВИзмерениях(ПостроительОтчета);
	Если НаличиеДублей Тогда
		Возврат;
	КонецЕсли;
	
	ДокументРезультат.Очистить();
	
	МассивРесурсов = СформироватьМассивПоказателей();
	
	МассивГруппировок = СформироватьМассивГруппировок();
	
	ЗапросОбороты = Новый Запрос;
	ЗапросОстатки = Новый Запрос;
	
	УстановитьПараметрыЗапроса(ЗапросОбороты);
	УстановитьПараметрыЗапроса(ЗапросОстатки);
	СформироватьТекстЗапросов(МассивРесурсов, ЗапросОбороты, ЗапросОстатки);
	
	ОтборСубконто = Новый Соответствие;
	Для каждого Элемент Из ПостроительОтчета.Отбор Цикл
		Если Элемент.Использование Тогда
			ОтборСубконто.Вставить(Элемент.ПутьКДанным, Элемент.Значение);
		КонецЕсли;
	КонецЦикла;
	
	Состояние("Выполнение запроса");
	
	Макет = ПолучитьМакет("Макет");

	РезультатОбороты = ЗапросОбороты.Выполнить();
	РезультатОстатки = ЗапросОстатки.Выполнить();
	
	// Вывод заголовка отчета
	БухгалтерскиеОтчеты.СформироватьИВывестиЗаголовокОтчета(ЭтотОбъект, ДокументРезультат, ВысотаЗаголовка, ПоказыватьЗаголовок);
	
	ФорматПериода = БухгалтерскиеОтчеты.ПолучитьСтрокуФорматаПериода(Период);
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ДокументРезультат",ДокументРезультат);
	СтруктураПараметров.Вставить("МассивГруппировок", МассивГруппировок);
	
	// Период
	СтруктураПараметров.Вставить("ОбластьСтрокаПериод", Макет.ПолучитьОбласть("Строка|Период"));
	СтруктураПараметров.ОбластьСтрокаПериод.Область(1, 2).Формат = ФорматПериода;
	
	// Нач сальдо
	СтруктураПараметров.Вставить("ОбластьСтрокаСальдоНачДт", Макет.ПолучитьОбласть("Строка|СальдоНачДт"));
	СтруктураПараметров.Вставить("ОбластьСтрокаСальдоНачКт", Макет.ПолучитьОбласть("Строка|СальдоНачКт"));
	
	// Кон сальдо
	СтруктураПараметров.Вставить("ОбластьСтрокаСальдоКонДт", Макет.ПолучитьОбласть("Строка|СальдоКонДт"));
	СтруктураПараметров.Вставить("ОбластьСтрокаСальдоКонКт", Макет.ПолучитьОбласть("Строка|СальдоКонКт"));
	
	// Оборот 
	СтруктураПараметров.Вставить("ОбластьСтрокаОборотДт", Макет.ПолучитьОбласть("Строка|ОборотДт"));
	СтруктураПараметров.Вставить("ОбластьСтрокаОборотКт", Макет.ПолучитьОбласть("Строка|ОборотКт"));
	СтруктураПараметров.Вставить("ОбластьСтрокаОборотДтКорСчет", Макет.ПолучитьОбласть("Строка|ОборотДтКорСчет"));
	СтруктураПараметров.Вставить("ОбластьСтрокаОборотКтКорСчет", Макет.ПолучитьОбласть("Строка|ОборотКтКорСчет"));
	
	Если МассивГруппировок.Количество()>0 Тогда
		// Субконто
		СтруктураПараметров.Вставить("ОбластьСтрокаСубконтоПериод", Макет.ПолучитьОбласть("СтрокаСубконто|Период"));
		
		// Нач сальдо
		СтруктураПараметров.Вставить("ОбластьСтрокаСубконтоСальдоНачДт", Макет.ПолучитьОбласть("СтрокаСубконто|СальдоНачДт"));
		СтруктураПараметров.Вставить("ОбластьСтрокаСубконтоСальдоНачКт", Макет.ПолучитьОбласть("СтрокаСубконто|СальдоНачКт"));
		
		// Кон сальдо
		СтруктураПараметров.Вставить("ОбластьСтрокаСубконтоСальдоКонДт", Макет.ПолучитьОбласть("СтрокаСубконто|СальдоКонДт"));
		СтруктураПараметров.Вставить("ОбластьСтрокаСубконтоСальдоКонКт", Макет.ПолучитьОбласть("СтрокаСубконто|СальдоКонКт"));
		
		// Оборот 
		СтруктураПараметров.Вставить("ОбластьСтрокаСубконтоОборотДт", Макет.ПолучитьОбласть("СтрокаСубконто|ОборотДт"));
		СтруктураПараметров.Вставить("ОбластьСтрокаСубконтоОборотКт", Макет.ПолучитьОбласть("СтрокаСубконто|ОборотКт"));
		СтруктураПараметров.Вставить("ОбластьСтрокаСубконтоОборотДтКорСчет", Макет.ПолучитьОбласть("СтрокаСубконто|ОборотДтКорСчет"));
		СтруктураПараметров.Вставить("ОбластьСтрокаСубконтоОборотКтКорСчет", Макет.ПолучитьОбласть("СтрокаСубконто|ОборотКтКорСчет"));
		
		Если ПоКоличеству Тогда
			// Субконто
			СтруктураПараметров.Вставить("ОбластьСтрокаСубконтоКоличествоПериод", Макет.ПолучитьОбласть("СтрокаСубконтоКоличество|Период"));
			
			// Нач сальдо
			СтруктураПараметров.Вставить("ОбластьСтрокаСубконтоКоличествоСальдоНачДт", Макет.ПолучитьОбласть("СтрокаСубконтоКоличество|СальдоНачДт"));
			СтруктураПараметров.Вставить("ОбластьСтрокаСубконтоКоличествоСальдоНачКт", Макет.ПолучитьОбласть("СтрокаСубконтоКоличество|СальдоНачКт"));
			
			// Кон сальдо
			СтруктураПараметров.Вставить("ОбластьСтрокаСубконтоКоличествоСальдоКонДт", Макет.ПолучитьОбласть("СтрокаСубконтоКоличество|СальдоКонДт"));
			СтруктураПараметров.Вставить("ОбластьСтрокаСубконтоКоличествоСальдоКонКт", Макет.ПолучитьОбласть("СтрокаСубконтоКоличество|СальдоКонКт"));
			
			// Оборот 
			СтруктураПараметров.Вставить("ОбластьСтрокаСубконтоКоличествоОборотДт", Макет.ПолучитьОбласть("СтрокаСубконтоКоличество|ОборотДт"));
			СтруктураПараметров.Вставить("ОбластьСтрокаСубконтоКоличествоОборотКт", Макет.ПолучитьОбласть("СтрокаСубконтоКоличество|ОборотКт"));
			СтруктураПараметров.Вставить("ОбластьСтрокаСубконтоКоличествоОборотДтКорСчет", Макет.ПолучитьОбласть("СтрокаСубконтоКоличество|ОборотДтКорСчет"));
			СтруктураПараметров.Вставить("ОбластьСтрокаСубконтоКоличествоОборотКтКорСчет", Макет.ПолучитьОбласть("СтрокаСубконтоКоличество|ОборотКтКорСчет"));
			
			
			// Период
			СтруктураПараметров.Вставить("ОбластьСтрокаКоличествоПериод", Макет.ПолучитьОбласть("СтрокаКоличество|Период"));
			СтруктураПараметров.ОбластьСтрокаКоличествоПериод.Область(1, 2).Формат = ФорматПериода;
			
			// Нач сальдо
			СтруктураПараметров.Вставить("ОбластьСтрокаКоличествоСальдоНачДт", Макет.ПолучитьОбласть("СтрокаКоличество|СальдоНачДт"));
			СтруктураПараметров.Вставить("ОбластьСтрокаКоличествоСальдоНачКт", Макет.ПолучитьОбласть("СтрокаКоличество|СальдоНачКт"));
			
			// Кон сальдо
			СтруктураПараметров.Вставить("ОбластьСтрокаКоличествоСальдоКонДт", Макет.ПолучитьОбласть("СтрокаКоличество|СальдоКонДт"));
			СтруктураПараметров.Вставить("ОбластьСтрокаКоличествоСальдоКонКт", Макет.ПолучитьОбласть("СтрокаКоличество|СальдоКонКт"));
			
			// Оборот 
			СтруктураПараметров.Вставить("ОбластьСтрокаКоличествоОборотДт", Макет.ПолучитьОбласть("СтрокаКоличество|ОборотДт"));
			СтруктураПараметров.Вставить("ОбластьСтрокаКоличествоОборотКт", Макет.ПолучитьОбласть("СтрокаКоличество|ОборотКт"));
			СтруктураПараметров.Вставить("ОбластьСтрокаКоличествоОборотДтКорСчет", Макет.ПолучитьОбласть("СтрокаКоличество|ОборотДтКорСчет"));
			СтруктураПараметров.Вставить("ОбластьСтрокаКоличествоОборотКтКорСчет", Макет.ПолучитьОбласть("СтрокаКоличество|ОборотКтКорСчет"));
		КонецЕсли;
		
	КонецЕсли;
	
	// Вывод отчета
	ОбщийИтогОбороты = РезультатОбороты.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам, "Общие");
	ОбщийИтогОстатки = РезультатОстатки.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам, "Общие");
	ЕстьИтог = ОбщийИтогОстатки.Следующий();
	ОбщийИтогОбороты.Следующий();
	
	ДокументРезультат.НачатьАвтогруппировкуКолонок();
	
	НачалоЗаголовка = Макет.ПолучитьОбласть("ЗаголовокТаблицы|Период");
	
	Если МассивГруппировок.Количество()>0 Тогда
		НачалоЗаголовка.Параметры.Заголовок = "Субконто";
	ИначеЕсли ЗначениеЗаполнено(Период) Тогда
		НачалоЗаголовка.Параметры.Заголовок = "Период";
	КонецЕсли;
	
	ДокументРезультат.Вывести(НачалоЗаголовка,0);
	
	ШиринаТаблицы = НачалоЗаголовка.ШиринаТаблицы;
	
	СписокДт = Неопределено;
	СписокКт = Неопределено;
	Выборка = Неопределено;
	БухгалтерскиеОтчеты.ВывестиПолныйЗаголовокОтчетаОборотовСчета(Выборка, ШиринаТаблицы, ЭтотОбъект, Макет, ДокументРезультат,
		РезультатОбороты, "ЗаголовокТаблицы", МассивРесурсов, СписокДт, СписокКт, 1);
		
	ДокументРезультат.ЗакончитьАвтогруппировкуКолонок();
	
	// Массивы хранят счета, по которым были обороты
	СтруктураПараметров.Вставить("СписокДт", СписокДт);
	СтруктураПараметров.Вставить("СписокКт", СписокКт);
	
	СоответствиеСчетовПредков = БухгалтерскиеОтчеты.ВернутьСоответвиеСчетовПредков(Метаданные.РегистрыБухгалтерии[ИмяРегистраБухгалтерии].ПланСчетов.Имя, Счет);
	СтруктураПараметров.Вставить("СоответствиеСчетовПредков", СоответствиеСчетовПредков);
	
	// вывод данных отчета
	ДокументРезультат.НачатьАвтогруппировкуСтрок();
	Если МассивГруппировок.Количество() > 0 Тогда
		
		ВыводСубконто(РезультатОбороты, РезультатОстатки, 0, СтруктураПараметров, ОтборСубконто, ПоКоличеству);
		
	ИначеЕсли ЗначениеЗаполнено(Период) Тогда
		
		ВывестиПериоды(РезультатОбороты, РезультатОстатки, СтруктураПараметров, ОтборСубконто);
		
	КонецЕсли;
	ДокументРезультат.ЗакончитьАвтогруппировкуСтрок();
	
	ДокументРезультат.Вывести(Макет.ПолучитьОбласть("Итог|Период"));
	
	// Вывод заголовков нач.сальдо
	ТекШиринаТаблицы = 0;
	БухгалтерскиеОтчеты.ВывестиПолныйЗаголовокОтчетаОборотовСчета(Выборка, ТекШиринаТаблицы, ЭтотОбъект, Макет, ДокументРезультат,
		РезультатОбороты, "Итог", МассивРесурсов, СписокДт, СписокКт, 0, ОбщийИтогОстатки, ОбщийИтогОбороты);
		                      
	ЗаполнитьИПрисоединитьОбласть(СальдоКонДт, СтруктураПараметров.ДокументРезультат, Макет.ПолучитьОбласть("Итог|СальдоКонДт"), ОбщийИтогОстатки);
	ЗаполнитьИПрисоединитьОбласть(СальдоКонКт, СтруктураПараметров.ДокументРезультат, Макет.ПолучитьОбласть("Итог|СальдоКонКт"), ОбщийИтогОстатки);
			
	// Обведение таблицы отчета линией, как в области границы
	ОбластьИтогПериод = Макет.ПолучитьОбласть("Итог|Период");
	
	ТолстаяЛиния = ОбластьИтогПериод.Область(1, 2).ГраницаСверху;
	
	ШиринаТаблицы = ШиринаТаблицы + СписокДт.Количество() + СписокКт.Количество();
	
	ДокументРезультат.Область(ВысотаЗаголовка + 2, 2, ДокументРезультат.ВысотаТаблицы, ШиринаТаблицы).Обвести(ТолстаяЛиния, ТолстаяЛиния, ТолстаяЛиния, ТолстаяЛиния);
	
	ШиринаТаблицы = ДокументРезультат.ШиринаТаблицы;
	
	// Заполним общую расшифровку:
	СтруктураНастроекОтчета = СформироватьОбщуюСтруктуруДляРасшифровки();
	СтруктураНастроекОтчета.Вставить("ПоказыватьЗаголовок", ПоказыватьЗаголовок);

	ДокументРезультат.Область(1,1).Расшифровка = СтруктураНастроекОтчета;

	// Зафиксируем заголовок отчета
	ДокументРезультат.ФиксацияСверху = ВысотаЗаголовка + 2;

	// Первую колонку не печатаем
	ДокументРезультат.ОбластьПечати = ДокументРезультат.Область(1,2,ДокументРезультат.ВысотаТаблицы,ДокументРезультат.ШиринаТаблицы);
	
	// Присвоим имя для сохранения параметров печати табличного документа
	ДокументРезультат.ИмяПараметровПечати = "ОборотноСальдоваяВедомостьПоСчету " + ИмяРегистраБухгалтерии;
	
	УправлениеОтчетами.УстановитьКолонтитулыПоУмолчанию(ДокументРезультат, ЗаголовокОтчета(), Строка(глЗначениеПеременной("глТекущийПользователь")));
	
КонецПроцедуры

//Функция возвращает массив показателей для отчета
Функция СформироватьМассивПоказателей() Экспорт
	
	МассивПоказателей = Новый Массив;
	МассивПоказателей.Добавить("Сумма");
	
	Если ПоКоличеству Тогда
		МассивПоказателей.Добавить("Количество");
	КонецЕсли;

	Возврат МассивПоказателей;
		
КонецФункции

//Функция возвращает общую структуру для расшифровки
Функция СформироватьОбщуюСтруктуруДляРасшифровки() Экспорт
	
	СтруктураНастроекОтчета = Новый Структура;

	СтруктураНастроекОтчета.Вставить("ДатаНач", ДатаНач);
	СтруктураНастроекОтчета.Вставить("ДатаКон", ДатаКон);
	СтруктураНастроекОтчета.Вставить("Организация", Организация);
	СтруктураНастроекОтчета.Вставить("ВидУчета", ВидУчета);
	СтруктураНастроекОтчета.Вставить("Период", Период);
		
	НастройкиОтбора = УправлениеОтчетами.ПолучитьКопиюОтбораВТЗ(ПостроительОтчета.Отбор);
	
	СтруктураНастроекОтчета.Вставить("Отбор", НастройкиОтбора);
			
	Возврат СтруктураНастроекОтчета;
	
КонецФункции

//Функция возвращает массив группировок для отчета
Функция СформироватьМассивГруппировок() Экспорт
	
	МассивГруппировок = Новый Массив;

	Если ПоСубСчетам Тогда
		МассивГруппировок.Добавить("Счет");
	КонецЕсли;
	
	Для Сч = 0 По ПостроительОтчета.ИзмеренияСтроки.Количество() - 1  Цикл
		
		МассивГруппировок.Добавить(ПостроительОтчета.ИзмеренияСтроки[Сч].Имя);
		
	КонецЦикла;

	Возврат МассивГруппировок;
		
КонецФункции

Процедура ЗаполнитьИПрисоединитьОбласть(Присоединять, ДокументРезультат, Область, Выборка, Уровень = Неопределено)
	
	Если НЕ Присоединять Тогда
		Возврат;
	КонецЕсли;
	
	Если Выборка <> Неопределено Тогда
		Область.Параметры.Заполнить(Выборка);
	Иначе
		Для Индекс = 0 По Область.Параметры.Количество() - 1 Цикл
			Область.Параметры.Установить(Индекс, Неопределено);
		КонецЦикла;
	КонецЕсли;
	
	ДокументРезультат.Присоединить(Область, Уровень);
	
КонецПроцедуры

// Вывод субконто определенного номера
Процедура ВыводСубконто(Знач ВыборкаОбороты, Знач ВыборкаОстатки, Знач Инд, СтруктураПараметров, ОтборДляРасшифровки, Знач ВыводКоличества)
	
	Если Инд > СтруктураПараметров.МассивГруппировок.Количество() - 1 Тогда
		
		Если ЗначениеЗаполнено(Период) Тогда
			
			ВывестиПериоды(ВыборкаОбороты, ВыборкаОстатки, СтруктураПараметров, ОтборДляРасшифровки, ВыводКоличества);
			
		КонецЕсли;
		
		Возврат;
		
	КонецЕсли;	
		
	Измерение = СтруктураПараметров.МассивГруппировок[Инд];
	
	ОборотИспользован = УправлениеОтчетами.СформироватьВыборку(ВыборкаОбороты, ОбходРезультатаЗапроса.ПоГруппировкам, Измерение);
	ОстатокИспользован = УправлениеОтчетами.СформироватьВыборку(ВыборкаОстатки, ОбходРезультатаЗапроса.ПоГруппировкам, Измерение);
	
	ОстатокПрочитан = Ложь;
	ОборотПрочитан = Ложь;
		
	ВыводКоличества = ПоКоличеству;
		
	Пока Истина Цикл
			
			Если ОстатокИспользован Тогда
				ОстатокПрочитан = ВыборкаОстатки.Следующий();
				ОстатокИспользован = Ложь;
			КонецЕсли;
			
			Если ОборотИспользован Тогда
				ОборотПрочитан = ВыборкаОбороты.Следующий();
				ОборотИспользован = Ложь;
			КонецЕсли;
			
			// Оборот сопоставляется с остатком
			Если ОборотПрочитан И ОстатокПрочитан
			   И ВыборкаОстатки[Измерение] = ВыборкаОбороты[Измерение] Тогда
			   
				ОборотИспользован = Истина;
				ОстатокИспользован = Истина;
				
			ИначеЕсли ОборотПрочитан И БухгалтерскиеОтчеты.ЭтоНулевойОборот(ВыборкаОбороты, ПоКоличеству) Тогда
				
				ОборотИспользован = Истина;
				
			ИначеЕсли ОстатокПрочитан Тогда
				ОстатокИспользован = Истина;
			КонецЕсли;
			
			Если Не ОстатокИспользован И Не ОборотИспользован Тогда
				Прервать;
			КонецЕсли;
			
			Выборка = ?(ОстатокИспользован, ВыборкаОстатки, ВыборкаОбороты);
			ВыборкаОборотыПараметр = ?(ОборотИспользован,  ВыборкаОбороты, Неопределено);
			ВыборкаОстаткиПараметр = ?(ОстатокИспользован, ВыборкаОстатки, Неопределено);
			
		ТипЗаписи = Выборка.ТипЗаписи();
		
		// счета более верхнего уровня выводить не надо
		Если Измерение = "Счет"
			И ТипЗаписи = ТипЗаписиЗапроса.ИтогПоИерархии
			И СтруктураПараметров.СоответствиеСчетовПредков[Выборка.Счет] <> Неопределено Тогда
			
			Продолжить;
			
		КонецЕсли;
		
		Уровень = Выборка.Уровень();
			
		Если ТипЗаписи = ТипЗаписиЗапроса.ИтогПоИерархии Тогда
			ВыводитьКоличествоВТекущейСтроке = Ложь;
		Иначе
			ВыводитьКоличествоВТекущейСтроке = ВыводКоличества;
		КонецЕсли;
			
		Если ВыводитьКоличествоВТекущейСтроке Тогда
			ТекстКоличество = "Количество";
		Иначе
			ТекстКоличество = "";
		КонецЕсли;
		
		ОблНачало          = СтруктураПараметров["ОбластьСтрокаСубконто" + ТекстКоличество + "Период"];
		ОблСальдоНачДт     = СтруктураПараметров["ОбластьСтрокаСубконто" + ТекстКоличество + "СальдоНачДт"];
		ОблСальдоНачКт     = СтруктураПараметров["ОбластьСтрокаСубконто" + ТекстКоличество + "СальдоНачКт"];
		ОблОборотДт        = СтруктураПараметров["ОбластьСтрокаСубконто" + ТекстКоличество + "ОборотДт"];
		ОблОборотКт        = СтруктураПараметров["ОбластьСтрокаСубконто" + ТекстКоличество + "ОборотКт"];
		ОблОборотДтКорСчет = СтруктураПараметров["ОбластьСтрокаСубконто" + ТекстКоличество + "ОборотДтКорСчет"];
		ОблОборотКтКорСчет = СтруктураПараметров["ОбластьСтрокаСубконто" + ТекстКоличество + "ОборотКтКорСчет"];
		ОблСальдоКонДт     = СтруктураПараметров["ОбластьСтрокаСубконто" + ТекстКоличество + "СальдоКонДт"];
		ОблСальдоКонКт     = СтруктураПараметров["ОбластьСтрокаСубконто" + ТекстКоличество + "СальдоКонКт"];
			
		ОблНачало.Область(1, 2, ОблНачало.ВысотаТаблицы, 2).Отступ = Уровень;
			
		// Вывод нач сальдо
		ОблНачало.Параметры.СубконтоПредставление = Выборка[Измерение + "Представление"];
			
		// Расшифровка
		ЗаполнитьПараметрыРасшифровки(ОблНачало, Выборка, СтруктураПараметров);
			
		СтруктураПараметров.ДокументРезультат.Вывести(ОблНачало, Уровень);
			
		// В итогах по иерархии шрифт меняется на наклонный
		Если ТипЗаписи = ТипЗаписиЗапроса.ИтогПоИерархии Тогда
			
			СтруктураПараметров.ДокументРезультат.Область(СтруктураПараметров.ДокументРезультат.ВысотаТаблицы, 2).Шрифт = 
				Новый Шрифт(СтруктураПараметров.ДокументРезультат.Область(СтруктураПараметров.ДокументРезультат.ВысотаТаблицы, 2).Шрифт,,,,Истина);
			
		КонецЕсли;
				
		// На начало периода дебет
		ЗаполнитьИПрисоединитьОбласть(СальдоНачДт, СтруктураПараметров.ДокументРезультат, ОблСальдоНачДт, ВыборкаОстаткиПараметр, Уровень);
		ЗаполнитьИПрисоединитьОбласть(СальдоНачКт, СтруктураПараметров.ДокументРезультат, ОблСальдоНачКт, ВыборкаОстаткиПараметр, Уровень);
		
		Если ОборотИспользован И (ОборотДтКорСчета ИЛИ ОборотКтКорСчета) Тогда
			ВыборкаПоКорСчетам = ВыборкаОборотыПараметр.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам, "КорСчет", "Все");
		Иначе
			ВыборкаПоКорСчетам = Неопределено;
		КонецЕсли;
		
		// ОБОРОТЫ
		//оборот Дт
		ЗаполнитьИПрисоединитьОбласть(ОборотДт, СтруктураПараметров.ДокументРезультат, ОблОборотДт, ВыборкаОборотыПараметр, Уровень);
			
		Если ОборотДтКорСчета Тогда
			// Вывод вложенных итогов по кор счетам
			ВывестиКорСчета(ВыборкаПоКорСчетам, СтруктураПараметров, "ДТ", "Сумма"+?(ВыводитьКоличествоВТекущейСтроке, ", Количество", ""), 
				ОблОборотДтКорСчет, ОтборДляРасшифровки, Выборка);
		КонецЕсли;
					
		// Оборот Кт
		ЗаполнитьИПрисоединитьОбласть(ОборотКт, СтруктураПараметров.ДокументРезультат, ОблОборотКт, ВыборкаОборотыПараметр, Уровень);
			
		Если ОборотКтКорСчета Тогда
			Если ОборотИспользован Тогда
				ВыборкаПоКорСчетам.Сбросить();
			КонецЕсли;
			// Вывод вложенных итогов по кор счетам
			ВывестиКорСчета(ВыборкаПоКорСчетам, СтруктураПараметров, "КТ", "Сумма"+?(ВыводитьКоличествоВТекущейСтроке, ", Количество", ""), 
				ОблОборотКтКорСчет, ОтборДляРасшифровки, Выборка);
		КонецЕсли;

		ЗаполнитьИПрисоединитьОбласть(СальдоКонДт, СтруктураПараметров.ДокументРезультат, ОблСальдоКонДт, ВыборкаОстаткиПараметр, Уровень);
		ЗаполнитьИПрисоединитьОбласть(СальдоКонКт, СтруктураПараметров.ДокументРезультат, ОблСальдоКонКт, ВыборкаОстаткиПараметр, Уровень);		
		
		// Вывод вложенных итогов
		Если ТипЗаписи <> ТипЗаписиЗапроса.ИтогПоИерархии Тогда
				
			ВыводСубконто(ВыборкаОборотыПараметр, ВыборкаОстаткиПараметр, Инд + 1, СтруктураПараметров, ОтборДляРасшифровки, ВыводКоличества);
			
		КонецЕсли;
				
	КонецЦикла;
			
КонецПроцедуры

// Вывод периодов
Процедура ВывестиПериоды(ВыборкаОбороты, ВыборкаОстатки, СтруктураПараметров, ОтборДляРасшифровки, ВыводКоличества = Ложь)
	
	Измерение = "Период";
		
	ОстатокПрочитан = Ложь;
	ОборотПрочитан = Ложь;
		
	Если ВсеПериоды Тогда
		ОборотИспользован  = УправлениеОтчетами.СформироватьВыборку(ВыборкаОбороты, ОбходРезультатаЗапроса.ПоГруппировкам, Измерение, "Все");
		ОстатокИспользован = УправлениеОтчетами.СформироватьВыборку(ВыборкаОстатки, ОбходРезультатаЗапроса.ПоГруппировкам, Измерение, "Все");
	Иначе
		ОборотИспользован  = УправлениеОтчетами.СформироватьВыборку(ВыборкаОбороты, ОбходРезультатаЗапроса.ПоГруппировкам, Измерение);
		ОстатокИспользован = УправлениеОтчетами.СформироватьВыборку(ВыборкаОстатки, ОбходРезультатаЗапроса.ПоГруппировкам, Измерение);
	КонецЕсли;
	
	Если ВыводКоличества Тогда
		ТекстКоличество = "Количество";
	Иначе
		ТекстКоличество = "";
	КонецЕсли;
		
	ОблНачало          = СтруктураПараметров["ОбластьСтрока" + ТекстКоличество + "Период"];
	ОблСальдоНачДт     = СтруктураПараметров["ОбластьСтрока" + ТекстКоличество + "СальдоНачДт"];
	ОблСальдоНачКт     = СтруктураПараметров["ОбластьСтрока" + ТекстКоличество + "СальдоНачКт"];
	ОблОборотДт        = СтруктураПараметров["ОбластьСтрока" + ТекстКоличество + "ОборотДт"];
	ОблОборотКт        = СтруктураПараметров["ОбластьСтрока" + ТекстКоличество + "ОборотКт"];
	ОблОборотДтКорСчет = СтруктураПараметров["ОбластьСтрока" + ТекстКоличество + "ОборотДтКорСчет"];
	ОблОборотКтКорСчет = СтруктураПараметров["ОбластьСтрока" + ТекстКоличество + "ОборотКтКорСчет"];
	ОблСальдоКонДт     = СтруктураПараметров["ОбластьСтрока" + ТекстКоличество + "СальдоКонДт"];
	ОблСальдоКонКт     = СтруктураПараметров["ОбластьСтрока" + ТекстКоличество + "СальдоКонКт"];
	
	Пока Истина Цикл
		
		Если ОстатокИспользован Тогда
			ОстатокПрочитан = ВыборкаОстатки.Следующий();
			ОстатокИспользован = Ложь;
		КонецЕсли;
		
		Если ОборотИспользован Тогда
			ОборотПрочитан = ВыборкаОбороты.Следующий();
			ОборотИспользован = Ложь;
		КонецЕсли;
		
		// Оборот сопоставляется с остатком
		Если ОборотПрочитан И ОстатокПрочитан
			И ВыборкаОстатки[Измерение] = ВыборкаОбороты[Измерение] Тогда
			
			ОборотИспользован = Истина;
			ОстатокИспользован = Истина;
			
		ИначеЕсли ОборотПрочитан И БухгалтерскиеОтчеты.ЭтоНулевойОборот(ВыборкаОбороты, ПоКоличеству) Тогда
			
			ОборотИспользован = Истина;
			
		ИначеЕсли ОстатокПрочитан Тогда
			ОстатокИспользован = Истина;
		КонецЕсли;
		
		Если Не ОстатокИспользован И Не ОборотИспользован Тогда
			Прервать;
		КонецЕсли;
		
		Если Не ОборотИспользован И Не ВсеПериоды Тогда
			Продолжить;
		КонецЕсли;
				
		Выборка = ?(ОстатокИспользован, ВыборкаОстатки, ВыборкаОбороты);
		ВыборкаОборотыПараметр = ?(ОборотИспользован, ВыборкаОбороты, Неопределено);
		ВыборкаОстаткиПараметр = ?(ОстатокИспользован, ВыборкаОстатки, Неопределено);
		
		
		ДанныеПериода = ?(Врег(Период)="РЕГИСТРАТОР", Выборка.РегистраторПредставление, Выборка.Период);
		
		Если ДанныеПериода = NULL Тогда
			Продолжить;
		КонецЕсли;
		
		Уровень = Выборка.Уровень();
		
		ОблНачало.Параметры.Период = ДанныеПериода;
		
		// Расшифровка
		ЗаполнитьПараметрыРасшифровки(ОблНачало, Выборка, СтруктураПараметров);
		
		Попытка
			ОбщиеДопОтборы = ОблНачало.Параметры.Расшифровка[0].Значение["ДополнительныеОтборы"].Скопировать();	
		Исключение
			ОбщиеДопОтборы = Неопределено;
		КонецПопытки;
		
		ОтборДляРасшифровки.Вставить("Период", Выборка.Период);
		
		ОблНачало.Область(1, 2, ОблНачало.ВысотаТаблицы, 2).Отступ = Уровень;

		СтруктураПараметров.ДокументРезультат.Вывести(ОблНачало, Уровень);
		
		ЗаполнитьИПрисоединитьОбласть(СальдоНачДт, СтруктураПараметров.ДокументРезультат, ОблСальдоНачДт, ВыборкаОстаткиПараметр, Уровень);
		ЗаполнитьИПрисоединитьОбласть(СальдоНачКт, СтруктураПараметров.ДокументРезультат, ОблСальдоНачКт, ВыборкаОстаткиПараметр, Уровень);
		
		// Одна выборку будем использовать для вывода дебетовых и кредитовых оборотов
		Если (ОборотДтКорСчета ИЛИ ОборотКтКорСчета) 
		   И ОборотИспользован Тогда
			ВыборкаОборотыПоКорСчетам = ВыборкаОборотыПараметр.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам, "КорСчет");
		Иначе
			ВыборкаОборотыПоКорСчетам = Неопределено;
		КонецЕсли;
		
		// Оборот Дт
		ЗаполнитьИПрисоединитьОбласть(ОборотДт, СтруктураПараметров.ДокументРезультат, ОблОборотДт, ВыборкаОборотыПараметр, Уровень);
		
		Если ОборотДтКорСчета Тогда
			// Вывод вложенных итогов по кор счетам
			ВывестиКорСчета(ВыборкаОборотыПоКорСчетам, СтруктураПараметров, "ДТ", "Сумма"+?(ВыводКоличества, ",Количество", ""), 
				ОблОборотДтКорСчет, ОтборДляРасшифровки, Выборка, ОбщиеДопОтборы);
		КонецЕсли;
		
		// Оборот Кт
		ЗаполнитьИПрисоединитьОбласть(ОборотКт, СтруктураПараметров.ДокументРезультат, ОблОборотКт, ВыборкаОборотыПараметр, Уровень);
		
		Если ОборотКтКорСчета Тогда
			Если ОборотИспользован Тогда
				ВыборкаОборотыПоКорСчетам.Сбросить();
			КонецЕсли;
			// Вывод вложенных итогов по кор счетам
			ВывестиКорСчета(ВыборкаОборотыПоКорСчетам, СтруктураПараметров, "КТ", "Сумма", 
				ОблОборотКтКорСчет, ОтборДляРасшифровки, Выборка, ОбщиеДопОтборы);
		КонецЕсли;

		// Вывод конечного сальдо
		ЗаполнитьИПрисоединитьОбласть(СальдоКонДт, СтруктураПараметров.ДокументРезультат, ОблСальдоКонДт, ВыборкаОстаткиПараметр, Уровень);
		ЗаполнитьИПрисоединитьОбласть(СальдоКонКт, СтруктураПараметров.ДокументРезультат, ОблСальдоКонКт, ВыборкаОстаткиПараметр, Уровень);
		
	КонецЦикла;

КонецПроцедуры

// Вывод кор счетов
Процедура ВывестиКорСчета(ВыборкаОборотыПоКорСчетам, СтруктураПараметров, ВидОборота, Ресурсы, ВыводимаяОбласть, 
	ОтборДляРасшифровки = Неопределено, ДанныеГруппировки, ОбщиеДопОтборы = Неопределено)
	
	СтРесурсы = Новый Структура(Ресурсы);
	
	Если ВидОборота = "ДТ" Тогда
		
		ТипПоля = "ОборотДт";
		СписокСчетов = СтруктураПараметров.СписокДт;
		
	ИначеЕсли ВидОборота = "КТ" Тогда
		
		ТипПоля = "ОборотКт";
		СписокСчетов = СтруктураПараметров.СписокКт;
		
	Иначе
		Возврат;
	КонецЕсли;
	
	// Создадим структуру соотвтетствиия кор счетов структуре ресурство
	Соотв = Новый Соответствие;
	Для каждого Элемент Из СписокСчетов Цикл
		Соотв[Элемент.Значение] = Новый Структура(Ресурсы);
	КонецЦикла;
	
	ВерхнийУровень = 1000;
	
	// Обойдем выборку по счетам, получим все ненулевые значения ресурсов и поставим их в соответсвие счетам
	Пока ВыборкаОборотыПоКорСчетам <> Неопределено И ВыборкаОборотыПоКорСчетам.Следующий() Цикл
		
		// Это итог по строке остатка
		//Если ВыборкаОборотыПоКорСчетам.КорСчет = NULL Тогда
		//	Продолжить;
		//КонецЕсли;
		
		// В выборке присутствуют счета всех уровней, если не нужно выводить субсчета, пропускаем 
		// группировки следующего уровня
		Если НЕ ПоСубсчетамКорСчетов Тогда
			
			// Выводим только верхний уровень
			Если ВерхнийУровень < ВыборкаОборотыПоКорСчетам.Уровень() Тогда
				Продолжить;
			Иначе
				ВерхнийУровень = ВыборкаОборотыПоКорСчетам.Уровень();
			КонецЕсли;
			
		КонецЕсли;
		
		СтЗначенияРесурсов = Новый Структура(Ресурсы);
		Вставлять = Ложь;
		
		Для каждого Элемент Из СтРесурсы Цикл
			
			Если НЕ БухгалтерскиеОтчеты.ПривестиКЧислу(ВыборкаОборотыПоКорСчетам[Элемент.Ключ+ТипПоля])=0 Тогда
				СтЗначенияРесурсов.Вставить(Элемент.Ключ, ВыборкаОборотыПоКорСчетам[Элемент.Ключ+ТипПоля]);
				
				Вставлять = Истина;
			КонецЕсли;
		КонецЦикла;
		
		// Полученную структуру вставляем в соответствие счетов
		Если Вставлять Тогда
			Соотв.Вставить(ВыборкаОборотыПоКорСчетам.КорСчет, СтЗначенияРесурсов);
		КонецЕсли;
		
	КонецЦикла;

	Если ВыборкаОборотыПоКорСчетам <> Неопределено Тогда
		ВыборкаОборотыПоКорСчетам.Сбросить();
		ВыборкаОборотыПоКорСчетам.Следующий();
	КонецЕсли;
	
	// Вывод ресурсов
	Для каждого ЭлементСчет Из СписокСчетов Цикл
		
		Для каждого Элемент Из Соотв[ЭлементСчет.Значение] Цикл
			ВыводимаяОбласть.Параметры[Элемент.Ключ+ТипПоля] = Элемент.Значение;
			
			Расшифровка = Новый Соответствие;
			РасшифровкаОтборПоСчетам = Новый Соответствие;
			
			БухгалтерскиеОтчеты.ЗаменитьОбщиеОтборыНаОтборыДтКт(ОтборДляРасшифровки, РасшифровкаОтборПоСчетам, ВидОборота);
			
			Если НЕ ЗначениеЗаполнено(ДанныеГруппировки) Тогда
				Продолжить;
			КонецЕсли;
			КонечнаяСтрока = (ДанныеГруппировки.Группировка() = "");
			
			Если ДанныеГруппировки.Группировка() = "Период" Тогда
				Если ТипЗнч(ОбщиеДопОтборы) = Тип("ТаблицаЗначений") Тогда
					ПромежуточныеДопОтборы = ОбщиеДопОтборы.Скопировать();
				КонецЕсли;
			Иначе
				ПромежуточныеДопОтборы = БухгалтерскиеОтчеты.СоздатьСтруктуруДопОграниченийДляОборотноСальдовойВедомостиПоСчету(ЭтотОбъект, 
										 ДанныеГруппировки, СтруктураПараметров.МассивГруппировок, КонечнаяСтрока);
			КонецЕсли;
				
			ДополнительныеОтборы = Новый Структура;
			БухгалтерскиеОтчеты.ЗаменитьОбщиеОтборыНаОтборыДтКт(ПромежуточныеДопОтборы, ДополнительныеОтборы, ВидОборота);
				
			Расшифровка.Вставить("ДополнительныеОтборы", ПромежуточныеДопОтборы);
			
			Расшифровка.Вставить("Отбор", РасшифровкаОтборПоСчетам);
			Расшифровка.Вставить("ИмяОбъекта", "ОтчетПоПроводкам" + ИмяРегистраБухгалтерии);
			
			Если ДанныеГруппировки.Группировка() = "Период" Тогда
				Расшифровка.Вставить("ДатаНач", ДатаНач);
				КонечнаяДатаОграничений = БухгалтерскиеОтчеты.ПолучитьДатуОкончанияПериода(ДанныеГруппировки.Период, Период);
				Расшифровка.Вставить("ДатаКон", КонечнаяДатаОграничений);
				Расшифровка.Вставить("ОграничениеПоПериоду", ДанныеГруппировки.Период);
			КонецЕсли;
			
			Если Не ПоСубсчетам Тогда
				СчетДляОграничений = Счет;
			Иначе
				СчетДляОграничений = ДанныеГруппировки.Счет;
			КонецЕсли;
			
			Если ВидОборота = "ДТ" Тогда
				
				НоваяСтрока = Расшифровка["ДополнительныеОтборы"].Добавить();
				НоваяСтрока.ПутьКДанным   = "ВидУчетаДт";
				НоваяСтрока.Имя           = "ВидУчетаДт";
				НоваяСтрока.ВидСравнения  = ВидСравнения.Равно;
				НоваяСтрока.Значение      =	ВидУчета;
				НоваяСтрока.Использование = Истина;
				
				Расшифровка.Вставить("СчетДт", СчетДляОграничений);
				Расшифровка.Вставить("СчетКт", ЭлементСчет.Значение);
				
				ВыводимаяОбласть.Параметры.РасшифровкаДт = Расшифровка;
				
			Иначе
				НоваяСтрока = Расшифровка["ДополнительныеОтборы"].Добавить();
				НоваяСтрока.ПутьКДанным   = "ВидУчетаКт";
				НоваяСтрока.Имя           = "ВидУчетаКт";
				НоваяСтрока.ВидСравнения  = ВидСравнения.Равно;
				НоваяСтрока.Значение      =	ВидУчета;
				НоваяСтрока.Использование = Истина;
				
				Расшифровка.Вставить("СчетДт", ЭлементСчет.Значение);
				Расшифровка.Вставить("СчетКт", СчетДляОграничений);
				
				ВыводимаяОбласть.Параметры.РасшифровкаКт = Расшифровка;
			КонецЕсли;
			
		КонецЦикла;
		
		СтруктураПараметров.ДокументРезультат.Присоединить(ВыводимаяОбласть);
		
	КонецЦикла;
	
КонецПроцедуры

// Заполняет параметры расшифровки
//
// Параметры:
//	Нет.
//
Процедура ЗаполнитьПараметрыРасшифровки(Область, Выборка, Знач СтруктураПараметров)

	Если Не ПоСубсчетам ИЛИ Выборка.Счет = Null Тогда
		СчетРасшифровки = Счет;
	Иначе
		СчетРасшифровки = Выборка.Счет;
	КонецЕсли;
	
	ПараметрыРасшифровки = Новый Соответствие;
	
	ПараметрыРасшифровки.Вставить("ИмяОбъекта", "ОтчетПоПроводкам" + ИмяРегистраБухгалтерии);

	ПараметрыРасшифровки.Вставить("Счет", Счет);

	Если Лев(Выборка.Группировка(), 8) = "Субконто" Тогда

		// надо в структуру доп ограничений поместить все группировки более высокого уровня
		ДополнительныеОтборы = БухгалтерскиеОтчеты.СоздатьСтруктуруДопОграниченийДляОборотноСальдовойВедомостиПоСчету(ЭтотОбъект, Выборка, СтруктураПараметров.МассивГруппировок);
				
		ПараметрыРасшифровки.Вставить("ДополнительныеОтборы", ДополнительныеОтборы);

		СписокРасшифровки = Новый СписокЗначений;

		СписокРасшифровки.Добавить(ПараметрыРасшифровки, "Журнал проводок " + СчетРасшифровки);
		
	ИначеЕсли Выборка.Группировка() = "Период" Тогда
		
		ПараметрыРасшифровки.Вставить("ДатаНач", ДатаНач);
		КонечнаяДатаОграничений = БухгалтерскиеОтчеты.ПолучитьДатуОкончанияПериода(Выборка.Период, Период);
		ПараметрыРасшифровки.Вставить("ДатаКон", КонечнаяДатаОграничений);
		
		ПараметрыРасшифровки.Вставить("ОграничениеПоПериоду", Выборка.Период);
		
		ДополнительныеОтборы = БухгалтерскиеОтчеты.СоздатьСтруктуруДопОграниченийДляОборотноСальдовойВедомостиПоСчету(ЭтотОбъект, Выборка, СтруктураПараметров.МассивГруппировок, Истина);
				
		ПараметрыРасшифровки.Вставить("ДополнительныеОтборы", ДополнительныеОтборы);
			
		СписокРасшифровки = Новый СписокЗначений;
			
		СписокРасшифровки.Добавить(ПараметрыРасшифровки, "Журнал проводок " + СчетРасшифровки);
		
	Иначе
		СписокРасшифровки = Неопределено;
	КонецЕсли;

	Область.Параметры.Расшифровка = СписокРасшифровки;

КонецПроцедуры

//////////////////////////////////////////////////////////
// ПРОЧИЕ ПРОЦЕДУРЫ И ФУНКЦИИ
//

// Обработчик события начала выбора значения субконто
//
// Параметры:
//	Элемент управления.
//	Стандартная обработка.
//
Процедура НачалоВыбораЗначенияСубконто(Элемент, СтандартнаяОбработка, ТипЗначенияПоля=Неопределено) Экспорт
	
	СписокПараметров = Новый Структура;
	СписокПараметров.Вставить("Дата",         ДатаКон);
	СписокПараметров.Вставить("СчетУчета",    Счет);
	СписокПараметров.Вставить("Номенклатура", Неопределено);
	СписокПараметров.Вставить("Склад", Неопределено);
	СписокПараметров.Вставить("Организация",  Организация);
	СписокПараметров.Вставить("Контрагент",  Неопределено);
	СписокПараметров.Вставить("ДоговорКонтрагента", Неопределено);
	СписокПараметров.Вставить("ЭтоНовыйДокумент", Ложь);
	
	// Поищем значения в отборе и в полях выбора субконто
	Для Инд=0 По ПостроительОтчета.Отбор.Количество()-1 Цикл
		
		СтрокаОтбора = ПостроительОтчета.Отбор[Инд];
		
		ЗначениеОтбора=?(ТипЗнч(СтрокаОтбора.Значение)<> Тип("СписокЗначений"), СтрокаОтбора.Значение, СтрокаОтбора.Значение[0].Значение);
		
		Если СтрокаОтбора.ТипЗначения = ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.Номенклатура.ТипЗначения Тогда
			СписокПараметров.Вставить("Номенклатура", ЗначениеОтбора);
		ИначеЕсли СтрокаОтбора.ТипЗначения = ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.Склады.ТипЗначения Тогда
			СписокПараметров.Вставить("Склад", ЗначениеОтбора);
		ИначеЕсли СтрокаОтбора.ТипЗначения = ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.Контрагенты.ТипЗначения Тогда
			СписокПараметров.Вставить("Контрагент", ЗначениеОтбора);
		ИначеЕсли СтрокаОтбора.ТипЗначения = ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.Договоры.ТипЗначения Тогда
			СписокПараметров.Вставить("ДоговорКонтрагента", ЗначениеОтбора);
		КонецЕсли;
		
	КонецЦикла;
	
	БухгалтерскийУчет.ОбработатьВыборСубконто(Элемент, СтандартнаяОбработка, Организация, СписокПараметров, ТипЗначенияПоля);
	
КонецПроцедуры // ОбработкаВыбораСубконто()

// Заполнение настроек построителя отчетов
Процедура ЗаполнитьНачальныеНастройки() Экспорт
	
	СтарыеНастройки = УправлениеОтчетами.ПолучитьКопиюОтбораВТЗ(ПостроительОтчета.Отбор);
	
	СальдоНачДт=Истина;
	СальдоНачКт=Истина;
	СальдоКонДт=Истина;
	СальдоКонКт=Истина;

	ОборотДт   =Истина;
	ОборотКт   =Истина;
	ОборотДтКорСчета = Истина;
	ОборотКтКорСчета = Истина;
	
	ТекстПоля = "";
	ТекстОтбор = "";
	ТекстИтоги = "";
		
	Сч = 0;
	МассивСубконто = Новый Массив;
	Для Каждого ВидСубконто Из Счет.ВидыСубконто Цикл
		
		Сч = Сч+1;
		
		ТекстПоля = ТекстПоля + ", Регистр.Субконто" +Сч+" КАК Субконто"+Сч;
		ТекстОтбор = ТекстОтбор + ", Субконто"+Сч+".*";
		ТекстИтоги = ТекстИтоги + ", Субконто"+Сч+".*";
		
		МассивСубконто.Добавить(ВидСубконто.ВидСубконто);
	КонецЦикла;
	
	ТекстПоля = Сред(ТекстПоля, 2);
	ТекстОтбор = Сред(ТекстОтбор, 2);
	ТекстИтоги = Сред(ТекстИтоги, 2);
	
	ПостроительОтчета.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	Регистр.СуммаОборот КАК СуммаОборот
	|	" +?(НЕ ПустаяСтрока(ТекстПоля), "{ВЫБРАТЬ " +ТекстПоля+ "}", "") + "
	|ИЗ
	|	РегистрБухгалтерии."+ИмяРегистраБухгалтерии+".Обороты(,,,Счет В Иерархии (&Счет),," + ?(НЕ ПустаяСтрока(ТекстОтбор), "{"+ТекстОтбор+"}", "") + ") КАК Регистр
	|
	|ИТОГИ СУММА(СуммаОборот) ПО ОБЩИЕ
	|	" +?(НЕ ПустаяСтрока(ТекстИтоги), "{ИТОГИ ПО "+ТекстИтоги+"}", "");
	
	Сч = 0;
	Для каждого Элемент Из  МассивСубконто Цикл
		Сч = Сч+1;
		Поле = ПостроительОтчета.ДоступныеПоля.Найти("Субконто"+Сч);
		Поле.ТипЗначения = Элемент.ТипЗначения;
		Поле.Представление = Элемент.Наименование;
	КонецЦикла;
					
	БухгалтерскиеОтчеты.СформироватьПервоначальныйОтборПостроителяПоСубконто(ПостроительОтчета, Счет);
	
	УправлениеОтчетами.УстановитьОтборИзТаблицы(ПостроительОтчета.Отбор, СтарыеНастройки);
	
КонецПроцедуры

// Процедура выполняется при смене счета
Процедура ОбработкаВыбораСчета() Экспорт
	
	ПоКоличеству = Счет.Количественный;
	
	ЗаполнитьНачальныеНастройки();
	
	
КонецПроцедуры

// Настраивает отчет по заданным параметрам (например, для расшифровки)
Процедура Настроить(СтруктураПараметров) Экспорт
	
	Параметры = БухгалтерскиеОтчеты.СоздатьПоСтруктуреСоответствие(СтруктураПараметров); 

	Счет = Параметры["Счет"];
	Организация = Параметры["Организация"];
	ДатаНач = Параметры["ДатаНач"];
	ДатаКон = Параметры["ДатаКон"];
	
	Если Параметры["ЗаполнитьПоУмолчанию"] = Истина Тогда
		
		// Настраиваем по умолчанию
		ОбработкаВыбораСчета();
		
	Иначе
		
		ВидУчета     = Параметры["ВидУчета"];
		ПоКоличеству = Параметры["ПоКоличеству"];
	
		ЗаполнитьНачальныеНастройки();
		
	КонецЕсли;
	
	Период = Параметры["Период"];
	ВсеПериоды = Параметры["ВсеПериоды"];
	
	СтрокиОтбора = Параметры["Отбор"];
	БухгалтерскиеОтчеты.ВосстановитьОтборПостроителяОтчетовПоПараметрам(ПостроительОтчета, СтрокиОтбора);
		
КонецПроцедуры

// Обработка расшифровки
//
// Параметры:
//	Нет.
//
Процедура ОбработкаРасшифровкиСтандартногоОтчета(Расшифровка) Экспорт
	
	ОграничениеПоПериоду = Неопределено;
	Расшифровка.Свойство("ОграничениеПопериоду", ОграничениеПоПериоду);
	
	Если ОграничениеПоПериоду <> Неопределено Тогда
			
		ПериодС = ОграничениеПоПериоду;
		ПериодПо = БухгалтерскиеОтчеты.ПолучитьДатуОкончанияПериода(ПериодС, Период);
									
	Иначе
					
		ПериодС  = ДатаНач;
		ПериодПо = ДатаКон;
					
	КонецЕсли;
				
	Если Врег(Период) = "РЕГИСТРАТОР" Тогда
		
		Если ОграничениеПоПериоду <> NULL
			И ЗначениеЗаполнено(ОграничениеПоПериоду) Тогда
			
			Расшифровка.Вставить("Регистратор", ОграничениеПоПериоду);
			Расшифровка.Вставить("ПоРегистратору", Истина);
		
		КонецЕсли;
					
	Иначе
					
		Если ДатаКон<>'00010101' Тогда
			ПериодПо = Мин(КонецДня(ДатаКон), ПериодПо);
		КонецЕсли;
					
		Расшифровка.Вставить("ДатаНач", ПериодС);
		Расшифровка.Вставить("ДатаКон", ПериодПо);
					
	КонецЕсли;
			
	Отчет = Отчеты[Расшифровка["ИмяОбъекта"]].Создать();
	
	ФормаОтчета = Отчет.ПолучитьФорму(, , Новый УникальныйИдентификатор());
	
	Попытка
		
		БухгалтерскиеОтчеты.ДополнитьДопОтборамиРасшифровкуДанных(Расшифровка);
		
		Отчет.Настроить(Расшифровка);
		
		ФормаОтчета.ПоказыватьЗаголовок = Расшифровка["ПоказыватьЗаголовок"];
		
		ФормаОтчета.ОбновитьОтчет();
		
	Исключение
		
	КонецПопытки;
	
	ФормаОтчета.Открыть();

КонецПроцедуры


//////////////////////////////////////////////////////////
// МОДУЛЬ ОБЪЕКТА
//

ИмяРегистраБухгалтерии = "Налоговый";

Период = "МЕСЯЦ";
#КонецЕсли