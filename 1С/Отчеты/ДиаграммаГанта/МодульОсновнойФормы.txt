Перем ФормаНастройка;
Перем СтруктураСвязиЭлементовСДанными;

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ

// Обновляет таблицу или диаграмму отчета
Процедура ОбновитьВыведенныйОтчет() Экспорт

	ЗаполнитьОбъектПоДиалогу();
	
	СформироватьОтчет(ЭлементыФормы.ДиаграммаГанта);
	
	ТекущийЭлемент = ЭлементыФормы.ДиаграммаГанта;

КонецПроцедуры // ОбновитьВыведенныйОтчет()

// Формирует текст заголовка
//
// Параметры:
//	Нет.
//
Процедура СформироватьЗаголовокФормы()

	Заголовок = УправлениеОтчетами.СформироватьЗаголовокОсновнойФормы(ДатаНач, ДатаКон, ВидОтчета, Ложь);
	
КонецПроцедуры // СформироватьЗаголовокФормы()

//  Заполняет реквизиты по диалогу
//
// Параметры:
//	Нет.
//
Процедура ЗаполнитьОбъектПоДиалогу()

	// Здесь должно быть расположено заполнение реквизитов
	// отчета по реквизитам формы, непосредственно не связанным
	// с реквизитами отчета (если таковые имеются)
	
КонецПроцедуры // ЗаполнитьОбъектПоДиалогу()

// Заполняет диалог по значениям реквизитов отчета
//
// Параметры:
//	Нет.
//
Процедура ЗаполнитьДиалогПоОбъекту()

	// Здесь должно быть расположено заполнение реквизитов формы
	// по реквизитам отчета, если они непосредственно не связаны
	// с реквизитами отчета (если таковые имеются)

	УправлениеОтчетами.ОбработатьПоляОтбораНаОсновнойФормеУниверсальногоОтчета(ЭлементыФормы, ПостроительОтчета, СтруктураСвязиЭлементовСДанными, "ОтчетОбъект");
	
КонецПроцедуры // ЗаполнитьДиалогПоОбъекту()

// Управляет видимостью панелей быстрого отбора
Процедура УстановитьВидимостьПанелейБыстрогоОтбораДиаграммы()
	
	Если НЕ ЭлементыФормы.ДействияФормы.Кнопки.Подменю.Кнопки.Отбор.Пометка Тогда
		
		Для Инд = 1 по 3 Цикл
			ЭлементыФормы["ПанельОтбора" + инд].Свертка = РежимСверткиЭлементаУправления.Верх;
		КонецЦикла;
			
		ЭлементыФормы.ПанельОтбора2.Свертка = РежимСверткиЭлементаУправления.Верх;
	Иначе
		Для инд = 1 по 3 Цикл
			Если ЭлементыФормы["ФлажокНастройки"+ (4 - инд)].Данные <> "" Тогда
				ЭлементыФормы["ПанельОтбора"+ (4 - инд)].Свертка = РежимСверткиЭлементаУправления.Нет;
			Иначе
				ЭлементыФормы["ПанельОтбора"+ (4 - инд)].Свертка = РежимСверткиЭлементаУправления.Верх;
			КонецЕсли
		КонецЦикла;
	КонецЕсли;

КонецПроцедуры

///////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ

// Процедура - обработчик события "Перед открытием" формы отчета.
Процедура ПередОткрытием(Отказ, СтандартнаяОбработка)

	Если НЕ ЗначениеЗаполнено(ВидОтчета) Тогда
		ВидОтчета = мТаблицаВидыОтчета[0].ВидОтчета;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Периодичность) Тогда
		Периодичность = 1;
	КонецЕсли;
	Если НЕ ЗначениеЗаполнено(ДатаНач) Тогда
		ДатаНач = НачалоГода(ОбщегоНазначения.ПолучитьРабочуюДату());
	КонецЕсли;
	Если НЕ ЗначениеЗаполнено(ДатаКон) Тогда
		ДатаКон = КонецГода(ДатаНач);
	КонецЕсли;
	
	ЗаполнитьНачальныеНастройки();
	УстановитьВидимостьПанелейБыстрогоОтбораДиаграммы();

	ЗаполнитьДиалогПоОбъекту();
	СформироватьЗаголовокФормы();
	
КонецПроцедуры // ПередОткрытием()

// Процедура - обработчик события "При открытии" формы отчета.
Процедура ПриОткрытии()
	
	//Настройка списка видов отчета
	СписокВидовОтчета = Новый СписокЗначений;
	Для каждого Строка Из мТаблицаВидыОтчета Цикл
		СписокВидовОтчета.Добавить(Строка.ВидОтчета, Строка.ВидОтчета);
	КонецЦикла; 
	ЭлементыФормы.ПолеВыбораВидОтчета.СписокВыбора = СписокВидовОтчета;
	ЭлементыФормы.ПолеВыбораВидОтчета.Значение = ВидОтчета;
	
КонецПроцедуры // ПриОткрытии()

// Процедура - обработчик сообщений
//
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)

	Если ИмяСобытия = "ИзмененоИмяРегистра" И Источник = ФормаНастройка Тогда
		
		ЗаполнитьДиалогПоОбъекту();
		СформироватьЗаголовокФормы();
		УстановитьВидимостьПанелейБыстрогоОтбораДиаграммы();
		
	КонецЕсли; 
	
КонецПроцедуры // ОбработкаОповещения()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ДЕЙСТВИЯ КОМАНДНЫХ ПАНЕЛЕЙ ФОРМЫ

// Процедура - обработчик нажатия кнопки "Сформировать"
Процедура КоманднаяПанельФормыВыполнить(Элемент)
	
	ОбновитьВыведенныйОтчет();

КонецПроцедуры

// Процедура - обработчик нажатия кнопки "Отбор"
Процедура КоманднаяПанельФормыОтбор(Кнопка)
	
	ЭлементыФормы.ДействияФормы.Кнопки.Отбор.Пометка = НЕ ЭлементыФормы.ДействияФормы.Кнопки.Отбор.Пометка;
	ЭлементыФормы.ДействияФормы.Кнопки.Подменю.Кнопки.Отбор.Пометка = НЕ ЭлементыФормы.ДействияФормы.Кнопки.Подменю.Кнопки.Отбор.Пометка;
	
	УстановитьВидимостьПанелейБыстрогоОтбораДиаграммы();

КонецПроцедуры

// Процедура - обработчик нажатия кнопки "Настройка"
Процедура КоманднаяПанельФормыНастройка(Кнопка)
	
	ФормаНастройка = ПолучитьФорму("ФормаНастройка", ЭтаФорма);
	ФормаНастройка.ВыбиратьВидОтчета = Истина;

	Если ФормаНастройка.ОткрытьМодально() = Истина Тогда
		ОбновитьВыведенныйОтчет();
	КонецЕсли;

КонецПроцедуры

// Процедура - обработчик нажатия кнопки "Печать"
//
Процедура КоманднаяПанельФормыПечать(Кнопка)
	
	Печать();
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ЭЛЕМЕНТОВ ДИАЛОГА

// Процедура - обработчик нажатия кнопки настройки периода.
Процедура КнопкаНастройкаПериодаНажатие(Элемент)
	
	НП = Новый НастройкаПериода;
	НП.ВариантНастройки = ВариантНастройкиПериода.Период;
	НП.УстановитьПериод(ДатаНач, ДатаКон);
	Если НП.Редактировать() Тогда
		ДатаНач = НП.ПолучитьДатуНачала();
		ДатаКон = НП.ПолучитьДатуОкончания();
	КонецЕсли;

КонецПроцедуры // КнопкаНастройкаПериодаНажатие()

// Процедура - обработчик изменения данных в поле значения отбора
//
Процедура ПолеНастройки1ПриИзменении(Элемент)

	УправлениеОтчетами.ПолеНастройкиПриИзменении(Элемент, ПостроительОтчета.Отбор, СтруктураСвязиЭлементовСДанными);
	
КонецПроцедуры // ПолеНастройки1ПриИзменении()

// Процедура - обработчик изменения данных в поле значения отбора С
//
Процедура ПолеНастройкиС1ПриИзменении(Элемент)

	УправлениеОтчетами.ПолеНастройкиСПриИзменении(Элемент, ПостроительОтчета, СтруктураСвязиЭлементовСДанными);
	
КонецПроцедуры // ПолеНастройкиС1ПриИзменении()

// Процедура - обработчик изменения данных в поле значения отбора ПО
//
Процедура ПолеНастройкиПо1ПриИзменении(Элемент)

	УправлениеОтчетами.ПолеНастройкиПоПриИзменении(Элемент, ПостроительОтчета, СтруктураСвязиЭлементовСДанными);

КонецПроцедуры // ПолеНастройкиПо1ПриИзменении()

// Процедура - обработчик изменения данных в поле выбора вида сравнения
//
Процедура ПолеВидаСравнения1ПриИзменении(Элемент)

	УправлениеОтчетами.ПолеВидаСравненияПриИзменении(Элемент, ЭлементыФормы);
	
КонецПроцедуры // ПолеВидаСравнения1ПриИзменении()

// Процедура - обработчик события "ПриИзменении" вида отчета
Процедура ПолеВыбораВидОтчетаПриИзменении(Элемент)
	
	СформироватьЗаголовокФормы();
	Состояние("Заполнение по умолчанию");
	ЗаполнитьНачальныеНастройки();
	ЗаполнитьДиалогПоОбъекту();
	УстановитьВидимостьПанелейБыстрогоОтбораДиаграммы();
	
КонецПроцедуры



////////////////////////////////////////////////////////////////////////////////
// ОПЕРАТОРЫ ОСНОВНОЙ ПРОГРАММЫ