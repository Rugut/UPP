// КОНТАКТЫ

Перем мОбработкаПоискаПоСтрокеВидаКИ;
Перем мТекстПоискаПоСтрокеВидаКИ;
Перем мПоследнееЗначениеЭлементаПоискаПоСтрокеВидаКИ;

Перем мКнопкаРедактироватьКИВДиалоге;
Перем мКнопкаПоказВсейКИ;

Перем ПроизвестиНачальноеЗаполнениеКалендаря;
Перем ПроизвестиНачальноеЗаполнениеПочты;

Перем ШиринаТабличногоПоляДня;
Перем ШиринаТабличногоПоляНедели;
Перем ШиринаТабличногоПоляМесяца;
Перем ШиринаРазделителяДвухДней;

Перем ВерхняяСтрокаНевидимойОбластиДня;
Перем НижняяСтрокаНевидимойОбластиДня;

Перем ВерхняяСтрокаНевидимойОбластиНедели;
Перем НижняяСтрокаНевидимойОбластиНедели;

Перем ОбщаяШиринаДня;

Перем СписокКандидатов;
Перем ТаблицаКандидатовСНепрочитнаннымиПисьмами;

Перем ТаблицаДанныхПоПредметам;
Перем ТаблицаДанныхПоПисьмам;

Перем СписокНепрочитанностиПисем;

Перем СписокДанныхПоПредметам;
Перем СписокДанныхПоПисьмам;
Перем СписокДанныхПоПредметамПоОбъекту;
Перем мПустаяКартинка;
Перем мНевидимаяСкрепка;
Перем мТолькоСкрепка;

Перем мНаборЗаписейФИО;
Перем мНаборЗаписейДокументаУдостоверяющегоЛичность;
Перем мФормаВводаМестаРождения;
Перем мВидОбъекта;

// КАЛЕНДАРЬ

// Список значений, содержащий список истории отборов с параметрами отборов
Перем мСписокИсторииОтбора;

Перем мДокументыОснования;

Перем мСписокДокументовДобавления;

Перем мМассивЗначенийБыстрогоСобытия;

Перем мТаблицаЯчеекИДатНедели;

Перем мСписокМесяцевВыбора;

Перем мДатаКалендаря;

Перем мБылоПервоеЗаполнениеНедели;

Перем мИмяТекущейОбластиДвойногоДня;

Перем мИмяТекущейОбластиДня;

Перем мБиблиотекаКартинокДокумент;

Перем СмещениеОтНачалаПервойЯчейкиДня;
Перем НомерПоследнейЯчейкиДня;
Перем НомерПоследнейЯчейкиНедели;

Перем мСкрепкиЛистовКалендаряПользователяНеРабочие;
Перем мСкрепкиЛистовКалендаряПользователяРабочие;
Перем мМакетДня;
Перем мМакетНедели;

Перем мЛичнаяВстречаИсходящяя;
Перем мЛичнаяВстречаВходящяя;
Перем мПочтовоеПисьмоИсходящее;
Перем мПочтовоеПисьмоВходящее;
Перем мПрочееСобытиеИсходящее;
Перем мПрочееСобытиеВходящее;
Перем мТелефонныйЗвонокИсходящий;
Перем мТелефонныйЗвонокВходящий;
Перем мЭлектронноеПисьмоИсходящее;
Перем мЭлектронноеПисьмоВходящее;

// ПОЧТА

// Переменная содержит объект Шрифт с установленной жирностью
Перем мЖирныйШрифт;

Перем мКартинкаКандидата;

// содержит строку списка писем, которая в данный момент отображена
// в поле ХТМЛ документа
Перем мОтображеннаяСтрокаСпискаПисем;

// Текущее письмо списка писем
Перем мТекущееПисьмо;

// Признак изменения списка писем при выборе папки или при активизации
Перем мИзменятьСписокЭлектронныхПисемПриВыбореПапкиПисем;

// Содержит залипающуюся кнопку командной панели управления отбором скрытых предметов
Перем мКнопкаОтображатьСкрытыеПредметыПисем;

// Содержит залипающуюся кнопку командной панели управления показом истории по датам
Перем мКнопкаОтображатьИсториюПоДатам;

// В переменной сохраняется структура ключа текущей строки списка предметов
Перем мСтруктураПредмета;

// Флаг режима выделения видимых строк списка писем
Перем ВыделитьВидимыеСтроки;

Перем СоответствиеСокращенныхТекстовЭлектронныхПисем;

// В переменной хранятся значение использования предметов писем в учетных записях
Перем мКлассификацияУчетныхЗаписейПоПредметам;

Перем мВыполняетсяОбновлениеОтображения;

// КАЛЕНДАРЬ

////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ

// Функция возвращает флаг использования предметов писем в учетной записи
//
// Параметры
//  УчетнаяЗаписьАнализа - анализируемая учетная запись
//
// Возвращаемое значение:
//   Булево
//
Функция ФлагКлассификацииПисемПоПредметам(УчетнаяЗаписьАнализа)

	Если ТипЗнч(УчетнаяЗаписьАнализа) <> Тип("СправочникСсылка.УчетныеЗаписиЭлектроннойПочты") Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(УчетнаяЗаписьАнализа) Тогда
		Возврат Ложь;
	КонецЕсли; 
	
	ЗначениеФлага = мКлассификацияУчетныхЗаписейПоПредметам.Получить(УчетнаяЗаписьАнализа);
	Если ЗначениеФлага = Неопределено Тогда
		ЗначениеФлага = УчетнаяЗаписьАнализа.ИспользоватьКлассификациюПисемПоПредметам;
		мКлассификацияУчетныхЗаписейПоПредметам.Вставить(УчетнаяЗаписьАнализа, ЗначениеФлага);
	КонецЕсли;
	
	Возврат ЗначениеФлага;

КонецФункции

// КАЛЕНДАРЬ

////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ

// Процедура изменяет стиль отображения электронного письма
// Назначение вызова процедупры обработчику производится программно
// в процедуре СоздатьКнопкиОформленияСтрокПисем()
Процедура ИзменитьСтильЭлектронногоПисьма(Кнопка)

	Если Лев(Кнопка.Имя, 1) = "_" Тогда
		ИзменитьОформление(ЭлементыФормы.ЭлектронныеПисьмаСписок.ВыделенныеСтроки, Истина, , Сред(Кнопка.Имя, 2));
	КонецЕсли; 

КонецПроцедуры

Процедура СоздатьКнопкиОформленияСтрокПисем()

	КнопкиОформления = ЭлементыФормы.КонтекстноеМенюСпискаПисем.Кнопки.Отметка.Кнопки;
	
	// Сначала удалим лишние кнопки
	а = 0;
	Пока а <= КнопкиОформления.Количество() - 1 Цикл
		Если Лев(КнопкиОформления[а].Имя, 1) = "_" Тогда
			КнопкиОформления.Удалить(а);
		Иначе
			а = а + 1;
		КонецЕсли;
	КонецЦикла;
	
	// Теперь создадим
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ОформленияСтрокПисем.Код КАК Код,
	               |	ОформленияСтрокПисем.Наименование КАК Наименование
	               |ИЗ
	               |	Справочник.ОформленияСтрокПисем КАК ОформленияСтрокПисем
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	Наименование УБЫВ";
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		КнопкиОформления.Вставить(0, ("_" + Выборка.Код), ТипКнопкиКоманднойПанели.Действие, Выборка.Наименование, Новый Действие("ИзменитьСтильЭлектронногоПисьма"))
	КонецЦикла;

КонецПроцедуры

// Процедура обрабатывает событие перетаскивания в поле календаря режима День и Неделя.
//
Процедура ПолеКалендаряПеретаскиваниеОбщее(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, ВыбраннаяДата, Неделя = Ложь)
	
	Если Неделя Тогда
		Область = ЭлементыФормы.ПолеТабличногоДокументаНеделя.ТекущаяОбласть;
	Иначе
		Если ОтображатьЗаказы Тогда
			Область = ЭлементыФормы.ПолеТабличногоДокументаДень.ТекущаяОбласть;
		Иначе
			Область = ЭлементыФормы.ПолеТабличногоДокументаДеньВторой.ТекущаяОбласть;
		КонецЕсли;
	КонецЕсли; 
	
	Если ТипЗнч(Область.Расшифровка) <> Тип("ДокументСсылка.Событие") Тогда
		Возврат;
	КонецЕсли; 
	
	СтандартнаяОбработка = Ложь;
	
	НовоеНачалоСобытия    = ВыбраннаяДата + (Область.Расшифровка.НачалоСобытия - НачалоДня(Область.Расшифровка.НачалоСобытия));
	НовоеОкончаниеСобытия = ВыбраннаяДата + (Область.Расшифровка.ОкончаниеСобытия - НачалоДня(Область.Расшифровка.ОкончаниеСобытия));
	
	Если НовоеНачалоСобытия = Область.Расшифровка.НачалоСобытия
		И НовоеОкончаниеСобытия = Область.Расшифровка.ОкончаниеСобытия Тогда
		Возврат;
	КонецЕсли; 
	
	Если ПараметрыПеретаскивания.Действие = ДействиеПеретаскивания.Копирование Тогда
		Объект = Область.Расшифровка.Скопировать();
		Объект.Дата = ТекущаяДата();
	Иначе
		Объект = Область.Расшифровка.ПолучитьОбъект();
	КонецЕсли; 
	
	Объект.НачалоСобытия    = НовоеНачалоСобытия;
	Объект.ОкончаниеСобытия = НовоеОкончаниеСобытия;
	Попытка
		Объект.Записать(РежимЗаписиДокумента.Проведение);
	Исключение
		ОбщегоНазначения.СообщитьОбОшибке(ОписаниеОшибки());
		Возврат;
	КонецПопытки;
	
	ЗаписьДокументаСобытие();
	
КонецПроцедуры

// Процедура обрабатывает событие проверки перетаскивания в поле табличного документа режима День и Двойной день.
//
Процедура ПолеТабличногоДокументаПроверкаПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Область)
	
	Если ТипЗнч(ПараметрыПеретаскивания.Значение.ТекущаяОбласть.Расшифровка) <> Тип("ДокументСсылка.Событие") 
		ИЛИ Область.Низ > НомерПоследнейЯчейкиДня Тогда
		СтандартнаяОбработка = Ложь;
		ПараметрыПеретаскивания.Действие = ДействиеПеретаскивания.Отмена;
	КонецЕсли;
	
КонецПроцедуры

// Процедура обрабатывает событие начала перетаскивания в поле табличного документа режима День и Двойной день.
//
Процедура ПолеТабличногоДокументаНачалоПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка)
	
	Элемент.ТолькоПросмотр = Ложь;
	ПараметрыПеретаскивания.ДопустимыеДействия = ДопустимыеДействияПеретаскивания.КопированиеИПеремещение;
	ПараметрыПеретаскивания.Действие = ДействиеПеретаскивания.Перемещение;
	
КонецПроцедуры

// Процедура обрабатывает событие перетаскивания в поле табличного документа режима День и Двойной день.
//
Процедура ПолеТабличногоПеретаскивание(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Область, ДваДня = Ложь)
	
	Если ТипЗнч(ПараметрыПеретаскивания.Значение.ТекущаяОбласть.Расшифровка) <> Тип("ДокументСсылка.Событие") Тогда
		Возврат;
	КонецЕсли;
	
	СтандартнаяОбработка = Ложь;
	
	НовоеНачалоСобытия    = ОпределитьДатыОбластиДня(Область, Истина);
	НовоеОкончаниеСобытия = ОпределитьДатыОбластиДня(Область, Ложь);
	Если КоличествоДнейНаЗакладкеДень = 2 И ДваДня И Область.Лево > ОбщаяШиринаДня+3 Тогда
		НовоеНачалоСобытия    = НовоеНачалоСобытия + 60*60*24;
		НовоеОкончаниеСобытия = НовоеОкончаниеСобытия + 60*60*24;
	КонецЕсли; 
	
	Если НовоеНачалоСобытия = ПараметрыПеретаскивания.Значение.ТекущаяОбласть.Расшифровка.НачалоСобытия
		И НовоеОкончаниеСобытия = ПараметрыПеретаскивания.Значение.ТекущаяОбласть.Расшифровка.ОкончаниеСобытия Тогда
		Возврат;
	КонецЕсли; 
	
	Если ПараметрыПеретаскивания.Действие = ДействиеПеретаскивания.Копирование Тогда
		Объект = ПараметрыПеретаскивания.Значение.ТекущаяОбласть.Расшифровка.Скопировать();
		Объект.Дата = ТекущаяДата();
	Иначе
		Объект = ПараметрыПеретаскивания.Значение.ТекущаяОбласть.Расшифровка.ПолучитьОбъект();
	КонецЕсли; 
	
	Объект.НачалоСобытия    = НовоеНачалоСобытия;
	Объект.ОкончаниеСобытия = НовоеОкончаниеСобытия;
	Попытка
		Объект.Записать(РежимЗаписиДокумента.Проведение);
	Исключение
		ОбщегоНазначения.СообщитьОбОшибке(ОписаниеОшибки());
		Возврат;
	КонецПопытки;
	
	ЗаписьДокументаСобытие();
	Элемент.ТекущаяОбласть = Область;
	
КонецПроцедуры

// Процедура обрабатывает событие записи документа Событие из календаря пользователя
//
Процедура ЗаписьДокументаСобытие()
	
	ОбновитьСписок[0]  = Истина;
	ОбновитьСписок[1]  = Ложь;
	
	ОбновитьМесяц[0]  = Истина;
	ОбновитьМесяц[2]  = Истина;
	
	ОбновитьНеделю[0] = Истина;
	ОбновитьНеделю[2] = Истина;
	
	ОбновитьДень[0]   = Истина;
	ОбновитьДень[2]   = Истина;
	
	ОбновитьИнформациюНаФорме();
	
КонецПроцедуры

// Процедура выполняется по нажатию на одну из кнопок подменю
// кнопки ИсторияОтборов командной панели КоманднаяПанельСписка.
// 
// Параметры
//  Кнопка - Кнопка командной панели, по нажатию на которую вызывается данная процедура
//
// Возвращаемые значения
//  НЕТ
Процедура ОбработкаИсторииОтбора(Кнопка)
	
	СтарыйОтборКонтрагент = СтруктураОтборов.Получить("КонтактноеЛицо");
	
	ИндексСпискаЗначений = Число(Кнопка.Имя);
	
	Если (ИндексСпискаЗначений + 1) > мСписокИсторииОтбора.Количество() Тогда
		Возврат;
	КонецЕсли;
	
	// Очистим отборы
	Для каждого ЭлементСоответствия Из СтруктураОтборов Цикл
		Если ЭлементСоответствия.Ключ = "Пользователь" Тогда
			Продолжить;
		КонецЕсли;
		СтруктураОтборов.Удалить(ЭлементСоответствия.Ключ);
	КонецЦикла; 
	
	ЗначениеЭлементаСпискаЗначений = мСписокИсторииОтбора[ИндексСпискаЗначений].Значение;
	Для каждого ЭлементСтруктуры Из ЗначениеЭлементаСпискаЗначений Цикл
		МассивОтбора = Новый Массив;
		МассивОтбора.Добавить(ЭлементСтруктуры.Значение[0]);
		Если ЭлементСтруктуры.Значение[0] = ВидСравнения.Интервал
			ИЛИ ЭлементСтруктуры.Значение[0] = ВидСравнения.ИнтервалВключаяГраницы
			ИЛИ ЭлементСтруктуры.Значение[0] = ВидСравнения.ИнтервалВключаяНачало
			ИЛИ ЭлементСтруктуры.Значение[0] = ВидСравнения.ИнтервалВключаяОкончание Тогда
			МассивОтбора.Добавить(ЭлементСтруктуры.Значение[2]);
			МассивОтбора.Добавить(ЭлементСтруктуры.Значение[3]);
		Иначе
			МассивОтбора.Добавить(ЭлементСтруктуры.Значение[1]);
		КонецЕсли;
		СтруктураОтборов.Вставить(ЭлементСтруктуры.Ключ, МассивОтбора);
	КонецЦикла;
	
	ОбновитьЗаказыСобытия(СтарыйОтборКонтрагент = СтруктураОтборов.Получить("КонтактноеЛицо"));
	
	СостояниеКнопокСнятияОтбора();
	СостояниеКнопкиОтбораПоТекущемуЗначению();
	
КонецПроцедуры

// Процедура формирует строковое представление отбора, для записи в историю отборов.
// 
// Параметры
//  СтрокаОтбора - Строка, строковое представление отбора
//  ЭлементОтбора - Массив, массив парметров и значений отбора
//
// Возвращаемые значения
//  НЕТ
Процедура ДописатьСтрокуОтбора(СтрокаОтбора, ЭлементОтбора)
	
	Если НЕ ПустаяСтрока(СтрокаОтбора) Тогда
		СтрокаОтбора = СтрокаОтбора + ", ";
	КонецЕсли; 
	Если ЭлементОтбора.Значение[0] = ВидСравнения.Равно Тогда
		СтрокаОтбора = СтрокаОтбора + мСтруктураПредставленийОтборов[ЭлементОтбора.Ключ] + " = "+ СокрЛП(Строка(ЭлементОтбора.Значение[1]));
	ИначеЕсли ЭлементОтбора.Значение[0] = ВидСравнения.НеРавно Тогда
		СтрокаОтбора = СтрокаОтбора + мСтруктураПредставленийОтборов[ЭлементОтбора.Ключ] + " <> "+ СокрЛП(Строка(ЭлементОтбора.Значение[1]));
	ИначеЕсли ЭлементОтбора.Значение[0] = ВидСравнения.ВСписке Тогда
		СтрокаСписка = "";
		Для каждого ЭлементСписка Из ЭлементОтбора.Значение[1] Цикл
			Если НЕ ПустаяСтрока(СтрокаСписка) Тогда
				СтрокаСписка = СтрокаСписка + "; ";
			КонецЕсли; 
			СтрокаСписка = СтрокаСписка + СокрЛП(Строка(ЭлементСписка.Значение));
		КонецЦикла; 
		СтрокаОтбора = СтрокаОтбора + мСтруктураПредставленийОтборов[ЭлементОтбора.Ключ] + " в списке "+ СтрокаСписка;
	ИначеЕсли ЭлементОтбора.Значение[0] = ВидСравнения.НеВСписке Тогда
		СтрокаСписка = "";
		Для каждого ЭлементСписка Из ЭлементОтбора.Значение[1] Цикл
			Если НЕ ПустаяСтрока(СтрокаСписка) Тогда
				СтрокаСписка = СтрокаСписка + "; ";
			КонецЕсли; 
			СтрокаСписка = СтрокаСписка + СокрЛП(Строка(ЭлементСписка.Значение));
		КонецЦикла; 
		СтрокаОтбора = СтрокаОтбора + мСтруктураПредставленийОтборов[ЭлементОтбора.Ключ] + " не в списке "+ СтрокаСписка;
	ИначеЕсли ЭлементОтбора.Значение[0] = ВидСравнения.Больше Тогда
		СтрокаОтбора = СтрокаОтбора + мСтруктураПредставленийОтборов[ЭлементОтбора.Ключ] + " > "+ СокрЛП(Строка(ЭлементОтбора.Значение[1]));
	ИначеЕсли ЭлементОтбора.Значение[0] = ВидСравнения.БольшеИлиРавно Тогда
		СтрокаОтбора = СтрокаОтбора + мСтруктураПредставленийОтборов[ЭлементОтбора.Ключ] + " >= "+ СокрЛП(Строка(ЭлементОтбора.Значение[1]));
	ИначеЕсли ЭлементОтбора.Значение[0] = ВидСравнения.Меньше Тогда
		СтрокаОтбора = СтрокаОтбора + мСтруктураПредставленийОтборов[ЭлементОтбора.Ключ] + " < "+ СокрЛП(Строка(ЭлементОтбора.Значение[1]));
	ИначеЕсли ЭлементОтбора.Значение[0] = ВидСравнения.МеньшеИлиРавно Тогда
		СтрокаОтбора = СтрокаОтбора + мСтруктураПредставленийОтборов[ЭлементОтбора.Ключ] + " <= "+ СокрЛП(Строка(ЭлементОтбора.Значение[1]));
	ИначеЕсли ЭлементОтбора.Значение[0] = ВидСравнения.Интервал Тогда
		СтрокаОтбора = СтрокаОтбора + СокрЛП(Строка(ЭлементОтбора.Значение[1])) + " < " + мСтруктураПредставленийОтборов[ЭлементОтбора.Ключ] + " < "+ СокрЛП(Строка(ЭлементОтбора.Значение[2]));
	ИначеЕсли ЭлементОтбора.Значение[0] = ВидСравнения.ИнтервалВключаяГраницы Тогда
		СтрокаОтбора = СтрокаОтбора + СокрЛП(Строка(ЭлементОтбора.Значение[1])) + " <= " + мСтруктураПредставленийОтборов[ЭлементОтбора.Ключ] + " <= "+ СокрЛП(Строка(ЭлементОтбора.Значение[2]));
	ИначеЕсли ЭлементОтбора.Значение[0] = ВидСравнения.ИнтервалВключаяНачало Тогда
		СтрокаОтбора = СтрокаОтбора + СокрЛП(Строка(ЭлементОтбора.Значение[1])) + " <= " + мСтруктураПредставленийОтборов[ЭлементОтбора.Ключ] + " < "+ СокрЛП(Строка(ЭлементОтбора.Значение[2]));
	ИначеЕсли ЭлементОтбора.Значение[0] = ВидСравнения.ИнтервалВключаяОкончание Тогда
		СтрокаОтбора = СтрокаОтбора + СокрЛП(Строка(ЭлементОтбора.Значение[1])) + " < " + мСтруктураПредставленийОтборов[ЭлементОтбора.Ключ] + " <= "+ СокрЛП(Строка(ЭлементОтбора.Значение[2]));
	КонецЕсли; 
	
КонецПроцедуры

// Процедура проверяет наличие и при необходимости добавляет новый элемент в писок истории отборов.
// 
// Параметры
//  НЕТ
//
// Возвращаемые значения
//  НЕТ
Процедура ДобавитьНовыйОтборВИсторию()
	
	СтрокаТекущихОтборов = "";
	СтруктураАктуальныхОтборов = Новый Структура;
	
	Для каждого ЭлементОтбора Из СтруктураОтборов Цикл
		Если ЭлементОтбора.Ключ = "Пользователь" Тогда
			Продолжить;
		КонецЕсли; 
		МассивИсторииОтбора = Новый Массив;
		МассивИсторииОтбора.Добавить(ЭлементОтбора.Значение[0]);
		МассивИсторииОтбора.Добавить(ЭлементОтбора.Значение[1]);
		Если ЭлементОтбора.Значение.Количество() = 3 Тогда
			МассивИсторииОтбора.Добавить(ЭлементОтбора.Значение[2]);
		КонецЕсли; 
		МассивИсторииОтбора.Добавить(Истина);
		ДописатьСтрокуОтбора(СтрокаТекущихОтборов, ЭлементОтбора);
		СтруктураАктуальныхОтборов.Вставить(ЭлементОтбора.Ключ, МассивИсторииОтбора);
	КонецЦикла;
	
	Если СтруктураАктуальныхОтборов.Количество() = 0 Тогда
		Возврат;
	КонецЕсли; 
	
	НайденныйЭлементСпискаЗначений = Неопределено;
	Для каждого ЭлементСписка Из мСписокИсторииОтбора Цикл
		Если ЭлементСписка.Представление = СтрокаТекущихОтборов Тогда
			НайденныйЭлементСпискаЗначений = ЭлементСписка;
		КонецЕсли; 
	КонецЦикла;
	
	Если НайденныйЭлементСпискаЗначений = Неопределено Тогда
		
		Если мСписокИсторииОтбора.Количество() > 0 Тогда
			мСписокИсторииОтбора.Вставить(0, СтруктураАктуальныхОтборов, СтрокаТекущихОтборов);
		Иначе
			мСписокИсторииОтбора.Добавить(СтруктураАктуальныхОтборов, СтрокаТекущихОтборов);
		КонецЕсли;
		
		Если мСписокИсторииОтбора.Количество() > 20 Тогда
			ИндУдаляемогоЭлемента = 20;
			Пока Истина Цикл
				Если (ИндУдаляемогоЭлемента + 1) > мСписокИсторииОтбора.Количество() Тогда
					Прервать;
				КонецЕсли;
				мСписокИсторииОтбора.Удалить(20);
			КонецЦикла; 
		КонецЕсли; 
		
	Иначе
		
		мСписокИсторииОтбора.Сдвинуть(НайденныйЭлементСпискаЗначений, (-мСписокИсторииОтбора.Индекс(НайденныйЭлементСпискаЗначений)));
		
	КонецЕсли; 
	
	СформироватьПодменюПоСпискуАктуальныхОтборов();
	
КонецПроцедуры

// Процедура формирует кноаки подменю для кнопки ИсторияОтборов командной панели КоманднаяПанельСписка.
// 
// Параметры
//  НЕТ
//
// Возвращаемые значения
//  НЕТ
Процедура СформироватьПодменюПоСпискуАктуальныхОтборов()
	
	КнопкаПодменю = ЭлементыФормы.КоманднаяПанельСписка.Кнопки.ИсторияОтборов;
	КнопкаПодменю.Кнопки.Очистить();
	КнопкаПодменю1 = ЭлементыФормы.КоманднаяПанельСписка.Кнопки.Подменю.Кнопки.ИсторияОтборов;
	КнопкаПодменю1.Кнопки.Очистить();
	Для каждого ЭлементСписка Из мСписокИсторииОтбора Цикл
		КнопкаПодменю.Кнопки.Добавить(Строка(мСписокИсторииОтбора.Индекс(ЭлементСписка)), ТипКнопкиКоманднойПанели.Действие, ЭлементСписка.Представление, Новый Действие("ОбработкаИсторииОтбора"));
		КнопкаПодменю1.Кнопки.Добавить(Строка(мСписокИсторииОтбора.Индекс(ЭлементСписка)), ТипКнопкиКоманднойПанели.Действие, ЭлементСписка.Представление, Новый Действие("ОбработкаИсторииОтбора"));
	КонецЦикла;
	
КонецПроцедуры

// Процедура устанавливает доступность кнопки СнятьОтбор
// командной панели формы.
//
// Параметры
//  НЕТ
//
// Возвращаемое значение:
//  НЕТ
//
Процедура СостояниеКнопокСнятияОтбора()
	
	Доступность = Ложь;
	
	Для каждого Отбор Из СтруктураОтборов Цикл
		Если Отбор.Ключ <> "Пользователь" Тогда
			Доступность = Истина;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	Если ДатаНач <> Дата("00010101000000") ИЛИ ДатаКон <> Дата("00010101000000") Тогда
		Доступность = Истина;
	КонецЕсли; 
	
	ЭлементыФормы.КоманднаяПанельСписка.Кнопки.СнятьОтбор.Доступность                = Доступность;
	ЭлементыФормы.КоманднаяПанельСписка.Кнопки.Подменю.Кнопки.СнятьОтбор.Доступность = Доступность;
	
КонецПроцедуры

// Функция определяет необходимость вывода строки
// элемента формы События
//
// Параметры
//  Строки - строка таблицы значений
//  СписокПроверяемыхПолей - Список значений, поля, которые надо проверять
//
// Возвращаемое значение:
//   Булево
//
Функция НужноПоказыватьСтрокуСобытий(Строки, СписокПроверяемыхПолей)
	
	ЗначениеВозврата = Истина;
	
	Для каждого ЭлементСписка Из СписокПроверяемыхПолей Цикл
		
		Если ЭлементСписка.Значение = "ТипДокумента" Тогда
			ЗначениеСтроки = ТипЗнч(Строки.Документ);
			Отбор = СтруктураОтборов.Получить(ЭлементСписка.Значение);
			Если Отбор <> Неопределено Тогда
				ВидСравненияОтбора = Отбор[0];
				ЗначениеОтбора = Отбор[1];
				
				Если НЕ ЗначениеОтбора.СодержитТип(ЗначениеСтроки) Тогда
					ЗначениеВозврата = Ложь;
					Прервать;
				КонецЕсли; 
			КонецЕсли; 
		Иначе
			ЗначениеСтроки = Строки[ЭлементСписка.Значение];
			Отбор = СтруктураОтборов.Получить(ЭлементСписка.Значение);
			Если Отбор <> Неопределено Тогда
				ВидСравненияОтбора = Отбор[0];
				ЗначениеОтбора = Отбор[1];
				Если ВидСравненияОтбора = ВидСравнения.Равно И ЗначениеОтбора <> ЗначениеСтроки Тогда
					ЗначениеВозврата = Ложь;
					Прервать;
				ИначеЕсли ВидСравненияОтбора = ВидСравнения.НеРавно И ЗначениеОтбора = ЗначениеСтроки Тогда
					ЗначениеВозврата = Ложь;
					Прервать;
				ИначеЕсли ВидСравненияОтбора = ВидСравнения.Больше И ЗначениеСтроки <= ЗначениеОтбора Тогда
					ЗначениеВозврата = Ложь;
					Прервать;
				ИначеЕсли ВидСравненияОтбора = ВидСравнения.БольшеИлиРавно И ЗначениеСтроки < ЗначениеОтбора  Тогда
					ЗначениеВозврата = Ложь;
					Прервать;
				ИначеЕсли ВидСравненияОтбора = ВидСравнения.Меньше И ЗначениеСтроки >= ЗначениеОтбора Тогда
					ЗначениеВозврата = Ложь;
					Прервать;
				ИначеЕсли ВидСравненияОтбора = ВидСравнения.МеньшеИлиРавно И ЗначениеСтроки > ЗначениеОтбора Тогда
					ЗначениеВозврата = Ложь;
					Прервать;
				ИначеЕсли ВидСравненияОтбора = ВидСравнения.ВСписке И ЗначениеОтбора.НайтиПоЗначению(ЗначениеСтроки) = Неопределено Тогда
					ЗначениеВозврата = Ложь;
					Прервать;
				ИначеЕсли ВидСравненияОтбора = ВидСравнения.НеВСписке И ЗначениеОтбора.НайтиПоЗначению(ЗначениеСтроки) <> Неопределено Тогда
					ЗначениеВозврата = Ложь;
					Прервать;
				ИначеЕсли ВидСравненияОтбора = ВидСравнения.Интервал Тогда
					Если ЗначениеСтроки > Отбор[2] ИЛИ ЗначениеСтроки < Отбор[1] Тогда
						ЗначениеВозврата = Ложь;
						Прервать;
					КонецЕсли; 
				КонецЕсли; 
			КонецЕсли; 
		КонецЕсли; 
		
	КонецЦикла; 
	
	Возврат ЗначениеВозврата;
	
КонецФункции // НужноПоказыватьСтрокуСобытий()

// Процедура заполняет таблицу значений События
//
// Параметры
//  БезЗапроса - Булево, выполнить запрос или нет
//
// Возвращаемое значение:
//  НЕТ
//
Процедура ОбновитьЗаказыСобытия(БезЗапроса = Истина) Экспорт
	
	Если ЕстьОтбор() Тогда
		Если ОтборПоОбъекту И ОбъектФормы <> ВыбКонтрагент Тогда
			ВыбКонтрагент = ОбъектФормы;
			МассивОтбора = Новый Массив;
			МассивОтбора.Добавить(ВидСравнения.Равно);
			МассивОтбора.Добавить(ОбъектФормы);
			СтруктураОтборов.Вставить("Контрагент",МассивОтбора);
		КонецЕсли;
	КонецЕсли;
	
	СписокПроверяемыхПолей = Новый СписокЗначений;
	СписокПроверяемыхПолей.Добавить("Важность");
	СписокПроверяемыхПолей.Добавить("Тип");
	СписокПроверяемыхПолей.Добавить("ТипДокумента");
	СписокПроверяемыхПолей.Добавить("Номер");
	СписокПроверяемыхПолей.Добавить("ВидОперации");
	СписокПроверяемыхПолей.Добавить("ДатаСобытия");
	
	Если НЕ БезЗапроса Тогда
		ЗаполнитьСобытия(ОтображатьЗаказы, ОтображаемыеЗаказы, ОтображатьЗапланированныеСобытия);
	КонецЕсли; 
	
	ТекущаяСтрокаСобытий = Неопределено;
	Если ЗаказыИСобытияПредставление.Количество() > 0 И ЭлементыФормы.ЗаказыИСобытияПредставление.ТекущиеДанные <> Неопределено Тогда
		ТекущаяСтрокаСобытий = ЭлементыФормы.ЗаказыИСобытияПредставление.ТекущиеДанные.Документ;
		ТекущийВид = ЭлементыФормы.ЗаказыИСобытияПредставление.ТекущиеДанные.ВидОперации;
	КонецЕсли;
	
	ЗаказыИСобытияПредставление.Очистить();
	
	ВалютаРегламентированногоУчета = глЗначениеПеременной("ВалютаРегламентированногоУчета");
	
	Для каждого Строки Из ЗаказыСобытия Цикл
		
		Если ТипЗнч(Строки.Документ) = Тип("ДокументСсылка.ЗаказПокупателя") Тогда
			
			НоваяСтрока = ЗаказыИСобытияПредставление.Добавить();
			НоваяСтрока.Документ = Строки.Документ;
			Если Строки.ВидОперации = Перечисления.ВидыДействийПоЗаказамПокупателей.ОтгрузкаПоЗаказу Тогда
				ПоДокументу             = Строки.ИтогКоличествоТЧ;
				НоваяСтрока.ДатаСобытия = Строки.ДатаПоступленияОтгрузки;
				НоваяСтрока.Информация  = "Склад: " + СокрЛП(Строки.Склад);
				НоваяСтрока.Тип         = Перечисления.ВходящееИсходящееСобытие.Исходящее;
			Иначе
				Если Строки.ВалютаДокумента = ВалютаРегламентированногоУчета Тогда
					ПоДокументу = ?(Строки.КурсВзаиморасчетов = 0, 0, (Строки.СуммаДокумента*Строки.КратностьВзаиморасчетов/Строки.КурсВзаиморасчетов));
				Иначе
					ПоДокументу = Строки.СуммаДокумента;
				КонецЕсли; 
				НоваяСтрока.ДатаСобытия = Строки.ДатаОплаты;
				НоваяСтрока.Информация  = ?(ЗначениеЗаполнено(Строки.СтруктурнаяЕдиница), (?(ТипЗнч(Строки.СтруктурнаяЕдиница) = Тип("СправочникСсылка.БанковскиеСчета"),"Банковский счет: ", "Касса: ") + СокрЛП(Строки.СтруктурнаяЕдиница)), "" );
				НоваяСтрока.Тип         = Перечисления.ВходящееИсходящееСобытие.Входящее;
			КонецЕсли;
			НоваяСтрока.ДатаДокумента                  = Строки.Дата;
			НоваяСтрока.Состояние                      = ?(ПоДокументу = Строки.Законченность, Перечисления.СостоянияСобытий.Запланировано, Перечисления.СостоянияСобытий.ПустаяСсылка());
			НоваяСтрока.Важность                       = Перечисления.Важность.Средняя;
			НоваяСтрока.Контрагент                     = Строки.Контрагент;
			НоваяСтрока.ВидОперации                    = Строки.ВидОперации;
			НоваяСтрока.ВидДокумента                   = СокрЛП(Строки.ВидОперации);
			НоваяСтрока.Номер                          = СокрЛП(Строки.Номер);
			НоваяСтрока.ВыполненностьВторойЧастиЗаказа = Строки.ВыполненностьВторойЧастиЗаказа;
			
		ИначеЕсли ТипЗнч(Строки.Документ) = Тип("ДокументСсылка.ЗаказПоставщику") Тогда
			
			НоваяСтрока = ЗаказыИСобытияПредставление.Добавить();
			НоваяСтрока.Документ = Строки.Документ;
			Если Строки.ВидОперации = Перечисления.ВидыДействийПоЗаказамПоставщикам.ПоступлениеПоЗаказу Тогда
				ПоДокументу             = Строки.ИтогКоличествоТЧ;
				НоваяСтрока.ДатаСобытия = Строки.ДатаПоступленияОтгрузки;
				НоваяСтрока.Информация  = "Склад: " + СокрЛП(Строки.Склад);
				НоваяСтрока.Тип                  = Перечисления.ВходящееИсходящееСобытие.Входящее;
				НоваяСтрока.Состояние            = ?(ПоДокументу = Строки.Законченность, Перечисления.СостоянияСобытий.Запланировано, Перечисления.СостоянияСобытий.ПустаяСсылка());
			Иначе
				Если Строки.ВалютаДокумента = ВалютаРегламентированногоУчета Тогда
					ПоДокументу = ?(Строки.КурсВзаиморасчетов = 0, 0, (Строки.СуммаДокумента*Строки.КратностьВзаиморасчетов/Строки.КурсВзаиморасчетов));
				Иначе
					ПоДокументу = Строки.СуммаДокумента;
				КонецЕсли; 
				НоваяСтрока.ДатаСобытия = Строки.ДатаОплаты;
				НоваяСтрока.Информация  = ?(ЗначениеЗаполнено(Строки.СтруктурнаяЕдиница), (?(ТипЗнч(Строки.СтруктурнаяЕдиница) = Тип("СправочникСсылка.БанковскиеСчета"),"Банковский счет: ", "Касса: ") + СокрЛП(Строки.СтруктурнаяЕдиница)), "" );
				НоваяСтрока.Тип                  = Перечисления.ВходящееИсходящееСобытие.Исходящее;
				НоваяСтрока.Состояние            = ?(ПоДокументу = (-1*Строки.Законченность), Перечисления.СостоянияСобытий.Запланировано, Перечисления.СостоянияСобытий.ПустаяСсылка());
			КонецЕсли;
			НоваяСтрока.ДатаДокумента                  = Строки.Дата;
			НоваяСтрока.Важность                       = Перечисления.Важность.Средняя;
			НоваяСтрока.Контрагент                     = Строки.Контрагент;
			НоваяСтрока.ВидОперации                    = Строки.ВидОперации;
			НоваяСтрока.ВидДокумента                   = СокрЛП(Строки.ВидОперации);
			НоваяСтрока.Номер                          = СокрЛП(Строки.Номер);
			НоваяСтрока.ВыполненностьВторойЧастиЗаказа = Строки.ВыполненностьВторойЧастиЗаказа;
			
		ИначеЕсли ТипЗнч(Строки.Документ) = Тип("ДокументСсылка.Событие") Тогда
			
			НоваяСтрока = ЗаказыИСобытияПредставление.Добавить();
			НоваяСтрока.Документ                       = Строки.Документ;
			НоваяСтрока.Состояние                      = Строки.СостояниеСобытия;
			НоваяСтрока.Важность                       = Строки.Важность;
			НоваяСтрока.Тип                            = Строки.ТипСобытия;
			НоваяСтрока.Информация                     = СокрЛП(Строки.ОписаниеСобытия);
			НоваяСтрока.Контрагент                     = Строки.Контрагент;
			НоваяСтрока.ДатаДокумента                  = Строки.Дата;
			НоваяСтрока.ДатаСобытия                    = Строки.НачалоСобытия;
			НоваяСтрока.ВидОперации                    = Строки.ВидОперации;
			НоваяСтрока.ВидДокумента                   = СокрЛП(Строки.ПредставлениеДокумента);
			НоваяСтрока.Номер                          = СокрЛП(Строки.Номер);
			НоваяСтрока.ВыполненностьВторойЧастиЗаказа = Строки.ВыполненностьВторойЧастиЗаказа;
			
		КонецЕсли; 
	КонецЦикла;
	
	ИндексСтроки = 0;
	Пока Истина Цикл
		Если ИндексСтроки > ЗаказыИСобытияПредставление.Количество() - 1 Тогда
			Прервать;
		КонецЕсли;
		Если НЕ НужноПоказыватьСтрокуСобытий(ЗаказыИСобытияПредставление[ИндексСтроки], СписокПроверяемыхПолей) Тогда
			ЗаказыИСобытияПредставление.Удалить(ИндексСтроки);
			Продолжить;
		КонецЕсли;
		ИндексСтроки = ИндексСтроки + 1;
	КонецЦикла; 
	
	ЗаказыИСобытияПредставление.Сортировать("ДатаСобытия ВОЗР");
	
	Если ТекущаяСтрокаСобытий <> Неопределено Тогда
		СтруктураПоиска = Новый Структура;
		СтруктураПоиска.Вставить("Документ",ТекущаяСтрокаСобытий);
		СтруктураПоиска.Вставить("ВидОперации",ТекущийВид);
		МассивСтрок = ЗаказыИСобытияПредставление.НайтиСтроки(СтруктураПоиска);
		Если МассивСтрок.Количество() > 0 Тогда
			ТекущаяСтрокаСобытий = МассивСтрок[0];
			Если ТекущаяСтрокаСобытий <> Неопределено Тогда
				ЭлементыФормы.ЗаказыИСобытияПредставление.ТекущаяСтрока = ТекущаяСтрокаСобытий;
			КонецЕсли; 
		КонецЕсли; 
	КонецЕсли; 
	
КонецПроцедуры

// Процедура устанавливает значение реквизита формы ВыбКонтрагент
//
// Параметры
//  НЕТ
//
// Возвращаемое значение:
//  НЕТ
//
Процедура ОпределитьКонтрагентаФормы()
	
	ОтборКонтрагент = СтруктураОтборов.Получить("КонтактноеЛицо");
	
	Если ОтборКонтрагент = Неопределено Тогда
		ВыбКонтактноеЛицо = Справочники.ФизическиеЛица.ПустаяСсылка();
	Иначе
		ВыбКонтактноеЛицо = ОтборКонтрагент[1];
	КонецЕсли; 
	
КонецПроцедуры

// Функция определяет список документов, которые можно
//  вводить на основании заданного
//  элемента формы События
//
// Параметры
//  ИмяДокумента - строка имя документа, как оно задано в метаданных
//
// Возвращаемое значение:
//   Список значений
//
Функция НайтиДокументыДляОснования(ИмяДокумента)
	
	СписокДокументов = Неопределено;
	
	мДокументыОснования.Свойство(ИмяДокумента, СписокДокументов);
	
	Если ТипЗнч(СписокДокументов) = Тип("СписокЗначений") Тогда
		Возврат СписокДокументов;
	КонецЕсли; 
	
	СписокДокументов = Новый СписокЗначений;
	
	Для каждого Док Из Метаданные.Документы Цикл
		Для каждого Основание Из Док.ВводитсяНаОсновании Цикл
			Если Основание.Имя = ИмяДокумента Тогда
				СписокДокументов.Добавить(Док.Имя, Док.Синоним);
			КонецЕсли; 
		КонецЦикла; 
	КонецЦикла; 
	
	мДокументыОснования.Вставить(ИмяДокумента, СписокДокументов);
	Возврат СписокДокументов;
	
КонецФункции

// Процедура открывает форму документа, введенного на основании текущего
//
// Параметры
//  Кнопка - кнопка командной панели формы
//
// Возвращаемое значение:
//  НЕТ
// // (процедура назначается через Действие)
Процедура ВводНаОсновании(Кнопка)
	
	Если ЭлементыФормы.ЗаказыИСобытияПредставление.ТекущиеДанные <> Неопределено И НЕ ЭлементыФормы.ЗаказыИСобытияПредставление.ТекущиеДанные.Документ.Пустая() Тогда
		
		Док = Новый("ДокументМенеджер."+СокрЛП(Кнопка.Имя));
		Док = Док.СоздатьДокумент();
		Док.Заполнить(ЭлементыФормы.ЗаказыИСобытияПредставление.ТекущиеДанные.Документ);
		Док.ПолучитьФорму(, ЭтаФорма).Открыть();
		
	КонецЕсли; 
	
КонецПроцедуры

// Процедура устанавливает пометку кнопки ОтборПоТекущемуЗначению
// командной панели формы
//
// Параметры
//  НЕТ
//
// Возвращаемое значение:
//  НЕТ
Процедура СостояниеКнопкиОтбораПоТекущемуЗначению()
	
	Если ЭлементыФормы.ЗаказыИСобытияПредставление.ТекущиеДанные = Неопределено ИЛИ ЭлементыФормы.ЗаказыИСобытияПредставление.ТекущаяКолонка = Неопределено Тогда
		Возврат;
	КонецЕсли; 
	
	ТекКолонка = ЭлементыФормы.ЗаказыИСобытияПредставление.ТекущаяКолонка;
	ИмяКолонки = ТекКолонка.Имя;
	КнопкаПанели = ЭлементыФормы.КоманднаяПанельСписка.Кнопки.ОтборПоТекущемуЗначению;
	КнопкаПанели1 = ЭлементыФормы.КоманднаяПанельСписка.Кнопки.Подменю.Кнопки.ОтборПоТекущемуЗначению;
	
	Если ИмяКолонки = "Картинка" Тогда
		Возврат;
	КонецЕсли; 
	
	ТекЗначение = ЭлементыФормы.ЗаказыИСобытияПредставление.ТекущиеДанные[ИмяКолонки];
	
	Если ИмяКолонки = "ДатаДокумента" Тогда
		Если НачалоДня(ТекЗначение) = НачалоДня(ДатаНач) И НачалоДня(ТекЗначение) = НачалоДня(ДатаКон) Тогда
			КнопкаПанели.Пометка = Истина;
			КнопкаПанели1.Пометка = Истина;
		Иначе
			КнопкаПанели.Пометка = Ложь;
			КнопкаПанели1.Пометка = Ложь;
		КонецЕсли;
	Иначе
		ЗначениеСоответствия = СтруктураОтборов.Получить(ИмяКолонки);
		Если ЗначениеСоответствия <> Неопределено И ЗначениеСоответствия[0] = ВидСравнения.Равно И ТекЗначение = ЗначениеСоответствия[1] Тогда
			КнопкаПанели.Пометка = Истина;
			КнопкаПанели1.Пометка = Истина;
		Иначе
			КнопкаПанели.Пометка = Ложь;
			КнопкаПанели1.Пометка = Ложь;
		КонецЕсли; 
	КонецЕсли; 
	
КонецПроцедуры

// Функция возвращает наименование дня недели по его номеру
//
// Параметры
//  НомерДняНедели - Число, номер дня недели
//
// Возвращаемое значение:
//   Строка, наименование дня недели
//
Функция ОпределитьДеньНедели(НомерДняНедели)
	
	Если НомерДняНедели = 1 Тогда
		Возврат "Понедельник";
	ИначеЕсли НомерДняНедели = 2 Тогда
		Возврат "Вторник";
	ИначеЕсли НомерДняНедели = 3 Тогда
		Возврат "Среда";
	ИначеЕсли НомерДняНедели = 4 Тогда
		Возврат "Четверг";
	ИначеЕсли НомерДняНедели = 5 Тогда
		Возврат "Пятница";
	ИначеЕсли НомерДняНедели = 6 Тогда
		Возврат "Суббота";
	Иначе
		Возврат "Воскресенье";
	КонецЕсли;
	
КонецФункции

// Процедура формирует строковое представление текущего значения интервалов
//  календаря пользователя
//
// Параметры
//  НЕТ
//
// Возвращаемое значение
//  НЕТ
Процедура СформироватьПредставлениеДня()
	
	СтрокаДня = Формат(ДатаКалендаря, "ДЛФ=DD") + ", " + ОпределитьДеньНедели(ДеньНедели(ДатаКалендаря));
	СтрокаМесяца = Формат(ДатаКалендаря, "ДФ=ММММ") + ", " + Формат(ДатаКалендаря, "ДФ=yyyy") + " г.";
	СтрокаНедели = Формат(НачалоНедели(ДатаКалендаря), "ДФ='dd MMMM yyyy'") + " г. - " + Формат(КонецНедели(ДатаКалендаря), "ДФ='dd MMMM yyyy'") + " г.";
	
	ЭлементыФормы.НадписьДня.Значение = СтрокаДня;
	ЭлементыФормы.НадписьМесяца.Значение = СтрокаМесяца;
	ЭлементыФормы.НадписьНедели.Значение = СтрокаНедели;
	
КонецПроцедуры

// Функция возвращает картинку вида События по значению вида
//
// Параметры
//  ВидСобытия - перчисление, вид события
//
// Возвращаемое значение:
//   Картинка - картинка вида события
//
Функция ОпределитьКартинку(ВидСобытия,ТипСобытия)
	
	Если ВидСобытия = Перечисления.ВидыСобытий.ЛичнаяВстреча Тогда
		Если ТипСобытия = Перечисления.ВходящееИсходящееСобытие.Исходящее Тогда
			Возврат мЛичнаяВстречаИсходящяя;
		Иначе
			Возврат мЛичнаяВстречаВходящяя;
		КонецЕсли;
	ИначеЕсли ВидСобытия = Перечисления.ВидыСобытий.ПочтовоеПисьмо Тогда
		Если ТипСобытия = Перечисления.ВходящееИсходящееСобытие.Исходящее Тогда
			Возврат мПочтовоеПисьмоИсходящее;
		Иначе
			Возврат мПочтовоеПисьмоВходящее;
		КонецЕсли;
	ИначеЕсли ВидСобытия = Перечисления.ВидыСобытий.Прочее Тогда
		Если ТипСобытия = Перечисления.ВходящееИсходящееСобытие.Исходящее Тогда
			Возврат мПрочееСобытиеИсходящее;
		Иначе
			Возврат мПрочееСобытиеВходящее;
		КонецЕсли;
	ИначеЕсли ВидСобытия = Перечисления.ВидыСобытий.ТелефонныйЗвонок Тогда
		Если ТипСобытия = Перечисления.ВходящееИсходящееСобытие.Исходящее Тогда
			Возврат мТелефонныйЗвонокИсходящий;
		Иначе
			Возврат мТелефонныйЗвонокВходящий;
		КонецЕсли;
	ИначеЕсли ВидСобытия = Перечисления.ВидыСобытий.ЭлектронноеПисьмо Тогда
		Если ТипСобытия = Перечисления.ВходящееИсходящееСобытие.Исходящее Тогда
			Возврат мЭлектронноеПисьмоИсходящее;
		Иначе
			Возврат мЭлектронноеПисьмоВходящее;
		КонецЕсли;
	Иначе
		Возврат Новый Картинка;
	КонецЕсли; 
	
КонецФункции // ОпределитьКартинку()

// Процедура на таблице документа визуально показывает наличие событий,
// не отображаемых в текущей настройки показа времени календаря
//
// Параметры
//  Таб                        - табличный документ
//  РисункиТабличногоДокумента - список рисунков табличного документа
//  ВерхНиз                    - направление отображения невидимых событий, принимаемые значения "Верх или "Низ"
//  Колонка                    - начальная колонка для отображения картинки
//  СмещениеСтрок              - смещение строк для отображаемой картинки
//
Процедура УказатьНаличиеНевидимыхСобытий(Таб,РисункиТабличногоДокумента,ВерхНиз = "Верх",Колонка = 2,СмещениеСтрок = 0,ДополнительнаяОбластьНачКолонка = 0,ДополнительнаяОбластьКонКолонка = 0)
	
	НовыйРисунок = РисункиТабличногоДокумента.Добавить(ТипРисункаТабличногоДокумента.Картинка);
	
	Если ВерхНиз = "Верх" Тогда
		НовыйРисунок.Картинка = БиблиотекаКартинок.СтрелкаВверхКалендаря;
		ОбластьРисунка = Таб.Область(1+СмещениеСтрок, Колонка, 1+СмещениеСтрок, Колонка);
		
		ОбластьЧисло = Таб.Область(1+СмещениеСтрок, Колонка-1, 1+СмещениеСтрок, Колонка-1);
		ОбластьЧисло.ЦветТекста = WebЦвета.Красный;
	Иначе
		НовыйРисунок.Картинка = БиблиотекаКартинок.СтрелкаВнизКалендаря;
		ОбластьРисунка = Таб.Область(НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня+СмещениеСтрок, Колонка, НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня+СмещениеСтрок, Колонка);
		
		ОбластьЧисло = Таб.Область(НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня-1+СмещениеСтрок, Колонка-1, НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня+СмещениеСтрок, Колонка-1);
		ОбластьЧисло.ЦветТекста = WebЦвета.Красный;
	КонецЕсли;   
	
	Если ДополнительнаяОбластьНачКолонка>0 И ДополнительнаяОбластьКонКолонка>0 Тогда
		ОбластьЧисло = Таб.Область(1, ДополнительнаяОбластьНачКолонка, 2, ДополнительнаяОбластьКонКолонка);
		ОбластьЧисло.ЦветТекста = WebЦвета.Красный;
	КонецЕсли;
	
	НовыйРисунок.ГраницаСлева = Ложь;
	НовыйРисунок.ЦветЛинии    = ОбластьРисунка.ЦветРамки;
	НовыйРисунок.ЦветФона     = ОбластьРисунка.ЦветФона;
	
	НайденныйРисунок = НовыйРисунок;
	
	НайденныйРисунок.Расшифровка = Новый Структура("Действие,Направление","Раскрыть",ВерхНиз);
	НайденныйРисунок.Защита = Истина;
	НайденныйРисунок.Расположить(ОбластьРисунка);
	
КонецПроцедуры

// Процедура заполняет данными поле табличного документа ПолеТабличногоДокументаДень.
//
// Параметры
//  НЕТ
//
// Возвращаемое значение
//  НЕТ
Процедура ЗаполнитьТаблицуДня()
	
	Если ОтображатьЗаказы Тогда
		ЭлементыФормы.НадписьДняВторого.Видимость = Ложь;
		ЭлементыФормы.ПанельМоксельГрид.ТекущаяСтраница = ЭлементыФормы.ПанельМоксельГрид.Страницы.Грид;
		// Начало отображения сделок
		ТекИндексСделок = -1;
		Если ЭлементыФормы.СделкиДень.ТекущаяСтрока <> Неопределено Тогда
			ТекИндексСделок = СделкиДень.Индекс(ЭлементыФормы.СделкиДень.ТекущиеДанные);
		КонецЕсли; 
			
		СделкиДень.Очистить();
			
		Для каждого СтрокаТаблицы Из ДанныеНеделиЗаказы Цикл
			Если НачалоДня(СтрокаТаблицы.Дата) = НачалоДня(ДатаКалендаря) Тогда
				НоваяСделка = СделкиДень.Добавить();
				НоваяСделка.Документ = СтрокаТаблицы.Документ;
				НоваяСделка.ВидДокументаЗаказа = СтрокаТаблицы.ТипЗаказа;
				Если ТипЗнч(НоваяСделка.Документ) = Тип("ДокументСсылка.ЗаказПокупателя") ИЛИ ТипЗнч(НоваяСделка.Документ) = Тип("ДокументСсылка.ЗаказПоставщику") Тогда
					НоваяСделка.ВидОперации = СтрокаТаблицы.Документ.ВидОперации;
				Иначе
					НоваяСделка.ВидОперации = СтрокаТаблицы.Документ.Метаданные().Синоним;
				КонецЕсли; 
				НоваяСделка.Контрагент = СтрокаТаблицы.Документ.Контрагент;
			КонецЕсли;
		КонецЦикла;
			
		Если ТекИндексСделок <> -1 Тогда
			Если СделкиДень.Количество() >= ТекИндексСделок + 1 Тогда
				ЭлементыФормы.СделкиДень.ТекущаяСтрока = СделкиДень.Получить(ТекИндексСделок);
			КонецЕсли;
		КонецЕсли; 
		// Конец отображения сделок
		Таб = ЭлементыФормы.ПолеТабличногоДокументаДень;
	Иначе
		ЭлементыФормы.НадписьДняВторого.Видимость = Истина;
		ЭлементыФормы.ПанельМоксельГрид.ТекущаяСтраница = ЭлементыФормы.ПанельМоксельГрид.Страницы.Моксель;
		Таб = ЭлементыФормы.ПолеТабличногоДокументаДеньВторой;
	КонецЕсли; 
		
	// Начало отображения календаря
		
	// Построим первый день, для режима отображения заказов - он единственный
	Таб.Очистить();
		
	ШиринаТабличногоПоляДня = Таб.Ширина;
		
	// Определим общую ширину дня 
	Если ОтображатьЗаказы Тогда
		ОбщаяШиринаКолонокДня = Цел(148*(ШиринаТабличногоПоляДня-56)/(1094-56));
	Иначе
		Если КоличествоДнейНаЗакладкеДень=1 Тогда
			ОбщаяШиринаКолонокДня = Цел(148*(ШиринаТабличногоПоляДня-56)/(1094-56));
		Иначе
			ОбщаяШиринаКолонокДня = Цел(140*(ШиринаТабличногоПоляДня-112)/(1094-112)/2);
		КонецЕсли;
	КонецЕсли; 
		
	ЗначениеРеквизитаДняНедели = ОбработкаОбъект["СобытияНедели_День" + Строка(ДеньНедели(ДатаКалендаря))];
		
	МаксимальноеКоличествоОдновременныхДокументов = 1;
	МаксимальноеКоличествоОдновременныхДокументовПоПомещениям = 0;
		
	ОтображатьЗанятостьПомещенийДляТекущегоДня = ОтображатьЗанятостьПомещений;
		
	// Определим из событий максимальное количество одновременных документов
	Если ТипЗнч(ЗначениеРеквизитаДняНедели) = Тип("Структура") Тогда
		ТаблицаСобытий = ЗначениеРеквизитаДняНедели.ТаблицаСобытий.Скопировать();
		Если ТаблицаСобытий.Количество()>0 Тогда
			ТаблицаСобытий.Сортировать("КоличествоОдновременныхДокументов УБЫВ");
			МаксимальноеКоличествоОдновременныхДокументов = ТаблицаСобытий[0].КоличествоОдновременныхДокументов;
		КонецЕсли;
			
		// если отображаем помещения
		Если ОтображатьЗанятостьПомещенийДляТекущегоДня Тогда
			ТаблицаСобытийПоПомещениям = ЗначениеРеквизитаДняНедели.ТаблицаСобытийПоПомещениям.Скопировать();
			Если ТаблицаСобытийПоПомещениям.Количество()>0 Тогда
				ТаблицаСобытийПоПомещениям.Сортировать("КоличествоОдновременныхДокументов УБЫВ");
				МаксимальноеКоличествоОдновременныхДокументовПоПомещениям = ТаблицаСобытийПоПомещениям[0].КоличествоОдновременныхДокументов;
			Иначе
				ОтображатьЗанятостьПомещенийДляТекущегоДня = Ложь;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
		
	ОбщаяШиринаКолонокТекущегоДня = ?(ОтображатьЗанятостьПомещенийДляТекущегоДня,Цел(ОбщаяШиринаКолонокДня/2),ОбщаяШиринаКолонокДня);
		
	// каждое событие состоит из двух колонок - под картинку (ширина 2) и под текст (ширина определяется)
	ШиринаВторойЧасти = Цел((ОбщаяШиринаКолонокТекущегоДня - МаксимальноеКоличествоОдновременныхДокументов*2)/МаксимальноеКоличествоОдновременныхДокументов);
		
	// ширина последней колонки должна быть "дотянута" до края
	ШиринаБезПоследнейКолонки = ШиринаВторойЧасти*(МаксимальноеКоличествоОдновременныхДокументов-1) + МаксимальноеКоличествоОдновременныхДокументов*2;
	ШиринаПоследнейКолонки = Макс(0,ОбщаяШиринаКолонокТекущегоДня - ШиринаБезПоследнейКолонки);
		
	Если ОтображатьЗанятостьПомещенийДляТекущегоДня Тогда
		// ширина для помещения
		ШиринаПоПомещениям = Цел((ОбщаяШиринаКолонокДня - ОбщаяШиринаКолонокТекущегоДня)/МаксимальноеКоличествоОдновременныхДокументовПоПомещениям);
			
		// ширина последней колонки должна быть "дотянута" до края
		ШиринаПоследнейКолонкиПоПомещениям = Макс(0,(ОбщаяШиринаКолонокДня - ОбщаяШиринаКолонокТекущегоДня) - ШиринаПоПомещениям*(МаксимальноеКоличествоОдновременныхДокументовПоПомещениям-1));
	КонецЕсли;
		
	// определяем количество колонок в зависимости от количества одновременных документов по событиями и помещениям
	ОбщаяШиринаДняДляРаспределенияСобытий = МаксимальноеКоличествоОдновременныхДокументов*2;
	ОбщаяШиринаДня = ОбщаяШиринаДняДляРаспределенияСобытий + МаксимальноеКоличествоОдновременныхДокументовПоПомещениям;
		
	Таб.ВставитьОбласть(мМакетДня.Область(1+СмещениеОтНачалаПервойЯчейкиДня,1,НомерПоследнейЯчейкиДня,ОбщаяШиринаДня+2), Таб.Область(1,1,НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня,ОбщаяШиринаДня+2));
		
	Таб.Область(,1,,1).ШиринаКолонки  = 4;
	Таб.Область(,2,,2).ШиринаКолонки  = 2;
	Таб.Область(1,,НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня,).ВысотаСтроки  = 11;
		
	СчетКолонок = 1;
	Для а=3 по ОбщаяШиринаДняДляРаспределенияСобытий+1 Цикл
		Если СчетКолонок = 1 Тогда
			Таб.Область(,а,,а).ШиринаКолонки = 2;
		Иначе
			Таб.Область(,а,,а).ШиринаКолонки = ШиринаВторойЧасти;
		КонецЕсли;
		СчетКолонок = СчетКолонок + 1;
		СчетКолонок = ?(СчетКолонок>2,1,2);
	КонецЦикла;
	// последняя колонка отдельно
	Таб.Область(,ОбщаяШиринаДняДляРаспределенияСобытий+2,,ОбщаяШиринаДняДляРаспределенияСобытий+2).ШиринаКолонки = ШиринаПоследнейКолонки;
		
	Если ОтображатьЗанятостьПомещенийДляТекущегоДня Тогда
		Для а=ОбщаяШиринаДняДляРаспределенияСобытий+3 по ОбщаяШиринаДня+1 Цикл
			Таб.Область(,а,,а).ШиринаКолонки = ШиринаПоПомещениям;
		КонецЦикла;
		// последняя колонка отдельно
		Таб.Область(,ОбщаяШиринаДня+2,,ОбщаяШиринаДня+2).ШиринаКолонки = ШиринаПоследнейКолонкиПоПомещениям;
	КонецЕсли;
		
	СформироватьПредставлениеДня();
		
	СтруктураРабочегоВремени = мОпределитьНачалоИОкончаниеРабочегоДняПользователя(глЗначениеПеременной("глТекущийПользователь"), ДатаКалендаря);
		
	ДатаНачалаРабочегоДня    = СтруктураРабочегоВремени.ДатаНачала;
	ДатаОкончанияРабочегоДня = СтруктураРабочегоВремени.ДатаОкончания;
		
	Если ДатаНачалаРабочегоДня = '00010101000000' И ДатаОкончанияРабочегоДня = '00010101235959' Тогда
			
		ОбластьРабочегоДня = Таб.Область(1,3,НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня,ОбщаяШиринаДня+2);
		ОбластьРабочегоДня.ЦветФона = ЦветаСтиля.ЦветФонаКнопки;
		КонечнаяСтрокаРабочегоДня  = Неопределено;
		НачальнаяСтрокаРабочегоДня = Неопределено;
		Таб.Область(1,1,НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня,2).ЦветФона = ЦветаСтиля.ЦветФонаКнопки;
			
	Иначе
			
		НачальнаяСтрокаРабочегоДня = УправлениеКонтактами.ВозвратитьНомерСтроки(Формат(ДатаНачалаРабочегоДня,"ДФ=Ч"), Формат(ДатаНачалаРабочегоДня,"ДФ=м"), ДатаКалендаря, Истина, ДатаКалендаря);
		Если Формат(ДатаНачалаРабочегоДня,"ДФ=Ч") = Формат(ДатаОкончанияРабочегоДня,"ДФ=Ч") И Формат(ДатаНачалаРабочегоДня,"ДФ=м") = Формат(ДатаОкончанияРабочегоДня,"ДФ=м") Тогда
			КонечнаяСтрокаРабочегоДня  = НачальнаяСтрокаРабочегоДня;
		Иначе
			КонечнаяСтрокаРабочегоДня = УправлениеКонтактами.ВозвратитьНомерСтроки(Формат(ДатаОкончанияРабочегоДня,"ДФ=Ч"), Формат(ДатаОкончанияРабочегоДня,"ДФ=м"), ДатаКалендаря, Ложь, ДатаКалендаря);
		КонецЕсли; 
			
		ОбластьДоРабочегоДня = Таб.Область(1,3,(НачальнаяСтрокаРабочегоДня - 1-СмещениеОтНачалаПервойЯчейкиДня),ОбщаяШиринаДня+2);
		ОбластьДоРабочегоДня.ЦветФона = ЦветаСтиля.ЦветФонаКнопки;
		ОбластьРабочегоДня = Таб.Область(НачальнаяСтрокаРабочегоДня-СмещениеОтНачалаПервойЯчейкиДня,3,КонечнаяСтрокаРабочегоДня-СмещениеОтНачалаПервойЯчейкиДня,ОбщаяШиринаДня+2);
		ОбластьРабочегоДня.ЦветФона = ЦветаСтиля.ЦветФонаФормы;
		Если КонечнаяСтрокаРабочегоДня < НомерПоследнейЯчейкиДня Тогда
			ОбластьПослеРабочегоДня = Таб.Область((КонечнаяСтрокаРабочегоДня + 1 -СмещениеОтНачалаПервойЯчейкиДня),3,НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня,ОбщаяШиринаДня+2);
			ОбластьПослеРабочегоДня.ЦветФона = ЦветаСтиля.ЦветФонаКнопки;
		КонецЕсли; 
		Таб.Область(НачальнаяСтрокаРабочегоДня-СмещениеОтНачалаПервойЯчейкиДня,1,КонечнаяСтрокаРабочегоДня-СмещениеОтНачалаПервойЯчейкиДня,2).ЦветФона = ЦветаСтиля.ЦветФонаФормы;
			
	КонецЕсли; 
		
	Если НачалоДня(ТекущаяДата()) = НачалоДня(ДатаКалендаря) Тогда
		ТекущийЧас = Час(ТекущаяДата());
		СтрокаТекущегоЧаса = ТекущийЧас*2+1-СмещениеОтНачалаПервойЯчейкиДня+?(Минута(ТекущаяДата())>29,1,0);
			
		Если СтрокаТекущегоЧаса <= НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня Тогда
			Таб.Область(СтрокаТекущегоЧаса,2,Мин(СтрокаТекущегоЧаса+1,НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня),ОбщаяШиринаДня+2).ЦветФона = WebЦвета.Бежевый;
		КонецЕсли;
	КонецЕсли;
		
	Таб.Рисунки.Очистить();
	РисункиТабличногоДокумента = Таб.Рисунки;
		
	ВерхняяСтрокаНевидимойОбластиДня = 1+СмещениеОтНачалаПервойЯчейкиДня;
	НижняяСтрокаНевидимойОбластиДня  = НомерПоследнейЯчейкиДня;
		
	Если ТипЗнч(ЗначениеРеквизитаДняНедели) = Тип("Структура") Тогда
			
		СписокЗначенийВремен = ЗначениеРеквизитаДняНедели.РасположениеСобытий;
		ТаблицаСобытий       = ЗначениеРеквизитаДняНедели.ТаблицаСобытий.Скопировать();
			
		СписокЗначенийВременПоПомещениям = ЗначениеРеквизитаДняНедели.РасположениеСобытийПоПомещениям;
		ТаблицаСобытийПоПомещениям       = ЗначениеРеквизитаДняНедели.ТаблицаСобытийПоПомещениям.Скопировать();
			
		Если ОтображатьЗанятостьПомещенийДляТекущегоДня Тогда
			Таб.Область(1,ОбщаяШиринаДняДляРаспределенияСобытий+2,НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня,ОбщаяШиринаДняДляРаспределенияСобытий+2).ГраницаСправа = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная);
		КонецЕсли;
			
		ШиринаОдногоСобытияВГруппе = Цел(ОбщаяШиринаДняДляРаспределенияСобытий/МаксимальноеКоличествоОдновременныхДокументов);
			
		// определим колонки для таблицы событий (независимо от диапозона показа)
		Для а = 0 По 47 Цикл
				
			ПоследнийСтолбец = 2;
				
			СписокТекущихДокументов = СписокЗначенийВремен.Получить(а).Значение;
				
			Для каждого ТекДокумент Из СписокТекущихДокументов Цикл
					
				СтрокаТаблицыДокументов = ТаблицаСобытий.Найти(ТекДокумент.Значение, "Документ");
				Если СтрокаТаблицыДокументов <> Неопределено Тогда
					Если СтрокаТаблицыДокументов.КоличествоОдновременныхДокументов = 1 Тогда
						ШиринаТекущегоДокумента = ОбщаяШиринаДняДляРаспределенияСобытий;
					Иначе
						ШиринаТекущегоДокумента = ШиринаОдногоСобытияВГруппе;
					КонецЕсли;
				Иначе
					ШиринаТекущегоДокумента = 0;
					Продолжить;
				КонецЕсли;
					
				Если СтрокаТаблицыДокументов.НомерНачальнойКолонки = 0 И СтрокаТаблицыДокументов.НомерКонечнойКолонки = 0 Тогда
					СтрокаТаблицыДокументов.НомерНачальнойКолонки = ПоследнийСтолбец + 1;
					СтрокаТаблицыДокументов.НомерКонечнойКолонки = ПоследнийСтолбец + ШиринаТекущегоДокумента;
				КонецЕсли;
					
				ПоследнийСтолбец = СтрокаТаблицыДокументов.НомерНачальнойКолонки - 1 + ШиринаТекущегоДокумента;
					
			КонецЦикла; 
				
		КонецЦикла;   
			
		ИндексСтрокиТаблицы = 0;
		Пока Истина Цикл
				
			Если ИндексСтрокиТаблицы > ТаблицаСобытий.Количество() - 1 Тогда
				Прервать;
			КонецЕсли; 
				
			СтрокаТаблицы = ТаблицаСобытий[ИндексСтрокиТаблицы];
				
			Если СтрокаТаблицы.НомерНачальнойКолонки = 0 ИЛИ СтрокаТаблицы.НомерКонечнойКолонки = 0 Тогда
				ТаблицаСобытий.Удалить(СтрокаТаблицы);
			Иначе
				ИндексСтрокиТаблицы = ИндексСтрокиТаблицы + 1;
			КонецЕсли; 
				
		КонецЦикла; 
			
		Для каждого СтрокаТаблицы Из ТаблицаСобытий Цикл
				
			ПерваяСтрокаОбласти    = СтрокаТаблицы.НомерНачальнойСтроки-СмещениеОтНачалаПервойЯчейкиДня;
			ПоследняяСтрокаОбласти = СтрокаТаблицы.НомерКонечнойСтроки-СмещениеОтНачалаПервойЯчейкиДня;
			Если ПерваяСтрокаОбласти < 1 Тогда
				ВерхняяСтрокаНевидимойОбластиДня = Мин(СтрокаТаблицы.НомерНачальнойСтроки,ВерхняяСтрокаНевидимойОбластиДня);
				УказатьНаличиеНевидимыхСобытий(Таб,РисункиТабличногоДокумента,"Верх",2); 
				Если ПоследняяСтрокаОбласти < 1 Тогда
					Продолжить;
				Иначе
					ПерваяСтрокаОбласти = 1;
				КонецЕсли;
			ИначеЕсли ПерваяСтрокаОбласти > НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня Тогда
				НижняяСтрокаНевидимойОбластиДня = Макс(СтрокаТаблицы.НомерКонечнойСтроки,НижняяСтрокаНевидимойОбластиДня);
				УказатьНаличиеНевидимыхСобытий(Таб,РисункиТабличногоДокумента,"Низ",2); 
				Продолжить;
			КонецЕсли;
				
			Если ПоследняяСтрокаОбласти > НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня Тогда
				НижняяСтрокаНевидимойОбластиДня = Макс(СтрокаТаблицы.НомерКонечнойСтроки,НижняяСтрокаНевидимойОбластиДня);
				УказатьНаличиеНевидимыхСобытий(Таб,РисункиТабличногоДокумента,"Низ",2); 
				ПоследняяСтрокаОбласти = НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня;
			КонецЕсли;
				
			ТекОбласть = Таб.Область(ПерваяСтрокаОбласти, СтрокаТаблицы.НомерНачальнойКолонки, ПоследняяСтрокаОбласти, СтрокаТаблицы.НомерКонечнойКолонки);
				
			ТекстЯчейки = "";
			Если ТипЗнч(СтрокаТаблицы.Документ) = Тип("ДокументСсылка.Событие") Тогда
					
				ТекстЯчейки = "" + ?((ТекОбласть.Низ - ТекОбласть.Верх + 1) > 2 , Символы.ПС, "") + ТекстЯчейки + Формат(СтрокаТаблицы.ДатаНачалаСобытия, "ДФ=ЧЧ:мм") + " - " + Формат(СтрокаТаблицы.ДатаКонцаСобытия, "ДФ=ЧЧ:мм");
				Если ЗначениеЗаполнено(СтрокаТаблицы.Контрагент) Тогда
					Если НЕ ПустаяСтрока(ТекстЯчейки) Тогда
						ТекстЯчейки = ТекстЯчейки + ?((ТекОбласть.Низ - ТекОбласть.Верх + 1) >= 2 , Символы.ПС, ", ");
					КонецЕсли; 
					ТекстЯчейки = ТекстЯчейки + Строка(СтрокаТаблицы.Контрагент);
				КонецЕсли; 
				Если ЗначениеЗаполнено(СтрокаТаблицы.КонтактноеЛицо) Тогда
					Если НЕ ПустаяСтрока(ТекстЯчейки) Тогда
						ТекстЯчейки = ТекстЯчейки + ?((ТекОбласть.Низ - ТекОбласть.Верх + 1) > 2 , ?(((ТекОбласть.Низ - ТекОбласть.Верх + 1) = 3), ", ", Символы.ПС), ", ");
					КонецЕсли; 
					ТекстЯчейки = ТекстЯчейки + Строка(СтрокаТаблицы.КонтактноеЛицо);
				КонецЕсли;
				Если НЕ ПустаяСтрока(СтрокаТаблицы.ОписаниеСобытия) Тогда
					Если НЕ ПустаяСтрока(ТекстЯчейки) Тогда
						ТекстЯчейки = ТекстЯчейки + ?((ТекОбласть.Низ - ТекОбласть.Верх + 1) >= 2 , Символы.ПС, ", ");
					КонецЕсли;
					ТекстЯчейки = ТекстЯчейки + СокрЛП(СтрокаТаблицы.ОписаниеСобытия);
				КонецЕсли; 
					
				Если ПользовательКалендаря.Количество()>1 Тогда
					ТекстЯчейки = ТекстЯчейки + ", "+ СтрокаТаблицы.Документ.Ответственный;
				КонецЕсли;
					
			КонецЕсли; 
				
			Если (ТекОбласть.Право - ТекОбласть.Лево + 1) < 4 Тогда
				ТекстЯчейки = ?((ТекОбласть.Низ - ТекОбласть.Верх + 1) >= 2 , Символы.ПС, "          ") + ТекстЯчейки;
			Иначе
				Если (ТекОбласть.Низ - ТекОбласть.Верх + 1) <= 2 Тогда
					ТекстЯчейки = "     " + ТекстЯчейки;
				КонецЕсли; 
			КонецЕсли; 
				
			ТекОбласть.ГраницаСлева = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная);
			ТекОбласть.ГраницаСправа = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная);
			ТекОбласть.ГраницаСверху = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная);
			ТекОбласть.ГраницаСнизу = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная);
			ТекОбласть.Объединить();
			ТекОбласть.ВертикальноеПоложение = ВертикальноеПоложение.Верх;
			ТекОбласть.ЦветФона = Новый Цвет;
				
			ТекОбласть.Текст = ТекстЯчейки;
			Если (ТекОбласть.Низ - ТекОбласть.Верх + 1) < 2 Тогда
				ТекОбласть.РазмещениеТекста = ТипРазмещенияТекстаТабличногоДокумента.Авто;
			Иначе
				ТекОбласть.РазмещениеТекста = ТипРазмещенияТекстаТабличногоДокумента.Переносить;
			КонецЕсли; 
			ТекОбласть.Заполнение = ТипЗаполненияОбластиТабличногоДокумента.Текст;
			ТекОбласть.ПоВыделеннымКолонкам = Истина;
			ТекОбласть.Расшифровка = СтрокаТаблицы.Документ;
				
			Если СтрокаТаблицы.Важность = Перечисления.Важность.Высокая Тогда
				ТекОбласть.ЦветТекста = WebЦвета.Красный;
			КонецЕсли;
			Если СтрокаТаблицы.СостояниеСобытия <> Перечисления.СостоянияСобытий.Запланировано Тогда
				ТекОбласть.ЦветФона = WebЦвета.Перламутровый;
				ТекОбласть.ЦветТекста = WebЦвета.Серый;
			КонецЕсли; 
				
			// Отобразим вид с типом события
				
			КартинкаВидаСобытия = ОпределитьКартинку(СтрокаТаблицы.ВидСобытия,СтрокаТаблицы.ТипСобытия);
			НовыйРисунок = РисункиТабличногоДокумента.Добавить(ТипРисункаТабличногоДокумента.Картинка);
			НовыйРисунок.Картинка = КартинкаВидаСобытия;
			НовыйРисунок.ЦветЛинии = ЦветаСтиля.ЦветРамки;
			Если СтрокаТаблицы.СостояниеСобытия <> Перечисления.СостоянияСобытий.Запланировано Тогда
				НовыйРисунок.ЦветФона = WebЦвета.Перламутровый;
			КонецЕсли;
			НовыйРисунок.ГраницаСверху = Истина;
			Если (ТекОбласть.Низ - ТекОбласть.Верх + 1) < 2 Тогда
				НовыйРисунок.ГраницаСнизу = Истина;
			Иначе
				НовыйРисунок.ГраницаСнизу = Ложь;
			КонецЕсли;
			Если ШиринаВторойЧасти = 0 Тогда
				НовыйРисунок.ГраницаСправа = Истина;;
			Иначе
				НовыйРисунок.ГраницаСправа = Ложь;
			КонецЕсли;
			НовыйРисунок.ГраницаСлева = Истина;
			НайденныйРисунок = НовыйРисунок;
				
			ОбластьРисунка = Таб.Область(ТекОбласть.Верх, ТекОбласть.Лево, ТекОбласть.Верх, (ТекОбласть.Лево ));  // + 1
			НайденныйРисунок.Расшифровка = СтрокаТаблицы.Документ;
			НайденныйРисунок.Защита = Истина;
			НайденныйРисунок.Расположить(ОбластьРисунка);
				
		КонецЦикла; 
			
		Если ОтображатьЗанятостьПомещенийДляТекущегоДня Тогда
				
			// определим колонки для таблицы событий (независимо от диапозона показа)
			ОбщаяШиринаДняДляРаспределенияСобытий = МаксимальноеКоличествоОдновременныхДокументовПоПомещениям;
				
			ШиринаОдногоСобытияВГруппе = Цел(ОбщаяШиринаДняДляРаспределенияСобытий/МаксимальноеКоличествоОдновременныхДокументовПоПомещениям);
				
			Для а = 0 По 47 Цикл
					
				ПоследнийСтолбец = ОбщаяШиринаДня-МаксимальноеКоличествоОдновременныхДокументовПоПомещениям+2;
					
				СписокТекущихДокументов = СписокЗначенийВременПоПомещениям.Получить(а).Значение;
					
				Для каждого ТекДокумент Из СписокТекущихДокументов Цикл
						
					СтрокаТаблицыДокументов = ТаблицаСобытийПоПомещениям.Найти(ТекДокумент.Значение, "Документ");
					Если СтрокаТаблицыДокументов <> Неопределено Тогда
						Если СтрокаТаблицыДокументов.КоличествоОдновременныхДокументов = 1 Тогда
							ШиринаТекущегоДокумента = ОбщаяШиринаДняДляРаспределенияСобытий;
						Иначе
							ШиринаТекущегоДокумента = ШиринаОдногоСобытияВГруппе;
						КонецЕсли;
					Иначе
						ШиринаТекущегоДокумента = 0;
						Продолжить;
					КонецЕсли;
						
					Если СтрокаТаблицыДокументов.НомерНачальнойКолонки = 0 И СтрокаТаблицыДокументов.НомерКонечнойКолонки = 0 Тогда
						СтрокаТаблицыДокументов.НомерНачальнойКолонки = ПоследнийСтолбец + 1;
						СтрокаТаблицыДокументов.НомерКонечнойКолонки = ПоследнийСтолбец + ШиринаТекущегоДокумента;
					КонецЕсли;
						
					ПоследнийСтолбец = СтрокаТаблицыДокументов.НомерНачальнойКолонки - 1 + ШиринаТекущегоДокумента;
						
				КонецЦикла; 
					
			КонецЦикла;   
				
			ИндексСтрокиТаблицы = 0;
			Пока Истина Цикл
					
				Если ИндексСтрокиТаблицы > ТаблицаСобытийПоПомещениям.Количество() - 1 Тогда
					Прервать;
				КонецЕсли; 
					
				СтрокаТаблицы = ТаблицаСобытийПоПомещениям[ИндексСтрокиТаблицы];
					
				Если СтрокаТаблицы.НомерНачальнойКолонки = 0 ИЛИ СтрокаТаблицы.НомерКонечнойКолонки = 0 Тогда
					ТаблицаСобытийПоПомещениям.Удалить(СтрокаТаблицы);
				Иначе
					ИндексСтрокиТаблицы = ИндексСтрокиТаблицы + 1;
				КонецЕсли; 
					
			КонецЦикла; 
				
			Для каждого СтрокаТаблицы Из ТаблицаСобытийПоПомещениям Цикл
					
				ПерваяСтрокаОбласти    = СтрокаТаблицы.НомерНачальнойСтроки-СмещениеОтНачалаПервойЯчейкиДня;
				ПоследняяСтрокаОбласти = СтрокаТаблицы.НомерКонечнойСтроки-СмещениеОтНачалаПервойЯчейкиДня;
				Если ПерваяСтрокаОбласти < 1 Тогда
					Если ПоследняяСтрокаОбласти < 1 Тогда
						Продолжить;
					Иначе
						ПерваяСтрокаОбласти = 1;
					КонецЕсли;
				ИначеЕсли ПерваяСтрокаОбласти > НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня Тогда
					Продолжить;
				КонецЕсли;
					
				Если ПоследняяСтрокаОбласти > НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня Тогда
					ПоследняяСтрокаОбласти = НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня;
				КонецЕсли;
					
				ТекОбласть = Таб.Область(ПерваяСтрокаОбласти, СтрокаТаблицы.НомерНачальнойКолонки, ПоследняяСтрокаОбласти, СтрокаТаблицы.НомерКонечнойКолонки);
					
				ТекстЯчейки = "";
					
				ТекстЯчейки = "" + ТекстЯчейки + Формат(СтрокаТаблицы.ДатаНачалаСобытия, "ДФ=ЧЧ:мм") + " - " + Формат(СтрокаТаблицы.ДатаКонцаСобытия, "ДФ=ЧЧ:мм");
					
				Помещения = "";
				Если ТипЗнч(СтрокаТаблицы.Документ) = Тип("ДокументСсылка.Событие") Тогда
					Помещения = СтрокаТаблицы.Документ.Помещение;
				Иначе
					Для каждого СтрокаПомещение из СтрокаТаблицы.Документ.СписокПомещений Цикл
						Помещения = Помещения + ?(ПустаяСтрока(Помещения),"",", ")+СокрЛП(СтрокаПомещение.Помещение);
					КонецЦикла;
				КонецЕсли; 
					
				Если НЕ ПустаяСтрока(Помещения) Тогда
					Если НЕ ПустаяСтрока(ТекстЯчейки) Тогда
						ТекстЯчейки = ТекстЯчейки + ?((ТекОбласть.Низ - ТекОбласть.Верх + 1) >= 2 , Символы.ПС, ", ");
					КонецЕсли;
					ТекстЯчейки = ТекстЯчейки + СокрЛП(Помещения);
				КонецЕсли; 
					
				ТекОбласть.ГраницаСлева = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная);
				ТекОбласть.ГраницаСправа = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная);
				ТекОбласть.ГраницаСверху = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная);
				ТекОбласть.ГраницаСнизу = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная);
				ТекОбласть.Объединить();
				ТекОбласть.ВертикальноеПоложение = ВертикальноеПоложение.Верх;
				ТекОбласть.ЦветФона = Новый Цвет;
					
				ТекОбласть.Текст = ТекстЯчейки;
				Если (ТекОбласть.Низ - ТекОбласть.Верх + 1) < 2 Тогда
					ТекОбласть.РазмещениеТекста = ТипРазмещенияТекстаТабличногоДокумента.Авто;
				Иначе
					ТекОбласть.РазмещениеТекста = ТипРазмещенияТекстаТабличногоДокумента.Переносить;
				КонецЕсли; 
				ТекОбласть.Заполнение = ТипЗаполненияОбластиТабличногоДокумента.Текст;
				ТекОбласть.ПоВыделеннымКолонкам = Истина;
				ТекОбласть.Расшифровка = СтрокаТаблицы.Документ;
					
				Если СтрокаТаблицы.Важность = Перечисления.Важность.Высокая Тогда
					ТекОбласть.ЦветТекста = WebЦвета.Красный;
				КонецЕсли;
					
				ТекОбласть.ЦветФона = WebЦвета.СветлоЖелтый;
				ТекОбласть.ЦветТекста = WebЦвета.Серый;
					
			КонецЦикла; 
		КонецЕсли;
	КонецЕсли;
		
	// Построим второй день
	Если (НЕ ОтображатьЗаказы) И (КоличествоДнейНаЗакладкеДень = 2) Тогда
			
		ДатаВторогоДня = ДатаКалендаря + 60*60*24;
			
		Если НачалоНедели(ДатаКалендаря) = НачалоНедели(ДатаВторогоДня) Тогда
			ЗначениеРеквизитаДняНедели = ОбработкаОбъект["СобытияНедели_День" + Строка(ДеньНедели(ДатаВторогоДня))];
		Иначе
			// Это может быть только понедельник следующей недели
			ЗначениеРеквизитаДняНедели = ОбработкаОбъект["СобытияНедели_День8"];
		КонецЕсли;
			
		ОбщаяШиринаВторогоДня = ОбщаяШиринаДня;
			
		МаксимальноеКоличествоОдновременныхДокументов = 1;
		МаксимальноеКоличествоОдновременныхДокументовПоПомещениям = 0;
			
		ОтображатьЗанятостьПомещенийДляТекущегоДня = ОтображатьЗанятостьПомещений;
			
		// Определим из событий максимальное количество одновременных документов
		Если ТипЗнч(ЗначениеРеквизитаДняНедели) = Тип("Структура") Тогда
			ТаблицаСобытий = ЗначениеРеквизитаДняНедели.ТаблицаСобытий.Скопировать();
			Если ТаблицаСобытий.Количество()>0 Тогда
				ТаблицаСобытий.Сортировать("КоличествоОдновременныхДокументов УБЫВ");
				МаксимальноеКоличествоОдновременныхДокументов = ТаблицаСобытий[0].КоличествоОдновременныхДокументов;
			КонецЕсли;
				
			// если отображаем помещения
			Если ОтображатьЗанятостьПомещенийДляТекущегоДня Тогда
				ТаблицаСобытийПоПомещениям = ЗначениеРеквизитаДняНедели.ТаблицаСобытийПоПомещениям.Скопировать();
				Если ТаблицаСобытийПоПомещениям.Количество()>0 Тогда
					ТаблицаСобытийПоПомещениям.Сортировать("КоличествоОдновременныхДокументов УБЫВ");
					МаксимальноеКоличествоОдновременныхДокументовПоПомещениям = ТаблицаСобытийПоПомещениям[0].КоличествоОдновременныхДокументов;
				Иначе
					ОтображатьЗанятостьПомещенийДляТекущегоДня = Ложь;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
			
		ОбщаяШиринаКолонокТекущегоДня = ?(ОтображатьЗанятостьПомещенийДляТекущегоДня,Цел(ОбщаяШиринаКолонокДня/2),ОбщаяШиринаКолонокДня);
			
		// каждое событие состоит из двух колонок - под картинку (ширина 2) и под текст (ширина определяется)
		ШиринаВторойЧасти = Цел((ОбщаяШиринаКолонокТекущегоДня - МаксимальноеКоличествоОдновременныхДокументов*2)/МаксимальноеКоличествоОдновременныхДокументов);
			
		// ширина последней колонки должна быть "дотянута" до края
		ШиринаБезПоследнейКолонки = ШиринаВторойЧасти*(МаксимальноеКоличествоОдновременныхДокументов-1) + МаксимальноеКоличествоОдновременныхДокументов*2;
		ШиринаПоследнейКолонки = Макс(0,ОбщаяШиринаКолонокТекущегоДня - ШиринаБезПоследнейКолонки);
			
		Если ОтображатьЗанятостьПомещенийДляТекущегоДня Тогда
			// ширина для помещения
			ШиринаПоПомещениям = Цел((ОбщаяШиринаКолонокДня - ОбщаяШиринаКолонокТекущегоДня)/МаксимальноеКоличествоОдновременныхДокументовПоПомещениям);
				
			// ширина последней колонки должна быть "дотянута" до края
			ШиринаПоследнейКолонкиПоПомещениям = Макс(0,(ОбщаяШиринаКолонокДня - ОбщаяШиринаКолонокТекущегоДня) - ШиринаПоПомещениям*(МаксимальноеКоличествоОдновременныхДокументовПоПомещениям-1));
		КонецЕсли;
			
		// определяем количество колонок в зависимости от количества одновременных документов по событиями и помещениям
		ОбщаяШиринаДняДляРаспределенияСобытий = МаксимальноеКоличествоОдновременныхДокументов*2;
		ОбщаяШиринаВторогоДня = ОбщаяШиринаДняДляРаспределенияСобытий + МаксимальноеКоличествоОдновременныхДокументовПоПомещениям;

			
		ПерваяКолонкаВтрогоДня = ОбщаяШиринаДня+4;
		ПоследняяКолонкаВтрогоДня = ОбщаяШиринаДня+4 + ОбщаяШиринаВторогоДня+1;
		ПоследняяКолонкаВтрогоДняПоСобытиям = ПоследняяКолонкаВтрогоДня - МаксимальноеКоличествоОдновременныхДокументовПоПомещениям;
			
		Таб.ВставитьОбласть(мМакетДня.Область(1+СмещениеОтНачалаПервойЯчейкиДня,1,НомерПоследнейЯчейкиДня,ОбщаяШиринаВторогоДня+2), Таб.Область(1,ПерваяКолонкаВтрогоДня,НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня,ПоследняяКолонкаВтрогоДня));
			
		Таб.Область(,ПерваяКолонкаВтрогоДня,,ПерваяКолонкаВтрогоДня).ШиринаКолонки = 4;
		Таб.Область(,(ПерваяКолонкаВтрогоДня + 1),,(ПерваяКолонкаВтрогоДня + 1)).ШиринаКолонки = 2;
			
		Таб.Область(1,,НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня,).ВысотаСтроки = 11;
			
		СчетКолонок = 1;
		Для а=ПерваяКолонкаВтрогоДня + 2 по ПоследняяКолонкаВтрогоДняПоСобытиям-1 Цикл
			Если СчетКолонок = 1 Тогда
				Таб.Область(,а,,а).ШиринаКолонки = 2;
			Иначе
				Таб.Область(,а,,а).ШиринаКолонки = ШиринаВторойЧасти;
			КонецЕсли;
			СчетКолонок = СчетКолонок + 1;
			СчетКолонок = ?(СчетКолонок>2,1,2);
		КонецЦикла;
		// последняя колонка отдельно
		Таб.Область(,ПоследняяКолонкаВтрогоДняПоСобытиям,,ПоследняяКолонкаВтрогоДняПоСобытиям).ШиринаКолонки = ШиринаПоследнейКолонки;
			
		Если ОтображатьЗанятостьПомещенийДляТекущегоДня Тогда
			Для а=ПоследняяКолонкаВтрогоДняПоСобытиям+1 по ПоследняяКолонкаВтрогоДня-1 Цикл
				Таб.Область(,а,,а).ШиринаКолонки = ШиринаПоПомещениям;
			КонецЦикла;
			// последняя колонка отдельно
			Таб.Область(,ПоследняяКолонкаВтрогоДня,,ПоследняяКолонкаВтрогоДня).ШиринаКолонки = ШиринаПоследнейКолонкиПоПомещениям;
		КонецЕсли;
			
		ЭлементыФормы.НадписьДняВторого.Видимость = Истина;
			
		СтрокаДня = Формат(ДатаВторогоДня, "ДЛФ=DD") + ", " + ОпределитьДеньНедели(ДеньНедели(ДатаВторогоДня));
		ЭлементыФормы.НадписьДняВторого.Значение = СтрокаДня;
			
		СтруктураРабочегоВремени = мОпределитьНачалоИОкончаниеРабочегоДняПользователя(глЗначениеПеременной("глТекущийПользователь"), ДатаВторогоДня);
			
		НачальнаяСтрокаПервогоРабочегоДня = НачальнаяСтрокаРабочегоДня;
		КонечнаяСтрокаПервогоРабочегоДня  = КонечнаяСтрокаРабочегоДня;
			
		ДатаНачалаРабочегоДня    = СтруктураРабочегоВремени.ДатаНачала;
		ДатаОкончанияРабочегоДня = СтруктураРабочегоВремени.ДатаОкончания;
			
		Если ДатаНачалаРабочегоДня = '00010101000000' И ДатаОкончанияРабочегоДня = '00010101235959' Тогда
				
			ОбластьРабочегоДня = Таб.Область(1,(ПерваяКолонкаВтрогоДня + 2),НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня,ПоследняяКолонкаВтрогоДня);
			ОбластьРабочегоДня.ЦветФона = ЦветаСтиля.ЦветФонаКнопки;
			НачальнаяСтрокаРабочегоДня  = Неопределено;
			КонечнаяСтрокаРабочегоДня   = Неопределено;
			Таб.Область(1,ПерваяКолонкаВтрогоДня,НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня,(ПерваяКолонкаВтрогоДня + 1)).ЦветФона = ЦветаСтиля.ЦветФонаКнопки;
				
		Иначе
				
			НачальнаяСтрокаРабочегоДня = УправлениеКонтактами.ВозвратитьНомерСтроки(Формат(ДатаНачалаРабочегоДня,"ДФ=Ч"), Формат(ДатаНачалаРабочегоДня,"ДФ=м"), ДатаКалендаря, Истина, ДатаКалендаря);
			Если Формат(ДатаНачалаРабочегоДня,"ДФ=Ч") = Формат(ДатаОкончанияРабочегоДня,"ДФ=Ч") И Формат(ДатаНачалаРабочегоДня,"ДФ=м") = Формат(ДатаОкончанияРабочегоДня,"ДФ=м") Тогда
				КонечнаяСтрокаРабочегоДня  = НачальнаяСтрокаРабочегоДня;
			Иначе
				КонечнаяСтрокаРабочегоДня = УправлениеКонтактами.ВозвратитьНомерСтроки(Формат(ДатаОкончанияРабочегоДня,"ДФ=Ч"), Формат(ДатаОкончанияРабочегоДня,"ДФ=м"), ДатаКалендаря, Ложь, ДатаКалендаря);
			КонецЕсли; 
				
			ОбластьДоРабочегоДня = Таб.Область(1,(ПерваяКолонкаВтрогоДня + 2),(НачальнаяСтрокаРабочегоДня - 1-СмещениеОтНачалаПервойЯчейкиДня),ПоследняяКолонкаВтрогоДня);
			ОбластьДоРабочегоДня.ЦветФона = ЦветаСтиля.ЦветФонаКнопки;
			ОбластьРабочегоДня = Таб.Область(НачальнаяСтрокаРабочегоДня-СмещениеОтНачалаПервойЯчейкиДня,(ПерваяКолонкаВтрогоДня + 2),КонечнаяСтрокаРабочегоДня-СмещениеОтНачалаПервойЯчейкиДня,ПоследняяКолонкаВтрогоДня);
			ОбластьРабочегоДня.ЦветФона = ЦветаСтиля.ЦветФонаФормы;
			Если КонечнаяСтрокаРабочегоДня < НомерПоследнейЯчейкиДня Тогда
				ОбластьПослеРабочегоДня = Таб.Область((КонечнаяСтрокаРабочегоДня + 1 -СмещениеОтНачалаПервойЯчейкиДня),(ПерваяКолонкаВтрогоДня + 2),НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня,ПоследняяКолонкаВтрогоДня);
				ОбластьПослеРабочегоДня.ЦветФона = ЦветаСтиля.ЦветФонаКнопки;
			КонецЕсли; 
				
			Таб.Область(НачальнаяСтрокаРабочегоДня-СмещениеОтНачалаПервойЯчейкиДня,ПерваяКолонкаВтрогоДня,КонечнаяСтрокаРабочегоДня-СмещениеОтНачалаПервойЯчейкиДня,(ПерваяКолонкаВтрогоДня + 1)).ЦветФона = ЦветаСтиля.ЦветФонаФормы;
				
		КонецЕсли; 
			
		Если НачалоДня(ТекущаяДата()) = НачалоДня(ДатаВторогоДня) Тогда
			ТекущийЧас = Час(ТекущаяДата());
			СтрокаТекущегоЧаса = ТекущийЧас*2+1-СмещениеОтНачалаПервойЯчейкиДня+?(Минута(ТекущаяДата())>29,1,0);
				
			Если СтрокаТекущегоЧаса <= НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня Тогда
				Таб.Область(СтрокаТекущегоЧаса,ПерваяКолонкаВтрогоДня+1,Мин(СтрокаТекущегоЧаса+1,НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня),ПоследняяКолонкаВтрогоДня).ЦветФона = WebЦвета.Бежевый;
			КонецЕсли;
		КонецЕсли;
			
		Для с = 1 По НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня Цикл
				
			ОбластьКартинки = Таб.Область(с,ОбщаяШиринаДня+3,с,ОбщаяШиринаДня+3);
			ОбластьКартинки.ШиринаКолонки = 2;
			ОбластьКартинки.ВысотаСтроки = 11;
				
			РисунокРазделительСтраниц = РисункиТабличногоДокумента.Добавить(ТипРисункаТабличногоДокумента.Картинка);
			Если (КонечнаяСтрокаРабочегоДня = Неопределено И НачальнаяСтрокаРабочегоДня = Неопределено) ИЛИ ((КонечнаяСтрокаПервогоРабочегоДня = Неопределено И НачальнаяСтрокаПервогоРабочегоДня = Неопределено)) Тогда
					
				РисунокРазделительСтраниц.Картинка = мСкрепкиЛистовКалендаряПользователяНеРабочие;
					
				Если с = 1 Тогда
					РисунокРазделительСтраниц.ГраницаСнизу  = Ложь;
					РисунокРазделительСтраниц.ГраницаСверху = Истина;
					РисунокРазделительСтраниц.ЦветЛинии = ЦветаСтиля.ЦветРамки;
				ИначеЕсли с = НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня Тогда
					РисунокРазделительСтраниц.ГраницаСверху = Ложь;
					РисунокРазделительСтраниц.ГраницаСнизу  = Истина;
					РисунокРазделительСтраниц.ЦветЛинии = ЦветаСтиля.ЦветРамки;
				Иначе
					РисунокРазделительСтраниц.ГраницаСверху = Ложь;
					РисунокРазделительСтраниц.ГраницаСнизу  = Ложь;
				КонецЕсли; 
					
			Иначе
					
				Если с < Мин(НачальнаяСтрокаПервогоРабочегоДня-СмещениеОтНачалаПервойЯчейкиДня, НачальнаяСтрокаРабочегоДня-СмещениеОтНачалаПервойЯчейкиДня) ИЛИ с > Макс(КонечнаяСтрокаПервогоРабочегоДня-СмещениеОтНачалаПервойЯчейкиДня, КонечнаяСтрокаРабочегоДня-СмещениеОтНачалаПервойЯчейкиДня) Тогда
					РисунокРазделительСтраниц.Картинка = мСкрепкиЛистовКалендаряПользователяНеРабочие;
				Иначе
					РисунокРазделительСтраниц.Картинка = мСкрепкиЛистовКалендаряПользователяРабочие;
				КонецЕсли; 
					
				Если с = 1+СмещениеОтНачалаПервойЯчейкиДня Тогда
					РисунокРазделительСтраниц.ГраницаСнизу  = Ложь;
					РисунокРазделительСтраниц.ГраницаСверху = Истина;
					РисунокРазделительСтраниц.ЦветЛинии = ЦветаСтиля.ЦветРамки;
				ИначеЕсли с = Мин(НачальнаяСтрокаПервогоРабочегоДня, НачальнаяСтрокаРабочегоДня)-СмещениеОтНачалаПервойЯчейкиДня - 1 ИЛИ с = Макс(КонечнаяСтрокаПервогоРабочегоДня, КонечнаяСтрокаРабочегоДня)-СмещениеОтНачалаПервойЯчейкиДня ИЛИ с = НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня Тогда
					РисунокРазделительСтраниц.ГраницаСверху = Ложь;
					РисунокРазделительСтраниц.ГраницаСнизу  = Истина;
					РисунокРазделительСтраниц.ЦветЛинии = ЦветаСтиля.ЦветРамки;
				Иначе
					РисунокРазделительСтраниц.ГраницаСверху = Ложь;
					РисунокРазделительСтраниц.ГраницаСнизу  = Ложь;
				КонецЕсли; 
					
			КонецЕсли; 
				
			РисунокРазделительСтраниц.ГраницаСправа = Ложь;
			РисунокРазделительСтраниц.ГраницаСлева  = Ложь;
				
			РисунокРазделительСтраниц.Расположить(ОбластьКартинки);
				
		КонецЦикла; 
			
		Если ТипЗнч(ЗначениеРеквизитаДняНедели) = Тип("Структура") Тогда
				
			СписокЗначенийВремен = ЗначениеРеквизитаДняНедели.РасположениеСобытий;
			ТаблицаСобытий       = ЗначениеРеквизитаДняНедели.ТаблицаСобытий.Скопировать();
				
			СписокЗначенийВременПоПомещениям = ЗначениеРеквизитаДняНедели.РасположениеСобытийПоПомещениям;
			ТаблицаСобытийПоПомещениям       = ЗначениеРеквизитаДняНедели.ТаблицаСобытийПоПомещениям.Скопировать();
				
			Если ОтображатьЗанятостьПомещений  И ТаблицаСобытийПоПомещениям.Количество()>0  Тогда
				Таб.Область(1,ПерваяКолонкаВтрогоДня+ОбщаяШиринаДняДляРаспределенияСобытий+1,НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня,ПерваяКолонкаВтрогоДня+ОбщаяШиринаДняДляРаспределенияСобытий+1).ГраницаСправа = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная);
			КонецЕсли;
				
			ШиринаОдногоСобытияВГруппе = Цел(ОбщаяШиринаДняДляРаспределенияСобытий/МаксимальноеКоличествоОдновременныхДокументов);
				
			// определим колонки для таблицы событий (независимо от диапозона показа)
			Для а = 0 По 47 Цикл
					
				ПоследнийСтолбец = 2;
					
				СписокТекущихДокументов = СписокЗначенийВремен.Получить(а).Значение;
					
				Для каждого ТекДокумент Из СписокТекущихДокументов Цикл
						
					СтрокаТаблицыДокументов = ТаблицаСобытий.Найти(ТекДокумент.Значение, "Документ");
					Если СтрокаТаблицыДокументов <> Неопределено Тогда
						Если СтрокаТаблицыДокументов.КоличествоОдновременныхДокументов = 1 Тогда
							ШиринаТекущегоДокумента = ОбщаяШиринаДняДляРаспределенияСобытий;
						Иначе
							ШиринаТекущегоДокумента = ШиринаОдногоСобытияВГруппе;
						КонецЕсли;
					Иначе
						ШиринаТекущегоДокумента = 0;
						Продолжить;
					КонецЕсли;
						
					Если СтрокаТаблицыДокументов.НомерНачальнойКолонки = 0 И СтрокаТаблицыДокументов.НомерКонечнойКолонки = 0 Тогда
						СтрокаТаблицыДокументов.НомерНачальнойКолонки = ПерваяКолонкаВтрогоДня + ПоследнийСтолбец + 1 - 1;
						СтрокаТаблицыДокументов.НомерКонечнойКолонки = ПерваяКолонкаВтрогоДня + ПоследнийСтолбец + ШиринаТекущегоДокумента - 1;
					КонецЕсли;
						
					ПоследнийСтолбец = СтрокаТаблицыДокументов.НомерНачальнойКолонки + ШиринаТекущегоДокумента - ПерваяКолонкаВтрогоДня;
						
				КонецЦикла; 
					
			КонецЦикла;
				
			ИндексСтрокиТаблицы = 0;
			Пока Истина Цикл
					
				Если ИндексСтрокиТаблицы > ТаблицаСобытий.Количество() - 1 Тогда
					Прервать;
				КонецЕсли; 
					
				СтрокаТаблицы = ТаблицаСобытий[ИндексСтрокиТаблицы];
					
				Если СтрокаТаблицы.НомерНачальнойКолонки = 0 ИЛИ СтрокаТаблицы.НомерКонечнойКолонки = 0 Тогда
					ТаблицаСобытий.Удалить(СтрокаТаблицы);
				Иначе
					ИндексСтрокиТаблицы = ИндексСтрокиТаблицы + 1;
				КонецЕсли; 
					
			КонецЦикла; 
				
			Для каждого СтрокаТаблицы Из ТаблицаСобытий Цикл
					
				ПерваяСтрокаОбласти    = СтрокаТаблицы.НомерНачальнойСтроки-СмещениеОтНачалаПервойЯчейкиДня;
				ПоследняяСтрокаОбласти = СтрокаТаблицы.НомерКонечнойСтроки-СмещениеОтНачалаПервойЯчейкиДня;
				Если ПерваяСтрокаОбласти < 1 Тогда
					ВерхняяСтрокаНевидимойОбластиДня = Мин(СтрокаТаблицы.НомерНачальнойСтроки,ВерхняяСтрокаНевидимойОбластиДня);
					УказатьНаличиеНевидимыхСобытий(Таб,РисункиТабличногоДокумента,"Верх",ОбщаяШиринаДня+5); 
					Если ПоследняяСтрокаОбласти < 1 Тогда
						Продолжить;
					Иначе
						ПерваяСтрокаОбласти = 1;
					КонецЕсли;
				ИначеЕсли ПерваяСтрокаОбласти > НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня Тогда
					НижняяСтрокаНевидимойОбластиДня = Макс(СтрокаТаблицы.НомерКонечнойСтроки,НижняяСтрокаНевидимойОбластиДня);
					УказатьНаличиеНевидимыхСобытий(Таб,РисункиТабличногоДокумента,"Низ",ОбщаяШиринаДня+5); 
					Продолжить;
				КонецЕсли;
					
				Если ПоследняяСтрокаОбласти > НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня Тогда
					НижняяСтрокаНевидимойОбластиДня = Макс(СтрокаТаблицы.НомерКонечнойСтроки,НижняяСтрокаНевидимойОбластиДня);
					УказатьНаличиеНевидимыхСобытий(Таб,РисункиТабличногоДокумента,"Низ",ОбщаяШиринаДня+5); 
					ПоследняяСтрокаОбласти = НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня;
				КонецЕсли;
					
				ТекОбласть = Таб.Область(ПерваяСтрокаОбласти, СтрокаТаблицы.НомерНачальнойКолонки, ПоследняяСтрокаОбласти, СтрокаТаблицы.НомерКонечнойКолонки);
					
				ТекстЯчейки = "";
				Если ТипЗнч(СтрокаТаблицы.Документ) = Тип("ДокументСсылка.Событие") Тогда
						
					ТекстЯчейки = "" + ?((ТекОбласть.Низ - ТекОбласть.Верх + 1) > 2 , Символы.ПС, "") + ТекстЯчейки + Формат(СтрокаТаблицы.ДатаНачалаСобытия, "ДФ=ЧЧ:мм") + " - " + Формат(СтрокаТаблицы.ДатаКонцаСобытия, "ДФ=ЧЧ:мм");
					Если ЗначениеЗаполнено(СтрокаТаблицы.КонтактноеЛицо) Тогда
						Если НЕ ПустаяСтрока(ТекстЯчейки) Тогда
							ТекстЯчейки = ТекстЯчейки + ?((ТекОбласть.Низ - ТекОбласть.Верх + 1) > 2 , Символы.ПС, " ");
						КонецЕсли; 
						ТекстЯчейки = ТекстЯчейки + Строка(СтрокаТаблицы.КонтактноеЛицо);
					КонецЕсли;
					Если НЕ ПустаяСтрока(СтрокаТаблицы.ОписаниеСобытия) Тогда
						Если НЕ ПустаяСтрока(ТекстЯчейки) Тогда
							ТекстЯчейки = ТекстЯчейки + ?((ТекОбласть.Низ - ТекОбласть.Верх + 1) >= 2 , Символы.ПС, " ");
						КонецЕсли;
						ТекстЯчейки = ТекстЯчейки + СокрЛП(СтрокаТаблицы.ОписаниеСобытия);
					КонецЕсли; 
						
					Если ПользовательКалендаря.Количество()>1 Тогда
						ТекстЯчейки = ТекстЯчейки + ", "+ СтрокаТаблицы.Документ.Ответственный;
					КонецЕсли;
						
				КонецЕсли; 
					
				Если (ТекОбласть.Право - ТекОбласть.Лево + 1) < 4 Тогда
					ТекстЯчейки = ?((ТекОбласть.Низ - ТекОбласть.Верх + 1) >= 2 , Символы.ПС, "          ") + ТекстЯчейки;
				Иначе
					Если (ТекОбласть.Низ - ТекОбласть.Верх + 1) <= 2 Тогда
						ТекстЯчейки = "     " + ТекстЯчейки;
					КонецЕсли; 
				КонецЕсли; 
					
				ТекОбласть.ГраницаСлева = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная);
				ТекОбласть.ГраницаСправа = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная);
				ТекОбласть.ГраницаСверху = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная);
				ТекОбласть.ГраницаСнизу = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная);
				ТекОбласть.Объединить();
				ТекОбласть.ВертикальноеПоложение = ВертикальноеПоложение.Верх;
				ТекОбласть.ЦветФона = Новый Цвет;
					
				ТекОбласть.Текст = ТекстЯчейки;
				Если (ТекОбласть.Низ - ТекОбласть.Верх + 1) < 2 Тогда
					ТекОбласть.РазмещениеТекста = ТипРазмещенияТекстаТабличногоДокумента.Авто;
				Иначе
					ТекОбласть.РазмещениеТекста = ТипРазмещенияТекстаТабличногоДокумента.Переносить;
				КонецЕсли; 
				ТекОбласть.Заполнение = ТипЗаполненияОбластиТабличногоДокумента.Текст;
				ТекОбласть.ПоВыделеннымКолонкам = Истина;
				ТекОбласть.Расшифровка = СтрокаТаблицы.Документ;
					
				Если СтрокаТаблицы.Важность = Перечисления.Важность.Высокая Тогда
					ТекОбласть.ЦветТекста = WebЦвета.Красный;
				КонецЕсли;
				Если СтрокаТаблицы.СостояниеСобытия <> Перечисления.СостоянияСобытий.Запланировано Тогда
					ТекОбласть.ЦветФона = WebЦвета.Перламутровый;
					ТекОбласть.ЦветТекста = WebЦвета.Серый;
				КонецЕсли; 
					
				// Отобразим вид с типом события
					
				КартинкаВидаСобытия = ОпределитьКартинку(СтрокаТаблицы.ВидСобытия,СтрокаТаблицы.ТипСобытия);
				НовыйРисунок = РисункиТабличногоДокумента.Добавить(ТипРисункаТабличногоДокумента.Картинка);
				НовыйРисунок.Картинка = КартинкаВидаСобытия;
				НовыйРисунок.ЦветЛинии = ЦветаСтиля.ЦветРамки;
				Если СтрокаТаблицы.СостояниеСобытия <> Перечисления.СостоянияСобытий.Запланировано Тогда
					НовыйРисунок.ЦветФона = WebЦвета.Перламутровый;
				КонецЕсли;
				НовыйРисунок.ГраницаСверху = Истина;
				Если (ТекОбласть.Низ - ТекОбласть.Верх + 1) < 2 Тогда
					НовыйРисунок.ГраницаСнизу = Истина;
				Иначе
					НовыйРисунок.ГраницаСнизу = Ложь;
				КонецЕсли;
				НовыйРисунок.ГраницаСлева = Истина;
				Если ШиринаВторойЧасти = 0 Тогда
					НовыйРисунок.ГраницаСправа = Истина;;
				Иначе
					НовыйРисунок.ГраницаСправа = Ложь;
				КонецЕсли;
					
				НайденныйРисунок = НовыйРисунок;
					
				ОбластьРисунка = Таб.Область(ТекОбласть.Верх, ТекОбласть.Лево, ТекОбласть.Верх, (ТекОбласть.Лево));
				НайденныйРисунок.Расшифровка = СтрокаТаблицы.Документ;
				НайденныйРисунок.Защита = Истина;
				НайденныйРисунок.Расположить(ОбластьРисунка);
					
			КонецЦикла; 
				
		КонецЕсли;
			
			
		Если ОтображатьЗанятостьПомещений И ТаблицаСобытийПоПомещениям.Количество()>0  Тогда
				
			// определим колонки для таблицы событий (независимо от диапозона показа)
			ОбщаяШиринаДняДляРаспределенияСобытий = МаксимальноеКоличествоОдновременныхДокументовПоПомещениям;
				
			ШиринаОдногоСобытияВГруппе = Цел(ОбщаяШиринаДняДляРаспределенияСобытий/МаксимальноеКоличествоОдновременныхДокументовПоПомещениям);
				
			Для а = 0 По 47 Цикл
					
				ПоследнийСтолбец = ОбщаяШиринаВторогоДня-МаксимальноеКоличествоОдновременныхДокументовПоПомещениям+2;
					
				СписокТекущихДокументов = СписокЗначенийВременПоПомещениям.Получить(а).Значение;
					
				Для каждого ТекДокумент Из СписокТекущихДокументов Цикл
						
					СтрокаТаблицыДокументов = ТаблицаСобытийПоПомещениям.Найти(ТекДокумент.Значение, "Документ");
					Если СтрокаТаблицыДокументов <> Неопределено Тогда
						Если СтрокаТаблицыДокументов.КоличествоОдновременныхДокументов = 1 Тогда
							ШиринаТекущегоДокумента = ОбщаяШиринаДняДляРаспределенияСобытий;
						Иначе
							ШиринаТекущегоДокумента = ШиринаОдногоСобытияВГруппе;
						КонецЕсли;
					Иначе
						ШиринаТекущегоДокумента = 0;
						Продолжить;
					КонецЕсли;
						
					Если СтрокаТаблицыДокументов.НомерНачальнойКолонки = 0 И СтрокаТаблицыДокументов.НомерКонечнойКолонки = 0 Тогда
						СтрокаТаблицыДокументов.НомерНачальнойКолонки = ПерваяКолонкаВтрогоДня + ПоследнийСтолбец + 1 - 1;
						СтрокаТаблицыДокументов.НомерКонечнойКолонки = ПерваяКолонкаВтрогоДня + ПоследнийСтолбец + ШиринаТекущегоДокумента - 1;
					КонецЕсли;
						
					ПоследнийСтолбец = СтрокаТаблицыДокументов.НомерНачальнойКолонки + ШиринаТекущегоДокумента - ПерваяКолонкаВтрогоДня;
						
				КонецЦикла; 
					
			КонецЦикла;   
				
			ИндексСтрокиТаблицы = 0;
			Пока Истина Цикл
					
				Если ИндексСтрокиТаблицы > ТаблицаСобытийПоПомещениям.Количество() - 1 Тогда
					Прервать;
				КонецЕсли; 
					
				СтрокаТаблицы = ТаблицаСобытийПоПомещениям[ИндексСтрокиТаблицы];
					
				Если СтрокаТаблицы.НомерНачальнойКолонки = 0 ИЛИ СтрокаТаблицы.НомерКонечнойКолонки = 0 Тогда
					ТаблицаСобытийПоПомещениям.Удалить(СтрокаТаблицы);
				Иначе
					ИндексСтрокиТаблицы = ИндексСтрокиТаблицы + 1;
				КонецЕсли; 
					
			КонецЦикла; 
				
			Для каждого СтрокаТаблицы Из ТаблицаСобытийПоПомещениям Цикл
					
				ПерваяСтрокаОбласти    = СтрокаТаблицы.НомерНачальнойСтроки-СмещениеОтНачалаПервойЯчейкиДня;
				ПоследняяСтрокаОбласти = СтрокаТаблицы.НомерКонечнойСтроки-СмещениеОтНачалаПервойЯчейкиДня;
				Если ПерваяСтрокаОбласти < 1 Тогда
					Если ПоследняяСтрокаОбласти < 1 Тогда
						Продолжить;
					Иначе
						ПерваяСтрокаОбласти = 1;
					КонецЕсли;
				ИначеЕсли ПерваяСтрокаОбласти > НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня Тогда
					Продолжить;
				КонецЕсли;
					
				Если ПоследняяСтрокаОбласти > НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня Тогда
					ПоследняяСтрокаОбласти = НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня;
				КонецЕсли;
					
				ТекОбласть = Таб.Область(ПерваяСтрокаОбласти, СтрокаТаблицы.НомерНачальнойКолонки, ПоследняяСтрокаОбласти, СтрокаТаблицы.НомерКонечнойКолонки);
					
				ТекстЯчейки = "";
					
				ТекстЯчейки = "" + ТекстЯчейки + Формат(СтрокаТаблицы.ДатаНачалаСобытия, "ДФ=ЧЧ:мм") + " - " + Формат(СтрокаТаблицы.ДатаКонцаСобытия, "ДФ=ЧЧ:мм");
					
				Помещения = "";
				Если ТипЗнч(СтрокаТаблицы.Документ) = Тип("ДокументСсылка.Событие") Тогда
					Помещения = СтрокаТаблицы.Документ.Помещение;
				Иначе
					Для каждого СтрокаПомещение из СтрокаТаблицы.Документ.СписокПомещений Цикл
						Помещения = Помещения + ?(ПустаяСтрока(Помещения),"",", ")+СокрЛП(СтрокаПомещение.Помещение);
					КонецЦикла;
				КонецЕсли; 
					
				Если НЕ ПустаяСтрока(Помещения) Тогда
					Если НЕ ПустаяСтрока(ТекстЯчейки) Тогда
						ТекстЯчейки = ТекстЯчейки + ?((ТекОбласть.Низ - ТекОбласть.Верх + 1) >= 2 , Символы.ПС, ", ");
					КонецЕсли;
					ТекстЯчейки = ТекстЯчейки + СокрЛП(Помещения);
				КонецЕсли; 
					
				ТекОбласть.ГраницаСлева = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная);
				ТекОбласть.ГраницаСправа = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная);
				ТекОбласть.ГраницаСверху = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная);
				ТекОбласть.ГраницаСнизу = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная);
				ТекОбласть.Объединить();
				ТекОбласть.ВертикальноеПоложение = ВертикальноеПоложение.Верх;
				ТекОбласть.ЦветФона = Новый Цвет;
					
				ТекОбласть.Текст = ТекстЯчейки;
				Если (ТекОбласть.Низ - ТекОбласть.Верх + 1) < 2 Тогда
					ТекОбласть.РазмещениеТекста = ТипРазмещенияТекстаТабличногоДокумента.Авто;
				Иначе
					ТекОбласть.РазмещениеТекста = ТипРазмещенияТекстаТабличногоДокумента.Переносить;
				КонецЕсли; 
				ТекОбласть.Заполнение = ТипЗаполненияОбластиТабличногоДокумента.Текст;
				ТекОбласть.ПоВыделеннымКолонкам = Истина;
				ТекОбласть.Расшифровка = СтрокаТаблицы.Документ;
					
				Если СтрокаТаблицы.Важность = Перечисления.Важность.Высокая Тогда
					ТекОбласть.ЦветТекста = WebЦвета.Красный;
				КонецЕсли;
					
				ТекОбласть.ЦветФона = WebЦвета.СветлоЖелтый;
				ТекОбласть.ЦветТекста = WebЦвета.Серый;
					
			КонецЦикла; 
				
		КонецЕсли;
			
	Иначе
		ЭлементыФормы.НадписьДняВторого.Видимость = Ложь;
		ОбщаяШиринаВторогоДня = 0;
	КонецЕсли;
		
	Если (НЕ ОтображатьЗаказы) И (КоличествоДнейНаЗакладкеДень = 2) Тогда
		Таб.ФиксацияСлева = ОбщаяШиринаДня + ОбщаяШиринаВторогоДня + КоличествоДнейНаЗакладкеДень*2 + КоличествоДнейНаЗакладкеДень - 1;
	Иначе
		Таб.ФиксацияСлева = ОбщаяШиринаДня + КоличествоДнейНаЗакладкеДень*2;
	КонецЕсли;
	
	Таб.ТолькоПросмотр = Истина;
	Таб.Показать();
	
КонецПроцедуры

// Процедура заполняет данными поле табличного документа ПолеТабличногоДокументаНеделя.
//
// Параметры
//  НЕТ
//
// Возвращаемое значение
//  НЕТ
Процедура ЗаполнитьТаблицуНедели()
	
	мВыполняетсяОбновлениеОтображения = Истина;
	Состояние("Заполняется таблица недели ...");
	
	Таб = ЭлементыФормы.ПолеТабличногоДокументаНеделя;
	Таб.Очистить();
	
	ШиринаТабличногоПоляНедели = Таб.Ширина;
	
	ОбшаяШиринаНедели = Цел(148*((ШиринаТабличногоПоляНедели-56)/(1094-56)));
	
	Таб.УдалитьОбласть(Таб.Область(1,2,1,));
	Таб.УдалитьОбласть(Таб.Область(2,1,2,1));
	Таб.УдалитьОбласть(Таб.Область(3,1,,));
	
	МакетДня = ПолучитьМакет("МакетНеделя");
	Таб.ВставитьОбласть(МакетДня.Область(3+СмещениеОтНачалаПервойЯчейкиДня,1,НомерПоследнейЯчейкиНедели+СмещениеОтНачалаПервойЯчейкиДня,(ОбшаяШиринаНедели+2)), Таб.Область(3,1,НомерПоследнейЯчейкиНедели,(ОбшаяШиринаНедели+2)));
	Таб.ВставитьОбласть(МакетДня.Область(1,1,2,2), Таб.Область(1,1,2,2));
	
	Таб.Область(1,,НомерПоследнейЯчейкиНедели,).Видимость = Истина;
	Таб.Область(НомерПоследнейЯчейкиНедели+1,,51,).Видимость = Ложь;
	
	Таб.Область(,1,,1).ШиринаКолонки = 4;
	Таб.Область(,2,,2).ШиринаКолонки = 2;
	Таб.Область(,3,,(ОбшаяШиринаНедели+2)).ШиринаКолонки = 1;
	Таб.Область(3,,НомерПоследнейЯчейкиНедели,).ВысотаСтроки = 11;
	
	Таб.Область(1,,1,).ВысотаСтроки = 20;
	Таб.Область(2,,2,).ВысотаСтроки = 50;
	
	Таб.Область(1,1,НомерПоследнейЯчейкиНедели,2).ЦветФона = ЦветаСтиля.ЦветФонаКнопки;
	
	ШиринаКолонки = Цел(ОбшаяШиринаНедели/КоличествоДнейНедели);
	ШиринаКолонки = ШиринаКолонки + ?(ОбшаяШиринаНедели - ШиринаКолонки*КоличествоДнейНедели > КоличествоДнейНедели/2,1,0);
	
	ТаблицаТаблицСделок = Новый ТаблицаЗначений;
	ТаблицаТаблицСделок.Колонки.Добавить("ДатаНедели");
	ТаблицаТаблицСделок.Колонки.Добавить("ТаблицаСделок");
	ТаблицаТаблицСделок.Колонки.Добавить("ТаблицаСобытий");
	ТаблицаТаблицСделок.Колонки.Добавить("НомерСтрокиНачало");
	ТаблицаТаблицСделок.Колонки.Добавить("НомерСтрокиКонец");
	
	ШаблонТаблицаСделок = Новый ТаблицаЗначений;
	ШаблонТаблицаСделок.Колонки.Добавить("Документ");
	ШаблонТаблицаСделок.Колонки.Добавить("Контрагент",,"Покупатель");
	ШаблонТаблицаСделок.Колонки.Добавить("ВидДокументаЗаказа");
	
	
	Для а = 1 По 7 Цикл
		ТекущийГрид = ЭлементыФормы.Найти("_ТЗСделок" + СокрЛП(Строка(а)));
		Если Не ТекущийГрид = Неопределено Тогда
			ЭлементыФормы.Удалить(ТекущийГрид);
		КонецЕсли;
	КонецЦикла; 
	
	Для а = 1 По КоличествоДнейНедели Цикл
		
		РазницаДней = а - ДеньНедели(ДатаКалендаря);
		ТекущаяДата = НачалоДня(ДатаКалендаря + РазницаДней*60*60*24);
		
		НоваяСтрока = ТаблицаТаблицСделок.Добавить();
		НоваяСтрока.ДатаНедели = ТекущаяДата;
		НоваяСтрока.ТаблицаСделок = ШаблонТаблицаСделок.Скопировать();
		
		ЗначениеРеквизитаДняНедели = ОбработкаОбъект["СобытияНедели_День" + Строка(а)];
		Если ТипЗнч(ЗначениеРеквизитаДняНедели) = Тип("Структура") Тогда
			НоваяСтрока.ТаблицаСобытий = ЗначениеРеквизитаДняНедели.ТаблицаСобытий.Скопировать();
		Иначе
			НоваяСтрока.ТаблицаСобытий = Неопределено;
		КонецЕсли; 
		
	КонецЦикла;
	
	Если ОтображатьЗаказы Тогда
		СобратьСделкиДня(ТаблицаТаблицСделок);
		Таб.Область(2,,2,).Видимость = Истина;
	Иначе
		Таб.Область(2,,2,).Видимость = Ложь;
	КонецЕсли; 
	
	мТаблицаЯчеекИДатНедели = Новый ТаблицаЗначений;
	мТаблицаЯчеекИДатНедели.Колонки.Добавить("ДатаНедели");
	мТаблицаЯчеекИДатНедели.Колонки.Добавить("НомерНачальнойЯчейки");
	мТаблицаЯчеекИДатНедели.Колонки.Добавить("НомерКонечнойЯчейки");
	
	ВерхняяСтрокаНевидимойОбластиНедели = 1+СмещениеОтНачалаПервойЯчейкиДня;
	НижняяСтрокаНевидимойОбластиНедели  = НомерПоследнейЯчейкиНедели+СмещениеОтНачалаПервойЯчейкиДня-2;
	
	Для а = 1 По КоличествоДнейНедели Цикл
		
		Состояние("Заполняется таблица недели, " + СокрЛП(ОпределитьДеньНедели(а)));
		
		Если а = КоличествоДнейНедели Тогда
			Если а*ШиринаКолонки < ОбшаяШиринаНедели Тогда
				НачальноеЗначениеКолонки = (а*ШиринаКолонки + 2 - ШиринаКолонки + 1);
				КонечноеЗначениеКолонки = (а*ШиринаКолонки + 2 + (ОбшаяШиринаНедели - а*ШиринаКолонки));
			Иначе
				НачальноеЗначениеКолонки = (а*ШиринаКолонки + 2 - ШиринаКолонки + 1);
				КонечноеЗначениеКолонки = ОбшаяШиринаНедели+2;
			КонецЕсли;
		Иначе
			НачальноеЗначениеКолонки = (а*ШиринаКолонки + 2 - ШиринаКолонки + 1);
			КонечноеЗначениеКолонки = (а*ШиринаКолонки + 2);
		КонецЕсли; 
		
		ОбластьНаименованияДняНедели = Таб.Область(1,НачальноеЗначениеКолонки,1,КонечноеЗначениеКолонки);
		ОбластьНаименованияДняНедели.Объединить();
		
		РазницаДней = а - ДеньНедели(ДатаКалендаря);
		ТекущаяДата = НачалоДня(ДатаКалендаря + РазницаДней*60*60*24);
		
		СтрокаДатыНедели = мТаблицаЯчеекИДатНедели.Добавить();
		СтрокаДатыНедели.ДатаНедели = ТекущаяДата;
		СтрокаДатыНедели.НомерНачальнойЯчейки = НачальноеЗначениеКолонки;
		СтрокаДатыНедели.НомерКонечнойЯчейки = КонечноеЗначениеКолонки;
		
		ОбластьДняНедели = Таб.Область(1,НачальноеЗначениеКолонки,1,КонечноеЗначениеКолонки);
		ОбластьДняНедели.Текст = ОпределитьДеньНедели(а) + Символы.ПС + Формат(ТекущаяДата,"ДФ='d MMMM'");
		ОбластьДняНедели.Шрифт = Новый Шрифт(,9,Ложь);
		ОбластьДняНедели.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Центр;
		ОбластьДняНедели.ВертикальноеПоложение = ВертикальноеПоложение.Центр;
		ОбластьДняНедели.РазмещениеТекста = ТипРазмещенияТекстаТабличногоДокумента.Авто;
		ОбластьДняНедели.Заполнение = ТипЗаполненияОбластиТабличногоДокумента.Текст;
		ОбластьДняНедели.Расшифровка = ТекущаяДата;
		ОбластьДняНедели.ГиперСсылка = Истина;
		
		ОбластьДняНедели.ГраницаСверху = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная, 1);
		ОбластьДняНедели.ГраницаСнизу = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная, 1);
		ОбластьДняНедели.ГраницаСлева = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная, 1);
		ОбластьДняНедели.ГраницаСправа = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная, 1);
		
		ОбластьДняНедели.ЦветРамки = ЦветаСтиля.ЦветРамки;
		ОбластьДняНедели.ЦветТекста = ЦветаСтиля.ЦветРамки;
		
		Если ОтображатьЗаказы Тогда
			
			ОбластьСделокДня = Таб.Область(2,НачальноеЗначениеКолонки,2,КонечноеЗначениеКолонки);
			ОбластьСделокДня.Объединить();
			ЭлементТЗСделок = ЭлементыФормы.Добавить(Тип("ТабличноеПоле"),"_ТЗСделок" + Строка(а), Ложь, Таб);
			
			ЭлементТЗСделок.Расположить(ОбластьСделокДня);
			ЭлементТЗСделок.ВстроенВЯчейку = Истина;
			
			ЭлементТЗСделок.Значение = ТаблицаТаблицСделок[а-1].ТаблицаСделок;
			ЭлементТЗСделок.СоздатьКолонки();
			ЭлементТЗСделок.Колонки.Документ.Видимость = Ложь;
			ЭлементТЗСделок.Колонки.ВидДокументаЗаказа.Видимость = Ложь;
			ЭлементТЗСделок.Колонки.Контрагент.КартинкиСтрок = БиблиотекаКартинок.ВидыСобытий;
			ЭлементТЗСделок.Колонки.Контрагент.Ширина = 5;
			ЭлементТЗСделок.Колонки.Контрагент.ГоризонтальноеПоложениеВШапке = ГоризонтальноеПоложение.Центр;
			
			ЭлементТЗСделок.РазрешитьПеретаскивание = Истина;
			ЭлементТЗСделок.ИзменятьСоставСтрок     = Ложь;
			ЭлементТЗСделок.ТолькоПросмотр          = Ложь;
			ЭлементТЗСделок.УстановитьДействие("ПередНачаломИзменения", Новый Действие("ТЗСделокПередНачаломИзменения"));
			ЭлементТЗСделок.УстановитьДействие("ПриВыводеСтроки", Новый Действие("ТЗСделокПриВыводеСтроки"));
			
			ЭлементТЗСделок.Видимость = Истина;
			
			ОбластьСделокДня.ЦветРамки = ЦветаСтиля.ЦветРамки;
			ОбластьСделокДня.ГраницаСверху = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная, 1);
			ОбластьСделокДня.ГраницаСнизу = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная, 1);
			ОбластьСделокДня.ГраницаСлева = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная, 1);
			ОбластьСделокДня.ГраницаСправа = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная, 1);
			
		КонецЕсли;
		
		// Выведем события
		
		СтруктураРабочегоВремени = мОпределитьНачалоИОкончаниеРабочегоДняПользователя(глЗначениеПеременной("глТекущийПользователь"), ТекущаяДата);
		
		ДатаНачалаРабочегоДня    = СтруктураРабочегоВремени.ДатаНачала;
		ДатаОкончанияРабочегоДня = СтруктураРабочегоВремени.ДатаОкончания;
		
		Если ДатаНачалаРабочегоДня = '00010101000000' И ДатаОкончанияРабочегоДня = '00010101235959' Тогда
			
			ОбластьРабочегоДня = Таб.Область(3,НачальноеЗначениеКолонки,НомерПоследнейЯчейкиНедели,КонечноеЗначениеКолонки);
			ОбластьРабочегоДня.ЦветФона = ЦветаСтиля.ЦветФонаКнопки;
			
		Иначе
			
			НачальнаяСтрокаРабочегоДня = УправлениеКонтактами.ВозвратитьНомерСтроки(Формат(ДатаНачалаРабочегоДня,"ДФ=Ч"), Формат(ДатаНачалаРабочегоДня,"ДФ=м"), ДатаКалендаря, Истина, ДатаКалендаря)+2;
			Если Формат(ДатаНачалаРабочегоДня,"ДФ=Ч") = Формат(ДатаОкончанияРабочегоДня,"ДФ=Ч") И Формат(ДатаНачалаРабочегоДня,"ДФ=м") = Формат(ДатаОкончанияРабочегоДня,"ДФ=м") Тогда
				КонечнаяСтрокаРабочегоДня  = НачальнаяСтрокаРабочегоДня;
			Иначе
				КонечнаяСтрокаРабочегоДня = УправлениеКонтактами.ВозвратитьНомерСтроки(Формат(ДатаОкончанияРабочегоДня,"ДФ=Ч"), Формат(ДатаОкончанияРабочегоДня,"ДФ=м"), ДатаКалендаря, Ложь, ДатаКалендаря)+2;
			КонецЕсли; 
			
			ОбластьДоРабочегоДня = Таб.Область(3,НачальноеЗначениеКолонки,(НачальнаяСтрокаРабочегоДня - 1)-СмещениеОтНачалаПервойЯчейкиДня,КонечноеЗначениеКолонки);
			ОбластьДоРабочегоДня.ЦветФона = ЦветаСтиля.ЦветФонаКнопки;
			
			ОбластьРабочегоДня = Таб.Область(НачальнаяСтрокаРабочегоДня-СмещениеОтНачалаПервойЯчейкиДня,НачальноеЗначениеКолонки,КонечнаяСтрокаРабочегоДня-СмещениеОтНачалаПервойЯчейкиДня,КонечноеЗначениеКолонки);
			ОбластьРабочегоДня.ЦветФона = ЦветаСтиля.ЦветФонаФормы;
			
			Если КонечнаяСтрокаРабочегоДня < НомерПоследнейЯчейкиНедели+СмещениеОтНачалаПервойЯчейкиДня Тогда
				ОбластьПослеРабочегоДня = Таб.Область((КонечнаяСтрокаРабочегоДня + 1)-СмещениеОтНачалаПервойЯчейкиДня,НачальноеЗначениеКолонки,НомерПоследнейЯчейкиНедели,КонечноеЗначениеКолонки);
				ОбластьПослеРабочегоДня.ЦветФона = ЦветаСтиля.ЦветФонаКнопки;
			КонецЕсли; 
			
		КонецЕсли; 
		
		ОбластьДоРабочегоДняПоследняяКолонка = Таб.Область(3,КонечноеЗначениеКолонки,НомерПоследнейЯчейкиНедели,КонечноеЗначениеКолонки);
		ОбластьДоРабочегоДняПоследняяКолонка.ГраницаСправа = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная);
		
		РисункиТабличногоДокумента = Таб.Рисунки;
		
		ЗначениеРеквизитаДняНедели = ОбработкаОбъект["СобытияНедели_День" + Строка(а)];
		Если ТипЗнч(ЗначениеРеквизитаДняНедели) = Тип("Структура") Тогда
			
			СписокЗначенийВремен = ЗначениеРеквизитаДняНедели.РасположениеСобытий;
			ТаблицаСобытий       = ТаблицаТаблицСделок[а-1].ТаблицаСобытий;
			
			ОбщееКоличествоЯчеек = КонечноеЗначениеКолонки - НачальноеЗначениеКолонки + 1;
			
			// определим колонки для таблицы событий (независимо от диапозона показа)
			Для я = 0 По 47 Цикл
				
				ПоследнийСтолбец = НачальноеЗначениеКолонки - 1;
				
				СписокТекущихДокументов = СписокЗначенийВремен.Получить(я).Значение;
				
				Для каждого ТекДокумент Из СписокТекущихДокументов Цикл
					
					СтрокаТаблицыДокументов = ТаблицаСобытий.Найти(ТекДокумент.Значение, "Документ");
					Если СтрокаТаблицыДокументов <> Неопределено Тогда
						ШиринаТекущегоДокумента = Цел(ОбщееКоличествоЯчеек/СтрокаТаблицыДокументов.КоличествоОдновременныхДокументов);
					Иначе
						ШиринаТекущегоДокумента = 0;
						Продолжить;
					КонецЕсли;
					
					Если (ПоследнийСтолбец + ШиринаТекущегоДокумента) = (ОбщееКоличествоЯчеек + 1) Тогда
						ШиринаТекущегоДокумента = ШиринаТекущегоДокумента + 1;
					ИначеЕсли (ПоследнийСтолбец + ШиринаТекущегоДокумента) = (ОбщееКоличествоЯчеек) Тогда
						ШиринаТекущегоДокумента = ШиринаТекущегоДокумента + 2;
					КонецЕсли; 
					
					Если ШиринаТекущегоДокумента < 1 Тогда
						ШиринаТекущегоДокумента = 1;
					КонецЕсли; 
					
					Если СтрокаТаблицыДокументов.НомерНачальнойКолонки = 0 И СтрокаТаблицыДокументов.НомерКонечнойКолонки = 0 Тогда
						СтрокаТаблицыДокументов.НомерНачальнойКолонки = ПоследнийСтолбец + 1;
						СтрокаТаблицыДокументов.НомерКонечнойКолонки = ПоследнийСтолбец + ШиринаТекущегоДокумента;
					КонецЕсли;
					
					ПоследнийСтолбец = СтрокаТаблицыДокументов.НомерНачальнойКолонки - 1 + ШиринаТекущегоДокумента;
					
				КонецЦикла; 
				
			КонецЦикла;
			
			ИндексСтрокиТаблицы = 0;
			Пока Истина Цикл
				
				Если ИндексСтрокиТаблицы > ТаблицаСобытий.Количество() - 1 Тогда
					Прервать;
				КонецЕсли; 
				
				СтрокаТаблицы = ТаблицаСобытий[ИндексСтрокиТаблицы];
				
				Если СтрокаТаблицы.НомерНачальнойКолонки = 0 ИЛИ СтрокаТаблицы.НомерКонечнойКолонки = 0 Тогда
					ТаблицаСобытий.Удалить(СтрокаТаблицы);
				Иначе
					ИндексСтрокиТаблицы = ИндексСтрокиТаблицы + 1;
				КонецЕсли; 
				
			КонецЦикла; 
			
			ТаблицаСобытий.Сортировать("НомерКонечнойКолонки ВОЗР");
			
			Для каждого СтрокаТаблицы Из ТаблицаСобытий Цикл
				
				Если СтрокаТаблицы.НомерКонечнойКолонки > КонечноеЗначениеКолонки Тогда
					Прервать;
				КонецЕсли; 
				
				Если (СтрокаТаблицы.НомерНачальнойСтроки + СтрокаТаблицы.НомерНачальнойКолонки + СтрокаТаблицы.НомерКонечнойСтроки + СтрокаТаблицы.НомерКонечнойКолонки) = 0 Тогда
					Продолжить;
				КонецЕсли; 
				
				ПерваяСтрокаОбласти    = (СтрокаТаблицы.НомерНачальнойСтроки + 2)-СмещениеОтНачалаПервойЯчейкиДня;
				ПоследняяСтрокаОбласти = (СтрокаТаблицы.НомерКонечнойСтроки + 2)-СмещениеОтНачалаПервойЯчейкиДня;
				Если ПерваяСтрокаОбласти < 3 Тогда
					ВерхняяСтрокаНевидимойОбластиНедели = Мин(СтрокаТаблицы.НомерНачальнойСтроки,ВерхняяСтрокаНевидимойОбластиНедели);
					УказатьНаличиеНевидимыхСобытий(Таб,РисункиТабличногоДокумента,"Верх",2,2,НачальноеЗначениеКолонки,КонечноеЗначениеКолонки); 
					Если ПоследняяСтрокаОбласти < 3 Тогда
						Продолжить;
					Иначе
						ПерваяСтрокаОбласти = 3;
					КонецЕсли;
				ИначеЕсли ПерваяСтрокаОбласти > НомерПоследнейЯчейкиНедели Тогда
					НижняяСтрокаНевидимойОбластиНедели = Макс(СтрокаТаблицы.НомерКонечнойСтроки,НижняяСтрокаНевидимойОбластиНедели);
					УказатьНаличиеНевидимыхСобытий(Таб,РисункиТабличногоДокумента,"Низ",2,2,НачальноеЗначениеКолонки,КонечноеЗначениеКолонки); 
					Продолжить;
				КонецЕсли;
				
				Если ПоследняяСтрокаОбласти > НомерПоследнейЯчейкиНедели Тогда
					НижняяСтрокаНевидимойОбластиНедели = Макс(СтрокаТаблицы.НомерКонечнойСтроки,НижняяСтрокаНевидимойОбластиНедели);
					УказатьНаличиеНевидимыхСобытий(Таб,РисункиТабличногоДокумента,"Низ",2,2,НачальноеЗначениеКолонки,КонечноеЗначениеКолонки);  
					ПоследняяСтрокаОбласти = НомерПоследнейЯчейкиНедели;
				КонецЕсли;
				
				ТекОбласть = Таб.Область(ПерваяСтрокаОбласти, СтрокаТаблицы.НомерНачальнойКолонки, ПоследняяСтрокаОбласти, СтрокаТаблицы.НомерКонечнойКолонки);
				
				ТекстЯчейки = "";
				Если ТипЗнч(СтрокаТаблицы.Документ) = Тип("ДокументСсылка.Событие") Тогда
					
					ТекстЯчейки = ТекстЯчейки + Формат(СтрокаТаблицы.ДатаНачалаСобытия, "ДФ=ЧЧ:мм") + " - " + Формат(СтрокаТаблицы.ДатаКонцаСобытия, "ДФ=ЧЧ:мм");
					Если ЗначениеЗаполнено(СтрокаТаблицы.КонтактноеЛицо) Тогда
						Если НЕ ПустаяСтрока(ТекстЯчейки) Тогда
							ТекстЯчейки = ТекстЯчейки + Символы.ПС;
						КонецЕсли; 
						ТекстЯчейки = ТекстЯчейки + Строка(СтрокаТаблицы.КонтактноеЛицо);
					КонецЕсли;
					Если НЕ ПустаяСтрока(СтрокаТаблицы.ОписаниеСобытия) Тогда
						Если НЕ ПустаяСтрока(ТекстЯчейки) Тогда
							ТекстЯчейки = ТекстЯчейки + Символы.ПС;
						КонецЕсли;
						ТекстЯчейки = ТекстЯчейки + СокрЛП(СтрокаТаблицы.ОписаниеСобытия);
					КонецЕсли; 
					
					Если ПользовательКалендаря.Количество()>1 Тогда
						ТекстЯчейки = ТекстЯчейки + ", "+ СтрокаТаблицы.Документ.Ответственный;
					КонецЕсли;
					
				КонецЕсли; 
				
				ТекОбласть.ГраницаСлева = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная, 2);
				ТекОбласть.ГраницаСправа = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная, 2);
				ТекОбласть.ГраницаСверху = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная, 2);
				ТекОбласть.ГраницаСнизу = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная, 2);
				ТекОбласть.Объединить();
				ТекОбласть.ВертикальноеПоложение = ВертикальноеПоложение.Верх;
				ТекОбласть.ЦветФона = Новый Цвет;
				
				ТекОбласть.Текст = ТекстЯчейки;
				ТекОбласть.РазмещениеТекста = ТипРазмещенияТекстаТабличногоДокумента.Обрезать;
				ТекОбласть.Заполнение = ТипЗаполненияОбластиТабличногоДокумента.Текст;
				ТекОбласть.ПоВыделеннымКолонкам = Истина;
				ТекОбласть.Расшифровка = СтрокаТаблицы.Документ;
				
				Если СтрокаТаблицы.Важность = Перечисления.Важность.Высокая Тогда
					ТекОбласть.ЦветТекста = WebЦвета.Красный;
				КонецЕсли;
				Если СтрокаТаблицы.СостояниеСобытия <> Перечисления.СостоянияСобытий.Запланировано Тогда
					ТекОбласть.ЦветФона = WebЦвета.Перламутровый;
					ТекОбласть.ЦветТекста = WebЦвета.Серый;
				КонецЕсли; 
				
			КонецЦикла; 
			
		КонецЕсли; 
		
		Если НачалоДня(ТекущаяДата)=НачалоДня(ТекущаяДата()) Тогда
			ТекущийЧас = Час(ТекущаяДата());
			СтрокаТекущегоЧаса = ТекущийЧас*2+1+2-СмещениеОтНачалаПервойЯчейкиДня+?(Минута(ТекущаяДата())>29,1,0);
			
			Если СтрокаТекущегоЧаса <= НомерПоследнейЯчейкиНедели Тогда
				Таб.Область(СтрокаТекущегоЧаса,2,Мин(СтрокаТекущегоЧаса+1,НомерПоследнейЯчейкиНедели),2).ЦветФона = WebЦвета.Бежевый;
				Таб.Область(СтрокаТекущегоЧаса,НачальноеЗначениеКолонки,Мин(СтрокаТекущегоЧаса+1,НомерПоследнейЯчейкиНедели),КонечноеЗначениеКолонки).ЦветФона = WebЦвета.Бежевый;
			КонецЕсли;
			
			ОбластьДняНедели.ЦветФона = WebЦвета.Бежевый;
		Иначе
			ОбластьДняНедели.ЦветФона = ЦветаСтиля.ЦветФонаКнопки;
		КонецЕсли;
		
	КонецЦикла;
	
	Таб.ТолькоПросмотр = Истина;
	Таб.ФиксацияСлева = (ОбшаяШиринаНедели + 2);
	Таб.ФиксацияСверху = 2;
	Таб.Показать();
	
	мБылоПервоеЗаполнениеНедели = Истина;
	
	мВыполняетсяОбновлениеОтображения = Ложь;
	
КонецПроцедуры

// Процедура заполняет данными поле табличного документа ПолеТабличногоДокументаМесяц.
//
// Параметры
//  НЕТ
//
// Возвращаемое значение
//  НЕТ
Процедура ЗаполнитьТаблицуМесяца()
	
	Состояние("Заполняется таблица месяца ...");
	
	Таб = ЭлементыФормы.ПолеТабличногоДокументаМесяц;
	Таб.Очистить();
	
	ШиринаТабличногоПоляМесяца = Таб.Ширина;
	
	ОбшаяШиринаМесяца = Цел(109*ШиринаТабличногоПоляМесяца/764);
	
	ШиринаКолонки = Цел(ОбшаяШиринаМесяца/КоличествоДнейНедели);
	
	Таб.Область(,1,,КоличествоДнейНедели).ШиринаКолонки = ШиринаКолонки;
	Таб.Область(1,,1,).ВысотаСтроки = 15;
	
	Если (ШиринаКолонки * КоличествоДнейНедели) <> ОбшаяШиринаМесяца Тогда
		Таб.Область(,КоличествоДнейНедели,,КоличествоДнейНедели).ШиринаКолонки = ОбшаяШиринаМесяца - (ШиринаКолонки * (КоличествоДнейНедели-1));
	КонецЕсли;
	
	ОбластьДнейНедели = Таб.Область(1,1,1,КоличествоДнейНедели);
	ОбластьДнейНедели.ЦветФона = ЦветаСтиля.ЦветФонаКнопки;
	ОбластьДнейНедели.ГраницаСверху = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная, 1);
	ОбластьДнейНедели.ГраницаСнизу = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная, 1);
	ОбластьДнейНедели.ГраницаСлева = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная, 1);
	ОбластьДнейНедели.ГраницаСправа = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная, 1);
	
	ОбластьДнейНедели.ЦветРамки = ЦветаСтиля.ЦветРамки;
	ОбластьДнейНедели.ЦветТекста = ЦветаСтиля.ЦветРамки;
	
	Для а = 1 По КоличествоДнейНедели Цикл
		
		ОбластьДняНедели = Таб.Область(1,а,1,а);
		ОбластьДняНедели.Текст = ОпределитьДеньНедели(а);
		ОбластьДняНедели.Шрифт = Новый Шрифт(,10,Истина);
		ОбластьДняНедели.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Центр;
		ОбластьДняНедели.ВертикальноеПоложение = ВертикальноеПоложение.Центр;
		ОбластьДняНедели.РазмещениеТекста = ТипРазмещенияТекстаТабличногоДокумента.Авто;
		ОбластьДняНедели.Заполнение = ТипЗаполненияОбластиТабличногоДокумента.Текст;
		
	КонецЦикла;
	
	ВысотаСтроки = Цел(50*(Таб.Высота-30)/(359-30));
	
	ПервыйДеньНеделиМесяца = ДеньНедели(ДатаНачалаМесяцаЗапроса);
	Если ПервыйДеньНеделиМесяца > 1 Тогда
		ПерваяДатаМесяца = ДатаНачалаМесяцаЗапроса - (ПервыйДеньНеделиМесяца - 1)*60*60*24;
	Иначе
		ПерваяДатаМесяца = ДатаНачалаМесяцаЗапроса;
	КонецЕсли;
	
	ТаблицаСобытияЗаказы = Новый ТаблицаЗначений();
	ТаблицаСобытияЗаказы.Колонки.Добавить("ДатаДокумента");
	ТаблицаСобытияЗаказы.Колонки.Добавить("СтрокаДокументов");
	
	Для каждого СтрокаДанных Из ДанныеМесяца Цикл
		
		НайденнаяСтрока = ТаблицаСобытияЗаказы.Найти(НачалоДня(СтрокаДанных.Дата), "ДатаДокумента");
		Если НайденнаяСтрока = Неопределено Тогда
			НайденнаяСтрока = ТаблицаСобытияЗаказы.Добавить();
			НайденнаяСтрока.ДатаДокумента = НачалоДня(СтрокаДанных.Дата);
			НайденнаяСтрока.СтрокаДокументов = "";
		КонецЕсли;
		
		Если НЕ ПустаяСтрока(НайденнаяСтрока.СтрокаДокументов) Тогда
			НайденнаяСтрока.СтрокаДокументов = НайденнаяСтрока.СтрокаДокументов + Символы.ПС;
		КонецЕсли;

		Если ТипЗнч(СтрокаДанных.Документ) = Тип("ДокументСсылка.Событие") Тогда
			НайденнаяСтрока.СтрокаДокументов = НайденнаяСтрока.СтрокаДокументов + Формат(СтрокаДанных.ДатаНачалаСобытия, "ДФ=ЧЧ:мм") + " - " + Формат(СтрокаДанных.ДатаКонцаСобытия, "ДФ=ЧЧ:мм");
			Если ЗначениеЗаполнено(СтрокаДанных.Контрагент) Тогда
				НайденнаяСтрока.СтрокаДокументов = НайденнаяСтрока.СтрокаДокументов + ", " + СокрЛП(СтрокаДанных.Контрагент);
				Если ЗначениеЗаполнено(СтрокаДанных.КонтактноеЛицо) Тогда
					НайденнаяСтрока.СтрокаДокументов = НайденнаяСтрока.СтрокаДокументов + ", " + СокрЛП(СтрокаДанных.КонтактноеЛицо);
				КонецЕсли;
			ИначеЕсли ЗначениеЗаполнено(СтрокаДанных.КонтактноеЛицо) Тогда
				НайденнаяСтрока.СтрокаДокументов = НайденнаяСтрока.СтрокаДокументов + ", " + СокрЛП(СтрокаДанных.КонтактноеЛицо);
			КонецЕсли;
		ИначеЕсли ТипЗнч(СтрокаДанных.Документ) = Тип("ДокументСсылка.ЗаказПокупателя") Тогда
			НайденнаяСтрока.СтрокаДокументов = НайденнаяСтрока.СтрокаДокументов + ?(СтрокаДанных.ТипЗаказа = Перечисления.ВидыДействийПоЗаказамПокупателей.ОплатаПоЗаказу, "Оплата покупателя", "Отгрузка");
			Если ЗначениеЗаполнено(СтрокаДанных.Контрагент) Тогда
				НайденнаяСтрока.СтрокаДокументов = НайденнаяСтрока.СтрокаДокументов + ", " + СокрЛП(СтрокаДанных.Контрагент);
			КонецЕсли;
		ИначеЕсли ТипЗнч(СтрокаДанных.Документ) = Тип("ДокументСсылка.ЗаказПоставщику") Тогда
			НайденнаяСтрока.СтрокаДокументов = НайденнаяСтрока.СтрокаДокументов + ?(СтрокаДанных.ТипЗаказа = Перечисления.ВидыДействийПоЗаказамПоставщикам.ОплатаПоЗаказу, "Оплата поставщику", "Поступление");
			Если ЗначениеЗаполнено(СтрокаДанных.Контрагент) Тогда
				НайденнаяСтрока.СтрокаДокументов = НайденнаяСтрока.СтрокаДокументов + ", " + СокрЛП(СтрокаДанных.Контрагент);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;

	ТекущаяДата = ПерваяДатаМесяца;
	
	Для Строка = 1 По 5 Цикл
		
		Для Колонка = 1 По КоличествоДнейНедели Цикл
			
			ОбластьЧислоДня = Таб.Область((Строка*2),Колонка,(Строка*2),Колонка);
			ОбластьЧислоДня.ГраницаСверху = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная, 1);
			ОбластьЧислоДня.ГраницаСлева = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная, 1);
			ОбластьЧислоДня.ГраницаСправа = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная, 1);
			ОбластьЧислоДня.ЦветРамки = ЦветаСтиля.ЦветРамки;
			ОбластьЧислоДня.ВысотаСтроки = 11;
			
			ОбластьЧислоДня.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Лево;
			ОбластьЧислоДня.ВертикальноеПоложение = ВертикальноеПоложение.Центр;
			ОбластьЧислоДня.РазмещениеТекста = ТипРазмещенияТекстаТабличногоДокумента.Авто;
			ОбластьЧислоДня.Заполнение = ТипЗаполненияОбластиТабличногоДокумента.Текст;
			ОбластьЧислоДня.Расшифровка = ТекущаяДата;
			
			ОбластьПоляДня = Таб.Область((Строка*2 + 1),Колонка,(Строка*2 + 1),Колонка);
			ОбластьПоляДня.ГраницаСнизу = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная, 1);
			ОбластьПоляДня.ГраницаСлева = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная, 1);
			ОбластьПоляДня.ГраницаСправа = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная, 1);
			ОбластьПоляДня.ЦветРамки = ЦветаСтиля.ЦветРамки;
			ОбластьПоляДня.ВысотаСтроки = ВысотаСтроки - 11;
			ОбластьПоляДня.Расшифровка = ТекущаяДата;
			ОбластьПоляДня.РазмещениеТекста = ТипРазмещенияТекстаТабличногоДокумента.Обрезать;
			
			ОбластьПоляДня.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Лево;
			ОбластьПоляДня.ВертикальноеПоложение = ВертикальноеПоложение.Верх;
			ОбластьПоляДня.Заполнение = ТипЗаполненияОбластиТабличногоДокумента.Текст;
			
			НайденнаяСтрокаСобытияИЗаказы = ТаблицаСобытияЗаказы.Найти(ТекущаяДата, "ДатаДокумента");
			
			ОбластьПоляДня.Текст = ?(НайденнаяСтрокаСобытияИЗаказы = Неопределено, "", НайденнаяСтрокаСобытияИЗаказы.СтрокаДокументов);
			
			Если НачалоДня(ТекущаяДата) = НачалоДня(ТекущаяДата()) Тогда
				
				ОбластьЧислоДня.Шрифт = Новый Шрифт(,,Истина);
				ОбластьЧислоДня.ЦветФона = WebЦвета.Бежевый;
				ОбластьЧислоДня.ГраницаСнизу =  Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная, 1);
				
				ОбластьПоляДня.ЦветФона = Новый Цвет;
				
				ОбластьПоляДня.ЦветТекста = Новый Цвет;
				
				СтрокаДатыДня = СокрЛП(Формат(ТекущаяДата,"ДФ=d"));
				ОбластьЧислоДня.Текст = СокрЛП(Формат(ТекущаяДата,"ДФ=d"));
				
			Иначе
				
				Если Месяц(ТекущаяДата) <> Месяц(ДатаНачалаМесяцаЗапроса) Тогда
					ОбластьЧислоДня.ЦветФона = WebЦвета.Перламутровый;
					ОбластьЧислоДня.ЦветТекста = WebЦвета.Серый;
					ОбластьЧислоДня.Текст = СокрЛП(Формат(ТекущаяДата,"ДФ=dd.MM.yyyy"));
					ОбластьЧислоДня.Шрифт = Новый Шрифт(,,Ложь);
					СтрокаДатыДня = СокрЛП(Формат(ТекущаяДата,"ДФ=dd.MM.yyyy"));
					
					ОбластьПоляДня.ЦветФона = WebЦвета.Перламутровый;
					ОбластьПоляДня.ЦветТекста = WebЦвета.Серый;
				Иначе
					
					Если Колонка = 6 ИЛИ Колонка = 7 Тогда
						ОбластьЧислоДня.ЦветФона = WebЦвета.ГолубойСКраснымОттенком;
						ОбластьПоляДня.ЦветФона = WebЦвета.ГолубойСКраснымОттенком;
					Иначе
						ОбластьЧислоДня.ЦветФона = Новый Цвет;
						ОбластьПоляДня.ЦветФона = Новый Цвет;
					КонецЕсли; 
					
					ОбластьЧислоДня.ЦветТекста = Новый Цвет;
					ОбластьЧислоДня.Текст = СокрЛП(Формат(ТекущаяДата,"ДФ=d"));
					ОбластьЧислоДня.Шрифт = Новый Шрифт(,,Ложь);
					СтрокаДатыДня = СокрЛП(Формат(ТекущаяДата,"ДФ=d"));
					
					ОбластьПоляДня.ЦветТекста = Новый Цвет;
					
				КонецЕсли;
				
			КонецЕсли;
			
			ТекущаяДата = ОпределитьСледующуюДата(ТекущаяДата);
			
		КонецЦикла;
		
	КонецЦикла;
	
	Таб.ФиксацияСверху = 11;
	Таб.ФиксацияСлева = КоличествоДнейНедели;
	Таб.ТолькоПросмотр = Истина;
	Таб.Показать();
	
КонецПроцедуры

// Функция определяет следующую дату за текущей в зависимости от
//  настроенного количества дней в недели для отображения в календаре
//
// Параметры
//  ТекущаяДата - Дата, текущая дата
//
// Возвращаемое значение:
//   Дата - следующая дата
//
Функция ОпределитьСледующуюДата(ТекущаяДата)
	
	Если КоличествоДнейНедели = 7 Тогда
		Возврат ТекущаяДата + 60*60*24;
	ИначеЕсли КоличествоДнейНедели = 6 Тогда
		Если ДеньНедели(ТекущаяДата) = 6 Тогда
			Возврат ТекущаяДата + 60*60*24*2;
		Иначе
			Возврат ТекущаяДата + 60*60*24;
		КонецЕсли; 
	ИначеЕсли КоличествоДнейНедели = 5 Тогда
		Если ДеньНедели(ТекущаяДата) = 5 Тогда
			Возврат ТекущаяДата + 60*60*24*3;
		ИначеЕсли ДеньНедели(ТекущаяДата) = 6 Тогда
			Возврат ТекущаяДата + 60*60*24*2;
		Иначе
			Возврат ТекущаяДата + 60*60*24;
		КонецЕсли; 
	КонецЕсли; 
	
КонецФункции // ОпределитьСледующуюДата()

// Процедура восстанавливает сохраненные в профайле значения пользователя..
//
// Параметры
//  НЕТ
//
// Возвращаемое значение
//  НЕТ
Процедура ПрочитатьСохраненныеЗначенияПользователя()
	
	ОграничитьВремяС  = "";
	ОграничитьВремяПо = "";
	
	Если НЕ ЗначениеЗаполнено(ДатаКалендаря) Тогда
		ДатаКалендаря = НачалоДня(ТекущаяДата());
	КонецЕсли;
	
	СохраненныеЗначения = ВосстановитьЗначение("КалендарьПользователя");
	Если СохраненныеЗначения <> Неопределено И ТипЗнч(СохраненныеЗначения) = Тип("Структура") Тогда
		СохраненныеЗначения.Свойство("КоличествоДнейНаЗакладкеДень"    , КоличествоДнейНаЗакладкеДень);
		СохраненныеЗначения.Свойство("КоличествоДнейНедели"            , КоличествоДнейНедели);
		СохраненныеЗначения.Свойство("ОтображатьЗапланированныеСобытия", ОтображатьЗапланированныеСобытия);
		СохраненныеЗначения.Свойство("ТипСобытияКалендаря"             , ТипСобытияКалендаря);
		СохраненныеЗначения.Свойство("ОтображатьЗаказы"                , ОтображатьЗаказы);
		СохраненныеЗначения.Свойство("ОтображаемыеЗаказы"              , ОтображаемыеЗаказы);
		СохраненныеЗначения.Свойство("ОграничитьВремя"                 , ОграничитьВремя);
		СохраненныеЗначения.Свойство("ОграничитьВремяС"                , ОграничитьВремяС);
		СохраненныеЗначения.Свойство("ОграничитьВремяПо"               , ОграничитьВремяПо);
		СохраненныеЗначения.Свойство("ОтображатьЗанятостьПомещений"    , ОтображатьЗанятостьПомещений);
		СохраненныеЗначения.Свойство("ПользовательКалендаря"           , ПользовательКалендаря);
		СохраненныеЗначения.Свойство("ВидСравненияПостроитель"         , ВидСравненияПостроитель);
	КонецЕсли; 
	
	Если ПользовательКалендаря.Количество()=0 Тогда
		ОсновнойОтветственный = УправлениеПользователями.ПолучитьЗначениеПоУмолчанию(глЗначениеПеременной("глТекущийПользователь"), "ОсновнойОтветственный");
		Если Не ЗначениеЗаполнено(ОсновнойОтветственный) Тогда
			ОсновнойОтветственный = глЗначениеПеременной("глТекущийПользователь");
		КонецЕсли;
		ПользовательКалендаря.Добавить(ОсновнойОтветственный);
	КонецЕсли;
	
	МассивЗначенийОтбора = Новый Массив;
	МассивЗначенийОтбора.Добавить(ВидСравненияПостроитель);
	МассивЗначенийОтбора.Добавить(ПользовательКалендаря);
	СтруктураОтборов.Вставить("Пользователь", МассивЗначенийОтбора);
	Если КоличествоДнейНаЗакладкеДень = 0 Тогда
		КоличествоДнейНаЗакладкеДень  = 2;
	КонецЕсли; 
	
	Если КоличествоДнейНедели = 0 Тогда
		КоличествоДнейНедели = 7;
	КонецЕсли; 
	
	Если ОтображаемыеЗаказы = 0 Тогда
		ОтображаемыеЗаказы = 3;
	КонецЕсли; 
	
	Если ОграничитьВремя Тогда
		СтруктураРабочегоВремени	= мОпределитьНачалоИОкончаниеРабочегоДняПользователя(глЗначениеПеременной("глТекущийПользователь"),ДатаКалендаря);
		ДатаНачалаРабочегоДня   	= СтруктураРабочегоВремени.ДатаНачала;
		ДатаОкончанияРабочегоДня	= СтруктураРабочегоВремени.ДатаОкончания;
		
		// ограничиваем или по выбранному времени, или по времени начала рабочего дня, или с начала дня (0 часов)
		Если ОграничитьВремяС <> Дата('00010101000000') Тогда
			ЧасНачалаРабочегоДня 		= Час(ОграничитьВремяС);
		Иначе
			ЧасНачалаРабочегоДня        = 0;	
		КонецЕсли;
		
		// ограничиваем или по выбранному времени, или по времени конца рабочего дня, или по конец дня(23 часа)	
		Если ОграничитьВремяПо <> Дата('00010101000000') Тогда
			ЧасОкончанияРабочегоДня 	= Час(ОграничитьВремяПо);
		Иначе
			ЧасОкончанияРабочегоДня 	= 23;	
		КонецЕсли;
		
	Иначе
		ЧасНачалаРабочегоДня    	= 0;
		ЧасОкончанияРабочегоДня 	= 23;
	КонецЕсли;
	
	СмещениеОтНачалаПервойЯчейкиДня = ЧасНачалаРабочегоДня *2;
	НомерПоследнейЯчейкиДня         = ЧасОкончанияРабочегоДня*2+2;
	НомерПоследнейЯчейкиНедели      = НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня + 2;
	
	
КонецПроцедуры

// Процедура открывает форму нового документа событие из контакстного меню мокселя.
//
// Параметры
//  Элемент - кнопка, по нажатию которой происходит действие
//
// Возвращаемое значение
//  НЕТ
Процедура ВвестиДокументСобытиеИзМокселя(Элемент = Неопределено)
	
	Если ТипЗнч(ЭтаФорма.ТекущийЭлемент) <> Тип("ПолеТабличногоДокумента") Тогда
		Возврат;
	КонецЕсли;
	
	ОбъектСобытия = Документы.Событие.СоздатьДокумент();
	
	ТекущаяОбласть = ЭтаФорма.ТекущийЭлемент.ТекущаяОбласть;
	
	Если Элемент <> Неопределено Тогда
		ИндексСписка = Число(Сред(Элемент.Имя, 2));
		ВыбранныйЭлемент = мСписокДокументовДобавления.Получить(ИндексСписка);
		ОбъектСобытия.ВидСобытия      = ВыбранныйЭлемент.Значение[0];
		ОбъектСобытия.ТипСобытия      = ВыбранныйЭлемент.Значение[1];
		
		//КнопкаФормы = ЭлементыФормы.ВвестиДокумент;
		//
		//КнопкаФормы.Заголовок = СокрЛП(Строка(ВыбранныйЭлемент.Значение[0]));
		//КнопкаФормы.Подсказка = "Ввести новое " + ВыбранныйЭлемент.Значение[1] + " событие -  " + ВыбранныйЭлемент.Значение[0];
		//КнопкаФормы.Картинка  = ?(ВыбранныйЭлемент.Значение[1] = Перечисления.ВходящееИсходящееСобытие.Исходящее, БиблиотекаКартинок.ИсходящееСобытие, БиблиотекаКартинок.ВходящееСобытие);
		//
		//КнопкаФормы = ЭлементыФормы.ВвестиДокументНеделя;
		//
		//КнопкаФормы.Заголовок = СокрЛП(Строка(ВыбранныйЭлемент.Значение[0]));
		//КнопкаФормы.Подсказка = "Ввести новое " + ВыбранныйЭлемент.Значение[1] + " событие -  " + ВыбранныйЭлемент.Значение[0];
		//КнопкаФормы.Картинка  = ?(ВыбранныйЭлемент.Значение[1] = Перечисления.ВходящееИсходящееСобытие.Исходящее, БиблиотекаКартинок.ИсходящееСобытие, БиблиотекаКартинок.ВходящееСобытие);
		
		мМассивЗначенийБыстрогоСобытия = Новый Массив;
		мМассивЗначенийБыстрогоСобытия.Добавить(ВыбранныйЭлемент.Значение[0]);
		мМассивЗначенийБыстрогоСобытия.Добавить(ВыбранныйЭлемент.Значение[1]);
		
	КонецЕсли; 
	
	Если ТекущаяОбласть <> Неопределено Тогда
		Если ЭтаФорма.ТекущийЭлемент = ЭлементыФормы.ПолеТабличногоДокументаНеделя Тогда
			ОбъектСобытия.НачалоСобытия = ОпределитьДатыОбластиНедели(ТекущаяОбласть, Истина);
			ОбъектСобытия.ОкончаниеСобытия = ОпределитьДатыОбластиНедели(ТекущаяОбласть, Ложь);
		Иначе
			ОбъектСобытия.НачалоСобытия = ОпределитьДатыОбластиДня(ТекущаяОбласть, Истина);
			ОбъектСобытия.ОкончаниеСобытия = ОпределитьДатыОбластиДня(ТекущаяОбласть, Ложь);
			Если ЭтаФорма.ТекущийЭлемент = ЭлементыФормы.ПолеТабличногоДокументаДеньВторой И ТекущаяОбласть.Лево > ОбщаяШиринаДня+3 Тогда
				ОбъектСобытия.НачалоСобытия = ОбъектСобытия.НачалоСобытия + 60*60*24;
				ОбъектСобытия.ОкончаниеСобытия = ОбъектСобытия.ОкончаниеСобытия + 60*60*24;
			КонецЕсли; 
		КонецЕсли; 
	КонецЕсли;
	
	ОбъектСобытия.ОписаниеСобытия = ТемаНовогоСобытия;
	ОбъектСобытия.Ответственный   = ПользовательКалендаря;
	ОбъектСобытия.КонтактноеЛицо  = ОбъектФормы;
	Если Элемент = Неопределено  И ТипЗнч(ОбъектФормы) = Тип("СправочникСсылка.ФизическиеЛица") Тогда
		ОбъектСобытия.ВидСобытия = Перечисления.ВидыСобытий.ЛичнаяВстреча;
		ОбъектСобытия.ОписаниеСобытия = ?(НЕ ЗначениеЗаполнено(ТемаНовогоСобытия),"Собеседование",ТемаНовогоСобытия);
	КонецЕсли;
	
	ОбъектСобытия.ПолучитьФорму(,ЭтаФорма).Открыть();
	
КонецПроцедуры

// Функция определяет по области ячеек табличного документа
//  дату начала и дату окончания данной области в ПолеТабличногоДокументаДень.
//
// Параметры
//  ТекущаяОбласть - Область ячеек табличного документа.
//  Начало - Булево, признак определения даты начала или окончания.
//
// Возвращаемое значение:
//   Дата
//
Функция ОпределитьДатыОбластиДня(ТекущаяОбласть, Начало)
	
	СтрокаДаты = СтрЗаменить((Строка(Год(ДатаКалендаря))),Символ(160),"");
	
	МесяцКалендаря = ?(Месяц(ДатаКалендаря) < 10, ("0" + Строка(Месяц(ДатаКалендаря))), Строка(Месяц(ДатаКалендаря)));
	СтрокаДаты = СтрокаДаты + МесяцКалендаря;
	
	ДеньКалендаря = ?(День(ДатаКалендаря)<10, ("0" + Строка(День(ДатаКалендаря))), Строка(День(ДатаКалендаря)));
	СтрокаДаты = СтрокаДаты + ДеньКалендаря;
	
	Если Начало Тогда
		Верх = ТекущаяОбласть.Верх+СмещениеОтНачалаПервойЯчейкиДня;
		Если Верх > НомерПоследнейЯчейкиДня Тогда
			Возврат КонецДня(ДатаКалендаря);
		ИначеЕсли Верх = НомерПоследнейЯчейкиДня Тогда
			Возврат (КонецДня(ДатаКалендаря) - 60 * 30 + 1);
		ИначеЕсли Верх <= 1 Тогда
			Возврат НачалоДня(ДатаКалендаря);
		Иначе
			Если ((Верх-1)/2) = Цел(((Верх-1)/2)) Тогда
				ЧислоЧаса = (Верх-1)/2;
				СтрокаДаты = СтрокаДаты + ?(ЧислоЧаса<10, ("0"+Строка(ЧислоЧаса)),(Строка(ЧислоЧаса))) + "0000";
				Возврат Дата(СтрокаДаты);
			Иначе
				ЧислоЧаса = Цел((Верх-1)/2);
				СтрокаДаты = СтрокаДаты + ?(ЧислоЧаса<10, ("0"+Строка(ЧислоЧаса)),(Строка(ЧислоЧаса))) + "3000";
				Возврат Дата(СтрокаДаты);
			КонецЕсли; 
		КонецЕсли; 
	Иначе
		Низ = ТекущаяОбласть.Низ+СмещениеОтНачалаПервойЯчейкиДня;
		Если Низ >= НомерПоследнейЯчейкиДня Тогда
			Возврат КонецДня(ДатаКалендаря);
		ИначеЕсли Низ < 1 Тогда
			Возврат НачалоДня(ДатаКалендаря);
		ИначеЕсли Низ = 1 Тогда
			Возврат (НачалоДня(ДатаКалендаря) + 60 * 30);
		Иначе
			Если (Низ/2) = Цел((Низ)/2) Тогда
				ЧислоЧаса = Низ/2;
				СтрокаДаты = СтрокаДаты + ?(ЧислоЧаса<10, ("0"+Строка(ЧислоЧаса)),(Строка(ЧислоЧаса))) + "0000";
				Возврат Дата(СтрокаДаты);
			Иначе
				ЧислоЧаса = Цел(Низ/2);
				СтрокаДаты = СтрокаДаты + ?(ЧислоЧаса<10, ("0"+Строка(ЧислоЧаса)),(Строка(ЧислоЧаса))) + "3000";
				Возврат Дата(СтрокаДаты);
			КонецЕсли; 
		КонецЕсли; 
	КонецЕсли;
	
КонецФункции

// Функция определяет по области ячеек табличного документа
//  дату начала и дату окончания данной области в ПолеТабличногоДокументаНеделя.
//
// Параметры
//  ТекущаяОбласть - Область ячеек табличного документа.
//  Начало - Булево, признак определения даты начала или окончания.
//
// Возвращаемое значение:
//   Дата
//
Функция ОпределитьДатыОбластиНедели(ТекущаяОбласть, Начало)
	
	ТекущаяДата = ДатаКалендаря;
	
	Для каждого СтрокаТаблицы Из мТаблицаЯчеекИДатНедели Цикл
		Если Начало Тогда
			Если ТекущаяОбласть.Лево >= СтрокаТаблицы.НомерНачальнойЯчейки И ТекущаяОбласть.Лево <= СтрокаТаблицы.НомерКонечнойЯчейки Тогда
				ТекущаяДата = СтрокаТаблицы.ДатаНедели;
				Прервать;
			КонецЕсли;
		Иначе
			Если ТекущаяОбласть.Право >= СтрокаТаблицы.НомерНачальнойЯчейки И ТекущаяОбласть.Право <= СтрокаТаблицы.НомерКонечнойЯчейки Тогда
				ТекущаяДата = СтрокаТаблицы.ДатаНедели;
				Прервать;
			КонецЕсли;
		КонецЕсли; 
	КонецЦикла; 
	
	СтрокаДаты = СтрЗаменить((Строка(Год(ТекущаяДата))),Символ(160),"");
	
	МесяцКалендаря = ?(Месяц(ТекущаяДата) < 10, ("0" + Строка(Месяц(ТекущаяДата))), Строка(Месяц(ТекущаяДата)));
	СтрокаДаты = СтрокаДаты + МесяцКалендаря;
	
	ДеньКалендаря = ?(День(ТекущаяДата)<10, ("0" + Строка(День(ТекущаяДата))), Строка(День(ТекущаяДата)));
	СтрокаДаты = СтрокаДаты + ДеньКалендаря;
	
	Если Начало Тогда
		Верх = ТекущаяОбласть.Верх - 2 + СмещениеОтНачалаПервойЯчейкиДня;
		Если Верх > НомерПоследнейЯчейкиДня Тогда
			Возврат КонецДня(СтрокаДаты);
		ИначеЕсли Верх = НомерПоследнейЯчейкиДня Тогда
			Возврат (КонецДня(СтрокаДаты) - 60 * 30 + 1);
		ИначеЕсли Верх <= 1 Тогда
			Возврат НачалоДня(СтрокаДаты);
		Иначе
			Если ((Верх-1)/2) = Цел(((Верх-1)/2)) Тогда
				ЧислоЧаса = (Верх-1)/2;
				СтрокаДаты = СтрокаДаты + ?(ЧислоЧаса<10, ("0"+Строка(ЧислоЧаса)),(Строка(ЧислоЧаса))) + "0000";
				Возврат Дата(СтрокаДаты);
			Иначе
				ЧислоЧаса = Цел((Верх-1)/2);
				СтрокаДаты = СтрокаДаты + ?(ЧислоЧаса<10, ("0"+Строка(ЧислоЧаса)),(Строка(ЧислоЧаса))) + "3000";
				Возврат Дата(СтрокаДаты);
			КонецЕсли; 
		КонецЕсли; 
	Иначе
		Низ = ТекущаяОбласть.Низ - 2 + СмещениеОтНачалаПервойЯчейкиДня;
		Если Низ >= НомерПоследнейЯчейкиДня Тогда
			Возврат КонецДня(СтрокаДаты);
		ИначеЕсли Низ < 1 Тогда
			Возврат НачалоДня(СтрокаДаты);
		ИначеЕсли Низ = 1 Тогда
			Возврат (НачалоДня(СтрокаДаты) + 60 * 30);
		Иначе
			Если (Низ/2) = Цел((Низ)/2) Тогда
				ЧислоЧаса = Низ/2;
				СтрокаДаты = СтрокаДаты + ?(ЧислоЧаса<10, ("0"+Строка(ЧислоЧаса)),(Строка(ЧислоЧаса))) + "0000";
				Возврат Дата(СтрокаДаты);
			Иначе
				ЧислоЧаса = Цел(Низ/2);
				СтрокаДаты = СтрокаДаты + ?(ЧислоЧаса<10, ("0"+Строка(ЧислоЧаса)),(Строка(ЧислоЧаса))) + "3000";
				Возврат Дата(СтрокаДаты);
			КонецЕсли; 
		КонецЕсли; 
	КонецЕсли;
	
КонецФункции // ОпределитьДатыОбластиНедели()

// Процедура меняет текущую страницу панели формы.
//
// Параметры
//  ИмяЗакладки - Строка, имя новой страницы
//
// Возвращаемое значение
//  НЕТ
Процедура УстановитьЗакладку(ИмяЗакладки)
	
	УстновитьВидимостьСтраницы(ЭлементыФормы.ПанельФормы.Страницы,ИмяЗакладки);
	
	ЗакладкаПерехода = ЭлементыФормы.ПанельФормы.Страницы[ИмяЗакладки];
	Если ЭлементыФормы.ПанельФормы.ТекущаяСтраница <> ЗакладкаПерехода Тогда
		УстновитьВидимостьСтраницы(ЭлементыФормы.ПанельФормы.Страницы,ИмяЗакладки);
		ЭлементыФормы.ПанельФормы.ТекущаяСтраница = ЗакладкаПерехода;
		УстановитьПометкуКнопок(ЭлементыФормы.КоманднаяПанельФормы.Кнопки, ЭлементыФормы.ПанельФормы.ТекущаяСтраница.Имя);
	КонецЕсли;
	
	Если ИмяЗакладки = "Неделя" И НЕ мБылоПервоеЗаполнениеНедели Тогда
		
		Если ОбновитьНеделю[2] Тогда
			СобратьДокументыНедели(ОтображатьЗапланированныеСобытия, ТипСобытияКалендаря, ОтображатьЗаказы, ОтображаемыеЗаказы, ОтображатьЗанятостьПомещений);
		КонецЕсли;
		ЗаполнитьТаблицуНедели();
		
		ОбновитьДень[1] = ДатаНачалаНедели;
		ОбновитьДень[2] = Ложь;
		
		ОбновитьНеделю[0] = Ложь;
		ОбновитьНеделю[1] = ДатаНачалаНедели;
		ОбновитьНеделю[2] = Ложь;
		
		ЭлементыФормы.ПанельФормы.ТекущаяСтраница = ЭлементыФормы.ПанельФормы.Страницы[ИмяЗакладки];
		
	Иначе
		
		ЭлементыФормы.ПанельФормы.ТекущаяСтраница = ЭлементыФормы.ПанельФормы.Страницы[ИмяЗакладки];
		
		ОбновитьИнформациюНаФорме();
		
	КонецЕсли; 
	
	СостояниеТулбараФормы();
	ОбновитьИнформациюНаФорме();
	
КонецПроцедуры

// Процедура вызывается из обработчиков ПриИзменении элементов формы
//  ПолеКалендаря и ПолеКалендаряНеделя
//
// Параметры
//  Элемент - элемент формы ПолеКалендаря или ПолеКалендаряНеделя
//
// Возвращаемое значение
//  НЕТ
Процедура ПриИзмененииДатыКалендаря(Элемент)
	
	Если НачалоМесяца(Элемент.Значение) <> ДатаНачалаМесяцаЗапроса Тогда
		ДатаНачалаМесяцаЗапроса = НачалоМесяца(Элемент.Значение);
		ОбновитьМесяц[0] = Истина;
	КонецЕсли; 
	
	Если ДатаНачалаНедели <> НачалоНедели(Элемент.Значение) Тогда
		ДатаНачалаНедели = НачалоНедели(Элемент.Значение);
		ОбновитьНеделю[0] = Истина;
	КонецЕсли; 
	
	ОбновитьДень[0] = Истина;
	
	ОбновитьИнформациюНаФорме();
	
КонецПроцедуры

// Процедура вызывается из из различных процедур и проверяет а при необходимости
//  производит обновление информации календаря и списка сделок
//
// Параметры
//  НЕТ
//
// Возвращаемое значение
//  НЕТ
Процедура ОбновитьИнформациюНаФорме()
	
	Если ЭлементыФормы.ПанельФормы.ТекущаяСтраница = ЭлементыФормы.ПанельФормы.Страницы.Список Тогда
		Если ОбновитьСписок[0] Тогда
			ОбновитьЗаказыСобытия(ОбновитьСписок[1]);
		КонецЕсли;
		ОбновитьСписок[0] = Ложь;
		ОбновитьСписок[1] = Истина;
	ИначеЕсли ЭлементыФормы.ПанельФормы.ТекущаяСтраница = ЭлементыФормы.ПанельФормы.Страницы.День Тогда
		Если ОбновитьДень[0] Тогда
			Если НачалоНедели(ОбновитьДень[1]) <> ДатаНачалаНедели ИЛИ ОбновитьДень[2] Тогда
				СобратьДокументыНедели(ОтображатьЗапланированныеСобытия, ТипСобытияКалендаря, ОтображатьЗаказы, ОтображаемыеЗаказы, ОтображатьЗанятостьПомещений);
				ОбновитьНеделю[1] = ДатаНачалаНедели;
				ОбновитьНеделю[2] = Ложь;
			КонецЕсли;
			ЗаполнитьТаблицуДня();
		КонецЕсли;
		ОбновитьДень[0] = Ложь;
		ОбновитьДень[1] = НачалоДня(ДатаКалендаря);
		ОбновитьДень[2] = Ложь;
	ИначеЕсли ЭлементыФормы.ПанельФормы.ТекущаяСтраница = ЭлементыФормы.ПанельФормы.Страницы.Неделя Тогда
		Если ОбновитьНеделю[0] Тогда
			Если ОбновитьНеделю[1] <> ДатаНачалаНедели ИЛИ ОбновитьНеделю[2] Тогда
				СобратьДокументыНедели(ОтображатьЗапланированныеСобытия, ТипСобытияКалендаря, ОтображатьЗаказы, ОтображаемыеЗаказы, ОтображатьЗанятостьПомещений);
				ОбновитьДень[1] = ДатаНачалаНедели;
				ОбновитьДень[2] = Ложь;
			КонецЕсли;
			ЗаполнитьТаблицуНедели();
		КонецЕсли;
		ОбновитьНеделю[0] = Ложь;
		ОбновитьНеделю[1] = ДатаНачалаНедели;
		ОбновитьНеделю[2] = Ложь;
	ИначеЕсли ЭлементыФормы.ПанельФормы.ТекущаяСтраница = ЭлементыФормы.ПанельФормы.Страницы.Месяц Тогда
		Если ОбновитьМесяц[0] Тогда
			Если ОбновитьМесяц[1] <> ДатаНачалаМесяцаЗапроса ИЛИ ОбновитьМесяц[2] Тогда
				СобратьДокументыМесяца(ОтображатьЗапланированныеСобытия, ТипСобытияКалендаря, ОтображатьЗаказы, ОтображаемыеЗаказы)
			КонецЕсли;
			ЗаполнитьТаблицуМесяца();
		КонецЕсли;
		ОбновитьМесяц[0] = Ложь;
		ОбновитьМесяц[1] = ДатаНачалаМесяцаЗапроса;
		ОбновитьМесяц[2] = Ложь;
	КонецЕсли;
	
КонецПроцедуры

// Процедура обновляет данные в таблице списка.
//
Процедура ОбновитьТаблицуСписка()
	
	ОбновитьЗаказыСобытия(Ложь);
	
КонецПроцедуры

// Процедура обновляет данные в календаря дня.
//
Процедура ОбновитьКалендарьДня()
	
	ОбновитьДень[0] = Истина;
	ОбновитьДень[2] = Истина;
	
	ОбновитьИнформациюНаФорме();
	
КонецПроцедуры

// Процедура обновляет данные в календаря недели.
//
Процедура ОбновитьКалендарьНеделя()
	
	ОбновитьНеделю[0] = Истина;
	ОбновитьНеделю[2] = Истина;
	
	ОбновитьИнформациюНаФорме();
	
КонецПроцедуры

// Процедура обновляет данные в календаря месяца.
//
Процедура ОбновитьКалендарьМесяц()
	
	ОбновитьМесяц[0] = Истина;
	ОбновитьМесяц[2] = Истина;
	
	ОбновитьИнформациюНаФорме();
	
КонецПроцедуры


////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ ДЛЯ ПОДДЕРЖКИ МЕХАНИЗМОВ СВОЙСТВ И КАТЕГОРИЙ

Процедура ПерейтиККалендарю(Закладка = "День", Событие = Неопределено)
	
	Если ЭлементыФормы.ОсновнаяПанель.ТекущаяСтраница <> ЭлементыФормы.ОсновнаяПанель.Страницы.Календарь Тогда
		ЭлементыФормы.ОсновнаяПанель.ТекущаяСтраница = ЭлементыФормы.ОсновнаяПанель.Страницы.Календарь;
	КонецЕсли;
	
	Если ДатаКалендаря <> мДатаКалендаря Тогда
		
		мДатаКалендаря = ДатаКалендаря;
		
		Если НачалоМесяца(ДатаКалендаря) <> ДатаНачалаМесяцаЗапроса Тогда
			ДатаНачалаМесяцаЗапроса = НачалоМесяца(ДатаКалендаря);
			ОбновитьМесяц[0] = Истина;
		КонецЕсли;
		
		Если ДатаНачалаНедели <> НачалоНедели(ДатаКалендаря) Тогда
			ДатаНачалаНедели = НачалоНедели(ДатаКалендаря);
			ОбновитьНеделю[0] = Истина;
		КонецЕсли; 
		
		ОбновитьДень[0] = Истина;
		
	КонецЕсли; 
	
	УстановитьЗакладку(Закладка);
	
	Если ЗначениеЗаполнено(Событие) Тогда
		Если Закладка = "Список" Тогда
			СтрокаТаблицы = ЗаказыИСобытияПредставление.Найти(Событие,"Документ");
			Если СтрокаТаблицы <> Неопределено Тогда
				ЭлементыФормы.ЗаказыИСобытияПредставление.ТекущаяСтрока = СтрокаТаблицы;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

// Обработчик события ПриОткрытии формы.
//
Процедура ПриОткрытии()
	
	мВидОбъекта  = ВосстановитьЗначение("ВидОбъекта");
	ОбъектФормы = ВосстановитьЗначение("ПоследнийОбъект");
	
	ПрочитатьСохраненныеЗначенияПользователя();
	
	// восстановим основную страницу формы
	ИмяСтраницыМенеджераКонтактов = ВосстановитьЗначение("ИмяСтраницыМенеджераКонтактов");
	Если ТипЗнч(ИмяСтраницыМенеджераКонтактов) = Тип("Строка") Тогда
		Попытка
			ЭлементыФормы.ОсновнаяПанель.ТекущаяСтраница = ЭлементыФормы.ОсновнаяПанель.Страницы[ИмяСтраницыМенеджераКонтактов];
		Исключение
		КонецПопытки;
	КонецЕсли;
		
	СформироватьПредставлениеДня();
	
	ПодключитьОбработчикОжидания("ОбновлениеОтображенияКалендаря",1);
	
	Если АвтообновлениеСпискаКандидатов Тогда
		ПодключитьОбработчикОжидания("АвтообновлениеСпискаКандидатов",ПериодАвтообновленияСпискаКандидатов);
	КонецЕсли;
	
КонецПроцедуры

// Обработчик события ПередЗакрытием формы.
//
Процедура ПередЗакрытием(Отказ, СтандартнаяОбработка)
	
	ОтветНаВопрос = Вопрос("Завершить работу менеджера контактов?", РежимДиалогаВопрос.ДаНет);
	Если ОтветНаВопрос <> КодВозвратаДиалога.Да Тогда
		Отказ = Истина;
	КонецЕсли;
	
КонецПроцедуры

Процедура ОбновлениеОтображенияКалендаря()
	
	Если ЭлементыФормы.ОсновнаяПанель.ТекущаяСтраница.Имя = "Календарь" Тогда
		Если ЭлементыФормы.ПанельФормы.ТекущаяСтраница.Имя = "День" Тогда
			Если ОтображатьЗаказы Тогда
				Если ШиринаТабличногоПоляДня <> ЭлементыФормы.ПолеТабличногоДокументаДень.Ширина Тогда
					ЗаполнитьТаблицуДня();
				КонецЕсли;
			Иначе
				Если ШиринаТабличногоПоляДня <> ЭлементыФормы.ПолеТабличногоДокументаДеньВторой.Ширина Тогда
					ЗаполнитьТаблицуДня();
				КонецЕсли;
			КонецЕсли; 
		ИначеЕсли ЭлементыФормы.ПанельФормы.ТекущаяСтраница.Имя = "Неделя" Тогда
			Если ШиринаТабличногоПоляНедели <> ЭлементыФормы.ПолеТабличногоДокументаНеделя.Ширина Тогда
				ЗаполнитьТаблицуНедели();
			КонецЕсли;
		ИначеЕсли ЭлементыФормы.ПанельФормы.ТекущаяСтраница.Имя = "Месяц" Тогда
			Если ШиринаТабличногоПоляМесяца <> ЭлементыФормы.ПолеТабличногоДокументаМесяц.Ширина Тогда
				ЗаполнитьТаблицуМесяца();
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

// Обработчик события ПередОткрытием формы.
//
Процедура ПередОткрытием(Отказ, СтандартнаяОбработка)
	
	//НастроитьТаблицуПретендентов();
	//Настройки = ВосстановитьЗначение("НастройкиПостроителяПоКандидатам");
	//Если ТипЗнч(Настройки) = Тип("НастройкиПостроителяОтчета") Тогда
	//	ПостроительОтчетаПоКандидатам.УстановитьНастройки(Настройки);
	//КонецЕсли;
	
	ПроизвестиНачальноеЗаполнениеКалендаря = Истина;
	ПроизвестиНачальноеЗаполнениеПочты     = Истина;
	
	//ПредметыОбъектов.Отбор.Объект.Значение = Справочники.ФизическиеЛица.ПустаяСсылка();
	//ПредметыОбъектов.Отбор.Объект.Использование = Истина;
	
	
	
	
	//Заполнение реквизита таблица настроек статуса.
	ТаблицаНастроекСтатуса = ВосстановитьЗначение("ТаблицаНастроекСтатуса");
	Если ТаблицаНастроекСтатуса.Количество() < Перечисления.УдалитьСостоянияКандидатаНаРаботу.Количество() Тогда
		ТаблицаНастроекСтатуса.Очистить();
		Для индекс = 0 по Перечисления.УдалитьСостоянияКандидатаНаРаботу.Количество()-1 Цикл
			ТаблицаНастроекСтатуса.Добавить(Перечисления.УдалитьСостоянияКандидатаНаРаботу[индекс],,Истина);
		КонецЦикла;
	КонецЕсли;
		
	// ПОЧТА
	
	мКнопкаОтображатьСкрытыеПредметыПисем = ЭлементыФормы.КоманднаяПанельСписокПредметов.Кнопки.ОтображатьСкрытыеПредметы;
	ВосстановленноеЗначение = ВосстановитьЗначение("ПометкаКнопкиОтображенияСкрытыхПредметов");
	Если ТипЗнч(ВосстановленноеЗначение) = Тип("Булево") Тогда
		мКнопкаОтображатьСкрытыеПредметыПисем.Пометка = ВосстановленноеЗначение;
	КонецЕсли;
	
	Если НЕ Константы.ИспользованиеВстроенногоПочтовогоКлиента.Получить() Тогда
		ЭлементыФормы.ОсновнаяПанель.Страницы.Почта.Доступность = Ложь;
		Возврат;
	КонецЕсли;
	
	ОбновитьДоступныеУчетныеЗаписи();
	
	Если мДоступныеУчетныеЗаписи.Количество() = 0 Тогда
		Если НЕ ПравоДоступа("Добавление", Метаданные.Справочники.УчетныеЗаписиЭлектроннойПочты) Тогда
			ЭлементыФормы.ОсновнаяПанель.Страницы.Почта.Доступность = Ложь;
		КонецЕсли;
	КонецЕсли;
	
	ЭлементыФормы.УчетнаяЗапись.СписокВыбора = мДоступныеУчетныеЗаписи.Скопировать();
	ЭлементыФормы.УчетнаяЗапись.СписокВыбора.СортироватьПоПредставлению(НаправлениеСортировки.Возр);
	ЭлементыФормы.УчетнаяЗапись.СписокВыбора.Добавить(Справочники.УчетныеЗаписиЭлектроннойПочты.ПустаяСсылка(), "Все доступные учетные записи");
	
	ЭлементыФормы.КоманднаяПанельПочты.Кнопки.Подменю.Кнопки.РассмотренностиПоТекущемуПользователю.Пометка = мОтображатьРассмотренностиПисемТолькоПоТекущемуПользователю;
	ЭлементыФормы.КоманднаяПанельПочты.Кнопки.Подменю.Кнопки.ПредметыПисем.Пометка = мОтображатьСписокПредметов;
	
	ВидимостьСпискаПредметов();
	
	СохраненнаяУчетнаяЗапись       = ВосстановитьЗначение("УчетнаяЗапись");
	Если СохраненнаяУчетнаяЗапись <> Неопределено Тогда
		Если ТипЗнч(СохраненнаяУчетнаяЗапись) = Тип("СправочникСсылка.УчетныеЗаписиЭлектроннойПочты") Тогда
			Если НЕ СохраненнаяУчетнаяЗапись.Пустая() Тогда
				Попытка
					Объект = СохраненнаяУчетнаяЗапись.ПолучитьОбъект();
					Если Объект = Неопределено Тогда
						СохраненнаяУчетнаяЗапись = УправлениеПользователями.ПолучитьЗначениеПоУмолчанию(глЗначениеПеременной("глТекущийПользователь"), "ОсновнаяУчетнаяЗапись");
					Иначе
						Если мДоступныеУчетныеЗаписи.НайтиПоЗначению(СохраненнаяУчетнаяЗапись) = Неопределено Тогда
							СохраненнаяУчетнаяЗапись = УправлениеПользователями.ПолучитьЗначениеПоУмолчанию(глЗначениеПеременной("глТекущийПользователь"), "ОсновнаяУчетнаяЗапись");
						КонецЕсли; 
					КонецЕсли; 
				Исключение
					СохраненнаяУчетнаяЗапись = УправлениеПользователями.ПолучитьЗначениеПоУмолчанию(глЗначениеПеременной("глТекущийПользователь"), "ОсновнаяУчетнаяЗапись");
				КонецПопытки;
			КонецЕсли; 
		Иначе
			СохраненнаяУчетнаяЗапись = УправлениеПользователями.ПолучитьЗначениеПоУмолчанию(глЗначениеПеременной("глТекущийПользователь"), "ОсновнаяУчетнаяЗапись");
		КонецЕсли;
	Иначе
		СохраненнаяУчетнаяЗапись = УправлениеПользователями.ПолучитьЗначениеПоУмолчанию(глЗначениеПеременной("глТекущийПользователь"), "ОсновнаяУчетнаяЗапись");
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(СохраненнаяУчетнаяЗапись) Тогда
		СохраненнаяУчетнаяЗапись = Справочники.УчетныеЗаписиЭлектроннойПочты.ПустаяСсылка();
	КонецЕсли; 
	
	УчетнаяЗапись = СохраненнаяУчетнаяЗапись;
	
	//Если мДоступныеУчетныеЗаписи.НайтиПоЗначению(УчетнаяЗапись) = Неопределено И мДоступныеУчетныеЗаписи.Количество() > 0 Тогда
	//	УчетнаяЗапись = мДоступныеУчетныеЗаписи[0].Значение;
	//КонецЕсли;
	
	Для каждого ЭлементУправленияОтбором Из ЭлементыФормы.ЭлектронныеПисьмаСписок.НастройкаОтбора Цикл
		Доступность = Ложь;
		Если ЭлементыФормы.ЭлектронныеПисьмаСписок.Колонки.Найти(ЭлементУправленияОтбором.Имя) <> Неопределено Тогда
			Если ЭлементыФормы.ЭлектронныеПисьмаСписок.Колонки[ЭлементУправленияОтбором.Имя].Видимость ИЛИ ЭлементУправленияОтбором.Имя = "ТекстПисьма" Тогда
				Доступность = (ЭлементУправленияОтбором.Имя <> "УчетнаяЗапись" И ЭлементУправленияОтбором.Имя <> "ЭлектронныеПисьмаИСобытияПоОбъекту");
			КонецЕсли;
		КонецЕсли;
		ЭлементУправленияОтбором.Доступность = Доступность;
	КонецЦикла;
	
	Для каждого ЭлементУправленияОтбором Из ЭлементыФормы.ПредметыСписок.НастройкаОтбора Цикл
		ЭлементУправленияОтбором.Доступность = (ЭлементУправленияОтбором.Имя = "Предмет");
	КонецЦикла;
	
	Для каждого ЭлементНастройкиПорядка Из ЭлементыФормы.ГруппыПисемДерево.НастройкаПорядка Цикл
		ЭлементНастройкиПорядка.Доступность = Ложь;
	КонецЦикла;
	Для каждого ЭлементНастройкиПорядка Из ЭлементыФормы.ГруппыПисемДерево1.НастройкаПорядка Цикл
		ЭлементНастройкиПорядка.Доступность = Ложь;
	КонецЦикла;
	
	ПредметыСписок.Порядок.Очистить();
	ПредметыСписок.Порядок.Установить("Предмет ВОЗР");
	
	//ПредметыОбъектов.Порядок.Очистить();
	//ПредметыОбъектов.Порядок.Установить("Предмет ВОЗР");
	//
	УстановитьОтборГрупп();
	
	ГруппыПисем_ПриАктивизацииСтроки(ПолучитьЭлементГруппыПисемДерево());
	ПредметыСписок_ПриАктивизацииСтроки();
	ЭлектронныеПисьма_СписокПриАктивизацииСтроки(ЭлементыФормы.ЭлектронныеПисьмаСписок);
	ЗаполнитьПодменюОтправитьПолучить();
	
КонецПроцедуры

// Обработчик события ОбработкаЗаписиНовогоОбъекта формы.
//
Процедура ОбработкаЗаписиНовогоОбъекта(Объект, Источник)
	
	Если ЭлементыФормы.ОсновнаяПанель.ТекущаяСтраница = ЭлементыФормы.ОсновнаяПанель.Страницы.Календарь Тогда
		Если ТипЗнч(Объект) = Тип("ДокументОбъект.Событие") ИЛИ ТипЗнч(Объект) = Тип("ДокументСсылка.Событие") Тогда
			ЗаписьДокументаСобытие();
		КонецЕсли;
	ИначеЕсли ЭлементыФормы.ОсновнаяПанель.ТекущаяСтраница = ЭлементыФормы.ОсновнаяПанель.Страницы.Почта Тогда
		Если ТипЗнч(Объект) = Тип("ДокументОбъект.ЭлектронноеПисьмо") ИЛИ ТипЗнч(Объект) = Тип("ДокументСсылка.ЭлектронноеПисьмо") Тогда
			СписокДанныхПоПредметам.Удалить(Нрег(Объект.ПредметКонтакта));
			СписокДанныхПоПисьмам.Удалить(Объект);
			СобратьСтатистикуРассмотренностиПисем();
		КонецЕсли;
	КонецЕсли;
	
	// Независимо от текущей страницы панели
	Если ТипЗнч(Объект) = Тип("СправочникСсылка.ОформленияСтрокПисем") Тогда
		СоздатьКнопкиОформленияСтрокПисем();
	КонецЕсли;
	
КонецПроцедуры

// Обработчик события ПриПовторномОткрытии формы.
//
Процедура ПриПовторномОткрытии(СтандартнаяОбработка)
	
	ОбновитьЗаказыСобытия(Ложь);
	
	ОпределитьКонтрагентаФормы();
	
КонецПроцедуры

// Обработчик события ОбновлениеОтображения формы.
//
Процедура ОбновлениеОтображения()
	
	Если ЭлементыФормы.ОсновнаяПанель.ТекущаяСтраница.Имя = "Календарь" Тогда
		
		ЭлементыФормы.ПолеТабличногоДокументаДень.ТолькоПросмотр       = Истина;
		ЭлементыФормы.ПолеТабличногоДокументаДеньВторой.ТолькоПросмотр = Истина;
		ЭлементыФормы.ПолеТабличногоДокументаНеделя.ТолькоПросмотр     = Истина;
		
		СформироватьПредставлениеДня();
		
		СостояниеКнопокСнятияОтбора();
		СостояниеКнопкиОтбораПоТекущемуЗначению();
		
		ОбновлениеОтображенияКалендаря();
		
	ИначеЕсли ЭлементыФормы.ОсновнаяПанель.ТекущаяСтраница.Имя = "Почта" Тогда
		
		СформироватьСтрокуОтборовПисем();
		
	ИначеЕсли ЭлементыФормы.ОсновнаяПанель.ТекущаяСтраница.Имя = "Контакты" Тогда
		
		
	КонецЕсли;
	
КонецПроцедуры

// Обработчик события ПриЗакрытии формы.
//
Процедура ПриЗакрытии()
	
	// КАЛЕНДАРЬ
	
	СохранитьЗначение("ЗначениеБыстрогоВводаСобытияКалендаря", мМассивЗначенийБыстрогоСобытия);
	СохранитьЗначение("ИсторииОтборовКалендаряПользователя"  , мСписокИсторииОтбора);
	СохранитьЗначение("ИмяСтраницыКалендаря"                 , ЭлементыФормы.ПанельФормы.ТекущаяСтраница.Имя);  
	
	// ПОЧТА
	
	СохранитьЗначение("УчетнаяЗапись"                                      , УчетнаяЗапись);
	СохранитьЗначение("ПометкаКнопкиОтображенияСкрытыхПредметов"           , мКнопкаОтображатьСкрытыеПредметыПисем.Пометка);
	СохранитьЗначение("ПометкаКнопкиОтображенияСпискаПредметов"            , мОтображатьСписокПредметов);  
	СохранитьЗначение("ПометкаКнопкиРассмотренностиПоТекущемуПользователю" , мОтображатьРассмотренностиПисемТолькоПоТекущемуПользователю);
	СохранитьЗначение("ИмяСтраницыМенеджераКонтактов"                      , ЭлементыФормы.ОсновнаяПанель.ТекущаяСтраница.Имя);
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ, ВЫЗЫВАЕМЫЕ ИЗ ОБРАБОТЧИКОВ ЭЛЕМЕНТОВ ФОРМЫ

// Обработчик события ПриВыводеСтроки элемента формы ЗаказыИСобытияПредставление.
//
Процедура ЗаказыИСобытияПредставлениеПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	
	Если ТипЗнч(ДанныеСтроки.Документ) = Тип("ДокументСсылка.ЗаказПокупателя") ИЛИ ТипЗнч(ДанныеСтроки.Документ) = Тип("ДокументСсылка.ЗаказПоставщику") Тогда
	
		Если ДанныеСтроки.ВыполненностьВторойЧастиЗаказа Тогда
			Если ТипЗнч(ДанныеСтроки.ВидОперации) = Тип("ПеречислениеСсылка.ВидыДействийПоЗаказамПокупателей") Тогда
				Если ДанныеСтроки.ВидОперации = Перечисления.ВидыДействийПоЗаказамПокупателей.ОтгрузкаПоЗаказу Тогда
					ОформлениеСтроки.ЦветФона = WebЦвета.НейтральноЗеленый;
				Иначе
					ОформлениеСтроки.ЦветФона = WebЦвета.ТусклоРозовый;
				КонецЕсли;
			ИначеЕсли ТипЗнч(ДанныеСтроки.ВидОперации) = Тип("ПеречислениеСсылка.ВидыДействийПоЗаказамПоставщикам") Тогда
				Если ДанныеСтроки.ВидОперации = Перечисления.ВидыДействийПоЗаказамПоставщикам.ОплатаПоЗаказу Тогда
					ОформлениеСтроки.ЦветФона = WebЦвета.НейтральноЗеленый;
				Иначе
					ОформлениеСтроки.ЦветФона = WebЦвета.ТусклоРозовый;
				КонецЕсли;
			Иначе
				ОформлениеСтроки.ЦветФона = Новый Цвет;
			КонецЕсли; 
		Иначе
			ОформлениеСтроки.ЦветФона = Новый Цвет;
		КонецЕсли; 
	
	КонецЕсли; 
	
	ОформлениеСтроки.Ячейки.Состояние.ОтображатьТекст = Ложь;
	ОформлениеСтроки.Ячейки.Состояние.ОтображатьФлажок = Ложь;
	ОформлениеСтроки.Ячейки.Состояние.ОтображатьКартинку = Истина;
	Если ДанныеСтроки.Состояние = Перечисления.СостоянияСобытий.Запланировано Тогда
		Если ТипЗнч(ДанныеСтроки.Документ) = Тип("ДокументСсылка.Событие") Тогда
			ОформлениеСтроки.Ячейки.Состояние.ИндексКартинки = 6;
		Иначе
			ОформлениеСтроки.Ячейки.Состояние.ИндексКартинки = 2;
		КонецЕсли; 
	ИначеЕсли ДанныеСтроки.Состояние = Перечисления.СостоянияСобытий.Отменено Тогда
		Если ТипЗнч(ДанныеСтроки.Документ) = Тип("ДокументСсылка.Событие") Тогда
			ОформлениеСтроки.Ячейки.Состояние.ИндексКартинки = 5;
		Иначе
			ОформлениеСтроки.Ячейки.Состояние.ИндексКартинки = 3;
		КонецЕсли; 
	ИначеЕсли ДанныеСтроки.Состояние = Перечисления.СостоянияСобытий.Завершено Тогда
		Если ТипЗнч(ДанныеСтроки.Документ) = Тип("ДокументСсылка.Событие") Тогда
			ОформлениеСтроки.Ячейки.Состояние.ИндексКартинки = 4;
		Иначе
			ОформлениеСтроки.Ячейки.Состояние.ИндексКартинки = 0;
		КонецЕсли; 
	ИначеЕсли ДанныеСтроки.Состояние.Пустая() Тогда
		Если ТипЗнч(ДанныеСтроки.Документ) = Тип("ДокументСсылка.Событие") Тогда
			ОформлениеСтроки.Ячейки.Состояние.ИндексКартинки = 3;
		Иначе
			ОформлениеСтроки.Ячейки.Состояние.ИндексКартинки = 1;
		КонецЕсли; 
	Иначе
		ОформлениеСтроки.Ячейки.Состояние.ИндексКартинки = 3;
	КонецЕсли; 
	
	ОформлениеСтроки.Ячейки.Важность.ОтображатьТекст = Ложь;
	ОформлениеСтроки.Ячейки.Важность.ОтображатьФлажок = Ложь;
	ОформлениеСтроки.Ячейки.Важность.ОтображатьКартинку = Истина;
	Если ДанныеСтроки.Важность = Перечисления.Важность.Высокая Тогда
		ОформлениеСтроки.Ячейки.Важность.ИндексКартинки = 0;
	ИначеЕсли ДанныеСтроки.Важность = Перечисления.Важность.Низкая Тогда
		ОформлениеСтроки.Ячейки.Важность.ИндексКартинки = 1;
	Иначе
		ОформлениеСтроки.Ячейки.Важность.Картинка = Новый Картинка;
	КонецЕсли; 
	
	Если НЕ ДанныеСтроки.ВидОперации.Пустая() И ТипЗнч(ДанныеСтроки.ВидОперации) = Тип("ПеречислениеСсылка.ВидыСобытий") Тогда
		ОформлениеСтроки.Ячейки.ВидОперации.ОтображатьФлажок   = Ложь;
		ОформлениеСтроки.Ячейки.ВидОперации.ОтображатьКартинку = Истина;
		ОформлениеСтроки.Ячейки.ВидОперации.ИндексКартинки     = УправлениеКонтактами.ОпределитьИндексКартинкиВидаСобытия(ДанныеСтроки.ВидОперации,ДанныеСтроки.Тип);
	ИначеЕсли ДанныеСтроки.ВидОперации = Перечисления.ВидыДействийПоЗаказамПокупателей.ОтгрузкаПоЗаказу Тогда
		ОформлениеСтроки.Ячейки.ВидОперации.ОтображатьФлажок   = Ложь;
		ОформлениеСтроки.Ячейки.ВидОперации.ОтображатьКартинку = Истина;
		ОформлениеСтроки.Ячейки.ВидОперации.ИндексКартинки     = 18;
	ИначеЕсли ДанныеСтроки.ВидОперации = Перечисления.ВидыДействийПоЗаказамПокупателей.ОплатаПоЗаказу Тогда
		ОформлениеСтроки.Ячейки.ВидОперации.ОтображатьФлажок   = Ложь;
		ОформлениеСтроки.Ячейки.ВидОперации.ОтображатьКартинку = Истина;
		ОформлениеСтроки.Ячейки.ВидОперации.ИндексКартинки     = 19;
	ИначеЕсли ДанныеСтроки.ВидОперации = Перечисления.ВидыДействийПоЗаказамПоставщикам.ПоступлениеПоЗаказу Тогда
		ОформлениеСтроки.Ячейки.ВидОперации.ОтображатьФлажок   = Ложь;
		ОформлениеСтроки.Ячейки.ВидОперации.ОтображатьКартинку = Истина;
		ОформлениеСтроки.Ячейки.ВидОперации.ИндексКартинки     = 22;
	ИначеЕсли ДанныеСтроки.ВидОперации = Перечисления.ВидыДействийПоЗаказамПоставщикам.ОплатаПоЗаказу Тогда
		ОформлениеСтроки.Ячейки.ВидОперации.ОтображатьФлажок   = Ложь;
		ОформлениеСтроки.Ячейки.ВидОперации.ОтображатьКартинку = Истина;
		ОформлениеСтроки.Ячейки.ВидОперации.ИндексКартинки     = 23;
	Иначе
		ОформлениеСтроки.Ячейки.ВидОперации.ОтображатьФлажок   = Ложь;
		ОформлениеСтроки.Ячейки.ВидОперации.ОтображатьКартинку = Ложь;
	КонецЕсли;
	
	Если ДанныеСтроки.ДатаСобытия < НачалоДня(ТекущаяДата()) Тогда
		ОформлениеСтроки.ЦветТекста = WebЦвета.ТемноКрасный;
	ИначеЕсли ДанныеСтроки.ДатаСобытия > КонецДня(ТекущаяДата()) Тогда
		ОформлениеСтроки.ЦветТекста = WebЦвета.Серый;
	КонецЕсли;
	
	Если ТипЗнч(ДанныеСтроки.Контрагент) = Тип("Строка") Тогда
		ОформлениеСтроки.Ячейки.Контрагент.Шрифт      = Новый Шрифт(,, Истина);
		ОформлениеСтроки.Ячейки.Контрагент.ЦветТекста = WebЦвета.ТемноСиний;
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события ПриАктивизацииСтроки элемента формы ЗаказыИСобытияПредставление.
//
Процедура ЗаказыИСобытияПредставлениеПриАктивизацииСтроки(Элемент)
	
	КнопкаРодитель = ЭлементыФормы.КоманднаяПанельСписка.Кнопки.ВводНаОсновании;
	КнопкаРодитель.Кнопки.Очистить();
	
	Если Элемент.ТекущиеДанные <> Неопределено Тогда
		СписокДокументов = НайтиДокументыДляОснования(Элемент.ТекущиеДанные.Документ.Метаданные().Имя);
		Для каждого Элементы Из СписокДокументов Цикл
			Кнопка = КнопкаРодитель.Кнопки.Добавить(Элементы.Значение, ТипКнопкиКоманднойПанели.Действие, Элементы.Представление, Новый Действие("ВводНаОсновании"));
			Кнопка.Картинка = мБиблиотекаКартинокДокумент;
		КонецЦикла;
		Если ТипЗнч(Элемент.ТекущиеДанные.Документ) = Тип("ДокументСсылка.Событие") Тогда
			ЭлементыФормы.КоманднаяПанельСписка.Кнопки.Подменю.Кнопки.АнализЗаказа.Доступность      = Ложь;
			ЭлементыФормы.КоманднаяПанельСписка.Кнопки.Подменю.Кнопки.ДокументыПоЗаказу.Доступность = Ложь;
		Иначе
			ЭлементыФормы.КоманднаяПанельСписка.Кнопки.Подменю.Кнопки.АнализЗаказа.Доступность      = Истина;
			ЭлементыФормы.КоманднаяПанельСписка.Кнопки.Подменю.Кнопки.ДокументыПоЗаказу.Доступность = Истина;
		КонецЕсли;
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события ПриАктивизацииЯчейки элемента формы ЗаказыИСобытияПредставление.
//
Процедура ЗаказыИСобытияПредставлениеПриАктивизацииЯчейки(Элемент)
	
	Доступность = Ложь;
	
	Если Элемент.ТекущиеДанные <> Неопределено Тогда
		
		ТекКолонка = Элемент.ТекущаяКолонка;
		
		Если ТекКолонка <> Элемент.Колонки.Информация И ТекКолонка <> Элемент.Колонки.Состояние Тогда
			
			Доступность = Истина;
			
		КонецЕсли; 
		
	КонецЕсли; 
	
	ЭлементыФормы.КоманднаяПанельСписка.Кнопки.ОтборПоТекущемуЗначению.Доступность = Доступность;
	
	СостояниеКнопкиОтбораПоТекущемуЗначению();
	
КонецПроцедуры

// Обработчик события ПередНачаломДобавления элемента формы ЗаказыИСобытияПредставление.
//
Процедура ЗаказыИСобытияПредставлениеПередНачаломДобавления(Элемент, Отказ, Копирование)
	
	Отказ = Истина;
	
	Если Копирование Тогда
		Если Элемент.ТекущиеДанные <> Неопределено И НЕ Элемент.ТекущиеДанные.Документ.Пустая() Тогда
			Элемент.ТекущиеДанные.Документ.Скопировать().ПолучитьФорму(,ЭтаФорма).Открыть();
		КонецЕсли;
	Иначе
		СписокВыбора = Новый СписокЗначений;
		Для каждого ВидСобытия Из Перечисления.ВидыСобытий Цикл
			СписокВыбора.Добавить(ВидСобытия, Строка(ВидСобытия));
		КонецЦикла; 
		СписокВыбора.Добавить("ЗаказПокупателя", "Заказ покупателя");
		СписокВыбора.Добавить("ЗаказПоставщику", "Заказ поставщику");
		
		Если Элемент.ТекущиеДанные <> Неопределено И НЕ Элемент.ТекущиеДанные.Документ.Пустая() Тогда
			Если ТипЗнч(Элемент.ТекущиеДанные.Документ) = Тип("ДокументСсылка.Событие") Тогда
				ЗначенияПоискаВСписке = Элемент.ТекущиеДанные.Документ.ВидСобытия;
			Иначе
				ЗначенияПоискаВСписке = Элемент.ТекущиеДанные.Документ.Метаданные().Имя;
			КонецЕсли; 
		КонецЕсли;
		
		НайденныйЭлементСписка = СписокВыбора.НайтиПоЗначению(ЗначенияПоискаВСписке);
		
		ВыбранныйЭлемент = СписокВыбора.ВыбратьЭлемент("Выберите тип документа", НайденныйЭлементСписка);
		
		Если ВыбранныйЭлемент <> Неопределено Тогда
			
			Если ТипЗнч(ВыбранныйЭлемент.Значение) = Тип("Строка") Тогда
				
				НовыйОбъект = Документы[ВыбранныйЭлемент.Значение].СоздатьДокумент();
				НовыйОбъект.Ответственный = ПользовательКалендаря;
				ФормаОбъекта = НовыйОбъект.ПолучитьФорму(,ЭтаФорма);
				ФормаОбъекта.Открыть();
				
			Иначе
				
				Док = Документы.Событие.СоздатьДокумент();
				Док.Ответственный   = ПользовательКалендаря;
				Док.ВидСобытия      = ВыбранныйЭлемент.Значение;
				
				// Тип события
				ЭлементОтбора = СтруктураОтборов.Получить("Тип");
				Если ЭлементОтбора <> Неопределено Тогда
					Если ЭлементОтбора[0] = ВидСравнения.Равно Тогда
						Док.ТипСобытия = ЭлементОтбора[1];
					КонецЕсли; 
				КонецЕсли;
				
				// Важность
				ЭлементОтбора = СтруктураОтборов.Получить("Важность");
				Если ЭлементОтбора <> Неопределено Тогда
					Если ЭлементОтбора[0] = ВидСравнения.Равно Тогда
						Док.Важность = ЭлементОтбора[1];
					КонецЕсли; 
				КонецЕсли;
				
				ФормаСобытия = Док.ПолучитьФорму(,ЭтаФорма);
				ФормаСобытия.Открыть();
				
			КонецЕсли; 
			
		КонецЕсли; 
		
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события ПередНачаломИзменения элемента формы ЗаказыИСобытияПредставление.
//
Процедура ЗаказыИСобытияПредставлениеПередНачаломИзменения(Элемент, Отказ)
	
	Отказ = Истина;
	Если Элемент.ТекущиеДанные <> Неопределено И НЕ Элемент.ТекущиеДанные.Документ.Пустая() Тогда
		Элемент.ТекущиеДанные.Документ.ПолучитьФорму(,ЭтаФорма).Открыть();
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события ПередУдалением элемента формы ЗаказыИСобытияПредставление.
//
Процедура ЗаказыИСобытияПредставлениеПередУдалением(Элемент, Отказ)
	
	Отказ = Истина;
	
	Если Элемент.ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли; 
	
	ОтветНаВопрос = Вопрос("Пометить объект на удаление?", РежимДиалогаВопрос.ДаНет);
	Если ОтветНаВопрос <> КодВозвратаДиалога.Да Тогда
		Возврат;
	КонецЕсли;
	
	Объект = Элемент.ТекущиеДанные.Документ.ПолучитьОбъект();
	Попытка
		Объект.УстановитьПометкуУдаления(Истина);
	Исключение
		ОбщегоНазначения.СообщитьОбОшибке(ОписаниеОшибки());
		Возврат;
	КонецПопытки;
	
	ЗаписьДокументаСобытие();
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ ВЫЗЫВАЕМЫЕ ПО НАЖАТИЮ КНОПОК КОМАНДНОЙ ПАНЕЛИ ФОРМЫ

// Обработчик события элемента КоманднаяПанельСписка.Интервал.
//
Процедура КоманднаяПанельСпискаИнтервал(Кнопка)
	
	МассивПериода = УправлениеОтчетами.ВвестиПериод(ДатаНач, ДатаКон);
	
	Если МассивПериода = Неопределено Тогда
		Возврат;
	КонецЕсли; 
	
	ДатаНач = МассивПериода[0];
	ДатаКон = МассивПериода[1];
	
	ОбновитьЗаказыСобытия(Ложь);
	
КонецПроцедуры

// Обработчик события элемента КоманднаяПанельСписка.СнятьОтбор.
//
Процедура КоманднаяПанельСпискаСнятьОтбор(Кнопка)
	
	СтруктураОтборов.Удалить("Контрагент");
	СтруктураОтборов.Удалить("КонтактноеЛицо");
	СтруктураОтборов.Удалить("Важность");
	СтруктураОтборов.Удалить("Тип");
	СтруктураОтборов.Удалить("ТипДокумента");
	СтруктураОтборов.Удалить("Номер");
	СтруктураОтборов.Удалить("ВидОперации");
	СтруктураОтборов.Удалить("ДатаСобытия");
	
	ДатаНач = Дата("00010101000000");
	ДатаКон = Дата("00010101000000");
	
	ОбновитьЗаказыСобытия(Ложь);
	ОпределитьКонтрагентаФормы();
	
КонецПроцедуры

// Обработчик события элемента КоманднаяПанельСписка.ОтборПоТекущемуКонтрагенту.
//
Процедура КоманднаяПанельСпискаОтборПоТекущемуЗначению(Кнопка)
	
	Если Кнопка.Пометка Тогда
		
		ИмяКолонки = ЭлементыФормы.ЗаказыИСобытияПредставление.ТекущаяКолонка.Имя;
		
		Если ИмяКолонки = "ДатаДокумента" Тогда
			
			ДатаНач = Дата("00010101000000");
			ДатаКон = Дата("00010101000000");
			
		Иначе
			
			ИмяОтбора = ИмяКолонки;
			
			СтруктураОтборов.Удалить(ИмяОтбора);
			
		КонецЕсли;
		
	Иначе
		
		ИмяКолонки = ЭлементыФормы.ЗаказыИСобытияПредставление.ТекущаяКолонка.Имя;
		
		Если ИмяКолонки = "ДатаДокумента" Тогда
			
			ЗначениеОтбора = ЭлементыФормы.ЗаказыИСобытияПредставление.ТекущиеДанные[ИмяКолонки];
			
			ДатаНач = НачалоДня(ЗначениеОтбора);
			ДатаКон = КонецДня(ЗначениеОтбора);
			
		ИначеЕсли ИмяКолонки = "ДатаСобытия" Тогда
			
			ЗначениеОтбора = ЭлементыФормы.ЗаказыИСобытияПредставление.ТекущиеДанные[ИмяКолонки];
			
			МассивОтбора = Новый Массив;
			МассивОтбора.Добавить(ВидСравнения.Равно);
			МассивОтбора.Добавить(ЗначениеОтбора);
			МассивОтбора.Добавить(ЗначениеОтбора);
			СтруктураОтборов.Вставить("ДатаСобытия",МассивОтбора);
			
		ИначеЕсли ИмяКолонки = "ВидДокумента" Тогда
			
			ЗначениеОтбора = ЭлементыФормы.ЗаказыИСобытияПредставление.ТекущиеДанные.Документ;
			масТипов = Новый Массив;
			масТипов.Добавить(ТипЗнч(ЗначениеОтбора));
			описТипов = Новый ОписаниеТипов(масТипов);
			
			МассивОтбора = Новый Массив;
			МассивОтбора.Добавить(ВидСравнения.Равно);
			МассивОтбора.Добавить(описТипов);
			СтруктураОтборов.Вставить("ТипДокумента",МассивОтбора);
			
		Иначе
			
			МассивОтбора = Новый Массив;
			
			ИмяОтбора = ИмяКолонки;
			ЗначениеОтбора = ЭлементыФормы.ЗаказыИСобытияПредставление.ТекущиеДанные[ИмяКолонки];
			МассивОтбора.Добавить(ВидСравнения.Равно);
			
			Если ЗначениеОтбора = Неопределено Тогда
				
				Возврат;
				
			КонецЕсли; 
			
			МассивОтбора.Добавить(ЗначениеОтбора);
			СтруктураОтборов.Вставить(ИмяОтбора,МассивОтбора);
			
		КонецЕсли;
		
	КонецЕсли; 
	
	Кнопка.Пометка = НЕ Кнопка.Пометка;
	
	ОбновитьЗаказыСобытия(Ложь);
	ДобавитьНовыйОтборВИсторию();
	ОпределитьКонтрагентаФормы();
	СостояниеКнопокОтбораПоВидуДокумента();
	
КонецПроцедуры

// Обработчик события элемента КоманднаяПанельСписка.Отборы.
//
Процедура КоманднаяПанельСпискаОтборы(Кнопка)
	
	ФормаОтбора = ПолучитьФорму("ФормаОтборов", ЭтаФорма);
	ФормаОтбора.ОткрытьМодально();
	
	ОпределитьКонтрагентаФормы();
	ДобавитьНовыйОтборВИсторию();
	СостояниеКнопокОтбораПоВидуДокумента();
	
КонецПроцедуры

// Обработчик события ПриИзменении элемента ПолеКалендаря.
//
Процедура ПолеКалендаряПриИзменении(Элемент)
	
	Если ДатаКалендаря <> мДатаКалендаря Тогда
		
		мДатаКалендаря = ДатаКалендаря;
		ПриИзмененииДатыКалендаря(Элемент);
		
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события ПриИзменении элемента ПолеКалендаряНеделя.
//
Процедура ПолеКалендаряНеделяПриИзменении(Элемент)
	
	Если ДатаКалендаря <> мДатаКалендаря Тогда
		
		мДатаКалендаря = ДатаКалендаря;
		ПриИзмененииДатыКалендаря(Элемент);
		
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события ОбработкаРасшифровки элемента ПолеТабличногоДокументаДень.
//
Процедура ПолеТабличногоДокументаДеньОбработкаРасшифровки(Элемент, Расшифровка, СтандартнаяОбработка)
	
	Если ТипЗнч(Расшифровка) = Тип("ДокументСсылка.Событие") Тогда
		СтандартнаяОбработка = Ложь;
		Расшифровка.ПолучитьФорму(,ЭтаФорма).Открыть();
	ИначеЕсли ТипЗнч(Расшифровка) = Тип("Структура") Тогда
		СтандартнаяОбработка = Ложь;
		Если Расшифровка.Действие = "Раскрыть" Тогда
			
			ЗапомнимСмещениеОтНачалаПервойЯчейкиДня = СмещениеОтНачалаПервойЯчейкиДня;
			ЗапомнимНомерПоследнейЯчейкиДня         = НомерПоследнейЯчейкиДня;
			
			Если Расшифровка.Направление = "Верх" Тогда
				СмещениеОтНачалаПервойЯчейкиДня = ВерхняяСтрокаНевидимойОбластиДня-1;
				СмещениеОтНачалаПервойЯчейкиДня = Цел((СмещениеОтНачалаПервойЯчейкиДня-1)/2)*2;
			Иначе
				НомерПоследнейЯчейкиДня         = НижняяСтрокаНевидимойОбластиДня;
				НомерПоследнейЯчейкиДня         = Цел((НомерПоследнейЯчейкиДня+1)/2)*2;
			КонецЕсли;
			
			ОбновитьКалендарьДня();
			
			СмещениеОтНачалаПервойЯчейкиДня = ЗапомнимСмещениеОтНачалаПервойЯчейкиДня;
			НомерПоследнейЯчейкиДня         = ЗапомнимНомерПоследнейЯчейкиДня;
			
		КонецЕсли;
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события ОбработкаРасшифровки элемента ПолеТабличногоДокументаДеньВторой.
//
Процедура ПолеТабличногоДокументаДеньВторойОбработкаРасшифровки(Элемент, Расшифровка, СтандартнаяОбработка)
	
	Если ТипЗнч(Расшифровка) = Тип("ДокументСсылка.Событие") Тогда
		СтандартнаяОбработка = Ложь;
		Расшифровка.ПолучитьФорму(,ЭтаФорма).Открыть();
	ИначеЕсли ТипЗнч(Расшифровка) = Тип("Структура") Тогда
		СтандартнаяОбработка = Ложь;
		Если Расшифровка.Действие = "Раскрыть" Тогда
			
			ЗапомнимСмещениеОтНачалаПервойЯчейкиДня = СмещениеОтНачалаПервойЯчейкиДня;
			ЗапомнимНомерПоследнейЯчейкиДня         = НомерПоследнейЯчейкиДня;
			
			Если Расшифровка.Направление = "Верх" Тогда
				СмещениеОтНачалаПервойЯчейкиДня = ВерхняяСтрокаНевидимойОбластиДня-1;
				СмещениеОтНачалаПервойЯчейкиДня = Цел((СмещениеОтНачалаПервойЯчейкиДня-1)/2)*2;
			Иначе
				НомерПоследнейЯчейкиДня         = НижняяСтрокаНевидимойОбластиДня;
				НомерПоследнейЯчейкиДня         = Цел((НомерПоследнейЯчейкиДня+1)/2)*2;
			КонецЕсли;
			
			ОбновитьКалендарьДня();
			
			СмещениеОтНачалаПервойЯчейкиДня = ЗапомнимСмещениеОтНачалаПервойЯчейкиДня;
			НомерПоследнейЯчейкиДня         = ЗапомнимНомерПоследнейЯчейкиДня;
			
		КонецЕсли;
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события ОбработкаРасшифровки элемента ПолеТабличногоДокументаМесяц.
//
Процедура ПолеТабличногоДокументаМесяцОбработкаРасшифровки(Элемент, Расшифровка, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	Если ТипЗнч(Расшифровка) = Тип("Дата") Тогда
		ДатаКалендаря = НачалоДня(Расшифровка);
		ПерейтиККалендарю("День");
	КонецЕсли;
	
КонецПроцедуры

// Обработчик события ОбработкаРасшифровки элемента ПолеТабличногоДокументаНеделя.
//
Процедура ПолеТабличногоДокументаНеделяОбработкаРасшифровки(Элемент, Расшифровка, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	Если ТипЗнч(Расшифровка) = Тип("Дата") Тогда
		
		ДатаКалендаря = НачалоДня(Расшифровка);
		ПерейтиККалендарю("День");
		
	ИначеЕсли ТипЗнч(Расшифровка) = Тип("ДокументСсылка.Событие") Тогда
		
		СтандартнаяОбработка = Ложь;
		
		Расшифровка.ПолучитьФорму(,ЭтаФорма).Открыть();
		
	ИначеЕсли ТипЗнч(Расшифровка) = Тип("Структура") Тогда
		СтандартнаяОбработка = Ложь;
		Если Расшифровка.Действие = "Раскрыть" Тогда
			
			ЗапомнимСмещениеОтНачалаПервойЯчейкиДня = СмещениеОтНачалаПервойЯчейкиДня;
			ЗапомнимНомерПоследнейЯчейкиДня         = НомерПоследнейЯчейкиДня;
			ЗапомнимНомерПоследнейЯчейкиНедели      = НомерПоследнейЯчейкиНедели;
			
			Если Расшифровка.Направление = "Верх" Тогда
				СмещениеОтНачалаПервойЯчейкиДня = ВерхняяСтрокаНевидимойОбластиНедели-2;
				СмещениеОтНачалаПервойЯчейкиДня = Цел((СмещениеОтНачалаПервойЯчейкиДня+1)/2)*2;
				НомерПоследнейЯчейкиНедели      = НомерПоследнейЯчейкиДня-СмещениеОтНачалаПервойЯчейкиДня + 2;
			Иначе
				НомерПоследнейЯчейкиНедели      = НижняяСтрокаНевидимойОбластиНедели+2-СмещениеОтНачалаПервойЯчейкиДня;
				НомерПоследнейЯчейкиНедели      = Цел((НомерПоследнейЯчейкиНедели+1)/2)*2;
			КонецЕсли;
			
			ОбновитьКалендарьНеделя();
			
			СмещениеОтНачалаПервойЯчейкиДня = ЗапомнимСмещениеОтНачалаПервойЯчейкиДня;
			НомерПоследнейЯчейкиДня         = ЗапомнимНомерПоследнейЯчейкиДня;
			НомерПоследнейЯчейкиНедели      = ЗапомнимНомерПоследнейЯчейкиНедели;
			
		КонецЕсли;
		
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события ПриАктивизацииОбласти элемента ПолеТабличногоДокументаНеделя.
//
Процедура ПолеТабличногоДокументаНеделяПриАктивизацииОбласти(Элемент)
	
	Если ТипЗнч(Элемент.ТекущаяОбласть) = Тип("РисунокТабличногоДокумента") Тогда
		Возврат;
	КонецЕсли;
	
	Если ТипЗнч(Элемент.ТекущаяОбласть) <> Тип("ОбластьЯчеекТабличногоДокумента") Тогда
		
		Расшифровка = Элемент.ТекущаяОбласть.Расшифровка;
		Если ТипЗнч(Элемент.ТекущаяОбласть.Расшифровка) = Тип("ДокументСсылка.Событие") Тогда
			Расшифровка.ПолучитьФорму(,ЭтаФорма).Открыть();
		КонецЕсли; 
	КонецЕсли; 
	
	Расшифровка = ПолучитьРасшифровкуТекущейОбласти();
	Если НЕ ЗначениеЗаполнено(Расшифровка) Тогда  
		ЭлементыФормы.ПолеТабличногоДокументаНеделя.КонтекстноеМеню.Кнопки.ИзменитьСобытие.Доступность = Ложь; 
		ЭлементыФормы.ПолеТабличногоДокументаНеделя.КонтекстноеМеню.Кнопки.ИзменитьВремя.Доступность = Ложь;
		ЭлементыФормы.ПолеТабличногоДокументаНеделя.КонтекстноеМеню.Кнопки.ПометитьКакЗавершено.Доступность = Ложь;
		ЭлементыФормы.ПолеТабличногоДокументаНеделя.КонтекстноеМеню.Кнопки.ПометитьКакОтменено.Доступность = Ложь;
	Иначе
		ЭлементыФормы.ПолеТабличногоДокументаНеделя.КонтекстноеМеню.Кнопки.ИзменитьСобытие.Доступность = Истина;
		ЭлементыФормы.ПолеТабличногоДокументаНеделя.КонтекстноеМеню.Кнопки.ИзменитьВремя.Доступность = Истина;
		ЭлементыФормы.ПолеТабличногоДокументаНеделя.КонтекстноеМеню.Кнопки.ПометитьКакЗавершено.Доступность = Истина;
		ЭлементыФормы.ПолеТабличногоДокументаНеделя.КонтекстноеМеню.Кнопки.ПометитьКакОтменено.Доступность = Истина;
	КонецЕсли;

КонецПроцедуры

// Обработчик события Нажатие элемента КоманднаяПанельФормы.Список.
//
Процедура КоманднаяПанельФормыСписок(Кнопка)
	
	УстановитьЗакладку(Кнопка.Имя);
	
КонецПроцедуры

// Обработчик события Нажатие элемента КоманднаяПанельФормы.День.
//
Процедура КоманднаяПанельФормыДень(Кнопка)
	
	УстановитьЗакладку(Кнопка.Имя);
	
	ДоступностьКнопокКоманднойПанели_СделкиДень();
	
КонецПроцедуры

// Обработчик события Нажатие элемента КоманднаяПанельФормы.Неделя.
//
Процедура КоманднаяПанельФормыНеделя(Кнопка)
	
	УстановитьЗакладку(Кнопка.Имя);
	
КонецПроцедуры

// Обработчик события Нажатие элемента КоманднаяПанельФормы.Месяц.
//
Процедура КоманднаяПанельФормыМесяц(Кнопка)
	
	УстановитьЗакладку(Кнопка.Имя);
	
КонецПроцедуры

// Обработчик события Нажатие элемента КоманднаяПанельДень.КнопкаДеньНазад.
//
Процедура КнопкаДеньНазадНажатие(Кнопка)
	
	ДатаКалендаря = НачалоДня(НачалоДня(ДатаКалендаря) - 1);
	ПерейтиККалендарю("День");
	
КонецПроцедуры

// Обработчик события Нажатие элемента КоманднаяПанельДень.КнопкаДеньВперед.
//
Процедура КнопкаДеньВпередНажатие(Кнопка)
	
	ДатаКалендаря = НачалоДня(НачалоДня(ДатаКалендаря) + (60*60*24 + 1));
	ПерейтиККалендарю("День");
	
КонецПроцедуры

// Обработчик события Нажатие элемента КоманднаяПанельНеделя.КнопкаНеделяНазад.
//
Процедура КнопкаНеделяНазадНажатие(Кнопка)
	
	ДатаКалендаря = НачалоДня(НачалоДня(ДатаКалендаря) - 60*60*24*7);
	ПерейтиККалендарю("Неделя");
	
КонецПроцедуры

// Обработчик события Нажатие элемента КоманднаяПанельНеделя.КнопкаНеделяВперед.
//
Процедура КнопкаНеделяВпередНажатие(Кнопка)
	
	ДатаКалендаря = НачалоДня(НачалоДня(ДатаКалендаря) + 60*60*24*7);
	ПерейтиККалендарю("Неделя");
	
КонецПроцедуры

// Обработчик события Нажатие элемента КоманднаяПанельМесяцВспомогательная.КнопкаМесяцНазад.
//
Процедура КнопкаМесяцНазадНажатие(Кнопка)
	
	ДатаКалендаря = НачалоДня(ДобавитьМесяц(ДатаКалендаря, -1));
	ДатаНачалаНедели = НачалоНедели(ДатаКалендаря);
	
	Если ДатаКалендаря <> мДатаКалендаря Тогда
		
		мДатаКалендаря = ДатаКалендаря;
		
		ДатаНачалаМесяцаЗапроса = НачалоМесяца(ДатаКалендаря);
		ОбновитьМесяц[0] = Истина;
		ОбновитьНеделю[0] = Истина;
		ОбновитьДень[0] = Истина;
		
		ОбновитьИнформациюНаФорме();
		
	КонецЕсли;
	
КонецПроцедуры

// Обработчик события Нажатие элемента КоманднаяПанельМесяцВспомогательная.КнопкаМесяцВперед.
//
Процедура КнопкаМесяцВпередНажатие(Кнопка)
	
	ДатаКалендаря = НачалоДня(ДобавитьМесяц(ДатаКалендаря, 1));
	ДатаНачалаНедели = НачалоНедели(ДатаКалендаря);
	
	Если ДатаКалендаря <> мДатаКалендаря Тогда
		
		мДатаКалендаря = ДатаКалендаря;
		
		ДатаНачалаМесяцаЗапроса = НачалоМесяца(ДатаКалендаря);
		ОбновитьМесяц[0] = Истина;
		ОбновитьНеделю[0] = Истина;
		ОбновитьДень[0] = Истина;
		
		ОбновитьИнформациюНаФорме();
		
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события Нажатие элемента КоманднаяПанельФормыДополнительно.Обновить.
//
Процедура КоманднаяПанельФормыДополнительноОбновить(Кнопка)
	
	Если ЭлементыФормы.ПанельФормы.ТекущаяСтраница = ЭлементыФормы.ПанельФормы.Страницы.Список Тогда
		ОбновитьТаблицуСписка();
	ИначеЕсли ЭлементыФормы.ПанельФормы.ТекущаяСтраница = ЭлементыФормы.ПанельФормы.Страницы.День Тогда
		ОбновитьКалендарьДня();
	ИначеЕсли ЭлементыФормы.ПанельФормы.ТекущаяСтраница = ЭлементыФормы.ПанельФормы.Страницы.Неделя Тогда
		ОбновитьКалендарьНеделя();
	ИначеЕсли ЭлементыФормы.ПанельФормы.ТекущаяСтраница = ЭлементыФормы.ПанельФормы.Страницы.Месяц Тогда
		ОбновитьКалендарьМесяц();
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события ПриАктивизацииОбласти элемента ПолеТабличногоДокументаДеньВторой.
//
Процедура ПолеТабличногоДокументаДеньВторойПриАктивизацииОбласти(Элемент)
	
	Если ТипЗнч(Элемент.ТекущаяОбласть) <> Тип("ОбластьЯчеекТабличногоДокумента") Тогда
		Расшифровка = Элемент.ТекущаяОбласть.Расшифровка;
		Если ТипЗнч(Элемент.ТекущаяОбласть.Расшифровка) = Тип("ДокументСсылка.Событие") Тогда
			Расшифровка.ПолучитьФорму(,ЭтаФорма).Открыть();
		КонецЕсли; 
		Элемент.ТекущаяОбласть = Элемент.Область(мИмяТекущейОбластиДвойногоДня);
	Иначе
		мИмяТекущейОбластиДвойногоДня = Элемент.ТекущаяОбласть.Имя;
	КонецЕсли; 
	
	Расшифровка = ПолучитьРасшифровкуТекущейОбласти();
	Если НЕ ЗначениеЗаполнено(Расшифровка) Тогда  
		ЭлементыФормы.ПолеТабличногоДокументаДеньВторой.КонтекстноеМеню.Кнопки.ИзменитьСобытие.Доступность = Ложь; 
		ЭлементыФормы.ПолеТабличногоДокументаДеньВторой.КонтекстноеМеню.Кнопки.ИзменитьВремя.Доступность = Ложь;
		ЭлементыФормы.ПолеТабличногоДокументаДеньВторой.КонтекстноеМеню.Кнопки.ПометитьКакЗавершено.Доступность = Ложь;
		ЭлементыФормы.ПолеТабличногоДокументаДеньВторой.КонтекстноеМеню.Кнопки.ПометитьКакОтменено.Доступность = Ложь;
	Иначе
		ЭлементыФормы.ПолеТабличногоДокументаДеньВторой.КонтекстноеМеню.Кнопки.ИзменитьСобытие.Доступность = Истина;
		ЭлементыФормы.ПолеТабличногоДокументаДеньВторой.КонтекстноеМеню.Кнопки.ИзменитьВремя.Доступность = Истина;
		ЭлементыФормы.ПолеТабличногоДокументаДеньВторой.КонтекстноеМеню.Кнопки.ПометитьКакЗавершено.Доступность = Истина;
		ЭлементыФормы.ПолеТабличногоДокументаДеньВторой.КонтекстноеМеню.Кнопки.ПометитьКакОтменено.Доступность = Истина;
	КонецЕсли;
	
КонецПроцедуры

// Обработчик события ПриАктивизацииОбласти элемента ПолеТабличногоДокументаДень.
//
Процедура ПолеТабличногоДокументаДеньПриАктивизацииОбласти(Элемент)
	
	Если ТипЗнч(Элемент.ТекущаяОбласть) <> Тип("ОбластьЯчеекТабличногоДокумента") Тогда
		Если ТипЗнч(Элемент.ТекущаяОбласть.Расшифровка) = Тип("ДокументСсылка.Событие") Тогда
			Элемент.ТекущаяОбласть.Расшифровка.ПолучитьФорму(,ЭтаФорма).Открыть();
		КонецЕсли; 
		Элемент.ТекущаяОбласть = Элемент.Область(мИмяТекущейОбластиДня);
	Иначе
		мИмяТекущейОбластиДня = Элемент.ТекущаяОбласть.Имя;
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события Нажатие элемента КнопкаВыбратьМесяц.
//
Процедура КнопкаВыбратьМесяцНажатие(Элемент)
	
	СписокМесяцев = Новый СписокЗначений;
	
	Для а = -6 По 6 Цикл
		
		Если а = 0 Тогда
			Пометка = Истина;
		Иначе
			Пометка = Ложь;
		КонецЕсли;
		
		ДатаМесяца = НачалоДня(ДобавитьМесяц(ДатаКалендаря, а));
		
		СтрокаМесяца = Формат(ДатаМесяца, "ДФ=ММММ") + " " + Формат(ДатаМесяца, "ДФ=yyyy") + " г.";
		СписокМесяцев.Добавить(ДатаМесяца, СтрокаМесяца, Пометка);
		
	КонецЦикла;
	
	ВыбранныйЭлемент = ЭтаФорма.ВыбратьИзМеню(СписокМесяцев, Элемент);
	
	Если ВыбранныйЭлемент <> Неопределено Тогда
		
		ДатаКалендаря = НачалоДня(ВыбранныйЭлемент.Значение);
		ДатаНачалаНедели = НачалоНедели(ДатаКалендаря);
		
		Если НачалоДня(ДатаКалендаря) <> НачалоДня(мДатаКалендаря) Тогда
			
			мДатаКалендаря = ДатаКалендаря;
			
			ДатаНачалаМесяцаЗапроса = НачалоМесяца(ДатаКалендаря);
			ОбновитьМесяц[0] = Истина;
			ОбновитьНеделю[0] = Истина;
			ОбновитьДень[0] = Истина;
			
			ОбновитьИнформациюНаФорме();
			
		КонецЕсли; 
		
	КонецЕсли;
	
КонецПроцедуры

// Обработчик события Выбор элемента ПолеТабличногоДокументаДень.
//
Процедура ПолеТабличногоДокументаДеньВыбор(Элемент, Область, СтандартнаяОбработка)
	
	Если НЕ ЗначениеЗаполнено(Область.Расшифровка) Тогда
		ВвестиДокументСобытиеИзМокселя();
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события Выбор элемента ПолеТабличногоДокументаДеньВторой.
//
Процедура ПолеТабличногоДокументаДеньВторойВыбор(Элемент, Область, СтандартнаяОбработка)
	
	Если НЕ ЗначениеЗаполнено(Область.Расшифровка) Тогда
		ВвестиДокументСобытиеИзМокселя();
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события Выбор элемента ПолеТабличногоДокументаНеделя.
//
Процедура ПолеТабличногоДокументаНеделяВыбор(Элемент, Область, СтандартнаяОбработка)
	
	Если НЕ ЗначениеЗаполнено(Область.Расшифровка) Тогда
		ВвестиДокументСобытиеИзМокселя();
	КонецЕсли; 
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ ВЫЗЫВАЕМЫЕ ПРИ ПЕРЕТАСКИВАНИИ В ЭЛЕМЕНТАХ УПРАВЛЕНИЯ

// Перетаскивание день

// Обработчик события НачалоПеретаскивания элемента ПолеТабличногоДокументаДень.
//
Процедура ПолеТабличногоДокументаДеньНачалоПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка)
	
	ПолеТабличногоДокументаНачалоПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка);
	
КонецПроцедуры

// Обработчик события ОкончаниеПеретаскивания элемента ПолеТабличногоДокументаДень.
//
Процедура ПолеТабличногоДокументаДеньОкончаниеПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
КонецПроцедуры

// Обработчик события Перетаскивание элемента ПолеТабличногоДокументаДень.
//
Процедура ПолеТабличногоДокументаДеньПеретаскивание(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Область)
	
	ПолеТабличногоПеретаскивание(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Область);
	
КонецПроцедуры

// Обработчик события ПроверкаПеретаскивания элемента ПолеТабличногоДокументаДень.
//
Процедура ПолеТабличногоДокументаДеньПроверкаПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Область)
	
	ПолеТабличногоДокументаПроверкаПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Область);
	
КонецПроцедуры

// Перетаскивание два дня

// Обработчик события НачалоПеретаскивания элемента ПолеТабличногоДокументаДеньВторой.
//
Процедура ПолеТабличногоДокументаДеньВторойНачалоПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка)
	
	ПолеТабличногоДокументаНачалоПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка);
	
КонецПроцедуры

// Обработчик события ПроверкаПеретаскивания элемента ПолеТабличногоДокументаДеньВторой.
//
Процедура ПолеТабличногоДокументаДеньВторойПроверкаПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Область)
	
	ПолеТабличногоДокументаПроверкаПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Область);
	
КонецПроцедуры

// Обработчик события ОкончаниеПеретаскивания элемента ПолеТабличногоДокументаДеньВторой.
//
Процедура ПолеТабличногоДокументаДеньВторойОкончаниеПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
КонецПроцедуры

// Обработчик события Перетаскивание элемента ПолеТабличногоДокументаДеньВторой.
//
Процедура ПолеТабличногоДокументаДеньВторойПеретаскивание(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Область)
	
	ПолеТабличногоПеретаскивание(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Область, Истина);
	
КонецПроцедуры

// Перетаскивание неделя

// Обработчик события НачалоПеретаскивания элемента ПолеТабличногоДокументаНеделя.
//
Процедура ПолеТабличногоДокументаНеделяНачалоПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка)
	
	ПолеТабличногоДокументаНачалоПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка);
	
КонецПроцедуры

// Обработчик события ПроверкаПеретаскивания элемента ПолеТабличногоДокументаНеделя.
//
Процедура ПолеТабличногоДокументаНеделяПроверкаПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Область)
	
	Если ТипЗнч(ПараметрыПеретаскивания.Значение.ТекущаяОбласть.Расшифровка) <> Тип("ДокументСсылка.Событие") 
		ИЛИ Область.Низ > НомерПоследнейЯчейкиНедели ИЛИ Область.Право > 84 ИЛИ Область.Лево < 3 ИЛИ Область.Верх < 3 Тогда
		СтандартнаяОбработка = Ложь;
		ПараметрыПеретаскивания.Действие = ДействиеПеретаскивания.Отмена;
	КонецЕсли;
	
КонецПроцедуры

// Обработчик события ОкончаниеПеретаскивания элемента ПолеТабличногоДокументаНеделя.
//
Процедура ПолеТабличногоДокументаНеделяОкончаниеПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
КонецПроцедуры

// Обработчик события Перетаскивание элемента ПолеТабличногоДокументаНеделя.
//
Процедура ПолеТабличногоДокументаНеделяПеретаскивание(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Область)
	
	Если ТипЗнч(ПараметрыПеретаскивания.Значение.ТекущаяОбласть.Расшифровка) <> Тип("ДокументСсылка.Событие") Тогда
		Возврат;
	КонецЕсли;
	
	СтандартнаяОбработка = Ложь;
	
	НовоеНачалоСобытия    = ОпределитьДатыОбластиНедели(Область, Истина);
	НовоеОкончаниеСобытия = ОпределитьДатыОбластиНедели(Область, Ложь);
	НовоеОкончаниеСобытия = НачалоДня(НовоеНачалоСобытия) + (НовоеОкончаниеСобытия - НачалоДня(НовоеОкончаниеСобытия));
	
	Если НовоеНачалоСобытия = ПараметрыПеретаскивания.Значение.ТекущаяОбласть.Расшифровка.НачалоСобытия
		И НовоеОкончаниеСобытия = ПараметрыПеретаскивания.Значение.ТекущаяОбласть.Расшифровка.ОкончаниеСобытия Тогда
		Возврат;
	КонецЕсли; 
	
	Если ПараметрыПеретаскивания.Действие = ДействиеПеретаскивания.Копирование Тогда
		Объект = ПараметрыПеретаскивания.Значение.ТекущаяОбласть.Расшифровка.Скопировать();
		Объект.Дата = ТекущаяДата();
	Иначе
		Объект = ПараметрыПеретаскивания.Значение.ТекущаяОбласть.Расшифровка.ПолучитьОбъект();
	КонецЕсли; 
	
	Объект.НачалоСобытия    = НовоеНачалоСобытия;
	Объект.ОкончаниеСобытия = НовоеОкончаниеСобытия;
	Попытка
		Объект.Записать(РежимЗаписиДокумента.Проведение);
	Исключение
		ОбщегоНазначения.СообщитьОбОшибке(ОписаниеОшибки());
		Возврат;
	КонецПопытки;
	
	ЗаписьДокументаСобытие();
	Элемент.ТекущаяОбласть = Область;
	
КонецПроцедуры

// Перетаскивание календарь дня

// Обработчик события Перетаскивание элемента ПолеКалендаря.
//
Процедура ПолеКалендаряПеретаскивание(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, ВыбраннаяДата)
	
	ПолеКалендаряПеретаскиваниеОбщее(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, ВыбраннаяДата);
	
КонецПроцедуры

// Обработчик события ПроверкаПеретаскивания элемента ПолеКалендаря.
//
Процедура ПолеКалендаряПроверкаПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, ВыбраннаяДата)
	
	СтандартнаяОбработка = Ложь;
	
КонецПроцедуры

// Перетаскивание календарь недели

// Обработчик события ПроверкаПеретаскивания элемента ПолеКалендаряНеделя.
//
Процедура ПолеКалендаряНеделяПроверкаПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, ВыбраннаяДата)
	
	СтандартнаяОбработка = Ложь;
	
КонецПроцедуры

// Обработчик события Перетаскивание элемента ПолеКалендаряНеделя.
//
Процедура ПолеКалендаряНеделяПеретаскивание(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, ВыбраннаяДата)
	
	ПолеКалендаряПеретаскиваниеОбщее(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, ВыбраннаяДата, Истина);
	
КонецПроцедуры

// ПОЧТА

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ

// Процедура сохраняет структуру для создания ключа
// записи регистра сведений списка предметов писем
//
Процедура СохранитьТекущийПредмет(Предмет = Неопределено)
	
	// Сохранение/Восстановление предмета необходимо, т.к. при записи нового письма
	// в тот же предмет переписывается регистр сведений, текущая строка в отображаемом
	// табличном поле предметов будет скакать, т.к. отображается срез последних
	// и ключ текущей строки становится отличным от ключа такущес строки предидущего
	// письма.
	Если ЭлементыФормы.ПредметыСписок.ТекущиеДанные <> Неопределено
		И мОтображатьСписокПредметов Тогда
		мСтруктураПредмета = Новый Структура("Предмет, ГруппаПисемЭлектроннойПочты", ?(Предмет = Неопределено, ЭлементыФормы.ПредметыСписок.ТекущиеДанные.Предмет, Предмет), ЭлементыФормы.ПредметыСписок.ТекущиеДанные.ГруппаПисемЭлектроннойПочты);
	КонецЕсли; 
	
КонецПроцедуры

// Процедура создает ключ записи регистра сведений списка предметов писем
// и устанавливает в соответствии с ним текущую строку списка писем
//
Процедура ВосстановитьТекущийПредмет()
	
	// Сохранение/Восстановление предмета необходимо, т.к. при записи нового письма
	// в тот же предмет переписывается регистр сведений, текущая строка в отображаемом
	// табличном поле предметов будет скакать, т.к. отображается срез последних
	// и ключ текущей строки становится отличным от ключа такущес строки предидущего
	// письма.
	Если ТипЗнч(мСтруктураПредмета) = Тип("Структура")
		И мОтображатьСписокПредметов
		И ((ЭлементыФормы.ПредметыСписок.ТекущиеДанные <> Неопределено И ЭлементыФормы.ПредметыСписок.ТекущиеДанные.Предмет <> мСтруктураПредмета.Предмет) ИЛИ ЭлементыФормы.ПредметыСписок.ТекущиеДанные = Неопределено)
		И ПолучитьЭлементГруппыПисемДерево().ТекущаяСтрока = мСтруктураПредмета.ГруппаПисемЭлектроннойПочты Тогда
		
		Запрос = Новый Запрос;
		
		Запрос.УстановитьПараметр("Предмет"                    , мСтруктураПредмета.Предмет);
		Запрос.УстановитьПараметр("ГруппаПисемЭлектроннойПочты", мСтруктураПредмета.ГруппаПисемЭлектроннойПочты);
		
		Запрос.Текст = "
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
		|	ПредметыЭлектронныхПисем.Период КАК Период,
		|	ПредметыЭлектронныхПисем.Регистратор,
		|	ПредметыЭлектронныхПисем.ГруппаПисемЭлектроннойПочты,
		|	ПредметыЭлектронныхПисем.Предмет
		|ИЗ
		|	РегистрСведений.ПредметыЭлектронныхПисем КАК ПредметыЭлектронныхПисем
		|
		|ГДЕ
		|	ПредметыЭлектронныхПисем.Предмет = &Предмет И
		|	ПредметыЭлектронныхПисем.ГруппаПисемЭлектроннойПочты = &ГруппаПисемЭлектроннойПочты
		|
		|УПОРЯДОЧИТЬ ПО
		|	Период УБЫВ
		|";
		
		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			
			ЭлементыФормы.ПредметыСписок.ТекущаяСтрока = РегистрыСведений.ПредметыЭлектронныхПисем.СоздатьКлючЗаписи(Новый Структура("Регистратор,
			|Период,
			|ГруппаПисемЭлектроннойПочты,
			|Предмет",
			Выборка.Регистратор,
			Выборка.Период,
			Выборка.ГруппаПисемЭлектроннойПочты,
			Выборка.Предмет));
			
		КонецЕсли; 
		
	КонецЕсли;
	
	мСтруктураПредмета = Неопределено;
	
КонецПроцедуры

// Процедура управляет режимом отображения скрытых предметов.
//
Процедура УстановитьОтборСкрытыхПредметов()
	
	ПредметыСписок.Отбор.Скрытый.Значение = Ложь;
	ПредметыСписок.Отбор.Скрытый.Использование = НЕ мКнопкаОтображатьСкрытыеПредметыПисем.Пометка;
	
КонецПроцедуры

// Процедура формирует строку обязательных отборов списка писем.
// которая отображается над табличным полем списка писем
Процедура СформироватьСтрокуОтборовПисем()
	
	СтрокаОтборов = "Отборы: учетная запись ";
	
	Если ЭлектронныеПисьмаСписок.Отбор.УчетнаяЗапись.ВидСравнения = ВидСравнения.ВСписке Тогда
		СтрокаОтборов = СтрокаОтборов + "(все доступные)";
	ИначеЕсли ЭлектронныеПисьмаСписок.Отбор.УчетнаяЗапись.ВидСравнения = ВидСравнения.Равно Тогда
		Если НЕ ЗначениеЗаполнено(ЭлектронныеПисьмаСписок.Отбор.УчетнаяЗапись.Значение) Тогда
			СтрокаОтборов = СтрокаОтборов + "(пустая)";
		Иначе
			СтрокаОтборов = СтрокаОтборов + """" + ЭлектронныеПисьмаСписок.Отбор.УчетнаяЗапись.Значение + """";
		КонецЕсли; 
	КонецЕсли; 
	
	СтрокаОтборов = СтрокаОтборов + ", группа писем ";
	Если ЭлектронныеПисьмаСписок.Отбор.ГруппаУчетнойЗаписи.Использование Тогда
		Если ЭлектронныеПисьмаСписок.Отбор.ГруппаУчетнойЗаписи.ВидСравнения <> ВидСравнения.Равно Тогда
			СтрокаОтборов = СтрокаОтборов + ЭлектронныеПисьмаСписок.Отбор.ГруппаУчетнойЗаписи.ВидСравнения + " ";
		КонецЕсли; 
		Если ТипЗнч(ЭлектронныеПисьмаСписок.Отбор.ГруппаУчетнойЗаписи.Значение) = Тип("СписокЗначений") Тогда
			СтрокаОтборовТемп = "";
			Для каждого ЭлементСписка Из ЭлектронныеПисьмаСписок.Отбор.ГруппаУчетнойЗаписи.Значение Цикл
				СтрокаОтборовТемп = ", " + СтрокаОтборовТемп;
			КонецЦикла;
			СтрокаОтборов = СтрокаОтборов + """" + Сред(СтрокаОтборовТемп, 3) + """";
		Иначе
			Если НЕ ЗначениеЗаполнено(ЭлектронныеПисьмаСписок.Отбор.ГруппаУчетнойЗаписи.Значение) Тогда
				СтрокаОтборов = СтрокаОтборов + "(пустая)";
			Иначе
				СтрокаОтборов = СтрокаОтборов + """" + ЭлектронныеПисьмаСписок.Отбор.ГруппаУчетнойЗаписи.Значение + """";
			КонецЕсли;
		КонецЕсли; 
	Иначе
		СтрокаОтборов = СтрокаОтборов + "(нет отбора)";
	КонецЕсли;
	
	СтрокаОтборов = СтрокаОтборов + ", пометка удаления ";
	Если ЭлектронныеПисьмаСписок.Отбор.ПометкаУдаления.Использование Тогда
		Если  ЭлектронныеПисьмаСписок.Отбор.ПометкаУдаления.Значение = Истина И ЭлектронныеПисьмаСписок.Отбор.ПометкаУдаления.ВидСравнения = ВидСравнения.Равно Тогда
			СтрокаОтборов = СтрокаОтборов + """" + "Истина" + """";
		Иначе
			СтрокаОтборов = СтрокаОтборов + """" + "Ложь" + """";
		КонецЕсли;
	Иначе
		СтрокаОтборов = СтрокаОтборов + " (нет отбора)";
	КонецЕсли;
	
	Если мОтображатьСписокПредметов Тогда
		СтрокаОтборов = СтрокаОтборов + ", предмет ";
		Если ЭлектронныеПисьмаСписок.Отбор.ПредметКонтакта.Использование Тогда
			Если ПустаяСтрока(СокрЛП(ЭлектронныеПисьмаСписок.Отбор.ПредметКонтакта.Значение)) Тогда
				СтрокаОтборов = СтрокаОтборов + "(не указан)";
			Иначе
				СтрокаОтборов = СтрокаОтборов + """" + СокрЛП(ЭлектронныеПисьмаСписок.Отбор.ПредметКонтакта.Значение) + """";
			КонецЕсли; 
		Иначе
			СтрокаОтборов = СтрокаОтборов + "(нет отбора)";
		КонецЕсли; 
	КонецЕсли;
	
	Если ЭлектронныеПисьмаСписок.Отбор.СтатусПисьма.Использование  Тогда
		СтрокаОтборов = СтрокаОтборов + ", статус письма ";
		Если ЭлектронныеПисьмаСписок.Отбор.СтатусПисьма.ВидСравнения <> ВидСравнения.Равно Тогда
			Если ЭлектронныеПисьмаСписок.Отбор.СтатусПисьма.ВидСравнения = ВидСравнения.НеРавно Тогда
				СтрокаОтборов = СтрокаОтборов + "<> ";
			Иначе
				СтрокаОтборов = СтрокаОтборов + ЭлектронныеПисьмаСписок.Отбор.СтатусПисьма.ВидСравнения + " ";
			КонецЕсли; 
		КонецЕсли; 
		Если ТипЗнч(ЭлектронныеПисьмаСписок.Отбор.СтатусПисьма.Значение) = Тип("СписокЗначений") Тогда
			СтрокаОтборовТемп = "";
			Для каждого ЭлементСписка Из ЭлектронныеПисьмаСписок.Отбор.СтатусПисьма.Значение Цикл
				СтрокаОтборовТемп = ", " + СтрокаОтборовТемп;
			КонецЦикла;
			СтрокаОтборов = СтрокаОтборов + """" + Сред(СтрокаОтборовТемп, 3) + """";
		Иначе
			Если НЕ ЗначениеЗаполнено(ЭлектронныеПисьмаСписок.Отбор.СтатусПисьма.Значение) Тогда
				СтрокаОтборов = СтрокаОтборов + "(пустая)";
			Иначе
				СтрокаОтборов = СтрокаОтборов + """" + ЭлектронныеПисьмаСписок.Отбор.СтатусПисьма.Значение + """";
			КонецЕсли;
		КонецЕсли; 
	КонецЕсли; 
	
	ЭлементыФормы.НадписьОтборовПисем.Заголовок = СтрокаОтборов;
	
КонецПроцедуры

// Процедура обрабатывает событие "ПриАктивизацииСтроки" для списка предметов эл.писем.
//
// Параметры
//  Элемент - Табличное поле списка предметов эл.писем
//
Процедура ПредметыСписок_ПриАктивизацииСтроки()
	
	Элемент = ЭлементыФормы.ПредметыСписок;
	Если мОтображатьСписокПредметов И Элемент.Доступность Тогда
		Если Элемент.ТекущиеДанные = Неопределено Тогда
			ЭлектронныеПисьмаСписок.Отбор.ПредметКонтакта.Использование = Ложь;
		Иначе
			ЭлектронныеПисьмаСписок.Отбор.ПредметКонтакта.Использование = Истина;
			ЭлектронныеПисьмаСписок.Отбор.ПредметКонтакта.Значение      = Элемент.ТекущиеДанные.Предмет;
		КонецЕсли;
	Иначе
		ЭлектронныеПисьмаСписок.Отбор.ПредметКонтакта.Использование = Ложь;
	КонецЕсли; 
	
	ВосстановитьТекущийПредмет();
	
КонецПроцедуры

// Процедура обрабатывает событие "ПриАктивизацииСтроки" для групп писем.
//
// Параметры
//  Элемент - Табличное поле списка групп писем
//
Процедура ГруппыПисем_ПриАктивизацииСтроки(Элемент)
	
	// Отобразим только необходимые письма
	
	Для каждого ЭлементОтбора Из ЭлектронныеПисьмаСписок.Отбор Цикл
		Если ЭлементОтбора.Имя <> "УчетнаяЗапись" И ЭлементОтбора.Имя <> "ЭлектронныеПисьмаИСобытияПоОбъекту" Тогда
			ЭлементОтбора.Использование = Ложь;
		КонецЕсли; 
	КонецЦикла; 
	
	Если Элемент.ТекущиеДанные <> Неопределено Тогда
		УдаленныеУчетнойЗаписи = мСоответствияГруппУдаленные.Получить(Элемент.ТекущиеДанные.Владелец);
		ЧерновикиУчетнойЗаписи = мСоответствияГруппЧерновики.Получить(Элемент.ТекущиеДанные.Владелец);
	Иначе
		УдаленныеУчетнойЗаписи = Неопределено;
		ЧерновикиУчетнойЗаписи = Неопределено;
	КонецЕсли; 
	
	ЭлектронныеПисьмаСписок.Отбор.УчетнаяЗапись.Использование = Истина;
	Если ЗначениеЗаполнено(УчетнаяЗапись) Тогда
		ЭлектронныеПисьмаСписок.Отбор.УчетнаяЗапись.ВидСравнения = ВидСравнения.Равно;
		ЭлектронныеПисьмаСписок.Отбор.УчетнаяЗапись.Значение     = УчетнаяЗапись;
	Иначе
		Если Элемент.ТекущиеДанные <> Неопределено И (УдаленныеУчетнойЗаписи = Элемент.ТекущиеДанные.Ссылка ИЛИ ЧерновикиУчетнойЗаписи = Элемент.ТекущиеДанные.Ссылка) Тогда
			ЭлектронныеПисьмаСписок.Отбор.УчетнаяЗапись.ВидСравнения = ВидСравнения.Равно;
			ЭлектронныеПисьмаСписок.Отбор.УчетнаяЗапись.Значение = Элемент.ТекущиеДанные.Владелец;
		Иначе
			ЭлектронныеПисьмаСписок.Отбор.УчетнаяЗапись.ВидСравнения = ВидСравнения.ВСписке;
			ЭлектронныеПисьмаСписок.Отбор.УчетнаяЗапись.Значение     = мДоступныеУчетныеЗаписи;
		КонецЕсли; 
	КонецЕсли; 
	
	Если Элемент.ТекущиеДанные = Неопределено Тогда
		ЭлектронныеПисьмаСписок.Отбор.ГруппаУчетнойЗаписи.ВидСравнения  = ВидСравнения.Равно;
		ЭлектронныеПисьмаСписок.Отбор.ГруппаУчетнойЗаписи.Значение      = Справочники.ГруппыПисемЭлектроннойПочты.ПустаяСсылка();
		ЭлектронныеПисьмаСписок.Отбор.ГруппаУчетнойЗаписи.Использование = Истина;
	Иначе
		Если НЕ ЗначениеЗаполнено(УдаленныеУчетнойЗаписи) И НЕ ЗначениеЗаполнено(ЧерновикиУчетнойЗаписи) Тогда
			ЭлектронныеПисьмаСписок.Отбор.ГруппаУчетнойЗаписи.ВидСравнения  = ВидСравнения.Равно;
			ЭлектронныеПисьмаСписок.Отбор.ГруппаУчетнойЗаписи.Значение      = Элемент.ТекущиеДанные.Ссылка;
			ЭлектронныеПисьмаСписок.Отбор.ГруппаУчетнойЗаписи.Использование = Истина;
		Иначе
			ЭлектронныеПисьмаСписок.Отбор.ПометкаУдаления.ВидСравнения     = ВидСравнения.Равно;
			ЭлектронныеПисьмаСписок.Отбор.ПометкаУдаления.Использование    = ЗначениеЗаполнено(УдаленныеУчетнойЗаписи);
			ЭлектронныеПисьмаСписок.Отбор.СтатусПисьма.Значение            = Перечисления.СтатусыПисем.Сохраненное;
			ЭлектронныеПисьмаСписок.Отбор.ГруппаУчетнойЗаписи.ВидСравнения = ВидСравнения.Равно;
			ЭлектронныеПисьмаСписок.Отбор.ГруппаУчетнойЗаписи.Значение     = Элемент.ТекущиеДанные.Ссылка;
			Если Элемент.ТекущиеДанные.Ссылка = УдаленныеУчетнойЗаписи Тогда
				ЭлектронныеПисьмаСписок.Отбор.ПометкаУдаления.Значение          = Истина;
				ЭлектронныеПисьмаСписок.Отбор.СтатусПисьма.Использование        = Ложь;
				ЭлектронныеПисьмаСписок.Отбор.ГруппаУчетнойЗаписи.Использование = Ложь;
			ИначеЕсли Элемент.ТекущиеДанные.Ссылка = ЧерновикиУчетнойЗаписи Тогда
				ЭлектронныеПисьмаСписок.Отбор.СтатусПисьма.ВидСравнения         = ВидСравнения.Равно;
				ЭлектронныеПисьмаСписок.Отбор.ПометкаУдаления.Значение          = Ложь;
				ЭлектронныеПисьмаСписок.Отбор.СтатусПисьма.Использование        = Истина;
				ЭлектронныеПисьмаСписок.Отбор.ГруппаУчетнойЗаписи.Использование = Ложь;
			Иначе
				ЭлектронныеПисьмаСписок.Отбор.СтатусПисьма.ВидСравнения         = ВидСравнения.НеРавно;
				ЭлектронныеПисьмаСписок.Отбор.ПометкаУдаления.Значение          = Ложь;
				ЭлектронныеПисьмаСписок.Отбор.СтатусПисьма.Использование        = (ЧерновикиУчетнойЗаписи <> Неопределено);
				ЭлектронныеПисьмаСписок.Отбор.ГруппаУчетнойЗаписи.Использование = Истина;
			КонецЕсли; 
		КонецЕсли; 
	КонецЕсли;
	
	Если Элемент.ТекущиеДанные <> Неопределено Тогда
		Если НЕ Элемент.ТекущиеДанные.Владелец.ДляВходящихОтветовИПереадресацийИскатьПисьмаОснованияИЗаполнятьГруппуПисемНовогоПисьма
			И НЕ Элемент.ТекущиеДанные.Владелец.ПомещатьОтветыИПереадресацииВТужеГруппу Тогда
			ЭлементыФормы.ЭлектронныеПисьмаСписок.Колонки.КомуПредставление.Видимость = Истина;
			ЭлементыФормы.ЭлектронныеПисьмаСписок.Колонки.ОтправительИмя.Видимость    = Истина;
			Если Элемент.ТекущиеДанные.Ссылка = Элемент.ТекущиеДанные.Владелец.ГруппаВходящие Тогда
				ЭлементыФормы.ЭлектронныеПисьмаСписок.Колонки.КомуПредставление.Видимость = Ложь;
			ИначеЕсли Элемент.ТекущиеДанные.Ссылка = Элемент.ТекущиеДанные.Владелец.ГруппаИсходящие
				ИЛИ Элемент.ТекущиеДанные.Ссылка = Элемент.ТекущиеДанные.Владелец.ГруппаЧерновики Тогда
				ЭлементыФормы.ЭлектронныеПисьмаСписок.Колонки.ОтправительИмя.Видимость = Ложь;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	УстановитьОтборПредметов();
	
КонецПроцедуры

// Процедура обрабатывает событие "ПриАктивизацииСтроки" для списка писем.
//
// Параметры
//  Элемент - Табличное поле списка писем
//
Процедура ЭлектронныеПисьма_СписокПриАктивизацииСтроки(Элемент)
	
	Если Элемент.ТекущиеДанные = Неопределено Тогда
		
		ЭлементыФормы.КнопкаВложения.Видимость = Ложь;
		
		ЭлементыФормы.ПолеОтправитель.Значение = "";
		ЭлементыФормы.ПолеКому.Значение        = "";
		ЭлементыФормы.ПолеТема.Значение        = "";
		ЭлементыФормы.ПолеКопии.Значение       = "";
		
		ЭлементыФормы.ПолеHTMLДокумента.УстановитьТекст("");
		
		ЭлементыФормы.КонтекстноеМенюСпискаПисем.Кнопки.УстановитьПометкуУдаления.Текст     = "Установить пометку удаления";
		ЭлементыФормы.КоманднаяПанельПочты.Кнопки.Подменю.Кнопки.УстановитьПометкуУдаления.Текст = "Установить пометку удаления";
		
	Иначе
		
		Если Элемент.ТекущиеДанные.ПометкаУдаления Тогда
			ЭлементыФормы.КонтекстноеМенюСпискаПисем.Кнопки.УстановитьПометкуУдаления.Текст     = "Снять пометку удаления";
			ЭлементыФормы.КоманднаяПанельПочты.Кнопки.Подменю.Кнопки.УстановитьПометкуУдаления.Текст = "Снять пометку удаления";
		Иначе
			ЭлементыФормы.КонтекстноеМенюСпискаПисем.Кнопки.УстановитьПометкуУдаления.Текст     = "Установить пометку удаления";
			ЭлементыФормы.КоманднаяПанельПочты.Кнопки.Подменю.Кнопки.УстановитьПометкуУдаления.Текст = "Установить пометку удаления";
		КонецЕсли; 
		
		Если Элемент.ТекущиеДанные.НеРассмотрено И Элемент.ТекущиеДанные.УчетнаяЗапись.АвтоматическаяУстановкаПометкиРассмотрено Тогда
			мТекущееПисьмо = Элемент.ТекущиеДанные.Ссылка;
			ПодключитьОбработчикОжидания("АвтоустановкаРассмотренностиПисьма", Элемент.ТекущиеДанные.УчетнаяЗапись.ИнтервалАвтоматическойУстановкиОтметкиРассмотрено);
		КонецЕсли; 
		
		ЭлементыФормы.ПолеОтправитель.Значение = Элемент.ТекущиеДанные.ОтправительПредставление;
		ЭлементыФормы.ПолеКому.Значение        = Элемент.ТекущиеДанные.Кому;
		ЭлементыФормы.ПолеТема.Значение        = Элемент.ТекущиеДанные.Тема;
		ЭлементыФормы.ПолеКопии.Значение       = Элемент.ТекущиеДанные.Копии;
		
		ЭлементыФормы.КнопкаВложения.Видимость = Элемент.ТекущиеДанные.ЕстьВложения;
		
		Если Элемент.ТекущиеДанные.ВидТекстаПисьма = Перечисления.ВидыТекстовЭлектронныхПисем.HTMLСКартинками Тогда
			НайденноеСоответствие = глЗначениеПеременной("глСоответствиеТекстовЭлектронныхПисем").Получить(Элемент.ТекущиеДанные.Ссылка);
			Если НайденноеСоответствие = Неопределено Тогда
				ЭлементыФормы.ПолеHTMLДокумента.УстановитьТекст(Элемент.ТекущиеДанные.ТекстПисьма);
				ПодключитьОбработчикОжидания("ПриАктивизацииСтрокиСпискаПисемСОжиданием", 1);
			Иначе
				ЭлементыФормы.ПолеHTMLДокумента.УстановитьТекст(НайденноеСоответствие);
				мОтображеннаяСтрокаСпискаПисем = Элемент.ТекущиеДанные.Ссылка;
			КонецЕсли; 
		Иначе
			Если Элемент.ТекущиеДанные.ВидТекстаПисьма = Перечисления.ВидыТекстовЭлектронныхПисем.Текст Тогда
				ТекстПисьма = УправлениеЭлектроннойПочтой.ВернутьТекстПисьмаВФорматеHTML(Элемент.ТекущиеДанные.ТекстПисьма);
				ЭлементыФормы.ПолеHTMLДокумента.УстановитьТекст(ТекстПисьма);
			Иначе
				ЭлементыФормы.ПолеHTMLДокумента.УстановитьТекст(Элемент.ТекущиеДанные.ТекстПисьма);
			КонецЕсли; 
			мОтображеннаяСтрокаСпискаПисем = Элемент.ТекущиеДанные.Ссылка;
		КонецЕсли;
		
	КонецЕсли; 
	
КонецПроцедуры

// Функция определяет, какое из 2-х табличных полей групп писем
// в настоящий момент активно. Сделано временно, пока в платформе
// некорректно работает схлопываение объектов с разделителем.
//
// Параметры
//  НЕТ
//
// Возвращаемое значение:
//  Табличное поле.
//
Функция ПолучитьЭлементГруппыПисемДерево()
	
	Если мОтображатьСписокПредметов Тогда
		Возврат ЭлементыФормы.ГруппыПисемДерево;
	Иначе
		Возврат ЭлементыФормы.ГруппыПисемДерево1;
	КонецЕсли; 
	
КонецФункции

// Процедура устанавливает при необходимости отбор на РегистрСведенийСписок
//  предметы писем электронной почты.
//
Процедура УстановитьОтборПредметов(ОтборПоГруппе = Истина)
	
	Если мОтображатьСписокПредметов Тогда
		ЭлементГруппыПисемДерево = ПолучитьЭлементГруппыПисемДерево();

		ПредметыСписок.Отбор.ГруппаПисемЭлектроннойПочты.Использование = ОтборПоГруппе;
		Если ЭлементГруппыПисемДерево.ТекущиеДанные <> Неопределено И ЗначениеЗаполнено(ЭлементГруппыПисемДерево.ТекущиеДанные.Ссылка) Тогда
			Если ФлагКлассификацииПисемПоПредметам(ЭлементГруппыПисемДерево.ТекущиеДанные.Владелец) И ЭлементГруппыПисемДерево.ТекущиеДанные.ИспользоватьПредметыПисем Тогда
				ПредметыСписок.Отбор.ГруппаПисемЭлектроннойПочты.Значение = ЭлементГруппыПисемДерево.ТекущиеДанные.Ссылка;
				ЭлементыФормы.ПредметыСписок.Доступность = Истина;
			Иначе
				ПредметыСписок.Отбор.ГруппаПисемЭлектроннойПочты.Значение = Справочники.ГруппыПисемЭлектроннойПочты.ПустаяСсылка();
				ЭлементыФормы.ПредметыСписок.Доступность = Ложь;
			КонецЕсли; 
		Иначе
			ПредметыСписок.Отбор.ГруппаПисемЭлектроннойПочты.Значение = Справочники.ГруппыПисемЭлектроннойПочты.ПустаяСсылка();
			ЭлементыФормы.ПредметыСписок.Доступность = Ложь;
		КонецЕсли;
	Иначе
		ПредметыСписок.Отбор.ГруппаПисемЭлектроннойПочты.Значение = Справочники.ГруппыПисемЭлектроннойПочты.ПустаяСсылка();
		ПредметыСписок.Отбор.ГруппаПисемЭлектроннойПочты.Использование = Истина;
		ЭлементыФормы.ПредметыСписок.Доступность = Ложь;
	КонецЕсли;
	Если НЕ ЭлементыФормы.ПредметыСписок.Доступность Тогда
		ЭлементыФормы.ПредметыСписок.Колонки.Предмет.ТекстШапки = "Предметы недоступны";
		ЭлементыФормы.ПредметыСписок.Колонки.Предмет.ШрифтШапки = Новый Шрифт(,, Истина);
	Иначе
		ЭлементыФормы.ПредметыСписок.Колонки.Предмет.ТекстШапки = "Предметы писем";
		ЭлементыФормы.ПредметыСписок.Колонки.Предмет.ШрифтШапки = Новый Шрифт;
	КонецЕсли; 
	ПредметыСписок_ПриАктивизацииСтроки();
	
КонецПроцедуры

// Процедура инициирует открытие формы нового электронного письма.
//
// Параметры:
//  Копирование - Булево, признак копирование письма
//  ВТекущейГруппе - Булево, Признак создания нового электронного письма в
//                   текущей группе электронных писем.
//
Процедура НаписатьНовоеПисьмо(Копирование = Ложь, ВТекущейГруппе = Ложь)
	
	Если Копирование Тогда
		
		НовыйОбъект = ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные.Ссылка.Скопировать();
		НовыйОбъект.ПолучитьФорму(, ЭтаФорма).Открыть();
		
	Иначе
		
		СтруктураНовогоПисьма = Новый Структура;
		
		ЭлементГруппыПисемДерево = ПолучитьЭлементГруппыПисемДерево();
		
		Если ЗначениеЗаполнено(УчетнаяЗапись) Тогда
			СтруктураНовогоПисьма.Вставить("УчетнаяЗапись", УчетнаяЗапись);
			Если ВТекущейГруппе Тогда
				Если ЭлементГруппыПисемДерево.ТекущиеДанные <> Неопределено И ЭлементГруппыПисемДерево.ТекущиеДанные.Ссылка.Владелец = УчетнаяЗапись Тогда
					СтруктураНовогоПисьма.Вставить("ГруппаУчетнойЗаписи", ЭлементГруппыПисемДерево.ТекущиеДанные.Ссылка);
				КонецЕсли;
			КонецЕсли; 
		Иначе
			Если ЭлементГруппыПисемДерево.ТекущиеДанные <> Неопределено И ЗначениеЗаполнено(ЭлементГруппыПисемДерево.ТекущиеДанные.Ссылка) Тогда
				СтруктураНовогоПисьма.Вставить("УчетнаяЗапись", ЭлементГруппыПисемДерево.ТекущиеДанные.Владелец);
				Если ВТекущейГруппе Тогда
					СтруктураНовогоПисьма.Вставить("ГруппаУчетнойЗаписи", ЭлементГруппыПисемДерево.ТекущиеДанные.Ссылка);
				КонецЕсли; 
			КонецЕсли;
		КонецЕсли;
		
		УправлениеЭлектроннойПочтой.НаписатьПисьмо(глЗначениеПеременной("глТекущийПользователь"),СтруктураНовогоПисьма,,,,, ЭтаФорма);
		
	КонецЕсли; 
	
КонецПроцедуры

// Процедура обрабатывает событие активизации строки электронных писем с ожиданием
// в 1 сек, задержка производится для отображения больших картинок в ХТМЛ формате.
// 
Процедура ПриАктивизацииСтрокиСпискаПисемСОжиданием()
	
	Если ЭлементыФормы.ОсновнаяПанель.ТекущаяСтраница.Имя = "Контакты" Тогда
		
	Иначе
		
		ТекущаяСтрокаСпискаПисем = ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные;
		
		Если ТекущаяСтрокаСпискаПисем = Неопределено Тогда
			Возврат;
		КонецЕсли;
		
		Если мОтображеннаяСтрокаСпискаПисем <> ТекущаяСтрокаСпискаПисем.Ссылка Тогда
			
			КопияТекстаПисьма = ТекущаяСтрокаСпискаПисем.ТекстПисьма;
			Если ТекущаяСтрокаСпискаПисем.ВидТекстаПисьма = Перечисления.ВидыТекстовЭлектронныхПисем.HTMLСКартинками Тогда
				УправлениеЭлектроннойПочтой.ПропарситьHTMLИДВ_ТекстКартинки(глЗначениеПеременной("глСоответствиеТекстовЭлектронныхПисем"), глЗначениеПеременной("глТекущийПользователь"), ТекущаяСтрокаСпискаПисем.Ссылка, КопияТекстаПисьма);
			КонецЕсли; 
			ЭлементыФормы.ПолеHTMLДокумента.УстановитьТекст(КопияТекстаПисьма);
			
			ОтключитьОбработчикОжидания("ПриАктивизацииСтрокиСпискаПисемСОжиданием");
			мОтображеннаяСтрокаСпискаПисем = ТекущаяСтрокаСпискаПисем.Ссылка;
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

// Процедура устанавливает отбор на список групп электронных писем
// в зависимости от текущей учетной записи.
//
Процедура УстановитьОтборГрупп()
	
	ЭлементыФормы.ГруппыПисемДерево.НастройкаОтбора.Владелец.Доступность = Ложь;
	ЭлементыФормы.ГруппыПисемДерево.Колонки.Владелец.Видимость = НЕ ЗначениеЗаполнено(УчетнаяЗапись);
	ЭлементыФормы.ГруппыПисемДерево1.НастройкаОтбора.Владелец.Доступность = Ложь;
	ЭлементыФормы.ГруппыПисемДерево1.Колонки.Владелец.Видимость = НЕ ЗначениеЗаполнено(УчетнаяЗапись);
	
	ГруппыПисемДерево.Порядок.Очистить();
	Если НЕ ЗначениеЗаполнено(УчетнаяЗапись) Тогда
		ГруппыПисемДерево.Отбор.Владелец.ВидСравнения  = ВидСравнения.ВСписке;
		ГруппыПисемДерево.Отбор.Владелец.Значение      = мДоступныеУчетныеЗаписи.Скопировать();
		ГруппыПисемДерево.Порядок.Установить("Владелец ВОЗР,Порядок ВОЗР");
	Иначе
		ГруппыПисемДерево.Отбор.Владелец.ВидСравнения  = ВидСравнения.Равно;
		ГруппыПисемДерево.Отбор.Владелец.Значение      = УчетнаяЗапись;
		ГруппыПисемДерево.Порядок.Установить("Порядок ВОЗР");
	КонецЕсли; 
	ГруппыПисемДерево.Отбор.Владелец.Использование = Истина;
	
	ГруппыПисемДерево1.Порядок.Очистить();
	Если НЕ ЗначениеЗаполнено(УчетнаяЗапись) Тогда
		ГруппыПисемДерево1.Отбор.Владелец.ВидСравнения  = ВидСравнения.ВСписке;
		ГруппыПисемДерево1.Отбор.Владелец.Значение      = мДоступныеУчетныеЗаписи.Скопировать();
		ГруппыПисемДерево1.Порядок.Установить("Владелец ВОЗР,Порядок ВОЗР");
	Иначе
		ГруппыПисемДерево1.Отбор.Владелец.ВидСравнения  = ВидСравнения.Равно;
		ГруппыПисемДерево1.Отбор.Владелец.Значение      = УчетнаяЗапись;
		ГруппыПисемДерево1.Порядок.Установить("Порядок ВОЗР");
	КонецЕсли; 
	ГруппыПисемДерево1.Отбор.Владелец.Использование = Истина;
	
КонецПроцедуры

// Процедура заполняет пункты меню "Отправить/Получить" в зависимости от
// уровня доступа текущего пользователя к транспорту эл.писем учетных записей.
//
Процедура ЗаполнитьПодменюОтправитьПолучить()
	
	// Подменю ПОЛУЧИТЬ/ОТПРАВИТЬ
	КнопкиПодменю = ЭлементыФормы.КоманднаяПанельПочты.Кнопки.ПодменюПолучитьОтправить.Кнопки;
	КнопкиПодменю1 = ЭлементыФормы.КоманднаяПанельПочты.Кнопки.Подменю.Кнопки.ПодменюПолучитьОтправить.Кнопки;
	КнопкиПодменю.Очистить();
	КнопкиПодменю1.Очистить();
	Для каждого ЭлементСписка Из мСтруктураДоступныхУчетныхЗаписей.Запись Цикл
		Кнопка = КнопкиПодменю.Добавить(("п" + СтрЗаменить(Строка(ЭлементСписка.Значение.УникальныйИдентификатор()), "-", "_")), ТипКнопкиКоманднойПанели.Действие, ("&" + Строка(мСтруктураДоступныхУчетныхЗаписей.Запись.Индекс(ЭлементСписка) + 1) + ". Получить: " + ЭлементСписка.Представление), Новый Действие("ПолучитьУчетнаяЗапись"));
		Кнопка.Картинка = БиблиотекаКартинок.ПолучитьУчетнаяЗапись;
		Кнопка = КнопкиПодменю1.Добавить(("п" + СтрЗаменить(Строка(ЭлементСписка.Значение.УникальныйИдентификатор()), "-", "_")), ТипКнопкиКоманднойПанели.Действие, ("&" + Строка(мСтруктураДоступныхУчетныхЗаписей.Запись.Индекс(ЭлементСписка) + 1) + ". Получить: " + ЭлементСписка.Представление), Новый Действие("ПолучитьУчетнаяЗапись"));
		Кнопка.Картинка = БиблиотекаКартинок.ПолучитьУчетнаяЗапись;
	КонецЦикла;
	Если мСтруктураДоступныхУчетныхЗаписей.Запись.Количество() > 1 Тогда
		КнопкиПодменю.Добавить("Разделитель99");
		КнопкиПодменю1.Добавить("Разделитель99");
	КонецЕсли; 
	Для каждого ЭлементСписка Из мСтруктураДоступныхУчетныхЗаписей.Запись Цикл
		Кнопка = КнопкиПодменю.Добавить(("о" + СтрЗаменить(Строка(ЭлементСписка.Значение.УникальныйИдентификатор()), "-", "_")), ТипКнопкиКоманднойПанели.Действие, ("&" + Строка(мСтруктураДоступныхУчетныхЗаписей.Запись.Индекс(ЭлементСписка) + 1) + ". Отправить: " + ЭлементСписка.Представление), Новый Действие("ОтправитьУчетнаяЗапись"));
		Кнопка.Картинка = БиблиотекаКартинок.ОтправитьУчетнаяЗапись;
		Кнопка = КнопкиПодменю1.Добавить(("о" + СтрЗаменить(Строка(ЭлементСписка.Значение.УникальныйИдентификатор()), "-", "_")), ТипКнопкиКоманднойПанели.Действие, ("&" + Строка(мСтруктураДоступныхУчетныхЗаписей.Запись.Индекс(ЭлементСписка) + 1) + ". Отправить: " + ЭлементСписка.Представление), Новый Действие("ОтправитьУчетнаяЗапись"));
		Кнопка.Картинка = БиблиотекаКартинок.ОтправитьУчетнаяЗапись;
	КонецЦикла;
	
	КнопкиПодменю.Добавить("Разделитель98");
	КнопкиПодменю1.Добавить("Разделитель98");
	
	Если мСтруктураДоступныхУчетныхЗаписей.Запись.Количество() > 1 Тогда
		Кнопка = КнопкиПодменю.Добавить("ПолучитьВсе"          , ТипКнопкиКоманднойПанели.Действие, "Получить ВСЕ"          , Новый Действие("ПолучитьВсе"));
		Кнопка.Картинка = БиблиотекаКартинок.ПолучитьВсе;
		Кнопка = КнопкиПодменю.Добавить("ОтправитьВсе"         , ТипКнопкиКоманднойПанели.Действие, "Отправить ВСЕ"         , Новый Действие("ОтправитьВсе"));
		Кнопка.Картинка = БиблиотекаКартинок.ОтправитьВсе;
		КнопкиПодменю.Добавить("Разделитель97");
	КонецЕсли; 
	Кнопка = КнопкиПодменю.Добавить("ОтправитьПолучитьВсе" , ТипКнопкиКоманднойПанели.Действие, "Получить/Отправить ВСЕ", Новый Действие("ОтправитьПолучитьВсе"));
	Кнопка.Картинка = БиблиотекаКартинок.ОтправитьПолучитьВсе;
	
	Если мСтруктураДоступныхУчетныхЗаписей.Запись.Количество() > 1 Тогда
		Кнопка = КнопкиПодменю1.Добавить("ПолучитьВсе"         , ТипКнопкиКоманднойПанели.Действие, "Получить ВСЕ"          , Новый Действие("ПолучитьВсе"));
		Кнопка.Картинка = БиблиотекаКартинок.ПолучитьВсе;
		Кнопка = КнопкиПодменю1.Добавить("ОтправитьВсе"        , ТипКнопкиКоманднойПанели.Действие, "Отправить ВСЕ"         , Новый Действие("ОтправитьВсе"));
		Кнопка.Картинка = БиблиотекаКартинок.ОтправитьВсе;
		КнопкиПодменю1.Добавить("Разделитель97");
	КонецЕсли; 
	Кнопка = КнопкиПодменю1.Добавить("ОтправитьПолучитьВсе", ТипКнопкиКоманднойПанели.Действие, "Получить/Отправить ВСЕ", Новый Действие("ОтправитьПолучитьВсе"));
	Кнопка.Картинка = БиблиотекаКартинок.ОтправитьПолучитьВсе;
	
КонецПроцедуры

// Процедура изменяет флаг рассмотренности электронного письма.
// 
// Параметры:
//  ВыделенныеСтроки  - Массив, выделенные строки табличного поля
//  НовыйФлаг         - Булево, новый флаг рассмотренности эл.писем
//  ВыдаватьСообщения - Булево, выдавать сообщения о невозможности изменения флага рассмотренности
// 
Процедура ИзменитьФлагРассмотренностьПисьма(ВыделенныеСтроки, НовыйФлаг, ВыдаватьСообщения = Истина)
	
	СписокОтправка = мСтруктураДоступныхУчетныхЗаписей.Запись;
	
	Если НовыйФлаг Тогда
		ФормаДаты = ПолучитьОбщуюФорму("ФормаИзмененияГраницыРассмотренияЭлектронногоПисьма");
		Если ВыделенныеСтроки.Количество() = 1 Тогда
			ФормаДаты.РассмотретьПосле = ВыделенныеСтроки[0].Ссылка.РассмотретьПосле;
		КонецЕсли; 
		РассмотретьПосле = ФормаДаты.ОткрытьМодально();
		Если ТипЗнч(РассмотретьПосле) <> Тип("Дата") Тогда
			Возврат;
		КонецЕсли; 
	КонецЕсли;
	
	КолСтрок = ВыделенныеСтроки.Количество();
	
	Если КолСтрок = 0 Тогда
		Возврат;
	КонецЕслИ;
	
	ФормаПрогрессора = ПолучитьОбщуюФорму("ХодВыполненияОбработкиДанных");
	Если ФормаПрогрессора.Открыта() Тогда
		ФормаПрогрессора.Закрыть();
	КонецЕсли; 
	
	Если ВыдаватьСообщения И КолСтрок > 1 Тогда
		ФормаПрогрессора.НаименованиеОбработкиДанных = "Установка признаки рассмотренности писем";
		ФормаПрогрессора.КомментарийОбработкиДанных  = "Установка признаки рассмотренности писем";
		ФормаПрогрессора.Значение = 1;
		ФормаПрогрессора.МаксимальноеЗначение = КолСтрок;
		ФормаПрогрессора.Открыть();
	КонецЕсли;
	
	Для каждого Строка Из ВыделенныеСтроки Цикл
		Если ТипЗнч(Строка) = Тип("ДокументСсылка.ЭлектронноеПисьмо") Тогда
			Ссылка = Строка;
		Иначе
			Ссылка = Строка.Ссылка;
		КонецЕсли;
		Если ТипЗнч(Ссылка) = Тип("ДокументСсылка.ЭлектронноеПисьмо") И (Ссылка.НеРассмотрено <> НовыйФлаг) ИЛИ (НовыйФлаг И Ссылка.РассмотретьПосле <> РассмотретьПосле) Тогда
			Если СписокОтправка.НайтиПоЗначению(Ссылка.УчетнаяЗапись) = Неопределено Тогда
				Если ВыдаватьСообщения Тогда
					Сообщить("Вам запрещено редактировать письма учетной записи " + УчетнаяЗапись);
				КонецЕсли; 
				Продолжить;
			КонецЕсли; 
			Объект = Ссылка.ПолучитьОбъект();
			Объект.НеВыдаватьСообщенияПриЗаписиОбъекта = НЕ ВыдаватьСообщения;
			Объект.НеРассмотрено = НовыйФлаг;
			Если НовыйФлаг Тогда
				Объект.РассмотретьПосле = РассмотретьПосле;
			КонецЕсли;
			Если НЕ НовыйФлаг И НЕ ЗначениеЗаполнено(Объект.Ответственный) Тогда
				Объект.Ответственный = глЗначениеПеременной("глТекущийПользователь");
			КонецЕсли; 
			Попытка
				Объект.Записать();
			Исключение
				Сообщить("Флаг рассмотренности документа " + Объект + " не изменен.");
			КонецПопытки;
		КонецЕсли; 
		
		ФормаПрогрессора.Значение = ФормаПрогрессора.Значение + 1;
		
	КонецЦикла; 
	
	Если ФормаПрогрессора.Открыта() Тогда
		ФормаПрогрессора.Закрыть();
	КонецЕсли;
	
КонецПроцедуры

// Процедура обработчика ожидания, которая контролирует автоматическую установку флага прочитанности
// эл.писем, настройка устанавливается в параметрах учетной записи.
// // (подключается через обработчик ожидания)
Процедура АвтоустановкаРассмотренностиПисьма()
	
	Если ЭлементыФормы.ОсновнаяПанель.ТекущаяСтраница.Имя = "Контакты" Тогда
	Иначе
		Если ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные <> Неопределено
			И ТипЗнч(мТекущееПисьмо) = Тип("ДокументСсылка.ЭлектронноеПисьмо") И мТекущееПисьмо.ПолучитьОбъект() <> Неопределено
			И ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные.Ссылка = мТекущееПисьмо
			И ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные.НеРассмотрено Тогда
			ВыделенныеСтроки = Новый Массив;
			ВыделенныеСтроки.Добавить(ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущаяСтрока);
			ИзменитьФлагРассмотренностьПисьма(ВыделенныеСтроки, Ложь, Ложь);
			СобратьСтатистикуРассмотренностиПисем();
		КонецЕсли;
	КонецЕсли;
	ОтключитьОбработчикОжидания("АвтоустановкаРассмотренностиПисьма");
	
КонецПроцедуры

// Процедура изменяет оформление строки письма
// 
// Параметры:
//  ВыделенныеСтроки  - Массив, выделенные строки табличного поля
//  Установить        - Булево, флаг установки/снятие оформления
//  ВыдаватьСообщения - Булево, выдавать сообщения о невозможности изменения флага рассмотренности
// 
Процедура ИзменитьОформление(ВыделенныеСтроки, Установить, ВыдаватьСообщения = Истина, КодУстанавливаемогоОформления = "")
	
	СписокОтправка = мСтруктураДоступныхУчетныхЗаписей.Запись;
	
	Если Установить И ЗначениеЗаполнено(КодУстанавливаемогоОформления) Тогда
		Оформление = Справочники.ОформленияСтрокПисем.НайтиПоКоду(КодУстанавливаемогоОформления);
		Если НЕ ЗначениеЗаполнено(Оформление) Тогда
			Возврат;
		КонецЕсли;
	Иначе
		Оформление = Справочники.ОформленияСтрокПисем.ПустаяСсылка();
	КонецЕсли;
	
	КолСтрок = ВыделенныеСтроки.Количество();
	КолОбработано = 0;
	Для каждого Строка Из ВыделенныеСтроки Цикл
		Если ТипЗнч(Строка) = Тип("ДокументСсылка.ЭлектронноеПисьмо") Тогда
			Если Строка.Оформление = Оформление Тогда
				Продолжить;
			КонецЕсли;
			Если СписокОтправка.НайтиПоЗначению(Строка.УчетнаяЗапись) = Неопределено Тогда
				Если ВыдаватьСообщения Тогда
					Сообщить("Вам запрещено редактировать письма учетной записи " + УчетнаяЗапись);
				КонецЕсли; 
				Продолжить;
			КонецЕсли; 
			Объект = Строка.ПолучитьОбъект();
			Объект.НеВыдаватьСообщенияПриЗаписиОбъекта = НЕ ВыдаватьСообщения;
			Объект.Оформление = Оформление;
			Попытка
				Объект.Записать();
			Исключение
				Сообщить("Оформление документа " + Объект + " не изменено.");
			КонецПопытки;
		КонецЕсли; 
		КолОбработано = КолОбработано + 1;
		Состояние("Обработано " + КолОбработано + " из " + КолСтрок);
	КонецЦикла; 
	
КонецПроцедуры

// Процедура обрабатывает событие начала редактирования электронного письма.
// 
// Параметры:
//  Элемент - Табличное поле списка эл.писем
//  Отказ   - Булево, флаг отказа от редактирования эл.письма
// 
Процедура ПередНачаломИзмененияЭлектронногоПисьма(Элемент, Отказ)
	
	Если Элемент.ТекущиеДанные <> Неопределено Тогда
		СписокОтправка = мСтруктураДоступныхУчетныхЗаписей.Запись;
		Если Элемент.ТекущиеДанные.НеРассмотрено И Элемент.ТекущиеДанные.УчетнаяЗапись.АвтоматическаяУстановкаПометкиРассмотрено И СписокОтправка.НайтиПоЗначению(Элемент.ТекущиеДанные.УчетнаяЗапись) <> Неопределено Тогда
			Объект = Элемент.ТекущиеДанные.Ссылка.ПолучитьОбъект();
			Объект.НеРассмотрено = Ложь;
			Если НЕ ЗначениеЗаполнено(Объект.Ответственный) Тогда
				Объект.Ответственный = глЗначениеПеременной("глТекущийПользователь");
			КонецЕсли; 
			Попытка
				Объект.Записать();
			Исключение
			КонецПопытки;
			СобратьСтатистикуРассмотренностиПисем();
		КонецЕсли;
		// Перехватываем что бы установить владельца формы
		Элемент.ТекущиеДанные.Ссылка.ПолучитьФорму(, ЭтаФорма).Открыть();
		Отказ = Истина;
	КонецЕсли; 
	
КонецПроцедуры

// Процедура производит общее обновление связей на форме, списка доступных учетных записей
// и электронных писем.
//
// Параметры:
//  ОбновлятьОтбор               - Булево, признак необходимости обновления отбора списков
//  ОбновлятьТекстТекущегоПисьма - Булево, признак обновления текста текущего эл.письма
//                                 в поле ХТМЛ документа.
//
Процедура ОбщееОбновлениеПочты(ОбновлятьОтбор = Истина, ОбновлятьТекстТекущегоПисьма = Истина)
	
	Если ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные <> Неопределено Тогда
		ТекущееПисьмо = ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные.Ссылка;
	КонецЕсли; 
	
	СоздатьКнопкиОформленияСтрокПисем();
	ОбновитьДоступныеУчетныеЗаписи();
	
	Если мДоступныеУчетныеЗаписи.Количество() = 0 Тогда
		ЭлементыФормы.ОсновнаяПанель.Страницы.Почта.Доступность = Ложь;
	Иначе
		ЭлементыФормы.ОсновнаяПанель.Страницы.Почта.Доступность = Истина;
		
		ЭлементыФормы.УчетнаяЗапись.СписокВыбора = мДоступныеУчетныеЗаписи.Скопировать();
		ЭлементыФормы.УчетнаяЗапись.СписокВыбора.СортироватьПоПредставлению(НаправлениеСортировки.Возр);
		ЭлементыФормы.УчетнаяЗапись.СписокВыбора.Добавить(Справочники.УчетныеЗаписиЭлектроннойПочты.ПустаяСсылка(), "Все доступные учетные записи");
		
		Если ЭлементыФормы.УчетнаяЗапись.СписокВыбора.НайтиПоЗначению(УчетнаяЗапись) = Неопределено Тогда
			УчетнаяЗапись = ЭлементыФормы.УчетнаяЗапись.СписокВыбора[0].Значение;
		КонецЕсли; 
		
		ЗаполнитьПодменюОтправитьПолучить();
		
		УстановитьОтборГрупп();
		
		ГруппыПисемДерево.Обновить();
		ЭлементГруппыПисемДерево = ПолучитьЭлементГруппыПисемДерево();
		
		Если ОбновлятьОтбор Тогда
			ГруппыПисем_ПриАктивизацииСтроки(ЭлементГруппыПисемДерево);
		КонецЕсли; 
		
		ПредметыСписок.Обновить();
		
		СписокДанныхПоПредметам.Очистить();
		СписокДанныхПоПисьмам.Очистить();
		СписокДанныхПоПредметамПоОбъекту.Очистить();
		
		СобратьСтатистикуРассмотренностиПисем();
		
		ЭлектронныеПисьмаСписок.Обновить();
		
		Если ТекущееПисьмо <> Неопределено Тогда
			ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущаяСтрока = ТекущееПисьмо;
		КонецЕсли;
		
		Если ОбновлятьТекстТекущегоПисьма Тогда
			ЭлектронныеПисьма_СписокПриАктивизацииСтроки(ЭлементыФормы.ЭлектронныеПисьмаСписок);
		КонецЕсли; 
		
		мИзменятьСписокЭлектронныхПисемПриВыбореПапкиПисем = УправлениеПользователями.ПолучитьЗначениеПоУмолчанию(глЗначениеПеременной("глТекущийПользователь"), "ИзменятьСписокЭлектронныхПисемПриВыбореПапкиПисем");
		
	КонецЕсли; 
	
КонецПроцедуры

// Процедура обрабатывает событие начала поиска объектов ИБ по адресу эл.почты и представлению.
// 
// Параметры:
//  ВыделенныйТекст - Текст для поиска, содержащий адрес эл.почты И/ИЛИ представление объекта.
// 
Процедура ПроизвестиПоиск(ВыделенныйТекст)
	
	ТекстДляПоиска = ВыделенныйТекст;
	
	АдреснаяКнига = Обработки.АдреснаяКнига.Создать();
	Если ЗначениеЗаполнено(УчетнаяЗапись) Тогда
		АдреснаяКнига.УчетнаяЗапись = УчетнаяЗапись;
	КонецЕсли; 
	АдреснаяКнига.ОткрытаДляВыбора  = Истина;
	АдреснаяКнига.ОткрытиеПриВыборе = Истина;
	АдреснаяКнига.ПроизвестиПоиск(ТекстДляПоиска);
	
КонецПроцедуры

// Процедура управляет видимостью списка предметов электронных писем.
//
Процедура ВидимостьСпискаПредметов()
	
	Если мОтображатьСписокПредметов Тогда
		ЭлементыФормы.ПанельСпискаПредметов.ТекущаяСтраница = ЭлементыФормы.ПанельСпискаПредметов.Страницы.СписокПредметов;
		Если ЭлементыФормы.ГруппыПисемДерево.ТекущиеДанные <> Неопределено Тогда
			ТекущаяГруппа = ЭлементыФормы.ГруппыПисемДерево.ТекущиеДанные.Ссылка;
		КонецЕсли; 
	Иначе
		ЭлементыФормы.ПанельСпискаПредметов.ТекущаяСтраница = ЭлементыФормы.ПанельСпискаПредметов.Страницы.ДеревоГрупп;
		Если ЭлементыФормы.ГруппыПисемДерево1.ТекущиеДанные <> Неопределено Тогда
			ТекущаяГруппа = ЭлементыФормы.ГруппыПисемДерево1.ТекущиеДанные.Ссылка;
		КонецЕсли; 
	КонецЕсли;
	Элемент = ПолучитьЭлементГруппыПисемДерево();
	Если ТекущаяГруппа <> Неопределено Тогда
		Элемент.ТекущаяСтрока = ТекущаяГруппа;
	КонецЕсли; 
	
КонецПроцедуры

// Процедура устанавливает/снимает признак пометки удаления у электронных писем.
// 
// Параметры:
//  Элемент - Табличное поле списка электронных писем.
//
Процедура УстановитьПометкуУдаленияЭлектронногоПисьма(Элемент)
	
	Если Элемент.ВыделенныеСтроки.Количество() > 0 Тогда
		
		Если Элемент.ВыделенныеСтроки.Количество() = 1 Тогда
			Если Элемент.ТекущиеДанные.ПометкаУдаления Тогда
				СтрокаВопроса = "Снять с объекта пометку на удаление?";
			Иначе
				СтрокаВопроса = "Пометить объект на удаление?";
			КонецЕсли;
		Иначе
			ФлагУдаления = Ложь;
			ФлагНеУдаления = Ложь;
			Для каждого Строка Из Элемент.ВыделенныеСтроки Цикл
				Если Строка.ПометкаУдаления Тогда
					ФлагУдаления = Истина;
				Иначе
					ФлагНеУдаления = Истина;
				КонецЕсли;
				Если ФлагНеУдаления И ФлагУдаления Тогда
					Прервать;
				КонецЕсли; 
			КонецЦикла; 
			Если ФлагНеУдаления И ФлагУдаления Тогда
				СтрокаВопроса = "Изменить у объектов пометку на удаление?";
			ИначеЕсли ФлагУдаления Тогда
				СтрокаВопроса = "Снять с объекта пометку на удаление?";
			Иначе
				СтрокаВопроса = "Пометить объект на удаление?";
			КонецЕсли;
		КонецЕсли; 
		
		ОтветНаВопрос = Вопрос(СтрокаВопроса, РежимДиалогаВопрос.ДаНет);
		Если ОтветНаВопрос <> КодВозвратаДиалога.Да Тогда
			Возврат;
		КонецЕсли; 
		
		ВсегоПисем = Элемент.ВыделенныеСтроки.Количество();
		ТекСтрока = 0;
		Для каждого ВыбраннаяСтрока Из Элемент.ВыделенныеСтроки Цикл
			ТекСтрока = ТекСтрока + 1;
			Состояние("Обработно " + Строка(ТекСтрока) + " из " + Строка(ВсегоПисем));
			Объект = ВыбраннаяСтрока.ПолучитьОбъект();
			Попытка
				Объект.УстановитьПометкуУдаления(НЕ Объект.ПометкаУдаления);
			Исключение
				Сообщить(ОписаниеОшибки());
			КонецПопытки;
		КонецЦикла; 
		
	КонецЕсли;
	
	СобратьСтатистикуРассмотренностиПисем();
	
КонецПроцедуры

// Процедура формирует новый документ "Событие" на основании электронного письма.
//
Процедура ВвестиСобытиеПоПисьму()
	
	Если ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные <> Неопределено Тогда
		НовоеСобытие = Документы.Событие.СоздатьДокумент();
		НовоеСобытие.Заполнить(ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные.Ссылка);
		НовоеСобытие.ПолучитьФорму().Открыть();
	КонецЕсли; 
	
КонецПроцедуры

Процедура СоздатьПисьмоСВложениями(ПараметрыПеретаскивания)
	
	// Определим учетную запись для создания письма
	УчетнаяЗапись = Неопределено;
	
	СписокДоступныхЗаписей = УправлениеЭлектроннойПочтой.ПроверитьУчетныеЗаписиДляОтправкиПисем(глЗначениеПеременной("глТекущийПользователь"));
	Если СписокДоступныхЗаписей.Количество() = 0 Тогда
		Возврат;
	КонецЕсли; 
	
	Если НЕ ЗначениеЗаполнено(УчетнаяЗапись) Тогда
		УчетнаяЗапись = УправлениеПользователями.ПолучитьЗначениеПоУмолчанию(глЗначениеПеременной("глТекущийПользователь"), "ОсновнаяУчетнаяЗапись");
		Если СписокДоступныхЗаписей.НайтиПоЗначению(УчетнаяЗапись) = Неопределено Тогда
			УчетнаяЗапись = Неопределено;
		КонецЕсли; 
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(УчетнаяЗапись) Тогда
		УчетнаяЗапись = СписокДоступныхЗаписей[0].Значение;
	КонецЕсли;
	
	// создадим письмо
	Письмо = Документы.ЭлектронноеПисьмо.СоздатьДокумент();
	Письмо.УчетнаяЗапись = УчетнаяЗапись;
	
	Форма = Письмо.ПолучитьФорму();
	
	Если ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("Файл") Тогда
		
		// добавим вложение
		ПолученныйФайл = ПараметрыПеретаскивания.Значение;
		
		НоваяСтрока = Форма.ВложенияПисьмаТЗ.Добавить();
		Попытка
			НоваяСтрока.Данные = Новый ХранилищеЗначения(Новый ДвоичныеДанные(ПолученныйФайл.ПолноеИмя), Новый СжатиеДанных);
			НоваяСтрока.ИмяФайла = Сред(ПолученныйФайл.ПолноеИмя, СтрДлина(ПолученныйФайл.Путь) + 1);
		Исключение
			ОбщегоНазначения.СообщитьОбОшибке(ОписаниеОшибки());
		КонецПопытки;
		
	ИначеЕсли ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("Массив") Тогда
		
		Массив = ПараметрыПеретаскивания.Значение;
		
		Для каждого ПолученныйФайл Из Массив Цикл
			
			Состояние("Добавляется файл: " + ПолученныйФайл.Имя);
			
			НачатьТранзакцию();
			
			Отказ = Ложь;
			
			НоваяСтрока = Форма.ВложенияПисьмаТЗ.Добавить();
			Попытка
				НоваяСтрока.Данные = Новый ХранилищеЗначения(Новый ДвоичныеДанные(ПолученныйФайл.ПолноеИмя), Новый СжатиеДанных);
				НоваяСтрока.ИмяФайла = Сред(ПолученныйФайл.ПолноеИмя, СтрДлина(ПолученныйФайл.Путь) + 1);
			Исключение
				ОбщегоНазначения.СообщитьОбОшибке(ОписаниеОшибки());
				Отказ = Истина;
			КонецПопытки;
			
			Если Отказ Тогда
				ОтменитьТранзакцию();
			Иначе
				ЗафиксироватьТранзакцию();
			КонецЕсли; 
			
		КонецЦикла;
		
	КонецЕсли;
	
	Форма.Открыть();
	
КонецПроцедуры

// Процедура предоставляет сервис при нажатие кнопки "Вложение"
//
Процедура НажатиеКнопкиВложения(Элемент, Ссылка, ПометкаУдаления)
	
	ПоВложениямПисем = (ТипЗнч(Ссылка) = Тип("ДокументСсылка.ЭлектронноеПисьмо"));
	
	Запрос = Новый Запрос;
	
	Запрос.УстановитьПараметр("ТекСсылка"   , Ссылка);
	Запрос.УстановитьПараметр("ПустаяСтрока", "");
	
	Если ПоВложениямПисем Тогда
		Запрос.Текст = "
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ВложенияЭлектронныхПисем.Ссылка   КАК Ссылка,
		|	ВложенияЭлектронныхПисем.ИмяФайла КАК ИмяФайла
		|ИЗ
		|	Справочник.ВложенияЭлектронныхПисем КАК ВложенияЭлектронныхПисем
		|ГДЕ
		|	ВложенияЭлектронныхПисем.Объект = &ТекСсылка
		|	И
		|	ВложенияЭлектронныхПисем.ИДФайлаПочтовогоПисьма = &ПустаяСтрока
		|";
		
		Если НЕ ПометкаУдаления Тогда
			Запрос.Текст = Запрос.Текст + "
			|	И
			|	ВложенияЭлектронныхПисем.ПометкаУдаления = Ложь
			|";
		КонецЕсли; 
	Иначе
		Запрос.Текст = "
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ХранилищеДополнительнойИнформации.Ссылка   КАК Ссылка,
		|	ХранилищеДополнительнойИнформации.ИмяФайла КАК ИмяФайла
		|ИЗ
		|	Справочник.ХранилищеДополнительнойИнформации КАК ХранилищеДополнительнойИнформации
		|ГДЕ
		|	ХранилищеДополнительнойИнформации.Объект = &ТекСсылка
		|";
		
		Если НЕ ПометкаУдаления Тогда
			Запрос.Текст = Запрос.Текст + "
			|	И
			|	ХранилищеДополнительнойИнформации.ПометкаУдаления = Ложь
			|";
		КонецЕсли; 
	КонецЕсли;
	
	СписокВыбора = Новый СписокЗначений;
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		Картинка = РаботаСФайлами.ПолучитьПиктограммуФайла(РаботаСФайлами.ПолучитьРасширениеФайла(Выборка.ИмяФайла));
		СписокВыбора.Добавить(Выборка.Ссылка, Выборка.ИмяФайла,, Картинка);
	КонецЦикла;
	
	СписокВыбора.Добавить("", "Открыть список вложений");
	
	ВыбранныйЭлемент = ЭтаФорма.ВыбратьИзМеню(СписокВыбора, Элемент);
	
	Если ВыбранныйЭлемент = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если ВыбранныйЭлемент.Значение = "" Тогда
		
		Если ПоВложениямПисем Тогда
			ФормаФайлов = Справочники.ВложенияЭлектронныхПисем.ПолучитьФорму("ФормаСпискаФайловИИзображений", ЭтаФорма);
			
			ФормаФайлов.Отбор.Объект.Использование = Истина;
			ФормаФайлов.Отбор.Объект.ВидСравнения  = ВидСравнения.Равно;
			ФормаФайлов.Отбор.Объект.Значение      = Ссылка;
			ФормаФайлов.ЭлементыФормы.СправочникСписок.НастройкаОтбора.Объект.Доступность = Ложь;
			
			ФормаФайлов.ОбязательныеОтборы = Новый Структура("Объект", Ссылка);
			ФормаФайлов.Заголовок = "Вложения письма (" + СокрЛП(Строка(Ссылка)) + ")";
			ФормаФайлов.Открыть();
		Иначе
			ФормаФайлов = Справочники.ХранилищеДополнительнойИнформации.ПолучитьФорму("ФормаСпискаФайловИИзображений", ЭтаФорма);
			
			// Изображения
			ФормаФайлов.Изображения.Отбор.Объект.Использование = Истина;
			ФормаФайлов.Изображения.Отбор.Объект.ВидСравнения  = ВидСравнения.Равно;
			ФормаФайлов.Изображения.Отбор.Объект.Значение      = Ссылка;
			ФормаФайлов.ЭлементыФормы.Изображения.НастройкаОтбора.Объект.Доступность = Ложь;
			
			// Дополнительные файлы
			ФормаФайлов.ДополнительныеФайлы.Отбор.Объект.Использование = Истина;
			ФормаФайлов.ДополнительныеФайлы.Отбор.Объект.ВидСравнения  = ВидСравнения.Равно;
			ФормаФайлов.ДополнительныеФайлы.Отбор.Объект.Значение      = Ссылка;
			ФормаФайлов.ЭлементыФормы.ДополнительныеФайлы.НастройкаОтбора.Объект.Доступность = Ложь;
			
			ФормаФайлов.ОбязательныеОтборы = Новый Структура("Объект", Ссылка);
			ФормаФайлов.Заголовок = "Файлы (" + СокрЛП(Строка(Ссылка)) + ")";
			ФормаФайлов.Открыть();
		КонецЕсли;
		
	Иначе
		
		ОткликФормы = ЭтотОбъект.ПолучитьФорму("ФормаОткрытияВложений").ОткрытьМодально();
		
		Если ОткликФормы = Неопределено ИЛИ ТипЗнч(ОткликФормы) <> Тип("Булево") Тогда
			Возврат;
		КонецЕсли;
		
		Если ОткликФормы Тогда
			РаботаСФайлами.ОткрытьФайлы(ВыбранныйЭлемент.Значение,, Ложь);
		Иначе
			
			СохраненноеИмяКаталога = ВосстановитьЗначение("ИмяКаталогаСохраненияФайлов");
			Если СохраненноеИмяКаталога = Неопределено Тогда
				ИмяКаталога = РаботаСФайлами.ПолучитьИмяКаталога();
			Иначе
				ИмяКаталога = СохраненноеИмяКаталога;
			КонецЕсли;
			
			ТолькоЧтение = Ложь;
			
			Если ПоВложениямПисем Тогда
				ФормаСохраненияФайлов = Справочники.ВложенияЭлектронныхПисем.ПолучитьФорму("ФормаСохраненияФайлов");
			Иначе
				ФормаСохраненияФайлов = Справочники.ХранилищеДополнительнойИнформации.ПолучитьФорму("ФормаСохраненияФайлов");
			КонецЕсли;
			ФормаСохраненияФайлов.ИмяКаталога    = ИмяКаталога;
			ФормаСохраненияФайлов.ТолькоЧтение   = ТолькоЧтение;
			ФормаСохраненияФайлов.ОткрытьКаталог = Ложь;
			СтруктураПараметров = ФормаСохраненияФайлов.ОткрытьМодально();
			
			Если СтруктураПараметров = Неопределено Тогда
				Возврат;
			КонецЕсли;
			
			Если Не РаботаСФайлами.ПроверитьСуществованиеКаталога(СтруктураПараметров.ИмяКаталога) Тогда
				Возврат;
			КонецЕсли;
			
			СохранитьЗначение("ИмяКаталогаСохраненияФайлов", СтруктураПараметров.ИмяКаталога);
			
			СпособПерезаписи = "";
			
			ИмяФайла = РаботаСФайлами.ПолучитьИмяФайла(СтруктураПараметров.ИмяКаталога, РаботаСФайлами.УдалитьЗапрещенныеСимволыИмени(ВыбранныйЭлемент.Значение.ИмяФайла));
			Состояние("Сохраняется файл: " + ИмяФайла);
			РаботаСФайлами.СохранитьФайлНаДиске(ВыбранныйЭлемент.Значение.Хранилище, ИмяФайла, СтруктураПараметров.ТолькоЧтение, СпособПерезаписи);
			
			Если СтруктураПараметров.ОткрытьКаталог Тогда
				ЗапуститьПриложение("explorer " + СтруктураПараметров.ИмяКаталога);
			КонецЕсли;
			
		КонецЕсли; 
		
	КонецЕсли; 
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

// Обработчик события ОбработкаВыбора формы.
//
Процедура ОбработкаВыбора(ЗначениеВыбора, Источник)
	
	Если ТипЗнч(ЗначениеВыбора) = Тип("Строка") И ЗначениеВыбора = "ЗаписаноЭлектронноеПисьмо" Тогда
		СписокНепрочитанностиПисем.Очистить();
		Если ЭлементыФормы.ОсновнаяПанель.ТекущаяСтраница.Имя = "Почта" Тогда
			СохранитьТекущийПредмет();
			ОбщееОбновлениеПочты(Ложь);
		КонецЕсли;
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события ОбработкаОповещения формы.
//
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	
	Если ИмяСобытия = "РоботПолученияПисем" Тогда
		СохранитьТекущийПредмет();
		ОбщееОбновлениеПочты(Ложь, Ложь);
	ИначеЕсли ИмяСобытия = "ОбновитьСписокКандидатов" Тогда
		СписокДанныхПоПисьмам.Очистить();
		ЗаполнитьТаблицуПретендентов();
		Если ЗначениеЗаполнено(Параметр) Тогда
			ДанныеДляПоиска = Новый Структура("Претендент",Параметр);
			
		КонецЕсли;
	ИначеЕсли ИмяСобытия = "ОбновитьДанныеОФизлице" Тогда
		Если ЗначениеЗаполнено(Параметр) Тогда
		КонецЕсли;
	ИначеЕсли ИмяСобытия = "ЗаписанОбъект" Тогда
		ОбработкаЗаписиНовогоОбъекта(Параметр,Источник);
	ИначеЕсли ИмяСобытия = "ЗаписанаКИ" Тогда
		Отказ = Ложь;
	КонецЕсли; 
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ЭЛЕМЕНТОВ ФОРМЫ

// Обработчик события НачалоПеретаскивания элемента формы ЭлектронныеПисьмаСписок.
//
Процедура ЭлектронныеПисьмаСписокНачалоПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка)
	
	ПараметрыПеретаскивания.ДопустимыеДействия = ДопустимыеДействияПеретаскивания.Перемещение;
	ПараметрыПеретаскивания.Значение = Новый Структура("ПараметрыПеретаскивания", ПараметрыПеретаскивания.Значение);
	
КонецПроцедуры

// Обработчик события onclick элемента формы ПолеHTMLДокумента.
//
Процедура ПолеHTMLДокументаonclick(Элемент, pEvtObj)
	
	Если ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные = Неопределено Тогда
		УправлениеЭлектроннойПочтой.ОбработкаСобытияOnClickПоляHTML(глЗначениеПеременной("глТекущийПользователь"), Элемент, pEvtObj,,, ЭтаФорма);
	Иначе
		УправлениеЭлектроннойПочтой.ОбработкаСобытияOnClickПоляHTML(глЗначениеПеременной("глТекущийПользователь"), Элемент, pEvtObj, ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные.УчетнаяЗапись, ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные.Ссылка.ГруппаУчетнойЗаписи, ЭтаФорма, ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные.Ссылка);
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события ПроверкаПеретаскивания элемента формы ГруппыПисемДерево.
//
Процедура ГруппыПисемДеревоПроверкаПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Строка, Колонка)
	
	Если ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("Массив") или ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("Файл") Тогда
		СтандартнаяОбработка = Ложь;
		Возврат;
	КонецЕсли;
	
	Если ТипЗнч(Строка) <> Тип("СправочникСсылка.ГруппыПисемЭлектроннойПочты") Тогда
		ПараметрыПеретаскивания.Действие = ДействиеПеретаскивания.Отмена;
		Возврат;
	КонецЕсли;
	
	СтандартнаяОбработка = Ложь;
	
	Если ЗначениеЗаполнено(Строка.Владелец.ГруппаЧерновики) И Строка = Строка.Владелец.ГруппаЧерновики Тогда
		ПараметрыПеретаскивания.Действие = ДействиеПеретаскивания.Отмена;
		Возврат;
	КонецЕсли;
	
	Если ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("Структура") Тогда
		
		ЗначениеПеретаскивания = ПараметрыПеретаскивания.Значение.ПараметрыПеретаскивания;
		
		Если ТипЗнч(ЗначениеПеретаскивания) = Тип("Массив") Тогда
			Если ЗначениеПеретаскивания.Количество() = 1 Тогда
				ЗначениеПеретаскивания = ЗначениеПеретаскивания[0];
			Иначе
				Возврат;
			КонецЕсли; 
		КонецЕсли;
		
		Если ТипЗнч(ЗначениеПеретаскивания) = Тип("ДокументСсылка.ЭлектронноеПисьмо") Тогда
			Если НЕ ЗначениеЗаполнено(Строка.Владелец.ГруппаУдаленные) Тогда
				Если ЗначениеПеретаскивания.ГруппаУчетнойЗаписи = Строка Тогда
					ПараметрыПеретаскивания.Действие = ДействиеПеретаскивания.Отмена;
				КонецЕсли;
			Иначе
				Если (Строка.Владелец <> ЗначениеПеретаскивания.УчетнаяЗапись И Строка.Владелец.ГруппаУдаленные = Строка)
					ИЛИ (Строка = Строка.Владелец.ГруппаУдаленные И ЗначениеПеретаскивания.ПометкаУдаления)
					ИЛИ (ЗначениеПеретаскивания.ГруппаУчетнойЗаписи = Строка И НЕ ЗначениеПеретаскивания.ПометкаУдаления) Тогда
					ПараметрыПеретаскивания.Действие = ДействиеПеретаскивания.Отмена;
				КонецЕсли;
			КонецЕсли; 
		КонецЕсли;
		
	ИначеЕсли ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("СправочникСсылка.ГруппыПисемЭлектроннойПочты") Тогда
		
		Если НЕ ЗначениеЗаполнено(Строка) И (НЕ Элемент.Значение.Отбор.Владелец.Использование ИЛИ ТипЗнч(Элемент.Значение.Отбор.Владелец.Значение) <> Тип("СправочникСсылка.УчетныеЗаписиЭлектроннойПочты")) Тогда
			ПараметрыПеретаскивания.Действие = ДействиеПеретаскивания.Отмена;
		Иначе
			УчетнаяЗаписьОбъектаПеретаскивания = ПараметрыПеретаскивания.Значение.Владелец;
			ДоступКУчетнойЗаписи = УчетнаяЗаписьОбъектаПеретаскивания.ДоступКУчетнойЗаписи.Найти(глЗначениеПеременной("глТекущийПользователь"));
			Если ДоступКУчетнойЗаписи = Неопределено ИЛИ НЕ ДоступКУчетнойЗаписи.Администрирование ИЛИ (ЗначениеЗаполнено(Строка) И Строка.Владелец <> УчетнаяЗаписьОбъектаПеретаскивания) Тогда
				ПараметрыПеретаскивания.Действие = ДействиеПеретаскивания.Отмена;
			КонецЕсли; 
		КонецЕсли; 
		
	КонецЕсли;
	
КонецПроцедуры

// Обработчик события Перетаскивание элемента формы ГруппыПисемДерево.
//
Процедура ГруппыПисемДеревоПеретаскивание(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Строка, Колонка)
	
	Если ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("Структура") Тогда
		
		СтандартнаяОбработка = Ложь;
		
		ПереносВДругуюУчетнуюЗапись = Неопределено;
		
		ЗначениеПеретаскивания = ПараметрыПеретаскивания.Значение.ПараметрыПеретаскивания;
		
		Если ТипЗнч(Строка) = Тип("СправочникСсылка.ГруппыПисемЭлектроннойПочты") Тогда
			Если ТипЗнч(ЗначениеПеретаскивания) = Тип("ДокументСсылка.ЭлектронноеПисьмо") Тогда
				Если НЕ Строка.Пустая() И Строка.Владелец <> ЗначениеПеретаскивания.УчетнаяЗапись Тогда
					Если ПереносВДругуюУчетнуюЗапись = Неопределено Тогда
						ОтветНаВопрос = Вопрос("Перенести письмо в другую учетную запись?", РежимДиалогаВопрос.ДаНет);
						Если ОтветНаВопрос <> КодВозвратаДиалога.Да Тогда
							ПереносВДругуюУчетнуюЗапись = Ложь;
							Возврат;
						Иначе
							ПереносВДругуюУчетнуюЗапись = Истина;
						КонецЕсли; 
					ИначеЕсли ПереносВДругуюУчетнуюЗапись = Ложь Тогда
						Возврат;
					КонецЕсли; 
				КонецЕсли; 
				ДокументОбъект = ЗначениеПеретаскивания.ПолучитьОбъект();
				Если НЕ Строка.Пустая() Тогда
					ДокументОбъект.УчетнаяЗапись       = Строка.Владелец;
				КонецЕсли; 
				ДокументОбъект.ГруппаУчетнойЗаписи = Строка;
				Попытка
					ДокументОбъект.Записать(РежимЗаписиДокумента.Запись);
				Исключение
					Сообщить(ОписаниеОшибки());
				КонецПопытки;
			ИначеЕсли ТипЗнч(ЗначениеПеретаскивания) = Тип("Массив") Тогда
				НачатьТранзакцию();
				Отказ = Ложь;
				Если Строка.Владелец.ГруппаУдаленные = Строка И ЗначениеЗаполнено(Строка) Тогда
					ЭтоКорзина = Истина;
				Иначе
					ЭтоКорзина = Ложь;
				КонецЕсли;
				КоличествоВсего = ЗначениеПеретаскивания.Количество();
				КолТекущийЭлемент = 0;
				Для каждого ЭлементМассива Из ЗначениеПеретаскивания Цикл
					КолТекущийЭлемент = КолТекущийЭлемент + 1;
					Состояние("Обработано: " + КолТекущийЭлемент + " из " + КоличествоВсего);
					Если ТипЗнч(ЭлементМассива) <> Тип("ДокументСсылка.ЭлектронноеПисьмо") Тогда
						Продолжить;
					КонецЕсли;
					Если НЕ Строка.Пустая() И Строка.Владелец <> ЭлементМассива.УчетнаяЗапись Тогда
						Если ПереносВДругуюУчетнуюЗапись = Неопределено Тогда
							ОтветНаВопрос = Вопрос("Разрешить перенесить письма в другую учетную запись?", РежимДиалогаВопрос.ДаНет);
							Если ОтветНаВопрос <> КодВозвратаДиалога.Да Тогда
								ПереносВДругуюУчетнуюЗапись = Ложь;
								Продолжить;
							Иначе
								ПереносВДругуюУчетнуюЗапись = Истина;
							КонецЕсли; 
						ИначеЕсли ПереносВДругуюУчетнуюЗапись = Ложь Тогда
							Продолжить;
						КонецЕсли; 
					КонецЕсли; 
					Если ЭтоКорзина И Строка.Владелец <> ЭлементМассива.УчетнаяЗапись Тогда
						Сообщить("Нельзя переносить в корзину другой учетной записи. Электронное письмо № " + СокрЛП(ЭлементМассива.Номер) + " не перенесено.");
						Продолжить;
					КонецЕсли; 
					ДокументОбъект = ЭлементМассива.ПолучитьОбъект();
					Если НЕ Строка.Пустая() Тогда
						ДокументОбъект.УчетнаяЗапись = Строка.Владелец;
					КонецЕсли;
					Если НЕ ЭтоКорзина Тогда
						ДокументОбъект.ГруппаУчетнойЗаписи = Строка;
					КонецЕсли;
					Если ЗначениеЗаполнено(Строка.Владелец.ГруппаУдаленные) Тогда
						ДокументОбъект.ПометкаУдаления = ЭтоКорзина;
					КонецЕсли; 
					Попытка
						ДокументОбъект.Записать(РежимЗаписиДокумента.Запись);
					Исключение
						Сообщить(ОписаниеОшибки());
						Отказ = Истина;
						Прервать;
					КонецПопытки;
				КонецЦикла;
				Если Отказ Тогда
					ОтменитьТранзакцию();
				Иначе
					ЗафиксироватьТранзакцию();
				КонецЕсли;
			КонецЕсли; 
		КонецЕсли;
		
	ИначеЕсли ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("СправочникСсылка.ГруппыПисемЭлектроннойПочты") Тогда
		
		Если Строка.Владелец = ПараметрыПеретаскивания.Значение.Владелец ИЛИ НЕ ЗначениеЗаполнено(Строка.Владелец) Тогда
			
			Если ПараметрыПеретаскивания.Действие = ДействиеПеретаскивания.Перемещение Тогда
				ОбъектДляЗаписи = ПараметрыПеретаскивания.Значение.Получитьобъект();
			ИначеЕсли ПараметрыПеретаскивания.Действие = ДействиеПеретаскивания.Копирование Тогда
				ОбъектДляЗаписи = ПараметрыПеретаскивания.Значение.Скопировать();
			КонецЕсли;
			
			ОбъектДляЗаписи.Родитель = Строка;
			
			Попытка
				ОбъектДляЗаписи.Записать();
			Исключение
				Сообщить(ОписаниеОшибки());
			КонецПопытки;
			
		КонецЕсли; 
		
	ИначеЕсли ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("Файл") или ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("Массив") Тогда
		
		СтандартнаяОбработка = Ложь;
		
		СоздатьПисьмоСВложениями(ПараметрыПеретаскивания);
		
	КонецЕсли;
	
	СобратьСтатистикуРассмотренностиПисем();
	
КонецПроцедуры

// Обработчик события ПриИзменении элемента формы УчетнаяЗапись.
//
Процедура УчетнаяЗаписьПриИзменении(Элемент)
	
	УстановитьОтборГрупп();
	
	Если ЗначениеЗаполнено(УчетнаяЗапись) И мОтображатьСписокПредметов Тогда
		мОтображатьСписокПредметов = ФлагКлассификацииПисемПоПредметам(УчетнаяЗапись);
	Иначе
		ОтображениеПредметов = Ложь;
		Для каждого ЭлементСписка Из Элемент.СписокВыбора Цикл
			Если ФлагКлассификацииПисемПоПредметам(ЭлементСписка.Значение) Тогда
				ОтображениеПредметов = Истина;
				Прервать;
			КонецЕсли; 
		КонецЦикла; 
		Если НЕ ОтображениеПредметов И мОтображатьСписокПредметов Тогда
			мОтображатьСписокПредметов = Ложь;
		КонецЕсли; 
	КонецЕсли; 
	
	ЭлементыФормы.КоманднаяПанельПочты.Кнопки.Подменю.Кнопки.ПредметыПисем.Пометка = мОтображатьСписокПредметов;
	
	СобратьСтатистикуРассмотренностиПисем();
	
	УстановитьОтборПредметов();
	ВидимостьСпискаПредметов();
	
	ЭлементГруппыПисемДерево = ПолучитьЭлементГруппыПисемДерево();
	ГруппыПисем_ПриАктивизацииСтроки(ЭлементГруппыПисемДерево);
	
КонецПроцедуры

// Обработчик события Открытие элемента формы УчетнаяЗапись.
//
Процедура УчетнаяЗаписьОткрытие(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	Если ЗначениеЗаполнено(УчетнаяЗапись) Тогда
		УчетнаяЗапись.ПолучитьФорму().Открыть();
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события Нажатие элемента формы КнопкаВложения.
//
Процедура КнопкаВложенияНажатие(Элемент)
	
	Если ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли; 
	
	НажатиеКнопкиВложения(Элемент, ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные.Ссылка, ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные.ПометкаУдаления);
	
КонецПроцедуры

// Обработчик события ПриВыводеСтроки элемента формы ГруппыПисемДерево.
//
Процедура ГруппыПисемДеревоПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	
	Если ДанныеСтроки = Неопределено Тогда
		ОформлениеСтроки.Ячейки.Наименование.ИндексКартинки = 1;
	Иначе
		Если НЕ ЗначениеЗаполнено(ДанныеСтроки.Владелец) Тогда
			ОформлениеСтроки.Ячейки.Наименование.ИндексКартинки = 1;
		Иначе
			ГруппаВходящие  = мСоответствияГруппВходящие.Получить(ДанныеСтроки.Владелец);
			ГруппаИсходящие = мСоответствияГруппИсходящие.Получить(ДанныеСтроки.Владелец);
			ГруппаУдаленные = мСоответствияГруппУдаленные.Получить(ДанныеСтроки.Владелец);
			ГруппаЧерновики = мСоответствияГруппЧерновики.Получить(ДанныеСтроки.Владелец);
			Если ГруппаВходящие = ДанныеСтроки.Ссылка Тогда
				ОформлениеСтроки.Ячейки.Наименование.ИндексКартинки = 3;
			ИначеЕсли ГруппаИсходящие = ДанныеСтроки.Ссылка Тогда
				ОформлениеСтроки.Ячейки.Наименование.ИндексКартинки = 2;
			ИначеЕсли ГруппаУдаленные = ДанныеСтроки.Ссылка Тогда
				ОформлениеСтроки.Ячейки.Наименование.ИндексКартинки = 0;
			ИначеЕсли ГруппаЧерновики = ДанныеСтроки.Ссылка Тогда
				СтатистикаГруппы = мСтатистикаСохраненныхПисем.Получить(ГруппаЧерновики);
				Если ТипЗнч(СтатистикаГруппы) = Тип("Число") И СтатистикаГруппы > 0 Тогда
					ОформлениеСтроки.Ячейки.Наименование.ИндексКартинки = 6;
				Иначе
					ОформлениеСтроки.Ячейки.Наименование.ИндексКартинки = 5;
				КонецЕсли; 
			Иначе
				Если ДанныеСтроки.ПометкаУдаления Тогда
					ОформлениеСтроки.Ячейки.Наименование.ИндексКартинки = 4;
				Иначе
					ОформлениеСтроки.Ячейки.Наименование.ИндексКартинки = 1;
				КонецЕсли; 
			КонецЕсли; 
		КонецЕсли;
		
	КонецЕсли;
	
	СтатистикаГруппы = мСтатистикаРассмотренностиПисем.Получить(?(ДанныеСтроки = Неопределено, Справочники.ГруппыПисемЭлектроннойПочты.ПустаяСсылка(), ДанныеСтроки.Ссылка));
	Если ТипЗнч(СтатистикаГруппы) = Тип("Число") И СтатистикаГруппы > 0 Тогда
		ОформлениеСтроки.Ячейки.Наименование.Текст = Строка(ДанныеСтроки.Наименование) + " (" + СтатистикаГруппы + ")";
		ОформлениеСтроки.Шрифт = мЖирныйШрифт;
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события Выбор элемента формы ГруппыПисемДерево.
//
Процедура ГруппыПисемДеревоВыбор(Элемент, ВыбраннаяСтрока, Колонка, СтандартнаяОбработка)
	
	Если мИзменятьСписокЭлектронныхПисемПриВыбореПапкиПисем Тогда
		СтандартнаяОбработка = Ложь;
		ГруппыПисем_ПриАктивизацииСтроки(Элемент);
		ПредметыСписок_ПриАктивизацииСтроки();
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события ПриАктивизацииСтроки элемента формы ГруппыПисемДерево.
//
Процедура ГруппыПисемДеревоПриАктивизацииСтроки(Элемент)
	
	Если НЕ мИзменятьСписокЭлектронныхПисемПриВыбореПапкиПисем Тогда
		ГруппыПисем_ПриАктивизацииСтроки(Элемент);
		ПредметыСписок_ПриАктивизацииСтроки();
	КонецЕсли;
	
КонецПроцедуры

// Обработчик события ПередНачаломДобавления элемента формы ГруппыПисемДерево.
//
Процедура ГруппыПисемДеревоПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, ЭтоГруппа)
	
	Если Элемент.ТекущиеДанные = Неопределено И НЕ ЗначениеЗаполнено(УчетнаяЗапись) Тогда
		Отказ = Истина;
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события НачалоПеретаскивания элемента формы ГруппыПисемДерево.
//
Процедура ГруппыПисемДеревоНачалоПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка)
	
	ПараметрыПеретаскивания.ДопустимыеДействия = ДопустимыеДействияПеретаскивания.КопированиеИПеремещение;
	
КонецПроцедуры

// Обработчик события ПриПолученииДанных элемента формы ПредметыСписок.
//
Процедура ПредметыСписокПриПолученииДанных(Элемент, ОформленияСтрок)
	
	// найдем новые ссылки
	СписокПредметов = Новый СписокЗначений;
	Для каждого ОформлениеСтроки из ОформленияСтрок Цикл
		
		ЗначениеПоиска = СписокДанныхПоПредметам[Нрег(ОформлениеСтроки.ДанныеСтроки.Предмет)];
		
		Если ЗначениеПоиска = Неопределено Тогда
			СписокПредметов.Добавить(ОформлениеСтроки.ДанныеСтроки.Предмет);
			СписокДанныхПоПредметам.Вставить(Нрег(ОформлениеСтроки.ДанныеСтроки.Предмет),0);
		КонецЕсли;
		
	КонецЦикла;
	
	ЭлементГруппыПисемДерево = ПолучитьЭлементГруппыПисемДерево();
	
	// получим но новым ссылкам количество писем
	Если СписокПредметов.Количество() > 0 Тогда
		ПодготовитьТаблицуПоПредметам(СписокПредметов,?(ЭлементГруппыПисемДерево.ТекущиеДанные = Неопределено,Неопределено,ЭлементГруппыПисемДерево.ТекущиеДанные.Ссылка));
		Для каждого СтрокаТаблицы из ТаблицаДанныхПоПредметам Цикл
			Если СтрокаТаблицы.КоличествоПисемСОбъектами > 0 Тогда
				СписокДанныхПоПредметам.Вставить(Нрег(СтрокаТаблицы.Предмет),?(СтрокаТаблицы.КоличествоПисем>СтрокаТаблицы.КоличествоПисемСОбъектами,1,2));
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	// отразим в оформлении строк
	Для каждого ОформлениеСтроки из ОформленияСтрок Цикл
		ЗначениеПоиска = СписокДанныхПоПредметам[Нрег(ОформлениеСтроки.ДанныеСтроки.Предмет)];
		Если ЗначениеПоиска <> Неопределено Тогда
			ОформлениеСтроки.Ячейки.Предмет.ИндексКартинки = ЗначениеПоиска;
		КонецЕсли; 
		
		СтатистикаГруппы = мСтатистикаРассмотренностиПисемПоПредметам.Получить(ОформлениеСтроки.ДанныеСтроки.ГруппаПисемЭлектроннойПочты);
		Если СтатистикаГруппы <> Неопределено Тогда
			СтатистикаПредмета = СтатистикаГруппы.Получить(ОформлениеСтроки.ДанныеСтроки.Предмет);
			Если ТипЗнч(СтатистикаПредмета) = Тип("Число") И СтатистикаПредмета > 0 Тогда
				ОформлениеСтроки.Ячейки.Предмет.ОтображатьТекст = Истина;
				Если НЕ ЗначениеЗаполнено(ОформлениеСтроки.ДанныеСтроки.Предмет) Тогда
					ОформлениеСтроки.Ячейки.Предмет.Текст = "<Предмет не указан>" + " (" + СтатистикаПредмета + ")";
				Иначе
					ОформлениеСтроки.Ячейки.Предмет.Текст = Строка(ОформлениеСтроки.ДанныеСтроки.Предмет) + " (" + СтатистикаПредмета + ")";
				КонецЕсли; 
				ОформлениеСтроки.Шрифт = мЖирныйШрифт;
			Иначе
				Если НЕ ЗначениеЗаполнено(ОформлениеСтроки.ДанныеСтроки.Предмет) Тогда
					ОформлениеСтроки.Ячейки.Предмет.ОтображатьТекст = Истина;
					ОформлениеСтроки.Ячейки.Предмет.Текст = "<Предмет не указан>";
				КонецЕсли;
			КонецЕсли;
		Иначе
			Если НЕ ЗначениеЗаполнено(ОформлениеСтроки.ДанныеСтроки.Предмет) Тогда
				ОформлениеСтроки.Ячейки.Предмет.ОтображатьТекст = Истина;
				ОформлениеСтроки.Ячейки.Предмет.Текст = "<Предмет не указан>";
			КонецЕсли;
		КонецЕсли;
		
		Если ОформлениеСтроки.ДанныеСтроки.Скрытый Тогда
			ОформлениеСтроки.Ячейки.Предмет.ЦветТекста = WebЦвета.Серый;
		Иначе
			Если мКнопкаОтображатьСкрытыеПредметыПисем.Пометка Тогда
				ОформлениеСтроки.Ячейки.Предмет.ЦветФона = ЦветаСтиля.ЦветФонаФормы;
			КонецЕсли; 
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ПодготовитьТаблицуПоПредметам(СписокПредметов,ГруппаПисемЭлектроннойПочты)
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("СписокПредметов",СписокПредметов);
	Запрос.УстановитьПараметр("ГруппаПисемЭлектроннойПочты",ГруппаПисемЭлектроннойПочты);
	
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ПредметыЭлектронныхПисем.Предмет,
	|	КОЛИЧЕСТВО(ПредметыЭлектронныхПисем.Регистратор) КАК КоличествоПисем,
	|	КОЛИЧЕСТВО(ОбъектыЭлектронныхПисемИСобытий.Регистратор) КАК КоличествоПисемСОбъектами
	|ИЗ
	|	РегистрСведений.ПредметыЭлектронныхПисем КАК ПредметыЭлектронныхПисем
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОбъектыЭлектронныхПисемИСобытий КАК ОбъектыЭлектронныхПисемИСобытий
	|	ПО ПредметыЭлектронныхПисем.Предмет = ОбъектыЭлектронныхПисемИСобытий.Предмет
	|	И ПредметыЭлектронныхПисем.Регистратор = ОбъектыЭлектронныхПисемИСобытий.Регистратор
	|ГДЕ
	|	ПредметыЭлектронныхПисем.Предмет в (&СписокПредметов)
	|	И ПредметыЭлектронныхПисем.ГруппаПисемЭлектроннойПочты = &ГруппаПисемЭлектроннойПочты
	|СГРУППИРОВАТЬ ПО
	|	ПредметыЭлектронныхПисем.Предмет";
	
	ТаблицаДанныхПоПредметам = Запрос.Выполнить().Выгрузить();
	
КонецПроцедуры

Процедура ПодготовитьТаблицуПоПисьмам(СписокПисем,ГруппаПисемЭлектроннойПочты)
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("СписокПисем",СписокПисем);
	Запрос.УстановитьПараметр("ГруппаПисемЭлектроннойПочты",ГруппаПисемЭлектроннойПочты);
	
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ЭлектронноеПисьмоОбъектыПисем.Ссылка,
	|	ВЫБОР
	|		КОГДА ОбъектыЭлектронныхПисемИСобытий.Регистратор ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ЕстьОбъекты
	|ИЗ
	|	Документ.ЭлектронноеПисьмо КАК ЭлектронноеПисьмоОбъектыПисем
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОбъектыЭлектронныхПисемИСобытий КАК ОбъектыЭлектронныхПисемИСобытий
	|		ПО ЭлектронноеПисьмоОбъектыПисем.Ссылка = ОбъектыЭлектронныхПисемИСобытий.Регистратор
	|ГДЕ
	|	ЭлектронноеПисьмоОбъектыПисем.Ссылка В(&СписокПисем)
	|	И ЭлектронноеПисьмоОбъектыПисем.Ссылка.ГруппаУчетнойЗаписи = &ГруппаПисемЭлектроннойПочты";
	
	ТаблицаДанныхПоПисьмам = Запрос.Выполнить().Выгрузить();
	
КонецПроцедуры            

// Обработчик события ПриАктивизацииСтроки элемента формы ПредметыСписок.
//
Процедура ПредметыСписокПриАктивизацииСтроки(Элемент)
	
	Если НЕ мИзменятьСписокЭлектронныхПисемПриВыбореПапкиПисем И мОтображатьСписокПредметов Тогда
		ПредметыСписок_ПриАктивизацииСтроки();
	КонецЕсли;
	
КонецПроцедуры

// Обработчик события Выбор элемента формы ПредметыСписок.
//
Процедура ПредметыСписокВыбор(Элемент, ВыбраннаяСтрока, Колонка, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	Если мИзменятьСписокЭлектронныхПисемПриВыбореПапкиПисем Тогда
		ПредметыСписок_ПриАктивизацииСтроки();
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события ПроверкаПеретаскивания элемента формы ПредметыСписок.
//
Процедура ПредметыСписокПроверкаПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Строка, Колонка)
	
	Если ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("Структура") Тогда
		
		СтандартнаяОбработка = Ложь;
		
		ЗначениеПеретаскивания = ПараметрыПеретаскивания.Значение.ПараметрыПеретаскивания;
		
		Если ТипЗнч(ЗначениеПеретаскивания) = Тип("Массив") Тогда
			Если ЗначениеПеретаскивания.Количество() = 1 Тогда
				ЗначениеПеретаскивания = ЗначениеПеретаскивания[0];
			Иначе
				Возврат;
			КонецЕсли;
			Если ТипЗнч(ЗначениеПеретаскивания) <> Тип("ДокументСсылка.ЭлектронноеПисьмо") Тогда
				ПараметрыПеретаскивания.Действие = ДействиеПеретаскивания.Отмена;
			КонецЕсли;
		Иначе
			ПараметрыПеретаскивания.Действие = ДействиеПеретаскивания.Отмена;
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

// Обработчик события Перетаскивание элемента формы ПредметыСписок.
//
Процедура ПредметыСписокПеретаскивание(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Строка, Колонка)
	
	Если ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("Структура") Тогда
		
		СтандартнаяОбработка = Ложь;
		
		ЗначениеПеретаскивания = ПараметрыПеретаскивания.Значение.ПараметрыПеретаскивания;
		
		Если ТипЗнч(Строка) = Тип("РегистрСведенийКлючЗаписи.ПредметыЭлектронныхПисем") Тогда
			Если ТипЗнч(ЗначениеПеретаскивания) = Тип("ДокументСсылка.ЭлектронноеПисьмо") Тогда
				ДокументОбъект = ЗначениеПеретаскивания.ПолучитьОбъект();
				ДокументОбъект.ПредметКонтакта = Строка.Предмет;
				Попытка
					ДокументОбъект.Записать(РежимЗаписиДокумента.Запись);
				Исключение
					Сообщить(ОписаниеОшибки());
				КонецПопытки;
			ИначеЕсли ТипЗнч(ЗначениеПеретаскивания) = Тип("Массив") Тогда
				НачатьТранзакцию();
				Отказ = Ложь;
				КоличествоВсего = ЗначениеПеретаскивания.Количество();
				КолТекущийЭлемент = 0;
				Для каждого ЭлементМассива Из ЗначениеПеретаскивания Цикл
					КолТекущийЭлемент = КолТекущийЭлемент + 1;
					Состояние("Обработано: " + КолТекущийЭлемент + " из " + КоличествоВсего);
					Если ТипЗнч(ЭлементМассива) <> Тип("ДокументСсылка.ЭлектронноеПисьмо") Тогда
						Продолжить;
					КонецЕсли;
					ДокументОбъект = ЭлементМассива.ПолучитьОбъект();
					ДокументОбъект.ПредметКонтакта = Строка.Предмет;
					Попытка
						ДокументОбъект.Записать(РежимЗаписиДокумента.Запись);
					Исключение
						Сообщить(ОписаниеОшибки());
						Отказ = Истина;
						Прервать;
					КонецПопытки;
				КонецЦикла;
				Если Отказ Тогда
					ОтменитьТранзакцию();
				Иначе
					ЗафиксироватьТранзакцию();
				КонецЕсли;
			КонецЕсли; 
		КонецЕсли;
		
	КонецЕсли;
	
	СобратьСтатистикуРассмотренностиПисем();
	СписокДанныхПоПредметам.Очистить();
	
КонецПроцедуры

// Обработчик события ПередНачаломИзменения элемента формы ПредметыСписок.
//
Процедура ПредметыСписокПередНачаломИзменения(Элемент, Отказ)
	
	Отказ = Истина;
	
КонецПроцедуры

// Обработчик события ПередУстановкойПометкиУдаления элемента формы ЭлектронныеПисьмаСписок.
//
Процедура ЭлектронныеПисьмаСписокПередУстановкойПометкиУдаления(Элемент, Отказ)
	
	Отказ = Истина;
	
	СохранитьТекущийПредмет();
	УстановитьПометкуУдаленияЭлектронногоПисьма(Элемент);
	
КонецПроцедуры

// Обработчик события ПриВыводеСтроки элемента формы ЭлектронныеПисьмаСписок.
//
Процедура ЭлектронныеПисьмаСписокПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	
	УправлениеЭлектроннойПочтой.ПриВыводеСтрокиЭлектронногоПисьма(Элемент, ОформлениеСтроки, ДанныеСтроки);
	
	Оформление = ДанныеСтроки.Оформление;
	
	Если ЗначениеЗаполнено(Оформление) Тогда
		
		ЦветТекста = Оформление.ЦветТекста.Получить();
		ЦветФона   = Оформление.ЦветФона.Получить();
		
		Жирный       = Оформление.Жирный;
		Наклонный    = Оформление.Наклонный;
		Подчеркнутый = Оформление.Подчеркнутый;
		Зачеркнутый  = Оформление.Зачеркнутый;
		
		Если ТипЗнч(ЦветТекста) = Тип("Цвет") Тогда
			ОформлениеСтроки.ЦветТекста   = ЦветТекста;
		КонецЕсли;
		
		Если ТипЗнч(ЦветФона)  = Тип("Цвет") Тогда
			ОформлениеСтроки.ЦветФона   = ЦветФона;
		КонецЕсли;
		
		ОформлениеСтроки.Шрифт = Новый Шрифт(,,Жирный,Наклонный,Подчеркнутый,Зачеркнутый);
		
	КонецЕсли;
	
	Если ДанныеСтроки.НеРассмотрено И ДанныеСтроки.РассмотретьПосле < ТекущаяДата() Тогда
		Если НЕ (мОтображатьРассмотренностиПисемТолькоПоТекущемуПользователю И ДанныеСтроки.Ответственный <> глЗначениеПеременной("глТекущийПользователь")И ДанныеСтроки.Ответственный <> Справочники.Пользователи.ПустаяСсылка()) Тогда
			ОформлениеСтроки.Шрифт = мЖирныйШрифт;
		КонецЕсли;
		Если ДанныеСтроки.РассмотретьПосле > мПоследняяДатаОбновленияРассмотренностиПисем Тогда
			СобратьСтатистикуРассмотренностиПисем();
		КонецЕсли; 
	КонецЕсли;
	
	Если Элемент.Колонки.ТекстПисьма.Видимость Тогда
		
		ТекстПисьма = ДанныеСтроки.ТекстПисьма;
		
		Если ДанныеСтроки.ВидТекстаПисьма <> Перечисления.ВидыТекстовЭлектронныхПисем.Текст Тогда
			ТекстПисьма= УправлениеЭлектроннойПочтой.ПреобразоватьТекстИзХТМЛФорматаВПростой(ДанныеСтроки.ТекстПисьма);
		КонецЕсли;
		
		НайденноеСоответствие = СоответствиеСокращенныхТекстовЭлектронныхПисем.Получить(ДанныеСтроки.Ссылка);
		
		Если НайденноеСоответствие = Неопределено Тогда
			ВысотаЯчейки = ОформлениеСтроки.Ячейки.ТекстПисьма.ВысотаЯчейки;
			ТекстПисьма = УправлениеЭлектроннойПочтой.СократитьТекстПисьма(ТекстПисьма,ВысотаЯчейки);
			
			СоответствиеСокращенныхТекстовЭлектронныхПисем.Вставить(ДанныеСтроки.Ссылка,ТекстПисьма);
		Иначе
			ТекстПисьма = НайденноеСоответствие;
		КонецЕсли;
		
		Если ТекстПисьма <> ДанныеСтроки.ТекстПисьма Тогда
			ОформлениеСтроки.Ячейки.ТекстПисьма.Текст = ТекстПисьма;
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ТекстПисьма) Тогда
			ОформлениеСтроки.Ячейки.ТекстПисьма.ИндексКартинки = 21;
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

// Обработчик события ПередНачаломДобавления элемента формы ЭлектронныеПисьмаСписок.
//
Процедура ЭлектронныеПисьмаСписокПередНачаломДобавления(Элемент, Отказ, Копирование)
	
	Отказ = Истина;
	
	НаписатьНовоеПисьмо(Копирование);
	
КонецПроцедуры

// Обработчик события ПриАктивизацииСтроки элемента формы ЭлектронныеПисьмаСписок.
//
Процедура ЭлектронныеПисьмаСписокПриАктивизацииСтроки(Элемент)
	
	ЭлектронныеПисьма_СписокПриАктивизацииСтроки(Элемент);
	
КонецПроцедуры

// Обработчик события ПередНачаломИзменения элемента формы ЭлектронныеПисьмаСписок.
//
Процедура ЭлектронныеПисьмаСписокПередНачаломИзменения(Элемент, Отказ)
	
	ПередНачаломИзмененияЭлектронногоПисьма(Элемент, Отказ);
	
КонецПроцедуры

// Обработчик события ПроверкаПеретаскивания элемента формы ЭлектронныеПисьмаСписок.
//
Процедура ЭлектронныеПисьмаСписокПроверкаПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Строка, Колонка)
	Если ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("Массив") или ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("Файл") Тогда
		СтандартнаяОбработка = Ложь;
	КонецЕсли;
КонецПроцедуры

// Обработчик события Перетаскивание элемента формы ЭлектронныеПисьмаСписок.
//
Процедура ЭлектронныеПисьмаСписокПеретаскивание(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Строка, Колонка)
	
	Если ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("Файл") или ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("Массив") Тогда
		
		СтандартнаяОбработка = Ложь;
		
		СоздатьПисьмоСВложениями(ПараметрыПеретаскивания);
		
	КонецЕсли;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ КОМАНДНЫХ ПАНЕЛЕЙ ФОРМЫ, УСТАНАВЛИВАЕМЫХ СОБЫТИЯ ПРОГРАММНО

// Процедура отправляет подготовленные к отправке письма по текущей учетной записи.
//
Процедура ОтправитьУчетнаяЗапись(Кнопка)
	
	ИД = Сред(СтрЗаменить(Кнопка.Имя, "_", "-"), 2);
	
	Попытка
		ИД = Новый УникальныйИдентификатор(ИД);
	Исключение
		Возврат;
	КонецПопытки;
	
	ТемпУчетнаяЗапись = Справочники.УчетныеЗаписиЭлектроннойПочты.ПолучитьСсылку(ИД);
	
	Если ЗначениеЗаполнено(ТемпУчетнаяЗапись) Тогда
		МассивУчетныхЗаписей = Новый Массив;
		МассивУчетныхЗаписей.Добавить(ТемпУчетнаяЗапись);
		УправлениеЭлектроннойПочтой.ПолучениеОтправкаПисем(глЗначениеПеременной("глСоответствиеТекстовЭлектронныхПисем"), глЗначениеПеременной("глТекущийПользователь"), МассивУчетныхЗаписей,, Истина);
	КонецЕсли; 
	
	СобратьСтатистикуРассмотренностиПисем();
	
КонецПроцедуры

// Процедура получает письма по текущей учетной записи.
//
Процедура ПолучитьУчетнаяЗапись(Кнопка)
	
	ИД = Сред(СтрЗаменить(Кнопка.Имя, "_", "-"), 2);
	
	Попытка
		ИД = Новый УникальныйИдентификатор(ИД);
	Исключение
		Возврат;
	КонецПопытки;
	
	ТемпУчетнаяЗапись = Справочники.УчетныеЗаписиЭлектроннойПочты.ПолучитьСсылку(ИД);
	
	Если ЗначениеЗаполнено(ТемпУчетнаяЗапись) Тогда
		МассивУчетныхЗаписей = Новый Массив;
		МассивУчетныхЗаписей.Добавить(ТемпУчетнаяЗапись);
		УправлениеЭлектроннойПочтой.ПолучениеОтправкаПисем(глЗначениеПеременной("глСоответствиеТекстовЭлектронныхПисем"), глЗначениеПеременной("глТекущийПользователь"), МассивУчетныхЗаписей,,, Истина);
	КонецЕсли; 
	
	СобратьСтатистикуРассмотренностиПисем();
	
КонецПроцедуры

// Процедура отправляет подготовленные к отправке письма по всем доступным
// для транспорта текущему пользоваетлю учетным записям.
//
Процедура ОтправитьВсе(Кнопка)
	
	УправлениеЭлектроннойПочтой.ПолучениеОтправкаПисем(глЗначениеПеременной("глСоответствиеТекстовЭлектронныхПисем"),глЗначениеПеременной("глТекущийПользователь"),,, Истина, Ложь);
	
	СобратьСтатистикуРассмотренностиПисем();
	
КонецПроцедуры

// Процедура получает письма по всем доступным
// для транспорта текущему пользоваетлю учетным записям.
//
Процедура ПолучитьВсе(Кнопка)
	
	УправлениеЭлектроннойПочтой.ПолучениеОтправкаПисем(глЗначениеПеременной("глСоответствиеТекстовЭлектронныхПисем"),глЗначениеПеременной("глТекущийПользователь"),,, Ложь, Истина);
	
	СобратьСтатистикуРассмотренностиПисем();
	
КонецПроцедуры

// Процедура отправляет подготовленные к отправке письма и получает эл.письма
// по всем доступным для транспорта текущему пользоваетлю учетным записям.
//
Процедура ОтправитьПолучитьВсе(Кнопка)
	
	УправлениеЭлектроннойПочтой.ПолучениеОтправкаПисем(глЗначениеПеременной("глСоответствиеТекстовЭлектронныхПисем"),глЗначениеПеременной("глТекущийПользователь"),,, Истина, Истина);
	
	СобратьСтатистикуРассмотренностиПисем();
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ОСНОВНОЙ КОМАНДНОЙ ПАНЕЛИ ФОРМЫ

// Обработчик события Нажатие кнопки НовоеПисьмо командной панели КоманднаяПанельФормы.
//
Процедура КоманднаяПанельФормыНовоеПисьмо(Кнопка)
	
	НаписатьНовоеПисьмо();
	
КонецПроцедуры

// Обработчик события Нажатие кнопки Ответить командной панели КоманднаяПанельФормы.
//
Процедура КоманднаяПанельФормыОтветить(Кнопка)
	
	Если ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные <> Неопределено Тогда
		УправлениеЭлектроннойПочтой.ОтветитьНаПисьмо(глЗначениеПеременной("глТекущийПользователь"), ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные.Ссылка, ЭтаФорма);
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события Нажатие кнопки ОтветитьВсем командной панели КоманднаяПанельФормы.
//
Процедура КоманднаяПанельФормыОтветитьВсем(Кнопка)
	
	Если ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные <> Неопределено Тогда
		УправлениеЭлектроннойПочтой.ОтветитьВсемНаПисьмо(глЗначениеПеременной("глТекущийПользователь"), ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные.Ссылка, ЭтаФорма);
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события Нажатие кнопки Переслать командной панели КоманднаяПанельФормы.
//
Процедура КоманднаяПанельФормыПереслать(Кнопка)
	
	Если ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные <> Неопределено Тогда
		УправлениеЭлектроннойПочтой.ПереадресоватьПисьмо(глЗначениеПеременной("глТекущийПользователь"), ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные.Ссылка, , ЭтаФорма);
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события Нажатие кнопки УчетныеЗаписи командной панели КоманднаяПанельФормы.
//
Процедура КоманднаяПанельФормыУчетныеЗаписи(Кнопка)
	
	Справочники.УчетныеЗаписиЭлектроннойПочты.ПолучитьФормуСписка().Открыть();
	
КонецПроцедуры

// Обработчик события Нажатие кнопки ОбновитьСписокДоступныхУчетныхЗаписей командной панели КоманднаяПанельФормы.
//
Процедура КоманднаяПанельФормыОбновитьСписокДоступныхУчетныхЗаписей(Кнопка)
	
	ОбновитьДоступныеУчетныеЗаписи();
	
	Если мДоступныеУчетныеЗаписи.Количество() = 0 Тогда
		Предупреждение("Нет доступных учетных записей.");
		ЭтаФорма.Закрыть();
		Возврат;
	КонецЕсли; 
	
	ЭлементыФормы.УчетнаяЗапись.СписокВыбора = мДоступныеУчетныеЗаписи.Скопировать();
	ЭлементыФормы.УчетнаяЗапись.СписокВыбора.СортироватьПоПредставлению(НаправлениеСортировки.Возр);
	ЭлементыФормы.УчетнаяЗапись.СписокВыбора.Добавить(Справочники.УчетныеЗаписиЭлектроннойПочты.ПустаяСсылка(), "Все доступные учетные записи");
	
	Если ЭлементыФормы.УчетнаяЗапись.СписокВыбора.НайтиПоЗначению(УчетнаяЗапись) = Неопределено Тогда
		УчетнаяЗапись = ЭлементыФормы.УчетнаяЗапись.СписокВыбора[0].Значение;
	КонецЕсли; 
	
	ЗаполнитьПодменюОтправитьПолучить();
	
	УстановитьОтборГрупп();
	
	ЭлементГруппыПисемДерево = ПолучитьЭлементГруппыПисемДерево();
	ГруппыПисем_ПриАктивизацииСтроки(ЭлементГруппыПисемДерево);
	ПредметыСписок_ПриАктивизацииСтроки();
	
	СобратьСтатистикуРассмотренностиПисем();
	
КонецПроцедуры

// Обработчик события Нажатие кнопки АдреснаяКнига командной панели КоманднаяПанельФормы.
//
Процедура КоманднаяПанельФормыАдреснаяКнига(Кнопка)
	
	АдрКнига = Обработки.АдреснаяКнига.Создать();
	Если ЗначениеЗаполнено(УчетнаяЗапись) Тогда
		АдрКнига.УчетнаяЗапись = УчетнаяЗапись;
	КонецЕсли; 
	АдрКнига.ОткрытаДляВыбора  = Истина;
	АдрКнига.ОткрытиеПриВыборе = Истина;
	АдрКнига.ПолучитьФорму("ФормаВыбора").Открыть();
	
КонецПроцедуры

// Обработчик события Нажатие кнопки АвтополучениеПисем командной панели КоманднаяПанельФормы.
//
Процедура КоманднаяПанельФормыАвтополучениеПисем(Кнопка)
	
	Если ТипЗнч(глЗначениеПеременной("глОбработкаАвтоПолученияОтправкиЭлектронныхПисем")) <> Тип("Форма") Тогда
		глЗначениеПеременнойУстановить("глОбработкаАвтоПолученияОтправкиЭлектронныхПисем", Обработки.АвтоПолучениеОтправкаЭлектронныхПисем.ПолучитьФорму());
	КонецЕсли;
	
	глЗначениеПеременной("глОбработкаАвтоПолученияОтправкиЭлектронныхПисем").Открыть();
	
КонецПроцедуры

// Обработчик события Нажатие кнопки Обновить командной панели КоманднаяПанельФормы.
//
Процедура КоманднаяПанельФормыНовоеПисьмоВТекущейГруппе(Кнопка)
	
	НаписатьНовоеПисьмо(, Истина);
	
КонецПроцедуры

// Обработчик события Нажатие кнопки Скопировать командной панели КоманднаяПанельФормы.
//
Процедура КоманднаяПанельФормыСкопировать(Кнопка)
	
	НаписатьНовоеПисьмо(Истина);
	
КонецПроцедуры

// Обработчик события Нажатие кнопки Изменить командной панели КоманднаяПанельФормы.
//
Процедура КоманднаяПанельФормыИзменить(Кнопка)
	
	ПередНачаломИзмененияЭлектронногоПисьма(ЭлементыФормы.ЭлектронныеПисьмаСписок, Ложь);
	
КонецПроцедуры

// Обработчик события Нажатие кнопки УстановитьПометкуУдаления командной панели КоманднаяПанельФормы.
//
Процедура КоманднаяПанельФормыУстановитьПометкуУдаления(Кнопка)
	
	УстановитьПометкуУдаленияЭлектронногоПисьма(ЭлементыФормы.ЭлектронныеПисьмаСписок);
	
КонецПроцедуры

// Обработчик события Нажатие кнопки Отправить командной панели КоманднаяПанельФормы.
//
Процедура КоманднаяПанельФормыОтправить(Кнопка)
	
	Перем МассивУчетныхЗаписей;
	
	Если ЗначениеЗаполнено(УчетнаяЗапись) Тогда
		МассивУчетныхЗаписей = Новый Массив;
		МассивУчетныхЗаписей.Добавить(УчетнаяЗапись);
	КонецЕсли;
	
	УправлениеЭлектроннойПочтой.ПолучениеОтправкаПисем(глЗначениеПеременной("глСоответствиеТекстовЭлектронныхПисем"),глЗначениеПеременной("глТекущийПользователь"), МассивУчетныхЗаписей,, Истина);
	СобратьСтатистикуРассмотренностиПисем();
	
КонецПроцедуры

// Обработчик события Нажатие кнопки Получить командной панели КоманднаяПанельФормы.
//
Процедура КоманднаяПанельФормыПолучить(Кнопка)
	
	Перем МассивУчетныхЗаписей;
	
	Если ЗначениеЗаполнено(УчетнаяЗапись) Тогда
		МассивУчетныхЗаписей = Новый Массив;
		МассивУчетныхЗаписей.Добавить(УчетнаяЗапись);
	КонецЕсли;
	
	УправлениеЭлектроннойПочтой.ПолучениеОтправкаПисем(глЗначениеПеременной("глСоответствиеТекстовЭлектронныхПисем"),глЗначениеПеременной("глТекущийПользователь"), МассивУчетныхЗаписей,,, Истина);
	СобратьСтатистикуРассмотренностиПисем();
	
КонецПроцедуры

// Обработчик события Нажатие кнопки ПоискПисемПоОбъектам командной панели КоманднаяПанельФормы.
//
Процедура КоманднаяПанельФормыПоискПисемПоОбъектам(Кнопка)
	
	Обработки.ПоискЭлектронныхПисемПоОбъектам.ПолучитьФорму().Открыть();
	
КонецПроцедуры

// Обработчик события Нажатие кнопки ВвестиСобытие командной панели КоманднаяПанельФормы.
//
Процедура КоманднаяПанельФормыВвестиСобытие(Кнопка)
	
	ВвестиСобытиеПоПисьму();
	
КонецПроцедуры

// Обработчик события Нажатие кнопки УстановитьСнятьПометкуУдаления командной панели КоманднаяПанельФормы.
//
Процедура КоманднаяПанельФормыУстановитьСнятьПометкуУдаления(Кнопка)
	
	УстановитьПометкуУдаленияЭлектронногоПисьма(ЭлементыФормы.ЭлектронныеПисьмаСписок);
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ КОНТЕКСТНОГО МЕНЮ СПИСКА ПИСЕМ

// Обработчик события Нажатие кнопки Ответить командной панели КонтекстноеМенюСпискаПисем.
//
Процедура КонтекстноеМенюСпискаПисемОтветить(Кнопка)
	
	Если ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные <> Неопределено Тогда
		УправлениеЭлектроннойПочтой.ОтветитьНаПисьмо(глЗначениеПеременной("глТекущийПользователь"), ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные.Ссылка, ЭтаФорма);
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события Нажатие кнопки ПисемОтветитьВсем командной панели КонтекстноеМенюСпискаПисем.
//
Процедура КонтекстноеМенюСпискаПисемОтветитьВсем(Кнопка)
	
	Если ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные <> Неопределено Тогда
		УправлениеЭлектроннойПочтой.ОтветитьВсемНаПисьмо(глЗначениеПеременной("глТекущийПользователь"), ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные.Ссылка, ЭтаФорма);
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события Нажатие кнопки Переслать командной панели КонтекстноеМенюСпискаПисем.
//
Процедура КонтекстноеМенюСпискаПисемПереслать(Кнопка)
	
	Если ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные <> Неопределено Тогда
		УправлениеЭлектроннойПочтой.ПереадресоватьПисьмо(глЗначениеПеременной("глТекущийПользователь"), ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные.Ссылка, , ЭтаФорма);
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события Нажатие кнопки УстановитьРассмотрено командной панели КонтекстноеМенюСпискаПисем.
//
Процедура КонтекстноеМенюСпискаПисемУстановитьРассмотрено(Кнопка)
	
	ИзменитьФлагРассмотренностьПисьма(ЭлементыФормы.ЭлектронныеПисьмаСписок.ВыделенныеСтроки, Ложь);
	СобратьСтатистикуРассмотренностиПисем();
	
КонецПроцедуры

// Обработчик события Нажатие кнопки УстановитьНеРассмотрено командной панели КонтекстноеМенюСпискаПисем.
//
Процедура КонтекстноеМенюСпискаПисемУстановитьНеРассмотрено(Кнопка)
	
	ИзменитьФлагРассмотренностьПисьма(ЭлементыФормы.ЭлектронныеПисьмаСписок.ВыделенныеСтроки, Истина);
	СобратьСтатистикуРассмотренностиПисем();
	
КонецПроцедуры

// Обработчик события Нажатие кнопки НовоеПисьмо командной панели КонтекстноеМенюСпискаПисем.
//
Процедура КонтекстноеМенюСпискаПисемНовоеПисьмо(Кнопка)
	
	НаписатьНовоеПисьмо();
	
КонецПроцедуры

// Обработчик события Нажатие кнопки Скопировать командной панели КонтекстноеМенюСпискаПисем.
//
Процедура КонтекстноеМенюСпискаПисемСкопировать(Кнопка)
	
	НаписатьНовоеПисьмо(Истина);
	
КонецПроцедуры

// Обработчик события Нажатие кнопки Изменить командной панели КонтекстноеМенюСпискаПисем.
//
Процедура КонтекстноеМенюСпискаПисемИзменить(Кнопка)
	
	ПередНачаломИзмененияЭлектронногоПисьма(ЭлементыФормы.ЭлектронныеПисьмаСписок, Ложь);
	
КонецПроцедуры

// Обработчик события Нажатие кнопки УстановитьПометкуУдаления командной панели КонтекстноеМенюСпискаПисем.
//
Процедура КонтекстноеМенюСпискаПисемУстановитьПометкуУдаления(Кнопка)
	
	УстановитьПометкуУдаленияЭлектронногоПисьма(ЭлементыФормы.ЭлектронныеПисьмаСписок);
	
КонецПроцедуры

// Обработчик события Нажатие кнопки ПрименитьКПисьмамФильтры командной панели КонтекстноеМенюСпискаПисем.
//
Процедура КонтекстноеМенюСпискаПисемПрименитьКПисьмамФильтры(Кнопка)
	
	ВсегоЭлементов = ЭлементыФормы.ЭлектронныеПисьмаСписок.ВыделенныеСтроки.Количество();
	
	Если ВсегоЭлементов > 0 Тогда
		ОтветНаВопрос = Вопрос("Применить к выбранным письмам фильтры учетных записей?", РежимДиалогаВопрос.ОКОтмена);
		Если ОтветНаВопрос <> КодВозвратаДиалога.ОК Тогда
			Возврат;
		КонецЕсли; 
	КонецЕсли; 
	
	ФормаПрогрессора = ПолучитьОбщуюФорму("ХодВыполненияОбработкиДанных");
	Если ФормаПрогрессора.Открыта() Тогда
		ФормаПрогрессора.Закрыть();
	КонецЕсли; 
	ФормаПрогрессора.НаименованиеОбработкиДанных = "Обработка писем по фильтрам";
	ФормаПрогрессора.КомментарийОбработкиДанных  = "Обработка писем по фильтрам";
	ФормаПрогрессора.Значение = 1;
	ФормаПрогрессора.МаксимальноеЗначение = ВсегоЭлементов;
	ФормаПрогрессора.Открыть();
	
	Для каждого Строка Из ЭлементыФормы.ЭлектронныеПисьмаСписок.ВыделенныеСтроки Цикл
		Объект = Строка.ПолучитьОбъект();
		УправлениеЭлектроннойПочтой.ПрименитьФильтрыКПисьму(Объект, глЗначениеПеременной("глТекущийПользователь"), Истина);
		ФормаПрогрессора.Значение = ФормаПрогрессора.Значение + 1;
		ФормаПрогрессора.КомментарийЗначения = Строка(Объект);
	КонецЦикла; 
	
	Если ФормаПрогрессора.Открыта() Тогда
		ФормаПрогрессора.Закрыть();
	КонецЕсли;
	
	СобратьСтатистикуРассмотренностиПисем();
	
КонецПроцедуры

// Обработчик события Нажатие кнопки ОтправитьВыбранныеПисьма командной панели КонтекстноеМенюСпискаПисем.
//
Процедура КонтекстноеМенюСпискаПисемОтправитьВыбранныеПисьма(Кнопка)
	
	ОтветНаВопрос = Вопрос("Хотите отправить выбранные письма?", РежимДиалогаВопрос.ОКОтмена);
	Если ОтветНаВопрос <> КодВозвратаДиалога.ОК Тогда
		Возврат;
	КонецЕсли;
	
	Писема = Новый Соответствие;
	Для каждого Строка Из ЭлементыФормы.ЭлектронныеПисьмаСписок.ВыделенныеСтроки Цикл
		Писема.Вставить(Строка);
	КонецЦикла; 
	
	УправлениеЭлектроннойПочтой.ОтправитьПисьма(Писема, глЗначениеПеременной("глСоответствиеТекстовЭлектронныхПисем"), глЗначениеПеременной("глТекущийПользователь"));
	СобратьСтатистикуРассмотренностиПисем();
	
КонецПроцедуры

// Обработчик события Нажатие кнопки НовоеПисьмоВТекущейГруппе командной панели КонтекстноеМенюСпискаПисем.
//
Процедура КонтекстноеМенюСпискаПисемНовоеПисьмоВТекущейГруппе(Кнопка)
	
	НаписатьНовоеПисьмо(, Истина);
	
КонецПроцедуры

// Обработчик события Нажатие кнопки ВвестиСобытие командной панели КонтекстноеМенюСпискаПисем.
//
Процедура КонтекстноеМенюСпискаПисемВвестиСобытие(Кнопка)
	
	ВвестиСобытиеПоПисьму();
	
КонецПроцедуры


////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ КОМАНДНЫХ ПАНЕЛЕЙ ФОРМЫ

// Обработчик события Нажатие кнопки НайтиДобавить командной панели КоманднаяПанельКому.
//
Процедура КоманднаяПанельКомуНайтиДобавить(Кнопка)
	
	ПроизвестиПоиск(ЭлементыФормы.ПолеКому.ВыделенныйТекст);
	
КонецПроцедуры

// Обработчик события Нажатие кнопки НайтиДобавить командной панели КоманднаяПанельКопии.
//
Процедура КоманднаяПанельКопииНайтиДобавить(Кнопка)
	
	ПроизвестиПоиск(ЭлементыФормы.ПолеКопии.ВыделенныйТекст);
	
КонецПроцедуры

// Обработчик события Нажатие кнопки НайтиДобавить командной панели КоманднаяПанельОтправитель.
//
Процедура КоманднаяПанельОтправительНайтиДобавить(Кнопка)
	
	ПроизвестиПоиск(ЭлементыФормы.ПолеОтправитель.ВыделенныйТекст);
	
КонецПроцедуры

// Обработчик события Нажатие кнопки ОткрытьСсылку командной панели КоманднаяПанельПолеХТМЛ.
//
Процедура КоманднаяПанельПолеХТМЛОткрытьСсылку(Кнопка)
	
	ВыделеннаяКоллекция = ЭлементыФормы.ПолеHTMLДокумента.Документ.selection.createRangeCollection();
	Если ВыделеннаяКоллекция.length > 0 Тогда
		ВыделенныйТекст = ВыделеннаяКоллекция.item(0).text;
		Если ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные <> Неопределено Тогда
			УчетнаяЗаписьПисьма = ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные.УчетнаяЗапись;
		КонецЕсли; 
		УправлениеЭлектроннойПочтой.ПерейтиПоСсылкеИзХТМЛПоля(ВыделенныйТекст, глЗначениеПеременной("глТекущийПользователь"), ЭтаФорма, УчетнаяЗаписьПисьма);
	КонецЕсли;
	
КонецПроцедуры

// Обработчик события Нажатие кнопки ПереместитьВверх командной панели КоманднаяПанельПорядокГрупп.
//
Процедура КоманднаяПанельПорядокГруппПереместитьВверх(Кнопка)
	
	ЭлементГруппыПисемДерево = ПолучитьЭлементГруппыПисемДерево();
	
	Если ЭлементГруппыПисемДерево.ТекущиеДанные <> Неопределено Тогда
		ОбщегоНазначения.ИзменитьПорядок(ЭлементГруппыПисемДерево.ТекущиеДанные.Ссылка, "Вверх");
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события Нажатие кнопки ПереместитьВниз командной панели КоманднаяПанельПорядокГрупп.
//
Процедура КоманднаяПанельПорядокГруппПереместитьВниз(Кнопка)
	
	ЭлементГруппыПисемДерево = ПолучитьЭлементГруппыПисемДерево();
	
	Если ЭлементГруппыПисемДерево.ТекущиеДанные <> Неопределено Тогда
		ОбщегоНазначения.ИзменитьПорядок(ЭлементГруппыПисемДерево.ТекущиеДанные.Ссылка, "Вниз");
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события Нажатие кнопки ИзменитьНазваниеПредмета командной панели КоманднаяПанельСписокПредметов.
//
Процедура КоманднаяПанельСписокПредметовИзменитьНазваниеПредмета(Кнопка)
	
	Если ЭлементыФормы.ПредметыСписок.ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ФормаИзмененияПредмета = ПолучитьФорму("ФормаИзмененияПредмета");
	Если ЭлектронныеПисьмаСписок.Отбор.ГруппаУчетнойЗаписи.Использование Тогда
		ФормаИзмененияПредмета.ГруппаУчетнойЗаписи = ЭлектронныеПисьмаСписок.Отбор.ГруппаУчетнойЗаписи.Значение;
		ГруппаПисем = ЭлектронныеПисьмаСписок.Отбор.ГруппаУчетнойЗаписи.Значение;
	КонецЕсли;
	Если ЗначениеЗаполнено(УчетнаяЗапись) Тогда
		ФормаИзмененияПредмета.УчетнаяЗапись = УчетнаяЗапись;
	КонецЕсли;
	ФормаИзмененияПредмета.Предмет = ЭлементыФормы.ПредметыСписок.ТекущиеДанные.Предмет;
	
	НовыйПредмет = ФормаИзмененияПредмета.ОткрытьМодально();
	Если НовыйПредмет = Неопределено ИЛИ НЕ Метаданные.Документы.ЭлектронноеПисьмо.Реквизиты.ПредметКонтакта.Тип.СодержитТип(ТипЗнч(НовыйПредмет)) Тогда
		Возврат;
	КонецЕсли; 
	
	СохранитьТекущийПредмет(НовыйПредмет);
	
	Запрос = Новый Запрос;
	
	Запрос.УстановитьПараметр("Предмет"                    , ЭлементыФормы.ПредметыСписок.ТекущиеДанные.Предмет);
	Запрос.УстановитьПараметр("ГруппаПисемЭлектроннойПочты", ГруппаПисем);
	
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ПредметыЭлектронныхПисем.Регистратор КАК Ссылка
	|ИЗ
	|	РегистрСведений.ПредметыЭлектронныхПисем КАК ПредметыЭлектронныхПисем
	|
	|ГДЕ
	|	ПредметыЭлектронныхПисем.Предмет = &Предмет
	|	" + ?(ГруппаПисем <> Неопределено, "И
	|	ПредметыЭлектронныхПисем.ГруппаПисемЭлектроннойПочты = &ГруппаПисемЭлектроннойПочты", "") + "
	|";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Всего = Выборка.Количество();
	ТекНомер = 0;
	Пока Выборка.Следующий() Цикл
		
		ТекНомер = ТекНомер + 1;
		Состояние("Обработано " + ТекНомер + " из " + Всего);
		
		Объект = Выборка.Ссылка.ПолучитьОбъект();
		Объект.ПредметКонтакта = НовыйПредмет;
		Попытка
			Объект.Записать();
		Исключение
			Сообщить("" + Объект + " не изменен, " + ОписаниеОшибки());
		КонецПопытки;
		
	КонецЦикла;
	
	СобратьСтатистикуРассмотренностиПисем();
	
КонецПроцедуры

// Обработчик события Нажатие кнопки ПрименитьКПисьмамПапкиФильтры командной панели КоманднаяПанельПорядокГрупп.
//
Процедура КоманднаяПанельПорядокГруппПрименитьКПисьмамПапкиФильтры(Кнопка)
	
	ЭлементГруппыПисемДерево = ПолучитьЭлементГруппыПисемДерево();
	
	Если ЭлементГруппыПисемДерево.ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ЭлементГруппыПисемДерево.ТекущиеДанные.Ссылка) Тогда
		Возврат;
	КонецЕсли;
	
	ДоступКУчетнойЗаписи = ЭлементГруппыПисемДерево.ТекущиеДанные.Владелец.ДоступКУчетнойЗаписи.Найти(глЗначениеПеременной("глТекущийПользователь"));
	Если ДоступКУчетнойЗаписи = Неопределено ИЛИ НЕ ДоступКУчетнойЗаписи.Администрирование Тогда
		Предупреждение("Данная функция доступна только администратору учетной записи.");
		Возврат;
	КонецЕсли;
	
	ФормаПараметров = ЭтотОбъект.ПолучитьФорму("ФормаНастройкиПринудительнойФильтрацииПисем");
	ФормаПараметров.ГруппаПисемДляОбработки = ЭлементГруппыПисемДерево.ТекущиеДанные.Ссылка;
	Запрос = ФормаПараметров.ОткрытьМодально();
	
	ФормаПрогрессора = ПолучитьОбщуюФорму("ХодВыполненияОбработкиДанных");
	Если ФормаПрогрессора.Открыта() Тогда
		ФормаПрогрессора.Закрыть();
	КонецЕсли; 
	
	Если ТипЗнч(Запрос) = Тип("Запрос") Тогда
		Выборка = Запрос.Выполнить().Выбрать();
		ВсегоЭлементов = Выборка.Количество();
		
		ФормаПрогрессора.НаименованиеОбработкиДанных = "Обработка писем по фильтрам";
		ФормаПрогрессора.КомментарийОбработкиДанных  = "Обработка писем по фильтрам";
		ФормаПрогрессора.Значение = 1;
		ФормаПрогрессора.МаксимальноеЗначение = ВсегоЭлементов;
		ФормаПрогрессора.Открыть();
		
		Пока Выборка.Следующий() Цикл
			Объект = Выборка.Ссылка.ПолучитьОбъект();
			УправлениеЭлектроннойПочтой.ПрименитьФильтрыКПисьму(Объект, глЗначениеПеременной("глТекущийПользователь"), Истина);
			ФормаПрогрессора.Значение = ФормаПрогрессора.Значение + 1;
			ФормаПрогрессора.КомментарийЗначения = Строка(Объект);
		КонецЦикла; 
	КонецЕсли;
	
	Если ФормаПрогрессора.Открыта() Тогда
		ФормаПрогрессора.Закрыть();
	КонецЕсли;
	
	СобратьСтатистикуРассмотренностиПисем();
	
КонецПроцедуры

// Обработчик события Нажатие кнопки СнятьОтборПоПредметам командной панели КоманднаяПанельСписокПредметов.
//
Процедура КоманднаяПанельСписокПредметовСнятьОтборПоПредметам(Кнопка)
	
	ЭлектронныеПисьмаСписок.Отбор.ПредметКонтакта.Использование = Ложь;
	
КонецПроцедуры

// Обработчик события Нажатие кнопки УстановитьУбратьСкрытостьПредмета командной панели КоманднаяПанельСписокПредметов.
//
Процедура КоманднаяПанельСписокПредметовУстановитьУбратьСкрытостьПредмета(Кнопка)
	
	Если ЭлементыФормы.ПредметыСписок.ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ФлагСкрытостиПредмета = НЕ ЭлементыФормы.ПредметыСписок.ТекущиеДанные.Скрытый;
	
	Запрос = Новый Запрос;
	
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ПредметыЭлектронныхПисем.Регистратор
	|ИЗ
	|	РегистрСведений.ПредметыЭлектронныхПисем КАК ПредметыЭлектронныхПисем
	|ГДЕ
	|	ПредметыЭлектронныхПисем.Предмет = &Предмет
	|	И
	|	ПредметыЭлектронныхПисем.ГруппаПисемЭлектроннойПочты = &ГруппаПисемЭлектроннойПочты
	|";
	
	Запрос.УстановитьПараметр("Предмет"                    , ЭлементыФормы.ПредметыСписок.ТекущиеДанные.Предмет);
	Запрос.УстановитьПараметр("ГруппаПисемЭлектроннойПочты", ЭлементыФормы.ПредметыСписок.ТекущиеДанные.ГруппаПисемЭлектроннойПочты);
	
	НачатьТранзакцию();
	ОтменаТранзакции = Ложь;
	Выборка = Запрос.Выполнить().Выбрать();
	ТекНомер = 0;
	Пока Выборка.Следующий() Цикл
		ТекНомер = ТекНомер + 1;
		Состояние("Обработано " + ТекНомер + " из " + Выборка.Количество());
		Набор = РегистрыСведений.ПредметыЭлектронныхПисем.СоздатьНаборЗаписей();
		Набор.Отбор.Регистратор.Значение = Выборка.Регистратор;
		Набор.Прочитать();
		Если Набор.Количество() = 1 И Набор[0].Скрытый <> ФлагСкрытостиПредмета Тогда
			Набор[0].Скрытый = ФлагСкрытостиПредмета;
			Попытка
				Набор.Записать();
			Исключение
				ОтменаТранзакции = Истина;
				ОбщегоНазначения.СообщитьОбОшибке(ОписаниеОшибки(),, "Изменение не произведено");
				Прервать;
			КонецПопытки;
		КонецЕсли; 
	КонецЦикла; 
	
	Если ОтменаТранзакции Тогда
		ОтменитьТранзакцию();
	Иначе
		ЗафиксироватьТранзакцию();
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события Нажатие кнопки УстановитьУбратьСкрытостьПредмета командной панели ОтображатьСкрытыеПредметы.
//
Процедура КоманднаяПанельСписокПредметовОтображатьСкрытыеПредметы(Кнопка)
	
	мКнопкаОтображатьСкрытыеПредметыПисем.Пометка = НЕ мКнопкаОтображатьСкрытыеПредметыПисем.Пометка;
	
	УстановитьотборСкрытыхПредметов();
	
КонецПроцедуры

// Обработчик события Нажатие кнопки СнятьОтборПоГруппе командной панели КоманднаяПанельПорядокГрупп.
//
Процедура КоманднаяПанельПорядокГруппСнятьОтборПоГруппе(Кнопка)
	
	ЭлектронныеПисьмаСписок.Отбор.ГруппаУчетнойЗаписи.Использование = Ложь;
	УстановитьОтборПредметов(Ложь);
	
КонецПроцедуры

Процедура КоманднаяПанельФормыЭкспортИмпортКонтактнойИнформации(Кнопка)
	
	Обработки.ЭкспортИмпортКонтактныхДанныхОбъектов.ПолучитьФорму().Открыть();
	
КонецПроцедуры

Процедура КоманднаяПанельФормыПечать(Кнопка)
	
	Если ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные <> Неопределено Тогда
		ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные.Ссылка.ПолучитьОбъект().НапечататьПисьмо();
	КонецЕсли; 
	
КонецПроцедуры

Процедура КоманднаяПанельФормыЗагрузкаПочтовыхСообщений(Кнопка)
	
	Обработка = Обработки.ЗагрузкаПочтовыхСообщений.Создать();
	Если ЗначениеЗаполнено(УчетнаяЗапись) Тогда
		Обработка.УчетнаяЗапись = УчетнаяЗапись;
	КонецЕсли; 
	Обработка.ПолучитьФорму().Открыть();
	
КонецПроцедуры


Процедура КоманднаяПанельСписокПредметовСоздатьОпрос(Кнопка)
	
	Попытка
		ТекущийПредмет = ЭлементыФормы.ПредметыСписок.ТекущиеДанные.Предмет;
	Исключение
		ТекущийПредмет = ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные.ПредметКонтакта;
	КонецПопытки;
	СоздатьОпрос(ТекущийПредмет);
	
КонецПроцедуры

Процедура КонтекстноеМенюСпискаПисемПоказатьЗаголовокПисьма(Кнопка)
	
	Если ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные <> Неопределено Тогда
		ТекстЗаголовкаПисьма = Новый ТекстовыйДокумент;
		ТекстЗаголовкаПисьма.УстановитьТекст(ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные.ЗаголовокПисьма);
		ТекстЗаголовкаПисьма.ТолькоПросмотр = Истина;
		ТекстЗаголовкаПисьма.Показать(Строка(ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные.Ссылка));
	КонецЕсли; 
	
КонецПроцедуры

// Процедура оставляет видимой только текущую страницу
//
// Параметры:
//     Страницы - коллекция страниц панели управления
//     ИмяСтраницы - имя текущей (переключаемой) страницы
Процедура УстновитьВидимостьСтраницы(Страницы,ИмяСтраницы)
	
	Для каждого Страница из Страницы Цикл
		Если Страница.Имя = ИмяСтраницы Тогда
			Страница.Видимость = Истина;
		Иначе
			Страница.Видимость = Ложь;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Процедура КоманднаяПанельФормыКалендарьДополнительноНастройка(Кнопка)
	
	ФормаНастройки = ОбработкаОбъект.ПолучитьФорму("ФормаНастройкиКалендаря", ЭтаФорма);
	Если ФормаНастройки.ОткрытьМодально() = Истина Тогда
		
		Если ТипЗнч(СтруктураОтборов) = Тип("Соответствие") Тогда
			МассивЗначенийОтбора = Новый Массив;
			МассивЗначенийОтбора.Добавить(ФормаНастройки.ВидСравненияПостроитель);
			МассивЗначенийОтбора.Добавить(ПользовательКалендаря);
			СтруктураОтборов.Вставить("Пользователь", МассивЗначенийОтбора);
		КонецЕсли; 
		
		ПрочитатьСохраненныеЗначенияПользователя();
		
		ОбновитьСписок[0] = Истина;
		ОбновитьСписок[1] = Ложь;
		
		ОбновитьМесяц[0] = Истина;
		ОбновитьМесяц[2] = Истина;
		
		ОбновитьНеделю[0] = Истина;
		ОбновитьНеделю[2] = Истина;
		
		ОбновитьДень[0] = Истина;
		ОбновитьДень[2] = Истина;
		
		ОбновитьИнформациюНаФорме();
		
	КонецЕсли;
	
КонецПроцедуры

// Обработчик события ПриСменеСтраницы элемента ОсновнаяПанель
//
Процедура ОсновнаяПанельПриСменеСтраницы(Элемент, ТекущаяСтраница)
	
	Если мВыполняетсяОбновлениеОтображения Тогда
		Возврат;
	КонецЕсли; 
	
	Если Элемент.ТекущаяСтраница.Имя = "Календарь" Тогда
		                                                          
		ЭлементыФормы.КоманднаяПанельФормы.Видимость                       = Истина;
		ЭлементыФормы.КоманднаяПанельФормыКалендарьДополнительно.Видимость = Истина;
		ЭлементыФормы.КоманднаяПанельПочты.Видимость                       = Ложь; 
		ЭлементыФормы.КоманднаяПанельПочтыДополнительно.Видимость          = Ложь; 

		Если ПроизвестиНачальноеЗаполнениеКалендаря Тогда
			
			Состояние("Выполняется заполнение начальных настроек ...");
			
			Если НЕ ЗначениеЗаполнено(ДатаКалендаря) Тогда
				ДатаКалендаря = НачалоДня(ТекущаяДата());
			КонецЕсли;
			мДатаКалендаря = ДатаКалендаря;
			ДатаНачалаНедели = НачалоНедели(ДатаКалендаря);
			
			ПрочитатьСохраненныеЗначенияПользователя();
			
			мМассивЗначенийБыстрогоСобытия = ВосстановитьЗначение("ЗначениеБыстрогоВводаСобытияКалендаря");
			
			ПроизвестиНачальноеЗаполнениеКалендаря = Ложь;
			
			ОбновитьЗаказыСобытия(Ложь);
			
			ОпределитьКонтрагентаФормы();
			
			ЗаполнитьКнопкиТулбараВводаНовогоСобытия(ЭлементыФормы.КонтекстноеМенюМокселя.Кнопки.СоздатьСобытие.Кнопки,"ВвестиДокументСобытиеИзМокселя");
			
			ИсторияОтборов = ВосстановитьЗначение("ИсторииОтборовКалендаряПользователя");
			Если ТипЗнч(ИсторияОтборов) = Тип("СписокЗначений") Тогда
				мСписокИсторииОтбора = ИсторияОтборов;
			КонецЕсли; 
			
			СформироватьПодменюПоСпискуАктуальныхОтборов();
			УстановитьПометкуКнопок(ЭлементыФормы.КоманднаяПанельФормы.Кнопки, ЭлементыФормы.ПанельФормы.ТекущаяСтраница.Имя);
			
			// восстановим страницу формы календаря
			ИмяСтраницыКалендаря = ВосстановитьЗначение("ИмяСтраницыКалендаря");  
			Если ТипЗнч(ИмяСтраницыКалендаря) = Тип("Строка") Тогда
				УстановитьЗакладку(ИмяСтраницыКалендаря);
			КонецЕсли;
			
		Иначе
			
			Если ЭлементыФормы.ПанельФормы.ТекущаяСтраница = ЭлементыФормы.ПанельФормы.Страницы.Список Тогда
				ОбновитьТаблицуСписка();
			ИначеЕсли ЭлементыФормы.ПанельФормы.ТекущаяСтраница = ЭлементыФормы.ПанельФормы.Страницы.День Тогда
				ОбновитьКалендарьДня();
			ИначеЕсли ЭлементыФормы.ПанельФормы.ТекущаяСтраница = ЭлементыФормы.ПанельФормы.Страницы.Неделя Тогда
				ОбновитьКалендарьНеделя();
			ИначеЕсли ЭлементыФормы.ПанельФормы.ТекущаяСтраница = ЭлементыФормы.ПанельФормы.Страницы.Месяц Тогда
				ОбновитьКалендарьМесяц();
			КонецЕсли; 
		КонецЕсли;
	КонецЕсли;
	
	Если Элемент.ТекущаяСтраница.Имя = "Почта" Тогда
		
		ЭлементыФормы.КоманднаяПанельПочты.Видимость                       = Истина;
		ЭлементыФормы.КоманднаяПанельПочтыДополнительно.Видимость          = Истина; 
		ЭлементыФормы.КоманднаяПанельФормы.Видимость                       = Ложь;
		ЭлементыФормы.КоманднаяПанельФормыКалендарьДополнительно.Видимость = Ложь;
		
		Если мДоступныеУчетныеЗаписи.Количество() = 0 Тогда
			
			Если ПравоДоступа("Добавление", Метаданные.Справочники.УчетныеЗаписиЭлектроннойПочты) Тогда
				
				ОтветНаВопрос = Вопрос("У вас нет доступных учетных записей, создать новую?", РежимДиалогаВопрос.ДаНет);
				Если ОтветНаВопрос = КодВозвратаДиалога.Да Тогда
					
					Справочники.УчетныеЗаписиЭлектроннойПочты.СоздатьЭлемент().ПолучитьФорму().ОткрытьМодально();
					ОбновитьДоступныеУчетныеЗаписи();
					
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
		
		Если мДоступныеУчетныеЗаписи.Количество() = 0 Тогда
			Элемент.ТекущаяСтраница.Доступность = Ложь;
		КонецЕсли;
		
		Если ПроизвестиНачальноеЗаполнениеПочты Тогда
			
			ПодключитьОбработчикОжидания("ПриАктивизацииСтрокиСпискаПисемСОжиданием", 1);
			
			Если УправлениеПользователями.ПолучитьЗначениеПоУмолчанию(глЗначениеПеременной("глТекущийПользователь"), "ПолучениеЭлектронныхПисемПриОткрытии") = Истина Тогда
				УправлениеЭлектроннойПочтой.ПолучениеОтправкаПисем(глЗначениеПеременной("глСоответствиеТекстовЭлектронныхПисем"),глЗначениеПеременной("глТекущийПользователь"),,,, Истина);
			КонецЕсли; 
			
			УстановитьотборСкрытыхПредметов();
			
			ПроизвестиНачальноеЗаполнениеПочты = Ложь;
		КонецЕсли;
		
		СобратьСтатистикуРассмотренностиПисем();
		
		СписокДанныхПоПредметам.Очистить();
		СписокДанныхПоПисьмам.Очистить();
		
		ВидимостьСпискаПредметов();
		СоздатьКнопкиОформленияСтрокПисем();
	ИначеЕсли Не Элемент.Страницы.Почта.Доступность Тогда
		
		Элемент.Страницы.Почта.Доступность = Истина;
		
	КонецЕсли;
	
	Если Элемент.ТекущаяСтраница.Имя = "Контакты" Тогда
		
		ЭлементыФормы.КоманднаяПанельПочты.Видимость                       = Ложь;
		ЭлементыФормы.КоманднаяПанельПочтыДополнительно.Видимость          = Ложь; 
		ЭлементыФормы.КоманднаяПанельФормы.Видимость                       = Ложь;
		ЭлементыФормы.КоманднаяПанельФормыКалендарьДополнительно.Видимость = Ложь;
		
		СписокДанныхПоПредметамПоОбъекту.Очистить();
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьКнопкиТулбараВводаНовогоСобытия(КнопкиТулбара,НаименованиеДейтсвия)
	
	КнопкиТулбара.Очистить();
	
	Для каждого ЭлементСписка Из мСписокДокументовДобавления Цикл
		
		НоваяКнопка = КнопкиТулбара.Добавить(("_" + мСписокДокументовДобавления.Индекс(ЭлементСписка)), ТипКнопкиКоманднойПанели.Действие, ЭлементСписка.Представление, Новый Действие(НаименованиеДейтсвия));
		НоваяКнопка.Картинка = ЭлементСписка.Картинка;
		
	КонецЦикла;
	
КонецПроцедуры

// Процедура выделяет кандидатов, от которых есть не рассмотренные письма 
//
// Параметры
//  Данные - строки дерева значений               
//
Процедура ОтметитьПараметрыПретендентов(Данные)
	
	Для Каждого СтрокаТаблицыКандидатов из Данные.Строки Цикл
		
		Если НЕ ЗначениеЗаполнено(СтрокаТаблицыКандидатов.Претендент) Тогда
			ОтметитьПараметрыПретендентов(СтрокаТаблицыКандидатов);
			СтрокаТаблицыКандидатов.КоличествоКандидатов = СтрокаТаблицыКандидатов.Строки.Итог("КоличествоКандидатов",Ложь);
			СтрокаТаблицыКандидатов.КоличествоНепрочитанныхПисем =  СтрокаТаблицыКандидатов.Строки.Итог("КоличествоНепрочитанныхПисем",Ложь);
		Иначе
			СтрокаПоиска = ТаблицаКандидатовСНепрочитнаннымиПисьмами.Найти(СтрокаТаблицыКандидатов.Претендент);
			Если СтрокаПоиска <> Неопределено Тогда
				СтрокаТаблицыКандидатов.КоличествоНепрочитанныхПисем =  СтрокаПоиска.Количество;
			Иначе
				СтрокаТаблицыКандидатов.КоличествоНепрочитанныхПисем = 0;
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры // ОтметитьНовыеСообщения()

// Процедура обновляет данные таблицы значений "Претенденты".
//
//
// Параметры:
//  Нет.
//
Процедура ЗаполнитьТаблицуПретендентов(ВосстанавливатьСтрокуЕслиСвернута = Истина) Экспорт
	
	
КонецПроцедуры // ОбновитьДанные()

// Процедура проставляет реквизиты Представление, КоличествоКандидатов для каждой строки дерева,
// а также заполняет список значений СписокКандидатов 
Процедура ОбработатьСтрокиДереваПретендентов(СтрокиДерева,Индекс = 0)
	
	Если Индекс < ПостроительОтчетаПоКандидатам.ИзмеренияСтроки.Количество() Тогда
		ИмяПараметра = ПостроительОтчетаПоКандидатам.ИзмеренияСтроки[Индекс].Имя; 
		ПредставлениеПараметра = ПостроительОтчетаПоКандидатам.ИзмеренияСтроки[Индекс].Представление;
	Иначе
		ИмяПараметра = "";
		ПредставлениеПараметра = "";
	КонецЕсли;
	
	Для каждого Строка из СтрокиДерева Цикл
		
		Если НЕ ЗначениеЗаполнено(ИмяПараметра) Тогда
			Строка.Представление = Строка.Претендент;
			Строка.КоличествоКандидатов = 1;
			
			СписокКандидатов.Добавить(Строка.Претендент);
		Иначе
			Параметр = Строка[ИмяПараметра];
			
			Если НЕ ЗначениеЗаполнено(Параметр) Тогда
				Если ПредставлениеПараметра = "Статус" Тогда
					Параметр = "Незарегистрованные";
				Иначе
					Параметр = "<пусто> ("+ПредставлениеПараметра+")";
				КонецЕсли;
			КонецЕсли;
			
			Строка.Представление = Параметр;
			ОбработатьСтрокиДереваПретендентов(Строка.Строки , Индекс+1);
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

// Процедура обновляет данные таблицы значений "Претенденты".
//
//
// Параметры:
//  Данные   - строки Дерева значений
//  Колонка  - наименование колонки поиска
//  Значение - значение поиска
//
Функция НайтиСтрокуВДереве(Данные,Значение,Колонка,ИскатьВПодчиненных = Истина)
	
	Если ТипЗнч(Значение) = Тип("Структура") Тогда
		МассивСтрок = Данные.НайтиСтроки(Значение);
		Если МассивСтрок.Количество() > 0 Тогда
			СтрокаПоиска = МассивСтрок[0];
		КонецЕсли;
	Иначе
		СтрокаПоиска = Данные.Найти(Значение,Колонка);
	КонецЕсли;
	
	Если  СтрокаПоиска <> Неопределено Тогда
		Возврат СтрокаПоиска;
	КонецЕсли;
	
	Если ИскатьВПодчиненных Тогда
		Для Каждого СтрокаТаблицыКандидатов из Данные Цикл
			
			СтрокаПоиска = НайтиСтрокуВДереве(СтрокаТаблицыКандидатов.Строки,Значение,Колонка);
			
			Если  СтрокаПоиска <> Неопределено Тогда
				Возврат СтрокаПоиска;
			КонецЕсли;
			
		КонецЦикла;
	КонецЕсли;
	
КонецФункции

///////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ МЕХАНИЗМА КОНТАКТНОЙ ИНФОРМАЦИИ

Процедура КонтекстноеМенюСпискаПисемСтруктураПодчиненностиДокумента(Кнопка)
	РаботаСДиалогами.ПоказатьСтруктуруПодчиненностиДокумента(ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные.Ссылка);
КонецПроцедуры

Процедура КонтекстноеМенюСпискаПисемСоздатьФильтрПоПисьму(Кнопка)
	
	Если ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ТекущееПисьмо = ЭлементыФормы.ЭлектронныеПисьмаСписок.ТекущиеДанные.Ссылка;
	
	Фильтр = Справочники.ФильтрыДляЭлектронныхПисем.СоздатьЭлемент();
	Фильтр.Владелец = ТекущееПисьмо.УчетнаяЗапись;
	Фильтр.Наименование = "Фильтр по письму";
	
	Если ЗначениеЗаполнено(ТекущееПисьмо.ОтправительПредставление) Тогда
		СтрокаУсловия = Фильтр.УсловияФильтра.Добавить();
		СтрокаУсловия.Условие = Перечисления.УсловияФильтровЭлектронныхПисем.ПолеОтправительСодержит;
		СтрокаУсловия.ЗначениеУсловия = ТекущееПисьмо.ОтправительПредставление;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ТекущееПисьмо.КомуПредставление) Тогда
		СтрокаУсловия = Фильтр.УсловияФильтра.Добавить();
		СтрокаУсловия.Условие = Перечисления.УсловияФильтровЭлектронныхПисем.ПолеКомуСодержит;
		СтрокаУсловия.ЗначениеУсловия = ТекущееПисьмо.Кому;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ТекущееПисьмо.КопииПредставление) Тогда
		СтрокаУсловия = Фильтр.УсловияФильтра.Добавить();
		СтрокаУсловия.Условие = Перечисления.УсловияФильтровЭлектронныхПисем.ПолеКопииСодержит;
		СтрокаУсловия.ЗначениеУсловия = ТекущееПисьмо.КопииПредставление;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ТекущееПисьмо.Тема) Тогда
		СтрокаУсловия = Фильтр.УсловияФильтра.Добавить();
		СтрокаУсловия.Условие = Перечисления.УсловияФильтровЭлектронныхПисем.ТемаПисьмаСодержит;
		СтрокаУсловия.ЗначениеУсловия = ТекущееПисьмо.Тема;
	КонецЕсли;
	
	Фильтр.ПолучитьФорму().Открыть();
	
КонецПроцедуры

Процедура КонтекстноеМенюСпискаПисемСнять(Кнопка)
	
	ИзменитьОформление(ЭлементыФормы.ЭлектронныеПисьмаСписок.ВыделенныеСтроки, Ложь);
	
КонецПроцедуры

Процедура КонтекстноеМенюСпискаПисемНастроить(Кнопка)
	
	ФормаВыбора = Справочники.ОформленияСтрокПисем.ПолучитьФормуСписка(, ЭтаФорма);
	ФормаВыбора.Открыть();
	
КонецПроцедуры

Процедура ЭлектронныеПисьмаСписокПриПолученииДанных(Элемент, ОформленияСтрок)
	
	// Обработка объектов если включена видимость соотв. колонки
	Если Элемент.Колонки.Объекты.Видимость Тогда
		
		// найдем новые ссылки
		СписокПисем = Новый СписокЗначений;
		Для каждого ОформлениеСтроки из ОформленияСтрок Цикл
			
			ЗначениеПоиска = СписокДанныхПоПисьмам[ОформлениеСтроки.ДанныеСтроки.Ссылка];
			
			Если ЗначениеПоиска = Неопределено Тогда
				СписокПисем.Добавить(ОформлениеСтроки.ДанныеСтроки.Ссылка);
				СписокДанныхПоПисьмам.Вставить(ОформлениеСтроки.ДанныеСтроки.Ссылка,0);
			КонецЕсли;
			
		КонецЦикла;
		
		ЭлементГруппыПисемДерево = ПолучитьЭлементГруппыПисемДерево();
		
		// получим но новым ссылкам количество писем
		Если СписокПисем.Количество() > 0 Тогда
			ПодготовитьТаблицуПоПисьмам(СписокПисем,?(ЭлементГруппыПисемДерево.ТекущиеДанные = Неопределено,Справочники.ГруппыПисемЭлектроннойПочты.ПустаяСсылка(),ЭлементГруппыПисемДерево.ТекущиеДанные.Ссылка));
			Для каждого СтрокаТаблицы из ТаблицаДанныхПоПисьмам Цикл
				Если СтрокаТаблицы.ЕстьОбъекты Тогда
					СписокДанныхПоПисьмам.Вставить(СтрокаТаблицы.Ссылка,1);
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		
		// отразим в оформлении строк
		Для каждого ОформлениеСтроки из ОформленияСтрок Цикл
			ЗначениеПоиска = СписокДанныхПоПисьмам[ОформлениеСтроки.ДанныеСтроки.Ссылка];
			Если ЗначениеПоиска <> Неопределено Тогда
				ОформлениеСтроки.Ячейки.Объекты.ИндексКартинки = ЗначениеПоиска;
			КонецЕсли; 
		КонецЦикла;
		
	КонецЕсли;
	
	Если ВыделитьВидимыеСтроки Тогда
		Для каждого Стр из ОформленияСтрок Цикл
			ЭлементыФормы.ЭлектронныеПисьмаСписок.ВыделенныеСтроки.Добавить(Стр.ДанныеСтроки.Ссылка);
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

Процедура КонтекстноеМенюСпискаПисемВыделитьВидимыеСтроки(Кнопка)
	ВыделитьВидимыеСтроки = Истина;
	ЭлементыФормы.ЭлектронныеПисьмаСписок.ОбновитьСтроки();
	ВыделитьВидимыеСтроки = Ложь;
КонецПроцедуры

Процедура КоманднаяПанельПочтыРассмотренностиПоТекущемуПользователю(Кнопка)
	
	Кнопка.Пометка = НЕ Кнопка.Пометка;
	мОтображатьРассмотренностиПисемТолькоПоТекущемуПользователю = Кнопка.Пометка;
	
	СобратьСтатистикуРассмотренностиПисем();
	
КонецПроцедуры

Процедура КонтекстноеМенюМокселяИзменитьСобытие(Кнопка)
	
	Расшифровка = ПолучитьРасшифровкуТекущейОбласти();
	
	Если ЗначениеЗаполнено(Расшифровка) И ТипЗнч(Расшифровка) = Тип("ДокументСсылка.Событие") Тогда
		Расшифровка.ПолучитьФорму(,ЭтаФорма).Открыть();
	КонецЕсли; 
	
КонецПроцедуры

Функция ПолучитьРасшифровкуТекущейОбласти()
	
	ИмяСтраницы = ЭлементыФормы.ПанельФормы.ТекущаяСтраница.Имя;
	
	Расшифровка = Неопределено;
	Если ИмяСтраницы = "Неделя" Тогда
		Попытка
			Расшифровка = ЭлементыФормы.ПолеТабличногоДокументаНеделя.ТекущаяОбласть.Расшифровка;
		Исключение
		КонецПопытки; 
	ИначеЕсли ИмяСтраницы = "День" Тогда
		Попытка
			Расшифровка = ЭлементыФормы.ПолеТабличногоДокументаДеньВторой.ТекущаяОбласть.Расшифровка;
		Исключение
		КонецПопытки; 
	КонецЕсли;
	
	Возврат Расшифровка;
	
КонецФункции

Процедура ИзменитьВремяСобытия(Событие)
	
	Если ЗначениеЗаполнено(Событие) И ТипЗнч(Событие) = Тип("ДокументСсылка.Событие") Тогда
		Форма = ПолучитьФорму("ФормаИзмененияВремениСобытия");
		Форма.Событие = Событие;
		ОтветФормы = Форма.ОткрытьМодально();
		Если ОтветФормы <> Неопределено И ОтветФормы Тогда
			ЗаписьДокументаСобытие();
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура КонтекстноеМенюМокселяПометитьКакЗавершено(Кнопка)
	
	Расшифровка = ПолучитьРасшифровкуТекущейОбласти();
	
	ИзменитьСостояниеСобытия(Расшифровка,Перечисления.СостоянияСобытий.Завершено);
	
КонецПроцедуры

Процедура КонтекстноеМенюМокселяПометитьКакОтменено(Кнопка)
	
	Расшифровка = ПолучитьРасшифровкуТекущейОбласти();
	
	ИзменитьСостояниеСобытия(Расшифровка,Перечисления.СостоянияСобытий.Отменено);
	
КонецПроцедуры

Процедура КонтекстноеМенюМокселяИзменитьВремя(Кнопка)
	
	Расшифровка = ПолучитьРасшифровкуТекущейОбласти();
	
	ИзменитьВремяСобытия(Расшифровка);
	
КонецПроцедуры

Процедура ИзменитьСостояниеСобытия(Ссылка,СостоянияСобытий)
	
	Если НЕ ЗначениеЗаполнено(Ссылка) Тогда
		Возврат;
	ИначеЕсли ТипЗнч(Ссылка) = Тип("ДокументСсылка.Событие") Тогда
		Объект = Ссылка.ПолучитьОбъект();    
		Объект.СостояниеСобытия = СостоянияСобытий;
		Объект.Записать(РежимЗаписиДокумента.Проведение);
		ЗаписьДокументаСобытие();
	КонецЕсли;
	
КонецПроцедуры

Процедура КоманднаяПанельПочтыПредметыПисем(Кнопка)
	
	Кнопка.Пометка = НЕ Кнопка.Пометка;
	мОтображатьСписокПредметов = Кнопка.Пометка;
	
	СобратьСтатистикуРассмотренностиПисем();
	
	ВидимостьСпискаПредметов();
	УстановитьОтборПредметов();
	
КонецПроцедуры

Процедура УстановитьПометкуКнопок(Кнопки, Имя)
	
	Для каждого Кнопка из Кнопки Цикл
		Если Кнопка.Имя = Имя Тогда
			Кнопка.Пометка = Истина;
		Иначе
			Кнопка.Пометка = Ложь;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Процедура КоманднаяПанельПочтыДополнительноОбновить(Кнопка)
	
	ОбщееОбновлениеПочты();
	
КонецПроцедуры

Процедура КоманднаяПанельПорядокГруппУстановитьРассмотрено(Кнопка)
	
	ЭлементГруппыПисемДерево = ПолучитьЭлементГруппыПисемДерево();
	
	Если ЭлементГруппыПисемДерево.ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ЭлементГруппыПисемДерево.ТекущиеДанные.Ссылка) Тогда
		Возврат;
	КонецЕсли;
	
	ДоступКУчетнойЗаписи = ЭлементГруппыПисемДерево.ТекущиеДанные.Владелец.ДоступКУчетнойЗаписи.Найти(глЗначениеПеременной("глТекущийПользователь"));
	Если ДоступКУчетнойЗаписи = Неопределено ИЛИ НЕ ДоступКУчетнойЗаписи.Запись Тогда
		Предупреждение("Вам не доступна данная функция.");
		Возврат;
	КонецЕсли;
	
	ФормаПараметров = ЭтотОбъект.ПолучитьФорму("ФормаНастройкиПринудительнойФильтрацииПисем");
	ФормаПараметров.ГруппаПисемДляОбработки = ЭлементГруппыПисемДерево.ТекущиеДанные.Ссылка;
	ФормаПараметров.СостояниеНеРассмотрено = Истина;
	ФормаПараметров.СостояниеРассмотрено   = Ложь;
	ФормаПараметров.ЭлементыФормы.СостояниеНеРассмотрено.Доступность = Ложь;
    ФормаПараметров.ЭлементыФормы.СостояниеРассмотрено.Доступность = Ложь;
	Запрос = ФормаПараметров.ОткрытьМодально();
	
	Если ТипЗнч(Запрос) = Тип("Запрос") Тогда
		ТаблицаПисем = Запрос.Выполнить().Выгрузить();
		Если ТаблицаПисем.Количество()>0 Тогда
			ИзменитьФлагРассмотренностьПисьма(ТаблицаПисем, Ложь);
		КонецЕсли;
	КонецЕсли;
	
	СобратьСтатистикуРассмотренностиПисем();
	
КонецПроцедуры

// Функция Определяет контрагента текщей строки табличного поля ЗаказыИСобытияПредставление.
//
// Параметры
//  НЕТ
//
// Возвращаемое значение:
//  СправочникСсылка.Конрагенты
//
Функция ОпределитьКонтрагента()
	
	Если ЭлементыФормы.ЗаказыИСобытияПредставление.ТекущиеДанные <> Неопределено И НЕ ЭлементыФормы.ЗаказыИСобытияПредставление.ТекущиеДанные.Документ.Пустая() Тогда
		Возврат ЭлементыФормы.ЗаказыИСобытияПредставление.ТекущиеДанные.Документ.Контрагент;
	Иначе
		Возврат Справочники.Контрагенты.ПустаяСсылка();
	КонецЕсли; 
	
КонецФункции // ОпределитьКонтрагента()

// Функция Определяет контрагента текщей строки табличного поля СделкиДень.
//
// Параметры
//  НЕТ
//
// Возвращаемое значение:
//  СправочникСсылка.Конрагенты
//
Функция ОпределитьКонтрагентаСпискаЗаказовДня()
	
	Если ЭлементыФормы.СделкиДень.ТекущиеДанные <> Неопределено И НЕ ЭлементыФормы.СделкиДень.ТекущиеДанные.Документ.Пустая() Тогда
		Возврат ЭлементыФормы.СделкиДень.ТекущиеДанные.Документ.КонтактноеЛицо;
	Иначе
		Возврат Справочники.ФизическиеЛица.ПустаяСсылка();
	КонецЕсли; 
	
КонецФункции // ОпределитьКонтрагента()

// Процедура устанавливает пометку кнопки ОтборПоТекущемуЗначению
// командной панели формы
//
// Параметры
//  НЕТ
//
// Возвращаемое значение:
//  НЕТ
Процедура СостояниеКнопокОтбораПоВидуДокумента()
	
	ОтборВидДокумента = СтруктураОтборов.Получить("ТипДокумента");
	
	ЭлементыФормы.КоманднаяПанельСписка.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаВсеДокументы.Пометка    = Ложь;
	ЭлементыФормы.КоманднаяПанельСписка.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаСобытие.Пометка         = Ложь;
	ЭлементыФормы.КоманднаяПанельСписка.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаЗаказПокупателя.Пометка = Ложь;
	ЭлементыФормы.КоманднаяПанельСписка.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаЗаказПоставщику.Пометка = Ложь;
	
	ЭлементыФормы.КоманднаяПанельСписка.Кнопки.Подменю.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаВсеДокументы.Пометка    = Ложь;
	ЭлементыФормы.КоманднаяПанельСписка.Кнопки.Подменю.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаСобытие.Пометка         = Ложь;
	ЭлементыФормы.КоманднаяПанельСписка.Кнопки.Подменю.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаЗаказПокупателя.Пометка = Ложь;
	ЭлементыФормы.КоманднаяПанельСписка.Кнопки.Подменю.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаЗаказПоставщику.Пометка = Ложь;
	
	Если ОтборВидДокумента <> Неопределено Тогда
		ЗначениеОтбора = ОтборВидДокумента[1];
		МассивТипов = ЗначениеОтбора.Типы();
		Если МассивТипов.Количество() = 1 Тогда
			Если МассивТипов[0] = Тип("ДокументСсылка.Событие") Тогда
				ЭлементыФормы.КоманднаяПанельСписка.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаВсеДокументы.Пометка    = Ложь;
				ЭлементыФормы.КоманднаяПанельСписка.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаСобытие.Пометка         = Истина;
				ЭлементыФормы.КоманднаяПанельСписка.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаЗаказПокупателя.Пометка = Ложь;
				ЭлементыФормы.КоманднаяПанельСписка.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаЗаказПоставщику.Пометка = Ложь;
				
				ЭлементыФормы.КоманднаяПанельСписка.Кнопки.Подменю.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаВсеДокументы.Пометка    = Ложь;
				ЭлементыФормы.КоманднаяПанельСписка.Кнопки.Подменю.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаСобытие.Пометка         = Истина;
				ЭлементыФормы.КоманднаяПанельСписка.Кнопки.Подменю.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаЗаказПокупателя.Пометка = Ложь;
				ЭлементыФормы.КоманднаяПанельСписка.Кнопки.Подменю.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаЗаказПоставщику.Пометка = Ложь;
			ИначеЕсли МассивТипов[0] = Тип("ДокументСсылка.ЗаказПокупателя") Тогда
				ЭлементыФормы.КоманднаяПанельСписка.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаВсеДокументы.Пометка    = Ложь;
				ЭлементыФормы.КоманднаяПанельСписка.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаСобытие.Пометка         = Ложь;
				ЭлементыФормы.КоманднаяПанельСписка.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаЗаказПокупателя.Пометка = Истина;
				ЭлементыФормы.КоманднаяПанельСписка.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаЗаказПоставщику.Пометка = Ложь;
				
				ЭлементыФормы.КоманднаяПанельСписка.Кнопки.Подменю.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаВсеДокументы.Пометка    = Ложь;
				ЭлементыФормы.КоманднаяПанельСписка.Кнопки.Подменю.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаСобытие.Пометка         = Ложь;
				ЭлементыФормы.КоманднаяПанельСписка.Кнопки.Подменю.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаЗаказПокупателя.Пометка = Истина;
				ЭлементыФормы.КоманднаяПанельСписка.Кнопки.Подменю.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаЗаказПоставщику.Пометка = Ложь;
			ИначеЕсли МассивТипов[0] = Тип("ДокументСсылка.ЗаказПоставщику") Тогда
				ЭлементыФормы.КоманднаяПанельСписка.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаВсеДокументы.Пометка    = Ложь;
				ЭлементыФормы.КоманднаяПанельСписка.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаСобытие.Пометка         = Ложь;
				ЭлементыФормы.КоманднаяПанельСписка.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаЗаказПокупателя.Пометка = Ложь;
				ЭлементыФормы.КоманднаяПанельСписка.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаЗаказПоставщику.Пометка = Истина;
				
				ЭлементыФормы.КоманднаяПанельСписка.Кнопки.Подменю.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаВсеДокументы.Пометка    = Ложь;
				ЭлементыФормы.КоманднаяПанельСписка.Кнопки.Подменю.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаСобытие.Пометка         = Ложь;
				ЭлементыФормы.КоманднаяПанельСписка.Кнопки.Подменю.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаЗаказПокупателя.Пометка = Ложь;
				ЭлементыФормы.КоманднаяПанельСписка.Кнопки.Подменю.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаЗаказПоставщику.Пометка = Истина;
			КонецЕсли; 
		КонецЕсли; 
	Иначе
		ЭлементыФормы.КоманднаяПанельСписка.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаВсеДокументы.Пометка    = Истина;
		ЭлементыФормы.КоманднаяПанельСписка.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаСобытие.Пометка         = Ложь;
		ЭлементыФормы.КоманднаяПанельСписка.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаЗаказПокупателя.Пометка = Ложь;
		ЭлементыФормы.КоманднаяПанельСписка.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаЗаказПоставщику.Пометка = Ложь;
		
		ЭлементыФормы.КоманднаяПанельСписка.Кнопки.Подменю.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаВсеДокументы.Пометка    = Истина;
		ЭлементыФормы.КоманднаяПанельСписка.Кнопки.Подменю.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаСобытие.Пометка         = Ложь;
		ЭлементыФормы.КоманднаяПанельСписка.Кнопки.Подменю.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаЗаказПокупателя.Пометка = Ложь;
		ЭлементыФормы.КоманднаяПанельСписка.Кнопки.Подменю.Кнопки.ОтборПоВидуДокумента.Кнопки.ОтборПоВидуДокументаЗаказПоставщику.Пометка = Ложь;
	КонецЕсли; 
	
КонецПроцедуры

// Процедура заполняет таблицу значений сделками и событиями
//  при этом разделяя их по датам
//
// Параметры
//  ТаблицаТаблицСделок - Таблица значений, таблица которую надо заполнить.
//
// Возвращаемое значение:
//   НЕТ
//
Процедура СобратьСделкиДня(ТаблицаТаблицСделок)
	
	Для каждого СтрокаТаблицы Из ДанныеНеделиЗаказы Цикл
		
		Для каждого СтрокаИсходнойТаблицы Из ТаблицаТаблицСделок Цикл
			
			ТекущаяДата = СтрокаИсходнойТаблицы.ДатаНедели;
			
			Если НачалоДня(СтрокаТаблицы.Дата) = НачалоДня(ТекущаяДата) Тогда
				
				ТаблицаСделок = СтрокаИсходнойТаблицы.ТаблицаСделок.Скопировать();;
				
				НоваяСделка = ТаблицаСделок.Добавить();
				НоваяСделка.Документ = СтрокаТаблицы.Документ;
				НоваяСделка.Контрагент = СтрокаТаблицы.Документ.Контрагент;
				НоваяСделка.ВидДокументаЗаказа = СтрокаТаблицы.ТипЗаказа;
				
				СтрокаИсходнойТаблицы.ТаблицаСделок = ТаблицаСделок.Скопировать();
				
				Прервать;
				
			КонецЕсли;
			
		КонецЦикла; 
		
	КонецЦикла;
	
КонецПроцедуры // СобратьСделкиДня()

// Процедура открывает форму документа ЗаказПокупателя.
//
// Параметры
//  Элемент - элемент формы
//
// Возвращаемое значение
//  НЕТ
Процедура ОткрытьДокументСделки(Элемент)
	
	Если Элемент.ТекущиеДанные <> Неопределено
		И (ТипЗнч(Элемент.ТекущиеДанные.Документ) = Тип("ДокументСсылка.ЗаказПокупателя")
		ИЛИ ТипЗнч(Элемент.ТекущиеДанные.Документ) = Тип("ДокументСсылка.ЗаказПоставщику"))
		И НЕ Элемент.ТекущиеДанные.Документ.Пустая() Тогда
		
		Элемент.ТекущиеДанные.Документ.ПолучитьФорму(,ЭтаФорма).Открыть();
		
	КонецЕсли; 
	
КонецПроцедуры

// Процедура меняет свойства кнопок конмандной панели формы.
//
// Параметры
//  НЕТ
//
// Возвращаемое значение
//  НЕТ
Процедура СостояниеТулбараФормы()
	
	Для каждого Страница Из ЭлементыФормы.ПанельФормы.Страницы Цикл
		ЭлементыФормы.КоманднаяПанельФормы.Кнопки[Страница.Имя].Пометка = (Страница = ЭлементыФормы.ПанельФормы.ТекущаяСтраница);
	КонецЦикла;
	
КонецПроцедуры

// Процедура изменяет доступность кнопок командной панели КоманднаяПанельСделкиДень
//
// Параметры
//  НЕТ
//
// Возвращаемое значение
//  НЕТ
Процедура ДоступностьКнопокКоманднойПанели_СделкиДень()
	
	Элемент = ЭлементыФормы.СделкиДень;
	
	Если Элемент.ТекущиеДанные <> Неопределено Тогда
		Если ТипЗнч(Элемент.ТекущиеДанные.Документ) = Тип("ДокументСсылка.ЗаказПокупателя") ИЛИ ТипЗнч(Элемент.ТекущиеДанные.Документ) = Тип("ДокументСсылка.ЗаказПоставщику") Тогда
			ЭлементыФормы.КоманднаяПанельСделкиДень.Кнопки.АнализЗаказа.Доступность = Истина;
			ЭлементыФормы.КоманднаяПанельСделкиДень.Кнопки.ДокументыПоЗаказу.Доступность = Истина;
		Иначе
			ЭлементыФормы.КоманднаяПанельСделкиДень.Кнопки.АнализЗаказа.Доступность = Ложь;
			ЭлементыФормы.КоманднаяПанельСделкиДень.Кнопки.ДокументыПоЗаказу.Доступность = Ложь;
		КонецЕсли;
		ЭлементыФормы.КоманднаяПанельСделкиДень.Кнопки.ПоКонтрагенту.Кнопки.СписокДокументов.Доступность = Истина;
		ЭлементыФормы.КоманднаяПанельСделкиДень.Кнопки.ПоКонтрагенту.Кнопки.СписокСобытий.Доступность    = Истина;
		//ЭлементыФормы.КоманднаяПанельСделкиДень.Кнопки.ПоКонтрагенту.Кнопки.Взаиморасчеты.Доступность    = Истина;
		//ЭлементыФормы.КоманднаяПанельСделкиДень.Кнопки.ПоКонтрагенту.Кнопки.ОтчетПоСобытиям.Доступность  = Истина;
	Иначе
		ЭлементыФормы.КоманднаяПанельСделкиДень.Кнопки.АнализЗаказа.Доступность                          = Ложь;
		ЭлементыФормы.КоманднаяПанельСделкиДень.Кнопки.ДокументыПоЗаказу.Доступность                     = Ложь;
		ЭлементыФормы.КоманднаяПанельСделкиДень.Кнопки.ПоКонтрагенту.Кнопки.СписокДокументов.Доступность = Ложь;
		ЭлементыФормы.КоманднаяПанельСделкиДень.Кнопки.ПоКонтрагенту.Кнопки.СписокСобытий.Доступность    = Ложь;
		//ЭлементыФормы.КоманднаяПанельСделкиДень.Кнопки.ПоКонтрагенту.Кнопки.Взаиморасчеты.Доступность    = Ложь;
		//ЭлементыФормы.КоманднаяПанельСделкиДень.Кнопки.ПоКонтрагенту.Кнопки.ОтчетПоСобытиям.Доступность  = Ложь;
	КонецЕсли; 
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

// Обработчик события Очистка элемента формы ВыбКонтрагент.
//
Процедура ВыбКонтрагентОчистка(Элемент, СтандартнаяОбработка)
	
	Если СтруктураОтборов.Получить("Контрагент") <> Неопределено Тогда
		СтруктураОтборов.Удалить("Контрагент");
		
		ОбновитьЗаказыСобытия(Ложь);
		ДобавитьНовыйОтборВИсторию();
		СостояниеКнопокОтбораПоВидуДокумента();
		
	КонецЕсли;
	
КонецПроцедуры

// Обработчик события НачалоВыбора элемента формы ВыбКонтрагент.
//
Процедура ВыбКонтрагентНачалоВыбора(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	Контрагенты = Справочники.Контрагенты.ПустаяСсылка();
	Выбран = ВвестиЗначение(Контрагенты, "Выберите контрагента");
	
	Если Выбран Тогда
		
		Если Контрагенты.ЭтоГруппа Тогда
			Возврат;
		КонецЕсли; 
		
		ВыбКонтрагент = Контрагенты;
		МассивОтбора = Новый Массив;
		МассивОтбора.Добавить(ВидСравнения.Равно);
		МассивОтбора.Добавить(Контрагенты);
		СтруктураОтборов.Вставить("Контрагент",МассивОтбора);
		
		ОбновитьЗаказыСобытия(Ложь);
		ДобавитьНовыйОтборВИсторию();
		СостояниеКнопокОтбораПоВидуДокумента();
		
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события ПриИзменении элемента формы ВыбКонтрагент.
//
Процедура ВыбКонтрагентПриИзменении(Элемент)
	
	Если ТипЗнч(Элемент.Значение) = Тип("СправочникСсылка.Контрагенты") И НЕ Элемент.Значение.Пустая() Тогда
		МассивОтбора = Новый Массив;
		МассивОтбора.Добавить(ВидСравнения.Равно);
		МассивОтбора.Добавить(Элемент.Значение);
		СтруктураОтборов.Вставить("Контрагент",МассивОтбора);
		
		ОбновитьЗаказыСобытия(Ложь);
		ДобавитьНовыйОтборВИсторию();
		СостояниеКнопокОтбораПоВидуДокумента();
		
	КонецЕсли;
	
КонецПроцедуры

// Обработчик события ПриВыводеСтроки элемента формы СделкиКалендаря.
//
Процедура СделкиКалендаряПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	
	ЯчейкаКонтрагент = ОформлениеСтроки.Ячейки.Найти("Контрагент");
	Если ЯчейкаКонтрагент = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ЯчейкаКонтрагент.ОтображатьТекст    = Истина;
	ЯчейкаКонтрагент.ОтображатьФлажок   = Ложь;
	ЯчейкаКонтрагент.ОтображатьКартинку = Истина;
	
	Если ДанныеСтроки.ВидДокументаЗаказа = Перечисления.ВидыДействийПоЗаказамПокупателей.ОплатаПоЗаказу Тогда
		ЯчейкаКонтрагент.ИндексКартинки = 6;
	ИначеЕсли ДанныеСтроки.ВидДокументаЗаказа = Перечисления.ВидыДействийПоЗаказамПокупателей.ОтгрузкаПоЗаказу Тогда
		ЯчейкаКонтрагент.ИндексКартинки = 5;
	ИначеЕсли ДанныеСтроки.ВидДокументаЗаказа = Перечисления.ВидыДействийПоЗаказамПоставщикам.ОплатаПоЗаказу Тогда
		ЯчейкаКонтрагент.ИндексКартинки = 10;
	ИначеЕсли ДанныеСтроки.ВидДокументаЗаказа = Перечисления.ВидыДействийПоЗаказамПоставщикам.ПоступлениеПоЗаказу Тогда
		ЯчейкаКонтрагент.ИндексКартинки = 9;
	КонецЕсли;
	
КонецПроцедуры

// Обработчик события элемента КоманднаяПанельСписка.Взаиморасчеты.
//
Процедура КоманднаяПанельСпискаВзаиморасчеты(Кнопка)
	
	ТекущийКонтрагент = ОпределитьКонтрагента();
	Если НЕ ЗначениеЗаполнено(ТекущийКонтрагент) Тогда
		Если ЗначениеЗаполнено(ВыбКонтрагент) Тогда
			ТекущийКонтрагент = ВыбКонтрагент;
		КонецЕсли;
	КонецЕсли;
	
	ОтчетКонтрагента = Отчеты.ВедомостьВзаиморасчетыСКонтрагентами.Создать();
	
	ОтчетКонтрагента.УстановитьНачальныеНастройки();
	
	ОтчетКонтрагента.УниверсальныйОтчет.ДатаКон = ДатаКон;
	ОтчетКонтрагента.УниверсальныйОтчет.ДатаНач = ДатаНач;
	//ОтчетКонтрагента.УниверсальныйОтчет.ВыводитьДетальныеЗаписи = Истина;
	
	Построитель = ОтчетКонтрагента.УниверсальныйОтчет.ПостроительОтчета;
	
	// Удалить группировки отчета по умолчанию
	ОтчетКонтрагента.УниверсальныйОтчет.ОчиститьНастройкиПостроителя();
	
	ОтчетКонтрагента.УниверсальныйОтчет.ДобавитьИзмерениеСтроки("Контрагент");
	ОтчетКонтрагента.УниверсальныйОтчет.ДобавитьИзмерениеСтроки("ДоговорКонтрагента");
	ОтчетКонтрагента.УниверсальныйОтчет.ДобавитьИзмерениеСтроки("Сделка");
	ОтчетКонтрагента.УниверсальныйОтчет.ДобавитьДополнительноеПоле("ВалютаВзаиморасчетов");
	
	Если ЗначениеЗаполнено(ВыбКонтрагент) Тогда
		ОтчетКонтрагента.УниверсальныйОтчет.ДобавитьОтбор("Контрагент", Истина, ВидСравнения.Равно, ТекущийКонтрагент);
	КонецЕсли;
		
	ОтчетКонтрагента.УниверсальныйОтчет.ДобавитьПорядок("ДоговорКонтрагента");
	ОтчетКонтрагента.УниверсальныйОтчет.ДобавитьПорядок("Сделка");
	
	ОтчетКонтрагента.УниверсальныйОтчет.мВосстанавливатьНастройкиПриОткрытии = Ложь;
	
	ФормаОтчета = ОтчетКонтрагента.ПолучитьФорму();
	ФормаОтчета.Открыть();
	ФормаОтчета.ОбновитьОтчет();
	
КонецПроцедуры

// Обработчик события элемента КоманднаяПанельСписка.СписокДокументов.
//
Процедура КоманднаяПанельСпискаСписокДокументов(Кнопка)
	
	ТекущийКонтрагент = ОпределитьКонтрагента();
	
	ФормаЖурнала = ЖурналыДокументов.ДокументыКонтрагентов.ПолучитьФорму();
	
	ФормаЖурнала.Отбор.ДокументыПоКонтрагенту.Значение = ТекущийКонтрагент;
	ФормаЖурнала.Отбор.ДокументыПоКонтрагенту.Использование = Истина;
	ФормаЖурнала.Открыть();
	
КонецПроцедуры

// Обработчик события элемента КоманднаяПанельСписка.АнализЗаказа.
//
Процедура КоманднаяПанельСпискаАнализЗаказа(Кнопка)
	
	Если ЭлементыФормы.ЗаказыИСобытияПредставление.ТекущиеДанные = Неопределено ИЛИ ТипЗнч(ЭлементыФормы.ЗаказыИСобытияПредставление.ТекущиеДанные.Документ) = Тип("ДокументСсылка.Событие") Тогда
		Возврат;
	КонецЕсли;
	УправлениеЗаказами.СформироватьОтчетАнализЗаказа(ЭлементыФормы.ЗаказыИСобытияПредставление.ТекущиеДанные.Документ,ложь, истина);
	
КонецПроцедуры

// Обработчик события элемента КоманднаяПанельСписка.ОтчетПоСобытиям.
//
Процедура КоманднаяПанельСпискаОтчетПоСобытиям(Кнопка)
	
	Если ЭлементыФормы.ЗаказыИСобытияПредставление.ТекущиеДанные <> Неопределено Тогда
		
		КонтрагентСтроки = ЭлементыФормы.ЗаказыИСобытияПредставление.ТекущиеДанные.Контрагент;
		
		ОбъектОтчета = Отчеты.ОтчетПоСобытиям.Создать();
		ОбъектОтчета.ЗаполнитьНачальныеНастройки();
		
		ОбъектОтчета.ДатаНачала    = ДатаНач;
		ОбъектОтчета.ДатаОкончания = ДатаКон;
		
		ОбъектОтчета.ПостроительОтчета.Отбор.Контрагент.Значение = КонтрагентСтроки;
		ОбъектОтчета.ПостроительОтчета.Отбор.Контрагент.Использование = Истина;
		
		ОбъектОтчета.ПостроительОтчета.ИзмеренияСтроки.Очистить();
		ОбъектОтчета.ПостроительОтчета.ИзмеренияСтроки.Добавить("Контрагент");
		
		ФормаОтчета = ОбъектОтчета.ПолучитьФорму();
		ФормаОтчета.НеЗаполнятьНастройкиПриОткрытии = Истина;
		ФормаОтчета.Открыть();
		ОбъектОтчета.СформироватьОтчет(ФормаОтчета.ЭлементыФормы.ПолеТабличногоДокумента);
		
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события элемента КоманднаяПанельСписка.ОтборПоВидуДокументаВсеДокументы.
//
Процедура КоманднаяПанельСпискаОтборПоВидуДокументаВсеДокументы(Кнопка)
	
	СтруктураОтборов.Удалить("ТипДокумента");
	
	ОбновитьЗаказыСобытия();
	
КонецПроцедуры

// Обработчик события элемента КоманднаяПанельСписка.ОтборПоВидуДокументаСобытие.
//
Процедура КоманднаяПанельСпискаОтборПоВидуДокументаСобытие(Кнопка)
	
	МассивТипов = Новый Массив;
	МассивТипов.Добавить(Тип("ДокументСсылка.Событие"));
	
	МассивОтбора = Новый Массив;
	МассивОтбора.Добавить(ВидСравнения.Равно);
	МассивОтбора.Добавить(Новый ОписаниеТипов(МассивТипов));
	СтруктураОтборов.Вставить("ТипДокумента",МассивОтбора);
	
	ОбновитьЗаказыСобытия();
	ДобавитьНовыйОтборВИсторию();
	СостояниеКнопокОтбораПоВидуДокумента();
	
КонецПроцедуры

// Обработчик события элемента КоманднаяПанельСписка.ОтборПоВидуДокументаЗаказПокупателя.
//
Процедура КоманднаяПанельСпискаОтборПоВидуДокументаЗаказПокупателя(Кнопка)
	
	МассивТипов = Новый Массив;
	МассивТипов.Добавить(Тип("ДокументСсылка.ЗаказПокупателя"));
	
	МассивОтбора = Новый Массив;
	МассивОтбора.Добавить(ВидСравнения.Равно);
	МассивОтбора.Добавить(Новый ОписаниеТипов(МассивТипов));
	СтруктураОтборов.Вставить("ТипДокумента",МассивОтбора);
	
	ОбновитьЗаказыСобытия();
	ДобавитьНовыйОтборВИсторию();
	СостояниеКнопокОтбораПоВидуДокумента();
	
КонецПроцедуры

// Обработчик события элемента КоманднаяПанельСписка.ОтборПоВидуДокументаЗаказПоставщику.
//
Процедура КоманднаяПанельСпискаОтборПоВидуДокументаЗаказПоставщику(Кнопка)
	
	МассивТипов = Новый Массив;
	МассивТипов.Добавить(Тип("ДокументСсылка.ЗаказПоставщику"));
	
	МассивОтбора = Новый Массив;
	МассивОтбора.Добавить(ВидСравнения.Равно);
	МассивОтбора.Добавить(Новый ОписаниеТипов(МассивТипов));
	СтруктураОтборов.Вставить("ТипДокумента",МассивОтбора);
	
	ОбновитьЗаказыСобытия();
	ДобавитьНовыйОтборВИсторию();
	СостояниеКнопокОтбораПоВидуДокумента();
	
КонецПроцедуры

// Обработчик события элемента КоманднаяПанельСписка.СписокСобытий.
//
Процедура КоманднаяПанельСпискаСписокСобытий(Кнопка)
	
	ТекущийКонтрагент = ОпределитьКонтрагента();
	
	ФормаСписка = Документы.Событие.ПолучитьФормуСписка();
	
	ФормаСписка.Отбор.ДокументыПоКонтрагенту.Значение = ТекущийКонтрагент;
	ФормаСписка.Отбор.ДокументыПоКонтрагенту.Использование = Истина;
	ФормаСписка.Открыть();
	
КонецПроцедуры

// Обработчик события элемента КоманднаяПанельСписка.ДокументыПоЗаказу.
//
Процедура КоманднаяПанельСпискаДокументыПоЗаказу(Кнопка)
	
	ОтобразитьСвязанныеДокументыПоЗаказу(ЭлементыФормы.ЗаказыИСобытияПредставление.ТекущиеДанные);
	
КонецПроцедуры

// Обработчик события ПриВыводеСтроки элемента СделкиДень.
//
Процедура СделкиДеньПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	
	ОформлениеСтроки.Ячейки.ВидДокументаЗаказа.ОтображатьТекст    = Ложь;
	ОформлениеСтроки.Ячейки.ВидДокументаЗаказа.ОтображатьФлажок   = Ложь;
	ОформлениеСтроки.Ячейки.ВидДокументаЗаказа.ОтображатьКартинку = Истина;
	
	Если ДанныеСтроки.ВидДокументаЗаказа = Перечисления.ВидыДействийПоЗаказамПокупателей.ОплатаПоЗаказу Тогда
		ОформлениеСтроки.Ячейки.ВидДокументаЗаказа.ИндексКартинки = 6;
	ИначеЕсли ДанныеСтроки.ВидДокументаЗаказа = Перечисления.ВидыДействийПоЗаказамПокупателей.ОтгрузкаПоЗаказу Тогда
		ОформлениеСтроки.Ячейки.ВидДокументаЗаказа.ИндексКартинки = 5;
	ИначеЕсли ДанныеСтроки.ВидДокументаЗаказа = Перечисления.ВидыДействийПоЗаказамПоставщикам.ОплатаПоЗаказу Тогда
		ОформлениеСтроки.Ячейки.ВидДокументаЗаказа.ИндексКартинки = 10;
	ИначеЕсли ДанныеСтроки.ВидДокументаЗаказа = Перечисления.ВидыДействийПоЗаказамПоставщикам.ПоступлениеПоЗаказу Тогда
		ОформлениеСтроки.Ячейки.ВидДокументаЗаказа.ИндексКартинки = 9;
	КонецЕсли;
	
	ОформлениеСтроки.Ячейки.КартинкаДокумента.ОтображатьТекст    = Ложь;
	ОформлениеСтроки.Ячейки.КартинкаДокумента.ОтображатьФлажок   = Ложь;
	ОформлениеСтроки.Ячейки.КартинкаДокумента.ОтображатьКартинку = Истина;
	
	Если ДанныеСтроки.Документ = Неопределено Тогда
		ОформлениеСтроки.Ячейки.КартинкаДокумента.ИндексКартинки = 3;
	Иначе
		Если ДанныеСтроки.Документ.Проведен Тогда
			ОформлениеСтроки.Ячейки.КартинкаДокумента.ИндексКартинки = 0;
		ИначеЕсли ДанныеСтроки.Документ.ПометкаУдаления Тогда
			ОформлениеСтроки.Ячейки.КартинкаДокумента.ИндексКартинки = 1;
		Иначе
			ОформлениеСтроки.Ячейки.КартинкаДокумента.ИндексКартинки = 2;
		КонецЕсли; 
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события ПриАктивизацииСтроки элемента СделкиДень.
//
Процедура СделкиДеньПриАктивизацииСтроки(Элемент)
	
	ДоступностьКнопокКоманднойПанели_СделкиДень();
	
КонецПроцедуры

// Обработчик события ПередНачаломИзменения элемента СделкиДень.
//
Процедура СделкиДеньПередНачаломИзменения(Элемент, Отказ)
	
	Отказ = Истина;
	
	Если Элемент.ТекущиеДанные <> Неопределено
		И (ТипЗнч(Элемент.ТекущиеДанные.Документ) = Тип("ДокументСсылка.ЗаказПокупателя")
		ИЛИ ТипЗнч(Элемент.ТекущиеДанные.Документ) = Тип("ДокументСсылка.ЗаказПоставщику"))
		И НЕ Элемент.ТекущиеДанные.Документ.Пустая() Тогда
		
		Элемент.ТекущиеДанные.Документ.ПолучитьФорму(,ЭтаФорма).Открыть();
		
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события ПередНачаломДобавления элемента СделкиДень.
//
Процедура СделкиДеньПередНачаломДобавления(Элемент, Отказ, Копирование)
	
	Отказ = Истина;
	
	Если Копирование Тогда
		
		Если Элемент.ТекущиеДанные <> Неопределено И ЗначениеЗаполнено(Элемент.ТекущиеДанные.Документ) Тогда
			
			НовыйОбъект = Элемент.ТекущиеДанные.Документ.Скопировать();
			НовыйОбъект.Ответственный = ПользовательКалендаря;
			НовыйОбъект.ПолучитьФорму(,ЭтаФорма).Открыть();
			
		КонецЕсли;
		
	Иначе
		
		СписокОбъектов = Новый СписокЗначений;
		СписокОбъектов.Добавить("ЗаказПокупателя", "Заказ покупателя");
		СписокОбъектов.Добавить("ЗаказПоставщику", "Заказ поставщику");
		
		ВыбранныйЭлемент = СписокОбъектов.ВыбратьЭлемент("Выберите тип документа", СписокОбъектов[0]);
		
		Если ВыбранныйЭлемент = Неопределено Тогда
			Возврат;
		КонецЕсли; 
		
		НовыйОбъект = Документы[ВыбранныйЭлемент.Значение].СоздатьДокумент();
		НовыйОбъект.Ответственный = ПользовательКалендаря;
		НовыйОбъект.ПолучитьФорму(,ЭтаФорма).Открыть();
		
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик события ПередУдалением элемента СделкиДень.
//
Процедура СделкиДеньПередУдалением(Элемент, Отказ)
	
	Отказ = Истина;
	
	Если Элемент.ТекущиеДанные <> Неопределено И ТипЗнч(Элемент.ТекущиеДанные.Документ) = Тип("ДокументСсылка.ЗаказПокупателя") И НЕ Элемент.ТекущиеДанные.Документ.Пустая() Тогда
		
		Если Элемент.ТекущиеДанные.Документ.ПометкаУдаления Тогда
			ТекстВопроса = "Снять с объекта пометку на удаление?";
		Иначе
			ТекстВопроса = "Пометить объект на удаление?";
		КонецЕсли;
		
		Ответ = Вопрос(ТекстВопроса, РежимДиалогаВопрос.ДаНет);
		
		Если Ответ = КодВозвратаДиалога.Нет  Тогда
			Возврат;
		КонецЕсли;
		
		ОбъектДокумент = Элемент.ТекущиеДанные.Документ.ПолучитьОбъект();
		
		Попытка
			
			ОбъектДокумент.УстановитьПометкуУдаления(НЕ ОбъектДокумент.ПометкаУдаления);
			
			ОбновитьДень[0]   = Истина;
			ОбновитьДень[2]   = Истина;
			
			ОбновитьНеделю[0] = Истина;
			ОбновитьНеделю[2] = Истина;
			
			ОбновитьМесяц[0]  = Истина;
			ОбновитьМесяц[2]  = Истина;
			
			ОбновитьИнформациюНаФорме();
			
		Исключение
			
			Сообщить(ОписаниеОшибки(), СтатусСообщения.Важное);
			
		КонецПопытки;
		
	КонецЕсли; 
	
КонецПроцедуры

// Обработчик назначается методом УстановитьДействие()
// Обработчик события ПриВыводеСтроки элемента ТЗСделок.
//
Процедура ТЗСделокПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	
	СделкиКалендаряПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки);
	
КонецПроцедуры

// Обработчик назначается методом УстановитьДействие()
// Обработчик события ПередНачаломИзменения элемента ТЗСделок.
//
Процедура ТЗСделокПередНачаломИзменения(Элемент, Отказ)
	
	Отказ = Истина;
	ОткрытьДокументСделки(Элемент);
	
КонецПроцедуры

// Обработчик события Нажатие элемента КоманднаяПанельСделкиДень.АнализЗаказа.
//
Процедура КоманднаяПанельСделкиДеньАнализЗаказа(Кнопка)
	УправлениеЗаказами.СформироватьОтчетАнализЗаказа(ЭлементыФормы.СделкиДень.ТекущиеДанные.Документ,ложь, истина);
КонецПроцедуры

// Обработчик события Нажатие элемента КоманднаяПанельСделкиДень.ДокументыПоЗаказу.
//
Процедура КоманднаяПанельСделкиДеньДокументыПоЗаказу(Кнопка)
	
	ОтобразитьСвязанныеДокументыПоЗаказу(ЭлементыФормы.СделкиДень.ТекущиеДанные);
	
КонецПроцедуры

// Обработчик события Нажатие элемента КоманднаяПанельСделкиДень.СписокДокументов.
//
Процедура КоманднаяПанельСделкиДеньСписокДокументов(Кнопка)
	
	ТекущийКонтрагент = ОпределитьКонтрагентаСпискаЗаказовДня();
	
	ФормаЖурнала = ЖурналыДокументов.ДокументыКонтрагентов.ПолучитьФорму();
	
	ФормаЖурнала.Отбор.ДокументыПоКонтрагенту.Значение = ТекущийКонтрагент;
	ФормаЖурнала.Отбор.ДокументыПоКонтрагенту.Использование = Истина;
	ФормаЖурнала.Открыть();
	
КонецПроцедуры

// Обработчик события Нажатие элемента КоманднаяПанельСделкиДень.СписокСобытий.
//
Процедура КоманднаяПанельСделкиДеньСписокСобытий(Кнопка)
	
	ТекущийКонтрагент = ОпределитьКонтрагентаСпискаЗаказовДня();
	
	ФормаСписка = Документы.Событие.ПолучитьФормуСписка();
	
	ФормаСписка.Отбор.ДокументыПоКонтрагенту.Значение = ТекущийКонтрагент;
	ФормаСписка.Отбор.ДокументыПоКонтрагенту.Использование = Истина;
	ФормаСписка.Открыть();
	
КонецПроцедуры

// Обработчик события ПриВыводеСтроки элемента формы ПредметыСписок.
//
Процедура ПредметыСписокПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	
	СтатистикаГруппы = мСтатистикаРассмотренностиПисемПоПредметам.Получить(ДанныеСтроки.ГруппаПисемЭлектроннойПочты);
	Если СтатистикаГруппы <> Неопределено Тогда
		СтатистикаПредмета = СтатистикаГруппы.Получить(ДанныеСтроки.Предмет);
		Если ТипЗнч(СтатистикаПредмета) = Тип("Число") И СтатистикаПредмета > 0 Тогда
			ОформлениеСтроки.Ячейки.Предмет.ОтображатьТекст = Истина;
			Если НЕ ЗначениеЗаполнено(ДанныеСтроки.Предмет) Тогда
				ОформлениеСтроки.Ячейки.Предмет.Текст = "<Предмет не указан>" + " (" + СтатистикаПредмета + ")";
			Иначе
				ОформлениеСтроки.Ячейки.Предмет.Текст = Строка(ДанныеСтроки.Предмет) + " (" + СтатистикаПредмета + ")";
			КонецЕсли; 
			ОформлениеСтроки.Шрифт = мЖирныйШрифт;
		Иначе
			Если НЕ ЗначениеЗаполнено(ДанныеСтроки.Предмет) Тогда
				ОформлениеСтроки.Ячейки.Предмет.ОтображатьТекст = Истина;
				ОформлениеСтроки.Ячейки.Предмет.Текст = "<Предмет не указан>";
			КонецЕсли;
		КонецЕсли;
	Иначе
		Если НЕ ЗначениеЗаполнено(ДанныеСтроки.Предмет) Тогда
			ОформлениеСтроки.Ячейки.Предмет.ОтображатьТекст = Истина;
			ОформлениеСтроки.Ячейки.Предмет.Текст = "<Предмет не указан>";
		КонецЕсли;
	КонецЕсли;
	
	Если ДанныеСтроки.Скрытый Тогда
		ОформлениеСтроки.Ячейки.Предмет.ЦветТекста = WebЦвета.Серый;
	Иначе
		Если мКнопкаОтображатьСкрытыеПредметыПисем.Пометка Тогда
			ОформлениеСтроки.Ячейки.Предмет.ЦветФона = ЦветаСтиля.ЦветФонаФормы;
		КонецЕсли; 
	КонецЕсли;
	
	ОформлениеСтроки.Ячейки.Предмет.ОтображатьКартинку = Истина;
	Если ТипЗнч(ДанныеСтроки.Предмет) = Тип("Строка") Тогда
		ОформлениеСтроки.Ячейки.Предмет.Картинка = мПустаяКартинка;
	Иначе
		ОформлениеСтроки.Ячейки.Предмет.Картинка = мКартинкаКандидата;
	КонецЕсли; 
	
КонецПроцедуры

// КОНТАКТЫ

////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ

// Функция возвращает булево значение наличие отбора по объекту 
// при условии что объект формы выбран
Функция ЕстьОтбор() 
	Возврат ОтборПоОбъекту И ЗначениеЗаполнено(ОбъектФормы);
КонецФункции

Процедура ОтобразитьСвязанныеДокументыПоЗаказу(ТекущиеДанные)
	
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если (ТипЗнч(ТекущиеДанные.Документ) = Тип("ДокументСсылка.ЗаказПокупателя")) ИЛИ (ТипЗнч(ТекущиеДанные.Документ) = Тип("ДокументСсылка.ЗаказПоставщику")) Тогда
		ФормаСвязанныеДокументы = КритерииОтбора.СвязанныеДокументы.ПолучитьФорму();
		ФормаСвязанныеДокументы.ПараметрОтборПоЗначению = ТекущиеДанные.Документ;
		ФормаСвязанныеДокументы.Открыть();
	КонецЕсли;
	
КонецПроцедуры


// КАЛЕНДАРЬ

ЭтаФорма.РазрешитьСоединятьОкно = Истина;
ЭтаФорма.РазрешитьСостояниеОбычное = Истина;
ЭтаФорма.РазрешитьСостояниеПрикрепленное = Истина;
ЭтаФорма.РазрешитьСостояниеПрячущееся = Истина;
ЭтаФорма.РазрешитьСостояниеСвободное = Истина;

мДокументыОснования = Новый Структура;

СделкиДень.Колонки.Добавить("Документ");

мСписокДокументовДобавления = Новый СписокЗначений;

МассивЗначений = Новый Массив;
МассивЗначений.Добавить(Перечисления.ВидыСобытий.ТелефонныйЗвонок);
МассивЗначений.Добавить(Перечисления.ВходящееИсходящееСобытие.Исходящее);
мСписокДокументовДобавления.Добавить(МассивЗначений, "Телефонный звонок",, БиблиотекаКартинок.Телефон);

МассивЗначений = Новый Массив;
МассивЗначений.Добавить(Перечисления.ВидыСобытий.ЭлектронноеПисьмо);
МассивЗначений.Добавить(Перечисления.ВходящееИсходящееСобытие.Исходящее);
мСписокДокументовДобавления.Добавить(МассивЗначений,"Электронное письмо",, БиблиотекаКартинок.ЭлектронноеПисьмо);

МассивЗначений = Новый Массив;
МассивЗначений.Добавить(Перечисления.ВидыСобытий.ЛичнаяВстреча);
МассивЗначений.Добавить(Перечисления.ВходящееИсходящееСобытие.Исходящее);
мСписокДокументовДобавления.Добавить(МассивЗначений,"Личная встреча",, БиблиотекаКартинок.ЛичнаяВстреча);

МассивЗначений = Новый Массив;
МассивЗначений.Добавить(Перечисления.ВидыСобытий.ПочтовоеПисьмо);
МассивЗначений.Добавить(Перечисления.ВходящееИсходящееСобытие.Исходящее);
мСписокДокументовДобавления.Добавить(МассивЗначений,"Почтовое письмо",, БиблиотекаКартинок.ПочтовоеПисьмо);

МассивЗначений = Новый Массив;
МассивЗначений.Добавить(Перечисления.ВидыСобытий.Прочее);
МассивЗначений.Добавить(Перечисления.ВходящееИсходящееСобытие.Исходящее);
мСписокДокументовДобавления.Добавить(МассивЗначений,"Прочее",, БиблиотекаКартинок.ПрочееСобытие);

мМассивЗначенийБыстрогоСобытия = Неопределено;

мТаблицаЯчеекИДатНедели = Неопределено;

мСписокМесяцевВыбора = Новый СписокЗначений;

ОбновитьСписок = Новый Массив;
ОбновитьСписок.Добавить(Ложь); // Флаг необходимости перезаполнения списка событий
ОбновитьСписок.Добавить(Истина); // Флаг необходимости выполнения запроса для списка событий

ОбновитьДень = Новый Массив;
ОбновитьДень.Добавить(Истина); // Флаг необходимости обновления данных о событиях и заказах в "мокселе" и "гриде"
ОбновитьДень.Добавить('00010101000000'); // Дата последнего заполнения
ОбновитьДень.Добавить(Истина); // Безусловное перевыполение запроса недели календаря

ОбновитьНеделю = Новый Массив;
ОбновитьНеделю.Добавить(Истина); // Флаг необходимости обновления данных о событиях и заказах в "мокселе" и "гриде"
ОбновитьНеделю.Добавить('00010101000000'); // Дата начала недели последнего заполнения
ОбновитьНеделю.Добавить(Истина); // Безусловное перевыполение запроса недели календаря

ОбновитьМесяц = Новый Массив;
ОбновитьМесяц.Добавить(Истина); // Флаг необходимости обновления данных о событиях и заказах в "мокселе"
ОбновитьМесяц.Добавить('00010101000000'); // Дата начала месяца последнего заполнения
ОбновитьМесяц.Добавить(Истина); // Безусловное перевыполение запроса месяца календаря

мБылоПервоеЗаполнениеНедели = Ложь;

мИмяТекущейОбластиДвойногоДня = "R1C1";
мИмяТекущейОбластиДня = "R1C1";

мСписокИсторииОтбора = Новый СписокЗначений;

мБиблиотекаКартинокДокумент = БиблиотекаКартинок.ДокументОбъект;

мМакетДня    = ПолучитьМакет("МакетДняПолный");
мМакетНедели = ПолучитьМакет("МакетНеделя");
мЛичнаяВстречаИсходящяя = БиблиотекаКартинок.ЛичнаяВстречаИсходящяя;
мЛичнаяВстречаВходящяя  = БиблиотекаКартинок.ЛичнаяВстречаВходящяя;
мПочтовоеПисьмоИсходящее = БиблиотекаКартинок.ПочтовоеПисьмоИсходящее;
мПочтовоеПисьмоВходящее = БиблиотекаКартинок.ПочтовоеПисьмоВходящее;
мПрочееСобытиеИсходящее = БиблиотекаКартинок.ПрочееСобытиеИсходящее;
мПрочееСобытиеВходящее = БиблиотекаКартинок.ПрочееСобытиеВходящее;
мТелефонныйЗвонокИсходящий = БиблиотекаКартинок.ТелефонныйЗвонокИсходящий;
мТелефонныйЗвонокВходящий = БиблиотекаКартинок.ТелефонныйЗвонокВходящий;
мЭлектронноеПисьмоИсходящее = БиблиотекаКартинок.ЭлектронноеПисьмоИсходящее;
мЭлектронноеПисьмоВходящее = БиблиотекаКартинок.ЭлектронноеПисьмоВходящее;

// ПОЧТА

Для каждого Реквизит Из Метаданные.Документы.ЭлектронноеПисьмо.Реквизиты Цикл
	ЭлектронныеПисьмаСписок.Колонки.Добавить(Реквизит.Имя, Ложь);
КонецЦикла;

мЖирныйШрифт = Новый Шрифт(,, Истина);

ГруппыПисемДерево.Колонки.Добавить("Владелец"                 , Ложь);
ГруппыПисемДерево.Колонки.Добавить("Порядок"                  , Ложь);
ГруппыПисемДерево.Колонки.Добавить("ИспользоватьПредметыПисем", Ложь);

ПредметыСписок.Колонки.Добавить("ГруппаПисемЭлектроннойПочты", Ложь);
ПредметыСписок.Колонки.Добавить("Скрытый", Ложь);

мИзменятьСписокЭлектронныхПисемПриВыбореПапкиПисем = УправлениеПользователями.ПолучитьЗначениеПоУмолчанию(глЗначениеПеременной("глТекущийПользователь"), "ИзменятьСписокЭлектронныхПисемПриВыбореПапкиПисем");
Если ТипЗнч(мИзменятьСписокЭлектронныхПисемПриВыбореПапкиПисем) <> Тип("Булево") Тогда
	мИзменятьСписокЭлектронныхПисемПриВыбореПапкиПисем = Ложь;
КонецЕсли; 

мКартинкаКандидата = БиблиотекаКартинок.ПерепискаСКандидатом;
мПустаяКартинка    = Новый Картинка;

// КОНТАКТЫ

СписокКандидатов = Новый СписокЗначений;

СписокНепрочитанностиПисем       = Новый Соответствие();
СписокДанныхПоПредметам          = Новый Соответствие(); 
СписокДанныхПоПисьмам            = Новый Соответствие();
СписокДанныхПоПредметамПоОбъекту = Новый Соответствие(); 

ВыделитьВидимыеСтроки = Ложь;

// ОБЩЕЕ

// режим рабочего стола
РежимРабочегоСтола = УправлениеПользователями.ПолучитьЗначениеПоУмолчанию(глЗначениеПеременной("глТекущийПользователь"), "РежимРабочегоСтолаДляМенеджераКонтактов");
ЭлектронныеПисьмаСписок.Колонки.Добавить("Оформление");
ЭлектронныеПисьмаСписок.Колонки.Добавить("Ответственный"); 


СоответствиеСокращенныхТекстовЭлектронныхПисем = Новый Соответствие();

мСкрепкиЛистовКалендаряПользователяНеРабочие = БиблиотекаКартинок.СкрепкиЛистовКалендаряПользователяНеРабочие;
мСкрепкиЛистовКалендаряПользователяРабочие   = БиблиотекаКартинок.СкрепкиЛистовКалендаряПользователяРабочие;

мНевидимаяСкрепка = БиблиотекаКартинок.НевидимаяСкрепка;
мТолькоСкрепка    = БиблиотекаКартинок.ТолькоСкрепка;

мКлассификацияУчетныхЗаписейПоПредметам = Новый Соответствие;

ПериодАвтообновленияСпискаКандидатов = 60;

мВыполняетсяОбновлениеОтображения = Ложь;