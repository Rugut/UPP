Процедура ПриОткрытии()
	
	Если ИмяРегистраПлан="ЗаявкиНаРасходованиеСредств" Тогда
		ИмяДокумента="ЗаявкаНаРасходование";
		ПредставлениеДокумента="Заявки на расходование средств";
	Иначе
		ИмяДокумента="ДокументПланирования";
		ПредставлениеДокумента="Планируемые поступления денежных средств";
	КонецЕсли;
	
	ЭтаФорма.Заголовок=ПредставлениеДокумента+". Вид операции: "+Строка(ВидОперацииПлан);
		
	СформироватьСписокПланируемыхДвижений(ИмяДокумента);
	
	РаботаСДиалогами.УстановитьВидимостьПроекта(, ЭлементыФормы, "ПланируемыеДвижения.Проект");
		
КонецПроцедуры

Процедура ПланируемыеДвиженияВыбор(Элемент, ВыбраннаяСтрока, Колонка, СтандартнаяОбработка)
	
	Перем КурсВзаиморасчетов,КратностьВзаиморасчетов,СуммаПлатежа,СуммаВзаиморасчетов;
	
	Если ТипЗнч(ВыбраннаяСтрока)=Тип("Массив") Тогда
		
		СтавкаНДС=?(НЕ ЗначениеЗаполнено(РасшифровкаПлатежаДок[0].СтавкаНДС),УправлениеПользователями.ПолучитьЗначениеПоУмолчанию(глЗначениеПеременной("глТекущийПользователь"),"ОсновнаяСтавкаНДС"),
						РасшифровкаПлатежаДок[0].СтавкаНДС);
		
		Для Каждого Строка Из ВыбраннаяСтрока Цикл
			
			НоваяСтрока=РасшифровкаПлатежаДок.Добавить();
			НоваяСтрока.ДоговорКонтрагента=Строка.ДоговорКонтрагента;
			НоваяСтрока.Сделка=Строка.Сделка;
			НоваяСтрока.ДокументРасчетовСКонтрагентом=Строка.ДокументРасчетовСКонтрагентом;
			НоваяСтрока.СуммаПлатежа=Строка.СуммаПлатежа;
			НоваяСтрока.КурсВзаиморасчетов=Строка.КурсВзаиморасчетов;
			НоваяСтрока.КратностьВзаиморасчетов=Строка.КратностьВзаиморасчетов;
			НоваяСтрока.СуммаВзаиморасчетов=Строка.СуммаВзаиморасчетов;
			НоваяСтрока.ДокументПланированияПлатежа=Строка.ДокументПланирования;
			НоваяСтрока.СтатьяДвиженияДенежныхСредств=Строка.СтатьяДвиженияДенежныхСредств;
			НоваяСтрока.Проект=Строка.Проект;
			НоваяСтрока.КурсВзаиморасчетовПлан=Строка.КурсВзаиморасчетовПлан;
			НоваяСтрока.СуммаПлатежаПлан=Строка.СуммаПлатежа;
			
			Если (Не ОтражатьВБухгалтерскомУчете=Неопределено) И ОтражатьВБухгалтерскомУчете Тогда
				
				УправлениеДенежнымиСредствами.ЗаполнитьРеквизитыРеглУчета(ДокументСсылка,НоваяСтрока, СтавкаНДС,ОтражатьВБухгалтерскомУчете);
				
			КонецЕсли;
			
		КонецЦикла;
		
		Пока ВыбраннаяСтрока.Количество()>0 Цикл
			
			ПланируемыеДвижения.Удалить(ВыбраннаяСтрока[0])
			
		КонецЦикла;
		
		ОповеститьОВыборе("АвтоПодбор");
		
	Иначе
		
		СтрокаДоговор=ВыбраннаяСтрока;
		
		Если ЕстьПодбор И НЕ ЭтаФорма.КлючУникальности="ФормаПодбораПараметров" Тогда
			
			НоваяСтрока=РасшифровкаПлатежаДок.Добавить();
			НоваяСтрока.ДоговорКонтрагента=СтрокаДоговор.ДоговорКонтрагента;
			НоваяСтрока.Сделка=СтрокаДоговор.Сделка;
			НоваяСтрока.ДокументРасчетовСКонтрагентом=СтрокаДоговор.ДокументРасчетовСКонтрагентом;
			НоваяСтрока.СуммаПлатежа=СтрокаДоговор.СуммаПлатежа;
			НоваяСтрока.КурсВзаиморасчетов=СтрокаДоговор.КурсВзаиморасчетов;
			НоваяСтрока.КратностьВзаиморасчетов=СтрокаДоговор.КратностьВзаиморасчетов;
			НоваяСтрока.СуммаВзаиморасчетов=СтрокаДоговор.СуммаВзаиморасчетов;
			НоваяСтрока.ДокументПланированияПлатежа=СтрокаДоговор.ДокументПланирования;
			НоваяСтрока.СтатьяДвиженияДенежныхСредств=СтрокаДоговор.СтатьяДвиженияДенежныхСредств;
			НоваяСтрока.Проект=СтрокаДоговор.Проект;
			НоваяСтрока.КурсВзаиморасчетовПлан=СтрокаДоговор.КурсВзаиморасчетовПлан;
			НоваяСтрока.СуммаПлатежаПлан=СтрокаДоговор.СуммаПлатежа;
			
			Если (Не ОтражатьВБухгалтерскомУчете=Неопределено) И ОтражатьВБухгалтерскомУчете Тогда
				
				УправлениеДенежнымиСредствами.ЗаполнитьРеквизитыРеглУчета(ДокументСсылка,НоваяСтрока, СтавкаНДС,ОтражатьВБухгалтерскомУчете);
				
			КонецЕсли;
			
			ПланируемыеДвижения.Удалить(СтрокаДоговор);
			ОповеститьОВыборе("АвтоПодбор");
			
		Иначе	
			
			СтруктураПодбора=Новый Структура;
			
			СтруктураПодбора.Вставить("ДоговорКонтрагента",				СтрокаДоговор.ДоговорКонтрагента);
			СтруктураПодбора.Вставить("Сделка",							СтрокаДоговор.Сделка);
			СтруктураПодбора.Вставить("ДокументРасчетовСКонтрагентом",	СтрокаДоговор.ДокументРасчетовСКонтрагентом);
			СтруктураПодбора.Вставить("ДокументПланирования",			СтрокаДоговор.ДокументПланирования);
			СтруктураПодбора.Вставить("Проект",							СтрокаДоговор.Проект);
			СтруктураПодбора.Вставить("СтатьяДвиженияДенежныхСредств",	СтрокаДоговор.СтатьяДвиженияДенежныхСредств);
			СтруктураПодбора.Вставить("СуммаПлатежаПлан",				СтрокаДоговор.СуммаПлатежа);
			СтруктураПодбора.Вставить("СуммаПлатежа",					СтрокаДоговор.СуммаПлатежа);
			СтруктураПодбора.Вставить("КурсВзаиморасчетов",				СтрокаДоговор.КурсВзаиморасчетов);
			СтруктураПодбора.Вставить("КратностьВзаиморасчетов",		СтрокаДоговор.КратностьВзаиморасчетов);
			СтруктураПодбора.Вставить("СуммаВзаиморасчетов",			СтрокаДоговор.СуммаВзаиморасчетов);
			СтруктураПодбора.Вставить("КурсВзаиморасчетовПлан",			СтрокаДоговор.КурсВзаиморасчетовПлан);
			
			ОповеститьОВыборе(СтруктураПодбора);
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура КоманднаяПанель1Выбрать(Кнопка)
	
	Перем КурсВзаиморасчетов,КратностьВзаиморасчетов,СуммаПлатежа,СуммаВзаиморасчетов;
	
	МассивСтрок=ЭлементыФормы.ПланируемыеДвижения.ВыделенныеСтроки;
	
	Если МассивСтрок.Количество()>1 Тогда
		
		СтавкаНДС=?(НЕ ЗначениеЗаполнено(РасшифровкаПлатежаДок[0].СтавкаНДС),УправлениеПользователями.ПолучитьЗначениеПоУмолчанию(глЗначениеПеременной("глТекущийПользователь"),"ОсновнаяСтавкаНДС"),
						РасшифровкаПлатежаДок[0].СтавкаНДС);
		
		Для Каждого Строка Из МассивСтрок Цикл
			
			НоваяСтрока=РасшифровкаПлатежаДок.Добавить();
			НоваяСтрока.ДоговорКонтрагента=Строка.ДоговорКонтрагента;
			НоваяСтрока.Сделка=Строка.Сделка;
			НоваяСтрока.ДокументРасчетовСКонтрагентом=Строка.ДокументРасчетовСКонтрагентом;
			НоваяСтрока.СуммаПлатежа=Строка.СуммаПлатежа;
			НоваяСтрока.КурсВзаиморасчетов=Строка.КурсВзаиморасчетов;
			НоваяСтрока.КратностьВзаиморасчетов=Строка.КратностьВзаиморасчетов;
			НоваяСтрока.СуммаВзаиморасчетов=Строка.СуммаВзаиморасчетов;
			НоваяСтрока.ДокументПланированияПлатежа=Строка.ДокументПланирования;
			НоваяСтрока.СтатьяДвиженияДенежныхСредств=Строка.СтатьяДвиженияДенежныхСредств;
			НоваяСтрока.Проект=Строка.Проект;
			НоваяСтрока.КурсВзаиморасчетовПлан=Строка.КурсВзаиморасчетовПлан;
			НоваяСтрока.СуммаПлатежаПлан=Строка.СуммаПлатежа;
			
			Если (Не ОтражатьВБухгалтерскомУчете=Неопределено) И ОтражатьВБухгалтерскомУчете Тогда
				
				УправлениеДенежнымиСредствами.ЗаполнитьРеквизитыРеглУчета(ДокументСсылка,НоваяСтрока, СтавкаНДС,ОтражатьВБухгалтерскомУчете);
				
			КонецЕсли;
			
		КонецЦикла;
		
		Пока МассивСтрок.Количество()>0 Цикл
			
			ПланируемыеДвижения.Удалить(МассивСтрок[0])
			
		КонецЦикла;
		
		ОповеститьОВыборе("АвтоПодбор");
		
	ИначеЕсли МассивСтрок.Количество()=1 Тогда
		
		СтрокаДоговор=МассивСтрок[0];
		
		Если ЕстьПодбор Тогда
			
			НоваяСтрока=РасшифровкаПлатежаДок.Добавить();
			НоваяСтрока.ДоговорКонтрагента=СтрокаДоговор.ДоговорКонтрагента;
			НоваяСтрока.Сделка=СтрокаДоговор.Сделка;
			НоваяСтрока.ДокументРасчетовСКонтрагентом=СтрокаДоговор.ДокументРасчетовСКонтрагентом;
			НоваяСтрока.СуммаПлатежа=СтрокаДоговор.СуммаПлатежа;
			НоваяСтрока.КурсВзаиморасчетов=СтрокаДоговор.КурсВзаиморасчетов;
			НоваяСтрока.КратностьВзаиморасчетов=СтрокаДоговор.КратностьВзаиморасчетов;
			НоваяСтрока.СуммаВзаиморасчетов=СтрокаДоговор.СуммаВзаиморасчетов;
			НоваяСтрока.ДокументПланированияПлатежа=СтрокаДоговор.ДокументПланирования;
			НоваяСтрока.СтатьяДвиженияДенежныхСредств=СтрокаДоговор.СтатьяДвиженияДенежныхСредств;
			НоваяСтрока.Проект=СтрокаДоговор.Проект;
			НоваяСтрока.КурсВзаиморасчетовПлан=СтрокаДоговор.КурсВзаиморасчетовПлан;
			НоваяСтрока.СуммаПлатежаПлан=СтрокаДоговор.СуммаПлатежа;
			
			Если (Не ОтражатьВБухгалтерскомУчете=Неопределено) И ОтражатьВБухгалтерскомУчете Тогда
				
				УправлениеДенежнымиСредствами.ЗаполнитьРеквизитыРеглУчета(ДокументСсылка,НоваяСтрока, СтавкаНДС,ОтражатьВБухгалтерскомУчете);
				
			КонецЕсли;
			
			ПланируемыеДвижения.Удалить(СтрокаДоговор);
			ОповеститьОВыборе("АвтоПодбор");
			
		Иначе	
			
			СтруктураПодбора=Новый Структура;
			
			СтруктураПодбора.Вставить("ДоговорКонтрагента",				СтрокаДоговор.ДоговорКонтрагента);
			СтруктураПодбора.Вставить("Сделка",							СтрокаДоговор.Сделка);
			СтруктураПодбора.Вставить("ДокументРасчетовСКонтрагентом",	СтрокаДоговор.ДокументРасчетовСКонтрагентом);
			СтруктураПодбора.Вставить("ДокументПланирования",			СтрокаДоговор.ДокументПланирования);
			СтруктураПодбора.Вставить("Проект",							СтрокаДоговор.Проект);
			СтруктураПодбора.Вставить("СтатьяДвиженияДенежныхСредств",	СтрокаДоговор.СтатьяДвиженияДенежныхСредств);
			СтруктураПодбора.Вставить("СуммаПлатежаПлан",				СтрокаДоговор.СуммаПлатежа);
			СтруктураПодбора.Вставить("СуммаПлатежа",					СтрокаДоговор.СуммаПлатежа);
			СтруктураПодбора.Вставить("КурсВзаиморасчетов",				СтрокаДоговор.КурсВзаиморасчетов);
			СтруктураПодбора.Вставить("КратностьВзаиморасчетов",		СтрокаДоговор.КратностьВзаиморасчетов);
			СтруктураПодбора.Вставить("СуммаВзаиморасчетов",			СтрокаДоговор.СуммаВзаиморасчетов);
			СтруктураПодбора.Вставить("КурсВзаиморасчетовПлан",			СтрокаДоговор.КурсВзаиморасчетовПлан);
			
			ОповеститьОВыборе(СтруктураПодбора);
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ПланируемыеДвиженияПриАктивизацииСтроки(Элемент)
	
	СуммаВыделено=0;
	
	Для Каждого Строка Из Элемент.ВыделенныеСтроки Цикл
		
		СуммаВыделено=СуммаВыделено+Строка.СуммаПлатежа;
		
	КонецЦикла;
	
	ЭлементыФормы.НадписьВыбрано.Заголовок="Всего отмечено: "+Формат(СуммаВыделено,"ЧЦ=15; ЧДЦ=2; ЧРГ=")+" "+Строка(ВалютаДокумента);
	
КонецПроцедуры

Процедура ПередОткрытием(Отказ, СтандартнаяОбработка)

	Если ОбработкаОбъект.МножественныйВыбор Тогда
		ЭлементыФормы.ПланируемыеДвижения.РежимВыделения=РежимВыделенияТабличногоПоля.Множественный;
		ЭлементыФормы.НадписьВыбрано.Видимость=Истина;
	Иначе
		ЭлементыФормы.ПланируемыеДвижения.РежимВыделения=РежимВыделенияТабличногоПоля.Одиночный;
		ЭлементыФормы.НадписьВыбрано.Видимость=Ложь;
	КонецЕсли;
	
КонецПроцедуры