////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

Процедура ПриОткрытии()

	ОбработкаПриОткрытии();
	
КонецПроцедуры


////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ЭЛЕМЕНТОВ ФОРМЫ

Процедура КнопкаВыполнитьНажатие(Элемент)
	
	Если Организация.Пустая() Тогда
		Сообщить("Не выбрана организация", СтатусСообщения.Внимание);
		Возврат;
	КонецЕсли;
	
	МассивСтрок=Новый Массив;

	Для Каждого Строка Из ДеревоКонтрагентов.Строки Цикл
		
		Если Строка.Пометка Тогда
			
			Если НЕ СоздатьКонтрагента(Строка,ФлажокОткрытияФормКотранетов).Пустая() Тогда
				
				МассивСтрок.Добавить(Строка);
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Для Каждого Строка ИЗ МассивСтрок Цикл
		
		ДеревоКонтрагентов.Строки.Удалить(Строка);
		
	КонецЦикла;
	
	Если Не ОткрытаИзПлатежногоДокумента Тогда
		ЭтотОбъект.ПолучитьФорму("Форма").ПрочитатьДанныеИзФайла(ложь);
		ОбработкаПриОткрытии();
	КонецЕсли;
	
	Если ДеревоКонтрагентов.Строки.Количество() = 0 Тогда
		Закрыть();
	КонецЕсли;
					
КонецПроцедуры

Процедура КоманднаяПанель2УстановитьВсе(Кнопка)
	
	Для Каждого Строка Из ДеревоКонтрагентов.Строки Цикл
		Строка.Пометка=Истина;
		Для Каждого ВнСтрока Из Строка.Строки Цикл
			Если ВнСтрока.Строки.количество()>0 Тогда
				ВнСтрока.Пометка=Истина;
			КонецЕсли;
		КонецЦикла;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура КоманднаяПанель2СнятьВсеПометки(Кнопка)
	 
	Для Каждого Строка Из ДеревоКонтрагентов.Строки Цикл
		ОформлениеСтроки = ЭлементыФормы.ДеревоКонтрагентов.ОформлениеСтроки(Строка);
		Если ОформлениеСтроки.Ячейки.Представление.ОтображатьФлажок Тогда
			Строка.Пометка=Ложь;
		КонецЕсли;
		
		Для Каждого ВнСтрока Из Строка.Строки Цикл
			Если ВнСтрока.Строки.количество()>0 Тогда
				ВнСтрока.Пометка=Ложь;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
КонецПроцедуры

Процедура ДеревоКонтрагентовПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	
	Если ДанныеСтроки.Строки.количество()>0 
		и (ДанныеСтроки.Реквизит=неопределено или ТипЗнч(ДанныеСтроки.Реквизит)=Тип("Строка")) Тогда
		
		ОформлениеСтроки.Ячейки.Представление.ОтображатьФлажок=Истина;
		
	Иначе
		
		ОформлениеСтроки.Ячейки.Представление.ОтображатьФлажок= Ложь;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ДеревоКонтрагентовПередНачаломИзменения(Элемент, Отказ)
	
	Если Элемент.ТекущаяКолонка.Имя = "Значение" Тогда
		Отказ = Истина;
	КонецЕсли;

КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ

Процедура СформироватьИЗагрузитьДеревоПоТаблицеЗначений(РеквизитыКонтрагента) Экспорт

	Дерево = Новый ДеревоЗначений;
    Дерево.Колонки.Добавить("Представление");
    Дерево.Колонки.Добавить("Значение");
    Дерево.Колонки.Добавить("Реквизит");
    Дерево.Колонки.Добавить("Пометка");
	
	НовыйЭлемент0 = Дерево.Строки.Добавить();
	НовыйЭлемент0.Представление = РеквизитыКонтрагента[0].Значение;

	Для Счет1=0 по РеквизитыКонтрагента.Количество()-1 Цикл
		
		Если РеквизитыКонтрагента[Счет1].Представление = "Р/счет" Тогда
			НовыйЭлемент1 = Дерево.Строки[0].Строки.Добавить();
			НовыйЭлемент1.Представление = РеквизитыКонтрагента[Счет1].Представление;
			НовыйЭлемент1.Значение 		= РеквизитыКонтрагента[Счет1].Значение;
			НовыйЭлемент1.Реквизит 		= РеквизитыКонтрагента[Счет1].Реквизит;
			Для Счет2=Счет1+1 по РеквизитыКонтрагента.Количество()-1 Цикл
				Если РеквизитыКонтрагента[Счет2].Представление = "Договор" Тогда
					НовыйЭлемент1 = Дерево.Строки[0].Строки.Добавить();
					НовыйЭлемент1.Представление = РеквизитыКонтрагента[Счет2].Представление;
					НовыйЭлемент1.Значение 		= РеквизитыКонтрагента[Счет2].Значение;
					НовыйЭлемент1.Реквизит 		= РеквизитыКонтрагента[Счет2].Реквизит;
					
					Для Счет3=Счет2+1 по РеквизитыКонтрагента.Количество()-1 Цикл
						НовыйЭлемент2 = Дерево.Строки[0].Строки[Счет1+1].Строки.Добавить();
						НовыйЭлемент2.Представление = РеквизитыКонтрагента[Счет3].Представление;
						НовыйЭлемент2.Значение 		= РеквизитыКонтрагента[Счет3].Значение;
						НовыйЭлемент2.Реквизит 		= РеквизитыКонтрагента[Счет3].Реквизит;
					КонецЦикла;	
					Прервать;
				Иначе
					НовыйЭлемент2 = Дерево.Строки[0].Строки[Счет1].Строки.Добавить();
					НовыйЭлемент2.Представление = РеквизитыКонтрагента[Счет2].Представление;
					НовыйЭлемент2.Значение 		= РеквизитыКонтрагента[Счет2].Значение;
					НовыйЭлемент2.Реквизит 		= РеквизитыКонтрагента[Счет2].Реквизит;
				КонецЕсли
			КонецЦикла;	
			Прервать;
		Иначе
			НовыйЭлемент1 = Дерево.Строки[0].Строки.Добавить();
			НовыйЭлемент1.Представление = РеквизитыКонтрагента[Счет1].Представление;
			НовыйЭлемент1.Значение 		= РеквизитыКонтрагента[Счет1].Значение;
			НовыйЭлемент1.Реквизит 		= РеквизитыКонтрагента[Счет1].Реквизит;
		КонецЕсли;
		
	КонецЦикла;	
	                                      
	ОткрытаИзПлатежногоДокумента = истина;
	ЭлементыФормы.ДеревоКонтрагентов.Значение = Дерево;
	ЭлементыФормы.ДеревоКонтрагентов.НачальноеОтображениеДерева = НачальноеОтображениеДерева.РаскрыватьВерхнийУровень;

КонецПроцедуры

Процедура ОбработкаПриОткрытии()

	ЭлементыФормы.ДеревоКонтрагентов.Колонки["Представление"].ДанныеФлажка = "Пометка";
	ЭлементыФормы.ДеревоКонтрагентов.ТолькоПросмотр=Ложь;
	Если Не ОткрытаИзПлатежногоДокумента Тогда
		ЭлементыФормы.ДеревоКонтрагентов.Значение = ТаблицаКонтрагентов;
	КонецЕсли;
	КоманднаяПанель2УстановитьВсе(неопределено);
	
КонецПроцедуры